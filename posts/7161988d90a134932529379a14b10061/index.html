<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Nvidia Jetson AGX Orin使用CAN与底盘通信（ROS C&#43;&#43; 驱动） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Nvidia Jetson AGX Orin使用CAN与底盘通信（ROS C&#43;&#43; 驱动）" />
<meta property="og:description" content="文章目录 一、Nvidia Jetson AGX Orin使用CAN通信1.1 CAN使能配置修改GPIO口功能1.2 can收发测试 二、通过CAN协议编写CAN的SocketCan ROS1驱动程序2.1 通讯协议2.2 接收数据节点2.3 发送数据节点2.4 功能包配置 三、ROS2驱动程序 一、Nvidia Jetson AGX Orin使用CAN通信 参考：https://blog.csdn.net/vonct/article/details/129055892，使用杜邦线将Nvidia Jetson AGX Orin的CAN口（底盘CANL和CANH连接对应Orin的CANL和CANH，具体底盘CANL和CANH接口可能要看Nvidia Jetson AGX Orin说明书）接出来。
1.1 CAN使能配置修改GPIO口功能 由于默认的CAN引脚不是配置为CAN，因此需要修改4个寄存器的值。具体可以从文档看到：
以Orin为例，图中Addr就是寄存器地址，value就是需要写入的值
（1）使用busybox修改寄存器的值
sudo apt-get install busybox sudo busybox devmem 0x0c303018 w 0xc458 sudo busybox devmem 0x0c303010 w 0xc400 sudo busybox devmem 0x0c303008 w 0xc458 sudo busybox devmem 0x0c303000 w 0xc400 （2）挂载CAN内核
sudo modprobe can sudo modprobe can_raw sudo modprobe mttcan （3）CAN属性设置" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7161988d90a134932529379a14b10061/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-08T22:35:57+08:00" />
<meta property="article:modified_time" content="2024-01-08T22:35:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Nvidia Jetson AGX Orin使用CAN与底盘通信（ROS C&#43;&#43; 驱动）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Nvidia_Jetson_AGX_OrinCAN_4" rel="nofollow">一、Nvidia Jetson AGX Orin使用CAN通信</a></li><li><ul><li><a href="#11_CANGPIO_6" rel="nofollow">1.1 CAN使能配置修改GPIO口功能</a></li><li><a href="#12_can_51" rel="nofollow">1.2 can收发测试</a></li></ul> 
  </li><li><a href="#CANCANSocketCan_ROS1_63" rel="nofollow">二、通过CAN协议编写CAN的SocketCan ROS1驱动程序</a></li><li><ul><li><a href="#21__64" rel="nofollow">2.1 通讯协议</a></li><li><a href="#22__80" rel="nofollow">2.2 接收数据节点</a></li><li><a href="#23__407" rel="nofollow">2.3 发送数据节点</a></li><li><a href="#24__673" rel="nofollow">2.4 功能包配置</a></li></ul> 
  </li><li><a href="#ROS2_744" rel="nofollow">三、ROS2驱动程序</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="Nvidia_Jetson_AGX_OrinCAN_4"></a>一、Nvidia Jetson AGX Orin使用CAN通信</h2> 
<p>参考：<a href="https://blog.csdn.net/vonct/article/details/129055892">https://blog.csdn.net/vonct/article/details/129055892</a>，使用杜邦线将Nvidia Jetson AGX Orin的CAN口（底盘CANL和CANH连接对应Orin的CANL和CANH，具体底盘CANL和CANH接口可能要看Nvidia Jetson AGX Orin说明书）接出来。</p> 
<h3><a id="11_CANGPIO_6"></a>1.1 CAN使能配置修改GPIO口功能</h3> 
<p>由于默认的CAN引脚不是配置为CAN，因此需要修改4个寄存器的值。具体可以从文档看到：<br> <img src="https://images2.imgbox.com/d9/74/Uqp3KeJP_o.png" alt="在这里插入图片描述"><br> 以Orin为例，图中Addr就是寄存器地址，value就是需要写入的值<br> （1）使用busybox修改寄存器的值</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> busybox
<span class="token function">sudo</span> busybox devmem 0x0c303018 w 0xc458
<span class="token function">sudo</span> busybox devmem 0x0c303010 w 0xc400
<span class="token function">sudo</span> busybox devmem 0x0c303008 w 0xc458
<span class="token function">sudo</span> busybox devmem 0x0c303000 w 0xc400
</code></pre> 
<p>（2）挂载CAN内核</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> modprobe can
<span class="token function">sudo</span> modprobe can_raw
<span class="token function">sudo</span> modprobe mttcan
</code></pre> 
<p>（3）CAN属性设置<br> 例如将CAN0波特率设置成500k，注意，配置前需要先关闭can</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> down can0
<span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> can0 <span class="token builtin class-name">type</span> can bitrate <span class="token number">500000</span>
<span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> up can0
</code></pre> 
<p>将上诉代码写进shell文件，每次使用之前要运行：</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> busybox devmem 0x0c303018 w 0xc458
<span class="token function">sudo</span> busybox devmem 0x0c303010 w 0xc400
<span class="token function">sudo</span> busybox devmem 0x0c303008 w 0xc458
<span class="token function">sudo</span> busybox devmem 0x0c303000 w 0xc400
<span class="token function">sudo</span> modprobe can
<span class="token function">sudo</span> modprobe can_raw
<span class="token function">sudo</span> modprobe mttcan
<span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> down can0
<span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> can0 <span class="token builtin class-name">type</span> can bitrate <span class="token number">500000</span>
<span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> up can0
</code></pre> 
<h3><a id="12_can_51"></a>1.2 can收发测试</h3> 
<p>用can-utils进行简单的can收发测试，后续将用SocketCan结合ROS。</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> can-utils
cansend can0 0E2<span class="token comment">#05.00.00.00.00.00.00.00  #cansend can0/1 [can_id]#[八字节数据]</span>
cangen <span class="token parameter variable">-v</span> can0  <span class="token comment">#随机发送</span>
candump can0 <span class="token comment">#接受can帧</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/84/2a/3k9wig5K_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/71/71/lZzuxh9d_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="CANCANSocketCan_ROS1_63"></a>二、通过CAN协议编写CAN的SocketCan ROS1驱动程序</h2> 
<h3><a id="21__64"></a>2.1 通讯协议</h3> 
<p>（1）小车反馈的整车数据<br> <img src="https://images2.imgbox.com/02/e8/UA3oHjhq_o.png" alt="在这里插入图片描述"><br> （2）线控指令<br> <img src="https://images2.imgbox.com/41/c8/shixOEWR_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/48/a9/me0FFs9d_o.png" alt="在这里插入图片描述"><br> 不同于UDP，类似于串口通信，可以参考我串口通信的文章<br> 代码写好之后遇到的问题：<br> （1）接收数据的时候反馈慢<br> 解决：去掉代码中的 spin频率控制;<br> （2）速度控制时无法换档<br> 解决：每次发速度之前，发送速度指令清零；<br> （3）节点关闭时速度仍在<br> 解决：在析构函数中发送退出线控指令；<br> （4）将Autoware参数（TwistStamped）写进Launch方便调参<br> 优化并调试后的代码如下（其中协议中写的角度和速度指定bit与实际值的比例关系似乎不太对，需要实际调试的时候优化）：</p> 
<h3><a id="22__80"></a>2.2 接收数据节点</h3> 
<p>can_receive_node.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"can_ros1_driver/can_receive.hpp"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ros<span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"can_receive_node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canControl can_control<span class="token punctuation">;</span>

    ros<span class="token double-colon punctuation">::</span><span class="token function">spin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>can_receive.hpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CAN_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/can.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/can/raw.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;net/if.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cmath&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ros/ros.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"std_msgs/String.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"geometry_msgs/Twist.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"nav_msgs/Odometry.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;tf/transform_broadcaster.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;tf/tf.h&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">canControl</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// 0 初始化</span>
    <span class="token function">canControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1 接收CAN消息</span>
    <span class="token keyword">void</span> <span class="token function">receiveCanData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.1 解析数据</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int16_t</span><span class="token operator">&gt;</span> <span class="token function">hexToShort</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>hex_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.2 推算里程计并发布</span>
    <span class="token keyword">void</span> <span class="token function">publishOdometry</span><span class="token punctuation">(</span><span class="token keyword">double</span> linear_velocity<span class="token punctuation">,</span> <span class="token keyword">double</span> angular_velocity<span class="token punctuation">,</span> <span class="token keyword">double</span> Steer_Angle<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2 析构函数</span>
    <span class="token operator">~</span><span class="token function">canControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    ros<span class="token double-colon punctuation">::</span>NodeHandle nh_<span class="token punctuation">;</span>
    <span class="token comment">// 轴距</span>
    <span class="token keyword">double</span> wheel_base<span class="token punctuation">;</span>
    <span class="token comment">// 套接字参数</span>
    <span class="token keyword">struct</span> <span class="token class-name">ifreq</span> ifr<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_can</span> can_addr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token comment">// 接收的数据</span>
    <span class="token keyword">struct</span> <span class="token class-name">can_frame</span> frame<span class="token punctuation">;</span>

    <span class="token comment">// 当前里程计</span>
    <span class="token keyword">double</span> position_x_<span class="token punctuation">;</span>
    <span class="token keyword">double</span> position_y_<span class="token punctuation">;</span>
    <span class="token keyword">double</span> yaw<span class="token punctuation">;</span>

    <span class="token comment">// 发布速度和里程计</span>
    ros<span class="token double-colon punctuation">::</span>Publisher pub_<span class="token punctuation">;</span>
    ros<span class="token double-colon punctuation">::</span>Publisher pub_Odom<span class="token punctuation">;</span>
    tf<span class="token double-colon punctuation">::</span>TransformBroadcaster tf_broadcaster_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// CAN_H_</span></span>
</code></pre> 
<p>can_receive.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"can_ros1_driver/can_receive.hpp"</span></span>

<span class="token comment">// 0 初始化</span>
canControl<span class="token double-colon punctuation">::</span><span class="token function">canControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">nh_</span><span class="token punctuation">(</span><span class="token string">"~"</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1 初始化ROS节点</span>
    nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">param</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"wheel_base"</span><span class="token punctuation">,</span> wheel_base<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    position_x_ <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    position_y_ <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    yaw <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>

    <span class="token comment">/* 打开套接字 */</span>
    sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_CAN<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> CAN_RAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&gt;</span> sockfd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 指定can0设备 */</span>
    ifr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    can_addr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    frame <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>ifr<span class="token punctuation">.</span>ifr_name<span class="token punctuation">,</span> <span class="token string">"can0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ioctl</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> SIOCGIFINDEX<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ifr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    can_addr<span class="token punctuation">.</span>can_family <span class="token operator">=</span> AF_CAN<span class="token punctuation">;</span>
    can_addr<span class="token punctuation">.</span>can_ifindex <span class="token operator">=</span> ifr<span class="token punctuation">.</span>ifr_ifindex<span class="token punctuation">;</span>

    <span class="token comment">/* 将can0与套接字进行绑定 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&gt;</span> <span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>can_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>can_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建用于反馈速度指令的发布者</span>
    pub_ <span class="token operator">=</span> nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">advertise</span><span class="token generic class-name"><span class="token operator">&lt;</span>geometry_msgs<span class="token double-colon punctuation">::</span>Twist<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"/feedback_twist"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pub_Odom <span class="token operator">=</span> nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">advertise</span><span class="token generic class-name"><span class="token operator">&lt;</span>nav_msgs<span class="token double-colon punctuation">::</span>Odometry<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"/panda_odom"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">receiveCanData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 2 接收CAN串口消息</span>
<span class="token keyword">void</span> canControl<span class="token double-colon punctuation">::</span><span class="token function">receiveCanData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>ros<span class="token double-colon punctuation">::</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* 接收数据 */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&gt;</span> <span class="token function">read</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">can_frame</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* 校验是否接收到错误帧 */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span>can_id <span class="token operator">&amp;</span> CAN_ERR_FLAG<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error frame!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* 校验帧格式 */</span>
        <span class="token comment">// if (frame.can_id &amp; CAN_EFF_FLAG) // 扩展帧</span>
        <span class="token comment">//     printf("扩展帧 &lt;0x%08x&gt; ", frame.can_id &amp; CAN_EFF_MASK);</span>
        <span class="token comment">// else // 标准帧</span>
        <span class="token comment">//     printf("标准帧 &lt;0x%03x&gt; ", frame.can_id &amp; CAN_SFF_MASK);</span>

        <span class="token comment">/* 校验帧类型：数据帧还是远程帧 */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span>can_id <span class="token operator">&amp;</span> CAN_RTR_FLAG<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"remote request\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* 打印数据长度 */</span>
        <span class="token comment">// printf("[%d] ", frame.can_dlc);</span>

        <span class="token comment">/* 打印数据 */</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span> buff<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> frame<span class="token punctuation">.</span>can_dlc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 这里的%02x表示以两位十六进制数的形式输出，并且若不足两位则在前面补0。</span>
            <span class="token comment">// printf("%02x ", frame.data[i]);</span>
            <span class="token comment">// 一位一位字节地添加到队列</span>
            buff<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int8_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// printf("\n");</span>

        <span class="token comment">/* 解析数据 */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span>can_id <span class="token operator">==</span> <span class="token number">0x116</span> <span class="token operator">&amp;&amp;</span> frame<span class="token punctuation">.</span>can_dlc <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// printf("扩展帧 &lt;0x%08x&gt; ", frame.can_id &amp; CAN_EFF_MASK);</span>
            <span class="token comment">// printf("%02x ", frame.can_dlc);</span>
            <span class="token comment">// printf("\n---------------------\n");</span>
            <span class="token comment">// printf("Receive状态值为:%02x \n", buff[0]);</span>
            <span class="token comment">// printf("Receive打角值L为:%02x \n", buff[2]);</span>
            <span class="token comment">// printf("Receive打角值H为:%02x \n", buff[3]);</span>
            <span class="token comment">// printf("Receive速度值L为:%02x \n", buff[4]);</span>
            <span class="token comment">// printf("Receive速度值H为:%02x \n", buff[5]);</span>
            <span class="token comment">// printf("Receive电量0x为:%02x \n", buff[6]);</span>

            std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int16_t</span><span class="token operator">&gt;</span> <span class="token function">Velocity_feedback</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Velocity_feedback <span class="token operator">=</span> <span class="token function">hexToShort</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 获取完一帧的标志位,可以输出数据</span>
            geometry_msgs<span class="token double-colon punctuation">::</span>Twist feedback_twist<span class="token punctuation">;</span>

            <span class="token comment">// 1 获取档位</span>
            <span class="token keyword">int</span> gear <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>Velocity_feedback<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 3 获取车速</span>
            <span class="token comment">// TODO  ± 5m/s 0.001(m/s)/bit  有符号 </span>
            <span class="token keyword">double</span> DM_Speed <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>Velocity_feedback<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">185</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>gear <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
                DM_Speed <span class="token operator">=</span> <span class="token operator">-</span>DM_Speed<span class="token punctuation">;</span>
            feedback_twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>x <span class="token operator">=</span> DM_Speed<span class="token punctuation">;</span>

            <span class="token comment">// 2 获取舵机转向角度（打角值）</span>
            <span class="token comment">// TODO 524-1024-1524   0.1°/bit    0对应最左,1024对应中间角度</span>
            <span class="token keyword">double</span> Steer_Angle <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>Velocity_feedback<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3.6</span><span class="token punctuation">;</span>
            <span class="token comment">// 打角值满足：tan(打角值) = 前后轮轴距 / 转弯半径</span>
            <span class="token comment">// 角速度 = 线速度 / 转弯半径 = 线速度 * tan(打角值) / 前后轮轴距</span>
            <span class="token keyword">double</span> Velocity_Angle <span class="token operator">=</span> DM_Speed <span class="token operator">*</span> <span class="token function">tan</span><span class="token punctuation">(</span><span class="token function">fabs</span><span class="token punctuation">(</span>M_PI <span class="token operator">*</span> Steer_Angle <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> wheel_base<span class="token punctuation">;</span>
            feedback_twist<span class="token punctuation">.</span>angular<span class="token punctuation">.</span>z <span class="token operator">=</span> Velocity_Angle<span class="token punctuation">;</span>

            <span class="token comment">// 4 获取电池电量</span>
            <span class="token keyword">int</span> power <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>Velocity_feedback<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>power <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span>
                <span class="token function">ROS_WARN</span><span class="token punctuation">(</span><span class="token string">"Battery power (%d) is less than 10%!"</span><span class="token punctuation">,</span> power<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// std::cout &lt;&lt; "Receive档位值为: " &lt;&lt; gear &lt;&lt; std::endl;</span>
            <span class="token comment">// std::cout &lt;&lt; "Receive角速度值为: " &lt;&lt; Velocity_Angle &lt;&lt; std::endl;</span>
            <span class="token comment">// std::cout &lt;&lt; "Receive速度值为: " &lt;&lt; DM_Speed &lt;&lt; std::endl;</span>
            <span class="token comment">// std::cout &lt;&lt; "Receive电量为: " &lt;&lt; power &lt;&lt; std::endl;</span>

            <span class="token comment">// 5 发布速度</span>
            pub_<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>feedback_twist<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 6 发布里程计，左转是rZ正方向，而这个底盘最左是负，因此加-号</span>
            <span class="token function">publishOdometry</span><span class="token punctuation">(</span>DM_Speed<span class="token punctuation">,</span> Velocity_Angle<span class="token punctuation">,</span> <span class="token operator">-</span>M_PI <span class="token operator">*</span> Steer_Angle <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 2.1 解析数据</span>
std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int16_t</span><span class="token operator">&gt;</span> canControl<span class="token double-colon punctuation">::</span><span class="token function">hexToShort</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>hex_data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int16_t</span><span class="token operator">&gt;</span> <span class="token function">short_data</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1 获取档位</span>
    <span class="token keyword">uint8_t</span> byte <span class="token operator">=</span> hex_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mask <span class="token operator">=</span> <span class="token number">0b00001100</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用位与操作符&amp;来获取第3-4位的值,将结果向右位移3位</span>
    <span class="token keyword">uint8_t</span> gear <span class="token operator">=</span> <span class="token punctuation">(</span>byte <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
    short_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int16_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>gear<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2 获取舵机转向角度</span>
    <span class="token comment">// 将两个连续的字节（低位hex_data[i] 和 高位hex_data[i+1]）组合为一个 int16_t 类型的数值：千万注意高低顺序，仔细看通讯协议</span>
    <span class="token comment">// 高位hex_data[i+1]需要先强制转换为一个有符号的short类型的数据以后再移位</span>
    <span class="token keyword">short</span> Steer_Angle_H <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int16_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>hex_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 左移运算符 &lt;&lt; 将 high 的二进制表示向左移动 8 位。这样做是因为 int16_t 类型占用 2 个字节，而我们希望将 high 的数据放置在最高的 8 位上。</span>
    <span class="token comment">// |: 按位或运算符 | 将经过左移的 high 数据和 hex_data[i] 数据进行按位或操作，将它们组合为一个 16 位的数值</span>
    short_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int16_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>Steer_Angle_H <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> hex_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3 获取车速</span>
    <span class="token keyword">short</span> DM_Speed_H <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int16_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>hex_data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    short_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int16_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>DM_Speed_H <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> hex_data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4 获取电池电量</span>
    short_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int16_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>hex_data<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> short_data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 2.2 推算里程计并发布</span>
<span class="token keyword">void</span> canControl<span class="token double-colon punctuation">::</span><span class="token function">publishOdometry</span><span class="token punctuation">(</span><span class="token keyword">double</span> linear_velocity<span class="token punctuation">,</span> <span class="token keyword">double</span> angular_velocity<span class="token punctuation">,</span> <span class="token keyword">double</span> Steer_Angle<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 计算与上一时刻的时间差</span>
    <span class="token keyword">static</span> <span class="token keyword">double</span> last_stamp <span class="token operator">=</span> ros<span class="token double-colon punctuation">::</span><span class="token class-name">Time</span><span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toSec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> dt <span class="token operator">=</span> ros<span class="token double-colon punctuation">::</span><span class="token class-name">Time</span><span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toSec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> last_stamp<span class="token punctuation">;</span>
    last_stamp <span class="token operator">=</span> ros<span class="token double-colon punctuation">::</span><span class="token class-name">Time</span><span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toSec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1 推算里程</span>
    <span class="token keyword">double</span> wz <span class="token operator">=</span> angular_velocity<span class="token punctuation">,</span> vx <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> vy <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算偏航角（注意是相对于初始0，要绝对的需要IMU）</span>
    yaw <span class="token operator">+=</span> angular_velocity <span class="token operator">*</span> dt<span class="token punctuation">;</span>
    <span class="token comment">// 根据线速度以及航向角计算X，Y方向上的位移</span>
    vx <span class="token operator">=</span> linear_velocity <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">cos</span><span class="token punctuation">(</span>Steer_Angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vy <span class="token operator">=</span> linear_velocity <span class="token operator">*</span> <span class="token punctuation">(</span>linear_velocity <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">?</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token operator">-</span>Steer_Angle<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">sin</span><span class="token punctuation">(</span>Steer_Angle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算相对与上一时刻的位，根据偏航变换到初始坐标系</span>
    position_x_ <span class="token operator">+=</span> <span class="token function">cos</span><span class="token punctuation">(</span>yaw<span class="token punctuation">)</span> <span class="token operator">*</span> vx <span class="token operator">*</span> dt <span class="token operator">-</span> <span class="token function">sin</span><span class="token punctuation">(</span>yaw<span class="token punctuation">)</span> <span class="token operator">*</span> vy <span class="token operator">*</span> dt<span class="token punctuation">;</span>
    position_y_ <span class="token operator">+=</span> <span class="token function">sin</span><span class="token punctuation">(</span>yaw<span class="token punctuation">)</span> <span class="token operator">*</span> vx <span class="token operator">*</span> dt <span class="token operator">+</span> <span class="token function">cos</span><span class="token punctuation">(</span>yaw<span class="token punctuation">)</span> <span class="token operator">*</span> vy <span class="token operator">*</span> dt<span class="token punctuation">;</span>

    <span class="token comment">// 2 发布tf</span>
    geometry_msgs<span class="token double-colon punctuation">::</span>Quaternion odom_quat <span class="token operator">=</span> tf<span class="token double-colon punctuation">::</span><span class="token function">createQuaternionMsgFromYaw</span><span class="token punctuation">(</span>yaw<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// std::cout&lt;&lt; "odom_quat:" &lt;&lt; odom_quat&lt;&lt;std::endl;</span>
    geometry_msgs<span class="token double-colon punctuation">::</span>TransformStamped tf_msg<span class="token punctuation">;</span>
    tf_msg<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> ros<span class="token double-colon punctuation">::</span><span class="token class-name">Time</span><span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tf_msg<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">"odom"</span><span class="token punctuation">;</span>
    tf_msg<span class="token punctuation">.</span>child_frame_id <span class="token operator">=</span> <span class="token string">"base_link"</span><span class="token punctuation">;</span>
    tf_msg<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>translation<span class="token punctuation">.</span>x <span class="token operator">=</span> position_x_<span class="token punctuation">;</span>
    tf_msg<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>translation<span class="token punctuation">.</span>y <span class="token operator">=</span> position_y_<span class="token punctuation">;</span>
    tf_msg<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>translation<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    tf_msg<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>rotation <span class="token operator">=</span> odom_quat<span class="token punctuation">;</span>
    tf_broadcaster_<span class="token punctuation">.</span><span class="token function">sendTransform</span><span class="token punctuation">(</span>tf_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3 发布odom</span>
    nav_msgs<span class="token double-colon punctuation">::</span>Odometry odom_msg<span class="token punctuation">;</span>
    odom_msg<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> ros<span class="token double-colon punctuation">::</span><span class="token class-name">Time</span><span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    odom_msg<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">"odom"</span><span class="token punctuation">;</span>
    odom_msg<span class="token punctuation">.</span>child_frame_id <span class="token operator">=</span> <span class="token string">"base_link"</span><span class="token punctuation">;</span>

    odom_msg<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">=</span> position_x_<span class="token punctuation">;</span>
    odom_msg<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> position_y_<span class="token punctuation">;</span>
    odom_msg<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    odom_msg<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation <span class="token operator">=</span> odom_quat<span class="token punctuation">;</span>

    odom_msg<span class="token punctuation">.</span>twist<span class="token punctuation">.</span>twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>x <span class="token operator">=</span> vx<span class="token punctuation">;</span>
    odom_msg<span class="token punctuation">.</span>twist<span class="token punctuation">.</span>twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>y <span class="token operator">=</span> vy<span class="token punctuation">;</span>
    odom_msg<span class="token punctuation">.</span>twist<span class="token punctuation">.</span>twist<span class="token punctuation">.</span>angular<span class="token punctuation">.</span>z <span class="token operator">=</span> wz<span class="token punctuation">;</span>

    odom_msg<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>covariance<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
    odom_msg<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>covariance<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
    odom_msg<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>covariance<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
    odom_msg<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>covariance<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    odom_msg<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>covariance<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    odom_msg<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>covariance<span class="token punctuation">[</span><span class="token number">35</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>

    pub_Odom<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>odom_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 3 析构函数</span>
<span class="token class-name">canControl</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">canControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* 关闭套接字 */</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="23__407"></a>2.3 发送数据节点</h3> 
<p>can_send_node.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"can_ros1_driver/can_send.hpp"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ros<span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"can_send_node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canControl can_control<span class="token punctuation">;</span>

    ros<span class="token double-colon punctuation">::</span><span class="token function">spin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>can_send.hpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CAN_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CAN_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/can.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/can/raw.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;net/if.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cmath&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ros/ros.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"std_msgs/String.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"geometry_msgs/Twist.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"geometry_msgs/TwistStamped.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"nav_msgs/Odometry.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">canControl</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// 0 初始化</span>
    <span class="token function">canControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1 下发CAN消息 速度控制节点消息的回调函数</span>
    <span class="token keyword">void</span> <span class="token function">velocityCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> geometry_msgs<span class="token double-colon punctuation">::</span>Twist<span class="token double-colon punctuation">::</span>ConstPtr <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">velocityCallback_Autoware</span><span class="token punctuation">(</span><span class="token keyword">const</span> geometry_msgs<span class="token double-colon punctuation">::</span>TwistStamped<span class="token double-colon punctuation">::</span>ConstPtr <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.1 向底盘发送控制指令</span>
    <span class="token keyword">void</span> <span class="token function">publishCmd</span><span class="token punctuation">(</span><span class="token keyword">float</span> linear_vel<span class="token punctuation">,</span> <span class="token keyword">float</span> angular_vel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2 析构函数</span>
    <span class="token operator">~</span><span class="token function">canControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    ros<span class="token double-colon punctuation">::</span>NodeHandle nh_<span class="token punctuation">;</span>
    <span class="token comment">// 是否为Autoware速度</span>
    <span class="token keyword">bool</span> Autoware<span class="token punctuation">;</span>
    <span class="token comment">// 接收的速度话题</span>
    std<span class="token double-colon punctuation">::</span>string twistTopic<span class="token punctuation">;</span>
    <span class="token comment">// 轴距</span>
    <span class="token keyword">double</span> wheel_base<span class="token punctuation">;</span>
    <span class="token comment">// 套接字参数</span>
    <span class="token keyword">struct</span> <span class="token class-name">ifreq</span> ifr<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_can</span> can_addr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token comment">// 发送的数据</span>
    <span class="token keyword">struct</span> <span class="token class-name">can_frame</span> frameE2<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">can_frame</span> frame469<span class="token punctuation">;</span>

    <span class="token comment">// 当前里程计</span>
    <span class="token keyword">double</span> position_x_<span class="token punctuation">;</span>
    <span class="token keyword">double</span> position_y_<span class="token punctuation">;</span>
    <span class="token keyword">double</span> yaw<span class="token punctuation">;</span>

    <span class="token comment">// 订阅速度控制</span>
    ros<span class="token double-colon punctuation">::</span>Subscriber sub_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// CAN_H_</span></span>
</code></pre> 
<p>can_send.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"can_ros1_driver/can_send.hpp"</span></span>

<span class="token comment">// 0 初始化</span>
canControl<span class="token double-colon punctuation">::</span><span class="token function">canControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">nh_</span><span class="token punctuation">(</span><span class="token string">"~"</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1 初始化ROS节点</span>
    nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">param</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"wheel_base"</span><span class="token punctuation">,</span> wheel_base<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">param</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"Autoware"</span><span class="token punctuation">,</span> Autoware<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">param</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"twistTopic"</span><span class="token punctuation">,</span> twistTopic<span class="token punctuation">,</span> <span class="token string">"/cmd_vel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    position_x_ <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    position_y_ <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    yaw <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>

    <span class="token comment">/* 打开套接字 */</span>
    sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_CAN<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> CAN_RAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&gt;</span> sockfd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 指定can0设备 */</span>
    ifr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    can_addr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>ifr<span class="token punctuation">.</span>ifr_name<span class="token punctuation">,</span> <span class="token string">"can0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ioctl</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> SIOCGIFINDEX<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ifr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    can_addr<span class="token punctuation">.</span>can_family <span class="token operator">=</span> AF_CAN<span class="token punctuation">;</span>
    can_addr<span class="token punctuation">.</span>can_ifindex <span class="token operator">=</span> ifr<span class="token punctuation">.</span>ifr_ifindex<span class="token punctuation">;</span>

    <span class="token comment">/* 将can0与套接字进行绑定 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&gt;</span> <span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>can_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>can_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 设置过滤规则 */</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> SOL_CAN_RAW<span class="token punctuation">,</span> CAN_RAW_FILTER<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 发送数据格式 */</span>
    frameE2<span class="token punctuation">.</span>can_dlc <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>    <span class="token comment">// 一次发送8个字节数据</span>
    frameE2<span class="token punctuation">.</span>can_id <span class="token operator">=</span> <span class="token number">0x0E2</span><span class="token punctuation">;</span> <span class="token comment">// 帧ID为0x0E2,标准帧</span>
    frameE2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    frameE2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    frameE2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

    frame469<span class="token punctuation">.</span>can_dlc <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>    <span class="token comment">// 一次发送8个字节数据</span>
    frame469<span class="token punctuation">.</span>can_id <span class="token operator">=</span> <span class="token number">0x469</span><span class="token punctuation">;</span> <span class="token comment">// 帧ID为0x469,标准帧</span>
    frame469<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x20</span><span class="token punctuation">;</span>
    frame469<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    frame469<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    frame469<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    frame469<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建订阅控制底盘消息的订阅者</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Autoware<span class="token punctuation">)</span>
        sub_ <span class="token operator">=</span> nh_<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>twistTopic<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>canControl<span class="token double-colon punctuation">::</span>velocityCallback_Autoware<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        sub_ <span class="token operator">=</span> nh_<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>twistTopic<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>canControl<span class="token double-colon punctuation">::</span>velocityCallback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 1 下发CAN消息 根据接收到的速度消息生成控制指令并发送</span>
<span class="token comment">// 其他节点消息的回调函数</span>
<span class="token keyword">void</span> canControl<span class="token double-colon punctuation">::</span><span class="token function">velocityCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> geometry_msgs<span class="token double-colon punctuation">::</span>Twist<span class="token double-colon punctuation">::</span>ConstPtr <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">publishCmd</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>linear<span class="token punctuation">.</span>x<span class="token punctuation">,</span> msg<span class="token operator">-&gt;</span>angular<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Autoware发送的</span>
<span class="token keyword">void</span> canControl<span class="token double-colon punctuation">::</span><span class="token function">velocityCallback_Autoware</span><span class="token punctuation">(</span><span class="token keyword">const</span> geometry_msgs<span class="token double-colon punctuation">::</span>TwistStamped<span class="token double-colon punctuation">::</span>ConstPtr <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">publishCmd</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>x<span class="token punctuation">,</span> msg<span class="token operator">-&gt;</span>twist<span class="token punctuation">.</span>angular<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 1.1 向底盘发送控制指令</span>
<span class="token keyword">void</span> canControl<span class="token double-colon punctuation">::</span><span class="token function">publishCmd</span><span class="token punctuation">(</span><span class="token keyword">float</span> linear_vel<span class="token punctuation">,</span> <span class="token keyword">float</span> angular_vel<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 根据线速度和角速度生成控制指令的逻辑,将 linear_vel、angular_vel 转换为控制指令</span>
    <span class="token comment">// 1. 计算挡位Gear</span>
    <span class="token keyword">int</span> gear <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 默认值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>linear_vel <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        gear <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 前进挡</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>linear_vel <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        gear <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 倒挡</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2. 线控驾驶标志位，通过CAN线控</span>
    <span class="token keyword">int</span> line_control <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. 驻车P标志位</span>
    <span class="token keyword">int</span> parking_brake <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 速度为0或速度反向的时候刹车</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> last_gear <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>linear_vel <span class="token operator">==</span> <span class="token number">0.0</span> <span class="token operator">||</span> last_gear <span class="token operator">+</span> gear <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span>
        parking_brake <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    last_gear <span class="token operator">=</span> gear<span class="token punctuation">;</span>
    <span class="token comment">// 4. 循环计数，默认为0</span>
    <span class="token keyword">int</span> loop_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">uint8_t</span> gear_contrl <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>loop_count <span class="token operator">+</span> parking_brake <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> line_control <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> gear<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5 计算速度byte</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>linear_vel <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">ROS_WARN</span><span class="token punctuation">(</span><span class="token string">"Speed is too fast!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        linear_vel <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// TODO 1000有待优化</span>
    <span class="token comment">// printf("Send档位值为:%02x \n", gear_contrl);</span>
    <span class="token comment">// std::cout &lt;&lt; "Send速度值为: " &lt;&lt; linear_vel &lt;&lt; std::endl;</span>
    <span class="token keyword">uint8_t</span> Speed_L <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">fabs</span><span class="token punctuation">(</span>linear_vel<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint8_t</span> Speed_H <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">fabs</span><span class="token punctuation">(</span>linear_vel<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 6. 计算低压电器开关和速度校验和</span>
    <span class="token keyword">int</span> brakeLight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parking_brake<span class="token punctuation">)</span>
        brakeLight <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> headlight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> trafficIndicatorL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> trafficIndicatorR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>angular_vel <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        trafficIndicatorL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>angular_vel <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        trafficIndicatorR <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">uint8_t</span> LowVoltageEle <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>brakeLight <span class="token operator">+</span> headlight <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> trafficIndicatorL <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> trafficIndicatorR <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">uint8_t</span> checksumSpeed <span class="token operator">=</span> gear_contrl <span class="token operator">+</span> Speed_L <span class="token operator">+</span> Speed_H <span class="token operator">+</span> LowVoltageEle<span class="token punctuation">;</span>

    <span class="token comment">/* 发送数据 进入线控 协议需要每次先要发速度清空 */</span>
    frameE2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> gear_contrl<span class="token punctuation">;</span>
    frameE2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    frameE2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    frameE2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> LowVoltageEle<span class="token punctuation">;</span>
    frameE2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> checksumSpeed<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frameE2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>frameE2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送数据</span>

    <span class="token comment">// 7. 生成速度控制指令 发送数据</span>
    frameE2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> gear_contrl<span class="token punctuation">;</span>
    frameE2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Speed_L<span class="token punctuation">;</span>
    frameE2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> Speed_H<span class="token punctuation">;</span>
    frameE2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> LowVoltageEle<span class="token punctuation">;</span>
    frameE2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> checksumSpeed<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frameE2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>frameE2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送数据</span>

    <span class="token comment">// 8. 计算角度byte</span>
    <span class="token comment">// 转弯的角度 = arctan(( 角速度 / 线速度 ) * 轴距 )</span>
    <span class="token comment">// 左转是rZ正方向，而这个底盘最左是负，因此加-号</span>
    <span class="token comment">// TODO</span>
    <span class="token keyword">double</span> angular <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">atan</span><span class="token punctuation">(</span><span class="token punctuation">(</span>angular_vel <span class="token operator">/</span> <span class="token function">fabs</span><span class="token punctuation">(</span>linear_vel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> wheel_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> angular_byte <span class="token operator">=</span> <span class="token number">3.6</span> <span class="token operator">*</span> angular <span class="token operator">*</span> <span class="token number">180</span> <span class="token operator">/</span> M_PI <span class="token operator">+</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token comment">// std::cout &lt;&lt; "Send打角值为: " &lt;&lt; angular_byte &lt;&lt; std::endl;</span>
    <span class="token keyword">uint8_t</span> angular_L <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>angular_byte <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint8_t</span> angular_H <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>angular_byte <span class="token operator">/</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 9. 计算角度校验和</span>
    <span class="token keyword">uint8_t</span> checksumAng <span class="token operator">=</span> <span class="token number">0x20</span> <span class="token operator">+</span> angular_H <span class="token operator">+</span> angular_L<span class="token punctuation">;</span>

    <span class="token comment">// 10. 生成角度控制指令 发送数据</span>
    frame469<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> angular_H<span class="token punctuation">;</span>
    frame469<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> angular_L<span class="token punctuation">;</span>
    frame469<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> checksumSpeed<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame469<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>frame469<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送数据</span>
<span class="token punctuation">}</span>

<span class="token comment">// 2 析构函数</span>
<span class="token class-name">canControl</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">canControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* 发送数据 退出线控 */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        frameE2<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frameE2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>frameE2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送数据</span>

    <span class="token comment">/* 关闭套接字 */</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="24__673"></a>2.4 功能包配置</h3> 
<p>can_control.launch</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>launch</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>can_receive_node<span class="token punctuation">"</span></span> <span class="token attr-name">pkg</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>can_ros1_driver<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>can_receive_node<span class="token punctuation">"</span></span> <span class="token attr-name">output</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>screen<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 小车轴距 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wheel_base<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.35<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>can_send_node<span class="token punctuation">"</span></span> <span class="token attr-name">pkg</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>can_ros1_driver<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>can_send_node<span class="token punctuation">"</span></span> <span class="token attr-name">output</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>screen<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 小车轴距 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wheel_base<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.35<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- 是否为Autoware速度 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Autoware<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- 接收的速度话题 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>twistTopic<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/turtle1/cmd_vel<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>launch</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>cmakeLists</p> 
<pre><code class="prism language-bash">cmake_minimum_required<span class="token punctuation">(</span>VERSION <span class="token number">3.0</span>.2<span class="token punctuation">)</span>
project<span class="token punctuation">(</span>can_ros1_driver<span class="token punctuation">)</span>

add_compile_options<span class="token punctuation">(</span>-std<span class="token operator">=</span>c++11<span class="token punctuation">)</span>

find_package<span class="token punctuation">(</span>catkin REQUIRED COMPONENTS
  roscpp
  tf
  std_msgs
  nav_msgs
  geometry_msgs
<span class="token punctuation">)</span>

catkin_package<span class="token punctuation">(</span> CATKIN_DEPENDS roscpp tf std_msgs nav_msgs geometry_msgs<span class="token punctuation">)</span>

include_directories<span class="token punctuation">(</span>
  include
  <span class="token variable">${catkin_INCLUDE_DIRS}</span><span class="token punctuation">)</span>

add_executable<span class="token punctuation">(</span>can_receive_node src/can_receive.cpp src/can_receive_node.cpp<span class="token punctuation">)</span>
<span class="token comment"># ROS相关库</span>
target_link_libraries<span class="token punctuation">(</span>can_receive_node <span class="token variable">${catkin_LIBRARIES}</span><span class="token punctuation">)</span>

add_executable<span class="token punctuation">(</span>can_send_node src/can_send.cpp src/can_send_node.cpp<span class="token punctuation">)</span>
target_link_libraries<span class="token punctuation">(</span>can_send_node <span class="token variable">${catkin_LIBRARIES}</span><span class="token punctuation">)</span>

</code></pre> 
<p>package.xml</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>package</span> <span class="token attr-name">format</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>can_ros1_driver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>The can_ros1_driver package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maintainer</span> <span class="token attr-name">email</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>WangBin@todo.todo<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>WangBin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maintainer</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>license</span><span class="token punctuation">&gt;</span></span>TODO<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>license</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>buildtool_depend</span><span class="token punctuation">&gt;</span></span>catkin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>buildtool_depend</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>depend</span><span class="token punctuation">&gt;</span></span>roscpp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>depend</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>depend</span><span class="token punctuation">&gt;</span></span>tf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>depend</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>depend</span><span class="token punctuation">&gt;</span></span>std_msgs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>depend</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>depend</span><span class="token punctuation">&gt;</span></span>nav_msgs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>depend</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>depend</span><span class="token punctuation">&gt;</span></span>geometry_msgs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>depend</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>package</span><span class="token punctuation">&gt;</span></span>

</code></pre> 
<h2><a id="ROS2_744"></a>三、ROS2驱动程序</h2> 
<p>TODO</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/264a5dc348e90a9dd8eeb0aba861ac14/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">linux下删除正在使用的文件（bin、so）会发生什么？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/760a6ce0d08ee358fa5ae76c8f716014/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">复杂度分析-时间复杂度和空间复杂度</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>