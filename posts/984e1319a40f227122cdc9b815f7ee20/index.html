<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring Cloud 实战系列：服务网关 Spring Cloud Gateway - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Spring Cloud 实战系列：服务网关 Spring Cloud Gateway" />
<meta property="og:description" content="🌈 服务网关 Spring Cloud Gateway 🐙 为什么需要服务网关 微服务架构的系统，拥有众多子服务，如果客户端直接与各个微服务进行通信，会有以下的问题：
客户端需要记录各个服务的地址各个服务都需要单独处理跨域各个服务都需要单独权限认证。。。 🐙 什么是服务网关 服务网关是介于客户端和服务端之间的中间层，所有的外部请求都会先经过网关这一层。由网关决定将请求路由到具体服务。
可以处理非业务的的逻辑，如安全、监控、限流、熔断、授权等等。
🐙 什么是 Spring cloud Gateway 一个构建在 Spring 生态系统之上的 API 网关，包括：Spring 6、Spring Boot 3、Spring Webflux 和 Project Reactor。Spring Cloud Gateway 旨在提供一种简单而有效的方法来路由到 API，并为它们提供横切关注点，例如：安全性、监控/指标和弹性。
🍅 1、术语
Route：Gateway 的基本构建块。它由 ID、目标 URI、谓词集合和过滤器集合定义。如果聚合谓词为真，则路由匹配。
Predicate：是一个Java 8 函数谓词。输入类型是Spring FrameworkServerWebExchange。可以匹配 HTTP 请求中的任何内容，例如请求头或参数。
Filter：是GatewayFilter使用特定工厂构建的实例。可以在发送下游请求之前或之后修改请求和响应。
🍅 2、工作原理
官网提供了 Spring Cloud Gateway 工作原理的高级概述图：
客户端向 Spring Cloud Gateway 发出请求。如果 Gateway Handler Mapping 确定请求与路由匹配，则将其发送到 Gateway Web Handler。此处理程序通过特定于请求的过滤器链运行请求。过滤器被虚线分开的原因是过滤器可以在发送代理请求之前和之后运行逻辑。执行所有 “pre” 过滤器逻辑。然后进行代理请求。发出代理请求后，运行 “post” 过滤器逻辑。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/984e1319a40f227122cdc9b815f7ee20/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-27T18:18:43+08:00" />
<meta property="article:modified_time" content="2023-05-27T18:18:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring Cloud 实战系列：服务网关 Spring Cloud Gateway</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="rainbow__Spring_Cloud_Gateway_0"></a>🌈 服务网关 Spring Cloud Gateway</h2> 
<h3><a id="octopus__2"></a>🐙 为什么需要服务网关</h3> 
<p>微服务架构的系统，拥有众多子服务，如果客户端直接与各个微服务进行通信，会有以下的问题：</p> 
<ol><li>客户端需要记录各个服务的地址</li><li>各个服务都需要单独处理跨域</li><li>各个服务都需要单独权限认证</li><li>。。。</li></ol> 
<h3><a id="octopus__11"></a>🐙 什么是服务网关</h3> 
<p>服务网关是介于客户端和服务端之间的中间层，所有的外部请求都会先经过网关这一层。由网关决定将请求路由到具体服务。</p> 
<p>可以处理非业务的的逻辑，如安全、监控、限流、熔断、授权等等。</p> 
<p><img src="https://images2.imgbox.com/c8/81/gQ8pUt4h_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="octopus__Spring_cloud_Gateway_19"></a>🐙 什么是 Spring cloud Gateway</h3> 
<p>一个构建在 Spring 生态系统之上的 API 网关，包括：Spring 6、Spring Boot 3、Spring Webflux 和 Project Reactor。Spring Cloud Gateway 旨在提供一种简单而有效的方法来路由到 API，并为它们提供横切关注点，例如：安全性、监控/指标和弹性。</p> 
<p>🍅 1、术语</p> 
<p><code>Route</code>：Gateway 的基本构建块。它由 ID、目标 URI、谓词集合和过滤器集合定义。如果聚合谓词为真，则路由匹配。</p> 
<p><code>Predicate</code>：是一个Java 8 函数谓词。输入类型是Spring FrameworkServerWebExchange。可以匹配 HTTP 请求中的任何内容，例如请求头或参数。</p> 
<p><code>Filter</code>：是GatewayFilter使用特定工厂构建的实例。可以在发送下游请求之前或之后修改请求和响应。</p> 
<p>🍅 2、工作原理</p> 
<p>官网提供了 Spring Cloud Gateway 工作原理的高级概述图：</p> 
<p><img src="https://images2.imgbox.com/cc/34/KFAj0N7p_o.png" alt="在这里插入图片描述"></p> 
<p>客户端向 Spring Cloud Gateway 发出请求。如果 Gateway Handler Mapping 确定请求与路由匹配，则将其发送到 Gateway Web Handler。此处理程序通过特定于请求的过滤器链运行请求。过滤器被虚线分开的原因是过滤器可以在发送代理请求之前和之后运行逻辑。执行所有 <code>“pre”</code> 过滤器逻辑。然后进行代理请求。发出代理请求后，运行 <code>“post”</code> 过滤器逻辑。</p> 
<h2><a id="rainbow_Spring_Cloud_Gateway__40"></a>🌈 Spring Cloud Gateway 实战</h2> 
<h3><a id="octopus__42"></a>🐙 版本定义</h3> 
<p>使用的版本如下：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.boot.version</span><span class="token punctuation">&gt;</span></span>2.6.13<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.boot.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.cloud.version</span><span class="token punctuation">&gt;</span></span>2021.0.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.cloud.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.cloud-alibaba.version</span><span class="token punctuation">&gt;</span></span>2021.0.5.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.cloud-alibaba.version</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="octopus__gateway_52"></a>🐙 新建模块 gateway</h3> 
<p>1、添加依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bootstrap<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>2、添加配置</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> spring<span class="token punctuation">-</span>cloud<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token comment"># 路由配置</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user_routh  <span class="token comment"># 路由ID，没有固定规则但要求唯一</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8001</span>  <span class="token comment"># 匹配后提供服务的路由地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/user<span class="token punctuation">-</span>service/<span class="token important">**</span>  <span class="token comment"># 断言，路径相匹配的进行路由</span>
</code></pre> 
<p>3、启动用户服务，网关服务</p> 
<p>先访问用户服务自身接口：http://localhost:8001/user-service/user/1，请求成功。</p> 
<p>通过网关路由到用户服务：http://localhost/user-service/user/1，请求成功。</p> 
<h2><a id="rainbow_Spring_Cloud_Gateway__89"></a>🌈 Spring Cloud Gateway 谓词</h2> 
<h3><a id="octopus__91"></a>🐙 ​配置路由谓词和过滤器</h3> 
<p>有两种配置谓词和过滤器的方法：快捷方式和完全扩展的参数。</p> 
<p>1、快捷方式配置</p> 
<p>快捷方式配置由过滤器名称识别，后跟等号 <code>=</code> ，然后是用逗号 <code>,</code> 分隔的参数值。</p> 
<p>示例</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> example_route
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8001</span>
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> Cookie=mycookie<span class="token punctuation">,</span>mycookievalue
</code></pre> 
<p>2、完全扩展的参数</p> 
<p>完全扩展的参数是带有名称/值的标准 yaml 配置。</p> 
<p>示例</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> example_route
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8001</span>
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Cookie
          <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> mycookie
            <span class="token key atrule">regexp</span><span class="token punctuation">:</span> mycookievalue
</code></pre> 
<h3><a id="octopus__132"></a>🐙 路由谓词工厂</h3> 
<p>Spring Cloud Gateway 包含许多内置的路由谓词工厂。所有这些谓词都匹配 HTTP 请求的不同属性。</p> 
<p>这些 Predict 的源码在 <code>org.springframework.cloud.gateway.handler.predicate</code> 包中。</p> 
<p>Spring Cloud Gateway 中的谓词工厂命名都是有规范的，格式：<code>xxxRoutePredicateFactory</code>。</p> 
<p>比如 Cookie 的路由谓词工厂：<code>CookieRoutePredicateFactory</code>，使用配置时直接取前面的 Cookie。</p> 
<p>一些示例：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//payment<span class="token punctuation">-</span>service
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/<span class="token important">**</span>
            <span class="token punctuation">-</span> After=2020<span class="token punctuation">-</span>02<span class="token punctuation">-</span>21T15<span class="token punctuation">:</span>51<span class="token punctuation">:</span>37.485+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
            <span class="token punctuation">-</span> Cookie=username<span class="token punctuation">,</span>don
            <span class="token punctuation">-</span> Header=X<span class="token punctuation">-</span>Request<span class="token punctuation">-</span>Id<span class="token punctuation">,</span> \d+  <span class="token comment"># 请求头要有X-Request-Id属性并且值为整数的正则表达式</span>
</code></pre> 
<h2><a id="rainbow_Spring_Cloud_Gateway__158"></a>🌈 Spring Cloud Gateway 过滤器</h2> 
<p>过滤器允许以某种方式修改传入的 HTTP 请求或传出的 HTTP 响应。</p> 
<p>🍅 ​1、过滤器的生命周期</p> 
<p><code>PRE</code>：过滤器在请求路由之前调用。可以用来实现身份验证、在集群中选择请求的微服务、记录调试信息等。</p> 
<p><code>POST</code>：过滤器在请求路由到微服务执行响应后调用。可以为响应添加标准的HTTP Header、收集统计信息等。</p> 
<p>🍅 ​2、过滤器的分类</p> 
<p>分为路由过滤器 <code>GatewayFilter</code> 和 全局过滤器 <code>GlobalFilter</code>。</p> 
<p>路由过滤器的作用范围是特定路由；全局过滤器应用于所有路由。</p> 
<h3><a id="octopus__174"></a>🐙 路由过滤器</h3> 
<p>路由过滤器允许以某种方式修改传入的 HTTP 请求或传出的 HTTP 响应。路由过滤器的范围是特定路由。</p> 
<p>Spring Cloud Gateway 内置了许多路由过滤器，多达 30 多个。详细参考文档：</p> 
<p>https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories</p> 
<p>🍅 1、路由过滤器的使用</p> 
<p>示例，StripPrefix 网关过滤器工厂采用一个参数 <code>parts</code>。parts 参数指示在将请求发送到服务之前要从请求路径中移除的层数。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user_routh  <span class="token comment"># 路由ID，没有固定规则但要求唯一</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>service  <span class="token comment"># 匹配后提供服务的路由地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/user<span class="token punctuation">-</span>service/<span class="token important">**</span>  <span class="token comment"># 断言，路径相匹配的进行路由</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> StripPrefix=1  <span class="token comment"># 将路径第一层移除</span>
</code></pre> 
<p>当向网关发送请求 http://localhost/user-service/user/1 时，经过路由转发到服务的是 <code>nameservice/user/1</code>，也即移除了第一层 <code>user-service</code>。</p> 
<p>🍅 2、自定义路由过滤器</p> 
<p>新建一个 <code>GatewayFilterFactory</code> 类，继承抽象类 <code>AbstractGatewayFilterFactory</code>，命名必须是<code>xxxGatewayFilterFactory</code>。</p> 
<p>示例，计算请求服务调用耗时：</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GatewayFilter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">AbstractGatewayFilterFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeGatewayFilterFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractGatewayFilterFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeGatewayFilterFactory<span class="token punctuation">.</span>Config</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> BEGIN_TIME <span class="token operator">=</span> <span class="token string">"beginTime"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">TimeGatewayFilterFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Config</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 读取配置文件中的参数赋值到配置类中
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">shortcutFieldOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">"showTime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">GatewayFilter</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Config</span> config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> chain<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">.</span>showTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果配置类中的show为false表示放行</span>
                <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            exchange<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>BEGIN_TIME<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/*
             * pre 的逻辑
             * chain.filter().then(Mono.fromRunnable(()-&gt;{
             *     post 的逻辑
             * }))
             */</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromRunnable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Long</span> startTime <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>BEGIN_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" (耗时: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//Put the configuration properties for your filter here</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> showTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>配置：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user_routh  <span class="token comment"># 路由ID，没有固定规则但要求唯一</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>service  <span class="token comment"># 匹配后提供服务的路由地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/user<span class="token punctuation">-</span>service/<span class="token important">**</span>  <span class="token comment"># 断言，路径相匹配的进行路由</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Time=true
</code></pre> 
<p>访问请求，查看控制台：</p> 
<pre><code>http://localhost/user-service/user/1 (耗时: 496ms)
</code></pre> 
<h3><a id="octopus__287"></a>🐙 全局过滤器</h3> 
<p><code>GlobalGilter</code> 全局过滤器接口与 <code>GatewayFilter</code> 网关过滤器接口具有相同的方法定义。全局过滤器是一系列特殊的过滤器，会根据条件应用到所有路由中。</p> 
<p>多个 <code>GlobalFilter</code> 可以通过 <code>@Order</code> 或者 <code>getOrder()</code> 方法指定每个 <code>GlobalFilter</code> 的执行顺序，<code>order</code> 值越小，执行的优先级越高。</p> 
<p>Spring Cloud Gateway 内置了多个全局过滤器对整个路由进行处理。</p> 
<p>🍅 ​1、内置的 <code>GlobalFilter</code> 全局过滤器</p> 
<ul><li><code>ForwardRoutingFilter</code> ：转发路由过滤器</li><li><code>ReactiveLoadBalancerClientFilter</code> ：负载均衡客户端过滤器</li><li><code>NettyRoutingFilter</code> 和 <code>NettyWriteResponseFilter</code> ：通过 <code>HttpClient</code> 客户端转发请求直实的URL并将响应写入到当前的请求响应中</li><li><code>RouteToRequestUrlFilter</code> ：路由到指定URL的过滤器</li><li><code>WebsocketRoutingFilter</code> ：负责处理 <code>Websocket</code> 类型的清求响应信息</li><li><code>WebClientHttpRoutingFilter</code> 和 <code>WebClientWriteResponseFilter</code> ：通过 <code>WebClient</code> 客户端转发请求直实的URL并将响应写入到当前的请求响应中</li></ul> 
<p>🍅 2、自定义全局过滤器</p> 
<p>新建过滤器实现 <code>GlobalFilter</code> 接口，并注入到容器中</p> 
<p>示例：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 访问日志全局过滤器
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccessLogGlobalFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">// filter 的前置处理</span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> path <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pathWithinApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InetSocketAddress</span> remoteAddress <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> chain
                <span class="token comment">// 继续调用 filter</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span>
                <span class="token comment">// filter 的后置处理</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromRunnable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">HttpStatus</span> statusCode <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"请求路径:{}, IP地址:{}, 响应码:{}"</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> remoteAddress<span class="token punctuation">,</span> statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>全局过滤器不必在路由上配置，注入到 IOC 容器中即可全局生效。</p> 
<h2><a id="rainbow_Spring_Cloud_Gateway__345"></a>🌈 Spring Cloud Gateway 集成注册中心</h2> 
<p>上述在配置文件中路由的服务地址是固定的 <code>uri</code> ，这种配置存在一定缺点：</p> 
<ol><li>微服务的地址修改了，路由配置中的 <code>uri</code> 必须修改</li><li>微服务集群无法实现负载均衡</li></ol> 
<p>即需要集成注册中心，使得网关能够从注册中心自动获取服务地址实现负载均衡。</p> 
<h3><a id="octopus__Nacos_354"></a>🐙 集成注册中心 Nacos</h3> 
<p>下文通过集成 Nacos 在注册中心来获取各个微服务的地址。</p> 
<p>1、添加 Nacos 依赖</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- Nacos 注册中心 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 负载均衡 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-loadbalancer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>2、在主启动类添加注解</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span><span class="token class-name">EnableDiscoveryClient</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@EnableDiscoveryClient</span>
</code></pre> 
<p>3、修改配置文件</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> spring<span class="token punctuation">-</span>cloud<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 开启从注册中心动态创建路由的功能，利用微服务名进行路由</span>
          <span class="token key atrule">lower-case-service-id</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 小写</span>
      <span class="token comment"># 路由配置</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user_routh  <span class="token comment"># 路由ID，没有固定规则但要求唯一</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>service  <span class="token comment"># 从注册中心获取微服务地址,并遵循负载均衡策略</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/user<span class="token punctuation">-</span>service/<span class="token important">**</span>  <span class="token comment"># 断言，路径相匹配的进行路由</span>
    <span class="token comment"># Nacos 配置</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre> 
<p>路由配置中，路由的 uri 格式：<code>lb://service-name</code>，这是固定写法：</p> 
<ul><li> <p><code>lb</code>：指的是从注册中心按照名称获取微服务地址，并遵循负载均衡策略</p> 
  <blockquote> 
   <p>全局过滤器 <code>ReactiveLoadBalancerClientFilter</code> 处理路由和负载均衡</p> 
  </blockquote> </li><li> <p><code>service-name</code>：注册中心的服务名称</p> </li></ul> 
<p>4、启动用户服务，网关服务</p> 
<p>成功注册到注册中心 Nacos：</p> 
<p><img src="https://images2.imgbox.com/a9/3f/CUYTDuZY_o.png" alt="在这里插入图片描述"></p> 
<p>通过网关路由到用户服务：http://localhost/user-service/user/1，请求成功。</p> 
<h2><a id="rainbow_Spring_Cloud_Gateway__421"></a>🌈 Spring Cloud Gateway 集成配置中心</h2> 
<p>如果将网关的一系列配置写到项目的配置文件中，一旦路由发生改变必须要重启项目，这样维护成本很高。</p> 
<p>可以将网关的配置存放到配置中心中，这样由配置中心统一管理，一旦路由发生改变，只需要在配置中心修改。</p> 
<h3><a id="octopus__Nacos__427"></a>🐙 集成配置中心 Nacos 实现动态路由</h3> 
<p>下文通过集成 Nacos 在配置中心来管理路由信息。</p> 
<p>1、添加依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>2、在 <code>bootstrap.yml</code> 配置 Nacos 作为配置中心</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> spring<span class="token punctuation">-</span>cloud<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token comment">### Nacos 配置</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token comment"># 指定文件后缀未yaml</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
</code></pre> 
<p>3、在 Nacos 中的默认命名空间中创建 Data ID 为 <code>spring-cloud-gateway.yaml</code> 的配置（未指定环境），编写路由信息</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token comment">## 路由配置</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>service          <span class="token comment"># 路由的ID，没有固定规则但要求唯一，建议配合服务名</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//system<span class="token punctuation">-</span>service    <span class="token comment"># 匹配后提供服务的路由地址，lb 负载均衡</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/system<span class="token punctuation">-</span>service/<span class="token important">**</span>   <span class="token comment"># 断言，路径相匹配的进行路由</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Time=true
</code></pre> 
<p>4、启动网关服务</p> 
<p>发送请求 http://localhost/system-service/dept 成功路由到系统服务</p> 
<h2><a id="rainbow_Spring_Cloud_Gateway__475"></a>🌈 Spring Cloud Gateway 异常处理</h2> 
<p>当网关服务或业务服务出现异常时，Spring Cloud Gateway 会返回一堆错误信息，非常不友好。</p> 
<p>Spring Boot 服务中都是使用 <code>@ControllerAdvice</code> 来包装全局异常处理的，当服务下线或宕机时，请求并没有到达服务。这时网关中也要定制一层全局异常处理，这样才能更加友好的和客户端交互。</p> 
<h3><a id="octopus__481"></a>🐙 自定义全局异常处理</h3> 
<p>创建一个类 <code>GlobalErrorExceptionHandler</code> 实现 <code>ErrorWebExceptionHandler</code> 重写其中的 handle 方法：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 网关的全局异常处理
 * &lt;p&gt;
 * 优先级一定要小于内置 ResponseStatusExceptionHandler 经过它处理的获取对应错误类的 响应码
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalErrorExceptionHandler</span> <span class="token keyword">implements</span> <span class="token class-name">ErrorWebExceptionHandler</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">// 已经 commit 则直接返回异常</span>
        <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isCommitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 转换成 Result</span>
        <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> result<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            result <span class="token operator">=</span> <span class="token function">notFoundExceptionHandler</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">NotFoundException</span><span class="token punctuation">)</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">ResponseStatusException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            result <span class="token operator">=</span> <span class="token function">responseStatusExceptionHandler</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">ResponseStatusException</span><span class="token punctuation">)</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            result <span class="token operator">=</span> <span class="token function">defaultExceptionHandler</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 返回给前端</span>
        <span class="token keyword">return</span> <span class="token class-name">WebUtil</span><span class="token punctuation">.</span><span class="token function">writeJson</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 处理 Spring Cloud Gateway 抛出的 NotFoundException 异常
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">notFoundExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">NotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[Gateway NotFoundException]. uri({} / {}), ex({})]"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getRawStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"服务未找到"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 处理 Spring Cloud Gateway 默认抛出的 ResponseStatusException 异常
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">responseStatusExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">ResponseStatusException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[Gateway ResponseStatusException]. uri({} / {}), ex({})]"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getRawStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 兜底处理系统异常
     */</span>
    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">defaultExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[Gateway Exception]. uri({} / {}), ex({})]"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token class-name">CommonConstants</span><span class="token punctuation">.</span>FAIL<span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>重启网关服务测试：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"code"</span><span class="token operator">:</span> <span class="token number">503</span><span class="token punctuation">,</span>
    <span class="token string-property property">"msg"</span><span class="token operator">:</span> <span class="token string">"服务未找到"</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="rainbow_Spring_Cloud_Gateway_559"></a>🌈 Spring Cloud Gateway</h2> 
<h2><a id="rainbow_Spring_Cloud_Gateway_564"></a>🌈 Spring Cloud Gateway</h2> 
<h2><a id="rainbow_Spring_Cloud_Gateway_569"></a>🌈 Spring Cloud Gateway</h2> 
<h2><a id="rainbow_Spring_Cloud_Gateway_574"></a>🌈 Spring Cloud Gateway</h2> 
<h2><a id="rainbow_Spring_Cloud_Gateway_579"></a>🌈 Spring Cloud Gateway</h2>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3904717f24553589e651a52dfe1fea51/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring Cloud 实战系列：服务注册与发现 Alibaba Nacos</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2d20b7df1d97e94b67057ec901e66e60/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">k8s可视化管理工具Rancher安装和使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>