<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>OpenCV-针对不同分辨率的匹配操作 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="OpenCV-针对不同分辨率的匹配操作" />
<meta property="og:description" content="针对不同分辨率的匹配操作 项目要求OpenCV模板匹配模板匹配的工作方式模板匹配的匹配方式模板匹配存在的问题 解决方法方法1：直方图&#43;自适应模板匹配结果 方法二：SIFT效果 方法三：灰度匹配&#43;模板匹配结果和结论 项目要求 有一个需要，在UI自动化中，我们需要匹配某个元素在app中的位置，如何获取该元素的位置呢？一般可以通过Automation ID或者XPath，但是，有些控件或者元素，它无法通过这种方法定位，所以，我们把问题抽象成在一张图片中，框出目标元素的位置。
OpenCV模板匹配 模板匹配的工作方式 模板匹配的工作方式跟直方图的反向投影基本一样，大致过程是这样的：通过在输入图像上滑动图像块对实际的图像块和输入图像进行匹配。
假设我们有一张100x100的输入图像，有一张10x10的模板图像，查找的过程是这样的：
（1）从输入图像的左上角(0,0)开始，切割一块(0,0)至(10,10)的临时图像；
（2）用临时图像和模板图像进行对比，对比结果记为c；
（3）对比结果c，就是结果图像(0,0)处的像素值；
（4）切割输入图像从(0,1)至(10,11)的临时图像，对比，并记录到结果图像；
（5）重复（1）～（4）步直到输入图像的右下角。
大家可以看到，直方图反向投影对比的是直方图，而模板匹配对比的是图像的像素值；模板匹配比直方图反向投影速度要快一些，但是我个人认为直方图反向投影的鲁棒性会更好。
模板匹配的匹配方式 在OpenCv和EmguCv中支持以下6种对比方式： CV_TM_SQDIFF 平方差匹配法：该方法采用平方差来进行匹配；最好的匹配值为0；匹配越差，匹配值越大。 CV_TM_CCORR 相关匹配法：该方法采用乘法操作；数值越大表明匹配程度越好。 CV_TM_CCOEFF 相关系数匹配法：1表示完美的匹配；-1表示最差的匹配。 CV_TM_SQDIFF_NORMED 归一化平方差匹配法 CV_TM_CCORR_NORMED 归一化相关匹配法 CV_TM_CCOEFF_NORMED 归一化相关系数匹配法 根据我的测试结果来看，上述几种匹配方式需要的计算时间比较接近（跟《学习OpenCV》书上说的不同），我们可以选择一个能适应场景的匹配方式。
模板匹配存在的问题 1.对于分辨率不同的图片，它无法正常匹配。在实际的任务中，我们的模板图片可能发生分辨率的改变。
2.对于些许形变的图片，它也无法正常匹配。
3.截图内容无法匹配。
原图：
传统匹配结果：
关于自适应屏幕显示：
#include &lt;opencv2/opencv.hpp&gt; #include &lt;iostream&gt; using namespace cv; using namespace std; void Show_Picture() { Mat src = imread(&#34;C:/Users/wenhaofu/Desktop/Multi-Scale-Template-Matching-master/test3.png&#34;); if (src.empty()) { printf(&#34;could not load image...\n&#34;); return; } namedWindow(&#34;input&#34;, WINDOW_NORMAL); imshow(&#34;input&#34;, src); waitKey(0); return; } int main(int artc, char** argv) { Show_Picture(); return 0; } 但是为了完整得显示图片，多次尝试发现，flag参数为WINDOW_NORMAL时才可以在手动调整窗口的条件下显示完整的图片。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f3510d2b2491de86df604226644ced6d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-20T10:51:38+08:00" />
<meta property="article:modified_time" content="2022-07-20T10:51:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">OpenCV-针对不同分辨率的匹配操作</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>针对不同分辨率的匹配操作</h4> 
 <ul><li><a href="#_2" rel="nofollow">项目要求</a></li><li><ul><li><a href="#OpenCV_4" rel="nofollow">OpenCV模板匹配</a></li><li><ul><li><a href="#_5" rel="nofollow">模板匹配的工作方式</a></li><li><a href="#_14" rel="nofollow">模板匹配的匹配方式</a></li><li><a href="#_23" rel="nofollow">模板匹配存在的问题</a></li></ul> 
   </li><li><a href="#_59" rel="nofollow">解决方法</a></li><li><ul><li><a href="#1_60" rel="nofollow">方法1：直方图+自适应模板匹配</a></li><li><ul><li><a href="#_209" rel="nofollow">结果</a></li></ul> 
    </li><li><a href="#SIFT_211" rel="nofollow">方法二：SIFT</a></li><li><ul><li><a href="#_285" rel="nofollow">效果</a></li></ul> 
    </li><li><a href="#_288" rel="nofollow">方法三：灰度匹配+模板匹配</a></li><li><ul><li><a href="#_411" rel="nofollow">结果和结论</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>项目要求</h2> 
<p>有一个需要，在UI自动化中，我们需要匹配某个元素在app中的位置，如何获取该元素的位置呢？一般可以通过Automation ID或者XPath，但是，有些控件或者元素，它无法通过这种方法定位，所以，我们把问题抽象成在一张图片中，框出目标元素的位置。</p> 
<h3><a id="OpenCV_4"></a>OpenCV模板匹配</h3> 
<h4><a id="_5"></a>模板匹配的工作方式</h4> 
<p>模板匹配的工作方式跟直方图的反向投影基本一样，大致过程是这样的：通过在输入图像上滑动图像块对实际的图像块和输入图像进行匹配。<br> 假设我们有一张100x100的输入图像，有一张10x10的模板图像，查找的过程是这样的：<br> （1）从输入图像的左上角(0,0)开始，切割一块(0,0)至(10,10)的临时图像；<br> （2）用临时图像和模板图像进行对比，对比结果记为c；<br> （3）对比结果c，就是结果图像(0,0)处的像素值；<br> （4）切割输入图像从(0,1)至(10,11)的临时图像，对比，并记录到结果图像；<br> （5）重复（1）～（4）步直到输入图像的右下角。<br> 大家可以看到，直方图反向投影对比的是直方图，而模板匹配对比的是图像的像素值；模板匹配比直方图反向投影速度要快一些，但是我个人认为直方图反向投影的鲁棒性会更好。</p> 
<h4><a id="_14"></a>模板匹配的匹配方式</h4> 
<pre><code>在OpenCv和EmguCv中支持以下6种对比方式：
CV_TM_SQDIFF 平方差匹配法：该方法采用平方差来进行匹配；最好的匹配值为0；匹配越差，匹配值越大。
CV_TM_CCORR 相关匹配法：该方法采用乘法操作；数值越大表明匹配程度越好。
CV_TM_CCOEFF 相关系数匹配法：1表示完美的匹配；-1表示最差的匹配。
CV_TM_SQDIFF_NORMED 归一化平方差匹配法
CV_TM_CCORR_NORMED 归一化相关匹配法
CV_TM_CCOEFF_NORMED 归一化相关系数匹配法
</code></pre> 
<p>根据我的测试结果来看，上述几种匹配方式需要的计算时间比较接近（跟《学习OpenCV》书上说的不同），我们可以选择一个能适应场景的匹配方式。</p> 
<h4><a id="_23"></a>模板匹配存在的问题</h4> 
<p>1.对于分辨率不同的图片，它无法正常匹配。在实际的任务中，我们的模板图片可能发生分辨率的改变。<br> 2.对于些许形变的图片，它也无法正常匹配。<br> 3.截图内容无法匹配。</p> 
<p>原图：<img src="https://images2.imgbox.com/92/4a/fRI4PKNR_o.png" alt="原图"><br> 传统匹配结果：<br> <img src="https://images2.imgbox.com/63/41/0XEZE4uX_o.png" alt="test"></p> 
<p>关于自适应屏幕显示：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Show_Picture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	Mat src <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"C:/Users/wenhaofu/Desktop/Multi-Scale-Template-Matching-master/test3.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"could not load image...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">,</span> WINDOW_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> artc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">Show_Picture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>但是为了完整得显示图片，多次尝试发现，flag参数为WINDOW_NORMAL时才可以在手动调整窗口的条件下显示完整的图片。</p> 
<h3><a id="_59"></a>解决方法</h3> 
<h4><a id="1_60"></a>方法1：直方图+自适应模板匹配</h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;opencv2/highgui/highgui_c.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;math.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"histogram.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"GrayMatching.h"</span></span>
<span class="token keyword">struct</span> <span class="token class-name">Best_Rect</span>
<span class="token punctuation">{<!-- --></span>
	Point best_point<span class="token punctuation">;</span>
	Mat best_mat<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>

<span class="token keyword">int</span> match_method <span class="token operator">=</span> CV_TM_SQDIFF_NORMED<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">template_match_demo</span><span class="token punctuation">(</span>Mat<span class="token operator">&amp;</span> test1<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> test2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">histogram</span><span class="token punctuation">(</span>string<span class="token operator">&amp;</span> s1<span class="token punctuation">,</span>string<span class="token operator">&amp;</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//C:/Users/wenhaofu/Desktop/Multi-Scale-Template-Matching-master/test1.png</span>
<span class="token comment">//C:/Users/wenhaofu/Desktop/Multi-Scale-Template-Matching-master/button.png</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	string s1 <span class="token operator">=</span> <span class="token string">"C:/Users/wenhaofu/Desktop/Multi-Scale-Template-Matching-master/test3.png"</span><span class="token punctuation">;</span>
	string s2 <span class="token operator">=</span> <span class="token string">"C:/Users/wenhaofu/Desktop/Multi-Scale-Template-Matching-master/button.png"</span><span class="token punctuation">;</span>
	<span class="token comment">//histogram(s1,s2);</span>
	clock_t start_time <span class="token operator">=</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">graymatching</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	clock_t end_time <span class="token operator">=</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span>end_time <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">/</span> CLOCKS_PER_SEC <span class="token operator">&lt;&lt;</span><span class="token string">"s"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">histogram</span><span class="token punctuation">(</span>string<span class="token operator">&amp;</span> s1<span class="token punctuation">,</span> string<span class="token operator">&amp;</span> s2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	Mat test<span class="token punctuation">,</span> temp<span class="token punctuation">;</span>
	test <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//待检测图像</span>
	temp <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//模板图像</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> temp<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"could not load image...\n"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">template_match_demo</span><span class="token punctuation">(</span>test<span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">template_match_demo</span><span class="token punctuation">(</span>Mat<span class="token operator">&amp;</span> test1<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> temp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	map<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> Best_Rect<span class="token operator">&gt;</span> record<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">15</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		Mat test <span class="token operator">=</span> test1<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> new_rows <span class="token operator">=</span> test1<span class="token punctuation">.</span>rows <span class="token operator">-</span> i <span class="token operator">*</span> <span class="token number">0.05</span> <span class="token operator">*</span> test1<span class="token punctuation">.</span>rows<span class="token punctuation">;</span>
		<span class="token keyword">int</span> new_cols <span class="token operator">=</span> test1<span class="token punctuation">.</span>cols <span class="token operator">-</span> i <span class="token operator">*</span> <span class="token number">0.05</span> <span class="token operator">*</span> test1<span class="token punctuation">.</span>cols<span class="token punctuation">;</span>
		<span class="token function">resize</span><span class="token punctuation">(</span>test<span class="token punctuation">,</span> test<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span>new_cols<span class="token punctuation">,</span> new_rows<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">int</span> result_rows <span class="token operator">=</span> test<span class="token punctuation">.</span>rows <span class="token operator">-</span> temp<span class="token punctuation">.</span>rows <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> result_cols <span class="token operator">=</span> test<span class="token punctuation">.</span>cols <span class="token operator">-</span> temp<span class="token punctuation">.</span>cols <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		Mat <span class="token function">result</span><span class="token punctuation">(</span>result_rows<span class="token punctuation">,</span> result_cols<span class="token punctuation">,</span> CV_32FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//模板匹配</span>
		<span class="token function">matchTemplate</span><span class="token punctuation">(</span>test<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> result<span class="token punctuation">,</span> match_method<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//归一化</span>
		<span class="token function">normalize</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> NORM_MINMAX<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//寻找模板匹配的最大最小匹配值</span>
		Point minLoc<span class="token punctuation">;</span>
		Point maxLoc<span class="token punctuation">;</span>
		Point match_loc<span class="token punctuation">;</span>
		<span class="token keyword">double</span> min_value<span class="token punctuation">,</span> max_value<span class="token punctuation">;</span>
		<span class="token function">minMaxLoc</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token operator">&amp;</span>min_value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>max_value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>minLoc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>maxLoc<span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>match_method <span class="token operator">==</span> CV_TM_SQDIFF <span class="token operator">||</span> match_method <span class="token operator">==</span> CV_TM_SQDIFF_NORMED<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			match_loc <span class="token operator">=</span> minLoc<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			match_loc <span class="token operator">=</span> maxLoc<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		Rect <span class="token function">rect</span><span class="token punctuation">(</span>match_loc<span class="token punctuation">.</span>x<span class="token punctuation">,</span> match_loc<span class="token punctuation">.</span>y<span class="token punctuation">,</span> temp<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> temp<span class="token punctuation">.</span>rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
		Mat result_img <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		Mat result_img_roi <span class="token operator">=</span> <span class="token function">result_img</span><span class="token punctuation">(</span>rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">double</span> his_temp <span class="token operator">=</span> <span class="token function">histogram</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> result_img_roi<span class="token punctuation">)</span><span class="token punctuation">;</span>
		Best_Rect best_rect <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> match_loc<span class="token punctuation">,</span>test <span class="token punctuation">}</span><span class="token punctuation">;</span>
		record<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token function">make_pair</span><span class="token punctuation">(</span>his_temp<span class="token punctuation">,</span> best_rect<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//将待检测图中与模板匹配出框起来</span>
	<span class="token keyword">auto</span> it <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">rbegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*for (it; it != record.end(); it++) {
		cout &lt;&lt; it-&gt;first &lt;&lt; endl;
	}*/</span>
	<span class="token function">rectangle</span><span class="token punctuation">(</span>it<span class="token operator">-&gt;</span>second<span class="token punctuation">.</span>best_mat<span class="token punctuation">,</span> <span class="token function">Rect</span><span class="token punctuation">(</span>it<span class="token operator">-&gt;</span>second<span class="token punctuation">.</span>best_point<span class="token punctuation">.</span>x<span class="token punctuation">,</span> it<span class="token operator">-&gt;</span>second<span class="token punctuation">.</span>best_point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> temp<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> temp<span class="token punctuation">.</span>rows<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> CV_AA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">,</span> WINDOW_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">,</span> it<span class="token operator">-&gt;</span>second<span class="token punctuation">.</span>best_mat<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre> 
<blockquote> 
 <p>histogram.h</p> 
</blockquote> 
<pre><code class="prism language-cpp"><span class="token comment">//直方图比较</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;math.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;opencv2/highgui/highgui_c.h&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">double</span> <span class="token function">histogram</span><span class="token punctuation">(</span>Mat <span class="token operator">&amp;</span>test1<span class="token punctuation">,</span>Mat <span class="token operator">&amp;</span>test2<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	Mat hsvtest1<span class="token punctuation">,</span> hsvtest2<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>test1<span class="token punctuation">.</span>data <span class="token operator">||</span> <span class="token operator">!</span>test2<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"could not load image...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//步骤一：从RGB空间转换到HSV空间</span>
	<span class="token function">cvtColor</span><span class="token punctuation">(</span>test1<span class="token punctuation">,</span> hsvtest1<span class="token punctuation">,</span> CV_BGR2HSV<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cvtColor</span><span class="token punctuation">(</span>test2<span class="token punctuation">,</span> hsvtest2<span class="token punctuation">,</span> CV_BGR2HSV<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//步骤二：计算直方图与归一化</span>
	<span class="token keyword">int</span> h_bins <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> s_bins <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> histsize<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> h_bins<span class="token punctuation">,</span>s_bins <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">//hue varies from 0 to 179,saturation from 0 to 255</span>
	<span class="token keyword">float</span> h_ranges<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">180</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> s_ranges<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">256</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> histRanges<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> h_ranges<span class="token punctuation">,</span>s_ranges <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">//use the 0-th and 1-st channels</span>
	<span class="token keyword">int</span> channels<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	MatND hist_test1<span class="token punctuation">;</span>
	MatND hist_test2<span class="token punctuation">;</span>
	<span class="token comment">//计算直方图</span>
	<span class="token function">calcHist</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hsvtest1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> channels<span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hist_test1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> histsize<span class="token punctuation">,</span> histRanges<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">calcHist</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hsvtest2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> channels<span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hist_test2<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> histsize<span class="token punctuation">,</span> histRanges<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//归一化</span>
	<span class="token function">normalize</span><span class="token punctuation">(</span>hist_test1<span class="token punctuation">,</span> hist_test1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> NORM_MINMAX<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">normalize</span><span class="token punctuation">(</span>hist_test2<span class="token punctuation">,</span> hist_test2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> NORM_MINMAX<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//步骤三：比较直方图，并返回值</span>
	<span class="token keyword">double</span> basetest2 <span class="token operator">=</span> <span class="token function">compareHist</span><span class="token punctuation">(</span>hist_test1<span class="token punctuation">,</span> hist_test2<span class="token punctuation">,</span> CV_COMP_CORREL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> basetest2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>大致思路：<br> 给定的模板，它已经是分辨率比较低的了，我们只能改变截图，根据，每次缩放截图，我们把结果用map存起来，map的key为直方图相似度，value为Point和Rect(该点坐标和对比的图)，通过，map自动排序。</p> 
<h5><a id="_209"></a>结果</h5> 
<p><img src="https://images2.imgbox.com/0c/4a/akDIxQeH_o.png" alt="result"></p> 
<h4><a id="SIFT_211"></a>方法二：SIFT</h4> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python</span>

<span class="token comment"># Python 2/3 compatibility</span>
<span class="token keyword">from</span> __future__ <span class="token keyword">import</span> print_function

<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2

<span class="token keyword">def</span> <span class="token function">init_feature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># SIFT匹配</span>
    detector <span class="token operator">=</span> cv2<span class="token punctuation">.</span>SIFT_create<span class="token punctuation">(</span><span class="token number">700</span><span class="token punctuation">)</span>
    <span class="token comment"># BRISK匹配</span>
    <span class="token comment">#cv2.BRISK_create()</span>
    <span class="token comment"># 归一化</span>
    norm <span class="token operator">=</span> cv2<span class="token punctuation">.</span>NORM_L2
    <span class="token comment">#cv2.NORM_L2</span>
    <span class="token comment"># 特征值全匹配</span>
    matcher <span class="token operator">=</span> cv2<span class="token punctuation">.</span>BFMatcher<span class="token punctuation">(</span>norm<span class="token punctuation">)</span>
    <span class="token keyword">return</span> detector<span class="token punctuation">,</span> matcher

<span class="token keyword">def</span> <span class="token function">filter_matches</span><span class="token punctuation">(</span>kp1<span class="token punctuation">,</span> kp2<span class="token punctuation">,</span> matches<span class="token punctuation">,</span> ratio <span class="token operator">=</span> <span class="token number">0.75</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    mkp1<span class="token punctuation">,</span> mkp2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> m <span class="token keyword">in</span> matches<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token keyword">and</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>distance <span class="token operator">*</span> ratio<span class="token punctuation">:</span>
            m <span class="token operator">=</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            mkp1<span class="token punctuation">.</span>append<span class="token punctuation">(</span> kp1<span class="token punctuation">[</span>m<span class="token punctuation">.</span>queryIdx<span class="token punctuation">]</span> <span class="token punctuation">)</span>
            mkp2<span class="token punctuation">.</span>append<span class="token punctuation">(</span> kp2<span class="token punctuation">[</span>m<span class="token punctuation">.</span>trainIdx<span class="token punctuation">]</span> <span class="token punctuation">)</span>
    p1 <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span>kp<span class="token punctuation">.</span>pt <span class="token keyword">for</span> kp <span class="token keyword">in</span> mkp1<span class="token punctuation">]</span><span class="token punctuation">)</span>
    p2 <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span>kp<span class="token punctuation">.</span>pt <span class="token keyword">for</span> kp <span class="token keyword">in</span> mkp2<span class="token punctuation">]</span><span class="token punctuation">)</span>
    kp_pairs <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>mkp1<span class="token punctuation">,</span> mkp2<span class="token punctuation">)</span>
    <span class="token keyword">return</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> kp_pairs

<span class="token keyword">def</span> <span class="token function">explore_match</span><span class="token punctuation">(</span>win<span class="token punctuation">,</span> img1<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> kp_pairs<span class="token punctuation">,</span> status <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> H <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    h1<span class="token punctuation">,</span> w1 <span class="token operator">=</span> img1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    h2<span class="token punctuation">,</span> w2 <span class="token operator">=</span> img2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    vis <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>h1<span class="token punctuation">,</span> h2<span class="token punctuation">)</span><span class="token punctuation">,</span> w1<span class="token operator">+</span>w2<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    vis<span class="token punctuation">[</span><span class="token punctuation">:</span>h1<span class="token punctuation">,</span> <span class="token punctuation">:</span>w1<span class="token punctuation">]</span> <span class="token operator">=</span> img1
    vis<span class="token punctuation">[</span><span class="token punctuation">:</span>h2<span class="token punctuation">,</span> w1<span class="token punctuation">:</span>w1<span class="token operator">+</span>w2<span class="token punctuation">]</span> <span class="token operator">=</span> img2
    vis <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>vis<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_GRAY2BGR<span class="token punctuation">)</span>

    <span class="token keyword">if</span> H <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        corners <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>w1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>w1<span class="token punctuation">,</span> h1<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> h1<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        corners <span class="token operator">=</span> np<span class="token punctuation">.</span>int32<span class="token punctuation">(</span> cv2<span class="token punctuation">.</span>perspectiveTransform<span class="token punctuation">(</span>corners<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> H<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>w1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>polylines<span class="token punctuation">(</span>vis<span class="token punctuation">,</span> <span class="token punctuation">[</span>corners<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>win<span class="token punctuation">,</span> vis<span class="token punctuation">)</span>
    <span class="token keyword">return</span> vis

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    img1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'button.png'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    img2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'test1.png'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    smaller_img1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img1<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> fx<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> fy<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_AREA<span class="token punctuation">)</span>
    smaller_img2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img2<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> fx<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> fy<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_AREA<span class="token punctuation">)</span>
    detector<span class="token punctuation">,</span> matcher <span class="token operator">=</span> init_feature<span class="token punctuation">(</span><span class="token punctuation">)</span>

    kp1<span class="token punctuation">,</span> desc1 <span class="token operator">=</span> detector<span class="token punctuation">.</span>detectAndCompute<span class="token punctuation">(</span>smaller_img1<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    kp2<span class="token punctuation">,</span> desc2 <span class="token operator">=</span> detector<span class="token punctuation">.</span>detectAndCompute<span class="token punctuation">(</span>smaller_img2<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>

    raw_matches <span class="token operator">=</span> matcher<span class="token punctuation">.</span>knnMatch<span class="token punctuation">(</span>desc1<span class="token punctuation">,</span> trainDescriptors <span class="token operator">=</span> desc2<span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> kp_pairs <span class="token operator">=</span> filter_matches<span class="token punctuation">(</span>kp1<span class="token punctuation">,</span> kp2<span class="token punctuation">,</span> raw_matches<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">4</span><span class="token punctuation">:</span>
        H<span class="token punctuation">,</span> status <span class="token operator">=</span> cv2<span class="token punctuation">.</span>findHomography<span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>RANSAC<span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%d / %d  inliers/matched'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        vis <span class="token operator">=</span> explore_match<span class="token punctuation">(</span><span class="token string">'find_obj'</span><span class="token punctuation">,</span> smaller_img1<span class="token punctuation">,</span> smaller_img2<span class="token punctuation">,</span> kp_pairs<span class="token punctuation">,</span> status<span class="token punctuation">,</span> H<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%d matches found, not enough for homography estimation'</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>通过,缩放和SIFT。其实际效果，有时候并不好。</p> 
<h5><a id="_285"></a>效果</h5> 
<p><img src="https://images2.imgbox.com/6d/55/iO0tuqHe_o.png" alt="1"><br> <img src="https://images2.imgbox.com/68/82/odm7E2uF_o.png" alt="2"></p> 
<h4><a id="_288"></a>方法三：灰度匹配+模板匹配</h4> 
<blockquote> 
 <p>GrayMatching.h</p> 
</blockquote> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;imgproc/types_c.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;map&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token keyword">int</span> match_method<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">Best_Mat</span>
<span class="token punctuation">{<!-- --></span>
    Rect best_rect<span class="token punctuation">;</span>
    Mat best_mat<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//相似度匹配算法之灰度值方差匹配法：</span>
<span class="token keyword">double</span> <span class="token function">get_variance</span><span class="token punctuation">(</span>Mat<span class="token operator">&amp;</span> a<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>rows <span class="token operator">!=</span> b<span class="token punctuation">.</span>rows <span class="token operator">||</span> a<span class="token punctuation">.</span>cols <span class="token operator">!=</span> b<span class="token punctuation">.</span>cols <span class="token operator">||</span> a<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> b<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"not the same size!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//处理图像相似度</span>
    <span class="token comment">//1.求出每一行到灰度值均值,加入容器，作为特征值；</span>
    <span class="token comment">//2.求出灰度值总平均值与每行平均值的方差；</span>
    <span class="token comment">//3.行行比较与模版方差的接近程度</span>


    vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span> variance_a<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span> variance_b<span class="token punctuation">;</span>
    <span class="token keyword">double</span> var_a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> var_b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> sum_a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> sum_b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> mean_a<span class="token punctuation">;</span>
    <span class="token keyword">double</span> mean_b<span class="token punctuation">;</span>
    <span class="token keyword">double</span> sum_variance <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token comment">//将每行灰度值均值存入容器</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> a<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mean_a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        mean_b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> a<span class="token punctuation">.</span>cols<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mean_a <span class="token operator">+=</span> a<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mean_b <span class="token operator">+=</span> b<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mean_a <span class="token operator">/=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>rows <span class="token operator">*</span> a<span class="token punctuation">.</span>cols<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mean_b <span class="token operator">/=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>rows <span class="token operator">*</span> a<span class="token punctuation">.</span>cols<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sum_a <span class="token operator">+=</span> mean_a<span class="token punctuation">;</span>
        sum_b <span class="token operator">+=</span> mean_b<span class="token punctuation">;</span>
        variance_a<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>mean_a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        variance_b<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>mean_b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//全图灰度值均值</span>
    mean_a <span class="token operator">=</span> sum_a <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>variance_a<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mean_b <span class="token operator">=</span> sum_b <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>variance_b<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//灰度值方差之差累加</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> variance_a<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        var_a <span class="token operator">=</span> <span class="token punctuation">(</span>variance_a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> mean_a<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>variance_a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> mean_a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        var_b <span class="token operator">=</span> <span class="token punctuation">(</span>variance_b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> mean_b<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>variance_b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> mean_b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sum_variance <span class="token operator">+=</span> <span class="token function">abs</span><span class="token punctuation">(</span>var_a <span class="token operator">-</span> var_b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> sum_variance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">graymatching</span><span class="token punctuation">(</span>string<span class="token operator">&amp;</span> s1<span class="token punctuation">,</span>string<span class="token operator">&amp;</span> s2<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//加载图像</span>
    Mat org <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mat my_template <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> my_template<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"could not load image...\n"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">cvtColor</span><span class="token punctuation">(</span>org<span class="token punctuation">,</span> org<span class="token punctuation">,</span> CV_RGB2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cvtColor</span><span class="token punctuation">(</span>my_template<span class="token punctuation">,</span> my_template<span class="token punctuation">,</span> CV_RGB2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    map<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> Best_Mat<span class="token operator">&gt;</span> arr<span class="token punctuation">;</span>
    <span class="token comment">//循环缩放，当前模版为最大尺寸，每次循环缩小5%，循环10次</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获得缩放后的模版</span>
        Mat temp_template <span class="token operator">=</span> org<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> new_rows <span class="token operator">=</span> org<span class="token punctuation">.</span>rows <span class="token operator">-</span> index <span class="token operator">*</span> <span class="token number">0.05</span> <span class="token operator">*</span> org<span class="token punctuation">.</span>rows<span class="token punctuation">;</span>
        <span class="token keyword">int</span> new_cols <span class="token operator">=</span> org<span class="token punctuation">.</span>cols <span class="token operator">-</span> index <span class="token operator">*</span> <span class="token number">0.05</span> <span class="token operator">*</span> org<span class="token punctuation">.</span>cols<span class="token punctuation">;</span>
        <span class="token function">resize</span><span class="token punctuation">(</span>temp_template<span class="token punctuation">,</span> temp_template<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span>new_cols<span class="token punctuation">,</span> new_rows<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//模版匹配</span>
        Mat result<span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>temp_template<span class="token punctuation">.</span>dims<span class="token punctuation">,</span> temp_template<span class="token punctuation">.</span>size<span class="token punctuation">,</span> temp_template<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">matchTemplate</span><span class="token punctuation">(</span>temp_template<span class="token punctuation">,</span> my_template<span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取模版匹配得到的rect</span>
        Point minPoint<span class="token punctuation">;</span>
        Point maxPoint<span class="token punctuation">;</span>
        <span class="token keyword">double</span> minVal<span class="token punctuation">;</span>
        <span class="token keyword">double</span> maxVal<span class="token punctuation">;</span>
        <span class="token function">minMaxLoc</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token operator">&amp;</span>minVal<span class="token punctuation">,</span> <span class="token operator">&amp;</span>maxVal<span class="token punctuation">,</span> <span class="token operator">&amp;</span>minPoint<span class="token punctuation">,</span> <span class="token operator">&amp;</span>maxPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Rect <span class="token function">rect</span><span class="token punctuation">(</span>minPoint<span class="token punctuation">.</span>x<span class="token punctuation">,</span> minPoint<span class="token punctuation">.</span>y<span class="token punctuation">,</span> my_template<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> my_template<span class="token punctuation">.</span>rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
       
        <span class="token comment">//获取匹配部分的roi图像</span>
        Mat result_img <span class="token operator">=</span> temp_template<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Mat result_img_roi <span class="token operator">=</span> <span class="token function">result_img</span><span class="token punctuation">(</span>rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//相似度比较部分：</span>
        <span class="token comment">//比较相似度的算法很多，各有所长，这里用的是一个灰度值方差的相似度比较</span>
        <span class="token comment">//variance_diff表示灰度值方差，方差越小，相似度越高；</span>
        <span class="token keyword">double</span> variance_diff <span class="token operator">=</span> <span class="token function">get_variance</span><span class="token punctuation">(</span>result_img_roi<span class="token punctuation">,</span> my_template<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Best_Mat best_mat <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> rect <span class="token punctuation">,</span>temp_template <span class="token punctuation">}</span><span class="token punctuation">;</span>
        arr<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token function">make_pair</span><span class="token punctuation">(</span>variance_diff<span class="token punctuation">,</span> best_mat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">auto</span> it <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rectangle</span><span class="token punctuation">(</span>it<span class="token operator">-&gt;</span>second<span class="token punctuation">.</span>best_mat<span class="token punctuation">,</span> it<span class="token operator">-&gt;</span>second<span class="token punctuation">.</span>best_rect<span class="token punctuation">,</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">,</span> WINDOW_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">,</span> it<span class="token operator">-&gt;</span>second<span class="token punctuation">.</span>best_mat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="_411"></a>结果和结论</h5> 
<p><img src="https://images2.imgbox.com/9a/c6/axnSVy0T_o.png" alt="gary"><br> <img src="https://images2.imgbox.com/10/7f/qfeUOtq7_o.png" alt="button"></p> 
<p><img src="https://images2.imgbox.com/00/38/cGhD3yCQ_o.png" alt="on"><br> <img src="https://images2.imgbox.com/3a/62/qxzc5DdK_o.png" alt="off"></p> 
<p><img src="https://images2.imgbox.com/29/c1/J6LB0BYF_o.png" alt="test1"></p> 
<p><img src="https://images2.imgbox.com/0c/99/iJUsOUCY_o.png" alt="2"><br> <img src="https://images2.imgbox.com/b1/b0/x0frm9Sl_o.png" alt="1"><br> 直方图8.186s，灰度匹配2.212s，此方法速度快。而且，匹配精度高。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d7fd6458c83185debdf4c543d066a198/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【数据结构与算法】删除线性表中的零元素</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5da175e04a3b83f12b6d426d14dc67da/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Restful接口</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>