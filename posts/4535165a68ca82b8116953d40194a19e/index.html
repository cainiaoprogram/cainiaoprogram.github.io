<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Qt调用onnxruntime推理maskrcnn模型 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Qt调用onnxruntime推理maskrcnn模型" />
<meta property="og:description" content="此内容为原创，转载请注明出处。
环境：
Ubuntu 18.04
python 3.8.5
opencv 4.4
onnx 1.9.0
c&#43;&#43; onnxruntime 1.8.0
opencv的安装我就不讲了，网上的教程多得是，这里讲一下onnxruntime的环境布置。
onnxruntime 下载地址： https://github.com/microsoft/onnxruntime
一般来说，页面右侧都有一个已经准备好的release版本，直接拉过来用就行。也是同事提醒我的，不然我还看不到，我眼睛一向不太好使。
下载好后解压放到/usr/local/目录下面，当然也可以放在其他位置，但我习惯放这里了。我当时下载的是1.8.0的版本，当我写这篇博客的时候官方已经升级到1.8.1的版本。
下面我们进入正题：
第一步 训练maskrcnn获得pth模型。 这一步就不着重讲了，pytorch官方有案例，照搬过来用就行，连样本图片都给准备好了。
案例地址：https://pytorch.org/tutorials/intermediate/torchvision_tutorial.html
如果还搞不定的话，这里还有篇更详细的官方教程讲解：https://blog.csdn.net/u013685264/article/details/100564660
第二步 在python中将maskrcnn转换成onnx的模型。 这里需要注意一下，模型训练时如果图片的尺寸全都一致，就可以使用固定尺寸的模型转换。
但如果像prtorch官方案例那种，图片尺寸没有固定的话，就需要使用动态的模型转换了。
动态尺寸的模型转换：
import torchvision import onnxruntime as ort import numpy as np import onnx model = torchvision.models.detection.maskrcnn_resnet50_fpn(pretrained=False, num_classes=2) model.load_state_dict(torch.load(&#39;./output/model.pth&#39;)[&#39;model&#39;])	# 训练保存的pth模型 model.eval() data = torch.randn(1, 3, 1024, 1278) # (图片数量, 通道数, 高, 宽) 这个宽高值可以随意 input_names = [&#34;image&#34;] output_names = [&#39;boxes&#39;, &#39;labels&#39;, &#39;scores&#39;, &#39;masks&#39;] # dynamic_axes 代表哪个轴可以变动。例如输入的images中，图片数量、高、宽可以变动，即为0, 2, 3 torch." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4535165a68ca82b8116953d40194a19e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-11T11:05:52+08:00" />
<meta property="article:modified_time" content="2023-09-11T11:05:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Qt调用onnxruntime推理maskrcnn模型</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><em>此内容为原创，转载请注明出处。</em></p> 
<p><strong>环境：</strong><br> Ubuntu 18.04<br> python 3.8.5<br> opencv 4.4<br> onnx 1.9.0<br> c++ onnxruntime 1.8.0</p> 
<p>opencv的安装我就不讲了，网上的教程多得是，这里讲一下onnxruntime的环境布置。<br> <strong>onnxruntime 下载地址：</strong> <a href="https://github.com/microsoft/onnxruntime">https://github.com/microsoft/onnxruntime</a><br> 一般来说，页面右侧都有一个已经准备好的release版本，直接拉过来用就行。也是同事提醒我的，不然我还看不到，我眼睛一向不太好使。<br> <img src="https://images2.imgbox.com/f5/cf/8E8CxhXE_o.png" alt="release版本"></p> 
<p>下载好后解压放到/usr/local/目录下面，当然也可以放在其他位置，但我习惯放这里了。我当时下载的是1.8.0的版本，当我写这篇博客的时候官方已经升级到1.8.1的版本。<br> <img src="https://images2.imgbox.com/c7/f1/NaSR3jic_o.png" alt="onnxruntime位置"><br> 下面我们进入正题：</p> 
<h3><a id="_maskrcnnpth_20"></a>第一步 训练maskrcnn获得pth模型。</h3> 
<p>这一步就不着重讲了，pytorch官方有案例，照搬过来用就行，连样本图片都给准备好了。<br> 案例地址：<a href="https://pytorch.org/tutorials/intermediate/torchvision_tutorial.html" rel="nofollow">https://pytorch.org/tutorials/intermediate/torchvision_tutorial.html</a></p> 
<p>如果还搞不定的话，这里还有篇更详细的官方教程讲解：<a href="https://blog.csdn.net/u013685264/article/details/100564660">https://blog.csdn.net/u013685264/article/details/100564660</a></p> 
<h3><a id="_pythonmaskrcnnonnx_25"></a>第二步 在python中将maskrcnn转换成onnx的模型。</h3> 
<p>这里需要注意一下，模型训练时如果图片的尺寸全都一致，就可以使用固定尺寸的模型转换。<br> 但如果像prtorch官方案例那种，图片尺寸没有固定的话，就需要使用动态的模型转换了。<br> <strong>动态尺寸的模型转换：</strong></p> 
<pre><code class="prism language-bash">	<span class="token function">import</span> torchvision
	<span class="token function">import</span> onnxruntime as ort
	<span class="token function">import</span> numpy as np
	<span class="token function">import</span> onnx


    model <span class="token operator">=</span> torchvision.models.detection.maskrcnn_resnet50_fpn<span class="token punctuation">(</span>pretrained<span class="token operator">=</span>False, <span class="token assign-left variable">num_classes</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    model.load_state_dict<span class="token punctuation">(</span>torch.load<span class="token punctuation">(</span><span class="token string">'./output/model.pth'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>	<span class="token comment"># 训练保存的pth模型</span>
    model.eval<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> torch.randn<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">3</span>, <span class="token number">1024</span>, <span class="token number">1278</span><span class="token punctuation">)</span>  <span class="token comment"># (图片数量, 通道数, 高, 宽) 这个宽高值可以随意</span>
    input_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span>
    output_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'boxes'</span>, <span class="token string">'labels'</span>, <span class="token string">'scores'</span>, <span class="token string">'masks'</span><span class="token punctuation">]</span>

    <span class="token comment"># dynamic_axes 代表哪个轴可以变动。例如输入的images中，图片数量、高、宽可以变动，即为0, 2, 3</span>
    torch.onnx.export<span class="token punctuation">(</span>model, data, <span class="token string">"./output/model.onnx"</span>,
                  <span class="token assign-left variable">export_params</span><span class="token operator">=</span>True,
                  <span class="token assign-left variable">opset_version</span><span class="token operator">=</span><span class="token number">11</span>,
                  <span class="token assign-left variable">input_names</span><span class="token operator">=</span>input_names,
                  <span class="token assign-left variable">output_names</span><span class="token operator">=</span>output_names,
                  <span class="token assign-left variable">dynamic_axes</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
                      <span class="token string">'image'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">0</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span>,
                      <span class="token string">"boxes"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>,
                      <span class="token string">"labels"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>,
                      <span class="token string">"scores"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>,
                      <span class="token string">"masks"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">0</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                          
</code></pre> 
<p><strong>固定尺寸的模型转换：</strong></p> 
<pre><code class="prism language-bash">	<span class="token function">import</span> torchvision
	<span class="token function">import</span> onnxruntime as ort
	<span class="token function">import</span> numpy as np
	<span class="token function">import</span> onnx


    model <span class="token operator">=</span> torchvision.models.detection.maskrcnn_resnet50_fpn<span class="token punctuation">(</span>pretrained<span class="token operator">=</span>False, <span class="token assign-left variable">num_classes</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    model.load_state_dict<span class="token punctuation">(</span>torch.load<span class="token punctuation">(</span><span class="token string">'./output/model.pth'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    model.eval<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> torch.rand<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">3</span>, <span class="token number">1024</span>, <span class="token number">1278</span><span class="token punctuation">)</span>  <span class="token comment"># (图片数量, 通道数, 高, 宽)</span>
    input_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span>
    output_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'boxes'</span>, <span class="token string">'labels'</span>, <span class="token string">'scores'</span>, <span class="token string">'masks'</span><span class="token punctuation">]</span>

    torch.onnx._export<span class="token punctuation">(</span>model, data, <span class="token string">'./output/model.onnx'</span>, <span class="token assign-left variable">export_params</span><span class="token operator">=</span>True, <span class="token assign-left variable">opset_version</span><span class="token operator">=</span><span class="token number">11</span>, <span class="token assign-left variable">input_names</span><span class="token operator">=</span>input_names, <span class="token assign-left variable">output_names</span><span class="token operator">=</span>output_names<span class="token punctuation">)</span>
</code></pre> 
<p>这里我们采用的是第一种“动态尺寸的模型转换”，在output文件夹下得到了一个model.onnx的模型。<br> 也不知道什么原因，我在转换模型的时候报了一溜的红，但最终还是得到了我想要的onnx模型，我也就没管它了，毕竟还是能用的嘛。</p> 
<h3><a id="_pythononnx_82"></a>第三步 在python中测试onnx模型</h3> 
<p>得到onnx模型后，我们先在python中调用测试一下，保证模型能成功调用并获取正确的结果。</p> 
<pre><code class="prism language-bash">	<span class="token function">import</span> torch
	<span class="token function">import</span> cv2
	<span class="token function">import</span> torchvision
	<span class="token function">import</span> onnxruntime as ort
	<span class="token function">import</span> numpy as np
	<span class="token function">import</span> onnx


    img <span class="token operator">=</span> cv2.imread<span class="token punctuation">(</span><span class="token string">'./PennFudanPed/PNGImages/FudanPed00001.png'</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> cv2.cvtColor<span class="token punctuation">(</span>img, cv2.COLOR_BGR2RGB<span class="token punctuation">)</span>
    img <span class="token operator">=</span> torch.from_numpy<span class="token punctuation">(</span>img.transpose<span class="token variable"><span class="token punctuation">((</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">))</span></span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> img.float<span class="token punctuation">(</span><span class="token punctuation">)</span>.div<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>			<span class="token comment"># 据说这里也可以用255</span>
    img <span class="token operator">=</span> np.expand_dims<span class="token punctuation">(</span>img, <span class="token assign-left variable">axis</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment"># 3维转4维。(3, 1024, 1278) &gt;&gt;&gt; (1, 3, 1024, 1278)</span>

    model <span class="token operator">=</span> onnx.load<span class="token punctuation">(</span><span class="token string">'./output/model.onnx'</span><span class="token punctuation">)</span>
    onnx.checker.check_model<span class="token punctuation">(</span>model<span class="token punctuation">)</span>     <span class="token comment"># 检查模型格式是否完整及正确</span>
    output <span class="token operator">=</span> model.graph.output         <span class="token comment"># 获取输出层，包含层名称、维度信息</span>
    print<span class="token punctuation">(</span>output<span class="token punctuation">)</span>

    ort_session <span class="token operator">=</span> ort.InferenceSession<span class="token punctuation">(</span><span class="token string">'./output/model.onnx'</span><span class="token punctuation">)</span>
    outputs <span class="token operator">=</span> ort_session.run<span class="token punctuation">(</span>None, <span class="token punctuation">{<!-- --></span><span class="token string">'image'</span><span class="token builtin class-name">:</span> img<span class="token punctuation">}</span><span class="token punctuation">)</span>
    print<span class="token punctuation">(</span>outputs<span class="token punctuation">)</span>
</code></pre> 
<p>我的代码中加载两次onnx，第一次load加载是为了检查onnx模型的输出层，并检查模型是否完整。第二次InferenceSession加载才是为了预测图片。如果不需要检查模型正确性的话，直接预测也是可以的。<br> 这一步我也是一路报红，但最后还是能得到正确的结果，所以最后我也就懒得去刨根问底了。</p> 
<h3><a id="_Qtonnx_113"></a>第四步 Qt中调用onnx</h3> 
<p>这一部分要着重讲一讲，代码量会比python要多很多，当然前提是得先把onnx的c++库和头文件部署好。这一步没做好的，可以看我文章开头。<br> 底下附有完整代码。</p> 
<h3><a id="_116"></a></h3> 
<h3><a id="1__118"></a>1. 添加库和头文件路径</h3> 
<p>Qt新建一个项目，打开pro文件，添加onnx的头文件和库路径，不然编译会报错找不到库。</p> 
<pre><code class="prism language-bash">INCLUDEPATH <span class="token operator">+=</span> /usr/local/onnxruntime-linux-x64-gpu-1.8.0/include/
LIBS <span class="token operator">+=</span> -L/usr/local/onnxruntime-linux-x64-gpu-1.8.0/lib/
LIBS <span class="token operator">+=</span> <span class="token parameter variable">-lonnxruntime</span> <span class="token parameter variable">-lonnxruntime_providers_cuda</span> <span class="token parameter variable">-lonnxruntime_providers_shared</span>
</code></pre> 
<p>顺便我们把opencv的路径也添加进来，等会儿代码中要用。</p> 
<pre><code class="prism language-bash">INCLUDEPATH <span class="token operator">+=</span> /usr/local/opencv4-4/include/opencv4/
LIBS <span class="token operator">+=</span> -L/usr/local/opencv4-4/lib/
LIBS <span class="token operator">+=</span> <span class="token parameter variable">-lopencv_core</span> <span class="token parameter variable">-lopencv_imgcodecs</span> <span class="token parameter variable">-lopencv_objdetect</span> <span class="token parameter variable">-lopencv_dnn</span> <span class="token parameter variable">-lopencv_imgproc</span>
</code></pre> 
<p>最后也就是这样子的：<br> <img src="https://images2.imgbox.com/b5/d6/f9ZGUuY6_o.png" alt="库路径"></p> 
<h3><a id="2_onnx_136"></a>2. 载入onnx模型</h3> 
<p>添加文件Demo.h和Demo.cpp，创建一个Demo的Class，把onnx需要的头文件include进去。</p> 
<p>Demo.h中：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QObject&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QDebug&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QPointF&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/dnn.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;onnxruntime/onnxruntime_cxx_api.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;onnxruntime/onnxruntime_run_options_config_keys.h&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">QObject</span></span>
<span class="token punctuation">{<!-- --></span>
    Q_OBJECT
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">explicit</span> <span class="token function">Demo</span><span class="token punctuation">(</span>QObject <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">demoModel</span><span class="token punctuation">(</span>QString imagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Demo.cpp中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">Demo</span><span class="token double-colon punctuation">::</span><span class="token function">demoModel</span><span class="token punctuation">(</span>QString imagePath<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Ort<span class="token double-colon punctuation">::</span>Env <span class="token function">env</span><span class="token punctuation">(</span>ORT_LOGGING_LEVEL_WARNING<span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/** 初始化环境，每个进程一个环境.环境保留了线程池和其他状态信息 **/</span>

    <span class="token comment">/**
    * 初始化Session选项
    * Available levels are
    * ORT_DISABLE_ALL -&gt; 禁用所有优化
    * ORT_ENABLE_BASIC -&gt; 要启用基本优化(如冗余节点删除)
    * ORT_ENABLE_EXTENDED -&gt; 启用扩展优化(包括1级以上更复杂的优化，如节点融合)
    * ORT_ENABLE_ALL -&gt; 启用所有可能的优化
    **/</span>
    Ort<span class="token double-colon punctuation">::</span>SessionOptions session_options<span class="token punctuation">;</span>
    session_options<span class="token punctuation">.</span><span class="token function">SetIntraOpNumThreads</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    session_options<span class="token punctuation">.</span><span class="token function">SetGraphOptimizationLevel</span><span class="token punctuation">(</span>GraphOptimizationLevel<span class="token double-colon punctuation">::</span>ORT_ENABLE_EXTENDED<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/** 设置图像优化级别 **/</span>

    <span class="token comment">//*************************************************************************</span>
    <span class="token comment">// 创建Session并把模型载入内存</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_WIN32</span></span>
    <span class="token keyword">const</span> <span class="token keyword">wchar_t</span><span class="token operator">*</span> model_path <span class="token operator">=</span> L<span class="token string">"model.onnx"</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> model_path <span class="token operator">=</span> <span class="token string">"model.onnx"</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Using Onnxruntime C++ API\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ort<span class="token double-colon punctuation">::</span>Session <span class="token function">session</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> model_path<span class="token punctuation">,</span> session_options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="3_onnx_189"></a>3. 打印一下onnx的输入层信息</h3> 
<p>这一步只是用来打印一下信息的，也是为了熟悉API，如果觉得不需要的话可以跳过也不会报错。<br> 先添加一下函数名。<br> Demo.h中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">printInputModel</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>Session <span class="token operator">*</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>Demo.cpp中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">Demo</span><span class="token double-colon punctuation">::</span><span class="token function">printInputModel</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>Session <span class="token operator">*</span>session<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Ort<span class="token double-colon punctuation">::</span>AllocatorWithDefaultOptions allocator<span class="token punctuation">;</span>

    <span class="token comment">//打印模型输入节点的数量</span>
    size_t num_input_nodes <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">GetInputCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token function">input_node_names</span><span class="token punctuation">(</span>num_input_nodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span> input_node_dims<span class="token punctuation">;</span>   <span class="token comment">/** 简化……该模型只有1个输入节点{1, 3, 1024, 1278}, 否则需要 vector&lt;vector&lt;&gt;&gt; **/</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"输入节点数量 = "</span> <span class="token operator">&lt;&lt;</span>  num_input_nodes<span class="token punctuation">;</span>

    <span class="token comment">// 遍历所有输入节点</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_input_nodes<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 打印输入节点名称</span>
        <span class="token keyword">char</span><span class="token operator">*</span> input_name <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">GetInputName</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输入节点第 %d 个: name=%s"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> input_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        input_node_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> input_name<span class="token punctuation">;</span>

        <span class="token comment">// 打印输入节点类型</span>
        Ort<span class="token double-colon punctuation">::</span>TypeInfo type_info <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">GetInputTypeInfo</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> tensor_info <span class="token operator">=</span> type_info<span class="token punctuation">.</span><span class="token function">GetTensorTypeAndShapeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ONNXTensorElementDataType type <span class="token operator">=</span> tensor_info<span class="token punctuation">.</span><span class="token function">GetElementType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输入节点第 %d 个: type=%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 打印输入 shapes/dims</span>
        input_node_dims <span class="token operator">=</span> tensor_info<span class="token punctuation">.</span><span class="token function">GetShape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输入节点第 %d 个: num_dims=%zu"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> input_node_dims<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> input_node_dims<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输入节点第 %d 个: dim %d=%jd"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> input_node_dims<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> input_node_dims<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="4__235"></a>4. 打印一下输出层信息</h3> 
<p>这一步是打印模型预测输出时，会有那些节点信息，例如maskrcnn中的labels、scores、masks等。<br> 当拿到一个陌生的模型时可以先输出看一下，当然如果你非常熟悉这个模型的话，这一步也可以跳过。</p> 
<p>Demo.h中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">printOutputModel</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>Session <span class="token operator">*</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>Demo.cpp中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">Demo</span><span class="token double-colon punctuation">::</span><span class="token function">printOutputModel</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>Session <span class="token operator">*</span>session<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Ort<span class="token double-colon punctuation">::</span>AllocatorWithDefaultOptions allocator<span class="token punctuation">;</span>
    <span class="token comment">//打印模型输出节点的数量</span>
    size_t num_output_nodes <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">GetOutputCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token function">output_node_names</span><span class="token punctuation">(</span>num_output_nodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span> output_node_dims<span class="token punctuation">;</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"输出节点数量 = "</span> <span class="token operator">&lt;&lt;</span>  num_output_nodes<span class="token punctuation">;</span>

    <span class="token comment">// 遍历所有输出节点</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_output_nodes<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 打印输出节点名称</span>
        <span class="token keyword">char</span><span class="token operator">*</span> output_name <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">GetOutputName</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输出节点第 %d 个: name=%s"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> output_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        output_node_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> output_name<span class="token punctuation">;</span>

        <span class="token comment">// 打印输出节点类型</span>
        Ort<span class="token double-colon punctuation">::</span>TypeInfo type_info <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">GetOutputTypeInfo</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> tensor_info <span class="token operator">=</span> type_info<span class="token punctuation">.</span><span class="token function">GetTensorTypeAndShapeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ONNXTensorElementDataType type <span class="token operator">=</span> tensor_info<span class="token punctuation">.</span><span class="token function">GetElementType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输出节点第 %d 个: type=%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 打印输出 shapes/dims</span>
        output_node_dims <span class="token operator">=</span> tensor_info<span class="token punctuation">.</span><span class="token function">GetShape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输出节点第 %d 个: num_dims=%zu"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> output_node_dims<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> output_node_dims<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输出节点第 %d 个: dim %d=%jd"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> output_node_dims<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="5__280"></a>5. 预测图片</h3> 
<p>onnx模型需要输入一组Tensor的数据，onnx创建tensor数据时，需要给定一组值为0~1的float数组。<br> 那么首先我们需要先写一个函数，能将cv::Mat转换为float数据。遍历图片的三个通道，依次将颜色值除以255填入vector&lt; float &gt;中。</p> 
<p>Demo.h中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">private</span>：
	<span class="token keyword">void</span> <span class="token function">normalized</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Mat mat<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>Demo.cpp中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">Demo</span><span class="token double-colon punctuation">::</span><span class="token function">normalized</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Mat input_tensor<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>output_data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>size_t counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> input_tensor<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> input_tensor<span class="token punctuation">.</span>cols<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                output_data<span class="token punctuation">[</span>counter<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>input_tensor<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Vec3b<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接下来我们开始预测图片：</p> 
<p>Demo.h中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">private</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token function">predictImage</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>Session <span class="token operator">*</span>session<span class="token punctuation">,</span> QString imagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>Demo.cpp中：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">Demo</span><span class="token double-colon punctuation">::</span><span class="token function">predictImage</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>Session <span class="token operator">*</span>session<span class="token punctuation">,</span> QString imgPath<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 预处理图片</span>
    cv<span class="token double-colon punctuation">::</span>Mat mat <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span>imgPath<span class="token punctuation">.</span><span class="token function">toStdString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/** 读取需要预测的图片 **/</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>mat<span class="token punctuation">,</span> mat<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>COLOR_BGR2RGB<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">/** 将图片的通道转变一下 **/</span>
    size_t input_tensor_size <span class="token operator">=</span> mat<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>width <span class="token operator">*</span> mat<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>height <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> <span class="token function">input_data</span><span class="token punctuation">(</span>input_tensor_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">normalized</span><span class="token punctuation">(</span>mat<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">/** 归一化图片数据 **/</span>

    <span class="token comment">// 从数据值创建输入张量对象</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span> input_node_dims <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> mat<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>height<span class="token punctuation">,</span> mat<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>width<span class="token punctuation">}</span><span class="token punctuation">;</span>
    Ort<span class="token double-colon punctuation">::</span>MemoryInfo memory_info <span class="token operator">=</span> Ort<span class="token double-colon punctuation">::</span><span class="token class-name">MemoryInfo</span><span class="token double-colon punctuation">::</span><span class="token function">CreateCpu</span><span class="token punctuation">(</span>OrtArenaAllocator<span class="token punctuation">,</span> OrtMemTypeDefault<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ort<span class="token double-colon punctuation">::</span>Value input_tensor <span class="token operator">=</span> Ort<span class="token double-colon punctuation">::</span>Value<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">CreateTensor</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>memory_info<span class="token punctuation">,</span> input_data<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input_tensor_size<span class="token punctuation">,</span> input_node_dims<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input_node_dims<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>input_tensor<span class="token punctuation">.</span><span class="token function">IsTensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Ort<span class="token double-colon punctuation">::</span>Value<span class="token operator">&gt;</span> ort_inputs<span class="token punctuation">;</span>
    ort_inputs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设计输入和输出的名字</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span> input_node_names <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"image"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span> output_node_names <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"boxes"</span><span class="token punctuation">,</span> <span class="token string">"labels"</span><span class="token punctuation">,</span> <span class="token string">"scores"</span><span class="token punctuation">,</span> <span class="token string">"masks"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 输入图片数据，运行模型获取预测结果，</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Ort<span class="token double-colon punctuation">::</span>Value<span class="token operator">&gt;</span> output_tensors <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">Run</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>RunOptions<span class="token punctuation">{<!-- --></span><span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">,</span> input_node_names<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ort_inputs<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> output_node_names<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>output_tensors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> output_tensors<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsTensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取一下预测结果</span>
    Ort<span class="token double-colon punctuation">::</span>AllocatorWithDefaultOptions allocator<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> output_tensors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span><span class="token operator">*</span> output_name <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">GetOutputName</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"/****************"</span><span class="token operator">&lt;&lt;</span>output_name<span class="token operator">&lt;&lt;</span><span class="token string">"*******************/"</span><span class="token punctuation">;</span>
        Ort<span class="token double-colon punctuation">::</span>Value <span class="token operator">*</span>output <span class="token operator">=</span> <span class="token operator">&amp;</span>output_tensors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> <span class="token operator">*</span>value <span class="token operator">=</span> output<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">GetTensorMutableData</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span> shape <span class="token operator">=</span> output<span class="token operator">-&gt;</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTensorTypeAndShapeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetShape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>output_name<span class="token punctuation">,</span> <span class="token string">"boxes"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>QPointF<span class="token operator">&gt;&gt;</span> boxes<span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>value<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token string">","</span><span class="token operator">&lt;&lt;</span>value<span class="token punctuation">[</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token string">" | "</span><span class="token operator">&lt;&lt;</span>value<span class="token punctuation">[</span>index<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token string">","</span><span class="token operator">&lt;&lt;</span>value<span class="token punctuation">[</span>index<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>QPointF<span class="token operator">&gt;</span> points<span class="token punctuation">;</span>
                points<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">QPointF</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span>value<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                points<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">QPointF</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                boxes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>output_name<span class="token punctuation">,</span> <span class="token string">"labels"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> labels<span class="token punctuation">;</span>
            <span class="token keyword">int64_t</span> <span class="token operator">*</span>labelV <span class="token operator">=</span> output<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">GetTensorMutableData</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> labelV<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span>
                labels<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>labelV<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>output_name<span class="token punctuation">,</span> <span class="token string">"scores"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> scores<span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> value<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span>
                scores<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>output_name<span class="token punctuation">,</span> <span class="token string">"masks"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&gt;</span> masks<span class="token punctuation">;</span>
            index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                cv<span class="token double-colon punctuation">::</span>Mat <span class="token function">mask</span><span class="token punctuation">(</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> CV_32FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span>mask<span class="token punctuation">.</span>data<span class="token punctuation">,</span> value <span class="token operator">+</span> x <span class="token operator">*</span> shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                QString name <span class="token operator">=</span> <span class="token function">QString</span><span class="token punctuation">(</span><span class="token string">"./masks_%1.bmp"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cv<span class="token double-colon punctuation">::</span><span class="token function">imwrite</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">toStdString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mask<span class="token operator">*</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                masks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="6__398"></a>6. 完整代码</h3> 
<p>Demo.h</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">DEMO_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEMO_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QObject&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QDebug&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QPointF&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/dnn.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;onnxruntime/onnxruntime_cxx_api.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;onnxruntime/onnxruntime_run_options_config_keys.h&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">QObject</span></span>
<span class="token punctuation">{<!-- --></span>
    Q_OBJECT
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">explicit</span> <span class="token function">Demo</span><span class="token punctuation">(</span>QObject <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">demoModel</span><span class="token punctuation">(</span>QString imagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">printInputModel</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>Session <span class="token operator">*</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">printOutputModel</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>Session <span class="token operator">*</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">predictImage</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>Session <span class="token operator">*</span>session<span class="token punctuation">,</span> QString imgPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">normalized</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Mat mat<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>

signals<span class="token operator">:</span>

<span class="token keyword">public</span> slots<span class="token operator">:</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// DEMO_H</span></span>
</code></pre> 
<p>Demo.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Demo.h"</span></span>

<span class="token class-name">Demo</span><span class="token double-colon punctuation">::</span><span class="token function">Demo</span><span class="token punctuation">(</span>QObject <span class="token operator">*</span>parent<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">QObject</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Demo</span><span class="token double-colon punctuation">::</span><span class="token function">demoModel</span><span class="token punctuation">(</span>QString imagePath<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Ort<span class="token double-colon punctuation">::</span>Env <span class="token function">env</span><span class="token punctuation">(</span>ORT_LOGGING_LEVEL_WARNING<span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/** 初始化环境，每个进程一个环境.环境保留了线程池和其他状态信息 **/</span>

    <span class="token comment">/**
    * 初始化Session选项
    * Available levels are
    * ORT_DISABLE_ALL -&gt; 禁用所有优化
    * ORT_ENABLE_BASIC -&gt; 要启用基本优化(如冗余节点删除)
    * ORT_ENABLE_EXTENDED -&gt; 启用扩展优化(包括1级以上更复杂的优化，如节点融合)
    * ORT_ENABLE_ALL -&gt; 启用所有可能的优化
    **/</span>
    Ort<span class="token double-colon punctuation">::</span>SessionOptions session_options<span class="token punctuation">;</span>
    session_options<span class="token punctuation">.</span><span class="token function">SetIntraOpNumThreads</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    session_options<span class="token punctuation">.</span><span class="token function">SetGraphOptimizationLevel</span><span class="token punctuation">(</span>GraphOptimizationLevel<span class="token double-colon punctuation">::</span>ORT_ENABLE_EXTENDED<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/** 设置图像优化级别 **/</span>

    <span class="token comment">//*************************************************************************</span>
    <span class="token comment">// 创建Session并把模型载入内存</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_WIN32</span></span>
    <span class="token keyword">const</span> <span class="token keyword">wchar_t</span><span class="token operator">*</span> model_path <span class="token operator">=</span> L<span class="token string">"model.onnx"</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> model_path <span class="token operator">=</span> <span class="token string">"model2.onnx"</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Using Onnxruntime C++ API\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ort<span class="token double-colon punctuation">::</span>Session <span class="token function">session</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> model_path<span class="token punctuation">,</span> session_options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//*************************************************************************</span>

    <span class="token function">printInputModel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//打印一下模型输入层</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"/*****************************************/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printOutputModel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//打印一下模型输出层</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"/*****************************************/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">predictImage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>session<span class="token punctuation">,</span> imagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Demo</span><span class="token double-colon punctuation">::</span><span class="token function">printInputModel</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>Session <span class="token operator">*</span>session<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Ort<span class="token double-colon punctuation">::</span>AllocatorWithDefaultOptions allocator<span class="token punctuation">;</span>

    <span class="token comment">//打印模型输入节点的数量</span>
    size_t num_input_nodes <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">GetInputCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token function">input_node_names</span><span class="token punctuation">(</span>num_input_nodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span> input_node_dims<span class="token punctuation">;</span>   <span class="token comment">/** 简化……该模型只有1个输入节点{1, 3, 1024, 1278}, 否则需要 vector&lt;vector&lt;&gt;&gt; **/</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"输入节点数量 = "</span> <span class="token operator">&lt;&lt;</span>  num_input_nodes<span class="token punctuation">;</span>

    <span class="token comment">// 遍历所有输入节点</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_input_nodes<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 打印输入节点名称</span>
        <span class="token keyword">char</span><span class="token operator">*</span> input_name <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">GetInputName</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输入节点第 %d 个: name=%s"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> input_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        input_node_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> input_name<span class="token punctuation">;</span>

        <span class="token comment">// 打印输入节点类型</span>
        Ort<span class="token double-colon punctuation">::</span>TypeInfo type_info <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">GetInputTypeInfo</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> tensor_info <span class="token operator">=</span> type_info<span class="token punctuation">.</span><span class="token function">GetTensorTypeAndShapeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ONNXTensorElementDataType type <span class="token operator">=</span> tensor_info<span class="token punctuation">.</span><span class="token function">GetElementType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输入节点第 %d 个: type=%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 打印输入 shapes/dims</span>
        input_node_dims <span class="token operator">=</span> tensor_info<span class="token punctuation">.</span><span class="token function">GetShape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输入节点第 %d 个: num_dims=%zu"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> input_node_dims<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> input_node_dims<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输入节点第 %d 个: dim %d=%jd"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> input_node_dims<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Demo</span><span class="token double-colon punctuation">::</span><span class="token function">printOutputModel</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>Session <span class="token operator">*</span>session<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Ort<span class="token double-colon punctuation">::</span>AllocatorWithDefaultOptions allocator<span class="token punctuation">;</span>
    <span class="token comment">//打印模型输出节点的数量</span>
    size_t num_output_nodes <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">GetOutputCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token function">output_node_names</span><span class="token punctuation">(</span>num_output_nodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span> output_node_dims<span class="token punctuation">;</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"输出节点数量 = "</span> <span class="token operator">&lt;&lt;</span>  num_output_nodes<span class="token punctuation">;</span>

    <span class="token comment">// 遍历所有输出节点</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_output_nodes<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 打印输出节点名称</span>
        <span class="token keyword">char</span><span class="token operator">*</span> output_name <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">GetOutputName</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输出节点第 %d 个: name=%s"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> output_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        output_node_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> output_name<span class="token punctuation">;</span>

        <span class="token comment">// 打印输出节点类型</span>
        Ort<span class="token double-colon punctuation">::</span>TypeInfo type_info <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">GetOutputTypeInfo</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> tensor_info <span class="token operator">=</span> type_info<span class="token punctuation">.</span><span class="token function">GetTensorTypeAndShapeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ONNXTensorElementDataType type <span class="token operator">=</span> tensor_info<span class="token punctuation">.</span><span class="token function">GetElementType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输出节点第 %d 个: type=%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 打印输出 shapes/dims</span>
        output_node_dims <span class="token operator">=</span> tensor_info<span class="token punctuation">.</span><span class="token function">GetShape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输出节点第 %d 个: num_dims=%zu"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> output_node_dims<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> output_node_dims<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"输出节点第 %d 个: dim %d=%jd"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> output_node_dims<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Demo</span><span class="token double-colon punctuation">::</span><span class="token function">predictImage</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>Session <span class="token operator">*</span>session<span class="token punctuation">,</span> QString imgPath<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 预处理图片</span>
    cv<span class="token double-colon punctuation">::</span>Mat mat <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span>imgPath<span class="token punctuation">.</span><span class="token function">toStdString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/** 读取需要预测的图片 **/</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>mat<span class="token punctuation">,</span> mat<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>COLOR_BGR2RGB<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">/** 将图片的通道转变一下 **/</span>
    size_t input_tensor_size <span class="token operator">=</span> mat<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>width <span class="token operator">*</span> mat<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>height <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> <span class="token function">input_data</span><span class="token punctuation">(</span>input_tensor_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">normalized</span><span class="token punctuation">(</span>mat<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">/** 归一化图片数据 **/</span>

    <span class="token comment">// 从数据值创建输入张量对象</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span> input_node_dims <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> mat<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>height<span class="token punctuation">,</span> mat<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>width<span class="token punctuation">}</span><span class="token punctuation">;</span>
    Ort<span class="token double-colon punctuation">::</span>MemoryInfo memory_info <span class="token operator">=</span> Ort<span class="token double-colon punctuation">::</span><span class="token class-name">MemoryInfo</span><span class="token double-colon punctuation">::</span><span class="token function">CreateCpu</span><span class="token punctuation">(</span>OrtArenaAllocator<span class="token punctuation">,</span> OrtMemTypeDefault<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ort<span class="token double-colon punctuation">::</span>Value input_tensor <span class="token operator">=</span> Ort<span class="token double-colon punctuation">::</span>Value<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">CreateTensor</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>memory_info<span class="token punctuation">,</span> input_data<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input_tensor_size<span class="token punctuation">,</span> input_node_dims<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input_node_dims<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>input_tensor<span class="token punctuation">.</span><span class="token function">IsTensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Ort<span class="token double-colon punctuation">::</span>Value<span class="token operator">&gt;</span> ort_inputs<span class="token punctuation">;</span>
    ort_inputs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设计输入和输出的名字</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span> input_node_names <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"image"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span> output_node_names <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"boxes"</span><span class="token punctuation">,</span> <span class="token string">"labels"</span><span class="token punctuation">,</span> <span class="token string">"scores"</span><span class="token punctuation">,</span> <span class="token string">"masks"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 输入图片数据，运行模型获取预测结果，</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Ort<span class="token double-colon punctuation">::</span>Value<span class="token operator">&gt;</span> output_tensors <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">Run</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>RunOptions<span class="token punctuation">{<!-- --></span><span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">,</span> input_node_names<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ort_inputs<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> output_node_names<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>output_tensors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> output_tensors<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsTensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取一下预测结果</span>
    Ort<span class="token double-colon punctuation">::</span>AllocatorWithDefaultOptions allocator<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> output_tensors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span><span class="token operator">*</span> output_name <span class="token operator">=</span> session<span class="token operator">-&gt;</span><span class="token function">GetOutputName</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"/****************"</span><span class="token operator">&lt;&lt;</span>output_name<span class="token operator">&lt;&lt;</span><span class="token string">"*******************/"</span><span class="token punctuation">;</span>
        Ort<span class="token double-colon punctuation">::</span>Value <span class="token operator">*</span>output <span class="token operator">=</span> <span class="token operator">&amp;</span>output_tensors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> <span class="token operator">*</span>value <span class="token operator">=</span> output<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">GetTensorMutableData</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span> shape <span class="token operator">=</span> output<span class="token operator">-&gt;</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTensorTypeAndShapeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetShape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>output_name<span class="token punctuation">,</span> <span class="token string">"boxes"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>QPointF<span class="token operator">&gt;&gt;</span> boxes<span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>value<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token string">","</span><span class="token operator">&lt;&lt;</span>value<span class="token punctuation">[</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token string">" | "</span><span class="token operator">&lt;&lt;</span>value<span class="token punctuation">[</span>index<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token string">","</span><span class="token operator">&lt;&lt;</span>value<span class="token punctuation">[</span>index<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>QPointF<span class="token operator">&gt;</span> points<span class="token punctuation">;</span>
                points<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">QPointF</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span>value<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                points<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">QPointF</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                boxes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>output_name<span class="token punctuation">,</span> <span class="token string">"labels"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> labels<span class="token punctuation">;</span>
            <span class="token keyword">int64_t</span> <span class="token operator">*</span>labelV <span class="token operator">=</span> output<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">GetTensorMutableData</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> labelV<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span>
                labels<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>output_name<span class="token punctuation">,</span> <span class="token string">"scores"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> scores<span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> value<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span>
                scores<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>output_name<span class="token punctuation">,</span> <span class="token string">"masks"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&gt;</span> masks<span class="token punctuation">;</span>
            index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                cv<span class="token double-colon punctuation">::</span>Mat <span class="token function">mask</span><span class="token punctuation">(</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> CV_32FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span>mask<span class="token punctuation">.</span>data<span class="token punctuation">,</span> value <span class="token operator">+</span> x <span class="token operator">*</span> shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                QString name <span class="token operator">=</span> <span class="token function">QString</span><span class="token punctuation">(</span><span class="token string">"./masks_%1.bmp"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cv<span class="token double-colon punctuation">::</span><span class="token function">imwrite</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">toStdString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mask<span class="token operator">*</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                masks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Demo</span><span class="token double-colon punctuation">::</span><span class="token function">normalized</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Mat input_tensor<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>output_data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>size_t counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> input_tensor<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> input_tensor<span class="token punctuation">.</span>cols<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                output_data<span class="token punctuation">[</span>counter<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>input_tensor<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Vec3b<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>main.cpp中</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QGuiApplication&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QQmlApplicationEngine&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Demo.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QGuiApplication <span class="token function">app</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Demo demo<span class="token punctuation">;</span>
    demo<span class="token punctuation">.</span><span class="token function">demoModel</span><span class="token punctuation">(</span><span class="token string">"/home/ps/work/Python/trainMaskRcnn/PennFudanPed/PNGImages/FudanPed00001.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    QQmlApplicationEngine engine<span class="token punctuation">;</span>
    engine<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token function">QUrl</span><span class="token punctuation">(</span><span class="token function">QStringLiteral</span><span class="token punctuation">(</span><span class="token string">"qrc:/main.qml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>engine<span class="token punctuation">.</span><span class="token function">rootObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="7__658"></a>7. 输出结果</h3> 
<p>输入层和输出层的打印log太多了我就不放了，只放一下预测图片的输出结果。<br> <img src="https://images2.imgbox.com/28/ac/4XzxIQZa_o.png" alt="预测结果"><br> masks的图片保存结果。<br> <img src="https://images2.imgbox.com/0d/3d/YkmFb8gu_o.png" alt="mask结果图片"></p> 
<p>2023/09/11更新：</p> 
<h3><a id="8_mask_665"></a>8. 将mask结果叠加在原图上</h3> 
<p>经过以上处理后，mask的值转变为一个opencv的Mat数据，这个Mat数据的type为CV_32F，也就是值为float。<br> 而值越接近1，说明此像素位置越接近目标。<br> 上代码：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">ImageThread</span><span class="token double-colon punctuation">::</span><span class="token function">addMask</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Mat <span class="token operator">&amp;</span>mat<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>Mat mask<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    cv<span class="token double-colon punctuation">::</span>Mat newMask <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token class-name">Mat</span><span class="token double-colon punctuation">::</span><span class="token function">zeros</span><span class="token punctuation">(</span>mat<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CV_8UC3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>newMask<span class="token punctuation">,</span> newMask<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>COLOR_RGB2BGR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> mask<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>height<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> mask<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>width<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// mask上的数据是float值，值越大说明它比重越大，这里只截取0.75以上的比重，作为mask的值。</span>
            <span class="token keyword">float</span> maskColor <span class="token operator">=</span> mask<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.75</span> <span class="token operator">?</span> mask<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            newMask<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Vec3b<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            newMask<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Vec3b<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            newMask<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Vec3b<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> maskColor <span class="token operator">*</span> <span class="token number">255.0f</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    mask<span class="token punctuation">.</span><span class="token function">copyTo</span><span class="token punctuation">(</span>mat<span class="token punctuation">,</span> mask<span class="token operator">=</span>newMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>代码中函数参数为mat，只显示mask中值为0.75以上的值，并将mask区域设置为红色叠加在原图中。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c2567f43f2522e9be03c69c013e11665/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring-Cloud-Gateway源码解析——过滤器 之 RequestRateLimiterGatewayFilterFactory 请求限流</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ee916320c4d537ca539e203c012a4989/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">英特尔边缘解决方案挑战赛</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>