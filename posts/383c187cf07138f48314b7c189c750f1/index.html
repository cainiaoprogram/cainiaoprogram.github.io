<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用LSTM预测股票数据 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用LSTM预测股票数据" />
<meta property="og:description" content="数据集：股票数据集.
数据集来源：:https://www.kaggle.com/dsadads/databases
1 加载数据集 import numpy as np import pandas as pd import datetime stock = pd.read_csv(&#39;dataset/SH600519.csv&#39;) stock_data = pd.read_csv(&#39;dataset/SH600519.csv&#39;) stock_data.set_index([&#39;date&#39;], inplace=True) stock_data Unnamed: 0openclosehighlowvolumecodedate2010-04-267488.70287.38189.07287.362107036.136005192010-04-277587.35584.84187.35584.68158234.486005192010-04-287684.23584.31885.12883.59726287.436005192010-04-297784.59285.67186.31584.59234501.206005192010-04-307883.87182.34083.87181.52385566.70600519........................2020-04-2024951221.0001227.3001231.5001216.80024239.006005192020-04-2124961221.0201200.0001223.9901193.00029224.006005192020-04-2224971206.0001244.5001249.5001202.22044035.006005192020-04-2324981250.0001252.2601265.6801247.77026899.006005192020-04-2424991248.0001250.5601259.8901235.18019122.00600519 2426 rows × 7 columns
2 绘制收盘价图 import matplotlib.pyplot as plt from matplotlib import ticker # 调整坐标轴 from matplotlib.pylab import date2num # 日期转换 stock = stock[100:200] stock[&#39;close&#39;].plot(grid = True) &lt;AxesSubplot:&gt; 3 计算涨跌幅 stock_data.shape[0] 2426 stock_data.iloc[101:102,].values array([[1.75000e&#43;02, 1.06990e&#43;02, 1.08749e&#43;02, 1.08858e&#43;02, 1.06475e&#43;02, 1.85480e&#43;04, 6.00519e&#43;05]]) quote_change = [] for i in range(stock_data." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/383c187cf07138f48314b7c189c750f1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-23T15:17:57+08:00" />
<meta property="article:modified_time" content="2022-02-23T15:17:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用LSTM预测股票数据</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>数据集：股票数据集.</strong></p> 
<p><font color="Red"><strong>数据集来源：</strong></font>:https://www.kaggle.com/dsadads/databases</p> 
<h4><a id="font_colorred1_font_4"></a><font color="red">1 加载数据集</font></h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> datetime
</code></pre> 
<pre><code class="prism language-python">stock <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'dataset/SH600519.csv'</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">stock_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'dataset/SH600519.csv'</span><span class="token punctuation">)</span>
stock_data<span class="token punctuation">.</span>set_index<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">stock_data
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>Unnamed: 0</th><th>open</th><th>close</th><th>high</th><th>low</th><th>volume</th><th>code</th></tr><tr><th>date</th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><th>2010-04-26</th><td>74</td><td>88.702</td><td>87.381</td><td>89.072</td><td>87.362</td><td>107036.13</td><td>600519</td></tr><tr><th>2010-04-27</th><td>75</td><td>87.355</td><td>84.841</td><td>87.355</td><td>84.681</td><td>58234.48</td><td>600519</td></tr><tr><th>2010-04-28</th><td>76</td><td>84.235</td><td>84.318</td><td>85.128</td><td>83.597</td><td>26287.43</td><td>600519</td></tr><tr><th>2010-04-29</th><td>77</td><td>84.592</td><td>85.671</td><td>86.315</td><td>84.592</td><td>34501.20</td><td>600519</td></tr><tr><th>2010-04-30</th><td>78</td><td>83.871</td><td>82.340</td><td>83.871</td><td>81.523</td><td>85566.70</td><td>600519</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>2020-04-20</th><td>2495</td><td>1221.000</td><td>1227.300</td><td>1231.500</td><td>1216.800</td><td>24239.00</td><td>600519</td></tr><tr><th>2020-04-21</th><td>2496</td><td>1221.020</td><td>1200.000</td><td>1223.990</td><td>1193.000</td><td>29224.00</td><td>600519</td></tr><tr><th>2020-04-22</th><td>2497</td><td>1206.000</td><td>1244.500</td><td>1249.500</td><td>1202.220</td><td>44035.00</td><td>600519</td></tr><tr><th>2020-04-23</th><td>2498</td><td>1250.000</td><td>1252.260</td><td>1265.680</td><td>1247.770</td><td>26899.00</td><td>600519</td></tr><tr><th>2020-04-24</th><td>2499</td><td>1248.000</td><td>1250.560</td><td>1259.890</td><td>1235.180</td><td>19122.00</td><td>600519</td></tr></tbody></table> 
<p>2426 rows × 7 columns</p> 
<h4><a id="font_colorred2_font_191"></a><font color="red">2 绘制收盘价图</font></h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> ticker <span class="token comment"># 调整坐标轴</span>
<span class="token keyword">from</span> matplotlib<span class="token punctuation">.</span>pylab <span class="token keyword">import</span> date2num <span class="token comment"># 日期转换</span>
</code></pre> 
<pre><code class="prism language-python">stock <span class="token operator">=</span> stock<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python">stock<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>grid <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>&lt;AxesSubplot:&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/55/2c/qXXH3J7x_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="font_colorred3_font_222"></a><font color="red">3 计算涨跌幅</font></h4> 
<pre><code class="prism language-python">stock_data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code>2426
</code></pre> 
<pre><code class="prism language-python">stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">:</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values
</code></pre> 
<pre><code>array([[1.75000e+02, 1.06990e+02, 1.08749e+02, 1.08858e+02, 1.06475e+02,
        1.85480e+04, 6.00519e+05]])
</code></pre> 
<pre><code class="prism language-python">quote_change <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>stock_data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        quote_change<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        today <span class="token operator">=</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        yestaday <span class="token operator">=</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        quote <span class="token operator">=</span> <span class="token punctuation">(</span>today <span class="token operator">-</span> yestaday<span class="token punctuation">)</span><span class="token operator">/</span>yestaday
        quote_change<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>quote<span class="token punctuation">,</span>dtype<span class="token operator">=</span>np<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">stock_data<span class="token punctuation">[</span><span class="token string">'quote_change'</span><span class="token punctuation">]</span> <span class="token operator">=</span> quote_change
</code></pre> 
<pre><code class="prism language-python">stock_data
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>Unnamed: 0</th><th>open</th><th>close</th><th>high</th><th>low</th><th>volume</th><th>code</th><th>quote_change</th></tr><tr><th>date</th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><th>2010-04-26</th><td>74</td><td>88.702</td><td>87.381</td><td>89.072</td><td>87.362</td><td>107036.13</td><td>600519</td><td>0</td></tr><tr><th>2010-04-27</th><td>75</td><td>87.355</td><td>84.841</td><td>87.355</td><td>84.681</td><td>58234.48</td><td>600519</td><td>-0.015185677887758948</td></tr><tr><th>2010-04-28</th><td>76</td><td>84.235</td><td>84.318</td><td>85.128</td><td>83.597</td><td>26287.43</td><td>600519</td><td>-0.03571632991815013</td></tr><tr><th>2010-04-29</th><td>77</td><td>84.592</td><td>85.671</td><td>86.315</td><td>84.592</td><td>34501.20</td><td>600519</td><td>0.00423814328960645</td></tr><tr><th>2010-04-30</th><td>78</td><td>83.871</td><td>82.340</td><td>83.871</td><td>81.523</td><td>85566.70</td><td>600519</td><td>-0.008523264611310805</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>2020-04-20</th><td>2495</td><td>1221.000</td><td>1227.300</td><td>1231.500</td><td>1216.800</td><td>24239.00</td><td>600519</td><td>0.00909090909090909</td></tr><tr><th>2020-04-21</th><td>2496</td><td>1221.020</td><td>1200.000</td><td>1223.990</td><td>1193.000</td><td>29224.00</td><td>600519</td><td>1.6380016380001484e-05</td></tr><tr><th>2020-04-22</th><td>2497</td><td>1206.000</td><td>1244.500</td><td>1249.500</td><td>1202.220</td><td>44035.00</td><td>600519</td><td>-0.012301190807685363</td></tr><tr><th>2020-04-23</th><td>2498</td><td>1250.000</td><td>1252.260</td><td>1265.680</td><td>1247.770</td><td>26899.00</td><td>600519</td><td>0.03648424543946932</td></tr><tr><th>2020-04-24</th><td>2499</td><td>1248.000</td><td>1250.560</td><td>1259.890</td><td>1235.180</td><td>19122.00</td><td>600519</td><td>-0.0016</td></tr></tbody></table> 
<p>2426 rows × 8 columns</p> 
<h5><a id="font_colorpink20font_443"></a><font color="pink">20天最大涨幅的计算</font></h5> 
<pre><code class="prism language-python"><span class="token builtin">len</span><span class="token punctuation">(</span>stock_data<span class="token punctuation">)</span>
</code></pre> 
<pre><code>2426
</code></pre> 
<h5><a id="_457"></a>封装成函数</h5> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">up</span><span class="token punctuation">(</span>min_data <span class="token punctuation">,</span>i <span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>min_data <span class="token operator">&gt;</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i <span class="token operator">-</span> m<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        min_data <span class="token operator">=</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i <span class="token operator">-</span> m<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> min_data
<span class="token keyword">def</span> <span class="token function">down</span><span class="token punctuation">(</span>min_data<span class="token punctuation">,</span>i<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>min_data <span class="token operator">&gt;</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> k<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        min_data <span class="token operator">=</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> k<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> min_data
</code></pre> 
<pre><code class="prism language-python">sequence <span class="token operator">=</span> <span class="token number">20</span>

new_feature <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>stock_data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    min_data <span class="token operator">=</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment"># 当i&lt;10时，向上寻找i中最小值 向下寻找十天的最小值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> m <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
            min_data <span class="token operator">=</span> up<span class="token punctuation">(</span>min_data <span class="token punctuation">,</span>i <span class="token punctuation">,</span>m<span class="token punctuation">)</span>       
        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            min_data <span class="token operator">=</span> down<span class="token punctuation">(</span>min_data<span class="token punctuation">,</span>i<span class="token punctuation">,</span>k<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token punctuation">(</span>stock<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                  
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            min_data <span class="token operator">=</span> up<span class="token punctuation">(</span>min_data <span class="token punctuation">,</span>i <span class="token punctuation">,</span>j<span class="token punctuation">)</span>   
        <span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>   
            min_data <span class="token operator">=</span> down<span class="token punctuation">(</span>min_data<span class="token punctuation">,</span>i<span class="token punctuation">,</span>n<span class="token punctuation">)</span> 
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            min_data <span class="token operator">=</span> up<span class="token punctuation">(</span>min_data<span class="token punctuation">,</span>i<span class="token punctuation">,</span>j<span class="token punctuation">)</span>
        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            min_data <span class="token operator">=</span> down<span class="token punctuation">(</span>min_data<span class="token punctuation">,</span>i<span class="token punctuation">,</span>k<span class="token punctuation">)</span>
        
    new_feature<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">(</span>stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-</span>min_data<span class="token punctuation">)</span><span class="token operator">/</span>min_data<span class="token punctuation">,</span>dtype<span class="token operator">=</span>np<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_499"></a>直接求</h5> 
<pre><code class="prism language-python">sequence <span class="token operator">=</span> <span class="token number">20</span>

new_feature <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>stock_data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    min_data <span class="token operator">=</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment"># 当i&lt;10时，向上寻找i中最小值 向下寻找十天的最小值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> m <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>min_data <span class="token operator">&gt;</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token operator">-</span>m<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                min_data <span class="token operator">=</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token operator">-</span>m<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>       
        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>min_data <span class="token operator">&gt;</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> k<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                min_data <span class="token operator">=</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> k<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token punctuation">(</span>stock<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                  
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>min_data <span class="token operator">&gt;</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">-</span> j<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                min_data <span class="token operator">=</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">-</span> j<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  
        <span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>   
             <span class="token keyword">if</span><span class="token punctuation">(</span>min_data <span class="token operator">&gt;</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> n<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                min_data <span class="token operator">=</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> n<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>min_data <span class="token operator">&gt;</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">-</span> j<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                min_data <span class="token operator">=</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">-</span> j<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  
        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>min_data <span class="token operator">&gt;</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> k<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                min_data <span class="token operator">=</span> stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> k<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        
    new_feature<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">(</span>stock_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-</span>min_data<span class="token punctuation">)</span><span class="token operator">/</span>min_data<span class="token punctuation">,</span>dtype<span class="token operator">=</span>np<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>new_feature</p> 
<pre><code class="prism language-python"><span class="token builtin">len</span><span class="token punctuation">(</span>new_feature<span class="token punctuation">)</span>
</code></pre> 
<pre><code>2426
</code></pre> 
<pre><code class="prism language-python">stock_data<span class="token punctuation">[</span><span class="token string">'max_increase'</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_feature
</code></pre> 
<pre><code class="prism language-python">stock_data
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>Unnamed: 0</th><th>open</th><th>close</th><th>high</th><th>low</th><th>volume</th><th>code</th><th>quote_change</th><th>max_increase</th></tr><tr><th>date</th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><th>2010-04-26</th><td>74</td><td>88.702</td><td>87.381</td><td>89.072</td><td>87.362</td><td>107036.13</td><td>600519</td><td>0</td><td>0.10317637987214874</td></tr><tr><th>2010-04-27</th><td>75</td><td>87.355</td><td>84.841</td><td>87.355</td><td>84.681</td><td>58234.48</td><td>600519</td><td>-0.015185677887758948</td><td>0.08642389871402628</td></tr><tr><th>2010-04-28</th><td>76</td><td>84.235</td><td>84.318</td><td>85.128</td><td>83.597</td><td>26287.43</td><td>600519</td><td>-0.03571632991815013</td><td>0.0476208243165932</td></tr><tr><th>2010-04-29</th><td>77</td><td>84.592</td><td>85.671</td><td>86.315</td><td>84.592</td><td>34501.20</td><td>600519</td><td>0.00423814328960645</td><td>0.052060791483222554</td></tr><tr><th>2010-04-30</th><td>78</td><td>83.871</td><td>82.340</td><td>83.871</td><td>81.523</td><td>85566.70</td><td>600519</td><td>-0.008523264611310805</td><td>0.043093798970225965</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>2020-04-20</th><td>2495</td><td>1221.000</td><td>1227.300</td><td>1231.500</td><td>1216.800</td><td>24239.00</td><td>600519</td><td>0.00909090909090909</td><td>0.059895833333333336</td></tr><tr><th>2020-04-21</th><td>2496</td><td>1221.020</td><td>1200.000</td><td>1223.990</td><td>1193.000</td><td>29224.00</td><td>600519</td><td>1.6380016380001484e-05</td><td>0.05991319444444443</td></tr><tr><th>2020-04-22</th><td>2497</td><td>1206.000</td><td>1244.500</td><td>1249.500</td><td>1202.220</td><td>44035.00</td><td>600519</td><td>-0.012301190807685363</td><td>0.04155871074722759</td></tr><tr><th>2020-04-23</th><td>2498</td><td>1250.000</td><td>1252.260</td><td>1265.680</td><td>1247.770</td><td>26899.00</td><td>600519</td><td>0.03648424543946932</td><td>0.07955919438974668</td></tr><tr><th>2020-04-24</th><td>2499</td><td>1248.000</td><td>1250.560</td><td>1259.890</td><td>1235.180</td><td>19122.00</td><td>600519</td><td>-0.0016</td><td>0.07124463519313305</td></tr></tbody></table> 
<p>2426 rows × 9 columns</p> 
<h2><a id="use_cols_740"></a>选择use_cols作为特征</h2> 
<pre><code>#X.append(np.array(stock_data.iloc[i:(i+sequence),].values, dtype=np.float))
# label 取当前日期后的30天收盘价涨幅
#y.append(np.array(stock_data.iloc[(i + sequence,5)],dtype=np.float))
</code></pre> 
<h4><a id="font_colorred4_font_744"></a><font color="red">4 归一化</font></h4> 
<h5><a id="sklearn_746"></a>sklearn</h5> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> MinMaxScaler 
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># stock_data = stock_data[2000:2420]</span>
</code></pre> 
<pre><code class="prism language-python">columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">,</span><span class="token string">'close'</span><span class="token punctuation">,</span><span class="token string">'high'</span><span class="token punctuation">,</span><span class="token string">'low'</span><span class="token punctuation">,</span><span class="token string">'volume'</span><span class="token punctuation">,</span><span class="token string">'quote_change'</span><span class="token punctuation">,</span><span class="token string">'max_increase'</span><span class="token punctuation">]</span>
stock_data <span class="token operator">=</span> stock_data<span class="token punctuation">[</span>columns<span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python">stock_data
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>open</th><th>close</th><th>high</th><th>low</th><th>volume</th><th>quote_change</th><th>max_increase</th></tr><tr><th>date</th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><th>2010-04-26</th><td>88.702</td><td>87.381</td><td>89.072</td><td>87.362</td><td>107036.13</td><td>0</td><td>0.10317637987214874</td></tr><tr><th>2010-04-27</th><td>87.355</td><td>84.841</td><td>87.355</td><td>84.681</td><td>58234.48</td><td>-0.015185677887758948</td><td>0.08642389871402628</td></tr><tr><th>2010-04-28</th><td>84.235</td><td>84.318</td><td>85.128</td><td>83.597</td><td>26287.43</td><td>-0.03571632991815013</td><td>0.0476208243165932</td></tr><tr><th>2010-04-29</th><td>84.592</td><td>85.671</td><td>86.315</td><td>84.592</td><td>34501.20</td><td>0.00423814328960645</td><td>0.052060791483222554</td></tr><tr><th>2010-04-30</th><td>83.871</td><td>82.340</td><td>83.871</td><td>81.523</td><td>85566.70</td><td>-0.008523264611310805</td><td>0.043093798970225965</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>2020-04-20</th><td>1221.000</td><td>1227.300</td><td>1231.500</td><td>1216.800</td><td>24239.00</td><td>0.00909090909090909</td><td>0.059895833333333336</td></tr><tr><th>2020-04-21</th><td>1221.020</td><td>1200.000</td><td>1223.990</td><td>1193.000</td><td>29224.00</td><td>1.6380016380001484e-05</td><td>0.05991319444444443</td></tr><tr><th>2020-04-22</th><td>1206.000</td><td>1244.500</td><td>1249.500</td><td>1202.220</td><td>44035.00</td><td>-0.012301190807685363</td><td>0.04155871074722759</td></tr><tr><th>2020-04-23</th><td>1250.000</td><td>1252.260</td><td>1265.680</td><td>1247.770</td><td>26899.00</td><td>0.03648424543946932</td><td>0.07955919438974668</td></tr><tr><th>2020-04-24</th><td>1248.000</td><td>1250.560</td><td>1259.890</td><td>1235.180</td><td>19122.00</td><td>-0.0016</td><td>0.07124463519313305</td></tr></tbody></table> 
<p>2426 rows × 7 columns</p> 
<pre><code class="prism language-python">scaler <span class="token operator">=</span> MinMaxScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
stock_scaler <span class="token operator">=</span> scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>stock_data<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">stock_scaler <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>stock_scaler<span class="token punctuation">)</span>
stock_scaler<span class="token punctuation">.</span>columns <span class="token operator">=</span> columns
</code></pre> 
<pre><code class="prism language-python">stock_scaler
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>open</th><th>close</th><th>high</th><th>low</th><th>volume</th><th>quote_change</th><th>max_increase</th></tr></thead><tbody><tr><th>0</th><td>0.007093</td><td>0.005806</td><td>0.006509</td><td>0.006230</td><td>0.353556</td><td>0.436961</td><td>0.299871</td></tr><tr><th>1</th><td>0.005941</td><td>0.003638</td><td>0.005059</td><td>0.003934</td><td>0.180317</td><td>0.378208</td><td>0.251182</td></tr><tr><th>2</th><td>0.003274</td><td>0.003192</td><td>0.003179</td><td>0.003006</td><td>0.066909</td><td>0.298776</td><td>0.138405</td></tr><tr><th>3</th><td>0.003579</td><td>0.004347</td><td>0.004181</td><td>0.003858</td><td>0.096067</td><td>0.453358</td><td>0.151309</td></tr><tr><th>4</th><td>0.002963</td><td>0.001504</td><td>0.002118</td><td>0.001230</td><td>0.277342</td><td>0.403985</td><td>0.125247</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>2421</th><td>0.975205</td><td>0.978697</td><td>0.971139</td><td>0.973477</td><td>0.059637</td><td>0.472133</td><td>0.174081</td></tr><tr><th>2422</th><td>0.975222</td><td>0.955397</td><td>0.964798</td><td>0.953095</td><td>0.077333</td><td>0.437024</td><td>0.174131</td></tr><tr><th>2423</th><td>0.962380</td><td>0.993377</td><td>0.986338</td><td>0.960991</td><td>0.129910</td><td>0.389368</td><td>0.120786</td></tr><tr><th>2424</th><td>1.000000</td><td>1.000000</td><td>1.000000</td><td>1.000000</td><td>0.069080</td><td>0.578117</td><td>0.231230</td></tr><tr><th>2425</th><td>0.998290</td><td>0.998549</td><td>0.995111</td><td>0.989218</td><td>0.041473</td><td>0.430770</td><td>0.207065</td></tr></tbody></table> 
<p>2426 rows × 7 columns</p> 
<pre><code class="prism language-python"><span class="token comment"># 为了归一化后复现原来数据</span>
close_min <span class="token operator">=</span> stock_data<span class="token punctuation">[</span><span class="token string">'quote_change'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
close_max <span class="token operator">=</span> stock_data<span class="token punctuation">[</span><span class="token string">'quote_change'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 归一化处理（0，1）</span>
stock<span class="token operator">=</span>stock_data<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token builtin">min</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">-</span><span class="token builtin">min</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
stock
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>open</th><th>close</th><th>high</th><th>low</th><th>volume</th><th>quote_change</th><th>max_increase</th></tr><tr><th>date</th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><th>2010-04-26</th><td>0.007093</td><td>0.005806</td><td>0.006509</td><td>0.006230</td><td>0.353556</td><td>0.436961</td><td>0.299871</td></tr><tr><th>2010-04-27</th><td>0.005941</td><td>0.003638</td><td>0.005059</td><td>0.003934</td><td>0.180317</td><td>0.378208</td><td>0.251182</td></tr><tr><th>2010-04-28</th><td>0.003274</td><td>0.003192</td><td>0.003179</td><td>0.003006</td><td>0.066909</td><td>0.298776</td><td>0.138405</td></tr><tr><th>2010-04-29</th><td>0.003579</td><td>0.004347</td><td>0.004181</td><td>0.003858</td><td>0.096067</td><td>0.453358</td><td>0.151309</td></tr><tr><th>2010-04-30</th><td>0.002963</td><td>0.001504</td><td>0.002118</td><td>0.001230</td><td>0.277342</td><td>0.403985</td><td>0.125247</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>2020-04-20</th><td>0.975205</td><td>0.978697</td><td>0.971139</td><td>0.973477</td><td>0.059637</td><td>0.472133</td><td>0.174081</td></tr><tr><th>2020-04-21</th><td>0.975222</td><td>0.955397</td><td>0.964798</td><td>0.953095</td><td>0.077333</td><td>0.437024</td><td>0.174131</td></tr><tr><th>2020-04-22</th><td>0.962380</td><td>0.993377</td><td>0.986338</td><td>0.960991</td><td>0.129910</td><td>0.389368</td><td>0.120786</td></tr><tr><th>2020-04-23</th><td>1.000000</td><td>1.000000</td><td>1.000000</td><td>1.000000</td><td>0.069080</td><td>0.578117</td><td>0.23123</td></tr><tr><th>2020-04-24</th><td>0.998290</td><td>0.998549</td><td>0.995111</td><td>0.989218</td><td>0.041473</td><td>0.43077</td><td>0.207065</td></tr></tbody></table> 
<p>2426 rows × 7 columns</p> 
<h4><a id="font_colorred5_20font_1260"></a><font color="red">5 前20天的数据预测之后的数据</font></h4> 
<pre><code class="prism language-python">stock <span class="token operator">=</span> stock_scaler
</code></pre> 
<pre><code class="prism language-python">pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">201</span><span class="token punctuation">:</span><span class="token number">400</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th></tr></thead><tbody><tr><th>0</th><td>0.029674</td><td>0.029436</td><td>0.029161</td><td>0.029494</td><td>0.055448</td><td>0.424231</td><td>0.000000</td></tr><tr><th>1</th><td>0.029393</td><td>0.028650</td><td>0.028655</td><td>0.028507</td><td>0.087525</td><td>0.425903</td><td>0.000000</td></tr><tr><th>2</th><td>0.028881</td><td>0.027435</td><td>0.028486</td><td>0.027811</td><td>0.107546</td><td>0.416771</td><td>0.000000</td></tr><tr><th>3</th><td>0.027631</td><td>0.027946</td><td>0.027448</td><td>0.027674</td><td>0.091984</td><td>0.387424</td><td>0.000000</td></tr><tr><th>4</th><td>0.028094</td><td>0.028743</td><td>0.027856</td><td>0.028413</td><td>0.092701</td><td>0.455529</td><td>0.013949</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>194</th><td>0.051861</td><td>0.051945</td><td>0.051049</td><td>0.052022</td><td>0.028754</td><td>0.380821</td><td>0.000000</td></tr><tr><th>195</th><td>0.051450</td><td>0.052410</td><td>0.052271</td><td>0.051808</td><td>0.038700</td><td>0.423796</td><td>0.000000</td></tr><tr><th>196</th><td>0.051830</td><td>0.050992</td><td>0.051593</td><td>0.051102</td><td>0.026645</td><td>0.449180</td><td>0.009179</td></tr><tr><th>197</th><td>0.052522</td><td>0.054592</td><td>0.053468</td><td>0.052875</td><td>0.082392</td><td>0.459155</td><td>0.025905</td></tr><tr><th>198</th><td>0.054341</td><td>0.054115</td><td>0.053112</td><td>0.053678</td><td>0.063958</td><td>0.495008</td><td>0.069899</td></tr></tbody></table> 
<p>199 rows × 7 columns</p> 
<pre><code class="prism language-python">stock
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>open</th><th>close</th><th>high</th><th>low</th><th>volume</th><th>quote_change</th><th>max_increase</th></tr></thead><tbody><tr><th>0</th><td>0.007093</td><td>0.005806</td><td>0.006509</td><td>0.006230</td><td>0.353556</td><td>0.436961</td><td>0.299871</td></tr><tr><th>1</th><td>0.005941</td><td>0.003638</td><td>0.005059</td><td>0.003934</td><td>0.180317</td><td>0.378208</td><td>0.251182</td></tr><tr><th>2</th><td>0.003274</td><td>0.003192</td><td>0.003179</td><td>0.003006</td><td>0.066909</td><td>0.298776</td><td>0.138405</td></tr><tr><th>3</th><td>0.003579</td><td>0.004347</td><td>0.004181</td><td>0.003858</td><td>0.096067</td><td>0.453358</td><td>0.151309</td></tr><tr><th>4</th><td>0.002963</td><td>0.001504</td><td>0.002118</td><td>0.001230</td><td>0.277342</td><td>0.403985</td><td>0.125247</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>2421</th><td>0.975205</td><td>0.978697</td><td>0.971139</td><td>0.973477</td><td>0.059637</td><td>0.472133</td><td>0.174081</td></tr><tr><th>2422</th><td>0.975222</td><td>0.955397</td><td>0.964798</td><td>0.953095</td><td>0.077333</td><td>0.437024</td><td>0.174131</td></tr><tr><th>2423</th><td>0.962380</td><td>0.993377</td><td>0.986338</td><td>0.960991</td><td>0.129910</td><td>0.389368</td><td>0.120786</td></tr><tr><th>2424</th><td>1.000000</td><td>1.000000</td><td>1.000000</td><td>1.000000</td><td>0.069080</td><td>0.578117</td><td>0.231230</td></tr><tr><th>2425</th><td>0.998290</td><td>0.998549</td><td>0.995111</td><td>0.989218</td><td>0.041473</td><td>0.430770</td><td>0.207065</td></tr></tbody></table> 
<p>2426 rows × 7 columns</p> 
<pre><code class="prism language-python"><span class="token comment"># 序列长度为30，即用前一个月的数据预测之后一天的数据</span>
sequence <span class="token operator">=</span> <span class="token number">20</span>

X <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
label <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 选择use_cols作为特征</span>
    X<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">(</span>i<span class="token operator">+</span>sequence<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 选择20天收盘价涨幅</span>
    y<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token operator">+</span>sequence<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>np<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token builtin">len</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>X<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
</code></pre> 
<pre><code>(2406, 20)
</code></pre> 
<pre><code class="prism language-python"><span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
</code></pre> 
<pre><code>2406
</code></pre> 
<h5><a id="_1613"></a>划分数据集</h5> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
</code></pre> 
<pre><code class="prism language-python">X_train<span class="token punctuation">,</span> X_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_test <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>X<span class="token punctuation">,</span>y<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span>random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token builtin">len</span><span class="token punctuation">(</span>X_train<span class="token punctuation">)</span>
</code></pre> 
<pre><code>1924
</code></pre> 
<pre><code class="prism language-python"><span class="token builtin">len</span><span class="token punctuation">(</span>X_test<span class="token punctuation">)</span>
</code></pre> 
<pre><code>482
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">as</span> Data 
torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>&lt;torch._C.Generator at 0x2393bdb43f0&gt;
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># list -&gt; numpy</span>
X_train <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>X_train<span class="token punctuation">)</span>
y_train <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y_train<span class="token punctuation">)</span>
X_test <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span>
y_test <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y_test<span class="token punctuation">)</span>

<span class="token comment"># numpy -&gt; torch</span>
X_train <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>X_train<span class="token punctuation">)</span>
y_train <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>y_train<span class="token punctuation">)</span>
X_test <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span>
y_test <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>y_test<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'X_train size: '</span><span class="token punctuation">,</span> X_train<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'y_train size: '</span><span class="token punctuation">,</span> y_train<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'X_test size: '</span><span class="token punctuation">,</span> X_test<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'y_test size: '</span><span class="token punctuation">,</span> y_test<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>X_train size:  torch.Size([1924, 20, 7])
y_train size:  torch.Size([1924])
X_test size:  torch.Size([482, 20, 7])
y_test size:  torch.Size([482])
</code></pre> 
<h4><a id="font_colorred6_font_1689"></a><font color="red">6 定义网络模型</font></h4> 
<pre><code class="prism language-python"><span class="token comment">#  批处理 batch的大小为32</span>
train_data <span class="token operator">=</span> Data<span class="token punctuation">.</span>TensorDataset<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
test_data <span class="token operator">=</span> Data<span class="token punctuation">.</span>TensorDataset<span class="token punctuation">(</span>X_test<span class="token punctuation">,</span> y_test<span class="token punctuation">)</span>

train_loader <span class="token operator">=</span> Data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>
    dataset<span class="token operator">=</span>train_data<span class="token punctuation">,</span>
    batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>
    shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    num_workers<span class="token operator">=</span><span class="token number">2</span>
<span class="token punctuation">)</span>

test_loader <span class="token operator">=</span> Data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>
    dataset<span class="token operator">=</span>test_data<span class="token punctuation">,</span>
    batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>
    shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    num_workers<span class="token operator">=</span><span class="token number">2</span>
<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">input_size <span class="token operator">=</span> <span class="token number">7</span>
seq_len <span class="token operator">=</span> <span class="token number">20</span>
hidden_size <span class="token operator">=</span> <span class="token number">32</span>
output_size <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F 
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable
<span class="token keyword">class</span> <span class="token class-name">MyNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_size<span class="token operator">=</span>input_size<span class="token punctuation">,</span> hidden_size<span class="token operator">=</span>hidden_size<span class="token punctuation">,</span> output_size<span class="token operator">=</span>output_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MyNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>input_size <span class="token operator">=</span> input_size
        self<span class="token punctuation">.</span>hidden_size <span class="token operator">=</span> hidden_size
        self<span class="token punctuation">.</span>output_size <span class="token operator">=</span> output_size
        self<span class="token punctuation">.</span>lstm <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span>input_size<span class="token operator">=</span>input_size<span class="token punctuation">,</span> hidden_size<span class="token operator">=</span>hidden_size<span class="token punctuation">,</span> batch_first<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>self<span class="token punctuation">.</span>hidden_size<span class="token operator">*</span>seq_len<span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_size<span class="token punctuation">)</span>            
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        out<span class="token punctuation">,</span>_ <span class="token operator">=</span> self<span class="token punctuation">.</span>lstm<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>
        b<span class="token punctuation">,</span> s<span class="token punctuation">,</span> h <span class="token operator">=</span> out<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>out<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>b<span class="token punctuation">,</span> s<span class="token operator">*</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> out 

net <span class="token operator">=</span> MyNet<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>net<span class="token punctuation">)</span>
</code></pre> 
<pre><code>MyNet(
  (lstm): LSTM(7, 32, batch_first=True)
  (fc): Linear(in_features=640, out_features=1, bias=True)
)
</code></pre> 
<h4><a id="font_colorred7_font_1745"></a><font color="red">7 选择损失函数和优化器</font></h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim 
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm

loss_function <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> epoch <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    total_loss <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> _<span class="token punctuation">,</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> label<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> Variable<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        pred <span class="token operator">=</span> net<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        label <span class="token operator">=</span> Variable<span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        label <span class="token operator">=</span> label<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        loss <span class="token operator">=</span> loss_function<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> label<span class="token punctuation">)</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        total_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
    <span class="token keyword">if</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Epoch: '</span><span class="token punctuation">,</span> epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">' loss: '</span><span class="token punctuation">,</span> total_loss<span class="token punctuation">)</span>
</code></pre> 
<pre><code> 10%|████████                                                                         | 10/100 [00:15&lt;02:20,  1.56s/it]

Epoch:  10  loss:  0.39631053362973034


 20%|████████████████▏                                                                | 20/100 [00:30&lt;01:59,  1.49s/it]

Epoch:  20  loss:  0.38432611781172454


 30%|████████████████████████▎                                                        | 30/100 [00:46&lt;01:48,  1.56s/it]

Epoch:  30  loss:  0.3594463015906513


 40%|████████████████████████████████▍                                                | 40/100 [01:02&lt;01:37,  1.62s/it]

Epoch:  40  loss:  0.2304799237754196


 50%|████████████████████████████████████████▌                                        | 50/100 [01:17&lt;01:17,  1.55s/it]

Epoch:  50  loss:  0.19538419507443905


 60%|████████████████████████████████████████████████▌                                | 60/100 [01:33&lt;01:06,  1.66s/it]

Epoch:  60  loss:  0.15910959872417152


 70%|████████████████████████████████████████████████████████▋                        | 70/100 [01:50&lt;00:51,  1.73s/it]

Epoch:  70  loss:  0.10108215303625911


 80%|████████████████████████████████████████████████████████████████▊                | 80/100 [02:07&lt;00:32,  1.63s/it]

Epoch:  80  loss:  0.09773806459270418


 90%|████████████████████████████████████████████████████████████████████████▉        | 90/100 [02:23&lt;00:16,  1.67s/it]

Epoch:  90  loss:  0.06839053201838396


100%|████████████████████████████████████████████████████████████████████████████████| 100/100 [02:41&lt;00:00,  1.62s/it]

Epoch:  100  loss:  0.06617061665747315
</code></pre> 
<h4><a id="font_colorred8_font_1825"></a><font color="red">8 测试</font></h4> 
<pre><code class="prism language-python">pred_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
label_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> _<span class="token punctuation">,</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> label<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>test_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> Variable<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    pred <span class="token operator">=</span> net<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    pred_list<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>pred<span class="token punctuation">.</span>data<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    label_list<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>label<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">pred_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code>[0.4532894492149353,
 0.4373990297317505,
 0.4552455246448517,
 0.3734513521194458,
 0.4417729675769806]
</code></pre> 
<pre><code class="prism language-python"><span class="token builtin">len</span><span class="token punctuation">(</span>pred_list<span class="token punctuation">)</span>
</code></pre> 
<pre><code>482
</code></pre> 
<pre><code class="prism language-python">label_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code>[0.4526440093601085,
 0.4235539693300972,
 0.4670736837074137,
 0.3081553795002458,
 0.5096712136068774]
</code></pre> 
<h4><a id="font_colorred9_font_1883"></a><font color="red">9 可视化</font></h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt  
plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'font.sans-serif'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">u'SimHei'</span><span class="token punctuation">]</span>
plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'axes.unicode_minus'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt 

plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token punctuation">(</span>close_max<span class="token operator">-</span>close_min<span class="token punctuation">)</span><span class="token operator">+</span>close_min <span class="token keyword">for</span> i <span class="token keyword">in</span> pred_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'pred'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token punctuation">(</span>close_max<span class="token operator">-</span>close_min<span class="token punctuation">)</span><span class="token operator">+</span>close_min <span class="token keyword">for</span> i <span class="token keyword">in</span> label_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'real'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Stock Forecast(前50条数据)'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/17/b8/JpMRT0Od_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt 
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token punctuation">(</span>close_max<span class="token operator">-</span>close_min<span class="token punctuation">)</span><span class="token operator">+</span>close_min <span class="token keyword">for</span> i <span class="token keyword">in</span> pred_list<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'pred'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token punctuation">(</span>close_max<span class="token operator">-</span>close_min<span class="token punctuation">)</span><span class="token operator">+</span>close_min <span class="token keyword">for</span> i <span class="token keyword">in</span> label_list<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'real'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Stock Forecast'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/40/dd/4Izxs508_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt 

plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>pred_list<span class="token punctuation">[</span><span class="token number">400</span><span class="token punctuation">:</span><span class="token number">480</span><span class="token punctuation">]</span> <span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'pred'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>label_list<span class="token punctuation">[</span><span class="token number">400</span><span class="token punctuation">:</span><span class="token number">480</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'real'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Stock Forecast（第400条到第480条数据）'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'dataset/some.jpg'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/23/e5/OIAQDNOA_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt 
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>pred_list <span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'pred'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>label_list<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'real'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Stock Forecast(测试集所有数据)'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'dataset/pred_real.jpg'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a7/f6/tamO133s_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt 
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token punctuation">(</span>close_max<span class="token operator">-</span>close_min<span class="token punctuation">)</span><span class="token operator">+</span>close_min <span class="token keyword">for</span> i <span class="token keyword">in</span> pred_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">482</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'pred'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token punctuation">(</span>close_max<span class="token operator">-</span>close_min<span class="token punctuation">)</span><span class="token operator">+</span>close_min <span class="token keyword">for</span> i <span class="token keyword">in</span> label_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">482</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'real'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Stock Forecast(测试集所有数据（还原数据）)'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'dataset/all.jpg'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/33/e9/hpSYDpMi_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="font_colorred10_font_1988"></a><font color="red">10 保存图片</font></h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt 
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token punctuation">(</span>close_max<span class="token operator">-</span>close_min<span class="token punctuation">)</span><span class="token operator">+</span>close_min <span class="token keyword">for</span> i <span class="token keyword">in</span> pred_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">482</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'pred'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Stock Forecast pred'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'dataset/pred.jpg'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/97/9b/EfRl8HGd_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt 
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token punctuation">(</span>close_max<span class="token operator">-</span>close_min<span class="token punctuation">)</span><span class="token operator">+</span>close_min <span class="token keyword">for</span> i <span class="token keyword">in</span> label_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">482</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'real'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Stock Forecast （real）'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'dataset/real.jpg'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/14/a9/XP5eY4SY_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="font_colorred11_font_2026"></a><font color="red">11 计算相似度</font></h4> 
<pre><code class="prism language-python"><span class="token builtin">len</span><span class="token punctuation">(</span>label_list<span class="token punctuation">)</span>
</code></pre> 
<pre><code>482
</code></pre> 
<h5><a id="_2040"></a>欧式距离</h5> 
<pre><code class="prism language-python">sum_all <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>label_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sum_all <span class="token operator">=</span> sum_all <span class="token operator">+</span> <span class="token punctuation">(</span>label_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> pred_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span>
</code></pre> 
<pre><code class="prism language-python">sum_all
</code></pre> 
<pre><code>1.1392427957537818
</code></pre> 
<h5><a id="DTW_2061"></a>DTW</h5> 
<pre><code class="prism language-python">pred_some <span class="token operator">=</span> pred_list<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">]</span>
label_some <span class="token operator">=</span> label_list<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python">pred_some <span class="token operator">=</span> pred_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">482</span><span class="token punctuation">]</span>
label_some <span class="token operator">=</span> label_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">482</span><span class="token punctuation">]</span>
</code></pre> 
<h5><a id="font_colorpinkfont_2075"></a><font color="pink">欧式距离矩阵</font></h5> 
<pre><code class="prism language-python">distances <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>pred_some<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pred_some<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>pred_some<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>label_some<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        distances<span class="token punctuation">[</span>i<span class="token punctuation">,</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>label_some<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">-</span>pred_some<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span> 
</code></pre> 
<pre><code class="prism language-python"><span class="token builtin">len</span><span class="token punctuation">(</span>distances<span class="token punctuation">)</span>
</code></pre> 
<pre><code>482
</code></pre> 
<p>计算两个序列的距离矩阵。横着表示x序列，竖着是y序列。<br> 比如说第0行第0个元素1表示x序列的第0个值和y序列的第0个值的距离（Python的索引从0开始）</p> 
<p>颜色越深表示距离越远</p> 
<h4><a id="font_colorpinkfont_2100"></a><font color="pink">欧式距离矩阵可视化</font></h4> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">distance_cost_plot</span><span class="token punctuation">(</span>distances<span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>distances<span class="token punctuation">,</span> interpolation<span class="token operator">=</span><span class="token string">'nearest'</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'Reds'</span><span class="token punctuation">)</span> 
    plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>invert_yaxis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#倒转y轴，让它与x轴的都从左下角开始</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"X"</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"Y"</span><span class="token punctuation">)</span>
<span class="token comment">#    plt.grid()</span>
    plt<span class="token punctuation">.</span>colorbar<span class="token punctuation">(</span><span class="token punctuation">)</span>
distance_cost_plot<span class="token punctuation">(</span>distances<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/44/ed/52cxCybr_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">x <span class="token operator">=</span> pred_some
y <span class="token operator">=</span> label_some
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 计算一个累积距离矩阵</span>
accumulated_cost <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>pred_some<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>label_some<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
accumulated_cost<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> distances<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python">pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>accumulated_cost<span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>...</th><th>472</th><th>473</th><th>474</th><th>475</th><th>476</th><th>477</th><th>478</th><th>479</th><th>480</th><th>481</th></tr></thead><tbody><tr><th>0</th><td>4.165926e-07</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>...</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><th>1</th><td>0.000000e+00</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>...</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><th>2</th><td>0.000000e+00</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>...</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><th>3</th><td>0.000000e+00</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>...</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><th>4</th><td>0.000000e+00</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>...</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>477</th><td>0.000000e+00</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>...</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><th>478</th><td>0.000000e+00</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>...</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><th>479</th><td>0.000000e+00</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>...</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><th>480</th><td>0.000000e+00</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>...</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><th>481</th><td>0.000000e+00</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>...</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr></tbody></table> 
<p>482 rows × 482 columns</p> 
<pre><code class="prism language-python">distance_cost_plot<span class="token punctuation">(</span>accumulated_cost<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a5/8c/6KGKS3DD_o.png" alt="在这里插入图片描述"></p> 
<p>显然累积距离矩阵的第0行第0列=距离矩阵的第0行第0列=1，我们必须经过起点吧……如果我们一直往右走，那么累积距离距离矩阵</p> 
<pre><code class="prism language-python"><span class="token comment"># 累积距离距离矩阵</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>label_some<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    accumulated_cost<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> distances<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> accumulated_cost<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> 
</code></pre> 
<pre><code class="prism language-python">pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>accumulated_cost<span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>...</th><th>472</th><th>473</th><th>474</th><th>475</th><th>476</th><th>477</th><th>478</th><th>479</th><th>480</th><th>481</th></tr></thead><tbody><tr><th>0</th><td>4.165926e-07</td><td>0.000885</td><td>0.001075</td><td>0.022139</td><td>0.025317</td><td>0.028503</td><td>0.028894</td><td>0.029663</td><td>0.030173</td><td>0.030348</td><td>...</td><td>2.791318</td><td>2.794677</td><td>2.794919</td><td>2.798835</td><td>2.803386</td><td>2.812828</td><td>2.827525</td><td>2.828109</td><td>2.850578</td><td>2.850708</td></tr><tr><th>1</th><td>0.000000e+00</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>2</th><td>0.000000e+00</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>3</th><td>0.000000e+00</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>4</th><td>0.000000e+00</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>477</th><td>0.000000e+00</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>478</th><td>0.000000e+00</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>479</th><td>0.000000e+00</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>480</th><td>0.000000e+00</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>481</th><td>0.000000e+00</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr></tbody></table> 
<p>482 rows × 482 columns</p> 
<pre><code class="prism language-python">distance_cost_plot<span class="token punctuation">(</span>accumulated_cost<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c1/7b/FhbmCHry_o.png" alt="在这里插入图片描述"></p> 
<p>如果我们一直往上走，那么</p> 
<pre><code class="prism language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pred_some<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    accumulated_cost<span class="token punctuation">[</span>i<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> distances<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> accumulated_cost<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>  
</code></pre> 
<pre><code class="prism language-python">pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>accumulated_cost<span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>...</th><th>472</th><th>473</th><th>474</th><th>475</th><th>476</th><th>477</th><th>478</th><th>479</th><th>480</th><th>481</th></tr></thead><tbody><tr><th>0</th><td>4.165926e-07</td><td>0.000885</td><td>0.001075</td><td>0.022139</td><td>0.025317</td><td>0.028503</td><td>0.028894</td><td>0.029663</td><td>0.030173</td><td>0.030348</td><td>...</td><td>2.791318</td><td>2.794677</td><td>2.794919</td><td>2.798835</td><td>2.803386</td><td>2.812828</td><td>2.827525</td><td>2.828109</td><td>2.850578</td><td>2.850708</td></tr><tr><th>1</th><td>2.328260e-04</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>2</th><td>2.395939e-04</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>3</th><td>6.511071e-03</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>4</th><td>6.629250e-03</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>477</th><td>2.676938e+00</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>478</th><td>2.696313e+00</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>479</th><td>2.696541e+00</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>480</th><td>2.709715e+00</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr><tr><th>481</th><td>2.709716e+00</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>...</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td></tr></tbody></table> 
<p>482 rows × 482 columns</p> 
<pre><code class="prism language-python">distance_cost_plot<span class="token punctuation">(</span>accumulated_cost<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/86/8d/jHwY9y4w_o.png" alt="在这里插入图片描述"></p> 
<p>把累积距离矩阵计算完整</p> 
<pre><code class="prism language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pred_some<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>label_some<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        accumulated_cost<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>accumulated_cost<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> accumulated_cost<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">]</span><span class="token punctuation">,</span> accumulated_cost<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> distances<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python">pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>accumulated_cost<span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>...</th><th>472</th><th>473</th><th>474</th><th>475</th><th>476</th><th>477</th><th>478</th><th>479</th><th>480</th><th>481</th></tr></thead><tbody><tr><th>0</th><td>4.165926e-07</td><td>0.000885</td><td>0.001075</td><td>0.022139</td><td>0.025317</td><td>0.028503</td><td>0.028894</td><td>0.029663</td><td>0.030173</td><td>0.030348</td><td>...</td><td>2.791318</td><td>2.794677</td><td>2.794919</td><td>2.798835</td><td>2.803386</td><td>2.812828</td><td>2.827525</td><td>2.828109</td><td>2.850578</td><td>2.850708</td></tr><tr><th>1</th><td>2.328260e-04</td><td>0.000192</td><td>0.001073</td><td>0.017777</td><td>0.023000</td><td>0.024644</td><td>0.025915</td><td>0.026055</td><td>0.027535</td><td>0.027542</td><td>...</td><td>2.784774</td><td>2.790229</td><td>2.790229</td><td>2.792408</td><td>2.799356</td><td>2.805962</td><td>2.817059</td><td>2.817128</td><td>2.844613</td><td>2.844633</td></tr><tr><th>2</th><td>2.395939e-04</td><td>0.001196</td><td>0.000332</td><td>0.021968</td><td>0.020739</td><td>0.024149</td><td>0.024466</td><td>0.025348</td><td>0.025773</td><td>0.026003</td><td>...</td><td>2.757107</td><td>2.760244</td><td>2.760550</td><td>2.764715</td><td>2.769005</td><td>2.778831</td><td>2.794007</td><td>2.794689</td><td>2.816575</td><td>2.816754</td></tr><tr><th>3</th><td>6.511071e-03</td><td>0.002750</td><td>0.009097</td><td>0.004596</td><td>0.023151</td><td>0.021286</td><td>0.031205</td><td>0.027180</td><td>0.035836</td><td>0.030210</td><td>...</td><td>2.759153</td><td>2.776096</td><td>2.764378</td><td>2.760848</td><td>2.782545</td><td>2.769306</td><td>2.771019</td><td>2.774119</td><td>2.826897</td><td>2.821256</td></tr><tr><th>4</th><td>6.629250e-03</td><td>0.003082</td><td>0.003390</td><td>0.021244</td><td>0.009206</td><td>0.011224</td><td>0.012202</td><td>0.012465</td><td>0.013627</td><td>0.013630</td><td>...</td><td>2.710571</td><td>2.715399</td><td>2.715415</td><td>2.718022</td><td>2.724259</td><td>2.731596</td><td>2.743634</td><td>2.743794</td><td>2.769848</td><td>2.769848</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>477</th><td>2.676938e+00</td><td>2.670701</td><td>2.651317</td><td>2.633292</td><td>2.665250</td><td>2.625748</td><td>2.589558</td><td>2.560992</td><td>2.560040</td><td>2.527341</td><td>...</td><td>0.777889</td><td>0.798232</td><td>0.777122</td><td>0.773360</td><td>0.805854</td><td>0.770449</td><td>0.770450</td><td>0.780098</td><td>0.854235</td><td>0.798668</td></tr><tr><th>478</th><td>2.696313e+00</td><td>2.682825</td><td>2.674917</td><td>2.633320</td><td>2.671796</td><td>2.632704</td><td>2.615029</td><td>2.573559</td><td>2.586418</td><td>2.543372</td><td>...</td><td>0.790750</td><td>0.817015</td><td>0.792572</td><td>0.779330</td><td>0.816334</td><td>0.772270</td><td>0.770795</td><td>0.783832</td><td>0.864046</td><td>0.815159</td></tr><tr><th>479</th><td>2.696541e+00</td><td>2.683021</td><td>2.675789</td><td>2.650064</td><td>2.638521</td><td>2.634361</td><td>2.616289</td><td>2.573703</td><td>2.575026</td><td>2.543378</td><td>...</td><td>0.790865</td><td>0.796182</td><td>0.792572</td><td>0.781524</td><td>0.786252</td><td>0.778901</td><td>0.781925</td><td>0.770866</td><td>0.798300</td><td>0.798319</td></tr><tr><th>480</th><td>2.709715e+00</td><td>2.703718</td><td>2.685858</td><td>2.717282</td><td>2.641856</td><td>2.663456</td><td>2.625196</td><td>2.593830</td><td>2.582086</td><td>2.559598</td><td>...</td><td>0.810622</td><td>0.794020</td><td>0.809387</td><td>0.812749</td><td>0.783702</td><td>0.823548</td><td>0.834297</td><td>0.789990</td><td>0.772145</td><td>0.787908</td></tr><tr><th>481</th><td>2.709716e+00</td><td>2.704500</td><td>2.686100</td><td>2.706414</td><td>2.645237</td><td>2.644846</td><td>2.625659</td><td>2.594505</td><td>2.582678</td><td>2.559730</td><td>...</td><td>0.795156</td><td>0.797587</td><td>0.794210</td><td>0.797908</td><td>0.788494</td><td>0.792804</td><td>0.807078</td><td>0.790492</td><td>0.795145</td><td>0.772238</td></tr></tbody></table> 
<p>482 rows × 482 columns</p> 
<pre><code class="prism language-python">distance_cost_plot<span class="token punctuation">(</span>accumulated_cost<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c3/0d/ZO6AI0Fq_o.png" alt="在这里插入图片描述"></p> 
<p>现在，最佳路径已经清晰地显示在了累积距离矩阵之中，就是图中颜色最淡的方块。</p> 
<p>现在，我们只需要通过回溯的方法找回最佳路径就可以了：</p> 
<pre><code class="prism language-python">path <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>label_some<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pred_some<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
i <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pred_some<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span>
j <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>label_some<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span>
<span class="token keyword">while</span> i<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">and</span> j<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> i<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
        j <span class="token operator">=</span> j <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">elif</span> j<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
        i <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> accumulated_cost<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token builtin">min</span><span class="token punctuation">(</span>accumulated_cost<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> accumulated_cost<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">]</span><span class="token punctuation">,</span> accumulated_cost<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            i <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token comment">#来自于左边</span>
        <span class="token keyword">elif</span> accumulated_cost<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token builtin">min</span><span class="token punctuation">(</span>accumulated_cost<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> accumulated_cost<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">]</span><span class="token punctuation">,</span> accumulated_cost<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            j <span class="token operator">=</span> j<span class="token operator">-</span><span class="token number">1</span><span class="token comment">#来自于下边</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            i <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token comment">#来自于左下边</span>
            j<span class="token operator">=</span> j<span class="token operator">-</span> <span class="token number">1</span>
    path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>j<span class="token punctuation">,</span> i<span class="token punctuation">]</span><span class="token punctuation">)</span>
path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">path_x <span class="token operator">=</span> <span class="token punctuation">[</span>point<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> point <span class="token keyword">in</span> path<span class="token punctuation">]</span>
path_y <span class="token operator">=</span> <span class="token punctuation">[</span>point<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> point <span class="token keyword">in</span> path<span class="token punctuation">]</span>
distance_cost_plot<span class="token punctuation">(</span>accumulated_cost<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>path_x<span class="token punctuation">,</span> path_y<span class="token punctuation">)</span>
</code></pre> 
<pre><code>[&lt;matplotlib.lines.Line2D at 0x2393ee7a220&gt;]
</code></pre> 
<p><img src="https://images2.imgbox.com/17/fa/qp7H3ovH_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_3533"></a>图片相似度</h5> 
<pre><code class="prism language-python"><span class="token keyword">from</span> skimage<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> structural_similarity <span class="token keyword">as</span> sk_cpt_ssim
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2

<span class="token keyword">def</span> <span class="token function">mse</span><span class="token punctuation">(</span>imageA<span class="token punctuation">,</span> imageB<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 计算两张图片的MSE指标</span>
    err <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>imageA<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">"float"</span><span class="token punctuation">)</span> <span class="token operator">-</span> imageB<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">"float"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>
    err <span class="token operator">/=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>imageA<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> imageA<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 返回结果，该值越小越好</span>
    <span class="token keyword">return</span> err

<span class="token keyword">def</span> <span class="token function">compare_images</span><span class="token punctuation">(</span>imageA<span class="token punctuation">,</span> imageB<span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 分别计算输入图片的MSE和SSIM指标值的大小</span>
    m <span class="token operator">=</span> mse<span class="token punctuation">(</span>imageA<span class="token punctuation">,</span> imageB<span class="token punctuation">)</span>
    s <span class="token operator">=</span> sk_cpt_ssim<span class="token punctuation">(</span>imageA<span class="token punctuation">,</span> imageB<span class="token punctuation">)</span>

    <span class="token comment"># 创建figure</span>
    fig <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>title<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>suptitle<span class="token punctuation">(</span><span class="token string">"MSE: %.2f, SSIM: %.2f"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>m<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 显示第一张图片</span>
    ax <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imageA<span class="token punctuation">,</span> cmap <span class="token operator">=</span> plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>gray<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">"off"</span><span class="token punctuation">)</span>

    <span class="token comment"># 显示第二张图片</span>
    ax <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imageB<span class="token punctuation">,</span> cmap <span class="token operator">=</span> plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>gray<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">"off"</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>



<span class="token comment"># 读取图片</span>
pred_image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"dataset/pred.jpg"</span><span class="token punctuation">)</span>
real_image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"dataset/real.jpg"</span><span class="token punctuation">)</span>
all_image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'dataset/all.jpg'</span><span class="token punctuation">)</span>
some_image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'dataset/some.jpg'</span><span class="token punctuation">)</span>

<span class="token comment"># 将彩色图转换为灰度图</span>
pred <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>pred_image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
real <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>real_image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
all_image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>all_image<span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
some_image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>some_image<span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>

<span class="token comment"># 初始化figure对象</span>
fig <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token string">"Images"</span><span class="token punctuation">)</span>
<span class="token comment"># images = ("pred", pred), ("real", real),('all',all_image),('some',some_image)</span>
images <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"pred"</span><span class="token punctuation">,</span> pred<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"real"</span><span class="token punctuation">,</span> real<span class="token punctuation">)</span>

<span class="token comment"># 遍历每张图片</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 显示图片</span>
    ax <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">,</span> cmap <span class="token operator">=</span> plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>gray<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">"off"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 比较图片</span>
<span class="token comment"># compare_images(real, real, "real vs real")</span>
compare_images<span class="token punctuation">(</span>real<span class="token punctuation">,</span> pred<span class="token punctuation">,</span> <span class="token string">"real vs pred"</span><span class="token punctuation">)</span>
<span class="token comment"># compare_images(all_image, pred, "real vs pred")</span>
<span class="token comment"># compare_images(some_image,all_image,'some vs all')</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7a/0e/qeE04Xmi_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3e/9a/zWRjkXIN_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/18ebbfe6065c5f815919bf871e7ec447/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">模型压缩：剪枝算法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/852612702f6a85cdb472126e253efb68/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">前端HTML5/HTML&#43;CSS3/CSS学习笔记(六)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>