<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBoot 集成 SpringSecurity 从入门到深入理解 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringBoot 集成 SpringSecurity 从入门到深入理解" />
<meta property="og:description" content="完整的目录 介绍 SpringSecurity简述 SpringSecuritySpringSecurity 的主要功能说明 项目源码入门案例项目工程路径第一步：加载依赖第二步：创建核心的配置类第三步：增加controller第三步：启动程序小结界面跳转说明密码生成说明 重点内容扫盲重要的FilterPasswordEncoder 接口UserDetailsService 接口 深入学习案例基础验证案列第一步：加载依赖第二步：初始化 SQL第三步: 添加配置第四步：添加实体类以及对应的 Mapper第五步：增加 controller 进行访问验证第六步：添加自定义的验证逻辑 验证验证一：异常访问验证二：正常登录验证三：异常登录 基于角色的访问控制项目结构添加菜单和角色实体类以及Mapper 文件调整 MyUserDetailsService 实现添加访问接口修改 Security 配置hasRole 的源码相关说明 验证验证一：使用普通用户登录验证验证二：使用管理员账户登录验证 自定义界面访问添加登录界面修改 Security 的配置 验证登录页面验证 自定义错误页面添加错误页面修改 Security 的配置 验证无访问权限验证 自定义主页添加主页修改 Security 的配置 验证验证跳转主页 remember-me 功能介绍修改 Security 配置修改Login页面创建表结构 验证验证 remember-me 功能 原理分析注解使用@Secured注解@PreAuthorize@PostAuthorize 总结 介绍 SpringSecurity 简述 SpringSecurity Spring Security 是 Spring 应用程序的安全框架，它提供了认证、授权、访问控制等安全性功能。在 Spring Boot 应用程序中使用 Spring Security，可以方便地进行安全性配置。
Spring Security最初是一个独立的项目，名为Acegi Security，于2004年首次发布。Acegi Security是针对Spring框架的安全框架，旨在为Java企业应用程序提供基于认证和授权的安全功能。
2010年，Spring Security成为Spring项目的一部分，并开始在Spring框架的生态系统中广泛应用。随着时间的推移，Spring Security逐渐成为Java企业应用程序中最受欢迎的安全框架之一，用于保护Web应用程序、REST API和基于Spring的微服务架构。
在最新版本的Spring Security 5中，该框架已经得到了大量改进和更新，以支持最新的安全标准和技术，如OAuth 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/fecffc39d720320b2c1173d325d68a9d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-13T16:47:16+08:00" />
<meta property="article:modified_time" content="2023-09-13T16:47:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBoot 集成 SpringSecurity 从入门到深入理解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>完整的目录</h4> 
 <ul><li><ul><li><a href="#_SpringSecurity_1" rel="nofollow">介绍 SpringSecurity</a></li><li><ul><li><a href="#_SpringSecurity_2" rel="nofollow">简述 SpringSecurity</a></li><li><a href="#SpringSecurity__11" rel="nofollow">SpringSecurity 的主要功能说明</a></li></ul> 
   </li><li><a href="#_18" rel="nofollow">项目源码</a></li><li><a href="#_22" rel="nofollow">入门案例</a></li><li><ul><li><a href="#_23" rel="nofollow">项目工程路径</a></li><li><a href="#_26" rel="nofollow">第一步：加载依赖</a></li><li><a href="#_61" rel="nofollow">第二步：创建核心的配置类</a></li><li><a href="#controller_92" rel="nofollow">第三步：增加controller</a></li><li><a href="#_109" rel="nofollow">第三步：启动程序</a></li><li><a href="#_119" rel="nofollow">小结</a></li><li><ul><li><a href="#_120" rel="nofollow">界面跳转说明</a></li><li><a href="#_125" rel="nofollow">密码生成说明</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_145" rel="nofollow">重点内容扫盲</a></li><li><ul><li><a href="#Filter_148" rel="nofollow">重要的Filter</a></li><li><a href="#PasswordEncoder__182" rel="nofollow">PasswordEncoder 接口</a></li><li><a href="#UserDetailsService__234" rel="nofollow">UserDetailsService 接口</a></li></ul> 
   </li><li><a href="#_307" rel="nofollow">深入学习案例</a></li><li><ul><li><a href="#_312" rel="nofollow">基础验证案列</a></li><li><ul><li><a href="#_316" rel="nofollow">第一步：加载依赖</a></li><li><a href="#_SQL_362" rel="nofollow">第二步：初始化 SQL</a></li><li><a href="#__434" rel="nofollow">第三步: 添加配置</a></li><li><a href="#_Mapper_499" rel="nofollow">第四步：添加实体类以及对应的 Mapper</a></li><li><a href="#_controller__521" rel="nofollow">第五步：增加 controller 进行访问验证</a></li><li><a href="#_546" rel="nofollow">第六步：添加自定义的验证逻辑</a></li></ul> 
    </li><li><a href="#_594" rel="nofollow">验证</a></li><li><ul><li><a href="#_595" rel="nofollow">验证一：异常访问</a></li><li><a href="#_598" rel="nofollow">验证二：正常登录</a></li><li><a href="#_601" rel="nofollow">验证三：异常登录</a></li></ul> 
    </li><li><a href="#_605" rel="nofollow">基于角色的访问控制</a></li><li><ul><li><a href="#_608" rel="nofollow">项目结构</a></li><li><a href="#Mapper__612" rel="nofollow">添加菜单和角色实体类以及Mapper 文件</a></li><li><a href="#_MyUserDetailsService__695" rel="nofollow">调整 MyUserDetailsService 实现</a></li><li><a href="#_768" rel="nofollow">添加访问接口</a></li><li><a href="#_Security__784" rel="nofollow">修改 Security 配置</a></li><li><a href="#hasRole__828" rel="nofollow">hasRole 的源码相关说明</a></li></ul> 
    </li><li><a href="#_875" rel="nofollow">验证</a></li><li><ul><li><a href="#_877" rel="nofollow">验证一：使用普通用户登录验证</a></li><li><a href="#_882" rel="nofollow">验证二：使用管理员账户登录验证</a></li></ul> 
    </li><li><a href="#_885" rel="nofollow">自定义界面访问</a></li><li><ul><li><a href="#_888" rel="nofollow">添加登录界面</a></li><li><a href="#_Security__915" rel="nofollow">修改 Security 的配置</a></li></ul> 
    </li><li><a href="#_948" rel="nofollow">验证</a></li><li><ul><li><a href="#_949" rel="nofollow">登录页面验证</a></li></ul> 
    </li><li><a href="#_954" rel="nofollow">自定义错误页面</a></li><li><a href="#_956" rel="nofollow">添加错误页面</a></li><li><ul><li><a href="#_Security__971" rel="nofollow">修改 Security 的配置</a></li></ul> 
    </li><li><a href="#_977" rel="nofollow">验证</a></li><li><ul><li><a href="#_978" rel="nofollow">无访问权限验证</a></li></ul> 
    </li><li><a href="#_982" rel="nofollow">自定义主页</a></li><li><ul><li><a href="#_984" rel="nofollow">添加主页</a></li><li><a href="#_Security__1006" rel="nofollow">修改 Security 的配置</a></li></ul> 
    </li><li><a href="#_1012" rel="nofollow">验证</a></li><li><ul><li><a href="#_1013" rel="nofollow">验证跳转主页</a></li></ul> 
    </li><li><a href="#rememberme__1017" rel="nofollow">remember-me 功能介绍</a></li><li><ul><li><a href="#_Security__1021" rel="nofollow">修改 Security 配置</a></li><li><a href="#Login_1046" rel="nofollow">修改Login页面</a></li><li><a href="#_1051" rel="nofollow">创建表结构</a></li></ul> 
    </li><li><a href="#_1085" rel="nofollow">验证</a></li><li><ul><li><a href="#_rememberme__1086" rel="nofollow">验证 remember-me 功能</a></li></ul> 
    </li><li><a href="#_1089" rel="nofollow">原理分析</a></li><li><a href="#_1173" rel="nofollow">注解使用</a></li><li><ul><li><a href="#Secured_1197" rel="nofollow">@Secured注解</a></li><li><a href="#PreAuthorize_1216" rel="nofollow">@PreAuthorize</a></li><li><a href="#PostAuthorize_1237" rel="nofollow">@PostAuthorize</a></li></ul> 
    </li><li><a href="#_1254" rel="nofollow">总结</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_SpringSecurity_1"></a>介绍 SpringSecurity</h3> 
<h4><a id="_SpringSecurity_2"></a>简述 SpringSecurity</h4> 
<p>Spring Security 是 Spring 应用程序的安全框架，它提供了认证、授权、访问控制等安全性功能。在 Spring Boot 应用程序中使用 Spring Security，可以方便地进行安全性配置。</p> 
<p>Spring Security最初是一个独立的项目，名为Acegi Security，于2004年首次发布。Acegi Security是针对Spring框架的安全框架，旨在为Java企业应用程序提供基于认证和授权的安全功能。</p> 
<p>2010年，Spring Security成为Spring项目的一部分，并开始在Spring框架的生态系统中广泛应用。随着时间的推移，Spring Security逐渐成为Java企业应用程序中最受欢迎的安全框架之一，用于保护Web应用程序、REST API和基于Spring的微服务架构。</p> 
<p>在最新版本的Spring Security 5中，该框架已经得到了大量改进和更新，以支持最新的安全标准和技术，如OAuth 2.0、OpenID Connect和WebFlux。</p> 
<h4><a id="SpringSecurity__11"></a>SpringSecurity 的主要功能说明</h4> 
<p>一般Web应用关于安全方面的两个主要区域是“认证”和“授权”（或者访问控制）。</p> 
<ul><li>认证：验证当前访问系统的是不是本系统的用户，并且要确认具体是哪个用户。<code>通俗的说就是系统认为用户是否能登录。</code></li><li>授权：经过认证后判断当前用户是否有权限进行某个操作。在一个系统中，不同用户所具有的权限是不同的。比如对某一个文件来说，有的用户只能进行读取，而有的用户可以进行修改。<code>通俗点讲就是系统判断用户是否有权限去做某些事情</code></li></ul> 
<p>而<code>认证和授权</code>也是 SpringSecurity 作为安全框架的核心功能。</p> 
<h3><a id="_18"></a>项目源码</h3> 
<blockquote> 
 <p>本文的项目地址：<a href="https://github.com/Wayfreem/spring-boot-demo/tree/main/boot-rbac-security">点击这里查看项目源码</a></p> 
</blockquote> 
<h3><a id="_22"></a>入门案例</h3> 
<h4><a id="_23"></a>项目工程路径</h4> 
<p>首先，我们创建一个 SpringBoot 项目，创建项目应该来说是比较简单的，这里就略过了。下面说下简单的搭建，那就接着向下看，最后的项目工程路径是这样子的：<br> <img src="https://images2.imgbox.com/62/1d/HJOWshmb_o.png" alt="入门工程项目结构"></p> 
<h4><a id="_26"></a>第一步：加载依赖</h4> 
<p>这里主要是看下 POM 文件引入哪些依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.18.26<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="_61"></a>第二步：创建核心的配置类</h4> 
<p><code>WebSecurityConfigurerAdapter</code> 类是 Spring Security 的核心配置类，相关的权限过滤，访问地址等等都是通过这里来配置的。使用Spring Security 就离不开这个类的实现。现在呢，我们就先有一个眼熟，后面我们会一点点的深入去看是如何整合的。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">HttpSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableWebSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">WebSecurityConfigurerAdapter</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * WebSecurityConfigurerAdapter就是Security的核心配置类，一般我们要用Security都会涉及到这个类，一般就是继承这个类，重写方法。
 *
 * @Author wuq
 * @Date 2021-7-16
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 表单登录</span>
        http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token comment">// 启用默认登录界面</span>
                <span class="token punctuation">.</span><span class="token function">failureUrl</span><span class="token punctuation">(</span><span class="token string">"/login?fail"</span><span class="token punctuation">)</span>     <span class="token comment">// 登录失败返回 Url</span>
                <span class="token punctuation">.</span><span class="token function">defaultSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/index"</span><span class="token punctuation">)</span>  <span class="token comment">// 登录成功跳转 URL，他会自动去根路径static文件夹下寻找login.html</span>
                <span class="token punctuation">.</span><span class="token function">failureForwardUrl</span><span class="token punctuation">(</span><span class="token string">"/fail"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// 登录页面全部权限可以访问</span>

        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="controller_92"></a>第三步：增加controller</h4> 
<p>我这里增加<code>controller</code>是为了方便于看到跳转的效果<br> **</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"index"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="_109"></a>第三步：启动程序</h4> 
<p>在启动程序的时候，会发现控制台中输出了这么串密码，<code>每次启动程序的时候，这里的密码都是不一样的</code><br> <img src="https://images2.imgbox.com/2e/42/Mt0BMa6F_o.png" alt="启动时会出现一串密码"><br> 访问 <code>localhost:8080/index</code>，这里访问的时候会自动跳转到下面的登录页面，这个并不是我们自己设置的登录页，而是 Spring Security 自己带有的登录界面，输入用户名 <code>user</code> (下面会介绍是怎么来的) 以及上面的密码串，就可以登录了<br> <img src="https://images2.imgbox.com/2f/40/OUDrqVCF_o.png" alt="登录页面"><br> 登录成功之后就会跳转到下面的页面了<br> <img src="https://images2.imgbox.com/47/da/4qO0CHZC_o.png" alt="登录之后跳转到index"><br> 当我们访问 <code>localhost:8080/logout </code> 就会出现下面的界面，这个页面也是 Spring Security 自带的界面<br> <img src="https://images2.imgbox.com/1c/9a/LucY0gNA_o.png" alt="退出登录"></p> 
<h4><a id="_119"></a>小结</h4> 
<h5><a id="_120"></a>界面跳转说明</h5> 
<p>由于我们在 <code>WebSecurityConfig</code> 配置了相关的界面跳转路径，所以就会实现登录之后，自动跳转到指定的页面上面。</p> 
<p>通过上面的界面跳转就会发现，我们可以通过简单的配置就能实现请求的拦截以及，登录之后页面跳转了。</p> 
<h5><a id="_125"></a>密码生成说明</h5> 
<p>在启动程序的时候会发现有这么一串密码出来，那他是怎么生成的呢？</p> 
<pre><code class="prism language-shell"><span class="token number">2023</span>-09-12 <span class="token number">13</span>:57:01.237  INFO <span class="token number">9228</span> --- <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> .s.s.UserDetailsServiceAutoConfiguration <span class="token builtin class-name">:</span> 

Using generated security password: 8026a963-4e4d-4fa2-b988-b28dcf264c33
</code></pre> 
<p>这里我们看下上面的控制台打印，会看到有一个类 <code>UserDetailsServiceAutoConfiguration</code> ，的确输出的位置就是这里，这个类是自动化配置用户相关的信息的。我们访问下这个自动装配的类<br> <img src="https://images2.imgbox.com/d7/f1/hk660RIK_o.png" alt="源码位置"><br> 我们就继续看下是怎么调用的，通过源码可以看到这里是在生成 <code>InMemoryUserDetailsManager</code> bean 的时候会去调用，并且这里使用了 <code>@ConditionalOnMissingBean</code> 注解<br> <img src="https://images2.imgbox.com/e5/ca/2dt1w2RW_o.png" alt="调用路径"><br> 然后在这里我们看到这里是有一个 <code>User</code> 类，我们就去看下这个<code>User</code> 类<br> <img src="https://images2.imgbox.com/eb/86/gj9NkTtk_o.png" alt="User 类"><br> <img src="https://images2.imgbox.com/c2/36/mfCl8zLy_o.png" alt="设置密码"></p> 
<p>看到这里，就应该清楚了这个密码是怎么生成了的，并且也知道了这个还可以去配置对应的用户名和密码：</p> 
<pre><code class="prism language-properties">spring.security.user.name=admin
spring.security.user.password=123456
</code></pre> 
<h3><a id="_145"></a>重点内容扫盲</h3> 
<p>对于接下来需要做的深入学习之前，我们先对两块的知识点扫盲一下</p> 
<h4><a id="Filter_148"></a>重要的Filter</h4> 
<p><code>Spring Security</code>采用责任链的设计模式，它有一条很长的过滤器链。通过不同的过滤器处理相应的业务流程，如登录认证、权限过滤等。</p> 
<ol><li> <p><code>org.springframework.security.web.context.SecurityContextPersistenceFilter</code>：SecurityContextPersistenceFilter 主要是使用 SecurityContextRepository 在session中保存或更新一个SecurityContext，并将 SecurityContext 给以后的过滤器使用，来为后续filter建立所需的上下文。SecurityContext 中存储了当前用户的认证以及权限信息。</p> </li><li> <p><code>org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter</code>：此过滤器用于集成SecurityContext到Spring异步执行机制中的 WebAsyncManager</p> </li><li> <p><code>org.springframework.security.web.header.HeaderWriterFilter</code>：向请求的Header中添加相应的信息,可在http标签内部使用security:headers来控制</p> </li><li> <p><code>org.springframework.security.web.csrf.CsrfFilter</code>：csrf又称跨域请求伪造，SpringSecurity会对所有post请求验证是否包含系统生成的csrf的token信息，如果不包含，则报错。起到防止csrf攻击的效果。</p> </li><li> <p><code>org.springframework.security.web.authentication.logout.LogoutFilter</code>：匹配 URL为/logout的请求，实现用户退出,清除认证信息。</p> </li><li> <p><code>org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter</code>：认证操作全靠这个过滤器，默认匹配URL为/login且必须为POST请求。</p> </li><li> <p><code>org.springframework.security.web.authentication.ui.DefaultLoginPageGeneratingFilter</code>：如果没有在配置文件中指定认证页面，则由该过滤器生成一个默认认证页面。</p> </li><li> <p><code>org.springframework.security.web.authentication.ui.DefaultLogoutPageGeneratingFilter</code>：由此过滤器可以生产一个默认的退出登录页面</p> </li><li> <p><code>org.springframework.security.web.authentication.www.BasicAuthenticationFilter</code>：此过滤器会自动解析HTTP请求中头部名字为Authentication，且以Basic开头的头信息。</p> </li><li> <p><code>org.springframework.security.web.savedrequest.RequestCacheAwareFilter</code>：通过HttpSessionRequestCache内部维护了一个RequestCache，用于缓存HttpServletRequest</p> </li><li> <p><code>org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter</code>：针对ServletRequest进行了一次包装，使得request具有更加丰富的API</p> </li><li> <p><code>org.springframework.security.web.authentication.AnonymousAuthenticationFilter</code>：当SecurityContextHolder中认证信息为空,则会创建一个匿名用户存入到SecurityContextHolder中。<br> spring security为了兼容未登录的访问，也走了一套认证流程，只不过是一个匿名的身份。</p> </li><li> <p><code>org.springframework.security.web.session.SessionManagementFilter</code>：SecurityContextRepository限制同一用户开启多个会话的数量</p> </li><li> <p><code>org.springframework.security.web.access.ExceptionTranslationFilter</code>：异常转换过滤器位于整个springSecurityFilterChain的后方，用来转换整个链路中出现的异常</p> </li><li> <p><code>org.springframework.security.web.access.intercept.FilterSecurityInterceptor</code>：获取所配置资源访问的授权信息，根据SecurityContextHolder中存储的用户信息来决定其是否有权限。</p> </li></ol> 
<h4><a id="PasswordEncoder__182"></a>PasswordEncoder 接口</h4> 
<p>关于 <code>PasswordEncoder</code> 接口，<code>PasswordEncoder</code> 主要负责的就是密码和 主题信息业务类返回的密码进行比对的时候，所要使用的加密方式。</p> 
<pre><code class="prism language-java"><span class="token comment">// 表示把参数按照特定的解析规则进行解析</span>
<span class="token class-name">String</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> rawPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 表示验证从存储中获取的编码密码与编码后提交的原始密码是否匹配。如果密码匹配，则返回 true；如果不匹配，则返回 false。第一个参数表示需要被解析的密码。第二个参数表示存储的密码。</span>
<span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> rawPassword<span class="token punctuation">,</span> <span class="token class-name">String</span> encodedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 表示如果解析的密码能够再次进行解析且达到更安全的结果则返回 true，否则返回false。默认返回 false。</span>
<span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">upgradeEncoding</span><span class="token punctuation">(</span><span class="token class-name">String</span> encodedPassword<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> 
<p>接着，我们看下对应的接口实现类<br> <img src="https://images2.imgbox.com/e0/c3/Fu2hZPnw_o.png" alt="PasswordEncoder 实现类"><br> 我们这里就主要介绍下 <code>BCryptPasswordEncoder</code> 密码解析器，这个也是官方推荐使用的，</p> 
<p><code>BCryptPasswordEncoder</code> 是 Spring Security 框架提供的一种密码加密方式。它使用 bcrypt 算法对密码进行加密，该算法是一种非常安全可靠的密码加密算法。</p> 
<p>使用 BCryptPasswordEncoder 加密用户的密码时，首先会生成一个随机“盐”（salt），并将盐值和原始密码一同进行加密。因为每个用户的盐值都是随机生成的，<code>即使两个用户的密码相同，加密后的结果也是不同的</code>，这样大大增加了密码破解的难度。</p> 
<blockquote> 
 <p>举一个实际的例子：密码是 <code>123456</code> 加密后成了 a 存到了数据库，这时候登录前端传的还是 <code>123456</code> 密码，然后进行加密，加密后的密文会发现根本不是a，是b，但是a和b两个密文通过加密算法提供的对比方法，在对比的时候是相等的。</p> 
</blockquote> 
<p><strong>具体实例</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>bcrypt<span class="token punctuation">.</span></span><span class="token class-name">BCryptPasswordEncoder</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BCryptTest</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BCryptPasswordEncoder</span> bCryptPasswordEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 对密码进行加密</span>
        <span class="token class-name">String</span> pwd <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 输出加密之后的字符串</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"加密之后数据：\t"</span><span class="token operator">+</span>pwd<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 使用 bCryptPasswordEncoder 的匹对方法</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">,</span> pwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 打印比较结果</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"比较结果：\t"</span><span class="token operator">+</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>控制台输出</p> 
<pre><code class="prism language-console">加密之后数据：	$2a$10$n.U/yTVF8c9mjMsPUv0fruekmbvfxAhZhcq0ymOWa/qMwr3P7LxQa
比较结果：	true
</code></pre> 
<p>对于 <code>BCryptPasswordEncoder</code> 的使用，在实际项目上面，我们是会将用户的密码使用 <code>BCrypt</code> 加密之后保存到数据库中，然后登录的时候会将明文的密码加密之后与数据库中的密文进行对比。</p> 
<h4><a id="UserDetailsService__234"></a>UserDetailsService 接口</h4> 
<p>在上面介绍密码是如何生成的时候，有讲到 <code>UserDetailsServiceAutoConfiguration</code> 类，在上面的注解上面就有出现过他的身影。通过这里的 <code>@ConditionalOnMissingBean</code> 可以看出来，当我们没有自己的登录逻辑时（就像上面的入门示例一样），就会默认的走到这个地方来。<br> <img src="https://images2.imgbox.com/ee/a8/XE963C7d_o.png" alt="UserDetailsServiceAutoConfiguration"><br> 对于这个接口呢，我感觉是需要重点需要了解的，这个是涉及到我们登录的时候校验用的。<code>也就是说 Spring Security 就是通过这个来校验登录用户信息的。</code> 我们具体应该怎么写代码呢？这由于他是一个接口，我们实现这个接口，然后写入我们自己的逻辑就好，对应的源码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>对于这个<code>loadUserByUsername</code> 具体的操作有点儿奇怪，我们这个先看整个验证流程，<mark>这里需要特别说明下：</mark></p> 
<blockquote> 
 <p>第一步：我们根据 username 查询数据库对应的用户是否存在。<br> 第二步：将数据库中查询的用户信息（账号+密码）封装到 UserDetail 对象中，作为方法的返回值。<br> 第三步，将第二步中数据库中的密码与前端出入的明文密码加密之后对比，验证身份。</p> 
</blockquote> 
<p><code>UserDetailsService 中</code>的 <code>loadUserByUsername</code> 就做的事情是第二步。我们通常的情况下，是直接判断用户名和密码，看看是否能登录成功，这里和我们自己写的登录逻辑并不一样。</p> 
<p>用户示例</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>authority<span class="token punctuation">.</span></span><span class="token class-name">AuthorityUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetailsService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UsernameNotFoundException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span>
            <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.根据username查询数据库，判断用户名是否存在</span>
       
        <span class="token comment">// 2.将数据库当中查出来的username和pwd封装到user对象当中返回 第三个参数表示权限</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> pwd<span class="token punctuation">,</span>
                <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span><span class="token string">"admin,"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>UserDetail</strong><br> 在上面出现了 <code>UserDetail</code> 以及一个 <code>User</code>类这里就再说明下他们是啥，<code>UserDetail</code> 是一个接口，具体的源码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetails</span> <span class="token keyword">extends</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 表示获取登录用户所有权限</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 表示获取密码</span>
    <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 表示获取用户名</span>
    <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 表示判断账户是否过期</span>
    <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 表示判断账户是否被锁定</span>
    <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 表示凭证{密码}是否过期</span>
    <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 表示当前用户是否可用</span>
    <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在Spring Security 中有一个 <code>User</code> (不是上面文章中 SecurityProperties 的内部类 User ) 作为 <code>UserDetails</code> 实现，在项目上面是新建一个类实现这个接口或者直接使用这个 <code>User</code> 都是可以的：<br> <img src="https://images2.imgbox.com/68/5f/ojLI2JLE_o.png" alt="User类"><br> 具体的验证调用验证的逻辑如下，这里是先将一部分源码贴出来给大伙看下，知道是怎么调用的，后面会通过示例讲到<br> <img src="https://images2.imgbox.com/04/e4/4rXZpwTM_o.png" alt="调用验证"></p> 
<h3><a id="_307"></a>深入学习案例</h3> 
<p>这里呢，我们需要深入学习下 Spring Security 的登录验证了，我们先看下是怎么实现web 登录校验</p> 
<p>先通过一个实际的例子来混个脸熟，这里呢，我把对应的源码放入到了这里：<a href="https://github.com/Wayfreem/spring-boot-demo/tree/main/boot-rbac-security">Github 项目工程地址点击这里</a></p> 
<h4><a id="_312"></a>基础验证案列</h4> 
<p>下面最后搭建的工程项目接口是下面这样子的：<br> <img src="https://images2.imgbox.com/18/43/GYwakKaz_o.png" alt="项目工程结构"></p> 
<h5><a id="_316"></a>第一步：加载依赖</h5> 
<p>我们这里使用 MybatisPlus 作为持久化框架，简化我们的查询。另外呢，这里需要注意的是mybatis-plus在springboot并没有版本管理，所以我们需要指定mybatis-plus版本，不然就报错。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.18.26<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="_SQL_362"></a>第二步：初始化 SQL</h5> 
<p>初始化 SQL，这里我是用 MySQL，在虚拟机上面搭建的 docker 容器，如果是需要搭建的话，可以看下我之前写这个文章：<a href="https://blog.csdn.net/qq_18948359/article/details/125486934?spm=1001.2014.3001.5501">docker 中安装 MySQL 以及使用</a></p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> users
<span class="token punctuation">(</span>
    id       <span class="token keyword">bigint</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    username <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">unique</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    password <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 密码 123456 使用了BCrypt加密</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> users
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$ZglYem2Zs8E4ETbLwaiA4OjXaTZX9w8wJ7x8LZdpGisdtI9VlIfvO'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 密码 123456</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> users
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$ZglYem2Zs8E4ETbLwaiA4OjXaTZX9w8wJ7x8LZdpGisdtI9VlIfvO'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> role
<span class="token punctuation">(</span>
    id   <span class="token keyword">bigint</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> role
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'管理员'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> role
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'普通用户'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> role_user
<span class="token punctuation">(</span>
    uid <span class="token keyword">bigint</span><span class="token punctuation">,</span>
    rid <span class="token keyword">bigint</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> role_user
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> role_user
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> menu
<span class="token punctuation">(</span>
    id         <span class="token keyword">bigint</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    name       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    url        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    parentid   <span class="token keyword">bigint</span><span class="token punctuation">,</span>
    permission <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> menu
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'系统管理'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'menu:system'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> menu
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'用户管理'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'menu:user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> role_menu
<span class="token punctuation">(</span>
    mid <span class="token keyword">bigint</span><span class="token punctuation">,</span>
    rid <span class="token keyword">bigint</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> role_menu
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> role_menu
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> role_menu
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>persistent_logins<span class="token punctuation">`</span></span>
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span>  <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>series<span class="token punctuation">`</span></span>    <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>token<span class="token punctuation">`</span></span>     <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>last_used<span class="token punctuation">`</span></span> <span class="token keyword">TIMESTAMP</span>   <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>series<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="__434"></a>第三步: 添加配置</h5> 
<p><strong>配置文件 application.yml</strong></p> 
<pre><code class="prism language-yml"><span class="token comment"># DataSource Config</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.152.129<span class="token punctuation">:</span>3306/study<span class="token punctuation">?</span>serverTimezone=GMT%2B8<span class="token important">&amp;useUnicode=true&amp;characterEncoding=UTF8</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>

<span class="token comment"># 日志打印</span>
<span class="token comment"># 日志打印</span>
<span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>
    <span class="token key atrule">log-impl</span><span class="token punctuation">:</span> org.apache.ibatis.logging.stdout.StdOutImpl
</code></pre> 
<p><strong>Spring Security 配置</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">HttpSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">WebSecurityConfigurerAdapter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>bcrypt<span class="token punctuation">.</span></span><span class="token class-name">BCryptPasswordEncoder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>password<span class="token punctuation">.</span></span><span class="token class-name">PasswordEncoder</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>


    <span class="token comment">// 注入 PasswordEncoder 类到 spring 容器中</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//  表单登录</span>
        http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 表单登录</span>
                <span class="token punctuation">.</span><span class="token function">defaultSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/index"</span><span class="token punctuation">)</span>  <span class="token comment">//  登录成功之后跳转到哪个 url</span>
                <span class="token punctuation">.</span><span class="token function">failureForwardUrl</span><span class="token punctuation">(</span><span class="token string">"/fail"</span><span class="token punctuation">)</span>   <span class="token comment">//  登录失败之后跳转到哪个 url</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 认证配置</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 任何请求</span>
                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 都需要身份验证</span>

        <span class="token comment">// 关闭 csrf</span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>Mapper 的扫码注解</strong><br> 由于我们使用了 mybatis plus 所以我们需要给 mapper 添加一个扫码的注解，在启动类上面添加就好</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">"com.demo.security.mapper"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityApplication</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SecurityApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_Mapper_499"></a>第四步：添加实体类以及对应的 Mapper</h5> 
<p>User 实体类以及对应的 Mapper，这个就是我们的用户，等下验证的时候，就是会去查询这个User 表中的数据</p> 
<p><strong>Users类</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Users</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>UsersMapper</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">BaseMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>security<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Users</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UsersMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Users</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_controller__521"></a>第五步：增加 controller 进行访问验证</h5> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ResponseBody</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IndexController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1111111111111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"fail"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"fail"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_546"></a>第六步：添加自定义的验证逻辑</h5> 
<p>这个验证类的实现比较重要，这里也需要重点啰嗦下，上面在知识点扫盲中有讲到 <code>UserDetailsService </code> 这个接口，这个类就主要做了两件事请：</p> 
<ul><li>第一：根据前端传入的用户名去查询数据库中是否存在对应的账户</li><li>第二：将数据库中查询到的用户，放入到 User 对象中返回</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">QueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>security<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Users</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>security<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">UsersMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">GrantedAuthority</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>authority<span class="token punctuation">.</span></span><span class="token class-name">AuthorityUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetailsService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UsernameNotFoundException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>


<span class="token comment">/**
 * 根据账号查询用户密码，顺便判断账户是否存在。
 * 将从数据库查询出来的账号密码，放到 User 对象当中并返回。
 *
 * UserDetailsService 接口：主要作用就是返回主体，并且主体当中会携带授权（授权这个权可以是菜单权限，也可以是角色权限）。
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUserDetailsService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UsersMapper</span> usersMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Users</span><span class="token punctuation">&gt;</span></span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Users</span> users <span class="token operator">=</span> usersMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>users <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">"用户名不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里就是在构建权限，这里的权限可以是菜单权限也可以是角色权限</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> auths <span class="token operator">=</span> <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span><span class="token string">"role"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> users<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> auths<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_594"></a>验证</h4> 
<h5><a id="_595"></a>验证一：异常访问</h5> 
<p>直接访问 <code>localhost:8080/index</code> 会发现访问的时候就会自动跳转到 <code>localhost:8080/login</code> 地址上面去，这里是因为没有权限就无法访问</p> 
<h5><a id="_598"></a>验证二：正常登录</h5> 
<p>访问 <code>localhost:8080/login</code> ，输入用户名<code>admin</code> 和密码 <code>123456</code>，就会进入到下面页面<br> <img src="https://images2.imgbox.com/cb/08/W4DxyJLb_o.png" alt="登录成功"></p> 
<h5><a id="_601"></a>验证三：异常登录</h5> 
<p>访问 <code>localhost:8080/login</code> ，输入用户名<code>admin</code> 然后输入错误的密码，再次登录<br> <img src="https://images2.imgbox.com/bf/29/UhdWKF9O_o.png" alt="登录失败调整"></p> 
<h4><a id="_605"></a>基于角色的访问控制</h4> 
<p>前面我们已经添加了一个用户实体类，现在我们来继续增加角色和菜单相应的实体类</p> 
<h5><a id="_608"></a>项目结构</h5> 
<p>我们这个地方修改之后的项目工程结构如下<br> <img src="https://images2.imgbox.com/bd/83/ZMKgjf3k_o.png" alt="项目结构"></p> 
<h5><a id="Mapper__612"></a>添加菜单和角色实体类以及Mapper 文件</h5> 
<p><strong>Menu类</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Menu</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> parentId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> permission<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>Role类</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Role</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>对应的 Mapper 文件以及 xml 查询</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>security<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Menu</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>security<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Role</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author wuq
 * @Time 2023-9-6 17:04
 * @Description
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserInfoMapper</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 根据用户 Id 查询用户角色
     *
     * @param userId
     * @return
     */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectRoleByUserId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 根据用户 Id 查询菜单
     *
     * @param userId
     * @return
     */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Menu</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectMenuByUserId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">mapper</span> <span class="token name">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.wq.security.mapper.UserInfoMapper<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--根据用户 Id 查询角色信息--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectRoleByUserId<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.wq.security.entity.Role<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        SELECT r.id,
               r.NAME
        FROM role r
                 INNER JOIN role_user ru ON ru.rid = r.id
        WHERE ru.uid = #{0}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--根据用户 Id 查询权限信息--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectMenuByUserId<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.wq.security.entity.Menu<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        SELECT m.id,
               m.NAME,
               m.url,
               m.parentid,
               m.permission
        FROM menu m
                 INNER JOIN role_menu rm ON m.id = rm.mid
                 INNER JOIN role r ON r.id = rm.rid
                 INNER JOIN role_user ru ON r.id = ru.rid
        WHERE ru.uid = #{0}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="_MyUserDetailsService__695"></a>调整 MyUserDetailsService 实现</h5> 
<p>这里呢，我们将上面的源码修改下，增加权限相关的查询，前面是写死了权限，我们现在是将权限信息从数据库中查询出来再返回，按照下面的源码看，权限是封装到了 <code>List&lt;GrantedAuthority&gt;</code> 集合中。</p> 
<blockquote> 
 <p><code>注意</code>：在实际开发当中，我们可能涉及不到某些接口必须用哪个角色才能访问的场景，而只是利用角色来分配菜单，然后给用户再分配角色。<br> 如果要是这样的话，我们只需要根据用户id来关联查询角色表，再根据拥有的角色查询出来所拥有的菜单权限即可。就不需要像下面一样，还查询出来角色，把角色也放到了List当中。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">QueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>security<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Menu</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>security<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Role</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>security<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Users</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>security<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">UserInfoMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>security<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">UsersMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">GrantedAuthority</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>authority<span class="token punctuation">.</span></span><span class="token class-name">SimpleGrantedAuthority</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetailsService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UsernameNotFoundException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>


<span class="token comment">/**
 * 根据账号查询用户密码，顺便判断账户是否存在。
 * 将从数据库查询出来的账号密码，放到 User 对象当中并返回。
 *
 * UserDetailsService 接口：主要作用就是返回主体，并且主体当中会携带授权（授权这个权可以是菜单权限，也可以是角色权限）。
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUserDetailsService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UsersMapper</span> usersMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserInfoMapper</span> userInfoMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Users</span><span class="token punctuation">&gt;</span></span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Users</span> users <span class="token operator">=</span> usersMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>users <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">"用户名不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取用户角色、菜单列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> userInfoMapper<span class="token punctuation">.</span><span class="token function">selectRoleByUserId</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Menu</span><span class="token punctuation">&gt;</span></span> menus <span class="token operator">=</span> userInfoMapper<span class="token punctuation">.</span><span class="token function">selectMenuByUserId</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 声明一个集合List&lt;GrantedAuthority&gt;, 将角色和菜单权限都加入进去</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> grantedAuthorityList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 处理角色</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Role</span> role<span class="token operator">:</span>roles<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 这个地方品拼接的 "ROLE_" 不能删除</span>
            <span class="token class-name">SimpleGrantedAuthority</span> simpleGrantedAuthority <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span><span class="token string">"ROLE_"</span> <span class="token operator">+</span> role<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            grantedAuthorityList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>simpleGrantedAuthority<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 处理权限</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Menu</span> menu<span class="token operator">:</span>menus<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            grantedAuthorityList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span>menu<span class="token punctuation">.</span><span class="token function">getPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> users<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> grantedAuthorityList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>另外这里需要注意下，在权限拼接的时候 <code>ROLE_</code> 不能删除，这个后面会讲到</p> 
<pre><code class="prism language-java"><span class="token class-name">SimpleGrantedAuthority</span> simpleGrantedAuthority <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span><span class="token string">"ROLE_"</span> <span class="token operator">+</span> role<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_768"></a>添加访问接口</h5> 
<p><strong>IndexController.java</strong> 中增加下面内容</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"findAll"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">"findAll"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"find"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">"find"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_Security__784"></a>修改 Security 配置</h5> 
<p>下面是增加了</p> 
<ul><li><code>.antMatchers("/findAll").hasRole("管理员")</code> 需要管理员权限才能访问</li><li><code>.antMatchers("/find").hasAuthority("menu:user")</code> 需要用户具备 <code>menu:user</code> 这个接口的许可，才可以访问，这里的许可就是指的是菜单中的 permission 字段，如果是权限是按钮级别的控制，那么对应的接口就需要有一个唯一的 permission 许可</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">HttpSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">WebSecurityConfigurerAdapter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>bcrypt<span class="token punctuation">.</span></span><span class="token class-name">BCryptPasswordEncoder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>password<span class="token punctuation">.</span></span><span class="token class-name">PasswordEncoder</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>


    <span class="token comment">// 注入 PasswordEncoder 类到 spring 容器中</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 表单登录</span>
        http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//  登录成功之后跳转到哪个 url</span>
                <span class="token punctuation">.</span><span class="token function">defaultSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/index"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//  登录失败之后跳转到哪个 url</span>
                <span class="token punctuation">.</span><span class="token function">failureForwardUrl</span><span class="token punctuation">(</span><span class="token string">"/fail"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 身份验证</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// // 需要用户带有管理员角色才可以访问/findAll接口</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/findAll"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"管理员"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/find"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"管理员"</span><span class="token punctuation">)</span>
                <span class="token comment">// 需要用户具备menu:user这个接口的许可，才可以访问</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/find"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasAuthority</span><span class="token punctuation">(</span><span class="token string">"menu:user"</span><span class="token punctuation">)</span>
                <span class="token comment">// 任何请求都需要认证</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关闭 csrf</span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="hasRole__828"></a>hasRole 的源码相关说明</h5> 
<p>通过编译器，我们点击进去看 <code>hasRole</code>的源码时，会找到 <code>ExpressionUrlAuthorizationConfigurer</code> 这个类，先看下 <code>hasRole()</code> 最后的校验逻辑，下面都出现这个 <code>rolePrefix</code> 的前缀</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">hasAnyRole</span><span class="token punctuation">(</span><span class="token class-name">String</span> rolePrefix<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> anyAuthorities <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">arrayToDelimitedString</span><span class="token punctuation">(</span>authorities<span class="token punctuation">,</span> <span class="token string">"','"</span> <span class="token operator">+</span> rolePrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"hasAnyRole('"</span> <span class="token operator">+</span> rolePrefix <span class="token operator">+</span> anyAuthorities <span class="token operator">+</span> <span class="token string">"')"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token class-name">String</span> rolePrefix<span class="token punctuation">,</span> <span class="token class-name">String</span> role<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>role<span class="token punctuation">,</span> <span class="token string">"role cannot be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>rolePrefix<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>role<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>rolePrefix<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">"role should not start with '"</span> <span class="token operator">+</span> rolePrefix <span class="token operator">+</span> <span class="token string">"' since it is automatically inserted. Got '"</span> <span class="token operator">+</span> role <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"hasRole('"</span> <span class="token operator">+</span> rolePrefix <span class="token operator">+</span> role <span class="token operator">+</span> <span class="token string">"')"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>那我们就全局搜索下吧，看下这个是怎么来的，看到下面就应该知道了，如果没有特殊配置的话，就走的默认前缀<code>ROLE_</code><br> <img src="https://images2.imgbox.com/fd/50/gnYltBLl_o.png" alt="rolePrefix"><br> 在Spring Security中，可以使用<code>GrantedAuthorityDefaults</code>来为所有的授权授予对象指定默认的前缀。默认的前缀为<code>ROLE_</code>，可以使用<code>rolePrefix</code>属性为其指定不同的前缀，那我们具体怎么修改这个前缀呢？</p> 
<p>在<code>WebSecurityConfigurerAdapter</code>的<code>configure(HttpSecurity http)</code>方法中，可以使用以下代码来设置<code>GrantedAuthorityDefaults</code>的前缀：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 设置授权授予对象的默认前缀</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mvcMatchers</span><span class="token punctuation">(</span><span class="token string">"/admin/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"ADMIN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 使用自定义的前缀</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mvcMatchers</span><span class="token punctuation">(</span><span class="token string">"/user/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasAuthority</span><span class="token punctuation">(</span><span class="token string">"CUSTOMER"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">GrantedAuthorityDefaults</span> <span class="token function">grantedAuthorityDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GrantedAuthorityDefaults</span><span class="token punctuation">(</span><span class="token string">"CUSTOMER_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在示例中，<code>grantedAuthorityDefaults()</code>方法返回了<code>GrantedAuthorityDefaults</code>对象，其构造函数中传入了一个自定义的前缀<code>CUSTOMER_</code>。然后，在<code>configure(HttpSecurity http)</code>方法中，使用<code>hasAuthority("CUSTOMER")</code>指定了使用自定义前缀的授权授予对象。</p> 
<p>也可以使用默认的前缀<code>ROLE_</code>，只需要在<code>grantedAuthorityDefaults()</code>方法中不传入任何参数即可。</p> 
<h4><a id="_875"></a>验证</h4> 
<p>前面的验证环节中验证过的，这里我就不再赘述了，直接做新的验证</p> 
<h5><a id="_877"></a>验证一：使用普通用户登录验证</h5> 
<p>访问 <code>localhost:8080/login</code> 输入用户名<code>user</code> 和密码 <code>123456</code> ，登录成功之后再去访问下 <code>findAll</code>接口，由于user并没有访问权限，所以这个地方会报错<br> <img src="https://images2.imgbox.com/eb/b9/sgVhZzU1_o.png" alt="user访问findAll"><br> 接下来，我们访问下 <code>find</code> 接口，由于我们有配置菜单的接口许可，所以这里可以访问（这里其实就是说明了，只要有一个条件满足就可以访问了）<br> <img src="https://images2.imgbox.com/82/d9/tPRpZLnX_o.png" alt="user 访问 find"></p> 
<h5><a id="_882"></a>验证二：使用管理员账户登录验证</h5> 
<p>访问 <code>localhost:8080/login</code> 输入用户名<code>admin</code> 和密码 <code>123456</code> ，登录成功之后再去访问下 <code>findAll</code>接口与 <code>find</code> 接口，都是可以访问的，这里就不贴图来说明了，大伙可以自己去试试就好</p> 
<h4><a id="_885"></a>自定义界面访问</h4> 
<p>看到这里感觉真是不容易啊，我们还没有结束，继续向下看吧，界面添加的位置在这里<br> <img src="https://images2.imgbox.com/a0/92/duPUXSke_o.png" alt="添加界面"></p> 
<h5><a id="_888"></a>添加登录界面</h5> 
<p><strong>login.html</strong></p> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/user/login<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>用户名:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>密码:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>login<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="_Security__915"></a>修改 Security 的配置</h5> 
<p><strong>SecurityConfig.java</strong> 具体源码下的注释都比较清楚了，大伙就看下就好了</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//  表单登录</span>
        http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 修改默认的登录页为login.html，他会自动去根路径static文件夹下寻找login.html</span>
                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/login.html"</span><span class="token punctuation">)</span>
                <span class="token comment">// 设置登录接口地址，这个接口不是真实存在的，还是用的security给我们提供的，之所以要有这个配置，是login.html当中form表单提交的地址我们设置的是这个</span>
                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/user/login"</span><span class="token punctuation">)</span>
                <span class="token comment">// 登录成功之后跳转的 url</span>
                <span class="token punctuation">.</span><span class="token function">defaultSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/index"</span><span class="token punctuation">)</span>
                <span class="token comment">// 登录失败之后跳转的 url</span>
                <span class="token punctuation">.</span><span class="token function">failureForwardUrl</span><span class="token punctuation">(</span><span class="token string">"/fail"</span><span class="token punctuation">)</span>
                <span class="token comment">// permitAll中文意思是许可所有的：所有的都遵循上面的配置的意思</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//  身份认证</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 该路由不需要身份认证</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/user/login"</span><span class="token punctuation">,</span> <span class="token string">"/login.html"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 需要用户带有管理员权限</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/findAll"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"管理员"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/find"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"管理员"</span><span class="token punctuation">)</span>
                <span class="token comment">// 需要用户具备这个接口的权限</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/find"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasAuthority</span><span class="token punctuation">(</span><span class="token string">"menu:user"</span><span class="token punctuation">)</span>
                <span class="token comment">// 任何请求都需要认证</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关闭 csrf</span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_948"></a>验证</h4> 
<h5><a id="_949"></a>登录页面验证</h5> 
<p>访问 <code>localhost:8080/login</code> 时，会发现自动跳转到下面的页面中，输入用户名<code>user</code> 和密码 <code>123456</code> 是可以登录进去的<br> <img src="https://images2.imgbox.com/81/ef/EC8aweNH_o.png" alt="login.html"><br> 登录之后界面跳转<br> <img src="https://images2.imgbox.com/f5/3e/FpRElaYI_o.png" alt="登录成功"></p> 
<h4><a id="_954"></a>自定义错误页面</h4> 
<h4><a id="_956"></a>添加错误页面</h4> 
<p>这里我们添加一个新页面 <code>unauth.html</code></p> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>没有权限<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>没有权限<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="_Security__971"></a>修改 Security 的配置</h5> 
<pre><code class="prism language-java"><span class="token comment">// 设置没有权限访问跳转自定义页面</span>
http<span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">accessDeniedPage</span><span class="token punctuation">(</span><span class="token string">"/unauth.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/11/45/TXuoCrl6_o.png" alt="添加错误配置"></p> 
<h4><a id="_977"></a>验证</h4> 
<h5><a id="_978"></a>无访问权限验证</h5> 
<p>访问 <code>localhost:8080/login</code> 输入用户名<code>user</code> 和密码 <code>123456</code> ，登录成功之后再去访问下 <code>findAll</code>接口，由于user并没有访问权限<br> <img src="https://images2.imgbox.com/e4/0f/VlHtiNXw_o.png" alt="没有权限"></p> 
<h4><a id="_982"></a>自定义主页</h4> 
<p>这里我们是增加一个 <code>home.html</code> 方便于登录之后跳转，以及界面退出使用</p> 
<h5><a id="_984"></a>添加主页</h5> 
<p><strong>home.html</strong></p> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dvi</span><span class="token punctuation">&gt;</span></span>
    登录成功
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dvi</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/logout<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>退出<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="_Security__1006"></a>修改 Security 的配置</h5> 
<pre><code class="prism language-java"><span class="token comment">// 退出,这里的/logout的请求是和前端的接口约定，是security给我们提供的,退出成功后跳转登录页/login.html</span>
http<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logoutSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/login.html"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/23/14/wyRHC6uI_o.png" alt="增加配置"></p> 
<h4><a id="_1012"></a>验证</h4> 
<h5><a id="_1013"></a>验证跳转主页</h5> 
<p>访问 <code>localhost:8080/login</code> 输入用户名<code>user</code> 和密码 <code>123456</code> ，再次点击退出就到主页了。<br> <img src="https://images2.imgbox.com/53/41/NTBLTKDZ_o.png" alt="home页面"></p> 
<h4><a id="rememberme__1017"></a>remember-me 功能介绍</h4> 
<p>简单点理解就是这样子的，当我们登录到系统，关闭掉网页，再次访问系统的接口是可以访问的。一般情况下，如果我们把网页关闭或者浏览器关闭了，即使是后端程序服务重启了，这个时候就需要重新登录。有这个 remember-me 功能，就可以不用重新登录了。</p> 
<p>具体是怎么做的呢？其实这个是将我们的请求相关的参数持久化到了数据库中去了。这里我就直接开始说怎么做了，以及相关的报错，大伙了解下就好</p> 
<h5><a id="_Security__1021"></a>修改 Security 配置</h5> 
<p>我们增加 remember-me 的配置</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">MyUserDetailsService</span> myUserDetailsService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">PersistentTokenRepository</span> <span class="token function">persistentTokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">JdbcTokenRepositoryImpl</span> jdbcTokenRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTokenRepositoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jdbcTokenRepository<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> jdbcTokenRepository<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 注入 PasswordEncoder 类到 spring 容器中</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/50/5a/0rgxSSAj_o.png" alt="remember-me 配置"></p> 
<h5><a id="Login_1046"></a>修改Login页面</h5> 
<p>修改页面增加 remember-me 复选框，这里的 <code>name="remember-me"</code> 是不能修改的，可以理解为Spring Security 默认的</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remember-me<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>自动登录
</code></pre> 
<h5><a id="_1051"></a>创建表结构</h5> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>persistent_logins<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
	<span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">64</span> <span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">`</span>series<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">64</span> <span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">`</span>token<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">64</span> <span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">`</span>last_used<span class="token punctuation">`</span></span> <span class="token keyword">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">`</span>series<span class="token punctuation">`</span></span> <span class="token punctuation">)</span> 
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>
</code></pre> 
<p>如果不创建表结构会出现什么问题呢？我这边先不创建表结构，直接启动程序</p> 
<pre><code class="prism language-shell">org.springframework.jdbc.BadSqlGrammarException: PreparedStatementCallback<span class="token punctuation">;</span> bad SQL grammar <span class="token punctuation">[</span>insert into persistent_logins <span class="token punctuation">(</span>username, series, token, last_used<span class="token punctuation">)</span> values<span class="token punctuation">(</span>?,?,?,?<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> nested exception is java.sql.SQLSyntaxErrorException: Table <span class="token string">'study.persistent_logins'</span> doesn't exist
    at org.springframework.jdbc.support.SQLErrorCodeSQLExceptionTranslator.doTranslate<span class="token punctuation">(</span>SQLErrorCodeSQLExceptionTranslator.java:235<span class="token punctuation">)</span>
    at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate<span class="token punctuation">(</span>AbstractFallbackSQLExceptionTranslator.java:72<span class="token punctuation">)</span>
    at org.springframework.jdbc.core.JdbcTemplate.translateException<span class="token punctuation">(</span>JdbcTemplate.java:1443<span class="token punctuation">)</span>
    at org.springframework.jdbc.core.JdbcTemplate.execute<span class="token punctuation">(</span>JdbcTemplate.java:633<span class="token punctuation">)</span>
    at org.springframework.jdbc.core.JdbcTemplate.update<span class="token punctuation">(</span>JdbcTemplate.java:862<span class="token punctuation">)</span>
    at org.springframework.jdbc.core.JdbcTemplate.update<span class="token punctuation">(</span>JdbcTemplate.java:917<span class="token punctuation">)</span>
    at org.springframework.jdbc.core.JdbcTemplate.update<span class="token punctuation">(</span>JdbcTemplate.java:927<span class="token punctuation">)</span>
</code></pre> 
<p>这里我们看下源码，我们是新增这部分的配置，然后这里出现了一个类 <code>JdbcTokenRepositoryImpl</code>， 并且我们还将 dataSource 传入进去了，我们就看下这个类</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">PersistentTokenRepository</span> <span class="token function">persistentTokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">JdbcTokenRepositoryImpl</span> jdbcTokenRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTokenRepositoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jdbcTokenRepository<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> jdbcTokenRepository<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/de/83/hX1Vcno3_o.png" alt="JdbcTokenRepositoryImpl类"><br> 在这类中，就已经将这个表的相关操作全部都集成进去了，所以看到这里就明白了。</p> 
<h4><a id="_1085"></a>验证</h4> 
<h5><a id="_rememberme__1086"></a>验证 remember-me 功能</h5> 
<p>我们使用 admin账号之后，将浏览器页面关闭掉，依然可以访问到 findAll 接口。<br> <img src="https://images2.imgbox.com/95/e6/mUY6eDNw_o.png" alt="remember-me 登录"></p> 
<h4><a id="_1089"></a>原理分析</h4> 
<p>流程图，百度上面查到的地址在<a href="https://image.baidu.com/search/detail?ct=503316480&amp;z=0&amp;ipn=d&amp;word=spring%20security%20rememer-me%20%E9%AA%8C%E8%AF%81%E6%B5%81%E7%A8%8B%E5%9B%BE&amp;step_word=&amp;hs=0&amp;pn=2&amp;spn=0&amp;di=7249025186345779201&amp;pi=0&amp;rn=1&amp;tn=baiduimagedetail&amp;is=0%2C0&amp;istype=0&amp;ie=utf-8&amp;oe=utf-8&amp;in=&amp;cl=2&amp;lm=-1&amp;st=undefined&amp;cs=2141765050%2C868365375&amp;os=3874886977%2C1791703182&amp;simid=3458855444%2C168858937&amp;adpicid=0&amp;lpn=0&amp;ln=485&amp;fr=&amp;fmq=1694589136803_R&amp;fm=&amp;ic=undefined&amp;s=undefined&amp;hd=undefined&amp;latest=undefined&amp;copyright=undefined&amp;se=&amp;sme=&amp;tab=0&amp;width=undefined&amp;height=undefined&amp;face=undefined&amp;ist=&amp;jit=&amp;cg=&amp;bdtype=0&amp;oriquery=&amp;objurl=https%3A%2F%2Fgimg2.baidu.com%2Fimage_search%2Fsrc%3Dhttp%3A%2F%2Fupload-images.jianshu.io%2Fupload_images%2F3126293-12a1df2860f8cff5.png%26refer%3Dhttp%3A%2F%2Fupload-images.jianshu.io%26app%3D2002%26size%3Df9999%2C10000%26q%3Da80%26n%3D0%26g%3D0n%26fmt%3Dauto%3Fsec%3D1697181143%26t%3D9f08fadda449c1c25a77dd7480ff22e2&amp;fromurl=ippr_z2C%24qAzdH3FAzdH3Fooo_z%26e3B3twgfi7_z%26e3Bv54AzdH3FrAzdH3Fv9uak0vmabua&amp;gsm=1e&amp;rpstart=0&amp;rpnum=0&amp;islist=&amp;querylist=&amp;nojc=undefined&amp;dyTabStr=MTEsMCw2LDQsNSwzLDEsMiw3LDgsOQ%3D%3D" rel="nofollow">这里</a><br> <img src="https://images2.imgbox.com/65/40/74KT612v_o.png" alt="百度找的图片"></p> 
<p>在登录成功之后，前端在浏览器上面写入了一部分信息到 cookies 中了<br> <img src="https://images2.imgbox.com/90/a5/kzalpVD2_o.png" alt="前端浏览器中的 cookies"><br> 开启 RememberMe 后，<code>RememberMeAuthenticationFilter</code> 过滤器就会被激活，我们可以看看这个过滤器的doFilter方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">;</span>
		<span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">;</span>
		<span class="token comment">// 查看是否有SecurityContextHolder中是否有认证信息</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 没有认证信息，因此尝试rememberMe认证，这也是核心方法</span>
			<span class="token class-name">Authentication</span> rememberMeAuth <span class="token operator">=</span> rememberMeServices<span class="token punctuation">.</span><span class="token function">autoLogin</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>rememberMeAuth <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// rememberMeAuth不为null则表示自动登录成功，现在需要对key进行校验</span>
				<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					rememberMeAuth <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token comment">// 认证走到这一步就说明成功了，因为失败会抛异常</span>
					<span class="token comment">// 将身份信息存储到SecurityContextHolder</span>
					<span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
					
					<span class="token comment">// 发布认证成功事件</span>
					<span class="token function">onSuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"SecurityContextHolder populated with remember-me token: '"</span>
								<span class="token operator">+</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
								<span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>

					<span class="token comment">// Fire event</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						eventPublisher
								<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InteractiveAuthenticationSuccessEvent</span><span class="token punctuation">(</span>
										<span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
												<span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>

					<span class="token keyword">if</span> <span class="token punctuation">(</span>successHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						successHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span>
								rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token keyword">return</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>

				<span class="token punctuation">}</span>
				<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> authenticationException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
								<span class="token string">"SecurityContextHolder not populated with remember-me token, as "</span>
										<span class="token operator">+</span> <span class="token string">"AuthenticationManager rejected Authentication returned by RememberMeServices: '"</span>
										<span class="token operator">+</span> rememberMeAuth
										<span class="token operator">+</span> <span class="token string">"'; invalidating remember-me token"</span><span class="token punctuation">,</span>
								authenticationException<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					
					<span class="token comment">// 登录失败，使用该方法处理失败回调</span>
					rememberMeServices<span class="token punctuation">.</span><span class="token function">loginFail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token comment">// 发布登录失败事件</span>
					<span class="token function">onUnsuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span>authenticationException<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 过滤器放行</span>
			chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		    <span class="token comment">// 如果SecurityContextHolder中有认证信息，说明已经认证过了，则打印日志并直接放行</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"SecurityContextHolder not populated with remember-me token, as it already contained: '"</span>
						<span class="token operator">+</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>从上面可以知道核心部分是在 <code>rememberMeServices.autoLogin()</code> ，最后我们找下具体的执行逻辑<br> <img src="https://images2.imgbox.com/72/39/NeyZkyDB_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_1173"></a>注解使用</h4> 
<p>由于在实际开发中，当接口越来越多之后，如果都在Spring Security 的配置类中增加配置，那么就会越来越难维护，在 Spring Security 中也提供了注解来处理这样子的问题。这里我就介绍常用一部分，另外的大家可以去搜索下，问题不大。</p> 
<p>Spring Security默认是禁用注解的，要想开启注解，要在继承 WebSecurityConfigurerAdapter 的类加 @EnableMethodSecurity 注解</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>prePostEnabled = true</code></p> 
<ul><li>@PreAuthorize 和 @PostAuthorize 两个注解会生效</li></ul> 
<p><code>securedEnabled =true </code></p> 
<ul><li>@Secured 会生效</li></ul> 
<p>另外还有一个 <code>jsr250Enabled = true</code> 这个是 java 提供的配置，这个就不在这里说了，其实都不算特别复杂的。</p> 
<p>我们先回顾下之前的配置</p> 
<pre><code class="prism language-java"><span class="token comment">// 需要用户带有管理员角色才可以访问/findAll接口</span>
<span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/findAll"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"管理员"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/find"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasAuthority</span><span class="token punctuation">(</span><span class="token string">"menu:user"</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="Secured_1197"></a>@Secured注解</h5> 
<p>需要开启配置</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>securedEnabled<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre> 
<p>具体使用如下，我们可以在 Controller 上面去增加一个注解就可以了，当然前缀 <code>ROLE_</code> 不能少！！！<br> <img src="https://images2.imgbox.com/25/32/KTHTI7RV_o.png" alt="在这里插入图片描述"></p> 
<p>这个也可以使用在方法上面：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Secured</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"ROLE_管理员"</span><span class="token punctuation">,</span><span class="token string">"ROLE_普通用户"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"find"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">"find"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个就是和 <code>.antMatchers("/findAll").hasRole("管理员")</code> 等效</p> 
<h5><a id="PreAuthorize_1216"></a>@PreAuthorize</h5> 
<p>@PreAuthorize：注解适合进入方法前的权限验证， 可以将登录用户的 roles/permissions 参数传到方法中。</p> 
<p>需要开启配置</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAnyAuthority('menu:system')"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1111111111111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个就是和 <code>.antMatchers("/find").hasAuthority("menu:user")</code> 等效。</p> 
<h5><a id="PostAuthorize_1237"></a>@PostAuthorize</h5> 
<p><code>@PostAuthorize</code> 注解使用并不多，在方法执行后再进行权限验证，适合验证带有返回值<br> 的权限。配置都是差不多的，这里就不多说了。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@PostAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAnyAuthority('menu:system')"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1111111111111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1254"></a>总结</h4> 
<p>看到这里了，应该是对 Spring Security 大致的用法是怎么来的就有一个清晰的了解了，在项目开发中看到上面，应该是应对一般的开发工作是没有问题了的。</p> 
<p>另外呢，使用 <a href="https://github.com/Wayfreem/spring-boot-demo/tree/main/boot-rbac-security-jwt">SpringBoot Security + Jwt + Redis + Mybatis Plus 做为登录校验可以点击看下项目工程源码</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/974d0972730c6ffc2b774ff5e33b7937/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python module - try&amp;except</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0a09897a9359c7eacf53362b6ce9f2b0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【C&#43;&#43;】Visual Studio warning C4819: 该文件包含不能在当前代码页(936)中表示的字符 &amp;&amp; “常量中有换行符”的解决办法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>