<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Android12】Android Framework系列--AMS启动Activity分析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Android12】Android Framework系列--AMS启动Activity分析" />
<meta property="og:description" content="AMS启动Activity分析 通过ActivityManagerService(AMS)提供的方法，可以启动指定的Activity。比如Launcher中点击应用图标后，调用AMS的startActivity函数启动应用。
AMS提供的服务通过IActivityManager.aidl文件定义。
// frameworks/base/core/java/android/app/IActivityManager.aidl package android.app; // 省略 /** * System private API for talking with the activity manager service. This * provides calls from the application back to the activity manager. * * {@hide} */ interface IActivityManager { // 省略 /** @deprecated Use {@link #startActivityWithFeature} instead */ @UnsupportedAppUsage(maxTargetSdk=29, publicAlternatives=&#34;Use {@link android.content.Context#startActivity(android.content.Intent)} instead&#34;) int startActivity(in IApplicationThread caller, in String callingPackage, in Intent intent, in String resolvedType, in IBinder resultTo, in String resultWho, int requestCode, int flags, in ProfilerInfo profilerInfo, in Bundle options); int startActivityWithFeature(in IApplicationThread caller, in String callingPackage, in String callingFeatureId, in Intent intent, in String resolvedType, in IBinder resultTo, in String resultWho, int requestCode, int flags, in ProfilerInfo profilerInfo, in Bundle options); // 省略 } 代码版本是Android12。分析一下从应用侧（比如Launcher）调用startActivity启动另一个应用的流程。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2b9dcb0cebc4b1f23ca96f2317d75a32/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-10T18:19:11+08:00" />
<meta property="article:modified_time" content="2023-12-10T18:19:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Android12】Android Framework系列--AMS启动Activity分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="AMSActivity_0"></a>AMS启动Activity分析</h3> 
<p>通过ActivityManagerService(AMS)提供的方法，可以启动指定的Activity。比如Launcher中点击应用图标后，调用AMS的<strong>startActivity</strong>函数启动应用。<br> AMS提供的服务通过<strong>IActivityManager.aidl</strong>文件定义。</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/IActivityManager.aidl</span>
<span class="token keyword">package</span> <span class="token namespace">android<span class="token punctuation">.</span>app</span><span class="token punctuation">;</span>
<span class="token comment">// 省略</span>
<span class="token comment">/**
 * System private API for talking with the activity manager service.  This
 * provides calls from the application back to the activity manager.
 *
 * {@hide}
 */</span>
<span class="token keyword">interface</span> <span class="token class-name">IActivityManager</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 省略</span>
    <span class="token comment">/** @deprecated Use {@link #startActivityWithFeature} instead */</span>
    <span class="token annotation punctuation">@UnsupportedAppUsage</span><span class="token punctuation">(</span>maxTargetSdk<span class="token operator">=</span><span class="token number">29</span><span class="token punctuation">,</span> publicAlternatives<span class="token operator">=</span><span class="token string">"Use {@link android.content.Context#startActivity(android.content.Intent)} instead"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span>in <span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> in <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span> in <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span>
            in <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> in <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> in <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span>
            <span class="token keyword">int</span> flags<span class="token punctuation">,</span> in <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> in <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token function">startActivityWithFeature</span><span class="token punctuation">(</span>in <span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> in <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
            in <span class="token class-name">String</span> callingFeatureId<span class="token punctuation">,</span> in <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> in <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span>
            in <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> in <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
            in <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> in <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 省略</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>代码版本是Android12。分析一下从应用侧（比如Launcher）调用startActivity启动另一个应用的流程。<br> <img src="https://images2.imgbox.com/33/6e/A2UyQCV0_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="startActivity_30"></a>startActivity源码分析</h4> 
<p>应用侧可以通过context的startActivity函数调用AMS。比如下述例子。</p> 
<pre><code class="prism language-java"><span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 启动com.linduo.test这个Package中的  MainActivity</span>
intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span><span class="token string">"com.linduo.test"</span><span class="token punctuation">,</span> <span class="token string">"com.linduo.test.MainActivity"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>context是abstract的类，其实现在ContextImpl中。</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/content/ContextWrapper.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContextWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">Context</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token comment">// frameworks/base/core/java/android/app/ContextImpl.java</span>
<span class="token keyword">class</span> <span class="token class-name">ContextImpl</span> <span class="token keyword">extends</span> <span class="token class-name">Context</span> <span class="token punctuation">{<!-- --></span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">warnIfCallingFromSystemProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">warnIfCallingFromSystemProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Calling start activity from outside an activity without FLAG_ACTIVITY_NEW_TASK is</span>
	<span class="token comment">// generally not allowed, except if the caller specifies the task id the activity should</span>
	<span class="token comment">// be launched in. A bug was existed between N and O-MR1 which allowed this to work. We</span>
	<span class="token comment">// maintain this for backwards compatibility.</span>
	<span class="token keyword">final</span> <span class="token keyword">int</span> targetSdkVersion <span class="token operator">=</span> <span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_ACTIVITY_NEW_TASK</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
			<span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>targetSdkVersion <span class="token operator">&lt;</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N</span>
					<span class="token operator">||</span> targetSdkVersion <span class="token operator">&gt;=</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>P</span><span class="token punctuation">)</span>
			<span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>options <span class="token operator">==</span> <span class="token keyword">null</span>
					<span class="token operator">||</span> <span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">fromBundle</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLaunchTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AndroidRuntimeException</span><span class="token punctuation">(</span>
				<span class="token string">"Calling startActivity() from outside of an Activity "</span>
						<span class="token operator">+</span> <span class="token string">" context requires the FLAG_ACTIVITY_NEW_TASK flag."</span>
						<span class="token operator">+</span> <span class="token string">" Is this really what you want?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	mMainThread<span class="token punctuation">.</span><span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execStartActivity</span><span class="token punctuation">(</span>
			<span class="token function">getOuterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span><span class="token class-name">Activity</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ContextImpl通过<strong>mMainThread(ActivityThread类型)<strong>得到了</strong>Instrumentation</strong>对象，调用Instrumentation的<strong>execStartActivity</strong>函数。execStartActivity函数中，如果开启了Activity监听模式，会通知监听者onStartActivity，然后调用ActivityTaskManagerService的startActivity函数启动Activity。最后检查启动的结果，如果启动失败抛出对应的异常。<br> onStartActivity的监听，可以使用Instrumentation.addMonitor方式，具体内容可以查看Instrumentation.java</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/Instrumentation.java</span>
<span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token keyword">public</span> <span class="token class-name">ActivityResult</span> <span class="token function">execStartActivity</span><span class="token punctuation">(</span>
		<span class="token class-name">Context</span> who<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> contextThread<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token class-name">Activity</span> target<span class="token punctuation">,</span>
		<span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">IApplicationThread</span> whoThread <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span><span class="token punctuation">)</span> contextThread<span class="token punctuation">;</span>
	<span class="token class-name">Uri</span> referrer <span class="token operator">=</span> target <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> target<span class="token punctuation">.</span><span class="token function">onProvideReferrer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>referrer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">EXTRA_REFERRER</span><span class="token punctuation">,</span> referrer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mActivityMonitors <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 如果开启了监听，会给监听者通过 onStartActivity</span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mSync<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token class-name">N</span> <span class="token operator">=</span> mActivityMonitors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token class-name">N</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">final</span> <span class="token class-name">ActivityMonitor</span> am <span class="token operator">=</span> mActivityMonitors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">ActivityResult</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">ignoreMatchingSpecificIntents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					result <span class="token operator">=</span> am<span class="token punctuation">.</span><span class="token function">onStartActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					am<span class="token punctuation">.</span>mHits<span class="token operator">++</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> result<span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>who<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					am<span class="token punctuation">.</span>mHits<span class="token operator">++</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">isBlocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token keyword">return</span> requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> am<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
		intent<span class="token punctuation">.</span><span class="token function">migrateExtraStreamToClipData</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span><span class="token punctuation">;</span>
		intent<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 调用ActivityTaskManagerService( AMS中提供的服务）</span>
		<span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">ActivityTaskManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>whoThread<span class="token punctuation">,</span>
				who<span class="token punctuation">.</span><span class="token function">getOpPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> who<span class="token punctuation">.</span><span class="token function">getAttributionTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
				intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span>who<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span>
				target <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> target<span class="token punctuation">.</span>mEmbeddedID <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 检查启动的结果，如果失败会throw异常。</span>
		<span class="token function">checkStartActivityResult</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failure from system"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ActivityTaskManagerService继承了<strong>IActivityTaskManager.Stub</strong>，属于AMS提供的服务。在其startActivity函数中，会调用startActivityAsUser，判断package与UID是否相符、是否为Isolated模式的应用、并检查用户权限（源码中可以看出系统用户权限非常大，所以为了安全要慎用系统用户权限），最终调用<strong>ActivityStarter</strong>的<strong>execute</strong>启动Activity。</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
		<span class="token class-name">String</span> callingFeatureId<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span>
		<span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span>
		<span class="token class-name">Bundle</span> bOptions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 调用startActivityAsUser</span>
	<span class="token keyword">return</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> callingFeatureId<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
			resultTo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> bOptions<span class="token punctuation">,</span>
			<span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getCallingUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
		<span class="token class-name">String</span> callingFeatureId<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span>
		<span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span>
		<span class="token class-name">Bundle</span> bOptions<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 调用startActivityAsUser，validateIncomingUser为true</span>
	<span class="token keyword">return</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> callingFeatureId<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
			resultTo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> bOptions<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
			<span class="token boolean">true</span> <span class="token comment">/*validateIncomingUser*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
		<span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> callingFeatureId<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span>
		<span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span>
		<span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> bOptions<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> validateIncomingUser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 判断调用的package和UID相符</span>
	<span class="token function">assertPackageMatchesCallingUid</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 禁止来自Isolated模式应用的调用</span>
	<span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token string">"startActivityAsUser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 检测用户权限。这个函数中，可以看出系统用户权限非常大（感兴趣的可以看一下）</span>
	userId <span class="token operator">=</span> <span class="token function">getActivityStartController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkTargetUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> validateIncomingUser<span class="token punctuation">,</span>
			<span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"startActivityAsUser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 通过ActivityStartController，取得ActivityStarter，设置好系列参数后调用execute</span>
	<span class="token comment">// TODO: Switch to user app stacks here.</span>
	<span class="token keyword">return</span> <span class="token function">getActivityStartController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">obtainStarter</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token string">"startActivityAsUser"</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setCaller</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setCallingPackage</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setCallingFeatureId</span><span class="token punctuation">(</span>callingFeatureId<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setResolvedType</span><span class="token punctuation">(</span>resolvedType<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setResultTo</span><span class="token punctuation">(</span>resultTo<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setResultWho</span><span class="token punctuation">(</span>resultWho<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setRequestCode</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setStartFlags</span><span class="token punctuation">(</span>startFlags<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setProfilerInfo</span><span class="token punctuation">(</span>profilerInfo<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setActivityOptions</span><span class="token punctuation">(</span>bOptions<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>ActivityStarter的execute函数中，再次进行了一些检查，比如是否存在文件句柄泄露（Intent）、config是否要变更，并调用了executeRequest函数。</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityStarter.java</span>
<span class="token keyword">int</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Refuse possible leaked file descriptors</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mRequest<span class="token punctuation">.</span>intent <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mRequest<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">hasFileDescriptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"File descriptors passed in Intent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">final</span> <span class="token class-name">LaunchingState</span> launchingState<span class="token punctuation">;</span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mGlobalLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> caller <span class="token operator">=</span> <span class="token class-name">ActivityRecord</span><span class="token punctuation">.</span><span class="token function">forTokenLocked</span><span class="token punctuation">(</span>mRequest<span class="token punctuation">.</span>resultTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> mRequest<span class="token punctuation">.</span>realCallingUid <span class="token operator">==</span> <span class="token class-name">Request</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_REAL_CALLING_UID</span>
					<span class="token operator">?</span>  <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> mRequest<span class="token punctuation">.</span>realCallingUid<span class="token punctuation">;</span>
			launchingState <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">getActivityMetricsLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notifyActivityLaunching</span><span class="token punctuation">(</span>
					mRequest<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> caller<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// If the caller hasn't already resolved the activity, we're willing</span>
		<span class="token comment">// to do so here. If the caller is already holding the WM lock here,</span>
		<span class="token comment">// and we need to check dynamic Uri permissions, then we're forced</span>
		<span class="token comment">// to assume those permissions are denied to avoid deadlocking.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mRequest<span class="token punctuation">.</span>activityInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			mRequest<span class="token punctuation">.</span><span class="token function">resolveActivity</span><span class="token punctuation">(</span>mSupervisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Add checkpoint for this shutdown or reboot attempt, so we can record the original</span>
		<span class="token comment">// intent action and package name.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mRequest<span class="token punctuation">.</span>intent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">String</span> intentAction <span class="token operator">=</span> mRequest<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> callingPackage <span class="token operator">=</span> mRequest<span class="token punctuation">.</span>callingPackage<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>intentAction <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> callingPackage <span class="token operator">!=</span> <span class="token keyword">null</span>
					<span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_REQUEST_SHUTDOWN</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intentAction<span class="token punctuation">)</span>
							<span class="token operator">||</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_SHUTDOWN</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intentAction<span class="token punctuation">)</span>
							<span class="token operator">||</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_REBOOT</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intentAction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">ShutdownCheckPoints</span><span class="token punctuation">.</span><span class="token function">recordCheckPoint</span><span class="token punctuation">(</span>intentAction<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">int</span> res<span class="token punctuation">;</span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mGlobalLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">final</span> <span class="token keyword">boolean</span> globalConfigWillChange <span class="token operator">=</span> mRequest<span class="token punctuation">.</span>globalConfig <span class="token operator">!=</span> <span class="token keyword">null</span>
					<span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span><span class="token function">getGlobalConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">diff</span><span class="token punctuation">(</span>mRequest<span class="token punctuation">.</span>globalConfig<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token comment">// 获取当前处于Top且Focus的RootTask</span>
			<span class="token keyword">final</span> <span class="token class-name">Task</span> rootTask <span class="token operator">=</span> mRootWindowContainer<span class="token punctuation">.</span><span class="token function">getTopDisplayFocusedRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>rootTask <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// RookTask非空，更新一下ConfigChange的Flag。</span>
				rootTask<span class="token punctuation">.</span>mConfigWillChange <span class="token operator">=</span> globalConfigWillChange<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">WM_DEBUG_CONFIGURATION</span><span class="token punctuation">,</span> <span class="token string">"Starting activity when config "</span>
					<span class="token operator">+</span> <span class="token string">"will change = %b"</span><span class="token punctuation">,</span> globalConfigWillChange<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			res <span class="token operator">=</span> <span class="token function">resolveToHeavyWeightSwitcherIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> <span class="token constant">START_SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> res<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 这个函数中，会创建ActivityRecord，并启动Activity</span>
			res <span class="token operator">=</span> <span class="token function">executeRequest</span><span class="token punctuation">(</span>mRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 后面的函数，主要是Config的变更。如果有变化会给config变化的通知。</span>
			<span class="token comment">// 以及结果的检查。</span>
			<span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>globalConfigWillChange<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// If the caller also wants to switch to a new configuration, do so now.</span>
				<span class="token comment">// This allows a clean switch, as we are waiting for the current activity</span>
				<span class="token comment">// to pause (so we will not destroy it), and have not yet started the</span>
				<span class="token comment">// next activity.</span>
				mService<span class="token punctuation">.</span>mAmInternal<span class="token punctuation">.</span><span class="token function">enforceCallingPermission</span><span class="token punctuation">(</span>
						<span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span></span>Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">CHANGE_CONFIGURATION</span><span class="token punctuation">,</span>
						<span class="token string">"updateConfiguration()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>rootTask <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					rootTask<span class="token punctuation">.</span>mConfigWillChange <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">WM_DEBUG_CONFIGURATION</span><span class="token punctuation">,</span>
							<span class="token string">"Updating to new configuration after starting activity."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				mService<span class="token punctuation">.</span><span class="token function">updateConfigurationLocked</span><span class="token punctuation">(</span>mRequest<span class="token punctuation">.</span>globalConfig<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// The original options may have additional info about metrics. The mOptions is not</span>
			<span class="token comment">// used here because it may be cleared in setTargetRootTaskIfNeeded.</span>
			<span class="token keyword">final</span> <span class="token class-name">ActivityOptions</span> originalOptions <span class="token operator">=</span> mRequest<span class="token punctuation">.</span>activityOptions <span class="token operator">!=</span> <span class="token keyword">null</span>
					<span class="token operator">?</span> mRequest<span class="token punctuation">.</span>activityOptions<span class="token punctuation">.</span><span class="token function">getOriginalOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token comment">// If the new record is the one that started, a new activity has created.</span>
			<span class="token keyword">final</span> <span class="token keyword">boolean</span> newActivityCreated <span class="token operator">=</span> mStartActivity <span class="token operator">==</span> mLastStartActivityRecord<span class="token punctuation">;</span>
			<span class="token comment">// Notify ActivityMetricsLogger that the activity has launched.</span>
			<span class="token comment">// ActivityMetricsLogger will then wait for the windows to be drawn and populate</span>
			<span class="token comment">// WaitResult.</span>
			mSupervisor<span class="token punctuation">.</span><span class="token function">getActivityMetricsLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notifyActivityLaunched</span><span class="token punctuation">(</span>launchingState<span class="token punctuation">,</span> res<span class="token punctuation">,</span>
					newActivityCreated<span class="token punctuation">,</span> mLastStartActivityRecord<span class="token punctuation">,</span> originalOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mRequest<span class="token punctuation">.</span>waitResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				mRequest<span class="token punctuation">.</span>waitResult<span class="token punctuation">.</span>result <span class="token operator">=</span> res<span class="token punctuation">;</span>
				res <span class="token operator">=</span> <span class="token function">waitResultIfNeeded</span><span class="token punctuation">(</span>mRequest<span class="token punctuation">.</span>waitResult<span class="token punctuation">,</span> mLastStartActivityRecord<span class="token punctuation">,</span>
						launchingState<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token function">getExternalResult</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">onExecutionComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ActivityStarter的executeRequest比较长，下面省略一部分内容。根据其注释内容“<strong>Executing activity start request and starts the journey of starting an activity</strong>”也可以看出，在这里处理了activity启动的请求。函数中，进行了权限检查，包括判断了是否为Home应用，创建了ActivityRecord记录这次启动为最后一次启动的Activity，然后调用startActivityUnchecked启动应用。</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityStarter.java</span>
<span class="token comment">/**
 * Executing activity start request and starts the journey of starting an activity. Here
 * begins with performing several preliminary checks. The normally activity launch flow will
 * go through {@link #startActivityUnchecked} to {@link #startActivityInner}.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">executeRequest</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">// 检查启动 权限</span>
	<span class="token keyword">boolean</span> abort <span class="token operator">=</span> <span class="token operator">!</span>mSupervisor<span class="token punctuation">.</span><span class="token function">checkStartAnyActivityPermission</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span>
			requestCode<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> callingFeatureId<span class="token punctuation">,</span>
			request<span class="token punctuation">.</span>ignoreTargetSecurity<span class="token punctuation">,</span> inTask <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> resultRecord<span class="token punctuation">,</span>
			resultRootTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
	abort <span class="token operator">|=</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mIntentFirewall<span class="token punctuation">.</span><span class="token function">checkStartActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
			callingPid<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	abort <span class="token operator">|=</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span><span class="token function">getPermissionPolicyInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkStartActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
			callingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">boolean</span> restrictedBgActivity <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>abort<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span>
					<span class="token string">"shouldAbortBackgroundActivityStart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 判断是否可以启动Activity.</span>
			<span class="token comment">// 这里也会判断是否为Home应用，如果是Home应用的可以启动。如果不是，还要进行其他判断。</span>
			restrictedBgActivity <span class="token operator">=</span> <span class="token function">shouldAbortBackgroundActivityStart</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span>
					callingPid<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> realCallingPid<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span>
					request<span class="token punctuation">.</span>originatingPendingIntent<span class="token punctuation">,</span> request<span class="token punctuation">.</span>allowBackgroundActivityStart<span class="token punctuation">,</span>
					intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// 创建ActivityRecord</span>
	<span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityRecord<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setCaller</span><span class="token punctuation">(</span>callerApp<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setLaunchedFromPid</span><span class="token punctuation">(</span>callingPid<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setLaunchedFromUid</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setLaunchedFromPackage</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setLaunchedFromFeature</span><span class="token punctuation">(</span>callingFeatureId<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setResolvedType</span><span class="token punctuation">(</span>resolvedType<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setActivityInfo</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setConfiguration</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span><span class="token function">getGlobalConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setResultTo</span><span class="token punctuation">(</span>resultRecord<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setResultWho</span><span class="token punctuation">(</span>resultWho<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setRequestCode</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setComponentSpecified</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>componentSpecified<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setRootVoiceInteraction</span><span class="token punctuation">(</span>voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setActivityOptions</span><span class="token punctuation">(</span>checkedOptions<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">setSourceRecord</span><span class="token punctuation">(</span>sourceRecord<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 记录为最后一次启动的Activity</span>
	mLastStartActivityRecord <span class="token operator">=</span> r<span class="token punctuation">;</span>
	<span class="token comment">// 调用startActivityUnchecked，启动Activity</span>
	mLastStartActivityResult <span class="token operator">=</span> <span class="token function">startActivityUnchecked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span>
			request<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* doResume */</span><span class="token punctuation">,</span> checkedOptions<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span>
			restrictedBgActivity<span class="token punctuation">,</span> intentGrants<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>outActivity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		request<span class="token punctuation">.</span>outActivity<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> mLastStartActivityRecord<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> mLastStartActivityResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ActivityStarter的startActivityUnchecked函数会调用startActivityInner函数，在这个函数中获取加载Activity的RootTask加载Activity，并调用RootWindowContainer的resumeFocusedTasksTopActivities函数fork出一个进程来运行Activity。</p> 
<pre><code class="prism language-java">
<span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityStarter.java</span>

<span class="token comment">/**
 * Start an activity while most of preliminary checks has been done and caller has been
 * confirmed that holds necessary permissions to do so.
 * Here also ensures that the starting activity is removed if the start wasn't successful.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">startActivityUnchecked</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> sourceRecord<span class="token punctuation">,</span>
			<span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
			<span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">,</span> <span class="token class-name">Task</span> inTask<span class="token punctuation">,</span>
			<span class="token keyword">boolean</span> restrictedBgActivity<span class="token punctuation">,</span> <span class="token class-name">NeededUriGrants</span> intentGrants<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 省略</span>
	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
		mService<span class="token punctuation">.</span><span class="token function">deferWindowLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span> <span class="token string">"startActivityInner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 调用startActivityInner</span>
		result <span class="token operator">=</span> <span class="token function">startActivityInner</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span>
				startFlags<span class="token punctuation">,</span> doResume<span class="token punctuation">,</span> options<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> restrictedBgActivity<span class="token punctuation">,</span> intentGrants<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 省略</span>
	<span class="token punctuation">}</span>

	<span class="token function">postStartActivityProcessing</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> result<span class="token punctuation">,</span> startedActivityRootTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
 * Start an activity and determine if the activity should be adding to the top of an existing
 * task or delivered new intent to an existing activity. Also manipulating the activity task
 * onto requested or valid root-task/display.
 *
 * Note: This method should only be called from {@link #startActivityUnchecked}.
 */</span>

<span class="token comment">// TODO(b/152429287): Make it easier to exercise code paths through startActivityInner</span>
<span class="token annotation punctuation">@VisibleForTesting</span>
<span class="token keyword">int</span> <span class="token function">startActivityInner</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> sourceRecord<span class="token punctuation">,</span>
		<span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
		<span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">,</span> <span class="token class-name">Task</span> inTask<span class="token punctuation">,</span>
		<span class="token keyword">boolean</span> restrictedBgActivity<span class="token punctuation">,</span> <span class="token class-name">NeededUriGrants</span> intentGrants<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 省略</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mTargetRootTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 获取目标RootTask</span>
		mTargetRootTask <span class="token operator">=</span> <span class="token function">getLaunchRootTask</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span> mLaunchFlags<span class="token punctuation">,</span> targetTask<span class="token punctuation">,</span> mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 调用RootTask，startActivity(细节可以顺着这个函数看）</span>
	mTargetRootTask<span class="token punctuation">.</span><span class="token function">startActivityLocked</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span>
			topRootTask <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> topRootTask<span class="token punctuation">.</span><span class="token function">getTopNonFinishingActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> newTask<span class="token punctuation">,</span>
			mKeepCurTransition<span class="token punctuation">,</span> mOptions<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
	<span class="token comment">// mDoResume为Ture</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mDoResume<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mTargetRootTask<span class="token punctuation">.</span><span class="token function">isTopActivityFocusable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token operator">||</span> <span class="token punctuation">(</span>topTaskActivity <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> topTaskActivity<span class="token punctuation">.</span><span class="token function">isTaskOverlay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token operator">&amp;&amp;</span> mStartActivity <span class="token operator">!=</span> topTaskActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 省略</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// If the target root-task was not previously focusable (previous top running</span>
			<span class="token comment">// activity on that root-task was not visible) then any prior calls to move the</span>
			<span class="token comment">// root-task to the will not update the focused root-task.  If starting the new</span>
			<span class="token comment">// activity now allows the task root-task to be focusable, then ensure that we</span>
			<span class="token comment">// now update the focused root-task accordingly.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mTargetRootTask<span class="token punctuation">.</span><span class="token function">isTopActivityFocusable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mRootWindowContainer<span class="token punctuation">.</span><span class="token function">isTopDisplayFocusedRootTask</span><span class="token punctuation">(</span>mTargetRootTask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				mTargetRootTask<span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">"startActivityInner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			mRootWindowContainer<span class="token punctuation">.</span><span class="token function">resumeFocusedTasksTopActivities</span><span class="token punctuation">(</span>
					mTargetRootTask<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">,</span> mOptions<span class="token punctuation">,</span> mTransientLaunch<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	mRootWindowContainer<span class="token punctuation">.</span><span class="token function">updateUserRootTask</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>mUserId<span class="token punctuation">,</span> mTargetRootTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Update the recent tasks list immediately when the activity starts</span>
	mSupervisor<span class="token punctuation">.</span>mRecentTasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	mSupervisor<span class="token punctuation">.</span><span class="token function">handleNonResizableTaskIfNeeded</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			mPreferredWindowingMode<span class="token punctuation">,</span> mPreferredTaskDisplayArea<span class="token punctuation">,</span> mTargetRootTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token constant">START_SUCCESS</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>启动的Activity如果是另一个应用，Android会fork出一个进程来加载Activity。那么是在哪里进行的fork？<br> 在ActivityStarter的handleStartResult中，会进行fork进程操作（调用Process.start实现）</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityStarter.java</span>
<span class="token comment">/**
 * Start an activity while most of preliminary checks has been done and caller has been
 * confirmed that holds necessary permissions to do so.
 * Here also ensures that the starting activity is removed if the start wasn't successful.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">startActivityUnchecked</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> sourceRecord<span class="token punctuation">,</span>
		<span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
		<span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">,</span> <span class="token class-name">Task</span> inTask<span class="token punctuation">,</span>
		<span class="token class-name">TaskFragment</span> inTaskFragment<span class="token punctuation">,</span> <span class="token keyword">boolean</span> restrictedBgActivity<span class="token punctuation">,</span>
		<span class="token class-name">NeededUriGrants</span> intentGrants<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token constant">START_CANCELED</span><span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">Task</span> startedActivityRootTask<span class="token punctuation">;</span>

	<span class="token comment">// Create a transition now to record the original intent of actions taken within</span>
	<span class="token comment">// startActivityInner. Otherwise, logic in startActivityInner could start a different</span>
	<span class="token comment">// transition based on a sub-action.</span>
	<span class="token comment">// Only do the create here (and defer requestStart) since startActivityInner might abort.</span>
	<span class="token keyword">final</span> <span class="token class-name">TransitionController</span> transitionController <span class="token operator">=</span> r<span class="token punctuation">.</span>mTransitionController<span class="token punctuation">;</span>
	<span class="token class-name">Transition</span> newTransition <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span>transitionController<span class="token punctuation">.</span><span class="token function">isCollecting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token operator">&amp;&amp;</span> transitionController<span class="token punctuation">.</span><span class="token function">getTransitionPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
			<span class="token operator">?</span> transitionController<span class="token punctuation">.</span><span class="token function">createTransition</span><span class="token punctuation">(</span><span class="token constant">TRANSIT_OPEN</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token class-name">RemoteTransition</span> remoteTransition <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">takeRemoteTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>newTransition <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> remoteTransition <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		newTransition<span class="token punctuation">.</span><span class="token function">setRemoteTransition</span><span class="token punctuation">(</span>remoteTransition<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	transitionController<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
		mService<span class="token punctuation">.</span><span class="token function">deferWindowLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span> <span class="token string">"startActivityInner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result <span class="token operator">=</span> <span class="token function">startActivityInner</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span>
				startFlags<span class="token punctuation">,</span> doResume<span class="token punctuation">,</span> options<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> inTaskFragment<span class="token punctuation">,</span> restrictedBgActivity<span class="token punctuation">,</span>
				intentGrants<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 这里会fork出一个进程（调用RootWindowContainer.ensureVisibilityAndConfig），最终调用Process.start</span>
		startedActivityRootTask <span class="token operator">=</span> <span class="token function">handleStartResult</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> options<span class="token punctuation">,</span> result<span class="token punctuation">,</span> newTransition<span class="token punctuation">,</span>
				remoteTransition<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mService<span class="token punctuation">.</span><span class="token function">continueWindowLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">postStartActivityProcessing</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> result<span class="token punctuation">,</span> startedActivityRootTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下面是调用的堆栈（Android13输出的，大概流程一样），感兴趣的可以依照堆栈看源码.</p> 
<pre><code class="prism language-java"><span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>ActivityTaskManagerService</span><span class="token punctuation">.</span><span class="token function">startProcessAsync</span><span class="token punctuation">(</span><span class="token class-name">ActivityTaskManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">4683</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>ActivityTaskSupervisor</span><span class="token punctuation">.</span><span class="token function">startSpecificActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityTaskSupervisor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1013</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>EnsureActivitiesVisibleHelper</span><span class="token punctuation">.</span><span class="token function">makeVisibleAndRestartIfNeeded</span><span class="token punctuation">(</span><span class="token class-name">EnsureActivitiesVisibleHelper</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">265</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>EnsureActivitiesVisibleHelper</span><span class="token punctuation">.</span><span class="token function">setActivityVisibilityState</span><span class="token punctuation">(</span><span class="token class-name">EnsureActivitiesVisibleHelper</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">191</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>EnsureActivitiesVisibleHelper</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">EnsureActivitiesVisibleHelper</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">139</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>TaskFragment</span><span class="token punctuation">.</span><span class="token function">updateActivityVisibilities</span><span class="token punctuation">(</span><span class="token class-name">TaskFragment</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">985</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>Task</span><span class="token punctuation">.</span>lambda$ensureActivitiesVisible$<span class="token function">15</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">4866</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>Task</span>$$<span class="token class-name">ExternalSyntheticLambda20</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>Task</span><span class="token punctuation">.</span><span class="token function">forAllLeafTasks</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3185</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>Task</span><span class="token punctuation">.</span><span class="token function">ensureActivitiesVisible</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">4865</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>DisplayContent</span><span class="token punctuation">.</span>lambda$ensureActivitiesVisible$<span class="token function">46</span><span class="token punctuation">(</span><span class="token class-name">DisplayContent</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">6000</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>DisplayContent</span>$$<span class="token class-name">ExternalSyntheticLambda17</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>Task</span><span class="token punctuation">.</span><span class="token function">forAllRootTasks</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3197</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>WindowContainer</span><span class="token punctuation">.</span><span class="token function">forAllRootTasks</span><span class="token punctuation">(</span><span class="token class-name">WindowContainer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1806</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>WindowContainer</span><span class="token punctuation">.</span><span class="token function">forAllRootTasks</span><span class="token punctuation">(</span><span class="token class-name">WindowContainer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1806</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>WindowContainer</span><span class="token punctuation">.</span><span class="token function">forAllRootTasks</span><span class="token punctuation">(</span><span class="token class-name">WindowContainer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1806</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>WindowContainer</span><span class="token punctuation">.</span><span class="token function">forAllRootTasks</span><span class="token punctuation">(</span><span class="token class-name">WindowContainer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1806</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>WindowContainer</span><span class="token punctuation">.</span><span class="token function">forAllRootTasks</span><span class="token punctuation">(</span><span class="token class-name">WindowContainer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1799</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>DisplayContent</span><span class="token punctuation">.</span><span class="token function">ensureActivitiesVisible</span><span class="token punctuation">(</span><span class="token class-name">DisplayContent</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">5999</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>RootWindowContainer</span><span class="token punctuation">.</span><span class="token function">ensureActivitiesVisible</span><span class="token punctuation">(</span><span class="token class-name">RootWindowContainer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2075</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>RootWindowContainer</span><span class="token punctuation">.</span><span class="token function">ensureVisibilityAndConfig</span><span class="token punctuation">(</span><span class="token class-name">RootWindowContainer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1876</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>ActivityStarter</span><span class="token punctuation">.</span><span class="token function">handleStartResult</span><span class="token punctuation">(</span><span class="token class-name">ActivityStarter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1669</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>ActivityStarter</span><span class="token punctuation">.</span><span class="token function">startActivityUnchecked</span><span class="token punctuation">(</span><span class="token class-name">ActivityStarter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1598</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>ActivityStarter</span><span class="token punctuation">.</span><span class="token function">executeRequest</span><span class="token punctuation">(</span><span class="token class-name">ActivityStarter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1185</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>ActivityStarter</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ActivityStarter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">672</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>ActivityTaskManagerService</span><span class="token punctuation">.</span><span class="token function">startActivityAsUser</span><span class="token punctuation">(</span><span class="token class-name">ActivityTaskManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1243</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>ActivityTaskManagerService</span><span class="token punctuation">.</span><span class="token function">startActivityAsUser</span><span class="token punctuation">(</span><span class="token class-name">ActivityTaskManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1215</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>IActivityTaskManager</span>$<span class="token class-name">Stub</span><span class="token punctuation">.</span><span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token class-name">IActivityTaskManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">969</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">.</span></span>ActivityTaskManagerService</span><span class="token punctuation">.</span><span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token class-name">ActivityTaskManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">5152</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Binder</span><span class="token punctuation">.</span><span class="token function">execTransactInternal</span><span class="token punctuation">(</span><span class="token class-name">Binder</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1179</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span>     at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Binder</span><span class="token punctuation">.</span><span class="token function">execTransact</span><span class="token punctuation">(</span><span class="token class-name">Binder</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1143</span><span class="token punctuation">)</span>
<span class="token class-name">ActivityTaskManager</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Throwable</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/07cc04cc782cca397bc885a656199bfe/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CTF学习笔记——ret2text</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dec8c1398a83e10e202b3fb570a5dd4e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【C&#43;&#43;】早绑定、析构与多态 | 一道关于多态的选择题记录</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>