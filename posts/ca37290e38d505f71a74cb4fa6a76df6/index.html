<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>下午好~ 我的论文【yolov5】（第四期） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="下午好~ 我的论文【yolov5】（第四期）" />
<meta property="og:description" content="文章目录 简介模型Mosaic数据增强自适应锚框计算自适应图片缩放Focus结构CSP结构 NeckCIOU_Lossnms非极大值抑制代码最后 简介 YOLO V4没过多久YOLO V5就出来了。YOLO V5的模型架构是与V4非常相近的。
模型 Yolov5官方代码中，给出的目标检测网络中一共有4个版本，分别是Yolov5s、Yolov5m、Yolov5l、Yolov5x四个模型。
Yolov5s整体的网络结构图：
图片来自：https://zhuanlan.zhihu.com/p/172121380
（1）输入端：Mosaic数据增强、自适应锚框计算、自适应图片缩放
（2）Backbone：Focus结构，CSP结构
（3）Neck：FPN&#43;PAN结构
（4）Prediction：GIOU_Loss
Mosaic数据增强 Mosaic数据增强的步骤包括：
选择四张不同的图像：从训练数据集中随机选择四张图像。
随机选取一个位置：随机选择一个位置在这四张图像中，这个位置将成为新的合成图像的中心点。
将这四张图像拼接：将选中位置的像素从四张图像中裁剪出来，然后将它们拼接在一起，形成新的合成图像。
调整目标框坐标：如果图像中包含目标框（用于目标检测的边界框），则需要相应地调整这些目标框的坐标，以反映合成图像中目标的新位置。
自适应锚框计算 在Yolo算法中，针对不同的数据集，都会有初始设定长宽的锚框。
在Yolov3、Yolov4中，训练不同的数据集时，计算初始锚框的值是通过单独的程序运行的。
但Yolov5中将此功能嵌入到代码中，每次训练时，自适应的计算不同训练集中的最佳锚框值。
传统的目标检测方法中，锚框通常是在图像中均匀分布的一组预定义框，但这种方法可能无法很好地适应不同尺度、长宽比或者特定场景下目标的变化。为了更好地适应不同的场景，自适应锚框计算采用一种动态的策略，根据数据集中的实际目标分布情况，调整生成锚框的尺度和长宽比。
自适应锚框计算可以采用以下策略：
数据统计分析： 对训练数据集进行分析，了解不同目标的尺度和长宽比分布情况。
动态调整锚框： 根据数据统计的结果，动态地调整生成锚框的尺度和长宽比，使其更符合实际场景中的目标形状和大小变化。
学习适应性参数： 有些方法还可以通过学习适应性参数的方式，让模型自动调整生成锚框的尺度和长宽比。
在yolov5x.yaml中查看锚定框的数据，如下：
# yolov5中预先设定了锚定框，这些锚框是针对coco数据集的，其他目标检测也适用。 # 这些框针对的图片大小是640x640，是默认的anchor大小。 # 需要注意的是在目标检测任务中，一般使用大特征图上去检测小目标，因为大特征图含有更多小目标信息， # 因此大特征图上的anchor数值通常设置为小数值，小特征图检测大目标，因此小特征图上anchor数值设置较大。 anchors: - [10,13, 16,30, 33,23] # P3/8 最大特征图上的锚框 - [30,61, 62,45, 59,119] # P4/16 中等特征图上的锚框 - [116,90, 156,198, 373,326] # P5/32 最小特征图上的锚框 在yolov5 中训练开始前，计算数据集标注信息针对默认锚定框的最佳召回率，当最佳召回率大于等于0.98时，则不需要更新锚定框；如果最佳召回率小于0.98，则需要重新计算数据集的锚定框，如果计算处理更好则更新原理的anchors。
def check_anchors(dataset, detect, thr=4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ca37290e38d505f71a74cb4fa6a76df6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-21T17:04:52+08:00" />
<meta property="article:modified_time" content="2023-12-21T17:04:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">下午好~ 我的论文【yolov5】（第四期）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">简介</a></li><li><a href="#_8" rel="nofollow">模型</a></li><li><ul><li><a href="#Mosaic_25" rel="nofollow">Mosaic数据增强</a></li><li><a href="#_37" rel="nofollow">自适应锚框计算</a></li><li><a href="#_409" rel="nofollow">自适应图片缩放</a></li><li><a href="#Focus_547" rel="nofollow">Focus结构</a></li><li><a href="#CSP_Neck_566" rel="nofollow">CSP结构 Neck</a></li><li><a href="#CIOU_Loss_659" rel="nofollow">CIOU_Loss</a></li><li><a href="#nms_922" rel="nofollow">nms非极大值抑制</a></li><li><a href="#_936" rel="nofollow">代码</a></li><li><a href="#_944" rel="nofollow">最后</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>简介</h2> 
<p>YOLO V4没过多久YOLO V5就出来了。YOLO V5的模型架构是与V4非常相近的。</p> 
<h2><a id="_8"></a>模型</h2> 
<p>Yolov5官方代码中，给出的目标检测网络中一共有4个版本，分别是Yolov5s、Yolov5m、Yolov5l、Yolov5x四个模型。</p> 
<p>Yolov5s整体的网络结构图：<br> <img src="https://images2.imgbox.com/51/35/BMVvIHD0_o.jpg" alt="在这里插入图片描述"><br> 图片来自：<a href="https://zhuanlan.zhihu.com/p/172121380" rel="nofollow">https://zhuanlan.zhihu.com/p/172121380</a></p> 
<p>（1）输入端：Mosaic数据增强、自适应锚框计算、自适应图片缩放<br> （2）Backbone：Focus结构，CSP结构<br> （3）Neck：FPN+PAN结构<br> （4）Prediction：GIOU_Loss</p> 
<h3><a id="Mosaic_25"></a>Mosaic数据增强</h3> 
<p>Mosaic数据增强的步骤包括：</p> 
<p>选择四张不同的图像：从训练数据集中随机选择四张图像。</p> 
<p>随机选取一个位置：随机选择一个位置在这四张图像中，这个位置将成为新的合成图像的中心点。</p> 
<p>将这四张图像拼接：将选中位置的像素从四张图像中裁剪出来，然后将它们拼接在一起，形成新的合成图像。</p> 
<p>调整目标框坐标：如果图像中包含目标框（用于目标检测的边界框），则需要相应地调整这些目标框的坐标，以反映合成图像中目标的新位置。</p> 
<p><img src="https://images2.imgbox.com/2d/95/4zlWvLKt_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_37"></a>自适应锚框计算</h3> 
<p>在Yolo算法中，针对不同的数据集，都会有初始设定长宽的锚框。</p> 
<p>在Yolov3、Yolov4中，训练不同的数据集时，计算初始锚框的值是通过单独的程序运行的。</p> 
<p>但Yolov5中将此功能嵌入到代码中，每次训练时，自适应的计算不同训练集中的最佳锚框值。</p> 
<p>传统的目标检测方法中，锚框通常是在图像中均匀分布的一组预定义框，但这种方法可能无法很好地适应不同尺度、长宽比或者特定场景下目标的变化。为了更好地适应不同的场景，自适应锚框计算采用一种动态的策略，根据数据集中的实际目标分布情况，调整生成锚框的尺度和长宽比。</p> 
<p>自适应锚框计算可以采用以下策略：</p> 
<p>数据统计分析： 对训练数据集进行分析，了解不同目标的尺度和长宽比分布情况。</p> 
<p>动态调整锚框： 根据数据统计的结果，动态地调整生成锚框的尺度和长宽比，使其更符合实际场景中的目标形状和大小变化。</p> 
<p>学习适应性参数： 有些方法还可以通过学习适应性参数的方式，让模型自动调整生成锚框的尺度和长宽比。</p> 
<p>在yolov5x.yaml中查看锚定框的数据，如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># yolov5中预先设定了锚定框，这些锚框是针对coco数据集的，其他目标检测也适用。</span>
<span class="token comment"># 这些框针对的图片大小是640x640，是默认的anchor大小。</span>
<span class="token comment"># 需要注意的是在目标检测任务中，一般使用大特征图上去检测小目标，因为大特征图含有更多小目标信息，</span>
<span class="token comment"># 因此大特征图上的anchor数值通常设置为小数值，小特征图检测大目标，因此小特征图上anchor数值设置较大。</span>
anchors<span class="token punctuation">:</span>
  <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">]</span>       <span class="token comment"># P3/8    最大特征图上的锚框</span>
  <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span><span class="token number">119</span><span class="token punctuation">]</span>      <span class="token comment"># P4/16   中等特征图上的锚框</span>
  <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">116</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">156</span><span class="token punctuation">,</span><span class="token number">198</span><span class="token punctuation">,</span> <span class="token number">373</span><span class="token punctuation">,</span><span class="token number">326</span><span class="token punctuation">]</span>  <span class="token comment"># P5/32   最小特征图上的锚框</span>

</code></pre> 
<p>在yolov5 中训练开始前，计算数据集标注信息针对默认锚定框的最佳召回率，当最佳召回率大于等于0.98时，则不需要更新锚定框；如果最佳召回率小于0.98，则需要重新计算数据集的锚定框，如果计算处理更好则更新原理的anchors。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">check_anchors</span><span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> detect<span class="token punctuation">,</span> thr<span class="token operator">=</span><span class="token number">4.0</span><span class="token punctuation">,</span> imgsz<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    # Check anchor fit to data, recompute if necessary
    检查 anchor你和数据情况, 如果不合理重新计算anchors
    输入:
        dataset - 数据集对象
        detect - 模型的最后一层，检测头
        thr - 阈值？
        imgsz - 图片大小
    """</span>
    m <span class="token operator">=</span> detect
    <span class="token comment"># 例如: shape = 640 * [1280  960] / 1280</span>
    shapes <span class="token operator">=</span> imgsz <span class="token operator">*</span> dataset<span class="token punctuation">.</span>shapes <span class="token operator">/</span> dataset<span class="token punctuation">.</span>shapes<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> keepdims<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token comment"># augment scale 随机缩放系数</span>
    scale <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">1.1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span>shapes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 计算框的wh</span>
    wh <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>l<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">*</span> s <span class="token keyword">for</span> s<span class="token punctuation">,</span> l <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>shapes <span class="token operator">*</span> scale<span class="token punctuation">,</span> dataset<span class="token punctuation">.</span>labels<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	
	<span class="token comment"># 计算指标 bpr,aat</span>
    <span class="token keyword">def</span> <span class="token function">metric</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># compute metric</span>
        r <span class="token operator">=</span> wh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">/</span> k<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">/</span> r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># ratio metric</span>
        best <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># best_x</span>
        aat <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">/</span> thr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># anchors above threshold</span>
        bpr <span class="token operator">=</span> <span class="token punctuation">(</span>best <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">/</span> thr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment"># best possible recall</span>
        <span class="token keyword">return</span> bpr<span class="token punctuation">,</span> aat

    <span class="token comment"># 计算BPR(最好的召回率)</span>
    stride <span class="token operator">=</span> m<span class="token punctuation">.</span>stride<span class="token punctuation">.</span>to<span class="token punctuation">(</span>m<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment"># model strides</span>
    anchors <span class="token operator">=</span> m<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> stride                    <span class="token comment"># current anchors</span>
    bpr<span class="token punctuation">,</span> aat <span class="token operator">=</span> metric<span class="token punctuation">(</span>anchors<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    s <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'\n</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PREFIX<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>aat<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> anchors/target, </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>bpr<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> Best Possible Recall (BPR). '</span></span>
    <span class="token comment"># 如果召回率&gt;0.98,当前的anchors是正常的</span>
    <span class="token comment"># 否则就修正anchors</span>
    <span class="token keyword">if</span> bpr <span class="token operator">&gt;</span> <span class="token number">0.98</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>s<span class="token punctuation">}</span></span><span class="token string">Current anchors are a good fit to dataset ✅'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>s<span class="token punctuation">}</span></span><span class="token string">Anchors are a poor fit to dataset ⚠️, attempting to improve...'</span></span><span class="token punctuation">)</span>
        na <span class="token operator">=</span> m<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>  <span class="token comment"># number of anchors</span>
        <span class="token comment"># 基于kmean方法重新计算 anchors</span>
        anchors <span class="token operator">=</span> kmean_anchors<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> n<span class="token operator">=</span>na<span class="token punctuation">,</span> img_size<span class="token operator">=</span>imgsz<span class="token punctuation">,</span> thr<span class="token operator">=</span>thr<span class="token punctuation">,</span> gen<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        new_bpr <span class="token operator">=</span> metric<span class="token punctuation">(</span>anchors<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment"># 如果新的anchors更好就替换</span>
        <span class="token keyword">if</span> new_bpr <span class="token operator">&gt;</span> bpr<span class="token punctuation">:</span>  <span class="token comment"># replace anchors</span>
            anchors <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>anchors<span class="token punctuation">,</span> device<span class="token operator">=</span>m<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>m<span class="token punctuation">.</span>anchors<span class="token punctuation">)</span>
            m<span class="token punctuation">.</span>anchors<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> anchors<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view_as<span class="token punctuation">(</span>m<span class="token punctuation">.</span>anchors<span class="token punctuation">)</span>
            check_anchor_order<span class="token punctuation">(</span>m<span class="token punctuation">)</span>  <span class="token comment"># must be in pixel-space (not grid-space)</span>
            m<span class="token punctuation">.</span>anchors <span class="token operator">/=</span> stride
            s <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PREFIX<span class="token punctuation">}</span></span><span class="token string">Done ✅ (optional: update model *.yaml to use these anchors in the future)'</span></span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            s <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PREFIX<span class="token punctuation">}</span></span><span class="token string">Done ⚠️ (original anchors better than new anchors, proceeding with original anchors)'</span></span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

</code></pre> 
<p>代码的主要步骤和解释：</p> 
<ol><li> <p><strong>计算框的wh：</strong></p> <pre><code class="prism language-python">wh <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>l<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">*</span> s <span class="token keyword">for</span> s<span class="token punctuation">,</span> l <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>shapes <span class="token operator">*</span> scale<span class="token punctuation">,</span> dataset<span class="token punctuation">.</span>labels<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <p>这一步计算了每个边界框（bounding box）的宽度（width）和高度（height），并将其保存在<code>wh</code>张量中。这些边界框的尺寸是通过将数据集中的标签（labels）的宽度和高度乘以随机缩放系数（<code>scale</code>）得到的。</p> </li><li> <p><strong>定义度量函数（metric）：</strong></p> <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">metric</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># compute metric</span>
    <span class="token comment"># ... （略）</span>
</code></pre> <p><code>metric</code>函数用于计算度量指标，包括最佳可能召回率（Best Possible Recall，BPR）和锚框与目标之间的适应度。它使用<code>wh</code>和输入的锚框<code>k</code>计算这些度量。</p> </li><li> <p><strong>计算当前锚框的适应度：</strong></p> <pre><code class="prism language-python">stride <span class="token operator">=</span> m<span class="token punctuation">.</span>stride<span class="token punctuation">.</span>to<span class="token punctuation">(</span>m<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment"># model strides</span>
anchors <span class="token operator">=</span> m<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> stride                    <span class="token comment"># current anchors</span>
bpr<span class="token punctuation">,</span> aat <span class="token operator">=</span> metric<span class="token punctuation">(</span>anchors<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <p>这一步将当前模型的锚框进行了一些处理，然后调用<code>metric</code>函数计算当前锚框的最佳可能召回率（BPR）和锚框数目相对于目标数目的比率（anchors/target）。这些度量值将用于判断当前锚框是否适合数据集。</p> </li><li> <p><strong>判断是否需要修正锚框：</strong></p> <pre><code class="prism language-python"><span class="token keyword">if</span> bpr <span class="token operator">&gt;</span> <span class="token number">0.98</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>s<span class="token punctuation">}</span></span><span class="token string">Current anchors are a good fit to dataset ✅'</span></span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token comment"># ... （略）</span>
</code></pre> <p>如果当前锚框的最佳可能召回率（BPR）超过了0.98，说明当前锚框适合数据集。否则，将尝试修正锚框。</p> </li><li> <p><strong>基于K均值（k-means）重新计算锚框：</strong></p> <pre><code class="prism language-python">anchors <span class="token operator">=</span> kmean_anchors<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> n<span class="token operator">=</span>na<span class="token punctuation">,</span> img_size<span class="token operator">=</span>imgsz<span class="token punctuation">,</span> thr<span class="token operator">=</span>thr<span class="token punctuation">,</span> gen<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> <p>如果需要修正锚框，就调用<code>kmean_anchors</code>函数重新计算锚框。该函数使用K均值聚类方法来根据数据集的实际情况生成新的锚框。</p> </li><li> <p><strong>比较新旧锚框的适应度：</strong></p> <pre><code class="prism language-python">new_bpr <span class="token operator">=</span> metric<span class="token punctuation">(</span>anchors<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">if</span> new_bpr <span class="token operator">&gt;</span> bpr<span class="token punctuation">:</span>  <span class="token comment"># replace anchors</span>
    <span class="token comment"># ... （略）</span>
</code></pre> <p>计算新锚框的最佳可能召回率（BPR），如果新锚框更好，则用新锚框替换模型中的锚框。</p> </li><li> <p><strong>更新模型中的锚框：</strong></p> <pre><code class="prism language-python">anchors <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>anchors<span class="token punctuation">,</span> device<span class="token operator">=</span>m<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>m<span class="token punctuation">.</span>anchors<span class="token punctuation">)</span>
m<span class="token punctuation">.</span>anchors<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> anchors<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view_as<span class="token punctuation">(</span>m<span class="token punctuation">.</span>anchors<span class="token punctuation">)</span>
check_anchor_order<span class="token punctuation">(</span>m<span class="token punctuation">)</span>  <span class="token comment"># must be in pixel-space (not grid-space)</span>
m<span class="token punctuation">.</span>anchors <span class="token operator">/=</span> stride
s <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PREFIX<span class="token punctuation">}</span></span><span class="token string">Done ✅ (optional: update model *.yaml to use these anchors in the future)'</span></span>
</code></pre> <p>将新的锚框复制到模型中，并进行一些必要的调整，确保锚框的顺序正确。更新完成后，输出一条日志消息，提示锚框已经更新。</p> </li></ol> 
<p>基于kmean计算训练数据集新的anchors</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">kmean_anchors</span><span class="token punctuation">(</span>dataset<span class="token operator">=</span><span class="token string">'./data/coco128.yaml'</span><span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> img_size<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> thr<span class="token operator">=</span><span class="token number">4.0</span><span class="token punctuation">,</span> gen<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" Creates kmeans-evolved anchors from training dataset

        Arguments:
            dataset: path to data.yaml, or a loaded dataset
            n: number of anchors
            img_size: image size used for training
            thr: anchor-label wh ratio threshold hyperparameter hyp['anchor_t'] used for training, default=4.0
            gen: generations to evolve anchors using genetic algorithm
            verbose: print all results

        Return:
            k: kmeans evolved anchors

        Usage:
            from utils.autoanchor import *; _ = kmean_anchors()
    """</span>
    <span class="token keyword">from</span> scipy<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>vq <span class="token keyword">import</span> kmeans

    npr <span class="token operator">=</span> np<span class="token punctuation">.</span>random
    thr <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> thr

    <span class="token keyword">def</span> <span class="token function">metric</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> wh<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># compute metrics</span>
        r <span class="token operator">=</span> wh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">/</span> k<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">/</span> r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># ratio metric</span>
        <span class="token comment"># x = wh_iou(wh, torch.tensor(k))  # iou metric</span>
        <span class="token keyword">return</span> x<span class="token punctuation">,</span> x<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># x, best_x</span>

    <span class="token keyword">def</span> <span class="token function">anchor_fitness</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># mutation fitness</span>
        _<span class="token punctuation">,</span> best <span class="token operator">=</span> metric<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>k<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> wh<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>best <span class="token operator">*</span> <span class="token punctuation">(</span>best <span class="token operator">&gt;</span> thr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># fitness</span>

    <span class="token keyword">def</span> <span class="token function">print_results</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        k <span class="token operator">=</span> k<span class="token punctuation">[</span>np<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span>k<span class="token punctuation">.</span>prod<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># sort small to large</span>
        x<span class="token punctuation">,</span> best <span class="token operator">=</span> metric<span class="token punctuation">(</span>k<span class="token punctuation">,</span> wh0<span class="token punctuation">)</span>
        bpr<span class="token punctuation">,</span> aat <span class="token operator">=</span> <span class="token punctuation">(</span>best <span class="token operator">&gt;</span> thr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x <span class="token operator">&gt;</span> thr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> n  <span class="token comment"># best possible recall, anch &gt; thr</span>
        s <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PREFIX<span class="token punctuation">}</span></span><span class="token string">thr=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>thr<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>bpr<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string"> best possible recall, </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>aat<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> anchors past thr\n'</span></span> \
            <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PREFIX<span class="token punctuation">}</span></span><span class="token string">n=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>n<span class="token punctuation">}</span></span><span class="token string">, img_size=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>img_size<span class="token punctuation">}</span></span><span class="token string">, metric_all=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>best<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">-mean/best, '</span></span> \
            <span class="token string-interpolation"><span class="token string">f'past_thr=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">[</span>x <span class="token operator">&gt;</span> thr<span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">-mean: '</span></span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> k<span class="token punctuation">:</span>
            s <span class="token operator">+=</span> <span class="token string">'%i,%i, '</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">round</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> verbose<span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> k

    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># *.yaml file</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            data_dict <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>  <span class="token comment"># model dict</span>
        <span class="token keyword">from</span> utils<span class="token punctuation">.</span>dataloaders <span class="token keyword">import</span> LoadImagesAndLabels
        dataset <span class="token operator">=</span> LoadImagesAndLabels<span class="token punctuation">(</span>data_dict<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> augment<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> rect<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># Get label wh</span>
    shapes <span class="token operator">=</span> img_size <span class="token operator">*</span> dataset<span class="token punctuation">.</span>shapes <span class="token operator">/</span> dataset<span class="token punctuation">.</span>shapes<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> keepdims<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    wh0 <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>l<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">*</span> s <span class="token keyword">for</span> s<span class="token punctuation">,</span> l <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>shapes<span class="token punctuation">,</span> dataset<span class="token punctuation">.</span>labels<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># wh</span>

    <span class="token comment"># Filter</span>
    i <span class="token operator">=</span> <span class="token punctuation">(</span>wh0 <span class="token operator">&lt;</span> <span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> i<span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PREFIX<span class="token punctuation">}</span></span><span class="token string">WARNING ⚠️ Extremely small objects found: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string"> of </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>wh0<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> labels are &lt;3 pixels in size'</span></span><span class="token punctuation">)</span>
    wh <span class="token operator">=</span> wh0<span class="token punctuation">[</span><span class="token punctuation">(</span>wh0 <span class="token operator">&gt;=</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>  <span class="token comment"># filter &gt; 2 pixels</span>
    <span class="token comment"># wh = wh * (npr.rand(wh.shape[0], 1) * 0.9 + 0.1)  # multiply by random scale 0-1</span>

    <span class="token comment"># Kmeans init</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PREFIX<span class="token punctuation">}</span></span><span class="token string">Running kmeans for </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>n<span class="token punctuation">}</span></span><span class="token string"> anchors on </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>wh<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> points...'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> n <span class="token operator">&lt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>wh<span class="token punctuation">)</span>  <span class="token comment"># apply overdetermined constraint</span>
        s <span class="token operator">=</span> wh<span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># sigmas for whitening</span>
        k <span class="token operator">=</span> kmeans<span class="token punctuation">(</span>wh <span class="token operator">/</span> s<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token builtin">iter</span><span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> s  <span class="token comment"># points</span>
        <span class="token keyword">assert</span> n <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span>  <span class="token comment"># kmeans may return fewer points than requested if wh is insufficient or too similar</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PREFIX<span class="token punctuation">}</span></span><span class="token string">WARNING ⚠️ switching strategies from kmeans to random init'</span></span><span class="token punctuation">)</span>
        k <span class="token operator">=</span> np<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>npr<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>n <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> img_size  <span class="token comment"># random init</span>
    wh<span class="token punctuation">,</span> wh0 <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>x<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">(</span>wh<span class="token punctuation">,</span> wh0<span class="token punctuation">)</span><span class="token punctuation">)</span>
    k <span class="token operator">=</span> print_results<span class="token punctuation">(</span>k<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token comment"># Plot</span>
    <span class="token comment"># k, d = [None] * 20, [None] * 20</span>
    <span class="token comment"># for i in tqdm(range(1, 21)):</span>
    <span class="token comment">#     k[i-1], d[i-1] = kmeans(wh / s, i)  # points, mean distance</span>
    <span class="token comment"># fig, ax = plt.subplots(1, 2, figsize=(14, 7), tight_layout=True)</span>
    <span class="token comment"># ax = ax.ravel()</span>
    <span class="token comment"># ax[0].plot(np.arange(1, 21), np.array(d) ** 2, marker='.')</span>
    <span class="token comment"># fig, ax = plt.subplots(1, 2, figsize=(14, 7))  # plot wh</span>
    <span class="token comment"># ax[0].hist(wh[wh[:, 0]&lt;100, 0],400)</span>
    <span class="token comment"># ax[1].hist(wh[wh[:, 1]&lt;100, 1],400)</span>
    <span class="token comment"># fig.savefig('wh.png', dpi=200)</span>

    <span class="token comment"># Evolve</span>
    f<span class="token punctuation">,</span> sh<span class="token punctuation">,</span> mp<span class="token punctuation">,</span> s <span class="token operator">=</span> anchor_fitness<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> k<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">0.1</span>  <span class="token comment"># fitness, generations, mutation prob, sigma</span>
    pbar <span class="token operator">=</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">,</span> bar_format<span class="token operator">=</span>TQDM_BAR_FORMAT<span class="token punctuation">)</span>  <span class="token comment"># progress bar</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> pbar<span class="token punctuation">:</span>
        v <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># mutate until a change occurs (prevent duplicates)</span>
            v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>npr<span class="token punctuation">.</span>random<span class="token punctuation">(</span>sh<span class="token punctuation">)</span> <span class="token operator">&lt;</span> mp<span class="token punctuation">)</span> <span class="token operator">*</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> npr<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token operator">*</span>sh<span class="token punctuation">)</span> <span class="token operator">*</span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span>
        kg <span class="token operator">=</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">)</span>
        fg <span class="token operator">=</span> anchor_fitness<span class="token punctuation">(</span>kg<span class="token punctuation">)</span>
        <span class="token keyword">if</span> fg <span class="token operator">&gt;</span> f<span class="token punctuation">:</span>
            f<span class="token punctuation">,</span> k <span class="token operator">=</span> fg<span class="token punctuation">,</span> kg<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            pbar<span class="token punctuation">.</span>desc <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PREFIX<span class="token punctuation">}</span></span><span class="token string">Evolving anchors with Genetic Algorithm: fitness = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>f<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">'</span></span>
            <span class="token keyword">if</span> verbose<span class="token punctuation">:</span>
                print_results<span class="token punctuation">(</span>k<span class="token punctuation">,</span> verbose<span class="token punctuation">)</span>

    <span class="token keyword">return</span> print_results<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

</code></pre> 
<p>函数<code>kmean_anchors</code>用于生成目标检测模型中的锚框（anchors）。主要步骤包括使用K均值（kmeans）聚类方法初始化锚框，然后通过遗传算法（genetic algorithm）进行锚框的进化。以下是代码的主要解释：</p> 
<ol><li> <p><strong>导入库：</strong></p> <pre><code class="prism language-python"><span class="token keyword">from</span> scipy<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>vq <span class="token keyword">import</span> kmeans
</code></pre> <p>导入了SciPy库中用于K均值聚类的函数。</p> </li><li> <p><strong>定义函数<code>kmean_anchors</code>：</strong></p> <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">kmean_anchors</span><span class="token punctuation">(</span>dataset<span class="token operator">=</span><span class="token string">'./data/coco128.yaml'</span><span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> img_size<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> thr<span class="token operator">=</span><span class="token number">4.0</span><span class="token punctuation">,</span> gen<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre> <p>这个函数接受多个参数，包括数据集路径（或加载的数据集对象）、锚框数量、图像大小、阈值、进化代数和是否输出详细信息等。</p> </li><li> <p><strong>数据处理和准备：</strong></p> <pre><code class="prism language-python">npr <span class="token operator">=</span> np<span class="token punctuation">.</span>random
thr <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> thr
</code></pre> <p>设置一些随机种子和计算阈值的倒数。</p> </li><li> <p><strong>度量计算函数<code>metric</code>：</strong></p> <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">metric</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> wh<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># compute metrics</span>
    <span class="token comment"># ... （略）</span>
</code></pre> <p>该函数用于计算度量指标，包括比率指标和最佳可能召回率。</p> </li><li> <p><strong>适应度函数<code>anchor_fitness</code>：</strong></p> <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">anchor_fitness</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># mutation fitness</span>
    <span class="token comment"># ... （略）</span>
</code></pre> <p>该函数计算基于变异的适应度，用于评估锚框的质量。</p> </li><li> <p><strong>结果打印函数<code>print_results</code>：</strong></p> <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">print_results</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ... （略）</span>
</code></pre> <p>该函数用于打印和返回计算结果，包括最佳可能召回率、锚框数量、锚框的平均度量值等。</p> </li><li> <p><strong>加载数据集：</strong></p> <pre><code class="prism language-python"><span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># *.yaml file</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        data_dict <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>  <span class="token comment"># model dict</span>
    <span class="token keyword">from</span> utils<span class="token punctuation">.</span>dataloaders <span class="token keyword">import</span> LoadImagesAndLabels
    dataset <span class="token operator">=</span> LoadImagesAndLabels<span class="token punctuation">(</span>data_dict<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> augment<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> rect<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> <p>如果输入的数据集是字符串路径，就加载数据集。</p> </li><li> <p><strong>获取标签尺寸信息：</strong></p> <pre><code class="prism language-python">shapes <span class="token operator">=</span> img_size <span class="token operator">*</span> dataset<span class="token punctuation">.</span>shapes <span class="token operator">/</span> dataset<span class="token punctuation">.</span>shapes<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> keepdims<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
wh0 <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>l<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">*</span> s <span class="token keyword">for</span> s<span class="token punctuation">,</span> l <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>shapes<span class="token punctuation">,</span> dataset<span class="token punctuation">.</span>labels<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># wh</span>
</code></pre> <p>从数据集中获取标签的尺寸信息，并计算标签的宽度和高度。</p> </li><li> <p><strong>过滤极小的目标：</strong></p> <pre><code class="prism language-python">i <span class="token operator">=</span> <span class="token punctuation">(</span>wh0 <span class="token operator">&lt;</span> <span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> i<span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PREFIX<span class="token punctuation">}</span></span><span class="token string">WARNING ⚠️ Extremely small objects found: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string"> of </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>wh0<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> labels are &lt;3 pixels in size'</span></span><span class="token punctuation">)</span>
wh <span class="token operator">=</span> wh0<span class="token punctuation">[</span><span class="token punctuation">(</span>wh0 <span class="token operator">&gt;=</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>  <span class="token comment"># filter &gt; 2 pixels</span>
</code></pre> <p>过滤掉宽度或高度小于3像素的目标，并保留宽度或高度大于等于2像素的目标。</p> </li><li> <p><strong>K均值初始化锚框：</strong></p> <pre><code class="prism language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PREFIX<span class="token punctuation">}</span></span><span class="token string">Running kmeans for </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>n<span class="token punctuation">}</span></span><span class="token string"> anchors on </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>wh<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> points...'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> n <span class="token operator">&lt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>wh<span class="token punctuation">)</span>  <span class="token comment"># apply overdetermined constraint</span>
    s <span class="token operator">=</span> wh<span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># sigmas for whitening</span>
    k <span class="token operator">=</span> kmeans<span class="token punctuation">(</span>wh <span class="token operator">/</span> s<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token builtin">iter</span><span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> s  <span class="token comment"># points</span>
    <span class="token keyword">assert</span> n <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span>  <span class="token comment"># kmeans may return fewer points than requested if wh is insufficient or too similar</span>
<span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PREFIX<span class="token punctuation">}</span></span><span class="token string">WARNING ⚠️ switching strategies from kmeans to random init'</span></span><span class="token punctuation">)</span>
    k <span class="token operator">=</span> np<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>npr<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>n <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> img_size  <span class="token comment"># random init</span>
</code></pre> <p>尝试使用K均值方法初始化锚框，如果出现异常（例如，聚类数目少于要求或标签信息不足），则切换到随机初始化锚框。</p> </li><li> <p><strong>锚框数据准备：</strong></p> <pre><code class="prism language-python">wh<span class="token punctuation">,</span> wh0 <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>x<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">(</span>wh<span class="token punctuation">,</span> wh0<span class="token punctuation">)</span><span class="token punctuation">)</span>
k <span class="token operator">=</span> print_results<span class="token punctuation">(</span>k<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> <p>将计算得到的锚框和相关数据准备成PyTorch张量，并进行一次结果打印。</p> </li><li> <p><strong>锚框进化（遗传算法）：</strong></p> <pre><code class="prism language-python">f<span class="token punctuation">,</span> sh<span class="token punctuation">,</span> mp<span class="token punctuation">,</span> s <span class="token operator">=</span> anchor_fitness<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> k<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">0.1</span>  <span class="token comment"># fitness, generations, mutation prob, sigma</span>
pbar <span class="token operator">=</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">,</span> bar_format<span class="token operator">=</span>TQDM_BAR_FORMAT<span class="token punctuation">)</span>  <span class="token comment"># progress bar</span>
<span class="token keyword">for</span> _ <span class="token keyword">in</span> pbar<span class="token punctuation">:</span>
    v <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># mutate until a change occurs (prevent duplicates)</span>
        v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>npr<span class="token punctuation">.</span>random<span class="token punctuation">(</span>sh<span class="token punctuation">)</span> <span class="token operator">&lt;</span> mp<span class="token punctuation">)</span> <span class="token operator">*</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> npr<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token operator">*</span>sh<span class="token punctuation">)</span> <span class="token operator">*</span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span>
    kg <span class="token operator">=</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">)</span>
    fg <span class="token operator">=</span> anchor_fitness<span class="token punctuation">(</span>kg<span class="token punctuation">)</span>
    <span class="token keyword">if</span> fg <span class="token operator">&gt;</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">,</span> k <span class="token operator">=</span> fg<span class="token punctuation">,</span> kg<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pbar<span class="token punctuation">.</span>desc <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PREFIX<span class="token punctuation">}</span></span><span class="token string">Evolving anchors with Genetic Algorithm: fitness = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>f<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">'</span></span>
        <span class="token keyword">if</span> verbose<span class="token punctuation">:</span>
            print_results<span class="token punctuation">(</span>k<span class="token punctuation">,</span> verbose<span class="token punctuation">)</span>
</code></pre> <p>使用遗传算法对锚框进行进化，不断变异和评估锚框的适应度，最终得到适应度最好的锚框。</p> </li><li> <p><strong>返回最终锚框：</strong></p> <pre><code class="prism language-python"><span class="token keyword">return</span> print_results<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
</code></pre> <p>返回经过进化算法得到的最终锚框，并打印最终结果。</p> </li></ol> 
<h3><a id="_409"></a>自适应图片缩放</h3> 
<p>YOLOV5中相比于之前的版本，有很多小trick，导致其性能和应用比较好。</p> 
<p>在目标检测中，输入的图片尺寸有大有小，根据前人的实验结果，输入网络的尺寸统一缩放到同一个尺寸时，检测效果会更好。</p> 
<p>简单的使用resize操作可能导致信息的丢失，这主要是因为在改变图像的尺寸时，像素值的重新分布和插值操作可能引入失真。</p> 
<p>插值操作： 在resize过程中，由于目标尺寸与原始尺寸不匹配，算法需要估计新尺寸上每个像素的值。常见的插值算法包括最近邻插值、双线性插值和双立方插值。这些插值方法都引入了一定的信息损失。</p> 
<p>失真和形变： 简单的resize可能导致图像的失真和形变，特别是在缩小尺寸的情况下。这可能导致对象的形状发生变化，从而影响后续的视觉任务。</p> 
<p>分辨率丧失： 缩小图像尺寸会导致分辨率的降低，从而丢失一些细节信息。</p> 
<p>这时就有个问题，如果是简单的使用resize，很有可能就造成了图片信息的丢失，所以提出了letterbox自适应图片缩放技术。</p> 
<p>train中放入的图片并不经过letterbox，而是检测的时候使用letterbox。</p> 
<p><code>Letterbox</code> 这个词的字面意思是“信箱”或“邮箱”，通常是指门或围栏上的一个盒子，用于接收信件或其他物品。在摄影和图像处理的上下文中，<code>letterbox</code> 这个词经常被用来描述一种图像调整的方法，该方法通过在图像周围添加边框（类似于信箱的概念）来适应不同的尺寸或宽高比例，以确保图像在显示或处理过程中不会失真或变形。</p> 
<p>letterbox的主要思想是尽可能的利用网络感受野的信息特征。比如在YOLOV5中最后一层的Stride=5，即最后一层的特征图中每个点，可以对应原图中32X32的区域信息，那么只要在保证整体图片变换比例一致的情况下，长宽均可以被32整除，那么就可以有效的利用感受野的信息。</p> 
<p>具体来说，图片变换比例一致指的是，长宽的收缩比例应该采用相同的比例。有效利用感受野信息则指对于收缩后不满足条件的一边，用灰白填充至可以被感受野整除。下面举例说明。</p> 
<p>假设图片原来尺寸为（1080， 1920），我们想要resize的尺寸为（640，640）。要想满足收缩的要求，应该选取收缩比例640/1920 = 0.33.则图片被缩放为（360，640）.下一步则要填充灰白边至360可以被32整除，则应该填充至384，最终得到图片尺寸（384，640）</p> 
<p>而其实letterbox的实现也十分简单，以下将结合代码讲解步骤。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">letterbox</span><span class="token punctuation">(</span>im<span class="token punctuation">,</span> new_shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">)</span><span class="token punctuation">,</span> auto<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> scaleFill<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Resize and pad image while meeting stride-multiple constraints</span>
    shape <span class="token operator">=</span> im<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># current shape [height, width]</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>new_shape<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        new_shape <span class="token operator">=</span> <span class="token punctuation">(</span>new_shape<span class="token punctuation">,</span> new_shape<span class="token punctuation">)</span>
   
    <span class="token comment"># Scale ratio (new / old)</span>
    r <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>new_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> new_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
 
    <span class="token comment"># Compute padding</span>
    ratio <span class="token operator">=</span> r<span class="token punctuation">,</span> r  <span class="token comment"># width, height ratios</span>
    new_unpad <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    dw<span class="token punctuation">,</span> dh <span class="token operator">=</span> new_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> new_unpad<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> new_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> new_unpad<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># wh padding</span>
    <span class="token keyword">if</span> auto<span class="token punctuation">:</span>  <span class="token comment"># minimum rectangle</span>
        dw<span class="token punctuation">,</span> dh <span class="token operator">=</span> np<span class="token punctuation">.</span>mod<span class="token punctuation">(</span>dw<span class="token punctuation">,</span> stride<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>mod<span class="token punctuation">(</span>dh<span class="token punctuation">,</span> stride<span class="token punctuation">)</span>  <span class="token comment"># wh padding</span>
 
    dw <span class="token operator">/=</span> <span class="token number">2</span>  <span class="token comment"># divide padding into 2 sides</span>
    dh <span class="token operator">/=</span> <span class="token number">2</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>dw<span class="token punctuation">,</span> dh<span class="token punctuation">)</span>
    <span class="token keyword">if</span> shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> new_unpad<span class="token punctuation">:</span>  <span class="token comment"># resize</span>
        im <span class="token operator">=</span> cv<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>im<span class="token punctuation">,</span> new_unpad<span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">)</span>
    top<span class="token punctuation">,</span> bottom <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dh <span class="token operator">-</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dh <span class="token operator">+</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    left<span class="token punctuation">,</span> right <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dw <span class="token operator">-</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dw <span class="token operator">+</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    im <span class="token operator">=</span> cv<span class="token punctuation">.</span>copyMakeBorder<span class="token punctuation">(</span>im<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> cv<span class="token punctuation">.</span>BORDER_CONSTANT<span class="token punctuation">,</span> value<span class="token operator">=</span>color<span class="token punctuation">)</span>  <span class="token comment"># add border</span>
    <span class="token keyword">return</span> im<span class="token punctuation">,</span> ratio<span class="token punctuation">,</span> <span class="token punctuation">(</span>dw<span class="token punctuation">,</span> dh<span class="token punctuation">)</span>
</code></pre> 
<p><code>letterbox</code>的函数，用于对输入的图像进行缩放和填充，以满足指定的尺寸要求和stride要求。</p> 
<ol><li> <p><strong>获取输入图像的形状：</strong></p> <pre><code class="prism language-python">shape <span class="token operator">=</span> im<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># current shape [height, width]</span>
</code></pre> <p>这行代码获取输入图像的高度和宽度。</p> </li><li> <p><strong>处理<code>new_shape</code>参数：</strong></p> <pre><code class="prism language-python"><span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>new_shape<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    new_shape <span class="token operator">=</span> <span class="token punctuation">(</span>new_shape<span class="token punctuation">,</span> new_shape<span class="token punctuation">)</span>
</code></pre> <p>如果<code>new_shape</code>是整数，将其转换为元组。</p> </li><li> <p><strong>计算缩放比例：</strong></p> <pre><code class="prism language-python">r <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>new_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> new_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <p>计算缩放比例，以确保图像适应新的尺寸，同时保持宽高比例。</p> </li><li> <p><strong>计算填充信息：</strong></p> <pre><code class="prism language-python">ratio <span class="token operator">=</span> r<span class="token punctuation">,</span> r  <span class="token comment"># width, height ratios</span>
new_unpad <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span>
dw<span class="token punctuation">,</span> dh <span class="token operator">=</span> new_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> new_unpad<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> new_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> new_unpad<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># wh padding</span>
</code></pre> <p>计算缩放后图像的尺寸，并计算需要填充的宽度和高度。</p> </li><li> <p><strong>自适应最小矩形：</strong></p> <pre><code class="prism language-python"><span class="token keyword">if</span> auto<span class="token punctuation">:</span>  <span class="token comment"># minimum rectangle</span>
    dw<span class="token punctuation">,</span> dh <span class="token operator">=</span> np<span class="token punctuation">.</span>mod<span class="token punctuation">(</span>dw<span class="token punctuation">,</span> stride<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>mod<span class="token punctuation">(</span>dh<span class="token punctuation">,</span> stride<span class="token punctuation">)</span>  <span class="token comment"># wh padding</span>
</code></pre> <p>如果启用了<code>auto</code>选项，确保填充的宽度和高度是stride的整数倍，以保持最小矩形。</p> </li><li> <p><strong>分配填充到两侧：</strong></p> <pre><code class="prism language-python">dw <span class="token operator">/=</span> <span class="token number">2</span>  <span class="token comment"># divide padding into 2 sides</span>
dh <span class="token operator">/=</span> <span class="token number">2</span>
</code></pre> <p>将填充均匀分配到图像的两侧。</p> </li><li> <p><strong>调整图像大小：</strong></p> <pre><code class="prism language-python"><span class="token keyword">if</span> shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> new_unpad<span class="token punctuation">:</span>  <span class="token comment"># resize</span>
    im <span class="token operator">=</span> cv<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>im<span class="token punctuation">,</span> new_unpad<span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">)</span>
</code></pre> <p>如果缩放后的图像尺寸与目标尺寸不同，使用线性插值调整图像大小。</p> </li><li> <p><strong>边框填充：</strong></p> <pre><code class="prism language-python">top<span class="token punctuation">,</span> bottom <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dh <span class="token operator">-</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dh <span class="token operator">+</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
left<span class="token punctuation">,</span> right <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dw <span class="token operator">-</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dw <span class="token operator">+</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
im <span class="token operator">=</span> cv<span class="token punctuation">.</span>copyMakeBorder<span class="token punctuation">(</span>im<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> cv<span class="token punctuation">.</span>BORDER_CONSTANT<span class="token punctuation">,</span> value<span class="token operator">=</span>color<span class="token punctuation">)</span>  <span class="token comment"># add border</span>
</code></pre> <p>使用OpenCV的<code>copyMakeBorder</code>函数，以指定的颜色填充图像的边框。</p> </li><li> <p><strong>返回结果：</strong></p> <pre><code class="prism language-python"><span class="token keyword">return</span> im<span class="token punctuation">,</span> ratio<span class="token punctuation">,</span> <span class="token punctuation">(</span>dw<span class="token punctuation">,</span> dh<span class="token punctuation">)</span>
</code></pre> <p>返回处理后的图像、缩放比例和填充信息。</p> </li></ol> 
<p>需要注意的是：</p> 
<p>a.这里填充的是黑色，即（0，0，0），而Yolov5中填充的是灰色，即（114,114,114），都是一样的效果。</p> 
<p>b.训练时没有采用缩减黑边的方式，还是采用传统填充的方式，即缩放到416*416大小。只是在测试，使用模型推理时，才采用缩减黑边的方式，提高目标检测，推理的速度。</p> 
<p>c.为什么np.mod函数的后面用32？因为Yolov5的网络经过5次下采样，而2的5次方，等于32。所以至少要去掉32的倍数，再进行取余。</p> 
<hr> 
<p>这种方式在之前github上Yolov3中也进行了讨论：<a href="https://github.com/ultralytics/yolov3/issues/232">https://github.com/ultralytics/yolov3/issues/232</a></p> 
<p>在讨论中，通过这种简单的改进，推理速度得到了37%的提升，可以说效果很明显。</p> 
<p><img src="https://images2.imgbox.com/aa/c0/FgVUVOK9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Focus_547"></a>Focus结构</h3> 
<p>资料参考：<a href="https://blog.csdn.net/qq_39056987/article/details/112712817">https://blog.csdn.net/qq_39056987/article/details/112712817</a><br> Focus模块是在V5版本中的一个图像处理模块，其主要作用是在图像输入到卷积神经网络的backbone之前进行切片操作。该模块通过在一张图片中每隔一个像素提取一个值，实现类似邻近下采样的效果，从而生成四张互补且大小相近的图片。这一操作将宽度（W）和高度（H）的信息集中到了通道空间。因此，输入通道数扩展了4倍，即将这四张图片拼接在一起，使得相对于原始的RGB三通道模式，通道数增至12。最后，经过卷积操作，得到没有信息丢失的二倍下采样特征图。<br> <img src="https://images2.imgbox.com/50/5a/sJDhnYpF_o.png" alt="在这里插入图片描述"><br> 代码实现：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Focus</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Focus wh information into c-space</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># ch_in, ch_out, kernel, stride, padding, groups</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Focus<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1 <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token punctuation">,</span> s<span class="token punctuation">,</span> p<span class="token punctuation">,</span> g<span class="token punctuation">,</span> act<span class="token punctuation">)</span>      <span class="token comment"># 这里输入通道变成了4倍</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># x(b,c,w,h) -&gt; y(b,4c,w/2,h/2)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<p>YOLOv5s 6.0版本之后，然而又改回卷积了。</p> 
<h3><a id="CSP_Neck_566"></a>CSP结构 Neck</h3> 
<p>Yolov5现在的Neck和Yolov4中一样，都采用FPN+PAN的结构，但在Yolov5刚出来时，只使用了FPN结构，后面才增加了PAN结构，此外网络中其他部分也进行了调整。</p> 
<p>Yolov4的Neck结构中，采用的都是普通的卷积操作。而Yolov5的Neck结构中，采用借鉴CSPnet设计的CSP2结构，加强网络特征融合的能力。</p> 
<p>Yolov4网络结构中，借鉴了CSPNet的设计思路，在主干网络中设计了CSP结构。</p> 
<p>Yolov5与Yolov4不同点在于，Yolov4中只有主干网络使用了CSP结构。</p> 
<p>而Yolov5中设计了两种CSP结构，以Yolov5s网络为例，CSP1_X结构应用于Backbone主干网络，另一种CSP2_X结构则应用于Neck中。</p> 
<p><img src="https://images2.imgbox.com/92/d4/J6e7nLLS_o.jpg" alt="在这里插入图片描述"><br> 图片出处：<a href="https://zhuanlan.zhihu.com/p/172121380" rel="nofollow">https://zhuanlan.zhihu.com/p/172121380</a></p> 
<p>CSPNet全称是Cross Stage Paritial Network，主要从网络结构设计的角度解决推理中从计算量很大的问题。</p> 
<p>CSPNet的作者认为推理计算过高的问题是由于网络优化中的梯度信息重复导致的。</p> 
<p>因此采用CSP模块先将基础层的特征映射划分为两部分，然后通过跨阶段层次结构将它们合并，在减少了计算量的同时可以保证准确率。</p> 
<p>CSPNet论文地址：<a href="https://arxiv.org/pdf/1911.11929.pdf" rel="nofollow">https://arxiv.org/pdf/1911.11929.pdf</a><br> <img src="https://images2.imgbox.com/25/95/GnfhAMl2_o.png" alt="在这里插入图片描述"><br> 左为原始的Dense Block，右者为Partial Dense Block。假设将输入按照part_ratio=0.5的比例分成两部分，并且假设一个Dense Block的输入为w * h * c，growth rate为 d，Dense block的layer数量为m，</p> 
<p>CIO （Convolutional input/Output）<br> 对于原始的DenseBlock<code>CIO = cm + [(mm+m)d]/2</code><br> 而对于使用了CSP结构的结构来说，<code>CIO = [cm + (mm+m)d]/2</code></p> 
<p>代码实现：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">DenseBlock</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_channels<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span> growth_rate<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DenseBlock<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>num_layers <span class="token operator">=</span> num_layers
        self<span class="token punctuation">.</span>k0 <span class="token operator">=</span> input_channels
        self<span class="token punctuation">.</span>k <span class="token operator">=</span> growth_rate
        self<span class="token punctuation">.</span>layers <span class="token operator">=</span> self<span class="token punctuation">.</span>__make_layers<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__make_layers</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        layer_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_layers<span class="token punctuation">)</span><span class="token punctuation">:</span>
            layer_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                BN_Conv2d<span class="token punctuation">(</span>self<span class="token punctuation">.</span>k0 <span class="token operator">+</span> i <span class="token operator">*</span> self<span class="token punctuation">.</span>k<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>k<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                BN_Conv2d<span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>k<span class="token punctuation">,</span> self<span class="token punctuation">.</span>k<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> layer_list

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        feature <span class="token operator">=</span> self<span class="token punctuation">.</span>layers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        out <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> feature<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>layers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            feature <span class="token operator">=</span> self<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
            out <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>feature<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> out


<span class="token keyword">class</span> <span class="token class-name">CSP_DenseBlock</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span> k<span class="token punctuation">,</span> part_ratio<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>CSP_DenseBlock<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>part1_chnls <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>in_channels <span class="token operator">*</span> part_ratio<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>part2_chnls <span class="token operator">=</span> in_channels <span class="token operator">-</span> self<span class="token punctuation">.</span>part1_chnls
        self<span class="token punctuation">.</span>dense <span class="token operator">=</span> DenseBlock<span class="token punctuation">(</span>self<span class="token punctuation">.</span>part2_chnls<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span> k<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        part1 <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>self<span class="token punctuation">.</span>part1_chnls<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
        part2 <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>part1_chnls<span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
        part2 <span class="token operator">=</span> self<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>part2<span class="token punctuation">)</span>
        out <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>part1<span class="token punctuation">,</span> part2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> out
</code></pre> 
<p><code>DenseBlock</code> 类：</p> 
<ul><li> <p><code>__init__</code>：使用指定的参数（<code>input_channels</code>，输入通道维度，<code>num_layers</code>，密集块中的层数，以及<code>growth_rate</code>，通道数量的增长率）初始化<code>DenseBlock</code>模块。</p> </li><li> <p><code>__make_layers</code>：创建密集块层的私有方法。它通过指定数量的层（<code>num_layers</code>）迭代，并将一个由自定义<code>BN_Conv2d</code>模块构成的卷积层对附加到<code>layer_list</code>。第一卷积层的输出通道大小为<code>4 * self.k</code>（其中<code>self.k</code>是增长率），第二卷积层的输出通道大小为<code>self.k</code>。</p> </li><li> <p><code>forward</code>：定义<code>DenseBlock</code>的前向传播。它通过层进行迭代，将输入张量与每个层的输出连接起来。结果作为密集块的输出返回。</p> </li></ul> 
<p><code>CSP_DenseBlock</code> 类：</p> 
<ul><li> <p><code>__init__</code>：使用指定的参数（<code>in_channels</code>，输入通道维度，<code>num_layers</code>，密集块中的层数，<code>k</code>，通道数量的增长率，以及可选的<code>part_ratio</code>参数，默认值为0.5，表示第一部分中通道的比例）初始化<code>CSP_DenseBlock</code>模块。</p> </li><li> <p><code>forward</code>：定义<code>CSP_DenseBlock</code>的前向传播。它根据指定的通道比率将输入张量分割成两部分（<code>part1</code>和<code>part2</code>）。然后，通过<code>DenseBlock</code>模块处理第二部分（<code>part2</code>）。最后，通过连接<code>part1</code>和<code>DenseBlock</code>的输出获得输出。</p> </li></ul> 
<h3><a id="CIOU_Loss_659"></a>CIOU_Loss</h3> 
<p>Yolov5中采用其中的CIOU_Loss做Bounding box的损失函数。</p> 
<p>Yolov4中也采用CIOU_Loss作为目标Bounding box的损失。</p> 
<p>下面介绍一下IOU loss的发展过程：<br> Intersection over Union (IoU)是用于评估目标检测模型性能的常见指标之一。IoU是通过计算预测框和真实目标框之间的交集面积与它们的并集面积的比例来衡量的。具体而言，IoU的计算公式如下：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          I 
         
        
          o 
         
        
          U 
         
        
          = 
         
         
         
           Intersection Area 
          
         
           Union Area 
          
         
        
       
         IoU = \frac{\text{Intersection Area}}{\text{Union Area}} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right: 0.109em;">U</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.0463em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord text"><span class="mord">Union Area</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord text"><span class="mord">Intersection Area</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<p><strong>GIoU:</strong><br> <img src="https://images2.imgbox.com/d9/18/3i0QzryA_o.png" alt="在这里插入图片描述"><br> GIoU参考资料：<br> <a href="https://giou.stanford.edu/" rel="nofollow">https://giou.stanford.edu/</a><br> <a href="https://sh-tsang.medium.com/review-giou-generalized-intersection-over-union-b4dd1ab89493" rel="nofollow">https://sh-tsang.medium.com/review-giou-generalized-intersection-over-union-b4dd1ab89493</a></p> 
<p>在对象检测中，IoU被用作评估预测边界框与地面实况的接近程度的度量。在上面的第一个例子中，预测和地面实况边界框重叠，因此IoU的值是非零的。让我们看一个IoU不足的例子。</p> 
<p>当预测框和目标框不相交时，它们的交集面积为零。这意味着分母中的并集面积就是两者的面积之和。因此，IoU的计算将变为零除以非零的值，结果将始终为零。</p> 
<p>设(A)为预测框的区域，(B)为目标框的区域。如果<span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          A 
         
        
          ∩ 
         
        
          B 
         
        
          = 
         
        
          ∅ 
         
        
          ) 
         
        
       
         (A \cap B = \emptyset) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∩</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">∅</span><span class="mclose">)</span></span></span></span></span></span>交集为空，那么<span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          I 
         
        
          o 
         
        
          U 
         
        
          = 
         
         
         
           0 
          
          
          
            A 
           
          
            ∪ 
           
          
            B 
           
          
         
        
          = 
         
        
          0 
         
        
       
         IoU = \frac{0}{A \cup B} = 0 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right: 0.109em;">U</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.0074em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3214em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0</span></span></span></span></span></span>在这种情况下，IoU的值为零，说明两个框不相交。</p> 
<p>如果我们进行了一个糟糕的预测，其中预测的边界框与基本事实没有重叠，该怎么办。在这种情况下，以及在地面实况和预测边界框之间没有重叠的任何其他情况下，交集为0，因此IoU也将为0。如果IoU即使在没有交集的情况下，我们新的、更好的预测也比第一个预测更接近地面实况，那就太好了。</p> 
<p><a href="https://arxiv.org/abs/1902.09630" rel="nofollow">《Generalized Intersection over Union: A Metric and A Loss for Bounding Box Regression》</a><br> 于是提出了一个解决方案，GIoU，其公式如下：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
            
              G 
             
            
              I 
             
            
              o 
             
            
              U 
             
            
              = 
             
             
              
              
                ∣ 
               
              
                A 
               
              
                ∩ 
               
              
                B 
               
              
                ∣ 
               
              
              
              
                ∣ 
               
              
                A 
               
              
                ∪ 
               
              
                B 
               
              
                ∣ 
               
              
             
            
              − 
             
             
              
              
                ∣ 
               
              
                C 
               
              
                \ 
               
              
                ( 
               
              
                A 
               
              
                ∪ 
               
              
                B 
               
              
                ) 
               
              
                ∣ 
               
              
              
              
                ∣ 
               
              
                C 
               
              
                ∣ 
               
              
             
            
              = 
             
            
              I 
             
            
              o 
             
            
              U 
             
            
           
          
         
         
          
           
            
            
              − 
             
             
              
              
                ∣ 
               
              
                C 
               
              
                \ 
               
              
                ( 
               
              
                A 
               
              
                ∪ 
               
              
                B 
               
              
                ) 
               
              
                ∣ 
               
              
              
              
                ∣ 
               
              
                C 
               
              
                ∣ 
               
              
             
            
           
          
         
        
       
         \begin{gathered}GIoU=\frac{|A\cap B|}{|A\cup B|}-\frac{|C\backslash(A\cup B)|}{|C|}=IoU\\-\frac{|C\backslash(A\cup B)|}{|C|}\end{gathered} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 5.326em; vertical-align: -2.413em;"></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.913em;"><span class="" style="top: -4.913em;"><span class="pstrut" style="height: 3.427em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="mord mathnormal" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right: 0.109em;">U</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="mord">∣</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∩</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="mord">∣</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord mathnormal" style="margin-right: 0.0715em;">C</span><span class="mord">∣</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord mathnormal" style="margin-right: 0.0715em;">C</span><span class="mord">\</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="mclose">)</span><span class="mord">∣</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord mathnormal" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right: 0.109em;">U</span></span></span><span class="" style="top: -2.25em;"><span class="pstrut" style="height: 3.427em;"></span><span class="mord"><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord mathnormal" style="margin-right: 0.0715em;">C</span><span class="mord">∣</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord mathnormal" style="margin-right: 0.0715em;">C</span><span class="mord">\</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="mclose">)</span><span class="mord">∣</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.413em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>其中A和B是预测和实际边界框。C是包含A和B的最小凸包。</p> 
<p>我们首先找到了包围A和B的最小凸包C 。然后，我们计算C（不包括A和B）所占的体积（面积）除以C所占的总体积（面积）。在更好预测的情况下，C的面积会更小，所有其他值保持不变。IoU都将为0。因此，随着预测向地面实况移动，减去较小的值，GIoU的值增加</p> 
<p>在一个实数向量空间V中，对于给定集合X所有包含X的凸集的交集S为X的凸包。<br> <img src="https://images2.imgbox.com/93/32/ufDW2FNM_o.png" alt="在这里插入图片描述"></p> 
<p>在点集拓扑学与欧几里得空间中，凸集（Convex set）是一个点集合，其中每两点之间的线段点都落在该点集合中。<br> <img src="https://images2.imgbox.com/e8/19/StcqPx9y_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/a5/a7/S5EYt7Rj_o.png" alt="在这里插入图片描述"></p> 
<p>随着预测向地面实况移动，减去较小的值，GIoU的值增加<br> <img src="https://images2.imgbox.com/53/65/2s67Lbdo_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/a0/5c/cfySRrSJ_o.png" alt="在这里插入图片描述"></p> 
<p>回想一下，在神经网络中，任何给定的损失函数都必须是可微分的，才能允许反向传播。我们从上面的例子中看到，在没有交集的情况下，IoU没有值，因此没有梯度。然而，GIoU总是可微的。<br> 我们对预测边界框与地面实况重叠（即相交）的情况和没有相交的情况进行了采样。这些样本的IoU和GIoU之间的关系如图所示。<br> 从图中可以看出，与上述公式一样，GIoU的范围从-1到1。当包围两个边界框的面积（例如C）大于IoU时，会出现负值。随着IoU分量的增加，GIoU的值收敛到IoU。<br> <img src="https://images2.imgbox.com/8d/73/m16uRQOa_o.png" alt="在这里插入图片描述"><br> 然而GIoU有一个问题，一旦预测框和目标框出现包含关系，或者宽和高对齐的情况，差集为0，GIoU就退化成了IoU，无法评估相对位置，收敛缓慢。<br> <img src="https://images2.imgbox.com/2a/b0/lOqZdupd_o.png" alt="在这里插入图片描述"><br> 我们可以从图中观察到，图3即使在250次迭代后，预测框（蓝色）也会扩展到与目标框（绿色）重叠，并且在预测框的中心坐标中只有很小的位移。图4中的垂直拉伸也是如此。因此，尤其是对于水平和垂直方向的盒子GIoU损失收敛缓慢。</p> 
<p><strong>DIoU：</strong></p> 
<p>Distance-IoU：<a href="https://arxiv.org/abs/1911.08287" rel="nofollow">https://arxiv.org/abs/1911.08287</a><br> 参考资料：<a href="https://medium.com/visionwizard/understanding-diou-loss-a-quick-read-a4a0fbcbf0f0" rel="nofollow">https://medium.com/visionwizard/understanding-diou-loss-a-quick-read-a4a0fbcbf0f0</a></p> 
<p>DIoU（距离-并集上的交集）损失函数包含预测框和目标框之间的归一化距离。</p> 
<p>它不仅继承了IoU和GIoU的属性，还解决了它们都表现不佳的问题：它直接最小化了两个盒子的距离，因此收敛速度比GIoU损失快得多，尤其是在非重叠的情况下。</p> 
<p>它还考虑了垂直和水平方向（图3和图4）DIoU可以更快地解决回归问题的情况。</p> 
<p>令<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         R 
        
       
         ( 
        
       
         B 
        
       
         , 
        
        
        
          B 
         
         
         
           g 
          
         
           t 
          
         
        
       
         ) 
        
       
      
        \mathcal{R}(B,B^{gt}) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0436em; vertical-align: -0.25em;"></span><span class="mord mathcal">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7936em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 是预测框 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         B 
        
       
      
        B 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span></span></span></span></span> 和目标框 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          B 
         
         
         
           g 
          
         
           t 
          
         
        
       
      
        B^{gt} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7936em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7936em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span></span></span></span></span>的惩罚项。</p> 
<p>通常基于IoU的损失所提出的方法可以定义为<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          L 
         
        
          = 
         
        
          1 
         
        
          − 
         
        
          I 
         
        
          o 
         
        
          U 
         
        
          + 
         
        
          R 
         
        
          ( 
         
        
          B 
         
        
          , 
         
         
         
           B 
          
          
          
            g 
           
          
            t 
           
          
         
        
          ) 
         
        
          , 
         
        
       
         \mathcal{L}=1-IoU+\mathcal{R}(B,B^{gt}), 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathcal">L</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;"></span><span class="mord mathnormal" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right: 0.109em;">U</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.0936em; vertical-align: -0.25em;"></span><span class="mord mathcal">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8436em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span></span></span></span></span></span></p> 
<p>其中，b和b<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
         
           g 
          
         
           t 
          
         
        
       
      
        ^{gt} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7936em;"></span><span class="mord"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7936em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span></span></span></span></span>表示<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         b 
        
       
      
        b 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          b 
         
         
         
           g 
          
         
           t 
          
         
        
       
      
        b^{gt} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7936em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7936em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span></span></span></span></span> 的中心点，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ρ 
        
       
         （ 
        
       
         ⋅ 
        
       
         ） 
        
       
      
        \rho（\cdot） 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">ρ</span><span class="mord cjk_fallback">（</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord cjk_fallback">）</span></span></span></span></span>是欧几里得距离，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         c 
        
       
      
        c 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span></span>是覆盖这两个盒子的最小封闭盒子的对角线长度。然后DIoU损失函数可以定义为：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           L 
          
          
          
            D 
           
          
            I 
           
          
            o 
           
          
            U 
           
          
         
        
          = 
         
        
          1 
         
        
          − 
         
        
          I 
         
        
          o 
         
        
          U 
         
        
          + 
         
         
          
           
           
             ρ 
            
           
             2 
            
           
          
            ( 
           
          
            b 
           
          
            , 
           
           
           
             b 
            
            
            
              g 
             
            
              t 
             
            
           
          
            ) 
           
          
          
          
            c 
           
          
            2 
           
          
         
        
       
         \mathcal{L}_{DIoU}=1-IoU+\frac{\rho^{2}(\mathbf{b},\mathbf{b}^{gt})}{c^{2}} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathcal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">D</span><span class="mord mathnormal mtight" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right: 0.109em;">U</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;"></span><span class="mord mathnormal" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right: 0.109em;">U</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.1771em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.4911em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">b</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathbf">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7936em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<p><img src="https://images2.imgbox.com/4a/d1/9mmYCr8O_o.png" alt="在这里插入图片描述"><br> DIoU损失的惩罚项直接使两个中心点之间的距离最小化。 c 的作用是防止损失函数的值过大，有点像标准化的感觉。</p> 
<p>参考资料：<a href="https://zhuanlan.zhihu.com/p/374907266" rel="nofollow">https://zhuanlan.zhihu.com/p/374907266</a></p> 
<p><img src="https://images2.imgbox.com/c5/0d/bbeP4Haw_o.png" alt="在这里插入图片描述"><br> 最终迭代T时IoU、GIoU和DIoU损失的回归误差可视化，即每个坐标n的e（T，n）。我们注意到（a）和（b）中的盆地对应于良好的回归情况。可以看出，在非重叠情况下，IoU损失有很大的误差，在水平和垂直情况下，GIoU损失有较大的误差，而DIoU损失导致到处都有非常小的回归误差。</p> 
<p>当与目标框不重叠时，DIoU可以为边界框提供移动方向。与GIoU相比，预测框显著地向目标边界框移动。<br> <img src="https://images2.imgbox.com/2c/37/W6wLjBX8_o.png" alt="在这里插入图片描述"></p> 
<p>DIoU要比GIou更加符合目标框回归的机制，将目标与anchor之间的距离，重叠率以及尺度都考虑进去，使得目标框回归变得更加稳定，不会像IoU和GIoU一样出现训练过程中发散等问题。</p> 
<p>损失相当于在保留GIoU损失优点的基础上，增加了中心点距离度量，直接优化两个框中心距离，快速收敛，而且仅中心点完全重合的时候，才会退化成IoU。</p> 
<p>但从式<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          L 
         
         
         
           D 
          
         
           I 
          
         
           o 
          
         
           U 
          
         
        
       
      
        \mathcal{L}_{DIoU} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathcal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">D</span><span class="mord mathnormal mtight" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right: 0.109em;">U</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>中我们可以看出 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          L 
         
         
         
           D 
          
         
           I 
          
         
           o 
          
         
           U 
          
         
        
       
      
        \mathcal{L}_{DIoU} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathcal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">D</span><span class="mord mathnormal mtight" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right: 0.109em;">U</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 和闭包的对角线距离 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         c 
        
       
      
        c 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span></span> 成反比，当两个bounding box的中心点之间的距离不变时，闭包的对角线越长，则DIoU损失函数的值越小，这就意味着DIoU Loss可能存在DIoU Loss存在训练过程中预测框被错误放大，但是损失值变小的问题。</p> 
<p>两个没有互相覆盖的矩形框，它们都是边长为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
      
        w 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span></span></span></span></span> 的矩形，它们中心点的距离为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         2 
        
       
         w 
        
       
      
        2w 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span></span></span></span></span> 。中心点不变，但是边长扩大到了<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         2 
        
       
         w 
        
       
      
        2w 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span></span></span></span></span>,两种情况下DIoU的值分别是 0.4 和 0.246 ,因此DloU Loss也存在预测框被错误放大的问题。</p> 
<hr> 
<p><strong>CIoU：</strong></p> 
<p>上面的论文考虑到bbox回归三要素中的长宽比还没被考虑到计算中，因此，进一步在DloU的基础上提出了CloU。其惩罚项如下面公式： <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          R 
         
         
         
           C 
          
         
           I 
          
         
           o 
          
         
           U 
          
         
        
       
         = 
        
        
         
          
          
            ρ 
           
          
            2 
           
          
         
           ( 
          
         
           b 
          
         
           , 
          
          
          
            b 
           
           
           
             g 
            
           
             t 
            
           
          
         
           ) 
          
         
         
         
           c 
          
         
           2 
          
         
        
       
         + 
        
       
         α 
        
       
         v 
        
       
      
        {\cal R}_{CIoU}=\frac{\rho^{2}(\mathbf{b},\mathbf{b}^{gt})}{c^{2}}+\alpha v 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathcal">R</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">C</span><span class="mord mathnormal mtight" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right: 0.109em;">U</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.4539em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.1089em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7463em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.485em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ρ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathbf mtight">b</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathbf mtight">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8703em;"><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">αv</span></span></span></span></span> 其中 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         α 
        
       
      
        \alpha 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0037em;">α</span></span></span></span></span> 是权重函数， 而 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ν 
        
       
      
        \nu 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0637em;">ν</span></span></span></span></span> 用来度量长宽比的相似性，定义为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         v 
        
       
         = 
        
        
        
          4 
         
         
         
           π 
          
         
           2 
          
         
        
        
         
         
           ( 
          
         
           arctan 
          
         
           ⁡ 
          
          
           
           
             w 
            
            
            
              g 
             
            
              t 
             
            
           
           
           
             h 
            
            
            
              g 
             
            
              t 
             
            
           
          
         
           − 
          
         
           arctan 
          
         
           ⁡ 
          
          
          
            w 
           
          
            h 
           
          
         
           ) 
          
         
        
          2 
         
        
       
      
        v=\frac4{\pi^2}\left(\arctan\frac{w^{gt}}{h^{gt}}-\arctan\frac wh\right)^2 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.004em; vertical-align: -0.65em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8451em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7463em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size2">(</span></span><span class="mop">arctan</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0032em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7253em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8703em;"><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mop">arctan</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6954em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0269em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size2">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.354em;"><span class="" style="top: -3.6029em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> 完整的 CloU 损失函数定义： <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           L 
          
          
          
            C 
           
          
            I 
           
          
            o 
           
          
            U 
           
          
         
        
          = 
         
        
          1 
         
        
          − 
         
        
          I 
         
        
          o 
         
        
          U 
         
        
          + 
         
         
          
           
           
             ρ 
            
           
             2 
            
           
           
           
             ( 
            
           
             b 
            
           
             , 
            
            
            
              b 
             
             
             
               g 
              
             
               t 
              
             
            
           
             ) 
            
           
          
          
          
            c 
           
          
            2 
           
          
         
        
          + 
         
        
          α 
         
        
          v 
         
        
       
         \mathcal{L}_{CIoU}=1-IoU+\frac{\rho^2\left(\mathbf{b},\mathbf{b}^{gt}\right)}{c^2}+\alpha v 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathcal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">C</span><span class="mord mathnormal mtight" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right: 0.109em;">U</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;"></span><span class="mord mathnormal" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right: 0.109em;">U</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.1771em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.4911em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord mathbf">b</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathbf">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7936em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">αv</span></span></span></span></span></span> 最后，CloU loss的梯度类似于DloU Ioss, 但还要考虑 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ν 
        
       
      
        \nu 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0637em;">ν</span></span></span></span></span> 的梯度。在长宽在 [0,1] 的情况下， <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          2 
         
        
       
         + 
        
        
        
          h 
         
        
          2 
         
        
       
      
        w^2+h^2 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8974em; vertical-align: -0.0833em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.8141em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> 的值通常很小，会导致梯度爆炸，因此在 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          1 
         
         
          
          
            w 
           
          
            2 
           
          
         
           + 
          
          
          
            h 
           
          
            2 
           
          
         
        
       
      
        \frac1{w^2+h^2} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.2484em; vertical-align: -0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8451em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7463em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7463em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4033em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span> 实现时将替换成1。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">bbox_overlaps_ciou</span><span class="token punctuation">(</span>bboxes1<span class="token punctuation">,</span> bboxes2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rows <span class="token operator">=</span> bboxes1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    cols <span class="token operator">=</span> bboxes2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    cious <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>rows<span class="token punctuation">,</span> cols<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> rows <span class="token operator">*</span> cols <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> cious
    exchange <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword">if</span> bboxes1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> bboxes2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        bboxes1<span class="token punctuation">,</span> bboxes2 <span class="token operator">=</span> bboxes2<span class="token punctuation">,</span> bboxes1
        cious <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>cols<span class="token punctuation">,</span> rows<span class="token punctuation">)</span><span class="token punctuation">)</span>
        exchange <span class="token operator">=</span> <span class="token boolean">True</span>

    w1 <span class="token operator">=</span> bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    h1 <span class="token operator">=</span> bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    w2 <span class="token operator">=</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    h2 <span class="token operator">=</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>

    area1 <span class="token operator">=</span> w1 <span class="token operator">*</span> h1
    area2 <span class="token operator">=</span> w2 <span class="token operator">*</span> h2

    center_x1 <span class="token operator">=</span> <span class="token punctuation">(</span>bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    center_y1 <span class="token operator">=</span> <span class="token punctuation">(</span>bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    center_x2 <span class="token operator">=</span> <span class="token punctuation">(</span>bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    center_y2 <span class="token operator">=</span> <span class="token punctuation">(</span>bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>

    inter_max_xy <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    inter_min_xy <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    out_max_xy <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    out_min_xy <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    inter <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token punctuation">(</span>inter_max_xy <span class="token operator">-</span> inter_min_xy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    inter_area <span class="token operator">=</span> inter<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> inter<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    inter_diag <span class="token operator">=</span> <span class="token punctuation">(</span>center_x2 <span class="token operator">-</span> center_x1<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>center_y2 <span class="token operator">-</span> center_y1<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span>
    outer <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token punctuation">(</span>out_max_xy <span class="token operator">-</span> out_min_xy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    outer_diag <span class="token operator">=</span> <span class="token punctuation">(</span>outer<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>outer<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>
    union <span class="token operator">=</span> area1<span class="token operator">+</span>area2<span class="token operator">-</span>inter_area
    u <span class="token operator">=</span> <span class="token punctuation">(</span>inter_diag<span class="token punctuation">)</span> <span class="token operator">/</span> outer_diag
    iou <span class="token operator">=</span> inter_area <span class="token operator">/</span> union
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        arctan <span class="token operator">=</span> torch<span class="token punctuation">.</span>atan<span class="token punctuation">(</span>w2 <span class="token operator">/</span> h2<span class="token punctuation">)</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span>atan<span class="token punctuation">(</span>w1 <span class="token operator">/</span> h1<span class="token punctuation">)</span>
        v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">/</span> <span class="token punctuation">(</span>math<span class="token punctuation">.</span>pi <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>atan<span class="token punctuation">(</span>w2 <span class="token operator">/</span> h2<span class="token punctuation">)</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span>atan<span class="token punctuation">(</span>w1 <span class="token operator">/</span> h1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        S <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> iou
        alpha <span class="token operator">=</span> v <span class="token operator">/</span> <span class="token punctuation">(</span>S <span class="token operator">+</span> v<span class="token punctuation">)</span>
        w_temp <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> w1
    ar <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">/</span> <span class="token punctuation">(</span>math<span class="token punctuation">.</span>pi <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> arctan <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>w1 <span class="token operator">-</span> w_temp<span class="token punctuation">)</span> <span class="token operator">*</span> h1<span class="token punctuation">)</span>
    cious <span class="token operator">=</span> iou <span class="token operator">-</span> <span class="token punctuation">(</span>u <span class="token operator">+</span> alpha <span class="token operator">*</span> ar<span class="token punctuation">)</span>
    cious <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>cious<span class="token punctuation">,</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token builtin">max</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> exchange<span class="token punctuation">:</span>
        cious <span class="token operator">=</span> cious<span class="token punctuation">.</span>T
    <span class="token keyword">return</span> cious
</code></pre> 
<ol><li> <p><strong>导入库：</strong></p> <pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> math
</code></pre> <p>导入 PyTorch 库，并从 torch 中导入 math 模块。</p> </li><li> <p><strong>函数定义：</strong></p> <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">bbox_overlaps_ciou</span><span class="token punctuation">(</span>bboxes1<span class="token punctuation">,</span> bboxes2<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre> <p>定义了一个名为 <code>bbox_overlaps_ciou</code> 的函数，该函数计算两组边界框之间的 CIoU。</p> </li><li> <p><strong>初始化变量：</strong></p> <pre><code class="prism language-python">rows <span class="token operator">=</span> bboxes1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
cols <span class="token operator">=</span> bboxes2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
cious <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>rows<span class="token punctuation">,</span> cols<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <p>初始化行数、列数和 CIoU 矩阵。如果其中一组边界框为空，则直接返回全零的 CIoU 矩阵。</p> </li><li> <p><strong>交换矩阵：</strong></p> <pre><code class="prism language-python">exchange <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token keyword">if</span> bboxes1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> bboxes2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    bboxes1<span class="token punctuation">,</span> bboxes2 <span class="token operator">=</span> bboxes2<span class="token punctuation">,</span> bboxes1
    cious <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>cols<span class="token punctuation">,</span> rows<span class="token punctuation">)</span><span class="token punctuation">)</span>
    exchange <span class="token operator">=</span> <span class="token boolean">True</span>
</code></pre> <p>如果第一组边界框的行数大于第二组，进行交换，确保第一组边界框的行数更少，同时初始化 CIoU 矩阵。</p> </li><li> <p><strong>提取边界框参数：</strong></p> <pre><code class="prism language-python">w1 <span class="token operator">=</span> bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
h1 <span class="token operator">=</span> bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
w2 <span class="token operator">=</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
h2 <span class="token operator">=</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
</code></pre> <p>提取边界框的宽度和高度。</p> </li><li> <p><strong>计算面积和中心点：</strong></p> <pre><code class="prism language-python">area1 <span class="token operator">=</span> w1 <span class="token operator">*</span> h1
area2 <span class="token operator">=</span> w2 <span class="token operator">*</span> h2

center_x1 <span class="token operator">=</span> <span class="token punctuation">(</span>bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
center_y1 <span class="token operator">=</span> <span class="token punctuation">(</span>bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
center_x2 <span class="token operator">=</span> <span class="token punctuation">(</span>bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
center_y2 <span class="token operator">=</span> <span class="token punctuation">(</span>bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
</code></pre> <p>计算边界框的面积和中心点坐标。</p> </li><li> <p><strong>计算交集和并集：</strong></p> <pre><code class="prism language-python">inter_max_xy <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
inter_min_xy <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
out_max_xy <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
out_min_xy <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>bboxes1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bboxes2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

inter <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token punctuation">(</span>inter_max_xy <span class="token operator">-</span> inter_min_xy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
inter_area <span class="token operator">=</span> inter<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> inter<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
</code></pre> <p>计算边界框的交集和并集的坐标和面积。</p> </li><li> <p><strong>计算对角线和 Complete IoU：</strong></p> <pre><code class="prism language-python">inter_diag <span class="token operator">=</span> <span class="token punctuation">(</span>center_x2 <span class="token operator">-</span> center_x1<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>center_y2 <span class="token operator">-</span> center_y1<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span>
outer <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token punctuation">(</span>out_max_xy <span class="token operator">-</span> out_min_xy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
outer_diag <span class="token operator">=</span> <span class="token punctuation">(</span>outer<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>outer<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>
union <span class="token operator">=</span> area1 <span class="token operator">+</span> area2 <span class="token operator">-</span> inter_area
u <span class="token operator">=</span> <span class="token punctuation">(</span>inter_diag<span class="token punctuation">)</span> <span class="token operator">/</span> outer_diag
iou <span class="token operator">=</span> inter_area <span class="token operator">/</span> union
</code></pre> <p>计算对角线、外接框和 Complete IoU。</p> </li><li> <p><strong>计算 CIoU 中的其他参数：</strong></p> <pre><code class="prism language-python"><span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    arctan <span class="token operator">=</span> torch<span class="token punctuation">.</span>atan<span class="token punctuation">(</span>w2 <span class="token operator">/</span> h2<span class="token punctuation">)</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span>atan<span class="token punctuation">(</span>w1 <span class="token operator">/</span> h1<span class="token punctuation">)</span>
    v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">/</span> <span class="token punctuation">(</span>math<span class="token punctuation">.</span>pi <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>atan<span class="token punctuation">(</span>w2 <span class="token operator">/</span> h2<span class="token punctuation">)</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span>atan<span class="token punctuation">(</span>w1 <span class="token operator">/</span> h1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    S <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> iou
    alpha <span class="token operator">=</span> v <span class="token operator">/</span> <span class="token punctuation">(</span>S <span class="token operator">+</span> v<span class="token punctuation">)</span>
    w_temp <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> w1
    ar <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">/</span> <span class="token punctuation">(</span>math<span class="token punctuation">.</span>pi <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> arctan <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>w1 <span class="token operator">-</span> w_temp<span class="token punctuation">)</span> <span class="token operator">*</span> h1<span class="token punctuation">)</span>
    cious <span class="token operator">=</span> iou <span class="token operator">-</span> <span class="token punctuation">(</span>u <span class="token operator">+</span> alpha <span class="token operator">*</span> ar<span class="token punctuation">)</span>
    cious <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>cious<span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>
</code></pre> <p>计算 CIoU 中的额外参数，然后使用这些参数<br> 计算 CIoU，最后将 CIoU 的值夹在 [-1.0, 1.0] 的范围内。</p> </li><li> <p><strong>矩阵交换：</strong></p> <pre><code class="prism language-python"><span class="token keyword">if</span> exchange<span class="token punctuation">:</span>
    cious <span class="token operator">=</span> cious<span class="token punctuation">.</span>T
</code></pre> <p>如果发生了交换，将 CIoU 矩阵转置回原始形状。</p> </li><li> <p><strong>返回结果：</strong></p> <pre><code class="prism language-python"><span class="token keyword">return</span> cious
</code></pre> <p>返回计算得到的 CIoU 矩阵。</p> </li></ol> 
<h3><a id="nms_922"></a>nms非极大值抑制</h3> 
<p>在目标检测的后处理过程中，针对很多目标框的筛选，通常需要nms操作。</p> 
<p>因为CIOU_Loss中包含影响因子v，涉及groudtruth的信息，而测试推理时，是没有groundtruth的。</p> 
<p>所以Yolov4在DIOU_Loss的基础上采用DIOU_nms的方式，而Yolov5中采用加权nms的方式。</p> 
<p>可以看出，采用DIOU_nms，下方中间箭头的黄色部分，原本被遮挡的摩托车也可以检出。</p> 
<p>将nms中IOU修改成DIOU_nms。对于一些遮挡重叠的目标，会有一些改进。<br> <img src="https://images2.imgbox.com/92/a2/6YlpOH5S_o.jpg" alt="在这里插入图片描述"><br> 图片：<a href="https://zhuanlan.zhihu.com/p/172121380" rel="nofollow">https://zhuanlan.zhihu.com/p/172121380</a></p> 
<h3><a id="_936"></a>代码</h3> 
<p>Yolov5的作者并没有发表论文，因此只能从代码角度进行分析。</p> 
<p>Yolov5代码：<a href="https://github.com/ultralytics/yolov5">https://github.com/ultralytics/yolov5</a></p> 
<p>大家可以根据网页的说明，下载训练，及测试。</p> 
<h3><a id="_944"></a>最后</h3> 
<p>综合而言，在实际测试中，Yolov4的准确性有不错的优势，但Yolov5的多种网络结构使用起来更加灵活，我们可以根据不同的项目需求，取长补短，发挥不同检测网络的优势。</p> 
<p>Yolox的改进trick中，有很多值得借鉴的地方。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8fa7ea4cc8bf2f8d72e0326c024d6e80/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ubuntu22 安装 cuda12.0</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fbf4f11306f35ad94ea2adc377728aaa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">shell 变量</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>