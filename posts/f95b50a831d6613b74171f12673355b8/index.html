<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>systemd实现python的守护进程 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="systemd实现python的守护进程" />
<meta property="og:description" content="守护进程（Daemon）是运行在后台的一种特殊进程。它独立于控制终端并且周期性地执行某种任务或等待处理某些发生的事件。（摘自百度百科）
之前有转过一遍python实现守护进程方法的博客，这次我们看看用systemd是如何实现的。
有关systemd的介绍和使用推荐阮一峰老师的以下两篇博客，写的非常详细和全面
命令篇实践篇 下面我们看看用systemd如何实现守护进程（我的环境Centos 7）
#!/usr/bin/env python # -*- coding=utf-8 -*- &#34;&#34;&#34; 每隔5秒输出本地时间到指定的文件 path: /home/test.py &#34;&#34;&#34; import time filepath = &#39;/home/time&#39; # 文件路径 fm = &#39;%Y-%m-%d %X&#39; def get_time(): while 1: nowtime = time.strftime(fm, time.localtime()) with open(filepath, &#39;a&#39;) as fp: fp.write(nowtime) fp.write(&#39;\n&#39;) time.sleep(5) if __name__ == &#39;__main__&#39;: get_time() 接着我们在/home目录下创建一个systemd的文件test.service
[Unit] Description=test deamon After=rc-local.service [Service] Type=simple User=root Group=root WorkingDirectory=/home ExecStart=/usr/bin/python test.py Restart=always [Install] WantedBy=multi-user.target 把此文件复制到systemd目录下: cp /home/test.service /etc/systemd/system/
启动: systemctl start test." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f95b50a831d6613b74171f12673355b8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-12-05T17:48:12+08:00" />
<meta property="article:modified_time" content="2016-12-05T17:48:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">systemd实现python的守护进程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>守护进程（Daemon）是运行在后台的一种特殊进程。它独立于控制终端并且周期性地执行某种任务或等待处理某些发生的事件。（<a href="http://baike.baidu.com/view/407213.htm" rel="nofollow">摘自百度百科</a>）</p> 
<p>之前有转过一遍python实现守护进程方法的<a href="http://blog.csdn.net/luckytanggu/article/details/51790440">博客</a>，这次我们看看用systemd是如何实现的。</p> 
<p>有关systemd的介绍和使用推荐阮一峰老师的以下两篇博客，写的非常详细和全面</p> 
<ul><li><a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html" rel="nofollow">命令篇</a></li><li><a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html" rel="nofollow">实践篇</a></li></ul> 
<p>下面我们看看用systemd如何实现守护进程（<strong>我的环境Centos 7</strong>）</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding=utf-8 -*-</span>


<span class="token triple-quoted-string string">"""
每隔5秒输出本地时间到指定的文件
path: /home/test.py
"""</span>

<span class="token keyword">import</span> time


filepath <span class="token operator">=</span> <span class="token string">'/home/time'</span> <span class="token comment"># 文件路径</span>
fm <span class="token operator">=</span> <span class="token string">'%Y-%m-%d %X'</span>

<span class="token keyword">def</span> <span class="token function">get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
	    nowtime <span class="token operator">=</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>fm<span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
	        fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>nowtime<span class="token punctuation">)</span>
	        fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
	    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    get_time<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>接着我们在<code>/home</code>目录下创建一个systemd的文件<code>test.service</code></p> 
<pre><code>[Unit]
Description=test deamon
After=rc-local.service

[Service]
Type=simple
User=root
Group=root
WorkingDirectory=/home
ExecStart=/usr/bin/python test.py
Restart=always

[Install]
WantedBy=multi-user.target
</code></pre> 
<p>把此文件复制到systemd目录下: <code>cp /home/test.service /etc/systemd/system/</code></p> 
<p>启动: <code>systemctl start test.service</code></p> 
<p><code>ps -ef | grep python</code> 查看python进程会发现多了<code>/usr/bin/python test.py</code>的进程</p> 
<p>当我们人为kill掉此进程的时候，systemd会自动帮我们重启此进程</p> 
<p>启动后查看time文件就会看到每隔5秒输出时间了: <code>tail -f /home/time</code></p> 
<p>停止: <code>systemctl stop test.service</code></p> 
<p>如果想开机启动此服务</p> 
<pre><code>$ systemctl enable test.service
# 以上命令相当于执行以下命令，把test.service添加到开机启动中
$ sudo ln -s  '/etc/systemd/system/test.service'  '/etc/systemd/system/multi-user.target.wants/test.service' 
</code></pre> 
<blockquote> 
 <p>systemd 实现守护进程是不是so easy 啊！比起python代码方式实现真的容易方便多了</p> 
</blockquote> 
<p><strong>注：现在大部分Linux衍生版本都支持systemd（如centos，deepin），部分不支持（如：Ubuntu14.04之前的版本）</strong></p> 
<p>查看系统是否支持systemd：<code>systemctl --version</code> 如果提示未找到命令则说明系统不支持systemd</p> 
<p>查看系统详细信息：<code>hostnamectl</code></p> 
<hr> 
<p><strong>注：由systemd起的任何服务，当我们停掉该systemd时，服务也会随之停掉</strong></p> 
<p>比如说，我们自己定义了一个systemd service，用来执行某python脚本，而该脚本启动mysql、nginx服务，当我们停掉该systemd service（systemctl stop xxx.service）时，mysql和nginx服务也会停(kill)掉。因为这两个服务是有systemd起的，当systemd服务停/kill掉时，由该systemd服务所起的服务或进程也会停/kill掉。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d4cfafadd3d8dbc87f060d545dbda537/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">关于service 与 activty 之间通信</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0f7f0f90defb432ffdb0fd1839c8dfee/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">EventBus的坑</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>