<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>TRUNCATE TABLE t 和DELETE FROM t的区别 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="TRUNCATE TABLE t 和DELETE FROM t的区别" />
<meta property="og:description" content="背景 最近再工作中,遇到一个问题,就是再代码执行过程中,出现异常时并不会去回滚代码.导致数据不一致,最初以为是@Transactional这个注解没有生效
Spring中什么时候@Transactional会失效
因为Spring事务是基于代理来实现的,所以某个加了@Transactional的方法只有是被代理对象调用时,那么这个注解才会生效,所以如果被代理对象来调用这个方法,那么@Transactional是不会失效的同时如果这个方法是private的,那么@Transactional也会失效,因为底层cglib是基于子父类来实现的,子类是不能重载父类的private方法的,所以无法很好的利用代理,也会导致@Transactional失效异常没有被正确抛出,那么@Transactional也会失效.@Transactional默认情况下只对未捕获的运行异常进行回滚,而对已检查异常不会回滚事务,默认只回滚RuntimeException,如果需要对特定异常进行回滚,可以使用rollbackFor属性来指定需要回滚的异常类型 经排查代码中不存在以上问题,后来才知道是SQL的问题,只因为使用了一条SQL:
TRUNCATE TABLE user 代码 使用代码模拟当时场景;
数据准备 DROP TABLE IF EXISTS `user`; CREATE TABLE `user` ( `id` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL, `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL, `address` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL, PRIMARY KEY (`id`) USING BTREE ) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci ROW_FORMAT = Dynamic; INSERT INTO `user` VALUES (&#39;be079b29ddc111eda9b20242ac110003&#39;, &#39;张三&#39;, &#39;北京市海淀区xx街道123号&#39;); INSERT INTO `user` VALUES (&#39;be079b53ddc111eda9b20242ac110003&#39;, &#39;李四&#39;, &#39;上海市徐汇区xx路456号&#39;); INSERT INTO `user` VALUES (&#39;be079b95ddc111eda9b20242ac110003&#39;, &#39;王五&#39;, &#39;广州市天河区xx街道789号&#39;); INSERT INTO `user` VALUES (&#39;be079ba4ddc111eda9b20242ac110003&#39;, &#39;赵六&#39;, &#39;深圳市南山区xx路321号&#39;); INSERT INTO `user` VALUES (&#39;be079bb8ddc111eda9b20242ac110003&#39;, &#39;周七&#39;, &#39;成都市高新区xx街道654号&#39;); INSERT INTO `user` VALUES (&#39;be079bc5ddc111eda9b20242ac110003&#39;, &#39;黄八&#39;, &#39;武汉市江汉区xx街道234号&#39;); INSERT INTO `user` VALUES (&#39;be079bd4ddc111eda9b20242ac110003&#39;, &#39;罗九&#39;, &#39;南京市秦淮区xx路567号&#39;); INSERT INTO `user` VALUES (&#39;be079be2ddc111eda9b20242ac110003&#39;, &#39;钱十&#39;, &#39;重庆市渝北区xx街道890号&#39;); INSERT INTO `user` VALUES (&#39;be079befddc111eda9b20242ac110003&#39;, &#39;周十一&#39;, &#39;长沙市岳麓区xx路432号&#39;); INSERT INTO `user` VALUES (&#39;be079bfbddc111eda9b20242ac110003&#39;, &#39;吴十二&#39;, &#39;西安市雁塔区xx街道765号&#39;); 涉及代码 service代码:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/dd11340438ee59d1aab86a66a1732b3b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-30T20:03:29+08:00" />
<meta property="article:modified_time" content="2023-05-30T20:03:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">TRUNCATE TABLE t 和DELETE FROM t的区别</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_1"></a>背景</h3> 
<p>最近再工作中,遇到一个问题,就是再代码执行过程中,出现异常时并不会去回滚代码.导致数据不一致,最初以为是@Transactional这个注解没有生效</p> 
<p><strong>Spring中什么时候@Transactional会失效</strong></p> 
<ul><li>因为Spring事务是基于代理来实现的,所以某个加了@Transactional的方法只有是被代理对象调用时,那么这个注解才会生效,所以如果被代理对象来调用这个方法,那么@Transactional是不会失效的</li><li>同时如果这个方法是private的,那么@Transactional也会失效,因为底层cglib是基于子父类来实现的,子类是不能重载父类的private方法的,所以无法很好的利用代理,也会导致@Transactional失效</li><li>异常没有被正确抛出,那么@Transactional也会失效.@Transactional默认情况下只对未捕获的运行异常进行回滚,而对已检查异常不会回滚事务,默认只回滚RuntimeException,如果需要对特定异常进行回滚,可以使用rollbackFor属性来指定需要回滚的异常类型</li></ul> 
<p>经排查代码中不存在以上问题,后来才知道是SQL的问题,只因为使用了一条SQL:</p> 
<pre><code class="prism language-sql"><span class="token keyword">TRUNCATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">user</span>
</code></pre> 
<h3><a id="_17"></a>代码</h3> 
<p>使用代码模拟当时场景;</p> 
<h4><a id="_21"></a>数据准备</h4> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>address<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
    <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'be079b29ddc111eda9b20242ac110003'</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token string">'北京市海淀区xx街道123号'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'be079b53ddc111eda9b20242ac110003'</span><span class="token punctuation">,</span> <span class="token string">'李四'</span><span class="token punctuation">,</span> <span class="token string">'上海市徐汇区xx路456号'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'be079b95ddc111eda9b20242ac110003'</span><span class="token punctuation">,</span> <span class="token string">'王五'</span><span class="token punctuation">,</span> <span class="token string">'广州市天河区xx街道789号'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'be079ba4ddc111eda9b20242ac110003'</span><span class="token punctuation">,</span> <span class="token string">'赵六'</span><span class="token punctuation">,</span> <span class="token string">'深圳市南山区xx路321号'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'be079bb8ddc111eda9b20242ac110003'</span><span class="token punctuation">,</span> <span class="token string">'周七'</span><span class="token punctuation">,</span> <span class="token string">'成都市高新区xx街道654号'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'be079bc5ddc111eda9b20242ac110003'</span><span class="token punctuation">,</span> <span class="token string">'黄八'</span><span class="token punctuation">,</span> <span class="token string">'武汉市江汉区xx街道234号'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'be079bd4ddc111eda9b20242ac110003'</span><span class="token punctuation">,</span> <span class="token string">'罗九'</span><span class="token punctuation">,</span> <span class="token string">'南京市秦淮区xx路567号'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'be079be2ddc111eda9b20242ac110003'</span><span class="token punctuation">,</span> <span class="token string">'钱十'</span><span class="token punctuation">,</span> <span class="token string">'重庆市渝北区xx街道890号'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'be079befddc111eda9b20242ac110003'</span><span class="token punctuation">,</span> <span class="token string">'周十一'</span><span class="token punctuation">,</span> <span class="token string">'长沙市岳麓区xx路432号'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'be079bfbddc111eda9b20242ac110003'</span><span class="token punctuation">,</span> <span class="token string">'吴十二'</span><span class="token punctuation">,</span> <span class="token string">'西安市雁塔区xx街道765号'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_43"></a>涉及代码</h4> 
<p>service代码:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    userMapper<span class="token punctuation">.</span><span class="token function">truncateTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 模拟一个异常,测试是否回滚</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"番茄炒蛋"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">"北京市朝阳区"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>具体sql:</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>delete</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>truncateTable<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    TRUNCATE TABLE user
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>delete</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>执行结果:<br> <img src="https://images2.imgbox.com/28/af/20JDxLr6_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/65/43/Zlq9WlGK_o.png" alt="在这里插入图片描述"></p> 
<p><strong>再出现异常时,并没有去回滚代码恢复原有的数据.</strong></p> 
<h4><a id="_81"></a>修改代码</h4> 
<p>具体sql:</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>delete</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>truncateTable<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    DELETE FROM user
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>delete</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>执行结果:<br> <img src="https://images2.imgbox.com/28/c8/U8QdCa9O_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/27/4f/fiVPEbcS_o.png" alt="在这里插入图片描述"></p> 
<p><strong>虽然还是会报错,但是会回滚事务,保证了数据的一致性</strong></p> 
<h3><a id="_102"></a>总结</h3> 
<p>TRUNCATE TABLE user和DELETE FROM user是用于删除关系数据库表中的数据的两种不同的SQL语句,它们之间有以下区别:</p> 
<ol><li><strong>操作方式:</strong> TRUNCATE TABLE user是一种DDL(数据定义语言)语句,而DELETE FROM user是一种DML(数据操作语言)语句.DDL语句用于定义数据库结构,而DML语句用于对数据进行操作</li><li><strong>速度:</strong> TRUNCATE TABLE user通常比DELETE FROM user更快,TRUNCATE 语句通过删除表中的所有数据并释放存储空间来执行操作.相比之下,DELETE 语句是逐行删除,需要遍历每一行并记录事务日志.因此它可能需要更长的时间来完成</li><li><strong>事务日志:</strong> TRUNCATE TABLE user在执行前会将操作记录在事务日志中,以便可以回滚操作.但是TRUNCATE 操作不会被事务回滚所影响.相反,DELETE FROM user操作可以被事务回滚,可以通过回滚操作恢复已删除的数据</li><li><strong>触发器:</strong> TRUNCATE TABLE user不会出发与表相关的触发器,而DELETE FROM user会触发表相关的删除触发器.触发器是在数据库表上定义的一种特殊操作,它会在特定事件发生时自动出发相关的操作</li><li><strong>权限要求:</strong> TRUNCATE TABLE user通常需要更高的权限才能执行,因为它是一种DDL语句.相比之下,DELETE FROM user是一种DML语句,对于具有适当权限的用户来说更容易执行</li></ol> 
<p>总结起来,TRUNCATE TABLE user是一种快速且非常有效的删除表数据的方法,不会触发触发器,并且不能被事务回滚,而DELETE FROM user是一种逐行删除数据的方法,可以出发触发器,并且可以通过事务回滚来恢复已删除的数据.选择使用那种语句取决于具体的需求和情况.</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ea9c25cb0a4f01873c7d9928c942204e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python报错 UnicodeDecodeError: ‘gbk‘ codec can‘t decode bytein position 2: illegal multibyte sequence</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e6717c599da38f2e68d39258d2e68171/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Linux】项目自动化构建工具-make和Makefile 的使用和进度条的实现</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>