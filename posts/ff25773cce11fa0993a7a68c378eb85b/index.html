<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>gitlab 版本升级 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="gitlab 版本升级" />
<meta property="og:description" content="简介:
gitlab现用版本为12.10.14由于版本漏洞，需升级为14 版本的gitlab，操作流程如下，通过docker-composer 启动gitlab，实现http,https,ssh访问和拉取代码.由于gitlab不可以直接升级到最新版本，故需要按gitlab官方升级流程进行升级（不可回退版本,回退版本会造成状态码：500报错）12.10.14---&gt;13.0.14---&gt;13.1.11---&gt;13.8.8---&gt;13.12.15---&gt;14.0.12 操作步骤如下
1. 数据备份
进入正在运行的gitlab中备份数据信息。
gitlab-rake gitlab:backup:create 备份位置可在/etc/gitlab.rb中进行配置
2. 编写docker-composer.yaml
version: &#39;3.7&#39; services: gitlab: image: &#39;gitlab/gitlab-ce:14.0.12-ce.0&#39; #升级修改版本号 restart: always hostname: &#39;gitlabs&#39; container_name: cs-gitlab environment: GITLAB_OMNIBUS_CONFIG: | external_url &#39;http://gitlab.域名.com&#39; ports: - &#39;9080:80&#39; - &#39;9443:443&#39; - &#39;9022:22&#39; volumes: - &#39;/data/cs-gitlab/config:/etc/gitlab&#39; - &#39;/data/cs-gitlab/logs:/var/log/gitlab&#39; - &#39;/data/cs-gitlab/data:/var/opt/gitlab&#39; 启动服务
docker-compose up -d 3. 导入数据
sudo mv /data/gitlab/srv/gitlab/data/backups/1649333339_2022_04_07_12.10.14_gitlab_backup.tar /data/cs-gitlab/data/backups docker exec -it cs-gitlab bash #进入容器 gitlab-rake gitlab:backup:restore #选择yes 备份位置可在/etc/gitlab.rb中进行配置
4. 代理配置
server { listen 80; server_name gitlab." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ff25773cce11fa0993a7a68c378eb85b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-09T15:52:52+08:00" />
<meta property="article:modified_time" content="2022-04-09T15:52:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">gitlab 版本升级</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><span style="color:#fe2c24;"><strong>简介:</strong></span></p> 
<p>gitlab现用版本为12.10.14由于版本漏洞，需升级为14 版本的gitlab，操作流程如下，通过docker-composer 启动gitlab，实现http,https,ssh访问和拉取代码.由于gitlab不可以直接升级到最新版本，故需要按gitlab官方升级流程进行升级（不可回退版本,回退版本会造成状态码：500报错）12.10.14---&gt;13.0.14---&gt;13.1.11---&gt;13.8.8---&gt;13.12.15---&gt;14.0.12 操作步骤如下</p> 
<p></p> 
<p><strong><span style="color:#fe2c24;">1. 数据备份</span></strong></p> 
<p>进入正在运行的gitlab中备份数据信息。</p> 
<pre><code class="language-bash">gitlab-rake gitlab:backup:create</code></pre> 
<p id="uf4c5f057">备份位置可在/etc/gitlab.rb中进行配置</p> 
<p></p> 
<p><span style="color:#fe2c24;"><strong>2. 编写docker-composer.yaml</strong></span></p> 
<pre><code class="language-bash">version: '3.7'
services:
  gitlab:
    image: 'gitlab/gitlab-ce:14.0.12-ce.0'  #升级修改版本号
    restart: always
    hostname: 'gitlabs'
    container_name: cs-gitlab
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://gitlab.域名.com'
    ports:
      - '9080:80'
      - '9443:443'
      - '9022:22'
    volumes:
      - '/data/cs-gitlab/config:/etc/gitlab'
      - '/data/cs-gitlab/logs:/var/log/gitlab'
      - '/data/cs-gitlab/data:/var/opt/gitlab'</code></pre> 
<p>启动服务</p> 
<pre><code class="language-bash">docker-compose up -d </code></pre> 
<p></p> 
<p><span style="color:#fe2c24;"><strong>3. 导入数据</strong></span></p> 
<pre><code class="language-bash">sudo mv  /data/gitlab/srv/gitlab/data/backups/1649333339_2022_04_07_12.10.14_gitlab_backup.tar  /data/cs-gitlab/data/backups

docker exec -it cs-gitlab bash  #进入容器

gitlab-rake gitlab:backup:restore  #选择yes</code></pre> 
<p id="u4521d508">备份位置可在/etc/gitlab.rb中进行配置</p> 
<p></p> 
<p><strong><span style="color:#fe2c24;">4. 代理配置</span></strong></p> 
<pre><code class="language-bash">server {
        listen  80;
        server_name     gitlab.域名.com;
        rewrite ^(.*)$  https://$host$1 permanent;
}


server{
    listen 443;
    server_name gitlab.域名.com;
    client_max_body_size 10M;
    ssl on;
    ssl_certificate /etc/nginx/cert/tuyi.crt;
    ssl_certificate_key /etc/nginx/cert/tuyi.key;
    access_log  /etc/nginx/logs/gitlabs/access.log  main;
    error_log  /etc/nginx/logs/gitlabs/error.log;

    location / {
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header Host $http_host;
       proxy_http_version 1.1;
       proxy_set_header Upgrade $http_upgrade;
       proxy_set_header Connection "upgrade";
       proxy_pass https://10.144.69.25:9443;
    }
}</code></pre> 
<p></p> 
<p><strong><span style="color:#fe2c24;">5. 版本升级</span></strong></p> 
<pre><code class="language-bash">docker exec -it cs-gitlab bash   #进入容器

gitlab-ctl stop    #停止gitlab服务

exit  #退出容器

docker stop cs-gitlab #停止容器

docker rm cs-gitlab #删除</code></pre> 
<p id="uaf3b0be4">修改docker-composer.yaml中的images</p> 
<p id="ub0325a2a">每次版本升级需登陆账号查看当前服务是否正确</p> 
<p></p> 
<p><strong><span style="color:#fe2c24;">6. 升级之后迁移原gitlab配置文件</span></strong></p> 
<pre><code class="language-bash">cd /data/cs-gitlab/config

mv gitlab.rb{,.bak}

mv gitlab-secrets.json{,.bak}

cd /data/gitlab/srv/gitlab/config

cp -pr ./gitlab.rb ./gitlab-secrets.json /data/cs-gitlab/config/</code></pre> 
<p></p> 
<p><strong><span style="color:#fe2c24;">7.报错解决</span></strong></p> 
<p><span style="color:#fe2c24;">7.1 状态码502</span></p> 
<pre><code class="language-bash">vim /etc/gitlab/gitlab.rb

# 设置服务响应URL
external_url 'http://ip:9080'
unicorn['listen'] = 'localhost'
# 设置监听端口
unicorn['port'] = 8080</code></pre> 
<p id="u628f234c">重启服务即可</p> 
<p><span style="color:#fe2c24;">7.2 升级版本后</span></p> 
<pre><code class="language-bash">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ECDSA key sent by the remote host is
SHA256:Udn6FJ6raK9NUCOBmHOUON3xiwXpZVgFZobNmMJ6lFg.
Please contact your system administrator.
Add correct host key in /Users/renteng/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in /Users/renteng/.ssh/known_hosts:1
ECDSA host key for gitlab.intviu.cn has changed and you have requested strict checking.
Host key verification failed.
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists.</code></pre> 
<p id="u0180e3e4">删除/Users/renteng/.ssh/known_hosts下第一行信息</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0db7c1ece20dd4fdbac048e934e71dfd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vue中V-model绑定控件表单</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/da44c0b55441eb3b79dd905fbfb428f1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">修改Centos最大连接数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>