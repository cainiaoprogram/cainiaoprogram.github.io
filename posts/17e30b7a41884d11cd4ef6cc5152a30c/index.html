<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C/C&#43;&#43;编程日记：用C语言实现的简单Web服务器(Linux)，全代码分享！ - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C/C&#43;&#43;编程日记：用C语言实现的简单Web服务器(Linux)，全代码分享！" />
<meta property="og:description" content="相信大家对Apache都有所听闻，Apache是目前使用最为广泛我Web服务器。大家可以从news.netcraft.com/这个网站得到证实。
这是腾讯的uptime.netcraft.com/up/graph?site=www.qq.com.Apache强大的功能和高效的性能并且开放源代码的这种模式对我很有吸引力，但无赖自己水平有限，无法从Apache庞大的source code里面理清头绪。
于是，我就冒出了个自己动手写一个小型的简单的Web服务器的想法，希望对这方面也和我一样感兴趣的朋友有所帮助。
我的实验环境为:
OS:Red Hat Enterprise Linux 5
gcc:4.1.2
libc:2.5
editor:Vim
lang:C
阅读该源代码需要以下预备知识：
C语言基础
Linux编程基础
socket编程基础(Linux)
TCP/IP基本原理
HTTP基本原理
关键字(Key Words):
Linux C, Web HTTP Server, Linux Socket.
-----------------------------------------------------------------------------------
下面是Mutu的第一个版本(0.1 Alpha)，实现了WEB 服务器的最基本功能
包括以下源文件:
webserver.c----程序入口
init_socket.h init_socket.c----完成一些WEB服务器的初始化工作
get_time.h get_time.c----获得服务器的时间
http_session.h http_session.c----处理一次HTTP会话
以下是各文件源码：
webserver.c:
/*
* file:webserver.c
*/
#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;string.h&gt;
#include&lt;strings.h&gt;
#include&lt;unistd.h&gt;
#include&lt;sys/types.h&gt;
#include&lt;sys/socket.h&gt;
#include&lt;netinet/in.h&gt;
#include&lt;arpa/inet.h&gt;
#include&#34;get_time.h&#34;
#include&#34;init_socket.h&#34;
#include&#34;http_session.h&#34;
intmain(intargc,char*argv[])
{
intlisten_fd;
intconnect_fd;
structsockaddr_inserver_addr;
structsockaddr_inclient_addr;
bzero(&amp;server_addr,sizeof(structsockaddr_in));
bzero(&amp;client_addr,sizeof(structsockaddr_in));
if(init_socket(&amp;listen_fd,&amp;server_addr)==-1)
{" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/17e30b7a41884d11cd4ef6cc5152a30c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-17T14:09:56+08:00" />
<meta property="article:modified_time" content="2020-10-17T14:09:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C/C&#43;&#43;编程日记：用C语言实现的简单Web服务器(Linux)，全代码分享！</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>相信大家对Apache都有所听闻，Apache是目前使用最为广泛我Web服务器。大家可以从news.netcraft.com/这个网站得到证实。</p> 
<p>这是腾讯的uptime.netcraft.com/up/graph?site=www.qq.com.Apache强大的功能和高效的性能并且开放源代码的这种模式对我很有吸引力，但无赖自己水平有限，无法从Apache庞大的source code里面理清头绪。</p> 
<p>于是，我就冒出了个自己动手写一个小型的简单的Web服务器的想法，希望对这方面也和我一样感兴趣的朋友有所帮助。</p> 
<p> </p> 
<p><img alt="" src="https://images2.imgbox.com/89/c1/O72RIAzR_o.png"></p> 
<p>我的实验环境为:</p> 
<p>OS:Red Hat Enterprise Linux 5</p> 
<p>gcc:4.1.2</p> 
<p>libc:2.5</p> 
<p>editor:Vim</p> 
<p>lang:C</p> 
<p>阅读该源代码需要以下预备知识：</p> 
<p>C语言基础</p> 
<p>Linux编程基础</p> 
<p>socket编程基础(Linux)</p> 
<p>TCP/IP基本原理</p> 
<p>HTTP基本原理</p> 
<p>关键字(Key Words):</p> 
<p>Linux C, Web HTTP Server, Linux Socket.</p> 
<p>-----------------------------------------------------------------------------------</p> 
<p>下面是Mutu的第一个版本(0.1 Alpha)，实现了WEB 服务器的最基本功能</p> 
<p>包括以下源文件:</p> 
<p>webserver.c----程序入口</p> 
<p>init_socket.h init_socket.c----完成一些WEB服务器的初始化工作</p> 
<p>get_time.h get_time.c----获得服务器的时间</p> 
<p>http_session.h http_session.c----处理一次HTTP会话</p> 
<p>以下是各文件源码：</p> 
<p>webserver.c:</p> 
<p> </p> 
<p><img alt="" src="https://images2.imgbox.com/46/6e/jEKZOodA_o.png"></p> 
<blockquote> 
 <p>/*</p> 
 <p>* file:webserver.c</p> 
 <p>*/</p> 
 <p>#include&lt;stdio.h&gt;</p> 
 <p>#include&lt;stdlib.h&gt;</p> 
 <p>#include&lt;string.h&gt;</p> 
 <p>#include&lt;strings.h&gt;</p> 
 <p>#include&lt;unistd.h&gt;</p> 
 <p>#include&lt;sys/types.h&gt;</p> 
 <p>#include&lt;sys/socket.h&gt;</p> 
 <p>#include&lt;netinet/in.h&gt;</p> 
 <p>#include&lt;arpa/inet.h&gt;</p> 
 <p>#include"get_time.h"</p> 
 <p>#include"init_socket.h"</p> 
 <p>#include"http_session.h"</p> 
 <p>intmain(intargc,char*argv[])</p> 
 <p>{<!-- --></p> 
 <p>intlisten_fd;</p> 
 <p>intconnect_fd;</p> 
 <p>structsockaddr_inserver_addr;</p> 
 <p>structsockaddr_inclient_addr;</p> 
 <p>bzero(&amp;server_addr,sizeof(structsockaddr_in));</p> 
 <p>bzero(&amp;client_addr,sizeof(structsockaddr_in));</p> 
 <p>if(init_socket(&amp;listen_fd,&amp;server_addr)==-1)</p> 
 <p>{<!-- --></p> 
 <p>perror("init_socket() error. in webserver.c");</p> 
 <p>exit(EXIT_FAILURE);</p> 
 <p>}</p> 
 <p>socklen_taddrlen=sizeof(structsockaddr_in);</p> 
 <p>pid_tpid;</p> 
 <p>while(1)</p> 
 <p>{<!-- --></p> 
 <p>if((connect_fd=accept(listen_fd,(structsockaddr*)&amp;client_addr,&amp;addrlen))==-1)</p> 
 <p>{<!-- --></p> 
 <p>perror("accept() error. in webserver.c");</p> 
 <p>continue;</p> 
 <p>}</p> 
 <p>if((pid=fork())&gt;0)</p> 
 <p>{<!-- --></p> 
 <p>close(connect_fd);</p> 
 <p>continue;</p> 
 <p>}</p> 
 <p>elseif(pid==0)</p> 
 <p>{<!-- --></p> 
 <p>close(listen_fd);</p> 
 <p>printf("pid %d process http session from %s : %d\n",getpid(),inet_ntoa(client_addr.sin_addr),htons(client_addr.sin_port));</p> 
 <p>if(http_session(&amp;connect_fd,&amp;client_addr)==-1)</p> 
 <p>{<!-- --></p> 
 <p>perror("http_session() error. in webserver.c");</p> 
 <p>shutdown(connect_fd,SHUT_RDWR);</p> 
 <p>printf("pid %d loss connection to %s\n",getpid(),inet_ntoa(client_addr.sin_addr));</p> 
 <p>exit(EXIT_FAILURE);/* exit from child process, stop this http session  */</p> 
 <p>}</p> 
 <p>printf("pid %d close connection to %s\n",getpid(),inet_ntoa(client_addr.sin_addr));</p> 
 <p>shutdown(connect_fd,SHUT_RDWR);</p> 
 <p>exit(EXIT_SUCCESS);</p> 
 <p>}</p> 
 <p>else</p> 
 <p>{<!-- --></p> 
 <p>perror("fork() error. in webserver.c");</p> 
 <p>exit(EXIT_FAILURE);</p> 
 <p>}</p> 
 <p>}</p> 
 <p>shutdown(listen_fd,SHUT_RDWR);</p> 
 <p>return0;</p> 
 <p>}</p> 
</blockquote> 
<p>init_socket.h</p> 
<blockquote> 
 <p>/*</p> 
 <p>* file:init_socket.h</p> 
 <p>*/</p> 
 <p>#ifndefINIT_SOCKET_H</p> 
 <p>#defineINIT_SOCKET_H</p> 
 <p>#include&lt;netinet/in.h&gt;</p> 
 <p>#defineBACKLOG    20/* length of listening queue on socket */</p> 
 <p>#definePORT    8080/* web server listening port */</p> 
 <p>/* initialize the socket on server, include below</p> 
 <p>socket();</p> 
 <p>bind();</p> 
 <p>listen();</p> 
 <p>*/</p> 
 <p>/* listen_fd : the web server listen file decriptor</p> 
 <p>server_addr: the web server ipv4 address</p> 
 <p>RETURNS: success on 0, error on -1</p> 
 <p>*/</p> 
 <p>intinit_socket(int*listen_fd,structsockaddr_in*server_addr);</p> 
 <p>#endif</p> 
</blockquote> 
<p>init_socket.c</p> 
<blockquote> 
 <p>/*</p> 
 <p>* file:init_socket.c</p> 
 <p>*/</p> 
 <p>#include&lt;stdio.h&gt;</p> 
 <p>#include&lt;strings.h&gt;</p> 
 <p>#include&lt;unistd.h&gt;</p> 
 <p>#include&lt;netinet/in.h&gt;</p> 
 <p>#include&lt;sys/types.h&gt;</p> 
 <p>#include&lt;sys/socket.h&gt;</p> 
 <p>#include"init_socket.h"</p> 
 <p>intinit_socket(int*listen_fd,structsockaddr_in*server_addr)</p> 
 <p>{<!-- --></p> 
 <p>if((*listen_fd=socket(AF_INET,SOCK_STREAM,0))==-1)</p> 
 <p>{<!-- --></p> 
 <p>perror("socket() error. in init_socket.c");</p> 
 <p>return-1;</p> 
 <p>}</p> 
 <p>/* set reuse the port on server machine  */</p> 
 <p>intopt=SO_REUSEADDR;</p> 
 <p>if(setsockopt(*listen_fd,SOL_SOCKET,SO_REUSEADDR,&amp;opt,sizeof(opt))==-1)</p> 
 <p>{<!-- --></p> 
 <p>perror("setsockopt() error.  in init_socket.c");</p> 
 <p>return-1;</p> 
 <p>}</p> 
 <p>server_addr-&gt;sin_family=AF_INET;</p> 
 <p>server_addr-&gt;sin_port=htons(PORT);</p> 
 <p>server_addr-&gt;sin_addr.s_addr=htonl(INADDR_ANY);</p> 
 <p>if(bind(*listen_fd,(structsockaddr*)server_addr,sizeof(structsockaddr_in))==-1)</p> 
 <p>{<!-- --></p> 
 <p>perror("bind() error.  in init_socket.c");</p> 
 <p>return-1;</p> 
 <p>}</p> 
 <p>if(listen(*listen_fd,BACKLOG)==-1)</p> 
 <p>{<!-- --></p> 
 <p>perror("listen() error.  in init_socket.c");</p> 
 <p>return-1;</p> 
 <p>}</p> 
 <p>return0;</p> 
 <p>}</p> 
</blockquote> 
<p>get_time.h</p> 
<blockquote> 
 <p>/*</p> 
 <p>* file: get_time.h</p> 
 <p>*/</p> 
 <p>#ifndefGET_TIME_H</p> 
 <p>#defineGET_TIME_H</p> 
 <p>#defineTIME_BUFFER_SIZE    40/* buffer size of time_buffer  */</p> 
 <p>char*get_time_str(char*time_buf);</p> 
 <p>#endif</p> 
</blockquote> 
<p>get_time.c</p> 
<blockquote> 
 <p>/*</p> 
 <p>* file:get_time.c</p> 
 <p>*/</p> 
 <p>#include&lt;time.h&gt;</p> 
 <p>#include&lt;stdio.h&gt;</p> 
 <p>#include&lt;string.h&gt;</p> 
 <p>#include"get_time.h"</p> 
 <p>/* get the time on server,</p> 
 <p>return: the ascii string of time , NULL on error</p> 
 <p>argument: time_buf the buffer to store time_string</p> 
 <p>*/</p> 
 <p>char*get_time_str(char*time_buf)</p> 
 <p>{<!-- --></p> 
 <p>time_tnow_sec;</p> 
 <p>structtm*time_now;</p> 
 <p>if(time(&amp;now_sec)==-1)</p> 
 <p>{<!-- --></p> 
 <p>perror("time() in get_time.c");</p> 
 <p>returnNULL;</p> 
 <p>}</p> 
 <p>if((time_now=gmtime(&amp;now_sec))==NULL)</p> 
 <p>{<!-- --></p> 
 <p>perror("localtime in get_time.c");</p> 
 <p>returnNULL;</p> 
 <p>}</p> 
 <p>char*str_ptr=NULL;</p> 
 <p>if((str_ptr=asctime(time_now))==NULL)</p> 
 <p>{<!-- --></p> 
 <p>perror("asctime in get_time.c");</p> 
 <p>returnNULL;</p> 
 <p>}</p> 
 <p>strcat(time_buf,str_ptr);</p> 
 <p>returntime_buf;</p> 
 <p>}</p> 
</blockquote> 
<p>http_session.c</p> 
<blockquote> 
 <p>/*</p> 
 <p>* file: http_session.h</p> 
 <p>*/</p> 
 <p>#ifndefHTTP_SESSION_H</p> 
 <p>#defineHTTP_SESSION_H</p> 
 <p>#include&lt;netinet/in.h&gt;</p> 
 <p>#defineRECV_BUFFER_SIZE    1024/* 1KB of receive buffer  */</p> 
 <p>#defineSEND_BUFFER_SIZE    1050000/* 1.xMB of send buffer  */</p> 
 <p>#defineURI_SIZE            128/* length of uri request from client browse */</p> 
 <p>#defineTIME_OUT_SEC        10/* select timeout of secend */</p> 
 <p>#defineTIME_OUT_USEC        0/* select timeout of usecend */</p> 
 <p>#defineFILE_OK                200</p> 
 <p>#defineFILE_FORBIDEN        403/* there are no access permission*/</p> 
 <p>#defineFILE_NOT_FOUND        404/* file not found on server */</p> 
 <p>#defineUNALLOW_METHOD        405/* un allow http request method*/</p> 
 <p>#defineFILE_TOO_LARGE        413/* file is too large */</p> 
 <p>#defineURI_TOO_LONG        414/*  */</p> 
 <p>#defineUNSUPPORT_MIME_TYPE    415</p> 
 <p>#defineUNSUPPORT_HTTP_VERSION    505</p> 
 <p>#defineFILE_MAX_SIZE        1048576/* 1MB the max siee of file read from hard disk */</p> 
 <p>#defineALLOW"Allow:GET"/* the server allow GET request method*/</p> 
 <p>#defineSERVER"Server:Mutu(0.1 Alpha)/Linux"</p> 
 <p>/* if the connect protocol is http then this function deal with it  */</p> 
 <p>inthttp_session(int*connect_fd,structsockaddr_in*client_addr);</p> 
 <p>/* if http protocol return 1, else return 0 */</p> 
 <p>intis_http_protocol(char*msg_from_client);</p> 
 <p>/* get the request header's uri */</p> 
 <p>char*get_uri(char*req_header,char*uri_buf);</p> 
 <p>/* get the uri status,access return 0, not exist return 1, permission deny return 2, error return -1 */</p> 
 <p>intget_uri_status(char*uri);</p> 
 <p>/* get the mime type of the file request in uri from client's browse */</p> 
 <p>char*get_mime_type(char*uri);</p> 
 <p>/* read the file which requested by client in uri ,and store in entity_buf.</p> 
 <p>success return bytes readed,error return -1</p> 
 <p>*/</p> 
 <p>intget_file_disk(char*uri,unsignedchar*entity_buf);</p> 
 <p>/* set http replay header's status:</p> 
 <p>200:ok</p> 
 <p>404:file not found</p> 
 <p>*/</p> 
 <p>intset_rep_status();</p> 
 <p>intset_error_information(unsignedchar*send_buf,interrorno);</p> 
 <p>intreply_normal_information(unsignedchar*send_buf,unsignedchar*file_buf,intfile_size,char*mime_type);</p> 
 <p>#endif</p> 
</blockquote> 
<p>如何访问该服务器呢？</p> 
<p>首先你要知道运行服务器主机的IP，在服务器主机上输入如下命令(需要超级用户权限)：</p> 
<p>ifconfig</p> 
<p> </p> 
<p><img alt="" src="https://images2.imgbox.com/ef/59/RgQJtHP6_o.png"></p> 
<p>如果你的是以太网(ethernet),那么会看到这样一行</p> 
<p>inet addr:xxx.xxx.xxx broadcast:xxx.xxx.xxx.xxx mask:255.xxx.xxx.xxx</p> 
<p>xxx代表数字（000-255），第一个inet addr后面的数字便是你的网卡地址。</p> 
<p style="text-align:center;"><img alt="" height="270" src="https://images2.imgbox.com/9f/10/Kvtzz8CX_o.gif" width="480"></p> 
<p>如果你是在本机进行测试，那IP地址可以直接用127.0.0.1(回环地址，localhost)</p> 
<p>取得服务器的IP后，用你喜欢的一款浏览器便可以访问WEB SERVER的内容了。</p> 
<p>方法为：在浏览器的地址栏内输入:</p> 
<p>http://xxx.xxx.xxx.xxx:8080</p> 
<p>回车，即可（xxx.xxx.xxx.xxx无刚取得的服务器IP地址，8080为预设的端口）。</p> 
<p><a href="https://jq.qq.com/?_wv=1027&amp;k=PQZgqqcn" rel="nofollow">点击了解更多资料，更有免费开源项目和课程等你观看哦！</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/437571b2c82b68a2614546b7a03d868f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">操作POSTMAN请求WebService的操作记录</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/65fe502083ab86b9dcce58f40364ddf5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">markdown语法最全汇总</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>