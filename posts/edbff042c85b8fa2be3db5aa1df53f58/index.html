<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>prometheus relabel_config 详解加示例 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="prometheus relabel_config 详解加示例" />
<meta property="og:description" content="relabel_config配置 Relabeling(重定义标签),是在拉取(scraping)阶段前,修改target和它的labels;
在每个scrape_configs可以定义多个重定义标签的步骤;
默认的, target的job标签设置为配置文件里的job_name的值;
__address__设置为配置里的targets的值;
而instance标签的值,是重定义标签操作之后__address__的值
__scheme__和__metrics_path__标签的值,也是从配置里取值的;
__param_&lt;name&gt;标签的值,是传给URL的查询参数&lt;name&gt;的值;
以__meta_开头的标签,也可以用于重定义标签;
重定义标签完成后,__开头的标签会被删除;
重定义标签阶段,如果要临时存储值用于下一阶段的处理,使用__tmp开头的标签名,这种标签不会被Prometheus使用;
# 从已有的标签选择值的源标签组;多个标签,使用separator分隔; # regex匹配源标签里的值 # 动作为replace, keep, 和 drop [ source_labels: &#39;[&#39; &lt;labelname&gt; [, ...] &#39;]&#39; ] # 多个源标签的分隔符; [ separator: &lt;string&gt; | default = ; ] # replace动作必需,regex匹配到的值,要替换的目标标签; [ target_label: &lt;labelname&gt; ] # 正则匹配源标签的值 [ regex: &lt;regex&gt; | default = (.*) ] # 源标签值取hash的模块; [ modulus: &lt;uint64&gt; ] # 要替换的匹配分组号 [ replacement: &lt;string&gt; | default = $1 ] # 基于正则匹配的动作 [ action: &lt;relabel_action&gt; | default = replace ] 正则匹配是到结尾的, 可以使用." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/edbff042c85b8fa2be3db5aa1df53f58/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-25T23:03:46+08:00" />
<meta property="article:modified_time" content="2020-04-25T23:03:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">prometheus relabel_config 详解加示例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="relabel_config_0"></a>relabel_config配置</h4> 
<p>Relabeling(重定义标签),是在拉取(scraping)阶段前,修改target和它的labels;<br> 在每个<code>scrape_configs</code>可以定义多个重定义标签的步骤;</p> 
<p>默认的, target的<code>job</code>标签设置为配置文件里的<code>job_name</code>的值;<br> <code>__address__</code>设置为配置里的<code>targets</code>的值;<br> 而<code>instance</code>标签的值,是重定义标签操作之后<code>__address__</code>的值<br> <code>__scheme__和__metrics_path__</code>标签的值,也是从配置里取值的;<br> <code>__param_&lt;name&gt;</code>标签的值,是传给URL的查询参数<code>&lt;name&gt;</code>的值;</p> 
<p>以<code>__meta_</code>开头的标签,也可以用于重定义标签;</p> 
<p>重定义标签完成后,<code>__</code>开头的标签会被删除;</p> 
<p>重定义标签阶段,如果要临时存储值用于下一阶段的处理,使用<code>__tmp</code>开头的标签名,这种标签不会被Prometheus使用;</p> 
<pre><code># 从已有的标签选择值的源标签组;多个标签,使用separator分隔;
# regex匹配源标签里的值
# 动作为replace, keep, 和 drop
[ source_labels: '[' &lt;labelname&gt; [, ...] ']' ]
# 多个源标签的分隔符;
[ separator: &lt;string&gt; | default = ; ]
# replace动作必需,regex匹配到的值,要替换的目标标签;
[ target_label: &lt;labelname&gt; ]
# 正则匹配源标签的值
[ regex: &lt;regex&gt; | default = (.*) ]
# 源标签值取hash的模块;
[ modulus: &lt;uint64&gt; ]
# 要替换的匹配分组号
[ replacement: &lt;string&gt; | default = $1 ]
# 基于正则匹配的动作
[ action: &lt;relabel_action&gt; | default = replace ]
</code></pre> 
<p>正则匹配是到结尾的, 可以使用<code>.*&lt;regex&gt;.*</code>匹配更多内容</p> 
<h4><a id="relabel_action_37"></a>relabel_action</h4> 
<pre><code>replace: 正则匹配源标签的值用来替换目标标签;如果有replacement,使用replacement替换目标标签;
keep: 如果正则没有匹配到源标签,删除targets 
drop: 正则匹配到源标签,删除targets
hashmod: 设置目标标签值为源标签值的hash值
labelmap: 正则匹配所有标签名; 将匹配的标签的值复制到由replacement提供的标签名
labeldrop: 正则匹配所有标签名;匹配则移除标签;
labelkeep: 正则匹配所有标签名;不匹配的标签会被移除;
</code></pre> 
<h4><a id="_48"></a>示例环境</h4> 
<p>使用默认的prometheus target和监控指标</p> 
<p>默认配置文件</p> 
<pre><code>cat prometheus.yml
------
global:
  scrape_interval:     15s
  evaluation_interval: 15s
alerting:
  alertmanagers:
  - static_configs:
    - targets:
rule_files:
scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
======
</code></pre> 
<p>查看target</p> 
<pre><code>curl 'http://localhost:9090/api/v1/targets?state=active'
------
{
	"status": "success",
	"data": {
		"activeTargets": [{
			"discoveredLabels": { // 这块只能作为源标签
				"__address__": "localhost:9090",
				"__metrics_path__": "/metrics",
				"__scheme__": "http",
				"job": "prometheus"
			},
			"labels": {
				"instance": "localhost:9090",
				"job": "prometheus"
			},
			"scrapePool": "prometheus",
			"scrapeUrl": "http://localhost:9090/metrics",
			"lastError": "",
			"lastScrape": "2020-04-25T08:42:19.254191755-04:00",
			"lastScrapeDuration": 0.012091634,
			"health": "up"
		}],
		"droppedTargets": []
	}
}
======
</code></pre> 
<p>relabel_config主要是处理target的labels字段</p> 
<h4><a id="_101"></a>重载配置命令</h4> 
<pre><code># 检查配置
./promtool check config prometheus.yml
# 重载配置;需要以--web.enable-lifecycle启动promethues
curl -X POST http://localhost:9090/-/reload
# 查看使用的配置 
curl http://localhost:9090/api/v1/status/config
</code></pre> 
<h4><a id="_111"></a>添加自定义标签</h4> 
<p>添加2个自定义标签,用于后续的演示</p> 
<pre><code>vi prometheus.yml
------
scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels: 
          userLabel1: value1
          userLabel2: value2
======
</code></pre> 
<p>重载配置后查询</p> 
<pre><code>curl 'http://localhost:9090/api/v1/targets?state=active'
------
{
	"status": "success",
	"data": {
		"activeTargets": [{
			"discoveredLabels": {
				"__address__": "localhost:9090",
				"__metrics_path__": "/metrics",
				"__scheme__": "http",
				"job": "prometheus",
				"userLabel1": "value1", //新增
				"userLabel2": "value2"  //新增
			},
			"labels": {
				"instance": "localhost:9090",
				"job": "prometheus",
				"userLabel1": "value1",  //新增
				"userLabel2": "value2"  //新增
			},
            ...
		}],
		"droppedTargets": []
	}
}
</code></pre> 
<h4><a id="_154"></a>替换标签的值</h4> 
<p>用源标签的值,替换目标标签的值</p> 
<pre><code>vi prometheus.yml
------
scrape_configs:
    ...
    relabel_configs:
    - source_labels: [userLabel1] 
      target_label:  userLabel2
      #默认action 是 'replace'
======
</code></pre> 
<p>重载配置后查询</p> 
<pre><code>curl 'http://localhost:9090/api/v1/targets?state=active'
------
			"discoveredLabels": {
				"__address__": "localhost:9090",
				"__metrics_path__": "/metrics",
				"__scheme__": "http",
				"job": "prometheus",
				"userLabel1": "value1", //不变
				"userLabel2": "value2"  //不变
			},
			"labels": {
				"instance": "localhost:9090",
				"job": "prometheus",
				"userLabel1": "value1",
				"userLabel2": "value1"  //用userLabel1的值替换了userLabel2
			},
======
</code></pre> 
<p><strong>relabel_configs是在拉取(scraping)前,修改target和它的labels</strong></p> 
<p>用userLabel1的部分值替换userLabel2</p> 
<pre><code>vi prometheus.yml
------
scrape_configs:
    ...
    relabel_configs:
    - source_labels: [userLabel1]
      regex: 'value([0-9]+)'
      target_label:  userLabel2
      replacement: '$1'
      action: replace
======
</code></pre> 
<p>重载配置后查询</p> 
<pre><code>curl 'http://localhost:9090/api/v1/targets?state=active'
------
			"labels": {
				"instance": "localhost:9090",
				"job": "prometheus",
				"userLabel1": "value1",
				"userLabel2": "1"
			},
======
</code></pre> 
<h4><a id="_216"></a>删除匹配的标签</h4> 
<pre><code>vi prometheus.yml
------
scrape_configs:
    ...
    relabel_configs:
    - regex: userLabel1
      action: labeldrop
======      
</code></pre> 
<p>重载配置后查询</p> 
<pre><code>curl 'http://localhost:9090/api/v1/targets?state=active'
------
{
	"status": "success",
	"data": {
		"activeTargets": [{
			"discoveredLabels": { //这部分只能做为源标签
				"__address__": "localhost:9090",
				"__metrics_path__": "/metrics",
				"__scheme__": "http",
				"job": "prometheus",
				"userLabel1": "value1",
				"userLabel2": "value2"
			},
			"labels": {
				"instance": "localhost:9090",
				"job": "prometheus",
				"userLabel2": "value2" //删除了userLabel1
			},
            ...
	}
}
======
</code></pre> 
<h4><a id="target_254"></a>删除匹配的target</h4> 
<pre><code>vi prometheus.yml
------
scrape_configs:
    ...
    relabel_configs:
    - source_labels: [userLabel1] 
      action: drop
======      
</code></pre> 
<p>重载配置后查询</p> 
<pre><code>curl 'http://localhost:9090/api/v1/targets?state=active'
------
{
	"status": "success",
	"data": {
		"activeTargets": [],
		"droppedTargets": []
	}
}
======
</code></pre> 
<h4><a id="_279"></a>取匹配的标签名的一部分生成新标签</h4> 
<pre><code>vi prometheus.yml
------
scrape_configs:
    ...
    relabel_configs:
    - regex: user(.*)1
      action: labelmap
======      
</code></pre> 
<p>重载配置后查询</p> 
<pre><code>curl 'http://localhost:9090/api/v1/targets?state=active'
------
			"labels": {
				"Label": "value1", //新生成的标签
				"instance": "localhost:9090",
				"job": "prometheus",
				"userLabel1": "value1",
				"userLabel2": "value2"
			},
======
</code></pre> 
<p>参考链接<br> <a href="https://github.com/prometheus/prometheus/blob/release-2.16/config/testdata/conf.good.yml">官方配置示例</a><br> <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/" rel="nofollow">官方文档</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8757d16cb37648b6367fa87d75e23993/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何通过代码插桩的方式在任何apk添加自己的逻辑代码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bd73e675e3f26780b730c00e9f110ad9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">PG进入单用户模式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>