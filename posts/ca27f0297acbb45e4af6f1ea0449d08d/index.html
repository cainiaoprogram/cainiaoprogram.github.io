<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Vue项目按需请求，组件数据懒加载—@vueuse/core中 useIntersectionObserver的使用 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Vue项目按需请求，组件数据懒加载—@vueuse/core中 useIntersectionObserver的使用" />
<meta property="og:description" content="Vue项目按需请求，组件数据懒加载—@vueuse/core中 useIntersectionObserver的使用 一、通过监听 scroll 事件实现 import { ref } from &#39;vue&#39;; // 响应式数据，用于是否显示固定头部 const isShow = ref(false); // 监听浏览器滚动事件 window.addEventListener(&#39;scroll&#39;, () =&gt; { // 获取滚动出去的距离 const top = document.documentElement.scrollTop; if (top &gt;= 78) { // 大于等于 78 显示盒子 isShow.value = true; } else { // 反之隐藏盒子 isShow.value = false; } }); // tempalte &lt;div class=&#34;app-header-sticky&#34; :class=&#34;{ show: isShow }&#34;&gt;&lt;/div&gt; 二、通过 @vueuse/core实现 即当模块进入到 可视区 ，再发请求获取数据
使用 @vueuse/core 中的 useIntersectionObserver 来实现监听组件进入可视区域行为，" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ca27f0297acbb45e4af6f1ea0449d08d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-30T10:45:43+08:00" />
<meta property="article:modified_time" content="2022-08-30T10:45:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Vue项目按需请求，组件数据懒加载—@vueuse/core中 useIntersectionObserver的使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Vuevueusecore_useIntersectionObserver_0"></a>Vue项目按需请求，组件数据懒加载—<code>@vueuse/core</code>中 <code>useIntersectionObserver</code>的使用</h2> 
<h4><a id="_scroll__2"></a>一、通过监听 scroll 事件实现</h4> 
<pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>

<span class="token comment">// 响应式数据，用于是否显示固定头部</span>
<span class="token keyword">const</span> isShow <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 监听浏览器滚动事件</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 获取滚动出去的距离</span>
  <span class="token keyword">const</span> top <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">&gt;=</span> <span class="token number">78</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 大于等于 78 显示盒子</span>
    isShow<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 反之隐藏盒子</span>
    isShow<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// tempalte</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"app-header-sticky"</span> <span class="token operator">:</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"{ show: isShow }"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> 
<h4><a id="_vueusecore_28"></a>二、通过 <code>@vueuse/core</code>实现</h4> 
<blockquote> 
 <p>即当模块进入到 可视区 ，再发请求获取数据</p> 
</blockquote> 
<p>使用 <code>@vueuse/core</code> 中的 <code>useIntersectionObserver</code> 来实现监听组件进入可视区域行为，</p> 
<p>需要配合 <code>vue3</code> 的组合 <code>API</code> 的方式才能实现 <a href="https://vueuse.org/core/useIntersectionObserver/" rel="nofollow">可参考官网</a></p> 
<p>先分析下这个<code>useIntersectionObserver</code> 函数：</p> 
<h5><a id="_38"></a>✨核心单词解释：</h5> 
<ul><li><code>useIntersectionObserver</code> 检查元素是否进入可视区函数</li><li><code>target</code> 目标元素，🎯需配合模板 ref 使用</li><li><code>isIntersecting </code> 是否进入可视区(布尔值)</li><li><code>stop</code> 用于停止检测的函数</li></ul> 
<pre><code class="prism language-ts"><span class="token operator">&lt;</span>script setup lang<span class="token operator">=</span><span class="token string">"ts"</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> useIntersectionObserver <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vueuse/core'</span><span class="token punctuation">;</span>

<span class="token comment">// 准备目标元素(DOM节点或组件，需配合模板 ref 使用)</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> stop <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useIntersectionObserver</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span> isIntersecting <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'检测元素可见性'</span><span class="token punctuation">,</span> isIntersecting<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 需求：如果目标元素进入可视区，就发送请求，并停止检测</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isIntersecting<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 当目标元素进入可视区域时，才发送请求</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'进入可视区，需要发送请求'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 请求已发送，主动停止检查</span>
    <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token string">"height: 2000px"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 🎯目标元素需添加模板 ref  <span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token string">"target"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>🎯我是目标元素🎯<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token string">"height: 2000px"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

</code></pre> 
<h4><a id="_78"></a>组件数据懒加载逻辑复用</h4> 
<p><code>本节目标:</code> 抽离组件数据懒加载可复用的逻辑</p> 
<h5><a id="_82"></a>现存问题</h5> 
<blockquote> 
 <p>首页中，很多地方都应该使用组件数据懒加载这个功能，不管是哪个模块使用，下面代码都会重复书写。</p> 
</blockquote> 
<p>事实上，唯一可能会随着业务使用发生变化的是 ajax接口的调用，其余的部分我们进行重复使用，抽离为可复用逻辑</p> 
<p><img src="https://images2.imgbox.com/54/1c/rUNTrf2O_o.png" alt="请添加图片描述"></p> 
<h5><a id="_91"></a>抽离通用逻辑</h5> 
<p>1）抽离逻辑</p> 
<p><code>src/hooks/index.ts</code></p> 
<ul><li>hooks.ts 封装常用的 组合式 API 函数</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> useIntersectionObserver <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@vueuse/core"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"vue"</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 请求按需加载
 * @param apiFn 发送请求函数
 * @returns  🚨 target 用于模板绑定
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">useObserver</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function-variable function">apiFn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 准备个 ref 用于绑定模板中的某个目标元素(DOM节点或组件)</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> stop <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useIntersectionObserver</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span> isIntersecting <span class="token punctuation">}</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"是否进入可视区域"</span><span class="token punctuation">,</span> isIntersecting<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isIntersecting<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 当目标元素进入可视区域时，才发送请求</span>
      <span class="token function">apiFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 请求已发送，主动停止检查</span>
      <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 🚨返回 ref 用于模板绑定，建议返回对象格式支持解构获取</span>
  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span> target <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>2）业务改写</p> 
<pre><code class="prism language-ts"><span class="token operator">&lt;</span>script setup lang<span class="token operator">=</span><span class="token string">"ts"</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> RouterLink <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"vue-router"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useStore <span class="token keyword">from</span> <span class="token string">"@/store"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> HomePanel <span class="token keyword">from</span> <span class="token string">"./home-panel.vue"</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> useObserver <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@/hooks"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> home <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> target <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useObserver</span><span class="token punctuation">(</span>home<span class="token punctuation">.</span>getHotGoodsList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4293b047ebb20fec21066e6fa79c0fe4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决vue3&#43;ts，内嵌vue2代码，无法使用$refs的问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0c4546e7238fcbb08c11a35b86707a22/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue分页监听</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>