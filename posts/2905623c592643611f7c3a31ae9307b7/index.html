<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【RTSP流】使用flv.js &#43; websocket播放rtsp视频流（h264） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【RTSP流】使用flv.js &#43; websocket播放rtsp视频流（h264）" />
<meta property="og:description" content="1 引言
在项目开发过程中经常需要接视频流。之前大都接的是HLS格式的流，这是Html5的video标签直接支持的。最近需要接rtsp流，web端目前不支持直接播放。本文提供一种方法直接播放rtsp流，不需要安装插件。
2 基于flv.js的RTSP播放方案
HTML5 原生仅支持播放 mp4/webm 格式，是不支持 FLV格式的。 flash性能问题是长期以来被全世界人所诟病的，尤其是以后chrome将彻底抛弃flash，越来越多有直播需求的人产生焦虑。这就加速了html5播放器的发展，也使得人们对html5非插件式的播放器更加渴望。而flv.js就是这么一款可以利用html5的video标签将http-flv直播流实时播放的一个js版的播放器。
2.1 使用node构建服务器端
目录如下所示：
package.json
{ &#34;name&#34;: &#34;ffmpeg-server&#34;, &#34;version&#34;: &#34;1.0.0&#34;, &#34;description&#34;: &#34;&#34;, &#34;main&#34;: &#34;index.js&#34;, &#34;scripts&#34;: { &#34;test&#34;: &#34;echo \&#34;Error: no test specified\&#34; &amp;&amp; exit 1&#34; }, &#34;author&#34;: &#34;&#34;, &#34;license&#34;: &#34;ISC&#34;, &#34;devDependencies&#34;: { &#34;express&#34;: &#34;^4.17.1&#34;, &#34;express-ws&#34;: &#34;^4.0.0&#34;, &#34;ffmpeg&#34;: &#34;0.0.4&#34;, &#34;fluent-ffmpeg&#34;: &#34;^2.1.2&#34;, &#34;http&#34;: &#34;0.0.0&#34;, &#34;websocket-stream&#34;: &#34;^5.5.0&#34; } } index2.js
var express = require(&#34;express&#34;); var expressWebSocket = require(&#34;express-ws&#34;); var ffmpeg = require(&#34;fluent-ffmpeg&#34;); ffmpeg." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2905623c592643611f7c3a31ae9307b7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-29T17:28:27+08:00" />
<meta property="article:modified_time" content="2022-04-29T17:28:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【RTSP流】使用flv.js &#43; websocket播放rtsp视频流（h264）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>1 引言</strong></p> 
<p>在项目开发过程中经常需要接视频流。之前大都接的是HLS格式的流，这是Html5的video标签直接支持的。最近需要接rtsp流，web端目前不支持直接播放。本文提供一种方法直接播放rtsp流，不需要安装插件。</p> 
<p><strong>2  基于flv.js的RTSP播放方案</strong></p> 
<p>HTML5 原生仅支持播放 mp4/webm 格式，是不支持 FLV格式的。 flash性能问题是长期以来被全世界人所诟病的，尤其是以后chrome将彻底抛弃flash，越来越多有直播需求的人产生焦虑。这就加速了html5播放器的发展，也使得人们对html5非插件式的播放器更加渴望。而flv.js就是这么一款可以利用html5的video标签将http-flv直播流实时播放的一个js版的播放器。</p> 
<p>2.1 使用node构建服务器端</p> 
<p>目录如下所示：</p> 
<p><img alt="" height="154" src="https://images2.imgbox.com/f3/1c/tbAi5MvL_o.png" width="414"></p> 
<p>package.json</p> 
<pre><code class="language-java">{
  "name": "ffmpeg-server",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"
  },
  "author": "",
  "license": "ISC",
  "devDependencies": {
    "express": "^4.17.1",
    "express-ws": "^4.0.0",
    "ffmpeg": "0.0.4",
    "fluent-ffmpeg": "^2.1.2",
    "http": "0.0.0",
    "websocket-stream": "^5.5.0"
  }
}</code></pre> 
<p>index2.js</p> 
<pre><code class="language-javascript">var express =  require("express");
var expressWebSocket = require("express-ws");
var ffmpeg = require("fluent-ffmpeg");
ffmpeg.setFfmpegPath("G:/ffmpeg/ffmpeg/ffmpeg-4.3.1-win64-static/bin/ffmpeg");
var webSocketStream = require("websocket-stream/stream");
var WebSocket = require("websocket-stream");
var http = require("http");
function localServer() {
    let app = express();
    app.use(express.static(__dirname));
    expressWebSocket(app, null, {
        perMessageDeflate: true
    });
    app.ws("/rtsp/:id/", rtspRequestHandle)
    app.listen(8888);
    console.log("express listened")
}
function rtspRequestHandle(ws, req) {
    console.log("rtsp request handle");
    const stream = webSocketStream(ws, {
        binary: true,
        browserBufferTimeout: 1000000
    }, {
        browserBufferTimeout: 1000000
    });
    let url = req.query.url;
    // console.log("rtsp url:", url);
    // console.log("rtsp params:", req.params);
    try {
        ffmpeg(url)
            .addInputOption("-rtsp_transport", "tcp", "-buffer_size", "102400")  // 这里可以添加一些 RTSP 优化的参数
            .on("start", function () {
                console.log(url, "Stream started.");
            })
            .on("codecData", function () {
                console.log(url, "Stream codecData.")
             // 摄像机在线处理
            })
            .on("error", function (err) {
                console.log(url, "An error occured: ", err.message);
            })
            .on("end", function () {
                console.log(url, "Stream end!");
             // 摄像机断线的处理
            })
            .outputFormat("flv").videoCodec("libx264").noAudio().pipe(stream);
    } catch (error) {
        console.log(error);
    }
}
localServer();</code></pre> 
<p>直接启动：</p> 
<p><img alt="" height="170" src="https://images2.imgbox.com/46/6c/id3fZKqy_o.png" width="700"></p> 
<p>2.2 客户端</p> 
<p>前端要安装flv.js，执行 npm install flv.js -S -D</p> 
<pre><code class="language-html">&lt;template&gt;
  &lt;div class="video-box"&gt;
    &lt;video controls="controls" class="demo-video" ref="player" muted  @dblclick="fullScreen"&gt;&lt;/video&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import flvjs from 'flv.js'
export default {
  name: 'Home',
  components: {},
  data () {
    return {
      player: null,
      loading: true
    }
  },
  mounted () {
    this.playVideo()
  },
  watch: {
    rtsp: {
      handler: function (val) {
        if (val) {
          if (this.player) {
            this.player.unload()
            this.player.destroy()
            this.player = null
            this.loading = true
          }
          this.$nextTick(() =&gt; {
            this.playVideo()
          })
        }
      },
      immediate: true
    }
  },
  methods: {
    fullScreen () {
      if (this.$refs.player.requestFullScreen) {
        this.$refs.player.requestFullScreen()
      } else if (this.$refs.player.mozRequestFullScreen) {
        this.$refs.player.mozRequestFullScreen()
      } else if (this.$refs.player.webkitRequestFullScreen) {
        this.$refs.player.webkitRequestFullScreen()
      }
    },
    playVideo () {
      const time1 = new Date().getTime()
      if (flvjs.isSupported()) {
        let video = this.$refs.player
        if (video) {
          this.player = flvjs.createPlayer({
            type: 'flv',
            isLive: true,
            url: `ws://192.168.80.49:8888/rtsp/id123?url=rtsp://192.168.80.49:8554/mystream`

          })
          this.player.attachMediaElement(video)
          try {
            this.player.load()
            this.player.play().then(() =&gt; {
              console.log(new Date().getTime() - time1)
              this.loading = false
            })
          } catch (error) {
            console.log(error)
          }
        }
      }
    }
  },
  beforeDestroy () {
    if (this.player) {
      this.player.unload()
      this.player.destroy()
      this.player = null
    }
  }
}
&lt;/script&gt;
&lt;style&gt;
.video-box {
  width: 100%;
  height: 100%;
}
video {
  width: 100%;
  height: 100%;
  object-fit: fill;
}
video::-webkit-media-controls-play-button {
  display: none;
}
video::-webkit-media-controls-current-time-display {
  display: none;
}
video::-webkit-media-controls-timeline {
  display: none;
}
&lt;/style&gt;


</code></pre> 
<p>相关概念：</p> 
<p>1，流媒体</p> 
<p>流媒体不是一种新的媒体，而是一种信息传达技术，与传统传达技术主要区别就是播放终端。流媒体技术可以在不下载信息，比如声音，视频，以及多媒体信息，的情况下直接通过缓冲观看。也就是你不用下载音乐或视频，或者用一个磁带之类的载体。</p> 
<p><br><br> 作者：二斗豆子<br> 链接：https://www.zhihu.com/question/20906684/answer/908577649<br> 来源：知乎<br> 著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p> 
<p></p> 
<p>参考文章：</p> 
<p>[1] <a href="https://blog.csdn.net/qq_32584661/article/details/103276360" title="使用bilibili开源的flvjs实现摄像头rtsp视频直播_一只程序媛-CSDN博客_bilibili flv.js">使用bilibili开源的flvjs实现摄像头rtsp视频直播_一只程序媛-CSDN博客_bilibili flv.js</a></p> 
<p>[2] <a href="https://www.cnblogs.com/liuqin-always/p/13853100.html" rel="nofollow" title="使用flv.js + websokect播放rtsp格式视频流 - 骄阳似我_lq - 博客园">使用flv.js + websokect播放rtsp格式视频流 - 骄阳似我_lq - 博客园</a></p> 
<p>[3] <a href="https://zhuanlan.zhihu.com/p/75406976" rel="nofollow" title="HTML5 播放 RTSP 视频 - 知乎">HTML5 播放 RTSP 视频 - 知乎</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7859a242a5735573991a35530abc7aec/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">linux docker 使用centos镜像创建容器，内部搭建宝塔面板过程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/34160d07e92162f068df6950f54e4410/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SpringBoot集成RabbitMQ---保证消息可靠性</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>