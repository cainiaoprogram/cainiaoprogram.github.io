<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>input子系统理论与实例分析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="input子系统理论与实例分析" />
<meta property="og:description" content="目录 前言基础知识数据结构evbit 上报事件类型input设备API 按键输入驱动实例上报输入事件 触摸屏部分电阻屏数据电容屏数据多点触摸协议（MT） 实战：基于tslib，不断打印2个触点的距离tslib库的用处数据结构应用程序 前言 直接上图：（图片来源于正点原子笔记）
（输入子系统对触摸屏狠重要，会用 TS Handler 狠重要！）
驱动层：输入设备的具体驱动程序，比如按键驱动程序，向内核层报告输入内容。
核心层：承上启下，为驱动层提供输入设备注册和操作接口。通知事件层对输入事件进行
处理。
事件层：和用户空间进行交互。
驱动触发消息，内核收集后产生对应的回调任务，事件层就可以执行内核发布的回调任务。
为什么不直接内核执行任务？你当内核傻啊，内核主要就是调度任务，这个更重要。任务下发后就可以被更重要的任务阻塞。
基础知识 驱动程序上报的数据含义三项重要内容：
type：哪类？例如 EV_KEY 按键类
code：哪个？例如 KEY_A
value：值，例如 0 按下，1 松开
而应用层可以得到一个输入事件，一个个 struct input_event：
数据结构 /* include/uapi/linux/input.h */ struct input_event{ __u16 type; __u16 code; __u16 value; }; /* include/uapi/linux/time.h */ struct timeval{ __kernel_time_t tv_sec; //秒 __kernel_suseconds_t tv_usec; //微秒 } /* 每个输入事件 input_event 中含有发生时间，timeval 表示的是自系统启动以后过了多少时间。*/ 所有输入设备都可以在 /proc/bus/input/devices 中显示。
描述输入设备的结构体：
/* include/uapi/linux/input.h */ struct input_dev { const char *name;//输入设备的名字 const char *phys;//在系统层次结构中设备的物理路径; const char *uniq; struct input_id id;//输入设备id,包含总线类型,制造商id,产品id和版本号等; unsigned long propbit[BITS_TO_LONGS(INPUT_PROP_CNT)]; //设备属性和怪异位图 unsigned long evbit[BITS_TO_LONGS(EV_CNT)]; //设备支持的事件类型;EV_KEY, EV_REL; unsigned long keybit[BITS_TO_LONGS(KEY_CNT)]; //设备具有的按键(能够报告的) unsigned long relbit[BITS_TO_LONGS(REL_CNT)]; //设备相对轴 unsigned long absbit[BITS_TO_LONGS(ABS_CNT)]; //绝对坐标的位图 unsigned long mscbit[BITS_TO_LONGS(MSC_CNT)]; //设备支持的杂项设备事件 unsigned long ledbit[BITS_TO_LONGS(LED_CNT)]; //设备存在的led位图 unsigned long sndbit[BITS_TO_LONGS(SND_CNT)]; //设备支持的声音效果 unsigned long ffbit[BITS_TO_LONGS(FF_CNT)]; //设备支持的力反馈效果位图 unsigned long swbit[BITS_TO_LONGS(SW_CNT)]; //设备存在的开关位图 /*以上支持哪些位就ke&#39;y unsigned int hint_events_per_packet; unsigned int keycodemax; //按键编码表的大小; unsigned int keycodesize; //按键编码表中每个编码的大小 void *keycode;//按键编码表 int (*open)(struct input_dev *dev); //打开设备 void (*close)(struct input_dev *dev); //关闭设备 ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a3be8128d48f95f053e817fbbb88f5b0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-01T01:51:47+08:00" />
<meta property="article:modified_time" content="2023-09-01T01:51:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">input子系统理论与实例分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#_12" rel="nofollow">基础知识</a></li><li><ul><li><a href="#_19" rel="nofollow">数据结构</a></li><li><a href="#evbit__75" rel="nofollow">evbit 上报事件类型</a></li><li><a href="#inputAPI_110" rel="nofollow">input设备API</a></li></ul> 
  </li><li><a href="#_181" rel="nofollow">按键输入驱动实例</a></li><li><ul><li><a href="#_365" rel="nofollow">上报输入事件</a></li></ul> 
  </li><li><a href="#_459" rel="nofollow">触摸屏部分</a></li><li><ul><li><a href="#_460" rel="nofollow">电阻屏数据</a></li><li><a href="#_477" rel="nofollow">电容屏数据</a></li><li><ul><li><a href="#MT_478" rel="nofollow">多点触摸协议（MT）</a></li></ul> 
  </li></ul> 
  </li><li><a href="#tslib2_558" rel="nofollow">实战：基于tslib，不断打印2个触点的距离</a></li><li><ul><li><a href="#tslib_560" rel="nofollow">tslib库的用处</a></li><li><a href="#_567" rel="nofollow">数据结构</a></li><li><a href="#_627" rel="nofollow">应用程序</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>前言</h2> 
<p>直接上图：（图片来源于正点原子笔记）<br> <img src="https://images2.imgbox.com/c5/3c/JsSivn2W_o.png" alt="在这里插入图片描述"><br> （输入子系统对触摸屏狠重要，会用 TS Handler 狠重要！）<br> 驱动层：输入设备的具体驱动程序，比如按键驱动程序，向内核层报告输入内容。<br> 核心层：承上启下，为驱动层提供输入设备注册和操作接口。通知事件层对输入事件进行<br> 处理。<br> 事件层：和用户空间进行交互。<br> 驱动触发消息，内核收集后产生对应的回调任务，事件层就可以执行内核发布的回调任务。<br> 为什么不直接内核执行任务？你当内核傻啊，内核主要就是调度任务，这个更重要。任务下发后就可以被更重要的任务阻塞。</p> 
<h2><a id="_12"></a>基础知识</h2> 
<p>驱动程序上报的数据含义<strong>三项重要内容</strong>：<br> <strong>type</strong>：哪类？例如 EV_KEY 按键类<br> <strong>code</strong>：哪个？例如 KEY_A<br> <strong>value</strong>：值，例如 0 按下，1 松开<br> 而应用层可以得到一个输入事件，一个个 struct input_event：</p> 
<h3><a id="_19"></a>数据结构</h3> 
<pre><code class="prism language-c"><span class="token comment">/* include/uapi/linux/input.h */</span>
<span class="token keyword">struct</span> <span class="token class-name">input_event</span><span class="token punctuation">{<!-- --></span>
    __u16 type<span class="token punctuation">;</span>
    __u16 code<span class="token punctuation">;</span>
    __u16 value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/* include/uapi/linux/time.h */</span>
<span class="token keyword">struct</span> <span class="token class-name">timeval</span><span class="token punctuation">{<!-- --></span>
    __kernel_time_t tv_sec<span class="token punctuation">;</span>          <span class="token comment">//秒</span>
    __kernel_suseconds_t tv_usec<span class="token punctuation">;</span>    <span class="token comment">//微秒</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 每个输入事件 input_event 中含有发生时间，timeval 表示的是自系统启动以后过了多少时间。*/</span>
</code></pre> 
<p>所有输入设备都可以在 /proc/bus/input/devices 中显示。<br> 描述输入设备的结构体：</p> 
<pre><code class="prism language-c"><span class="token comment">/* include/uapi/linux/input.h */</span>
<span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span><span class="token comment">//输入设备的名字</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>phys<span class="token punctuation">;</span><span class="token comment">//在系统层次结构中设备的物理路径;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>uniq<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">input_id</span> id<span class="token punctuation">;</span><span class="token comment">//输入设备id,包含总线类型,制造商id,产品id和版本号等;</span>
 
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> propbit<span class="token punctuation">[</span><span class="token function">BITS_TO_LONGS</span><span class="token punctuation">(</span>INPUT_PROP_CNT<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//设备属性和怪异位图</span>
 
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> evbit<span class="token punctuation">[</span><span class="token function">BITS_TO_LONGS</span><span class="token punctuation">(</span>EV_CNT<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">//设备支持的事件类型;EV_KEY, EV_REL;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> keybit<span class="token punctuation">[</span><span class="token function">BITS_TO_LONGS</span><span class="token punctuation">(</span>KEY_CNT<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//设备具有的按键(能够报告的)</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> relbit<span class="token punctuation">[</span><span class="token function">BITS_TO_LONGS</span><span class="token punctuation">(</span>REL_CNT<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//设备相对轴</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> absbit<span class="token punctuation">[</span><span class="token function">BITS_TO_LONGS</span><span class="token punctuation">(</span>ABS_CNT<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//绝对坐标的位图</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> mscbit<span class="token punctuation">[</span><span class="token function">BITS_TO_LONGS</span><span class="token punctuation">(</span>MSC_CNT<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//设备支持的杂项设备事件</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> ledbit<span class="token punctuation">[</span><span class="token function">BITS_TO_LONGS</span><span class="token punctuation">(</span>LED_CNT<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//设备存在的led位图</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sndbit<span class="token punctuation">[</span><span class="token function">BITS_TO_LONGS</span><span class="token punctuation">(</span>SND_CNT<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//设备支持的声音效果</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> ffbit<span class="token punctuation">[</span><span class="token function">BITS_TO_LONGS</span><span class="token punctuation">(</span>FF_CNT<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">//设备支持的力反馈效果位图</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> swbit<span class="token punctuation">[</span><span class="token function">BITS_TO_LONGS</span><span class="token punctuation">(</span>SW_CNT<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">//设备存在的开关位图</span>
 <span class="token comment">/*以上支持哪些位就ke'y
    unsigned int hint_events_per_packet;
 
 unsigned int keycodemax;                //按键编码表的大小;
 unsigned int keycodesize;               //按键编码表中每个编码的大小
 void *keycode;//按键编码表
 
   
 int (*open)(struct input_dev *dev);     //打开设备 

 void (*close)(struct input_dev *dev);   //关闭设备
 ...
 struct device dev;                      //设备的驱动程序模型视图
 
 struct list_head    h_list;
 struct list_head    node;
};
</span></code></pre> 
<h3><a id="evbit__75"></a>evbit 上报事件类型</h3> 
<p>evbit 表示设备能够报告的事件类型; 常见取值如下:</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EV_SYN</span>            <span class="token expression"><span class="token number">0x00</span> 表同步事件</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EV_KEY</span>            <span class="token expression"><span class="token number">0x01</span> 表设备能够报告的按键事件</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EV_REL</span>            <span class="token expression"><span class="token number">0x02</span> 表设备能够报告相对坐标事件<span class="token punctuation">(</span>如鼠标<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EV_ABS</span>            <span class="token expression"><span class="token number">0x03</span> 表设备能够报告的绝对坐标事件</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EV_MSC</span>            <span class="token expression"><span class="token number">0x04</span> 杂项</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EV_SW</span>             <span class="token expression"><span class="token number">0x05</span> 开关事件</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EV_LED</span>            <span class="token expression"><span class="token number">0x11</span> LED</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EV_SND</span>            <span class="token expression"><span class="token number">0x12</span> 声音事件</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EV_REP</span>            <span class="token expression"><span class="token number">0x14</span> 表设备支持长按键检测</span></span>
</code></pre> 
<p>https://blog.csdn.net/qq_39048131/article/details/126533233<br> 如果是按键事件，那么 EV_KEY 对应的按键值就是：</p> 
<pre><code class="prism language-c"><span class="token comment">/* include/uapi/linux/input.h */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_RESERVED</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_ESC</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_1</span>   <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_2</span>   <span class="token expression"><span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_3</span>   <span class="token expression"><span class="token number">4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_4</span>   <span class="token expression"><span class="token number">5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_5</span>   <span class="token expression"><span class="token number">6</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_6</span>   <span class="token expression"><span class="token number">7</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_7</span>   <span class="token expression"><span class="token number">8</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_8</span>   <span class="token expression"><span class="token number">9</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_9</span>   <span class="token expression"><span class="token number">10</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_0</span>   <span class="token expression"><span class="token number">11</span></span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTN_TRIGGER_HAPPY39</span> <span class="token expression"><span class="token number">0x2e6</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTN_TRIGGER_HAPPY40</span> <span class="token expression"><span class="token number">0x2e7</span></span></span>
</code></pre> 
<h3><a id="inputAPI_110"></a>input设备API</h3> 
<p>申请输入设备：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span><span class="token function">input_allocate_device</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
</code></pre> 
<p>返回值：申请到的 input_dev。<br> 注销输入设备：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">input_free_device</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
</code></pre> 
<p>初始化输入设备：<br> 申请好一个 input_dev 以后就需要初始化这个 input_dev，需要初始化的内容主要为事件类<br> 型 (evbit) 和事件值 (keybit) 这两种。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">input_register_device</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
</code></pre> 
<p>注销 input 驱动的时候也需要使用 input_unregister_device 函数来注销掉前面注册<br> 的 input_dev：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">input_unregister_device</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
</code></pre> 
<p>①、使用 input_allocate_device 函数申请一个 input_dev。<br> ②、初始化 input_dev 的事件类型以及事件值。<br> ③、使用 input_register_device 函数向 Linux 系统注册前面初始化好的 input_dev。<br> ④、卸载input驱动的时候需要先使用input_unregister_device函数注销掉注册的input_dev，<br> 然后使用 input_free_device 函数释放掉前面申请的 input_dev。<br> input_dev 注册过程示例代码如下<br> 所示：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>inputdev<span class="token punctuation">;</span> <span class="token comment">/* input 结构体变量 */</span>

<span class="token comment">/* 驱动入口函数 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">xxx_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    inputdev <span class="token operator">=</span> <span class="token function">input_allocate_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 申请 input_dev */</span>
    inputdev<span class="token operator">-&gt;</span>name <span class="token operator">=</span> <span class="token string">"test_inputdev"</span><span class="token punctuation">;</span>   <span class="token comment">/* 设置 input_dev 名字 */</span>
    <span class="token comment">/*********第一种设置事件和事件值的方法***********/</span>
    <span class="token function">__set_bit</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">,</span> inputdev<span class="token operator">-&gt;</span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 设置产生按键事件 */</span>
    <span class="token function">__set_bit</span><span class="token punctuation">(</span>EV_REP<span class="token punctuation">,</span> inputdev<span class="token operator">-&gt;</span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 重复事件 */</span>
    <span class="token function">__set_bit</span><span class="token punctuation">(</span>KEY_0<span class="token punctuation">,</span> inputdev<span class="token operator">-&gt;</span>keybit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/*设置产生哪些按键值 */</span>

    <span class="token comment">/*********第二种设置事件和事件值的方法***********/</span>
    keyinputdev<span class="token punctuation">.</span>inputdev<span class="token operator">-&gt;</span>evbit<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BIT_MASK</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">BIT_MASK</span><span class="token punctuation">(</span>EV_REP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    keyinputdev<span class="token punctuation">.</span>inputdev<span class="token operator">-&gt;</span>keybit<span class="token punctuation">[</span><span class="token function">BIT_WORD</span><span class="token punctuation">(</span>KEY_0<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token function">BIT_MASK</span><span class="token punctuation">(</span>KEY_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*********第三种设置事件和事件值的方法***********/</span>
    keyinputdev<span class="token punctuation">.</span>inputdev<span class="token operator">-&gt;</span>evbit<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BIT_MASK</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">BIT_MASK</span><span class="token punctuation">(</span>EV_REP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">input_set_capability</span><span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>inputdev<span class="token punctuation">,</span> EV_KEY<span class="token punctuation">,</span> KEY_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 注册 input_dev */</span>
    <span class="token function">input_register_device</span><span class="token punctuation">(</span>inputdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 驱动出口函数 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">xxx_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">input_unregister_device</span><span class="token punctuation">(</span>inputdev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 注销 input_dev */</span>
    <span class="token function">input_free_device</span><span class="token punctuation">(</span>inputdev<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">/* 删除 input_dev */</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>实际中的驱动，输入设备只是一个机制，主题还是各种协议对应的框架。然后输入一般都伴随着硬件中断，所以一般都是中断服务函数中实现输入事件和值的上报。</p> 
<h2><a id="_181"></a>按键输入驱动实例</h2> 
<p>先说好啊，input 主要就学个框架，工作中最好不要把驱动自己全写了，一定要copy相同的类型的设备驱动，然后修改。<br> 设备树：</p> 
<pre><code class="prism language-shell">pinctrl_key: keygrp <span class="token punctuation">{<!-- --></span>
 fsl,pins <span class="token operator">=</span> <span class="token operator">&lt;</span>MX6UL_PAD_UART1_CTS_B__GPIO1_IO18 0xF08<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token punctuation">;</span> 
 /* 将管脚号为MX6UL_PAD_UART1_CTS_B__GPIO1_IO18的管脚复用为0xF080功能： 普通GPIO功能 */
<span class="token punctuation">}</span><span class="token punctuation">;</span>

key <span class="token punctuation">{<!-- --></span>
 <span class="token comment">#address-cells = &lt;1&gt;;</span>
 <span class="token comment">#size-cells = &lt;1&gt;;</span>
 compatible <span class="token operator">=</span> <span class="token string">"atkalpha-key"</span><span class="token punctuation">;</span>
 pinctrl-names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
 pinctrl-0 <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>pinctrl_key<span class="token operator">&gt;</span><span class="token punctuation">;</span>
 key-gpio <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>gpio1 <span class="token number">18</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span> /* 初始化为低电平 */
 status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>按键输入驱动：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEYINPUT_CNT</span> <span class="token expression"><span class="token number">1</span>             </span><span class="token comment">/* 设备号个数 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEYINPUT_NAME</span> <span class="token string">"keyinput"</span>   <span class="token comment">/* 名字 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY0VALUE</span> <span class="token expression"><span class="token number">0X01</span>             </span><span class="token comment">/* KEY0 按键值 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INVAKEY</span> <span class="token expression"><span class="token number">0XFF</span>               </span><span class="token comment">/* 无效的按键值 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_NUM</span> <span class="token expression"><span class="token number">1</span>                  </span><span class="token comment">/* 按键数量 */</span></span>

<span class="token comment">/* 中断 IO 描述结构体 */</span>
 <span class="token keyword">struct</span> <span class="token class-name">irq_keydesc</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">int</span> gpio<span class="token punctuation">;</span>                            <span class="token comment">/* gpio */</span>
 <span class="token keyword">int</span> irqnum<span class="token punctuation">;</span>                          <span class="token comment">/* 中断号 */</span>
 <span class="token keyword">unsigned</span> <span class="token keyword">char</span> value<span class="token punctuation">;</span>                 <span class="token comment">/* 按键对应的键值 */</span>
 <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                       <span class="token comment">/* 名字 */</span>
 <span class="token class-name">irqreturn_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 中断服务函数 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* keyinput 设备结构体 */</span>
 <span class="token keyword">struct</span> <span class="token class-name">keyinput_dev</span><span class="token punctuation">{<!-- --></span>
 <span class="token class-name">dev_t</span> devid<span class="token punctuation">;</span>                             <span class="token comment">/* 设备号 */</span>
 <span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev<span class="token punctuation">;</span>                        <span class="token comment">/* cdev */</span>
 <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">;</span>                     <span class="token comment">/* 类 */</span>
 <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>device<span class="token punctuation">;</span>                   <span class="token comment">/* 设备 */</span>
 <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>nd<span class="token punctuation">;</span>                  <span class="token comment">/* 设备节点 */</span>
 <span class="token keyword">struct</span> <span class="token class-name">timer_list</span> timer<span class="token punctuation">;</span>                 <span class="token comment">/* 定义一个定时器 */</span>
 <span class="token keyword">struct</span> <span class="token class-name">irq_keydesc</span> irqkeydesc<span class="token punctuation">[</span>KEY_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">/* 按键描述数组 */</span>
 <span class="token keyword">unsigned</span> <span class="token keyword">char</span> curkeynum<span class="token punctuation">;</span>                 <span class="token comment">/* 当前的按键号 */</span>
 <span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>inputdev<span class="token punctuation">;</span>              <span class="token comment">/* input 结构体 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">keyinput_dev</span> keyinputdev<span class="token punctuation">;</span> <span class="token comment">/* key input 设备 */</span>

<span class="token comment">/* 中断服务函数，开启定时器，延时10ms */</span>
<span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">key0_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">keyinput_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">keyinput_dev</span> <span class="token operator">*</span><span class="token punctuation">)</span>dev_id<span class="token punctuation">;</span>

 dev<span class="token operator">-&gt;</span>curkeynum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 dev<span class="token operator">-&gt;</span>timer<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">long</span><span class="token punctuation">)</span>dev_id<span class="token punctuation">;</span>
    <span class="token function">mod_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>timer<span class="token punctuation">,</span> jiffies <span class="token operator">+</span> <span class="token function">msecs_to_jiffies</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 10ms定时 */</span>
    <span class="token keyword">return</span> <span class="token function">IRQ_RETVAL</span><span class="token punctuation">(</span>IRQ_HANDLED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 定时器服务函数，用于按键消抖，定时器到了以后再次读取按键值，如果按键还是处于按下状态就表示按键有效 */</span>
<span class="token keyword">void</span> <span class="token function">timer_function</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> value<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> num<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">irq_keydesc</span> <span class="token operator">*</span>keydesc<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">keyinput_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">keyinput_dev</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>

    num <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>curkeynum<span class="token punctuation">;</span>
    keydesc <span class="token operator">=</span> <span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>irqkeydesc<span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">;</span>
    value <span class="token operator">=</span> <span class="token function">gpio_get_value</span><span class="token punctuation">(</span>keydesc<span class="token operator">-&gt;</span>gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">/* 读取IO值 */</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>                         <span class="token comment">/* 按下按键 */</span>
        <span class="token comment">/* 上报按键值 */</span>
        <span class="token comment">//input_event(dev-&gt;inputdev, EV_KEY, keydesc-&gt;value, 1);</span>
        <span class="token function">input_report_key</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>inputdev<span class="token punctuation">,</span> keydesc<span class="token operator">-&gt;</span>value<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* 最后一个参数表示按下还是松开，1为按下，0为松开 */</span>
        <span class="token function">input_sync</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>inputdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>                                     <span class="token comment">/* 按键松开 */</span>
        <span class="token comment">//input_event(dev-&gt;inputdev, EV_KEY, keydesc-&gt;value, 0);</span>
        <span class="token function">input_report_key</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>inputdev<span class="token punctuation">,</span> keydesc<span class="token operator">-&gt;</span>value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">input_sync</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>inputdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 按键IO初始化 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keyio_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    keyinputdev<span class="token punctuation">.</span>nd <span class="token operator">=</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>nd<span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"key node not find!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 

    <span class="token comment">/* 提取GPIO */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> KEY_NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        keyinputdev<span class="token punctuation">.</span>irqkeydesc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>gpio <span class="token operator">=</span> <span class="token function">of_get_named_gpio</span><span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>nd <span class="token punctuation">,</span><span class="token string">"key-gpio"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>irqkeydesc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>gpio <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"can't get key%d\r\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 初始化key所使用的IO，并且设置成中断模式 */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> KEY_NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">memset</span><span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>irqkeydesc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 缓冲区清零 */</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>irqkeydesc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"KEY%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* 组合名字 */</span>
        <span class="token function">gpio_request</span><span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>irqkeydesc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>gpio<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_direction_input</span><span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>irqkeydesc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>    
        keyinputdev<span class="token punctuation">.</span>irqkeydesc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>irqnum <span class="token operator">=</span> <span class="token function">irq_of_parse_and_map</span><span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>nd<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 申请中断 */</span>
    keyinputdev<span class="token punctuation">.</span>irqkeydesc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> key0_handler<span class="token punctuation">;</span>
    keyinputdev<span class="token punctuation">.</span>irqkeydesc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> KEY_0<span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> KEY_NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">request_irq</span><span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>irqkeydesc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>irqnum<span class="token punctuation">,</span> keyinputdev<span class="token punctuation">.</span>irqkeydesc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>handler<span class="token punctuation">,</span> 
                         IRQF_TRIGGER_FALLING<span class="token operator">|</span>IRQF_TRIGGER_RISING<span class="token punctuation">,</span> keyinputdev<span class="token punctuation">.</span>irqkeydesc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>keyinputdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"irq %d request failed!\r\n"</span><span class="token punctuation">,</span> keyinputdev<span class="token punctuation">.</span>irqkeydesc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>irqnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 创建定时器 */</span>
    <span class="token function">init_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>keyinputdev<span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    keyinputdev<span class="token punctuation">.</span>timer<span class="token punctuation">.</span>function <span class="token operator">=</span> timer_function<span class="token punctuation">;</span>

    <span class="token comment">/* 申请input_dev */</span>
    keyinputdev<span class="token punctuation">.</span>inputdev <span class="token operator">=</span> <span class="token function">input_allocate_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    keyinputdev<span class="token punctuation">.</span>inputdev<span class="token operator">-&gt;</span>name <span class="token operator">=</span> KEYINPUT_NAME<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
    <span class="token comment">/* 初始化input_dev，设置产生哪些事件 */</span>
    <span class="token function">__set_bit</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">,</span> keyinputdev<span class="token punctuation">.</span>inputdev<span class="token operator">-&gt;</span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 设置产生按键事件          */</span>
    <span class="token function">__set_bit</span><span class="token punctuation">(</span>EV_REP<span class="token punctuation">,</span> keyinputdev<span class="token punctuation">.</span>inputdev<span class="token operator">-&gt;</span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 重复事件，比如按下去不放开，就会一直输出信息          */</span>

    <span class="token comment">/* 初始化input_dev，设置产生哪些按键 */</span>
    <span class="token function">__set_bit</span><span class="token punctuation">(</span>KEY_0<span class="token punctuation">,</span> keyinputdev<span class="token punctuation">.</span>inputdev<span class="token operator">-&gt;</span>keybit<span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
    keyinputdev<span class="token punctuation">.</span>inputdev<span class="token operator">-&gt;</span>evbit<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BIT_MASK</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">BIT_MASK</span><span class="token punctuation">(</span>EV_REP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    keyinputdev<span class="token punctuation">.</span>inputdev<span class="token operator">-&gt;</span>keybit<span class="token punctuation">[</span><span class="token function">BIT_WORD</span><span class="token punctuation">(</span>KEY_0<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token function">BIT_MASK</span><span class="token punctuation">(</span>KEY_0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    keyinputdev<span class="token punctuation">.</span>inputdev<span class="token operator">-&gt;</span>evbit<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BIT_MASK</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">BIT_MASK</span><span class="token punctuation">(</span>EV_REP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">input_set_capability</span><span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>inputdev<span class="token punctuation">,</span> EV_KEY<span class="token punctuation">,</span> KEY_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 注册输入设备 */</span>
    ret <span class="token operator">=</span> <span class="token function">input_register_device</span><span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>inputdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"register input device failed!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">keyinput_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">keyio_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">keyinput_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/* 删除定时器 */</span>
    <span class="token function">del_timer_sync</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>keyinputdev<span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 删除定时器 */</span>
        
    <span class="token comment">/* 释放中断 */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> KEY_NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">free_irq</span><span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>irqkeydesc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>irqnum<span class="token punctuation">,</span> <span class="token operator">&amp;</span>keyinputdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 释放input_dev */</span>
    <span class="token function">input_unregister_device</span><span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>inputdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">input_free_device</span><span class="token punctuation">(</span>keyinputdev<span class="token punctuation">.</span>inputdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_365"></a>上报输入事件</h3> 
<p>如按键，我们需要在按<br> 键中断处理函数，或者消抖定时器中断函数中将按键值上报给 Linux 内核，这样 Linux 内核才<br> 能获取到正确的输入值。不同的事件，其上报事件的 API 函数不同。<br> 如按键，我们需要在按<br> 键中断处理函数，或者消抖定时器中断函数中将按键值上报给 Linux 内核，这样 Linux 内核才<br> 能获取到正确的输入值。不同的事件，其上报事件的 API 函数不同。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">input_event</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> 
                 <span class="token keyword">unsigned</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> 
                 <span class="token keyword">unsigned</span> <span class="token keyword">int</span> code<span class="token punctuation">,</span> 
                 <span class="token keyword">int</span> value<span class="token punctuation">)</span>
</code></pre> 
<p>dev：需要上报的 input_dev。<br> type: 上报的事件类型，比如 EV_KEY。<br> code：事件码，也就是我们注册的按键值，比如 KEY_0、KEY_1 等等。<br> value：事件值，比如 1 表示按键按下，0 表示按键松开。<br> input_event 函数可以上报所有的事件类型和事件值，Linux 内核也提供了其他的针对具体<br> 事件的上报函数，这些函数其实都用到了 input_event 函数。比如上报按键所使用的<br> input_report_key 函数，此函数内容如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">input_report_key</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
                                    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 <span class="token function">input_event</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> EV_KEY<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token operator">!</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>同样的还有一些其他的事件上报函数：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">input_report_rel</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">input_report_abs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">input_report_ff_status</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">input_report_switch</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">input_mt_sync</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
</code></pre> 
<p>当我们上报事件以后还需要使用 input_sync 函数来告诉 Linux 内核 input 子系统上报结束，<br> input_sync 函数本质是上报一个同步事件，此函数原型如下所示：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">input_sync</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
</code></pre> 
<p>按键的上报事件的参考代码如下所示：</p> 
<pre><code class="prism language-c"><span class="token comment">/* 定时器服务函数 */</span>
<span class="token keyword">void</span> <span class="token function">timer_function</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> value<span class="token punctuation">;</span>
    value <span class="token operator">=</span> <span class="token function">gpio_get_value</span><span class="token punctuation">(</span>keydesc<span class="token operator">-&gt;</span>gpio<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 读取 IO 值 */</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token comment">/* 按下按键 */</span>
        <span class="token comment">/* 上报按键值 */</span>
        <span class="token function">input_report_key</span><span class="token punctuation">(</span>inputdev<span class="token punctuation">,</span> KEY_0<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 最后一个参数 1，按下 */</span>
        <span class="token function">input_sync</span><span class="token punctuation">(</span>inputdev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 同步事件 */</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token comment">/* 按键松开 */</span>
        <span class="token function">input_report_key</span><span class="token punctuation">(</span>inputdev<span class="token punctuation">,</span> KEY_0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 最后一个参数 0，松开 */</span>
        <span class="token function">input_sync</span><span class="token punctuation">(</span>inputdev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 同步事件 */</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> 
<p>参考一下上报的使用就可以了。</p> 
<p>Linux 内核使用 input_event 这个结构体来表示所有的输入事件：</p> 
<pre><code class="prism language-c"><span class="token comment">/* include/uapi/linux/input.h */</span>
<span class="token keyword">struct</span> <span class="token class-name">input_event</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> time<span class="token punctuation">;</span>
    __u16 type<span class="token punctuation">;</span>
    __u16 code<span class="token punctuation">;</span>
    __s32 value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*
type：事件类型，比如 EV_KEY，表示此次事件为按键事件，此成员变量为 16 位。
code：事件码，比如在 EV_KEY 事件中 code 就表示具体的按键码，如：KEY_0、KEY_1 等等这些按键。此成员变量为 16 位。
value：值，比如 EV_KEY 事件中 value 就是按键值，表示按键有没有被按下，如果为 1 的话说明按键按下，如果为 0 的话说明按键没有被按下或者按键松开了。
*/</span>

<span class="token comment">/* time：时间，也就是此事件发生的时间 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">long</span>             __kernel_long_t<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> __kernel_long_t  __kernel_time_t<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> __kernel_long_t  __kernel_suseconds_t<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token punctuation">{<!-- --></span>
    __kernel_time_t 
    tv_sec<span class="token punctuation">;</span>                       <span class="token comment">/* 秒 */</span>
    __kernel_suseconds_t tv_usec<span class="token punctuation">;</span> <span class="token comment">/* 微秒 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>input_envent 这个结构体非常重要，因为所有的输入设备最终都是按照 input_event 结构体<br> 呈现给用户的，用户应用程序可以通过 input_event 来获取到具体的输入事件或相关的值。</p> 
<h2><a id="_459"></a>触摸屏部分</h2> 
<h3><a id="_460"></a>电阻屏数据</h3> 
<p>驱动会上报触点的 X、Y 数据，这不是LCD的坐标值，需要APP再次处理才能转换为 LCD 坐标值。<br> 对应的 input_event 结构体中，type、code、value 如下：</p> 
<pre><code class="prism language-c"><span class="token comment">/* 按下时 */</span>
EV_KEY    BTN_TOUCH        <span class="token number">1</span>        按下
EV_ABS    ABS_PRESSURE     <span class="token number">1</span>        压力值，可有可无
EV_ABS    ABS_X            x_value  X坐标
EV_ABS    ABS_Y            y_value  y坐标
EV_SYNC   <span class="token number">0</span>                <span class="token number">0</span>        同步事件
<span class="token comment">/* 松开时 */</span>
EV_ABS    BTN_TOUCH        <span class="token number">0</span>        松开
EV_ABS    ABS_PRESSURE     <span class="token number">0</span>        压力值
EV_SYNC   <span class="token number">0</span>                <span class="token number">0</span>        同步事件  
</code></pre> 
<h3><a id="_477"></a>电容屏数据</h3> 
<h4><a id="MT_478"></a>多点触摸协议（MT）</h4> 
<p>input子系统下的多点触摸协议称为MT协议，其文档为：Documentation/input/multitouch-protocol.txt。<br> MT协议被分为两种类型，取决于硬件的兼容性：<br> Type A：适用于触摸点不能被区分或者追踪，此类型的设备上报原始数据<br> Type B：能分辨时哪一个触点，上报数据时会先上报触点ID，再上报它的数据。此类型设备都通过slot更新某一个触摸点的信息<br> Type A 已经过时了，内核也不支持了。<br> 触摸点的信息通过一系列的ABS_MT事件上报给Linux内核，定义在文件 include/uapi/linux/input.h 中：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_SLOT</span>             <span class="token expression"><span class="token number">0x2f</span>    </span><span class="token comment">/* MT slot being modified */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_TOUCH_MAJOR</span>     <span class="token expression"><span class="token number">0x30</span>    </span><span class="token comment">/* Major axis of touching ellipse */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_TOUCH_MINOR</span>     <span class="token expression"><span class="token number">0x31</span>    </span><span class="token comment">/* Minor axis (omit if circular) */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_WIDTH_MAJOR</span>     <span class="token expression"><span class="token number">0x32</span>    </span><span class="token comment">/* Major axis of approaching ellipse */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_WIDTH_MINOR</span>     <span class="token expression"><span class="token number">0x33</span>    </span><span class="token comment">/* Minor axis (omit if circular) */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_ORIENTATION</span>     <span class="token expression"><span class="token number">0x34</span>    </span><span class="token comment">/* Ellipse orientation */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_POSITION_X</span>     <span class="token expression"><span class="token number">0x35</span>    </span><span class="token comment">/* Center X touch position */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_POSITION_Y</span>     <span class="token expression"><span class="token number">0x36</span>    </span><span class="token comment">/* Center Y touch position */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_TOOL_TYPE</span>     <span class="token expression"><span class="token number">0x37</span>    </span><span class="token comment">/* Type of touching device */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_BLOB_ID</span>         <span class="token expression"><span class="token number">0x38</span>    </span><span class="token comment">/* Group a set of packets as a blob */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_TRACKING_ID</span>     <span class="token expression"><span class="token number">0x39</span>    </span><span class="token comment">/* Unique ID of initiated contact */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_PRESSURE</span>         <span class="token expression"><span class="token number">0x3a</span>    </span><span class="token comment">/* Pressure on contact area */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_DISTANCE</span>         <span class="token expression"><span class="token number">0x3b</span>    </span><span class="token comment">/* Contact hover distance */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_TOOL_X</span>         <span class="token expression"><span class="token number">0x3c</span>    </span><span class="token comment">/* Center X tool position */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ABS_MT_TOOL_Y</span>         <span class="token expression"><span class="token number">0x3d</span>    </span><span class="token comment">/* Center Y tool position */</span></span>
</code></pre> 
<p>其中最常用的是：</p> 
<p>ABS_MT_SLOT：用来上报触摸点ID<br> ABS_MT_POSITION_X和ABS_MT_POSITION_Y：用来上报触摸点的 (X, Y) 坐标信息<br> ABS_MT_TRACKING_ID：对于Type B类型的设备，需要用该事件来区分触摸点</p> 
<p>当有2个触点时，type、code、value 如下：</p> 
<pre><code class="prism language-c">EV_ABS    ABS_MT_SLOT           <span class="token number">0</span>       表示要上报一个触点信息了
EV_ABS    ABS_MT_TRACKING_ID    <span class="token number">45</span>      这个触点的ID是<span class="token number">45</span>
EV_ABS    ABS_MT_POSITION_X     x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    触点X坐标
EV_ABS    ABS_MT_POSITION_Y     y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    触点Y坐标
EV_ABS    ABS_MT_SLOT           <span class="token number">1</span>       表示要上报一个触点信息了
EV_ABS    ABS_MT_TRACKING_ID    <span class="token number">46</span>      这个触点的ID是<span class="token number">46</span>
EV_ABS    ABS_MT_POSITION_X     x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    触点X坐标
EV_ABS    ABS_MT_POSITION_Y     y<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    触点Y坐标
EV_SYNC   SYN_REPORT            <span class="token number">0</span>       全部数据上报完毕
</code></pre> 
<p>当ID为45的触点正在移动：</p> 
<pre><code class="prism language-c">EV_ABS    ABS_MT_SLOT           <span class="token number">0</span>       表示要上报一个触点信息了
</code></pre> 
<p>/* 同一个slot不需要再上报一次ID*/</p> 
<pre><code class="prism language-c">EV_ABS    ABS_MT_POSITION_X     x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    触点X坐标
EV_SYNC   SYN_REPORT            <span class="token number">0</span>       全部数据上报完毕
</code></pre> 
<p>松开ID为45的触点时（前面slot已经设置为0，这里需要重新设置slot，slot就像一个全局变量，如果没有变化，就无需再次设置）</p> 
<pre><code class="prism language-c">EV_ABS    ABS_MT_TRACKING_ID    <span class="token operator">-</span><span class="token number">1</span>
EV_SYNC   SYN_REPORT            <span class="token number">0</span>       全部数据上报完毕
</code></pre> 
<p>最后，松开ID为46的触点：</p> 
<pre><code class="prism language-c">EV_ABS    ABS_MT_SLOT           <span class="token number">1</span>       表示要上报一个触点信息了
<span class="token comment">/* 前面设置过slot 1的ID为46 */</span>
EV_ABS    ABS_MT_TRACKING_ID    <span class="token operator">-</span><span class="token number">1</span>      <span class="token operator">-</span><span class="token number">1</span>表示slot <span class="token number">1</span> 被松开，即ID为<span class="token number">46</span>的触点被松开
EV_SYNC   SYN_REPORT            <span class="token number">0</span>       全部数据上报完毕
</code></pre> 
<p>执行 hexdump /dev/input/event0<br> 再用一个手指触碰电容屏，得到这些数据：<br> <img src="https://images2.imgbox.com/05/83/HQ25sXc9_o.png" alt="在这里插入图片描述"><br> 可以看到一个手指的时候，并没有上报 slot<br> 使用了两个手指时：<br> <img src="https://images2.imgbox.com/3b/4e/5EyngwZt_o.png" alt="在这里插入图片描述"><br> 基本上都有兼容了老程序。</p> 
<h2><a id="tslib2_558"></a>实战：基于tslib，不断打印2个触点的距离</h2> 
<h3><a id="tslib_560"></a>tslib库的用处</h3> 
<p>tslib是一个触摸屏的开源库，可以使用它来访问触摸屏设备，可以给输入设备添加各种“filter”（过滤库，就是各种处理）。<br> tslib 框架分析、交叉编译tslib库、测试：<br> 参考资料：https://blog.csdn.net/weixin_42373086/article/details/130138000<br> 触摸屏可能支持多个触点，比如5个，tslib为了简化处理，即使只有两个触点，ts_read_mt函数也会返回五个触点的数据。<br> 驱动程序中使用slot、tracing_id来标识一个触点，当tracing_id等于-1时，标识这个触点被松开了。<br> 所以可以根据这个标识来判断数据是否有效，所以当有两个触点有效时，就打印它俩之间的距离。</p> 
<h3><a id="_567"></a>数据结构</h3> 
<ul><li>核心函数：ts_read_mt</li><li>四个参数：tsdev结构体、max_slots(最大点数)、ts_sample_mt结构体（存数据）、nr</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">ts_read_mt</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tsdev</span> <span class="token operator">*</span>ts<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">ts_sample_mt</span> <span class="token operator">*</span><span class="token operator">*</span>samp<span class="token punctuation">,</span> <span class="token keyword">int</span> max_slots<span class="token punctuation">,</span> <span class="token keyword">int</span> nr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> result<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    result <span class="token operator">=</span> ts<span class="token operator">-&gt;</span>list<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span><span class="token function">read_mt</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>list<span class="token punctuation">,</span> samp<span class="token punctuation">,</span> max_slots<span class="token punctuation">,</span> nr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>max_slots<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>samp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">&amp;</span> TSLIB_MT_VALID<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token function">ts_error</span><span class="token punctuation">(</span><span class="token string">"TS_READ_MT----&gt; slot %d: x = %d, y = %d, pressure = %d\n"</span><span class="token punctuation">,</span>
                 samp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>slot<span class="token punctuation">,</span> samp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> samp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">,</span>
                 samp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pressure<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
    参数 ts ：指向一个触摸屏设备句柄。
    参数samp：指向一个struct ts_sample_mt *对象。
    参数max_slots ：表示触摸屏支持的最大触摸点数（可以通过调用 ioctl()函数获取到）。
    参数 nr ：表示对一个触摸点的采样数。
*/</span>
<span class="token keyword">struct</span> <span class="token class-name">ts_sample_mt</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* ABS_MT_* event codes. linux/include/uapi/linux/input-event-codes.h
    * has the definitions.
    */</span>
    <span class="token keyword">int</span> x<span class="token punctuation">;</span> <span class="token comment">//X 坐标</span>
    <span class="token keyword">int</span> y<span class="token punctuation">;</span> <span class="token comment">//Y 坐标</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pressure<span class="token punctuation">;</span> <span class="token comment">//按压力大小</span>
    <span class="token keyword">int</span> slot<span class="token punctuation">;</span> <span class="token comment">//触摸点 slot</span>
    <span class="token keyword">int</span> tracking_id<span class="token punctuation">;</span> <span class="token comment">//ID</span>
    <span class="token keyword">int</span> tool_type<span class="token punctuation">;</span>
    <span class="token keyword">int</span> tool_x<span class="token punctuation">;</span>
    <span class="token keyword">int</span> tool_y<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> touch_major<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> width_major<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> touch_minor<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> width_minor<span class="token punctuation">;</span>
    <span class="token keyword">int</span> orientation<span class="token punctuation">;</span>
    <span class="token keyword">int</span> distance<span class="token punctuation">;</span>
    <span class="token keyword">int</span> blob_id<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> tv<span class="token punctuation">;</span> <span class="token comment">//时间</span>
    <span class="token comment">/* BTN_TOUCH state */</span>
    <span class="token keyword">short</span> pen_down<span class="token punctuation">;</span> <span class="token comment">//BTN_TOUCH 的状态</span>
    <span class="token comment">/* valid is set != 0 if this sample
    * contains new data; see below for the
    * bits that get set.
    * valid is set to 0 otherwise
    */</span>
    <span class="token keyword">short</span> valid<span class="token punctuation">;</span> <span class="token comment">//此次样本是否有效标志 触摸点数据是否发生更新</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_627"></a>应用程序</h3> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;getopt.h&gt;</span></span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/input.h&gt;</span></span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span></span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;tslib.h&gt;</span></span>
 
<span class="token keyword">int</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ts_sample_mt</span> <span class="token operator">*</span>point1<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">ts_sample_mt</span> <span class="token operator">*</span>point2<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> x <span class="token operator">=</span> point1<span class="token operator">-&gt;</span>x <span class="token operator">-</span> point2<span class="token operator">-&gt;</span>x<span class="token punctuation">;</span>
    <span class="token keyword">int</span> y <span class="token operator">=</span> point1<span class="token operator">-&gt;</span>y <span class="token operator">-</span> point2<span class="token operator">-&gt;</span>y<span class="token punctuation">;</span>
 
    <span class="token keyword">return</span> x<span class="token operator">*</span>x <span class="token operator">+</span> y<span class="token operator">*</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">tsdev</span> <span class="token operator">*</span>ts<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token comment">//定义新旧触点sample结构体</span>
    <span class="token keyword">struct</span> <span class="token class-name">ts_sample_mt</span> <span class="token operator">*</span><span class="token operator">*</span>samp_mt<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">ts_sample_mt</span> <span class="token operator">*</span><span class="token operator">*</span>pre_samp_mt<span class="token punctuation">;</span>
    <span class="token keyword">int</span> max_slots<span class="token punctuation">;</span>
    <span class="token keyword">int</span> point_pressed<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">input_absinfo</span> slot<span class="token punctuation">;</span>
    <span class="token keyword">int</span> touch_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
    <span class="token comment">//阻塞方式</span>
 ts <span class="token operator">=</span> <span class="token function">ts_setup</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//寻找并初始化触摸屏设备</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ts<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ts_setup err\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//读取设备节点，获取属性---同时支持多少个触点，得到max_slots</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span><span class="token function">ts_fd</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">EVIOCGABS</span><span class="token punctuation">(</span>ABS_MT_SLOT<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>slot<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl EVIOGABS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ts_close</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> errno<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
 max_slots <span class="token operator">=</span> slot<span class="token punctuation">.</span>maximum <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">-</span> slot<span class="token punctuation">.</span>minimum<span class="token punctuation">;</span>
 
    
    <span class="token comment">//参照测试程序初始samp_mt和pre_samp_mt结构体数组</span>
 samp_mt <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ts_sample_mt</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>samp_mt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ts_close</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 samp_mt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span>max_slots<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ts_sample_mt</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>samp_mt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">free</span><span class="token punctuation">(</span>samp_mt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ts_close</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
 pre_samp_mt <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ts_sample_mt</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pre_samp_mt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ts_close</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 pre_samp_mt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span>max_slots<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ts_sample_mt</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pre_samp_mt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">free</span><span class="token punctuation">(</span>pre_samp_mt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ts_close</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max_slots<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
 pre_samp_mt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
    
 
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//第一步：读取触点数据</span>
        ret <span class="token operator">=</span> <span class="token function">ts_read_mt</span><span class="token punctuation">(</span>ts<span class="token punctuation">,</span> samp_mt<span class="token punctuation">,</span> max_slots<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ts_read_mt err\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ts_close</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token comment">//第二步：判断是否更新，将新数据拷贝到旧数据里</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max_slots<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>samp_mt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid<span class="token punctuation">)</span>

                <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pre_samp_mt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>samp_mt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ts_sample_mt</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
 
        <span class="token comment">//第三步：判断是否有两个触点，如果是两个，则执行打印</span>
        touch_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max_slots<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pre_samp_mt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">&amp;&amp;</span> pre_samp_mt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tracking_id <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                point_pressed<span class="token punctuation">[</span>touch_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>touch_cnt <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>

            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"distance: %08d\n"</span><span class="token punctuation">,</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pre_samp_mt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>point_pressed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pre_samp_mt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>point_pressed<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其他参考资料<br> https://blog.csdn.net/weixin_45499326/article/details/131130227<br> https://blog.csdn.net/weixin_44453694/article/details/126906896</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dec856b629398c77ff1952e71e01179a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">学校头歌作业1_2四则运算(头歌作业[Python])</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0fcb724c9975c3b464214ddef151f6d5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">IIC驱动理论与实例分析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>