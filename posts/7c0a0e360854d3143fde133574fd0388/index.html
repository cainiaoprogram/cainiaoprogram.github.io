<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PackageManagerService启动详解(六)之Android包信息体和解析器(下) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="PackageManagerService启动详解(六)之Android包信息体和解析器(下)" />
<meta property="og:description" content="PKMS启动详解(六)之Android包信息体和包解析器(下) Android PackageManagerService系列博客目录:
PKMS启动详解系列博客概要
PKMS启动详解(一)之整体流程分析
PKMS启动详解(二)之怎么通过packages.xml对已安装应用信息进行持久化管理?
PKMS启动详解(三)之BOOT_PROGRESS_PMS_START流程分析
PKMS启动详解(四)之Android包信息体和包解析器(上)
PKMS启动详解(五)之Android包信息体和包解析器(中)
PKMS启动详解(六)之Android包信息体和包解析器(下)
PKMS启动详解(七)之BOOT_PROGRESS_PMS_SYSTEM_SCAN_START阶段流程分析
PKMS启动详解(八)之BOOT_PROGRESS_PMS_DATA_SCAN_START阶段流程分析
引言 通过前面不懈的努力，终于Android包信息体和包解析器要到完结篇了，此处的我们值得掌声(鲜花就算了，我们coder还是很实在的)！在前面的博客PKMS启动详解(五)之Android包信息体和包解析器(中)我们从Android包管理机制的设计者角度出发，着重分析了：
Android包管理机制中的Android包解析器的PackageParser成员信息(主要是用于解析Android包的各种配件信息，不是配件信息不是配牛) 如果说前面我们分析的PackageParser成员变量等相关的信息，是包管理器为了烹饪Android包准备的各种顶级食材的话，那么PackageParser中定义的各种方法就是为了烹饪Android包准备的各种烹饪技术了。是不是很好奇，Android包管理器是怎么将前面的各种食材进行烹饪得到各种美味呢？通过这篇博客的源码实战分析，我想读者朋友一定会解开上述谜题成为一个烹饪大师的！
在正式开始本篇的博客相关分析前，还是非常有必要放出包解析器PackageParser的核心结构图,这样在后续分析时有一个整体上的参考(有点像我们小孩拼积木的配件图，实在撸不动的时候回来看看)。
注意:本篇的介绍是基于Android 7.xx平台为基础的(并且为了书写简便后续PackageManagerService统一简称为PKMS)，其中涉及的代码路径如下：
frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java frameworks/base/core/java/android/content/pm/PackageParser.java 一.包解析器PackageParser解析Android包流程概述 包解析器PackageParser解析Android包的工作，难度不大(属于伤害性不大，侮辱性极强的范畴)，但其流程的非常的繁琐，跟着流程走一边过来估计读者骂娘的心思都有了。但是没有办法阅读分析源码就是这么枯燥且乏味的事情，但是谁叫我们是coder呢？木有办法！
为了能将相关解析Android包的流程分析清楚，所以这个章节我们先对整个的流程简单概述一下！
前面的博客中我们已经将PackageParser解析Android包需要的各种数据结构(配件)已经备齐了，要得到以上的数据结构，包解析器PackageParser中的相关方法功不可没，其中最最核心的就是parsePackages方法，它从接收一个静态的文件(File类型)开始，会经过一个漫长的包解析过程，直到生成最终可口香甜的的Package：
parsePackages(File file...) └── parseClusterPackage(File packageDir...) └── parseClusterPackageLite(File packageDir...) | └── parseApkLite(File apkFile...) | └── parseApkLite(String codePath...) └── parseBaseApk() └── parseBaseApplication() | └── parseActivity() | └── parseService() | └── ... └── parseInstrumentation() └── ... └── parseMonolithicPackage(File apkFile...) └── parseMonolithicPackageLite(File packageFile...) | └── parseApkLite(File apkFile...) | └── parseApkLite(String codePath." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7c0a0e360854d3143fde133574fd0388/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-17T11:39:53+08:00" />
<meta property="article:modified_time" content="2021-03-17T11:39:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PackageManagerService启动详解(六)之Android包信息体和解析器(下)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="font_faceCourier_NewemspemspemspemspPKMSAndroid_0"></a><font face="Courier New">    PKMS启动详解(六)之Android包信息体和包解析器(下)</font></h2> 
<br> 
<p><font face="Courier New" size="4">Android PackageManagerService系列博客目录:</font></p> 
<blockquote> 
 <p><a href="https://blog.csdn.net/tkwxty/article/details/113050319"><font face="Courier New" size="3">PKMS启动详解系列博客概要</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/113137052"><font face="Courier New" size="3">PKMS启动详解(一)之整体流程分析</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/113340177"><font face="Courier New" size="3">PKMS启动详解(二)之怎么通过packages.xml对已安装应用信息进行持久化管理?</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/113607061"><font face="Courier New" size="3">PKMS启动详解(三)之BOOT_PROGRESS_PMS_START流程分析</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/114137504"><font face="Courier New" size="3">PKMS启动详解(四)之Android包信息体和包解析器(上)</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/114538497"><font face="Courier New" size="3">PKMS启动详解(五)之Android包信息体和包解析器(中)</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/114835060"><font face="Courier New" size="3">PKMS启动详解(六)之Android包信息体和包解析器(下)</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/114964303"><font face="Courier New" size="3">PKMS启动详解(七)之BOOT_PROGRESS_PMS_SYSTEM_SCAN_START阶段流程分析</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/115185220"><font face="Courier New" size="3">PKMS启动详解(八)之BOOT_PROGRESS_PMS_DATA_SCAN_START阶段流程分析</font></a></p> 
</blockquote> 
<hr> 
<br> 
<h3><a id="font_faceCourier_New_21"></a><font face="Courier New">引言</font></h3> 
<p><font face="Courier New">  通过前面不懈的努力，终于Android包信息体和包解析器要到完结篇了，此处的我们值得掌声(鲜花就算了，我们coder还是很实在的)！在前面的博客<a href="https://blog.csdn.net/tkwxty/article/details/114538497">PKMS启动详解(五)之Android包信息体和包解析器(中)</a>我们从Android包管理机制的设计者角度出发，着重分析了：</font></p> 
<ul><li><font face="Courier New">Android包管理机制中的Android包解析器的PackageParser成员信息(主要是用于解析Android包的各种配件信息，不是配件信息不是配牛)</font></li></ul> 
<p><font face="Courier New">如果说前面我们分析的PackageParser成员变量等相关的信息，是包管理器为了烹饪Android包准备的各种顶级食材的话，那么PackageParser中定义的各种方法就是为了烹饪Android包准备的各种烹饪技术了。是不是很好奇，Android包管理器是怎么将前面的各种食材进行烹饪得到各种美味呢？通过这篇博客的源码实战分析，我想读者朋友一定会解开上述谜题成为一个烹饪大师的！</font></p> 
<blockquote> 
 <p><font face="Courier New" size="3" color="RED">在正式开始本篇的博客相关分析前，还是非常有必要放出包解析器PackageParser的核心结构图,这样在后续分析时有一个整体上的参考(有点像我们小孩拼积木的配件图，实在撸不动的时候回来看看)。<br> <img src="https://images2.imgbox.com/79/0c/dtqcsdPl_o.png" alt="在这里插入图片描述"></font></p> 
</blockquote> 
<p><font face="Courier New">注意:本篇的介绍是基于Android 7.xx平台为基础的(并且为了书写简便后续PackageManagerService统一简称为PKMS)，其中涉及的代码路径如下：</font></p> 
<pre><code class="prism language-bash">frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java

frameworks/base/core/java/android/content/pm/PackageParser.java
</code></pre> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_NewPackageParserAndroid_46"></a><font face="Courier New">一.包解析器PackageParser解析Android包流程概述</font></h3> 
<blockquote> 
 <p><font face="Courier New" size="3" color="RED">包解析器PackageParser解析Android包的工作，难度不大(属于伤害性不大，侮辱性极强的范畴)，但其流程的非常的繁琐，跟着流程走一边过来估计读者骂娘的心思都有了。但是没有办法阅读分析源码就是这么枯燥且乏味的事情，但是谁叫我们是coder呢？木有办法！<br><br> 为了能将相关解析Android包的流程分析清楚，所以这个章节我们先对整个的流程简单概述一下！</font></p> 
</blockquote> 
<p><font face="Courier New">  前面的博客中我们已经将PackageParser解析Android包需要的各种数据结构(配件)已经备齐了，要得到以上的数据结构，包解析器PackageParser中的相关方法功不可没，其中最最核心的就是parsePackages方法，它从接收一个静态的文件(File类型)开始，会经过一个漫长的包解析过程，直到生成最终可口香甜的的Package：</font></p> 
<pre><code class="prism language-bash">parsePackages<span class="token punctuation">(</span>File file<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
└── parseClusterPackage<span class="token punctuation">(</span>File packageDir<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    └── parseClusterPackageLite<span class="token punctuation">(</span>File packageDir<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    <span class="token operator">|</span>   └── parseApkLite<span class="token punctuation">(</span>File apkFile<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    <span class="token operator">|</span>       └── parseApkLite<span class="token punctuation">(</span>String codePath<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    └── parseBaseApk<span class="token punctuation">(</span><span class="token punctuation">)</span>
        └── parseBaseApplication<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">|</span>    └── parseActivity<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">|</span>    └── parseService<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">|</span>    └── <span class="token punctuation">..</span>.
        └── parseInstrumentation<span class="token punctuation">(</span><span class="token punctuation">)</span>
        └── <span class="token punctuation">..</span>.
└── parseMonolithicPackage<span class="token punctuation">(</span>File apkFile<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    └── parseMonolithicPackageLite<span class="token punctuation">(</span>File packageFile<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    <span class="token operator">|</span>   └── parseApkLite<span class="token punctuation">(</span>File apkFile<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    <span class="token operator">|</span>       └── parseApkLite<span class="token punctuation">(</span>String codePath<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    └── parseBaseApk<span class="token punctuation">(</span><span class="token punctuation">)</span>
        └── parseBaseApplication<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">|</span>    └── parseActivity<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">|</span>    └── parseService<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">|</span>    └── <span class="token punctuation">..</span>.
        └── parseInstrumentation<span class="token punctuation">(</span><span class="token punctuation">)</span>
        └── <span class="token punctuation">..</span>.		
</code></pre> 
<p><font face="Courier New">这些方法的具体逻辑在后续章节我们会详细分析，这里先把核心的关键的流程捋出来:</font></p> 
<ul><li><font face="Courier New"><strong>PackageParser.parsePackages</strong>()是包解析器的入口方法，它首先会判定给定的输入是否为一个目录，如果是目录，则以为着目录下可能存在多个拆分后的APK，这就需要以<strong>Cluster</strong>的方式进行解析；如果仅仅是一个APK文件，就以<strong>Monolithic</strong>的方式解析；</font></li><li><font face="Courier New">解析APK，需要先得到一个中间数据结构<strong>PacakgeLite</strong>，包名、版本、拆分包等信息都会保存在这个数据结构中；由于一个包可能有多个拆分的APK，所以<strong>PackageLite</strong>可能关联到多个APK，每一个APK都对应到<strong>ApkLite</strong>这个数据结构，也是一些基本信息的封装。之所以以<strong>Lite</strong>为后缀命名，是因为这两个数据结构都比较轻量，只保存APK中很少信息；</font></li><li><font face="Courier New">一个APK真正的信息都写在<strong>AndroidManifest.xml</strong>这个文件中，<strong>PackageParser.parseBaseApk</strong>()这个方法就是用来解析该文件。其解析过程与<strong>AndroidManifest.xml</strong>的文件结构一一对应，譬如先解析&lt;application&gt;标签的内容，然后解析其下的&lt;activity&gt;,&lt;service&gt;等标签。由于<strong>AndroidManifest.xml</strong>文件的结构非常复杂，所以该方法逻辑也非常庞大，读者们可以自行分析源码。</font></li></ul> 
<p><font face="Courier New"><strong>至此，包解析器PackageParser就将一个静态的文件，转换成了内存中的数据结构Package，它包含了一个包的所有信息，如包名、包路径、权限、四大组件等，其数据来源主要就是AndroidManifest.xml文件。</strong></font></p> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_NewPackageParser_96"></a><font face="Courier New">二.PackageParser的核心方法</font></h3> 
<p><font face="Courier New">  前面我们介绍了包解析器的PackageParser设计思想，它的各种成员信息，而前面我们所做的一切的最终目的都是为了它的最最核心功能服务的就是快速的理解PackageParser是如何解析Android安装包的。而关于理解PackageParser工具类解析Android包我们可以从它的parsePackage方法开始，也从它结束！</font></p> 
<blockquote> 
 <p><font face="Courier New" size="3" color="RED">为啥说理解PackageParser对于Android包的解析可以从parsePackage方法开始，也从它结束。因为这个方法类似于一个总的入口，通过这个入口我们能理解到它其中的各种方法和小的细节的实现！如果说它是露出冰山的一角，那么我们可以顺着这个冰山看到冰山的全貌！<br><br> 并且在后续的章节中，为了体现PackageParser一系列的核心方法，我们的排版不会采用层次标题的方式，而是采用并行标题的方式。这个提前和读者朋友们提前亮出来！</font></p> 
</blockquote> 
<br> 
<h4><a id="font_faceCourier_New21_PackageParserparsePackage_108"></a><font face="Courier New">2.1 PackageParser.parsePackage(…)方法</font></h4> 
<p><font face="Courier New">前面唠叨了这么久，是时候开始我们的表演了！我们来上源码!</font></p> 
<pre><code class="prism language-java"><span class="token comment">// 【 PackageParser.java 】</span>
	<span class="token comment">/*
		解析指定位置的安装包。它自动会检测安装包的模式的是单一APK或者集群APK模式。
	    这样就可以对"集群APK"的安装包进行理性的检查，比如会检查"base APK"和"拆分APK"是否具有相同的包名和版本号。
        请注意，这里面是不执行签名验证的，所以必须要单独执行collectCertificates(Package，int)这个方法
	*/</span>
    <span class="token keyword">public</span> Package <span class="token function">parsePackage</span><span class="token punctuation">(</span>File packageFile<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageFile<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//如果解析的是目录，形如/system/app/xxx/，这个是Android 5.x之后加入的</span>
            <span class="token keyword">return</span> <span class="token function">parseClusterPackage</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 详见章节 【 2.2 】</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//解析的是/system/app/xxx.apk,这种在5.0之前常见</span>
            <span class="token keyword">return</span> <span class="token function">parseMonolithicPackage</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 详见章节 【 2.12 】，跨度咋这么大呢</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">我们先来看下parsePackage的入参，它的参数有两个:</font></p> 
<ul><li><font face="Courier New"> 第一个为待解析的安装包的路径，</font></li><li><font face="Courier New">另外一个是解析附加的flag值，不同的目录取值是不同的</font></li></ul> 
<p><font face="Courier New">接着根据掺入解析的安装路径，采取两种不同的解析方式()虽然是不同的两种解析方式，但是最后都是殊途同归：</font></p> 
<ul><li><font face="Courier New">如果packageFil 是一个目录的话，比如 /system/app/xxx/，那就采用第一种解析方式！</font></li><li><font face="Courier New">如果packageFile是一个非目录文件的话，比如 /system/app/xxx.apk，那就采用第二种解析方式！</font></li></ul> 
<blockquote> 
 <p><font face="Courier New" size="3" color="RED">Android 5.0 以前，APK都是直接位于安装/xxx/app目录下的，比如:xxx/app/MyService.apk。<br><br>但是从5.x以后，谷歌引入了apk拆分机制，就是支持将一个apk拆分成很多个具有相同签名的apk，为了支持 apk拆分，谷歌增加了一级目录：/system/app/xxx/，这个目录里会存放一到多个apk，比如 base.apk，split.apk等；<br><br> 所以PKMS在解析package时，会把多个apk的数据封装成一个 Package，加载到内存中！最终我们就得到了下面的解析分支图:<br> <img src="https://images2.imgbox.com/e9/79/3cjpYHaM_o.png" alt="在这里插入图片描述"></font></p> 
</blockquote> 
<p><font face="Courier New">这里我们先以/system/app/xxx/xxx.apk并且没有差分包的的情况来对分支parseClusterPackage方法进行分析！可能会由读者说了为啥不先从下一种情况入手呢，我想说的是先干硬的的再来软的，复杂的都被我们解决了那么后续分支parseMonolithicPackage方法的情况我们也就手到擒来了。</font></p> 
<br> 
<h4><a id="font_faceCourier_New22_PackageParserparseClusterPackage_149"></a><font face="Courier New">2.2 PackageParser.parseClusterPackage(…)方法</font></h4> 
<p><font face="Courier New">没有啥好说的，直接接着往下撸！</font></p> 
<pre><code class="prism language-java"><span class="token comment">// 【 PackageParser.java 】</span>
	<span class="token comment">/*
		解析给定目录中包含的所有APKs，将它们视为单包。这还会执行完整性检查，
		比如require相同的包名和版本代码，一个基本APK，并且是唯一的分裂的名字。
		并且这个方法不执行签名验证，如果要执行必须调用collectCertificates方法
		
		上述的翻译挺奇怪的，一句总结就是解析拆分目录下的所有apk信息，并且将信息最终封装成一个Package数据类结构
	*/</span>
    <span class="token keyword">private</span> Package <span class="token function">parseClusterPackage</span><span class="token punctuation">(</span>File packageDir<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// ***************** 第一步 *****************</span>
		<span class="token comment">// 解析目录，并获取对应的PackageLite</span>
		<span class="token keyword">final</span> PackageLite lite <span class="token operator">=</span> <span class="token function">parseClusterPackageLite</span><span class="token punctuation">(</span>packageDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 详见章节 【 2.3 】</span>
        
        <span class="token comment">// 正常流程中中，mOnlyPowerOffAlarmApps和mOnlyCoreApps的取值都为false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOnlyPowerOffAlarmApps<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mOnlyPowerOffAlarmApps <span class="token operator">&amp;&amp;</span> mOnlyCoreApps <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>lite<span class="token punctuation">.</span>coreApp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 构建AssetManager对象实例</span>
        <span class="token keyword">final</span> AssetManager assets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AssetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// ***************** 第二步 *****************</span>
            <span class="token comment">// 装载应用程序的资源到AssetManager！</span>
            <span class="token function">loadApkIntoAssetManager</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> lite<span class="token punctuation">.</span>baseCodePath<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>splitCodePaths<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 如果apk被拆分了，加载子apk的资源！</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>String path <span class="token operator">:</span> lite<span class="token punctuation">.</span>splitCodePaths<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">loadApkIntoAssetManager</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> path<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> File baseApk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>baseCodePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ***************** 第三步 *****************</span>
			<span class="token comment">// 对核心base apk解析，返回封装核心apk信息的Package对象pkg!</span>
            <span class="token keyword">final</span> Package pkg <span class="token operator">=</span> <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>baseApk<span class="token punctuation">,</span> assets<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 详见章节 【 2.8 】</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_NOT_APK<span class="token punctuation">,</span>
                        <span class="token string">"Failed to parse base APK: "</span> <span class="token operator">+</span> baseApk<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// ***************** 第四步 *****************</span>
			<span class="token comment">// 如果apk被拆分了，那就对非核心apk也进行处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>splitNames<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> num <span class="token operator">=</span> lite<span class="token punctuation">.</span>splitNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>splitNames <span class="token operator">=</span> lite<span class="token punctuation">.</span>splitNames<span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>splitCodePaths <span class="token operator">=</span> lite<span class="token punctuation">.</span>splitCodePaths<span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>splitRevisionCodes <span class="token operator">=</span> lite<span class="token punctuation">.</span>splitRevisionCodes<span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>splitFlags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>splitPrivateFlags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// 对拆分后的非核心apk也进行解析，这个不在我们当前讨论的范围之内，所以先行忽略</span>
                    <span class="token function">parseSplitApk</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> i<span class="token punctuation">,</span> assets<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            pkg<span class="token punctuation">.</span><span class="token function">setCodePath</span><span class="token punctuation">(</span>packageDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置package的codePath</span>
            pkg<span class="token punctuation">.</span><span class="token function">setUse32bitAbi</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>use32bitAbi<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> pkg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>assets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">通过源码逻辑分析，我们知道parseClusterPackage方法的处理逻辑主要分为如下的几部分:</font></p> 
<ul><li> <p><font face="Courier New">首先调用方法parseClusterPackageLite先得到一个中间数据结构<strong>PacakgeLite</strong>，最终Android的包名、版本、拆分包等信息都会保存在这个数据结构中(并且由于一个包可能有多个拆分的APK，所以<strong>PackageLite</strong>可能关联到多个APK，每一个APK都对应到<strong>ApkLite</strong>这个数据结构，也是一些基本信息的封装)</font></p> 
  <blockquote> 
   <p><font face="Courier New" size="3" color="RED">如果对于上面的流程还有不清晰的读者的话，我们可以理解parseClusterPackageLite就是依次对下面数据结构类填充的过程:<br> 1.先ApkLite<br> 2.然后根据前面得到的ApkLite信息填充PackageLite<br><br> 此时的读者也许在想前面来个获取PacakgeLite，后面又来个获取Package这有必要吗！答案是肯定的,我初步分析有如下两个:<br> 1.首先是对如果存在差分包的，拆分情况合法性的确定<br> 2.另外一个就是获得安装包下的base apk核心apk信息，注意不是说base.apk而是存在拆分情况下的核心apk，或者是不存在拆分但是是类似/system/app/xxx/下apk的情况的apk信息<br><br> 这个就好像有点我们实际生活中的处对象，如果前期验证都不能通过,那么后面的深入交流和进一步发展就无从谈起了！</font></p> 
  </blockquote> </li><li> <p><font face="Courier New">接着创建AssetManager对象，并调用loadApkIntoAssetManager方法载入"base APK"</font></p> 
  <blockquote> 
   <p><font face="Courier New" size="3" color="RED">此处逻辑，不在我们分析讨论的范围之内，读者自行分析</font></p> 
  </blockquote> </li><li> <p><font face="Courier New">然后接着调用<strong>PackageParser.parseBaseApk</strong>进行下一步的Android包处理逻辑，这个方法主要用来详细解析AndroidManifest.xml文件。其解析过程与<strong>AndroidManifest.xml</strong>的文件结构一一对应，譬如先解析&lt;application&gt;标签的内容，然后解析其下的&lt;activity&gt;,&lt;service&gt;等标签。最终将上述得到的解析信息封装成Package、此时I的Package中就基本上涵盖了AndroidManifest.xml中涉及的所有信息。</font></p> </li><li> <p><font face="Courier New">如果存在拆分的情况，则调用parseSplitApk遍历所有"拆分APK"，此时会载入第二步创建的AssetManager对象作为参数，从而实现对拆分APK资源的解析</font></p> 
  <blockquote> 
   <p><font face="Courier New" size="3" color="RED">根据我们前面的预制条件是不会进入此分支的，所以关于存在拆分包情况的解析，这里就不放出来了，其逻辑并不是很复杂。读者将主线分支理解清楚之后，可以自行存在差分包情况的分析。</font></p> 
  </blockquote> </li></ul> 
<br> 
<h4><a id="font_faceCourier_New23_PackageParserparseClusterPackageLite_247"></a><font face="Courier New">2.3 PackageParser.parseClusterPackageLite(…)方法</font></h4> 
<blockquote> 
 <p><font face="Courier New" size="3" color="RED">按照排版的逻辑，此处应该属于前面一个章节的小标题，但是为了展现PackageParser解析器中各种方法，所以采用了平行章节的方式。</font></p> 
</blockquote> 
<p><font face="Courier New">好了，我们接着继续分析源码！</font></p> 
<pre><code class="prism language-java"><span class="token comment">// 【 PackageParser.java 】</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> PackageLite <span class="token function">parseClusterPackageLite</span><span class="token punctuation">(</span>File packageDir<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取目录下的所有文件</span>
        <span class="token keyword">final</span> File<span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> packageDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_NOT_APK<span class="token punctuation">,</span>
                    <span class="token string">"No packages found in split"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        String packageName <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">int</span> versionCode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token comment">// ***************** 第一步 *****************</span>
		<span class="token comment">// 开始验证包名和版本号是否一致</span>
        <span class="token keyword">final</span> ArrayMap<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> ApkLite<span class="token punctuation">&gt;</span></span> apks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 遍历所有文件</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isApkFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 解析单个APK文件成ApkLite对象</span>
                <span class="token keyword">final</span> ApkLite lite <span class="token operator">=</span> <span class="token function">parseApkLite</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 详见章节 【 2.4 】</span>
                
                 <span class="token comment">// 遍历的时候只有第一个文件的时候packageName为null</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>packageName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    packageName <span class="token operator">=</span> lite<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
                    versionCode <span class="token operator">=</span> lite<span class="token punctuation">.</span>versionCode<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// 对比当前的lite对象和上一个lite对象的包名是否一致</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_BAD_MANIFEST<span class="token punctuation">,</span>
                                <span class="token string">"Inconsistent package "</span> <span class="token operator">+</span> lite<span class="token punctuation">.</span>packageName <span class="token operator">+</span> <span class="token string">" in "</span> <span class="token operator">+</span> file
                                <span class="token operator">+</span> <span class="token string">"; expected "</span> <span class="token operator">+</span> packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
					<span class="token comment">// 对比当前的lite对象和上一个lite对象的版本号是否一致</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>versionCode <span class="token operator">!=</span> lite<span class="token punctuation">.</span>versionCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_BAD_MANIFEST<span class="token punctuation">,</span>
                                <span class="token string">"Inconsistent version "</span> <span class="token operator">+</span> lite<span class="token punctuation">.</span>versionCode <span class="token operator">+</span> <span class="token string">" in "</span> <span class="token operator">+</span> file
                                <span class="token operator">+</span> <span class="token string">"; expected "</span> <span class="token operator">+</span> versionCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment">/*
                	保证不重复添加
                	将解析得到的ApkLite对象添加到一个ArrayMap集合中
                	此处对于核心apk，splitName为null
               	*/</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>apks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>splitName<span class="token punctuation">,</span> lite<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_BAD_MANIFEST<span class="token punctuation">,</span>
                            <span class="token string">"Split name "</span> <span class="token operator">+</span> lite<span class="token punctuation">.</span>splitName
                            <span class="token operator">+</span> <span class="token string">" defined more than once; most recent was "</span> <span class="token operator">+</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// ***************** 第二步 *****************</span>
		<span class="token comment">/* 
			从列表中移除核心apk，保存到baseApk中，之所以remove null，是因为base apk的splitName为null！
    	 	如果没有base apk，那就报错！！
    	 */</span>
        <span class="token keyword">final</span> ApkLite baseApk <span class="token operator">=</span> apks<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>baseApk <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_BAD_MANIFEST<span class="token punctuation">,</span>
                    <span class="token string">"Missing base APK in "</span> <span class="token operator">+</span> packageDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// ***************** 第三步 *****************</span>
        <span class="token comment">// 处理非核心的apk</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> apks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> splitNames <span class="token operator">=</span> null<span class="token punctuation">;</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> splitCodePaths <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> splitRevisionCodes <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//获得非核心apk的splitName，codePath和splitRevisionCodes！</span>
            splitNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
            splitCodePaths <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
            splitRevisionCodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>

            splitNames <span class="token operator">=</span> apks<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>splitNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// splitNames排序</span>
            Arrays<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>splitNames<span class="token punctuation">,</span> sSplitNameComparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 初始化splitCodePaths和splitRevisionCodes</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                splitCodePaths<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> apks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>splitNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>codePath<span class="token punctuation">;</span>
                splitRevisionCodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> apks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>splitNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>revisionCode<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// ***************** 第四步 *****************</span>
        <span class="token keyword">final</span> String codePath <span class="token operator">=</span> packageDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PackageLite</span><span class="token punctuation">(</span>codePath<span class="token punctuation">,</span> baseApk<span class="token punctuation">,</span> splitNames<span class="token punctuation">,</span> splitCodePaths<span class="token punctuation">,</span>
                splitRevisionCodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">通过源码逻辑分析，我们可以得出parseClusterPackageLite方法的处理逻辑主要分为如下的几部分:</font></p> 
<ul><li> <p><font face="Courier New">遍历安装包目录， 然后调用parseApkLite方法获取安装包目录下各个APK文件的轻量级的数据结构ApkLite，并且解析得到数据加入到ArrayMap列表中。并且如果存在差分包的情况则进行相关的校验，主要是校验包名和版本号是否一致</font></p> 
  <blockquote> 
   <p><font face="Courier New" size="3" color="RED">关于安装包存在拆分的情况，存在许多的限制，并且需要做一些常规的检验等。并且此种情况也不在我们重点主干的分析情况下，所以对于存在拆分的情况只是一笔带过！</font></p> 
  </blockquote> </li><li> <p><font face="Courier New">接着从前面的ArrayMap列表中取出核心的"base APK“赋给baseApk.</font></p> </li><li> <p><font face="Courier New">如果存在差分包的情况则继续对splitNames、splitCodePaths、splitRevisionCodes完成初始化</font></p> </li><li> <p><font face="Courier New">最后填充codePath,并且将前面获取的一系列变量信息填充构造一个PackageLite实例对象返回回去</font></p> </li></ul> 
<p><font face="Courier New">总体来说，上述源码的逻辑并不是十分复杂，只是比较繁琐而已，而已！</font></p> 
<br> 
<h4><a id="font_faceCourier_New24_PackageParserparseApkLiteFile__363"></a><font face="Courier New">2.4 PackageParser.parseApkLite(File …)方法</font></h4> 
<blockquote> 
 <p><font face="Courier New" size="3" color="RED">此处是针对单个APK文件进行轻量级的解析！</font></p> 
</blockquote> 
<p><font face="Courier New">撸起柚子，我们接着继续分析源码！</font></p> 
<pre><code class="prism language-java"><span class="token comment">// 【 PackageParser.java 】</span>
    <span class="token comment">/**
     * Utility method that retrieves lightweight details about a single APK
     * file, including package name, split name, and install location.
     *
     * @param apkFile path to a single APK
     * @param flags optional parse flags, such as
     *            {@link #PARSE_COLLECT_CERTIFICATES}
     */</span>
    <span class="token comment">/*
    	这是一个轻量级的用于检索单个APK的轻量级细节的实用程序方法文件，包括包名称、
    	分割名称和安装位置的方法
		
		并且要注意此时的第一个入参类型为File，因为parseApkLite有被重载了，所以不要搞混淆了
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> ApkLite <span class="token function">parseApkLite</span><span class="token punctuation">(</span>File apkFile<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> String apkPath <span class="token operator">=</span> apkFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        AssetManager assets <span class="token operator">=</span> null<span class="token punctuation">;</span>
        XmlResourceParser parser <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 创建资源管理器</span>
            assets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AssetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            assets<span class="token punctuation">.</span><span class="token function">setConfiguration</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>RESOURCES_SDK_INT<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 资源管理器加载待解析apk的资源，主要用于解析AndroidManifest.xml文件</span>
			<span class="token keyword">int</span> cookie <span class="token operator">=</span> assets<span class="token punctuation">.</span><span class="token function">addAssetPath</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_NOT_APK<span class="token punctuation">,</span>
                        <span class="token string">"Failed to parse "</span> <span class="token operator">+</span> apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">final</span> DisplayMetrics metrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            metrics<span class="token punctuation">.</span><span class="token function">setToDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> Resources res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resources</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> metrics<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 创建解析器，用来解析apk中的AndroidMenifest.xml配置文件</span>
            parser <span class="token operator">=</span> assets<span class="token punctuation">.</span><span class="token function">openXmlResourceParser</span><span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> ANDROID_MANIFEST_FILENAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> Signature<span class="token punctuation">[</span><span class="token punctuation">]</span> signatures<span class="token punctuation">;</span>
            <span class="token keyword">final</span> Certificate<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> certificates<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PARSE_COLLECT_CERTIFICATES<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 如果需要验证签名信息</span>
                <span class="token comment">// TODO: factor signature related items out of Package object</span>
                <span class="token keyword">final</span> Package tempPkg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Package</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"collectCertificates"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// 进行签名验证，并将签名保存在signatures中</span>
                    <span class="token function">collectCertificates</span><span class="token punctuation">(</span>tempPkg<span class="token punctuation">,</span> apkFile<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/*parseFlags*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                signatures <span class="token operator">=</span> tempPkg<span class="token punctuation">.</span>mSignatures<span class="token punctuation">;</span>
                certificates <span class="token operator">=</span> tempPkg<span class="token punctuation">.</span>mCertificates<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                signatures <span class="token operator">=</span> null<span class="token punctuation">;</span>
                certificates <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// 将&lt;manifest&gt;标签的属性赋给attrs！</span>
            <span class="token keyword">final</span> AttributeSet attrs <span class="token operator">=</span> parser<span class="token punctuation">;</span>
			<span class="token comment">// 接着调用重载的parseApkLite继续解析流程</span>
            <span class="token keyword">return</span> <span class="token function">parseApkLite</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> signatures<span class="token punctuation">,</span> certificates<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">XmlPullParserException</span> <span class="token operator">|</span> IOException <span class="token operator">|</span> RuntimeException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION<span class="token punctuation">,</span>
                    <span class="token string">"Failed to parse "</span> <span class="token operator">+</span> apkPath<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>assets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">上述源码逻辑并不复杂，只是比较繁琐，核心的诉求点只有一个就是解析单个APK文件获取轻量级的ApkLite对象实例。我们通过分析可知上述的核心处理步骤为:</font></p> 
<ul><li><font face="Courier New">首先创建AssetManager对象assets</font></li><li><font face="Courier New">接着assets调用addAssetPath加载待解析apk的资源</font></li><li><font face="Courier New">然后用assets作为入参来创建Resources对象res</font></li><li><font face="Courier New">接着调用assets的openXmlResourceParser()来获取XmlResourceParser对象parser对象</font></li><li><font face="Courier New">然后如果传入的flag携带的标志，标明需要获取签名信息，则调用collectCertificates方法获取Android包签名信息</font></li><li><font face="Courier New">最后调用重载的parseApkLite(String,Resource,XmlPullParser,AttributeSet,int,Signature[])方法来返回一个ApkLite对象</font></li></ul> 
<blockquote> 
 <p><font face="Courier New" size="3" color="RED">在该方法里面有初始化了一个AssertMananger对象，一个DisplayMetrics对象，一个Resources对象，但是细心的读者也许发现了这些对象在当前的方法中都没有被使用到，这些对象都是后续解析中需要用的，因此将这些参数传递给它的重载parseApkLite方法，在它的重载方法中解析完成后关闭资源管理器与解析器。</font></p> 
</blockquote> 
<p><font face="Courier New">我们接着继续分析parseApkLite另外一个重载方法，看看它是怎么继续进一步处理的。</font></p> 
<br> 
<h4><a id="font_faceCourier_New25_PackageParserparseApkLiteString__464"></a><font face="Courier New">2.5 PackageParser.parseApkLite(String …)方法</font></h4> 
<blockquote> 
 <p><font face="Courier New" size="3" color="RED">注意此处，不是博主跑错了片场又重新将前面的标题复制了一篇，这里的parseApkLite是另外一个重载的方法，是一个重载的方法。<br><br>在PKMS的分析中，我们可以发现存在非常非常多的重载方法！所以如果下次面试或者其它的环境下有人询问你关于重载的使用，你可以将PKMS中各种重载直接甩给他！</font></p> 
</blockquote> 
<p><font face="Courier New">提起精神，我们接着继续分析源码！</font></p> 
<pre><code class="prism language-java"><span class="token comment">// 【 PackageParser.java 】</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> ApkLite <span class="token function">parseApkLite</span><span class="token punctuation">(</span>String codePath<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span> XmlPullParser parser<span class="token punctuation">,</span>
            AttributeSet attrs<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> Signature<span class="token punctuation">[</span><span class="token punctuation">]</span> signatures<span class="token punctuation">,</span> Certificate<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> certificates<span class="token punctuation">)</span>
                    <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> XmlPullParserException<span class="token punctuation">,</span> PackageParserException <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// ***************** 第一步 *****************</span>
		<span class="token comment">// 解析得到是否有拆分相关信息</span>
		<span class="token keyword">final</span> Pair<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> packageSplit <span class="token operator">=</span> <span class="token function">parsePackageSplitNames</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 详见章节 【 2.6 】</span>

        <span class="token keyword">int</span> installLocation <span class="token operator">=</span> PARSE_DEFAULT_INSTALL_LOCATION<span class="token punctuation">;</span>
        <span class="token keyword">int</span> versionCode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> revisionCode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> coreApp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> multiArch <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> use32bitAbi <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> extractNativeLibs <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

		<span class="token comment">// ***************** 第二步 *****************</span>
		<span class="token comment">// 解析&lt;manifest&gt;标签的属性，并填充相关变量</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> attrs<span class="token punctuation">.</span><span class="token function">getAttributeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> String attr <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">getAttributeName</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 解析android:installLocation属性，表示安装位置，取值为auto|internalOnly|preferExternal</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>attr<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"installLocation"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                installLocation <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">getAttributeIntValue</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>
                        PARSE_DEFAULT_INSTALL_LOCATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>attr<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"versionCode"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                versionCode <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">getAttributeIntValue</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>attr<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"revisionCode"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                revisionCode <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">getAttributeIntValue</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>attr<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"coreApp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 是否是核心app</span>
                coreApp <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">getAttributeBooleanValue</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ***************** 第三步 *****************</span>
        <span class="token comment">// 接着，解析manifest标签的直接子标签</span>
        <span class="token keyword">int</span> type<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> searchDepth <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>VerifierInfo<span class="token punctuation">&gt;</span></span> verifiers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>VerifierInfo<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> searchDepth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>TEXT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// 解析&lt;package-verifier&gt;标签的属性</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> searchDepth <span class="token operator">&amp;&amp;</span> <span class="token string">"package-verifier"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> VerifierInfo verifier <span class="token operator">=</span> <span class="token function">parseVerifier</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>verifier <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    verifiers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>verifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// 解析&lt;application&gt;标签的属性！</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> searchDepth <span class="token operator">&amp;&amp;</span> <span class="token string">"application"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> attrs<span class="token punctuation">.</span><span class="token function">getAttributeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">final</span> String attr <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">getAttributeName</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"multiArch"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        multiArch <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">getAttributeBooleanValue</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"use32bitAbi"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        use32bitAbi <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">getAttributeBooleanValue</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"extractNativeLibs"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        extractNativeLibs <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">getAttributeBooleanValue</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ***************** 第四步 *****************</span>
		<span class="token comment">// 根据解析得到的数据，构建apk对应的ApkLite对象</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApkLite</span><span class="token punctuation">(</span>codePath<span class="token punctuation">,</span> packageSplit<span class="token punctuation">.</span>first<span class="token punctuation">,</span> packageSplit<span class="token punctuation">.</span>second<span class="token punctuation">,</span> versionCode<span class="token punctuation">,</span>
                revisionCode<span class="token punctuation">,</span> installLocation<span class="token punctuation">,</span> verifiers<span class="token punctuation">,</span> signatures<span class="token punctuation">,</span> certificates<span class="token punctuation">,</span> coreApp<span class="token punctuation">,</span>
                multiArch<span class="token punctuation">,</span> use32bitAbi<span class="token punctuation">,</span> extractNativeLibs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">上述源码逻辑依然并不复杂，核心的诉求点只有一个就是继续解析单个APK文件获取轻量级的ApkLite对象实例。我们通过分析可知上述的核心处理步骤为:</font></p> 
<ul><li><font face="Courier New">首先调用parsePackageSplitNames方法解析解析apk的 &lt;manifest&gt;标签的package属性和split属性,然后以返回packageName和splitName的Pair对象</font></li><li><font face="Courier New">接着再次遍历&lt;manifest&gt;标签属性，并获取相应的值，这里面主要是循环解析出installLocation，versionCode，revisionCode，coreApp</font></li><li><font face="Courier New">接着再次解析&lt;manifest&gt;标签的直接子标签&lt;package-verifier&gt;和&lt;application&gt;，并得到相关的标签属性值保存起来</font></li><li><font face="Courier New">最后利用前面解析出来的数据去构造一个ApkLite实例对象返回回去，关于ApkLite对象的介绍可以参见前面博客</font></li></ul> 
<p><font face="Courier New">此处收功，我们接着继续下面的流程！</font></p> 
<br> 
<h4><a id="font_faceCourier_New26_PackageParserparsePackageSplitNames_560"></a><font face="Courier New">2.6 PackageParser.parsePackageSplitNames()方法</font></h4> 
<p><font face="Courier New">路漫漫其修远兮，吾将上下而求索！战斗依然还在继续，我们继续跟进！</font></p> 
<pre><code class="prism language-java"><span class="token comment">// 【 PackageParser.java 】</span>
	<span class="token comment">/*
		该方法用于解析apk的AndroidManifest.xml的&lt;manifest&gt;标签的package属性
	*/</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Pair<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> <span class="token function">parsePackageSplitNames</span><span class="token punctuation">(</span>XmlPullParser parser<span class="token punctuation">,</span>
            AttributeSet attrs<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> XmlPullParserException<span class="token punctuation">,</span>
            PackageParserException <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">int</span> type<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>START_TAG
                <span class="token operator">&amp;&amp;</span> type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>START_TAG<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">,</span>
                    <span class="token string">"No start tag found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_MANIFEST<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">,</span>
                    <span class="token string">"No &lt;manifest&gt; tag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 解析manifest标签的package属性</span>
        <span class="token keyword">final</span> String packageName <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"package"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"android"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 如果package不是android，则需要校验格式</span>
            <span class="token keyword">final</span> String error <span class="token operator">=</span> <span class="token function">validateName</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME<span class="token punctuation">,</span>
                        <span class="token string">"Invalid manifest package: "</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 解析manifest标签的split属性</span>
        String splitName <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"split"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>splitName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>splitName<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                splitName <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> String error <span class="token operator">=</span> <span class="token function">validateName</span><span class="token punctuation">(</span>splitName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME<span class="token punctuation">,</span>
                            <span class="token string">"Invalid manifest split: "</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 返回packageName和splitName的Pair对象！</span>
        <span class="token keyword">return</span> Pair<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>packageName<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>splitName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> splitName<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> splitName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">此方法的核心逻辑就是无外乎两点:</font></p> 
<ul><li><font face="Courier New">先解析apk的 &lt;manifest&gt;标签的package属性和split属性，在获得package包名之后会调用validateName方法来判断获取的apk包名的有效性，这里简单说下，这个方法主要就是检测是否是数字、字母、下划线和点分隔符，这也是取包名的规则，比如是字母数字下划线加点分隔符，否则都不是合法的应用包名。并且合法的包名至少包含一个点分隔符。 </font> 
  <blockquote> 
   <p><font face="Courier New" size="3" color="red">对于包名的合法性判断规则，过滤了一个特别的包名"android"，读者知道这个特殊的包名是那个应用吗，是的它就是/system/framework/framework-res.apk！</font></p> 
  </blockquote> </li><li><font face="Courier New">然后将获取到的package和split属性值，以Pair对的形式返回</font></li></ul> 
<br> 
<h4><a id="font_faceCourier_New27_PackageParserparseBaseApkFile__628"></a><font face="Courier New">2.7 PackageParser.parseBaseApk(File …)方法</font></h4> 
<blockquote> 
 <p><font face="Courier New" size="3" color="RED">分析支持，读者估计心里有一个声音了我是谁，我在那里的恍惚感觉了。还是让我们来捋一捋，还记的在章节2.2中parseClusterPackage中我们分了两步走:<br> 1.我们是先通过parseClusterPackageLite方法获取了Android包轻量级的包信息体(我们前面的一大部分工作量都耗在这个里面了)<br><br> 2.然后接着调用parseBaseApk来真刀真枪的获取全的Android包信息(这就是我们来到此处的原因)<br><br>并且我们需要注意，此时解析的是"base apk"文件，不是拆包的apk或者其它</font></p> 
</blockquote> 
<p><font face="Courier New">既然解决了我是谁，我来自那里的问题了！我们责无旁贷的，必须向前冲，继续干就好了！</font></p> 
<pre><code class="prism language-java"><span class="token comment">// 【 PackageParser.java 】</span>
    <span class="token keyword">private</span> Package <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>File apkFile<span class="token punctuation">,</span> AssetManager assets<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> String apkPath <span class="token operator">=</span> apkFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String volumeUuid <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>apkPath<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>MNT_EXPAND<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析 /mnt/expand/</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> end <span class="token operator">=</span> apkPath<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> MNT_EXPAND<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            volumeUuid <span class="token operator">=</span> apkPath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>MNT_EXPAND<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">;</span>
        mArchiveSourcePath <span class="token operator">=</span> apkFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_JAR<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Scanning base APK: "</span> <span class="token operator">+</span> apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 用于解析AndroidManifest.xml文件</span>
		<span class="token keyword">final</span> <span class="token keyword">int</span> cookie <span class="token operator">=</span> <span class="token function">loadApkIntoAssetManager</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> apkPath<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Resources res <span class="token operator">=</span> null<span class="token punctuation">;</span>
        XmlResourceParser parser <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resources</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> mMetrics<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            assets<span class="token punctuation">.</span><span class="token function">setConfiguration</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>RESOURCES_SDK_INT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            parser <span class="token operator">=</span> assets<span class="token punctuation">.</span><span class="token function">openXmlResourceParser</span><span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> ANDROID_MANIFEST_FILENAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token comment">// 调用重载的parseBaseApk进行下一步的解析</span>
            <span class="token keyword">final</span> Package pkg <span class="token operator">=</span> <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 详见章节 【 2.8 】</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>mParseError<span class="token punctuation">,</span>
                        apkPath <span class="token operator">+</span> <span class="token string">" (at "</span> <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"): "</span> <span class="token operator">+</span> outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            pkg<span class="token punctuation">.</span><span class="token function">setVolumeUuid</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setApplicationVolumeUuid</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setBaseCodePath</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span><span class="token function">setSignatures</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> pkg<span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION<span class="token punctuation">,</span>
                    <span class="token string">"Failed to read manifest from "</span> <span class="token operator">+</span> apkPath<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p><font face="Courier New">此处方法逻辑不复杂，核心步骤如下：</font></p> 
<ul><li> <p><font face="Courier New">判断当前安装包路劲是不是/mnt/expand/，如果是对volumeUuid值做特殊处理</font></p> 
  <blockquote> 
   <p><font face="Courier New" size="3" color="RED">不要问我volumeUuid是啥，我也木有搞懂是啥，直接忽略。</font></p> 
  </blockquote> </li><li> <p><font face="Courier New">接着构建以安装包路径为参数的Resources和XmlResourceParser等实例对象</font></p> </li><li> <p><font face="Courier New">以上述构建的实例对象为参数，接着调用另外一个重载的parseBaseApk进行下一步的处理</font></p> </li></ul> 
<p><font face="Courier New">接着继续往下撸！</font></p> 
<br> 
<h4><a id="font_faceCourier_New28_PackageParserparseBaseApkResources__706"></a><font face="Courier New">2.8 PackageParser.parseBaseApk(Resources …)方法</font></h4> 
<p><font face="Courier New">一直撸，一直爽！让我们继续撸！</font></p> 
<pre><code class="prism language-java">    <span class="token comment">/**
		此类用于详细解析base apk的清单文件
     */</span>
    <span class="token keyword">private</span> Package <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>Resources res<span class="token punctuation">,</span> XmlResourceParser parser<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError<span class="token punctuation">)</span> <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> String splitName<span class="token punctuation">;</span>
        <span class="token keyword">final</span> String pkgName<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// ***************** 第一步 *****************</span>
			<span class="token comment">/*
				解析&lt;manifest&gt;标签，获得packageName和splitName的值
				并且结果以Pair&lt;packageName, splitName&gt;的形式返回
			*/</span>
            Pair<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> packageSplit <span class="token operator">=</span> <span class="token function">parsePackageSplitNames</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> parser<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 章节 【 2.5 】已经详细分析了</span>
            pkgName <span class="token operator">=</span> packageSplit<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
            splitName <span class="token operator">=</span> packageSplit<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
			<span class="token comment">// 异常处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>splitName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Expected base APK, but found split "</span> <span class="token operator">+</span> splitName<span class="token punctuation">;</span>
                mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME<span class="token punctuation">;</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME<span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 构建一个Package实例对象，用于保存最终的解析信息</span>
        <span class="token keyword">final</span> Package pkg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Package</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        TypedArray sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// ***************** 第二步 *****************</span>
		<span class="token comment">// 通过解析标签&lt;manifest&gt;标签初始化pkg的属性mVersionCode、baseRevisionCode和mVersionName</span>
        pkg<span class="token punctuation">.</span>mVersionCode <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>versionCode <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_versionCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkg<span class="token punctuation">.</span>baseRevisionCode <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_revisionCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkg<span class="token punctuation">.</span>mVersionName <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_versionName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mVersionName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pkg<span class="token punctuation">.</span>mVersionName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>mVersionName<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 是不是核心App</span>
        pkg<span class="token punctuation">.</span>coreApp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeBooleanValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"coreApp"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// ***************** 第三步 *****************</span>
		<span class="token comment">// 接着调用parseBaseApkCommon方法，继续解析</span>
        <span class="token keyword">return</span> <span class="token function">parseBaseApkCommon</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> null<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 详见章节 【 2.9 】</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">上述逻辑依然不是很复杂，其核心逻辑分为如下几个部分:</font></p> 
<ul><li> <p><font face="Courier New">首先调用parsePackageSplitNames方法解析“base apk”的&lt;manifest&gt;标签，获得packageName和splitName的值并且结果以Pair&lt;packageName, splitName&gt;的形式返回,得到上述的返回值以后再判断合法性</font></p> </li><li> <p><font face="Courier New">接着通过解析标签&lt;manifest&gt;属性初始化pkg的属性mVersionCode、baseRevisionCode和mVersionName</font></p> </li><li> <p><font face="Courier New">接着继续调用parseBaseApkCommon开始更进一步的详细解析，从而完全填充Package实例对象的信息</font></p> </li></ul> 
<blockquote> 
 <p><font face="Courier New" size="3" color="RED">parseBaseApkCommon的解析逻辑非常繁琐且冗长，主要是完全解析"base apk" 的配置清单文件，然后将解析得到的数据填充Package实例！<br><br>读者可以先行想想一下工作量，就是你自己完全解析复杂的Androidmanifest.xml文件！</font></p> 
</blockquote> 
<br> 
<h4><a id="font_faceCourier_New29_PackageParserparseBaseApkCommon_781"></a><font face="Courier New">2.9 PackageParser.parseBaseApkCommon()方法</font></h4> 
<p><font face="Courier New">前方高能预警，此处的parseBaseApkCommon源码逻辑一大堆，难度不大但是及其繁琐！一口气给整完，估计是有点难度，实在不行就整两口！</font></p> 
<pre><code class="prism language-java"><span class="token comment">// 【 PackageParser.java 】</span>
    <span class="token keyword">private</span> Package <span class="token function">parseBaseApkCommon</span><span class="token punctuation">(</span>Package pkg<span class="token punctuation">,</span> Set<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> acceptedTags<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span>
            XmlResourceParser parser<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError<span class="token punctuation">)</span> <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span>
            IOException <span class="token punctuation">{<!-- --></span>
        mParseInstrumentationArgs <span class="token operator">=</span> null<span class="token punctuation">;</span>
        mParseActivityArgs <span class="token operator">=</span> null<span class="token punctuation">;</span>
        mParseServiceArgs <span class="token operator">=</span> null<span class="token punctuation">;</span>
        mParseProviderArgs <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">int</span> type<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> foundApp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token comment">// 继续获取&lt;manifest&gt;标签属性</span>
        TypedArray sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 获取sharedUserId属性值</span>
        String str <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_sharedUserId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> str<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 异常处理</span>
            String nameError <span class="token operator">=</span> <span class="token function">validateName</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nameError <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">"android"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"&lt;manifest&gt; specifies bad sharedUserId name \""</span>
                    <span class="token operator">+</span> str <span class="token operator">+</span> <span class="token string">"\": "</span> <span class="token operator">+</span> nameError<span class="token punctuation">;</span>
                mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_BAD_SHARED_USER_ID<span class="token punctuation">;</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            pkg<span class="token punctuation">.</span>mSharedUserId <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span>mSharedUserLabel <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getResourceId</span><span class="token punctuation">(</span>
                    com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_sharedUserLabel<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 获取installLocation属性值</span>
        pkg<span class="token punctuation">.</span>installLocation <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_installLocation<span class="token punctuation">,</span>
                PARSE_DEFAULT_INSTALL_LOCATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>installLocation <span class="token operator">=</span> pkg<span class="token punctuation">.</span>installLocation<span class="token punctuation">;</span>

		<span class="token comment">// 根据传入的flag设置对应ApplicationInfo的flag值</span>
        <span class="token comment">/* Set the global "forward lock" flag */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PARSE_FORWARD_LOCK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>privateFlags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_FORWARD_LOCK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Set the global "on SD card" flag */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PARSE_EXTERNAL_STORAGE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_EXTERNAL_STORAGE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PARSE_IS_EPHEMERAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>privateFlags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_EPHEMERAL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Resource boolean are -1, so 1 means we don't know the value.</span>
        <span class="token keyword">int</span> supportsSmallScreens <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> supportsNormalScreens <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> supportsLargeScreens <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> supportsXLargeScreens <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> resizeable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> anyDensity <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> outerDepth <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 开始解析Androidmanifest.xml的&lt;manifest&gt;的子标签</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> outerDepth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>TEXT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            String tagName <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>acceptedTags <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>acceptedTags<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Skipping unsupported element under &lt;manifest&gt;: "</span>
                        <span class="token operator">+</span> tagName <span class="token operator">+</span> <span class="token string">" at "</span> <span class="token operator">+</span> mArchiveSourcePath <span class="token operator">+</span> <span class="token string">" "</span>
                        <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

			<span class="token comment">//开始解析&lt;application&gt;标签，这个是重头戏</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_APPLICATION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>foundApp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>RIGID_PARSER<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span><span class="token punctuation">;</span>
                        mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                foundApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token comment">/*
					调用parseBaseApplication方法进行下一步的解析，
					并将解析的数据填充Package实例对象
				*/</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">parseBaseApplication</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 详见章节 【 2.10 】</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_OVERLAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//解析&lt;overlay&gt;标签</span>
                sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestResourceOverlay<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>mOverlayTarget <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestResourceOverlay_targetPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>mOverlayPriority <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestResourceOverlay_priority<span class="token punctuation">,</span>
                        <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mOverlayTarget <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"&lt;overlay&gt; does not specify a target package"</span><span class="token punctuation">;</span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mOverlayPriority <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> pkg<span class="token punctuation">.</span>mOverlayPriority <span class="token operator">&gt;</span> <span class="token number">9999</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"&lt;overlay&gt; priority must be between 0 and 9999"</span><span class="token punctuation">;</span>
                    mParseError <span class="token operator">=</span>
                        PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_KEY_SETS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析 &lt;key-sets&gt;标签</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">parseKeySets</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_PERMISSION_GROUP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;permission-group&gt;标签</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parsePermissionGroup</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> outError<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_PERMISSION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;permission&gt;标签</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parsePermission</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> outError<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_PERMISSION_TREE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;permission-tree&gt;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parsePermissionTree</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> outError<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_USES_PERMISSION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;uses-permission&gt;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">parseUsesPermission</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_USES_PERMISSION_SDK_M<span class="token punctuation">)</span>
                    <span class="token operator">||</span> tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_USES_PERMISSION_SDK_23<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 解析&lt;uses-permission-sdk-m&gt;或&lt;uses-permission-sdk-23&gt;标签</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">parseUsesPermission</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_USES_CONFIGURATION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;uses-configuration&gt;标签</span>
                ConfigurationInfo cPref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestUsesConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cPref<span class="token punctuation">.</span>reqTouchScreen <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestUsesConfiguration_reqTouchScreen<span class="token punctuation">,</span>
                        Configuration<span class="token punctuation">.</span>TOUCHSCREEN_UNDEFINED<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cPref<span class="token punctuation">.</span>reqKeyboardType <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestUsesConfiguration_reqKeyboardType<span class="token punctuation">,</span>
                        Configuration<span class="token punctuation">.</span>KEYBOARD_UNDEFINED<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestUsesConfiguration_reqHardKeyboard<span class="token punctuation">,</span>
                        <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    cPref<span class="token punctuation">.</span>reqInputFeatures <span class="token operator">|=</span> ConfigurationInfo<span class="token punctuation">.</span>INPUT_FEATURE_HARD_KEYBOARD<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                cPref<span class="token punctuation">.</span>reqNavigation <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestUsesConfiguration_reqNavigation<span class="token punctuation">,</span>
                        Configuration<span class="token punctuation">.</span>NAVIGATION_UNDEFINED<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestUsesConfiguration_reqFiveWayNav<span class="token punctuation">,</span>
                        <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    cPref<span class="token punctuation">.</span>reqInputFeatures <span class="token operator">|=</span> ConfigurationInfo<span class="token punctuation">.</span>INPUT_FEATURE_FIVE_WAY_NAV<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>configPreferences <span class="token operator">=</span> ArrayUtils<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>configPreferences<span class="token punctuation">,</span> cPref<span class="token punctuation">)</span><span class="token punctuation">;</span>

                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_USES_FEATURE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 解析&lt;uses-feature&gt;标签</span>
                FeatureInfo fi <span class="token operator">=</span> <span class="token function">parseUsesFeature</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>reqFeatures <span class="token operator">=</span> ArrayUtils<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>reqFeatures<span class="token punctuation">,</span> fi<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>fi<span class="token punctuation">.</span>name <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    ConfigurationInfo cPref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cPref<span class="token punctuation">.</span>reqGlEsVersion <span class="token operator">=</span> fi<span class="token punctuation">.</span>reqGlEsVersion<span class="token punctuation">;</span>
                    pkg<span class="token punctuation">.</span>configPreferences <span class="token operator">=</span> ArrayUtils<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>configPreferences<span class="token punctuation">,</span> cPref<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_FEATURE_GROUP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;feature-group&gt;标签</span>
                FeatureGroupInfo group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FeatureGroupInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>FeatureInfo<span class="token punctuation">&gt;</span></span> features <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> innerDepth <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> innerDepth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>TEXT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">final</span> String innerTagName <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>innerTagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"uses-feature"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        FeatureInfo featureInfo <span class="token operator">=</span> <span class="token function">parseUsesFeature</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// FeatureGroups are stricter and mandate that</span>
                        <span class="token comment">// any &lt;uses-feature&gt; declared are mandatory.</span>
                        featureInfo<span class="token punctuation">.</span>flags <span class="token operator">|=</span> FeatureInfo<span class="token punctuation">.</span>FLAG_REQUIRED<span class="token punctuation">;</span>
                        features <span class="token operator">=</span> ArrayUtils<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> featureInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unknown element under &lt;feature-group&gt;: "</span> <span class="token operator">+</span> innerTagName <span class="token operator">+</span>
                                <span class="token string">" at "</span> <span class="token operator">+</span> mArchiveSourcePath <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span>
                                parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>features <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    group<span class="token punctuation">.</span>features <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FeatureInfo</span><span class="token punctuation">[</span>features<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    group<span class="token punctuation">.</span>features <span class="token operator">=</span> features<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>group<span class="token punctuation">.</span>features<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                pkg<span class="token punctuation">.</span>featureGroups <span class="token operator">=</span> ArrayUtils<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>featureGroups<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_USES_SDK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;uses-sdk&gt;标签</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>SDK_VERSION <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestUsesSdk<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">int</span> minVers <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    String minCode <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token keyword">int</span> targetVers <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    String targetCode <span class="token operator">=</span> null<span class="token punctuation">;</span>

                    TypedValue val <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">peekValue</span><span class="token punctuation">(</span>
                            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestUsesSdk_minSdkVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>val<span class="token punctuation">.</span>type <span class="token operator">==</span> TypedValue<span class="token punctuation">.</span>TYPE_STRING <span class="token operator">&amp;&amp;</span> val<span class="token punctuation">.</span>string <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            targetCode <span class="token operator">=</span> minCode <span class="token operator">=</span> val<span class="token punctuation">.</span>string<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// If it's not a string, it's an integer.</span>
                            targetVers <span class="token operator">=</span> minVers <span class="token operator">=</span> val<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    val <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">peekValue</span><span class="token punctuation">(</span>
                            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestUsesSdk_targetSdkVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>val<span class="token punctuation">.</span>type <span class="token operator">==</span> TypedValue<span class="token punctuation">.</span>TYPE_STRING <span class="token operator">&amp;&amp;</span> val<span class="token punctuation">.</span>string <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            targetCode <span class="token operator">=</span> val<span class="token punctuation">.</span>string<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>minCode <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                minCode <span class="token operator">=</span> targetCode<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            targetVers <span class="token operator">=</span> val<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>minCode <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">boolean</span> allowedCodename <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>String codename <span class="token operator">:</span> SDK_CODENAMES<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>minCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>codename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                allowedCodename <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowedCodename<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>SDK_CODENAMES<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Requires development platform "</span> <span class="token operator">+</span> minCode
                                        <span class="token operator">+</span> <span class="token string">" (current platform is any of "</span>
                                        <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>SDK_CODENAMES<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Requires development platform "</span> <span class="token operator">+</span> minCode
                                        <span class="token operator">+</span> <span class="token string">" but this is a release platform."</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_OLDER_SDK<span class="token punctuation">;</span>
                            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>minSdkVersion <span class="token operator">=</span>
                                android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>CUR_DEVELOPMENT<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>minVers <span class="token operator">&gt;</span> SDK_VERSION<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Requires newer sdk version #"</span> <span class="token operator">+</span> minVers
                                <span class="token operator">+</span> <span class="token string">" (current version is #"</span> <span class="token operator">+</span> SDK_VERSION <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
                        mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_OLDER_SDK<span class="token punctuation">;</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>minSdkVersion <span class="token operator">=</span> minVers<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>targetCode <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">boolean</span> allowedCodename <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>String codename <span class="token operator">:</span> SDK_CODENAMES<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>targetCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>codename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                allowedCodename <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowedCodename<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>SDK_CODENAMES<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Requires development platform "</span> <span class="token operator">+</span> targetCode
                                        <span class="token operator">+</span> <span class="token string">" (current platform is any of "</span>
                                        <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>SDK_CODENAMES<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Requires development platform "</span> <span class="token operator">+</span> targetCode
                                        <span class="token operator">+</span> <span class="token string">" but this is a release platform."</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_OLDER_SDK<span class="token punctuation">;</span>
                            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion
                                <span class="token operator">=</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>CUR_DEVELOPMENT<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion <span class="token operator">=</span> targetVers<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_SUPPORT_SCREENS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 解析&lt;supports-screens&gt;标签</span>
                sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestSupportsScreens<span class="token punctuation">)</span><span class="token punctuation">;</span>

                pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>requiresSmallestWidthDp <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestSupportsScreens_requiresSmallestWidthDp<span class="token punctuation">,</span>
                        <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>compatibleWidthLimitDp <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestSupportsScreens_compatibleWidthLimitDp<span class="token punctuation">,</span>
                        <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>largestWidthLimitDp <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestSupportsScreens_largestWidthLimitDp<span class="token punctuation">,</span>
                        <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 和屏幕相关的参数解析，屏幕大小等等！</span>
                supportsSmallScreens <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestSupportsScreens_smallScreens<span class="token punctuation">,</span>
                        supportsSmallScreens<span class="token punctuation">)</span><span class="token punctuation">;</span>
                supportsNormalScreens <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestSupportsScreens_normalScreens<span class="token punctuation">,</span>
                        supportsNormalScreens<span class="token punctuation">)</span><span class="token punctuation">;</span>
                supportsLargeScreens <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestSupportsScreens_largeScreens<span class="token punctuation">,</span>
                        supportsLargeScreens<span class="token punctuation">)</span><span class="token punctuation">;</span>
                supportsXLargeScreens <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestSupportsScreens_xlargeScreens<span class="token punctuation">,</span>
                        supportsXLargeScreens<span class="token punctuation">)</span><span class="token punctuation">;</span>
                resizeable <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestSupportsScreens_resizeable<span class="token punctuation">,</span>
                        resizeable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                anyDensity <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestSupportsScreens_anyDensity<span class="token punctuation">,</span>
                        anyDensity<span class="token punctuation">)</span><span class="token punctuation">;</span>

                sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_PROTECTED_BROADCAST<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;protected-broadcast&gt;标签</span>
                sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestProtectedBroadcast<span class="token punctuation">)</span><span class="token punctuation">;</span>
                String name <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonResourceString</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestProtectedBroadcast_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

                sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>PARSE_IS_SYSTEM<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>protectedBroadcasts <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        pkg<span class="token punctuation">.</span>protectedBroadcasts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pkg<span class="token punctuation">.</span>protectedBroadcasts<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        pkg<span class="token punctuation">.</span>protectedBroadcasts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_INSTRUMENTATION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;instrumentation&gt;标签</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseInstrumentation</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> outError<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_ORIGINAL_PACKAGE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;original-package&gt;标签</span>
                sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestOriginalPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>

                String orig <span class="token operator">=</span>sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestOriginalPackage_name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mOriginalPackages <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        pkg<span class="token punctuation">.</span>mOriginalPackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        pkg<span class="token punctuation">.</span>mRealPackage <span class="token operator">=</span> pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    pkg<span class="token punctuation">.</span>mOriginalPackages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_ADOPT_PERMISSIONS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 解析&lt;adopt-permissions&gt;标签</span>
                sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestOriginalPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>

                String name <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestOriginalPackage_name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mAdoptPermissions <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        pkg<span class="token punctuation">.</span>mAdoptPermissions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    pkg<span class="token punctuation">.</span>mAdoptPermissions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_USES_GL_TEXTURE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Just skip this tag</span>
                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_COMPATIBLE_SCREENS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Just skip this tag</span>
                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_SUPPORTS_INPUT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//</span>
                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_EAT_COMMENT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Just skip this tag</span>
                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_PACKAGE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;package&gt;标签，该标签表示应用的子包！</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>MULTI_PACKAGE_APK_ENABLED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
				<span class="token comment">// 所有的子包都会解析保存到ArrayList&lt;Package&gt;childPackages集合中！</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">parseBaseApkChild</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// If parsing a child failed the error is already set</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_RESTRICT_UPDATE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 解析&lt;restrict-update&gt;标签</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PARSE_IS_SYSTEM_DIR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestRestrictUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> String hash <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
                            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestRestrictUpdate_hash<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    pkg<span class="token punctuation">.</span>restrictUpdateHash <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>hash <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">final</span> <span class="token keyword">int</span> hashLength <span class="token operator">=</span> hash<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hashBytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>hashLength <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hashLength<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                            hashBytes<span class="token punctuation">[</span>i<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Character<span class="token punctuation">.</span><span class="token function">digit</span><span class="token punctuation">(</span>hash<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span>
                                    <span class="token operator">+</span> Character<span class="token punctuation">.</span><span class="token function">digit</span><span class="token punctuation">(</span>hash<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        pkg<span class="token punctuation">.</span>restrictUpdateHash <span class="token operator">=</span> hashBytes<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>RIGID_PARSER<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Bad element under &lt;manifest&gt;: "</span>
                    <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unknown element under &lt;manifest&gt;: "</span> <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">+</span> <span class="token string">" at "</span> <span class="token operator">+</span> mArchiveSourcePath <span class="token operator">+</span> <span class="token string">" "</span>
                        <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>foundApp <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"&lt;manifest&gt; does not contain an &lt;application&gt; or &lt;instrumentation&gt;"</span><span class="token punctuation">;</span>
            mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_EMPTY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> NP <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span>NEW_PERMISSIONS<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        StringBuilder implicitPerms <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ip<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> ip<span class="token operator">&lt;</span>NP<span class="token punctuation">;</span> ip<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>NewPermissionInfo npi
                    <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span>NEW_PERMISSIONS<span class="token punctuation">[</span>ip<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&gt;=</span> npi<span class="token punctuation">.</span>sdkVersion<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pkg<span class="token punctuation">.</span>requestedPermissions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>npi<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>implicitPerms <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    implicitPerms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    implicitPerms<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    implicitPerms<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">": compat added "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    implicitPerms<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                implicitPerms<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>npi<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>requestedPermissions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>npi<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>implicitPerms <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> implicitPerms<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> NS <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span>SPLIT_PERMISSIONS<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> is<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> is<span class="token operator">&lt;</span>NS<span class="token punctuation">;</span> is<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>SplitPermissionInfo spi
                    <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span>SPLIT_PERMISSIONS<span class="token punctuation">[</span>is<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&gt;=</span> spi<span class="token punctuation">.</span>targetSdk
                    <span class="token operator">||</span> <span class="token operator">!</span>pkg<span class="token punctuation">.</span>requestedPermissions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>spi<span class="token punctuation">.</span>rootPerm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> in<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> in<span class="token operator">&lt;</span>spi<span class="token punctuation">.</span>newPerms<span class="token punctuation">.</span>length<span class="token punctuation">;</span> in<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> String perm <span class="token operator">=</span> spi<span class="token punctuation">.</span>newPerms<span class="token punctuation">[</span>in<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pkg<span class="token punctuation">.</span>requestedPermissions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>perm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    pkg<span class="token punctuation">.</span>requestedPermissions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 解析屏幕大小、像素密度相关的属性！</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsSmallScreens <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>supportsSmallScreens <span class="token operator">&gt;</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion
                        <span class="token operator">&gt;=</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>DONUT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_SUPPORTS_SMALL_SCREENS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsNormalScreens <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_SUPPORTS_NORMAL_SCREENS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsLargeScreens <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>supportsLargeScreens <span class="token operator">&gt;</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion
                        <span class="token operator">&gt;=</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>DONUT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_SUPPORTS_LARGE_SCREENS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsXLargeScreens <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>supportsXLargeScreens <span class="token operator">&gt;</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion
                        <span class="token operator">&gt;=</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>GINGERBREAD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_SUPPORTS_XLARGE_SCREENS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resizeable <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>resizeable <span class="token operator">&gt;</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion
                        <span class="token operator">&gt;=</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>DONUT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_RESIZEABLE_FOR_SCREENS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>anyDensity <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>anyDensity <span class="token operator">&gt;</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion
                        <span class="token operator">&gt;=</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>DONUT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_SUPPORTS_SCREEN_DENSITIES<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> pkg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">如果说前面的章节的方法对于清单文件的解析是点到为止的话，那么parseBaseApkCommon方法就会对apk的清单文件AndroidManifest.xml做一个三百六十度全方位无死角的解析，它将会遍历下面的每一个节点，最最核心的就是对于application、overlay、key-sets、permission-group，permisstion，permission-tree，uses-permission等等节点相关的解析。然后在每个节点解析的具体方法里面将解析得到的数据继续填充Package对象实例，直至解析完成所有节点！</font></p> 
<blockquote> 
 <p><font face="Courier New" size="3" color="RED">上述源码中关于各个子节点的详细解析，这里就不一一展开分析了！<br><br>其分析套路基本都是一样，打通了一个节点的解析其它的基本也就一通百通了。在下面的章节中我会分析下解析&lt;application&gt;节点的源码，因为我们最最熟悉的Android四大组件 Activity、Service等都在它之下！</font></p> 
</blockquote> 
<br> 
<h4><a id="font_faceCourier_New210_PackageParserparseBaseApplication_1357"></a><font face="Courier New">2.10 PackageParser.parseBaseApplication()方法</font></h4> 
<p><font face="Courier New">任务是艰巨的，前途是光明的！战役至此，胜利就在前方，我们继续往前冲，冲，冲！</font></p> 
<pre><code class="prism language-java"><span class="token comment">// 【 PackageParser.java 】</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseBaseApplication</span><span class="token punctuation">(</span>Package owner<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span>
            XmlResourceParser parser<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 开始解析&lt;application&gt;标签属性</span>
        
        <span class="token comment">// 获取ApplicationInfo对象ai</span>
        <span class="token keyword">final</span> ApplicationInfo ai <span class="token operator">=</span> owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">;</span>

		<span class="token comment">// 获取包名</span>
        <span class="token keyword">final</span> String pkgName <span class="token operator">=</span> owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
		<span class="token comment">// // 从资源里面获取AndroidManifestApplication的数组 </span>
        TypedArray sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 解析 android:name android:label android:icon android:roundIcon android:logo android:banner 属性！</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">parsePackageItemInfo</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> ai<span class="token punctuation">,</span> outError<span class="token punctuation">,</span>
                <span class="token string">"&lt;application&gt;"</span><span class="token punctuation">,</span> sa<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/*nameRequired*/</span><span class="token punctuation">,</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_name<span class="token punctuation">,</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_label<span class="token punctuation">,</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_icon<span class="token punctuation">,</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_roundIcon<span class="token punctuation">,</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_logo<span class="token punctuation">,</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_banner<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ai<span class="token punctuation">.</span>name <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 如果有设置过Application的名称，则设置为ApplicationInfo的类名</span>
            ai<span class="token punctuation">.</span>className <span class="token operator">=</span> ai<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 在AndroidManifest里面是否设置了android:manageSpaceActivity属性，</span>
		<span class="token comment">// 如果设置了则manageSpaceActivity不为空，没有设置manageSpaceActivity为空</span>
        String manageSpaceActivity <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_manageSpaceActivity<span class="token punctuation">,</span>
                Configuration<span class="token punctuation">.</span>NATIVE_CONFIG_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>manageSpaceActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 如果设置了，则添加类名</span>
            ai<span class="token punctuation">.</span>manageSpaceActivityName <span class="token operator">=</span> <span class="token function">buildClassName</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span> manageSpaceActivity<span class="token punctuation">,</span>
                    outError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 解析android:allowBackup属性，为true表示应用允许备份</span>
        <span class="token keyword">boolean</span> allowBackup <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_allowBackup<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>allowBackup<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 如果为true，设置FLAG_ALLOW_BACKUP标志位</span>
            ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_ALLOW_BACKUP<span class="token punctuation">;</span>

            <span class="token comment">// backupAgent, killAfterRestore, fullBackupContent, backupInForeground,</span>
            <span class="token comment">// and restoreAnyVersion are only relevant if backup is possible for the</span>
            <span class="token comment">// given application.</span>
            <span class="token comment">// 解析android:backupAgent属性！</span>
            String backupAgent <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
                    com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_backupAgent<span class="token punctuation">,</span>
                    Configuration<span class="token punctuation">.</span>NATIVE_CONFIG_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>backupAgent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ai<span class="token punctuation">.</span>backupAgentName <span class="token operator">=</span> <span class="token function">buildClassName</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span> backupAgent<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BACKUP<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"android:backupAgent = "</span> <span class="token operator">+</span> ai<span class="token punctuation">.</span>backupAgentName
                            <span class="token operator">+</span> <span class="token string">" from "</span> <span class="token operator">+</span> pkgName <span class="token operator">+</span> <span class="token string">"+"</span> <span class="token operator">+</span> backupAgent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_killAfterRestore<span class="token punctuation">,</span>
                        <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_KILL_AFTER_RESTORE<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_restoreAnyVersion<span class="token punctuation">,</span>
                        <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_RESTORE_ANY_VERSION<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_fullBackupOnly<span class="token punctuation">,</span>
                        <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_FULL_BACKUP_ONLY<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_backupInForeground<span class="token punctuation">,</span>
                        <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    ai<span class="token punctuation">.</span>privateFlags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_BACKUP_IN_FOREGROUND<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            TypedValue v <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">peekValue</span><span class="token punctuation">(</span>
                    com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_fullBackupContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ai<span class="token punctuation">.</span>fullBackupContent <span class="token operator">=</span> v<span class="token punctuation">.</span>resourceId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BACKUP<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"fullBackupContent specified as boolean="</span> <span class="token operator">+</span>
                            <span class="token punctuation">(</span>v<span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">"false"</span> <span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// "false" =&gt; -1, "true" =&gt; 0</span>
                ai<span class="token punctuation">.</span>fullBackupContent <span class="token operator">=</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_BACKUP<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"fullBackupContent="</span> <span class="token operator">+</span> ai<span class="token punctuation">.</span>fullBackupContent <span class="token operator">+</span> <span class="token string">" for "</span> <span class="token operator">+</span> pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        ai<span class="token punctuation">.</span>theme <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getResourceId</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_theme<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ai<span class="token punctuation">.</span>descriptionRes <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getResourceId</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_description<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>PARSE_IS_SYSTEM<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                    com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_persistent<span class="token punctuation">,</span>
                    <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_PERSISTENT<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_requiredForAllUsers<span class="token punctuation">,</span>
                <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            owner<span class="token punctuation">.</span>mRequiredForAllUsers <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        String restrictedAccountType <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable
                <span class="token punctuation">.</span>AndroidManifestApplication_restrictedAccountType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>restrictedAccountType <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> restrictedAccountType<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            owner<span class="token punctuation">.</span>mRestrictedAccountType <span class="token operator">=</span> restrictedAccountType<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        String requiredAccountType <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable
                <span class="token punctuation">.</span>AndroidManifestApplication_requiredAccountType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredAccountType <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> requiredAccountType<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            owner<span class="token punctuation">.</span>mRequiredAccountType <span class="token operator">=</span> requiredAccountType<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 解析android:debuggable android:vmSafeMode属性！</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_debuggable<span class="token punctuation">,</span>
                <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_DEBUGGABLE<span class="token punctuation">;</span><span class="token comment">//设置可调试</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_vmSafeMode<span class="token punctuation">,</span>
                <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_VM_SAFE_MODE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 解析android:hardwareAccelerated属性！</span>
        owner<span class="token punctuation">.</span>baseHardwareAccelerated <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_hardwareAccelerated<span class="token punctuation">,</span>
                owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>ICE_CREAM_SANDWICH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>owner<span class="token punctuation">.</span>baseHardwareAccelerated<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_HARDWARE_ACCELERATED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_hasCode<span class="token punctuation">,</span>
                <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_HAS_CODE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 解析 android:allowTaskReparenting属性，这个属性很重要，决定了acivity和task的关系</span>
		<span class="token comment">// 在application标签上设置该属性对内部的所有activity生效！</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_allowTaskReparenting<span class="token punctuation">,</span>
                <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_ALLOW_TASK_REPARENTING<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 解析android:allowClearUserData属性！</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_allowClearUserData<span class="token punctuation">,</span>
                <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_ALLOW_CLEAR_USER_DATA<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// The parent package controls installation, hence specify test only installs.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>owner<span class="token punctuation">.</span>parentPackage <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                    com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_testOnly<span class="token punctuation">,</span>
                    <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_TEST_ONLY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 解析android:largeHeap属性！</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_largeHeap<span class="token punctuation">,</span>
                <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_LARGE_HEAP<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_usesCleartextTraffic<span class="token punctuation">,</span>
                <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_USES_CLEARTEXT_TRAFFIC<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_supportsRtl<span class="token punctuation">,</span>
                <span class="token boolean">false</span> <span class="token comment">/* default is no RTL support*/</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_SUPPORTS_RTL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_multiArch<span class="token punctuation">,</span>
                <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_MULTIARCH<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_extractNativeLibs<span class="token punctuation">,</span>
                <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_EXTRACT_NATIVE_LIBS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_defaultToDeviceProtectedStorage<span class="token punctuation">,</span>
                <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ai<span class="token punctuation">.</span>privateFlags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_DEFAULT_TO_DEVICE_PROTECTED_STORAGE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_directBootAware<span class="token punctuation">,</span>
                <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ai<span class="token punctuation">.</span>privateFlags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_DIRECT_BOOT_AWARE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_resizeableActivity<span class="token punctuation">,</span>
                owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ai<span class="token punctuation">.</span>privateFlags <span class="token operator">|=</span> PRIVATE_FLAG_RESIZEABLE_ACTIVITIES<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ai<span class="token punctuation">.</span>networkSecurityConfigRes <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getResourceId</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_networkSecurityConfig<span class="token punctuation">,</span>
                <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String str<span class="token punctuation">;</span>
        str <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_permission<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ai<span class="token punctuation">.</span>permission <span class="token operator">=</span> <span class="token punctuation">(</span>str <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> str<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> str<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>FROYO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            str <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
                    com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_taskAffinity<span class="token punctuation">,</span>
                    Configuration<span class="token punctuation">.</span>NATIVE_CONFIG_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Some older apps have been seen to use a resource reference</span>
            <span class="token comment">// here that on older builds was ignored (with a warning).  We</span>
            <span class="token comment">// need to continue to do this for them so they don't break.</span>
            str <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonResourceString</span><span class="token punctuation">(</span>
                    com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_taskAffinity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ai<span class="token punctuation">.</span>taskAffinity <span class="token operator">=</span> <span class="token function">buildTaskAffinityName</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> ai<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                str<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            CharSequence pname<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>FROYO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                pname <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_process<span class="token punctuation">,</span>
                        Configuration<span class="token punctuation">.</span>NATIVE_CONFIG_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Some older apps have been seen to use a resource reference</span>
                <span class="token comment">// here that on older builds was ignored (with a warning).  We</span>
                <span class="token comment">// need to continue to do this for them so they don't break.</span>
                pname <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonResourceString</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_process<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ai<span class="token punctuation">.</span>processName <span class="token operator">=</span> <span class="token function">buildProcessName</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> null<span class="token punctuation">,</span> pname<span class="token punctuation">,</span>
                    flags<span class="token punctuation">,</span> mSeparateProcesses<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span>

            ai<span class="token punctuation">.</span>enabled <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                    com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_enabled<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                    com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_isGame<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ai<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_IS_GAME<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_cantSaveState<span class="token punctuation">,</span>
                        <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    ai<span class="token punctuation">.</span>privateFlags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_CANT_SAVE_STATE<span class="token punctuation">;</span>

                    <span class="token comment">// A heavy-weight application can not be in a custom process.</span>
                    <span class="token comment">// We can do direct compare because we intern all strings.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ai<span class="token punctuation">.</span>processName <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> ai<span class="token punctuation">.</span>processName <span class="token operator">!=</span> ai<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"cantSaveState applications can not use custom processes"</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        ai<span class="token punctuation">.</span>uiOptions <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestApplication_uiOptions<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 开始解析&lt;application&gt;标签的子标签对应的四大组件</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> innerDepth <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> type<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> innerDepth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>TEXT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            String tagName <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"activity"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;activity&gt;组件</span>
                Activity a <span class="token operator">=</span> <span class="token function">parseActivity</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        owner<span class="token punctuation">.</span>baseHardwareAccelerated<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 详见章节 【 2.11 】</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                owner<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"receiver"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;receiver&gt;组件</span>
                Activity a <span class="token operator">=</span> <span class="token function">parseActivity</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                owner<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"service"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;service&gt;组件</span>
                Service s <span class="token operator">=</span> <span class="token function">parseService</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                owner<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"provider"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 解析&lt;provider&gt;组件</span>
                Provider p <span class="token operator">=</span> <span class="token function">parseProvider</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                owner<span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"activity-alias"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Activity a <span class="token operator">=</span> <span class="token function">parseActivityAlias</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                owner<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"meta-data"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// note: application meta-data is stored off to the side, so it can</span>
                <span class="token comment">// remain null in the primary copy (we like to avoid extra copies because</span>
                <span class="token comment">// it can be large)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>owner<span class="token punctuation">.</span>mAppMetaData <span class="token operator">=</span> <span class="token function">parseMetaData</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> owner<span class="token punctuation">.</span>mAppMetaData<span class="token punctuation">,</span>
                        outError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"library"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestLibrary<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Note: don't allow this value to be a reference to a resource</span>
                <span class="token comment">// that may change.</span>
                String lname <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonResourceString</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestLibrary_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

                sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>lname <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    lname <span class="token operator">=</span> lname<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>owner<span class="token punctuation">.</span>libraryNames<span class="token punctuation">,</span> lname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        owner<span class="token punctuation">.</span>libraryNames <span class="token operator">=</span> ArrayUtils<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>owner<span class="token punctuation">.</span>libraryNames<span class="token punctuation">,</span> lname<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"uses-library"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestUsesLibrary<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Note: don't allow this value to be a reference to a resource</span>
                <span class="token comment">// that may change.</span>
                String lname <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonResourceString</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestUsesLibrary_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> req <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                        com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestUsesLibrary_required<span class="token punctuation">,</span>
                        <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>lname <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    lname <span class="token operator">=</span> lname<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        owner<span class="token punctuation">.</span>usesLibraries <span class="token operator">=</span> ArrayUtils<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>owner<span class="token punctuation">.</span>usesLibraries<span class="token punctuation">,</span> lname<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        owner<span class="token punctuation">.</span>usesOptionalLibraries <span class="token operator">=</span> ArrayUtils<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
                                owner<span class="token punctuation">.</span>usesOptionalLibraries<span class="token punctuation">,</span> lname<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"uses-package"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Dependencies for app installers; we don't currently try to</span>
                <span class="token comment">// enforce this.</span>
                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>RIGID_PARSER<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unknown element under &lt;application&gt;: "</span> <span class="token operator">+</span> tagName
                            <span class="token operator">+</span> <span class="token string">" at "</span> <span class="token operator">+</span> mArchiveSourcePath <span class="token operator">+</span> <span class="token string">" "</span>
                            <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Bad element under &lt;application&gt;: "</span> <span class="token operator">+</span> tagName<span class="token punctuation">;</span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">modifySharedLibrariesForBackwardCompatibility</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasDomainURLs</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>privateFlags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_HAS_DOMAIN_URLS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>privateFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_HAS_DOMAIN_URLS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">上述方法的目的明确诉求简单，只有一个就是各种开撕application节点属性，以及子节点下的所有信息，比如activity、service、receiver、provider、library、users-librayry等信息，同时将解析后的每一个属性生成相应的对象，添加到传入的Package对象实例里面，最后返回给调用者。整体上属于难度不大，但是逻辑繁琐代码冗长。</font></p> 
<blockquote> 
 <p><font face="Courier New" size="3" color="RED">其中各处代码的细节注释，我就偷懒了！读者可以在阅读的时候自行理解，难度不大，属于体力活的范畴！</font></p> 
</blockquote> 
<br> 
<h4><a id="font_faceCourier_New211_PackageParserparseActivity_1806"></a><font face="Courier New">2.11 PackageParser.parseActivity()方法</font></h4> 
<p><font face="Courier New">真的干不动了，肝不动了，这是最后一杯了。</font></p> 
<pre><code class="prism language-java"><span class="token comment">// 【 PackageParser.java 】</span>
	<span class="token keyword">private</span> Activity <span class="token function">parseActivity</span><span class="token punctuation">(</span>Package owner<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span>
	        XmlResourceParser parser<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError<span class="token punctuation">,</span>
	        <span class="token keyword">boolean</span> receiver<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hardwareAccelerated<span class="token punctuation">)</span>
	        <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{<!-- --></span>
	    TypedArray sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token comment">// 解析 android:name android:label android:icon android:roundIcon android:logo android:banner 属性！</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>mParseActivityArgs <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        mParseActivityArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParseComponentArgs</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> outError<span class="token punctuation">,</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_name<span class="token punctuation">,</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_label<span class="token punctuation">,</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_icon<span class="token punctuation">,</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_roundIcon<span class="token punctuation">,</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_logo<span class="token punctuation">,</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_banner<span class="token punctuation">,</span>
	                mSeparateProcesses<span class="token punctuation">,</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_process<span class="token punctuation">,</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_description<span class="token punctuation">,</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 由于 activty 和 receiver 使用的同一个方法，所以需要区分解析的是哪个，此时 receiver 为 false！</span>
	    mParseActivityArgs<span class="token punctuation">.</span>tag <span class="token operator">=</span> receiver <span class="token operator">?</span> <span class="token string">"&lt;receiver&gt;"</span> <span class="token operator">:</span> <span class="token string">"&lt;activity&gt;"</span><span class="token punctuation">;</span>
	    mParseActivityArgs<span class="token punctuation">.</span>sa <span class="token operator">=</span> sa<span class="token punctuation">;</span>
	    mParseActivityArgs<span class="token punctuation">.</span>flags <span class="token operator">=</span> flags<span class="token punctuation">;</span>
	
	    <span class="token comment">//【2】创建了一个 Activity 对象！</span>
	    Activity a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Activity</span><span class="token punctuation">(</span>mParseActivityArgs<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:exported 属性！</span>
	    <span class="token keyword">boolean</span> setExported <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">hasValue</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_exported<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>setExported<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>exported <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_exported<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:theme 属性！</span>
	    a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>theme <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getResourceId</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_theme<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token comment">// 解析 android:uiOptions 属性！</span>
	    a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uiOptions <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_uiOptions<span class="token punctuation">,</span>
	            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uiOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token comment">// 解析 android:parentActivityName 属性！</span>
	    String parentName <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
	            R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_parentActivityName<span class="token punctuation">,</span>
	            Configuration<span class="token punctuation">.</span>NATIVE_CONFIG_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        String parentClassName <span class="token operator">=</span> <span class="token function">buildClassName</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> parentName<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token keyword">if</span> <span class="token punctuation">(</span>outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>parentActivityName <span class="token operator">=</span> parentClassName<span class="token punctuation">;</span>
	        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Activity "</span> <span class="token operator">+</span> a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">" specified invalid parentActivityName "</span> <span class="token operator">+</span>
	                    parentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	            outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:permission 属性！</span>
	    String str<span class="token punctuation">;</span>
	    str <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_permission<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>permission <span class="token operator">=</span> owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>permission<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>permission <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> str<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:taskAffinity 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！！</span>
	    str <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
	            R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_taskAffinity<span class="token punctuation">,</span>
	            Configuration<span class="token punctuation">.</span>NATIVE_CONFIG_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>taskAffinity <span class="token operator">=</span> <span class="token function">buildTaskAffinityName</span><span class="token punctuation">(</span>owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
	            owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>taskAffinity<span class="token punctuation">,</span> str<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	    a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	    <span class="token comment">// 解析 android:multiprocess 属性</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
	            R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_multiprocess<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_MULTIPROCESS<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:finishOnTaskLaunch 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！！</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_finishOnTaskLaunch<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_FINISH_ON_TASK_LAUNCH<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:clearTaskOnLaunch 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_clearTaskOnLaunch<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_CLEAR_TASK_ON_LAUNCH<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:noHistory 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_noHistory<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_NO_HISTORY<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:alwaysRetainTaskState 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_alwaysRetainTaskState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_ALWAYS_RETAIN_TASK_STATE<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:stateNotNeeded 属性</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_stateNotNeeded<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_STATE_NOT_NEEDED<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:excludeFromRecents 属性，不再最近任务显示</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_excludeFromRecents<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_EXCLUDE_FROM_RECENTS<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:allowTaskReparenting 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_allowTaskReparenting<span class="token punctuation">,</span>
	            <span class="token punctuation">(</span>owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_ALLOW_TASK_REPARENTING<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_ALLOW_TASK_REPARENTING<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:finishOnCloseSystemDialogs 属性</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_finishOnCloseSystemDialogs<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_FINISH_ON_CLOSE_SYSTEM_DIALOGS<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:showOnLockScreen 属性</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_showOnLockScreen<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	            <span class="token operator">||</span> sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_showForAllUsers<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_SHOW_FOR_ALL_USERS<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:immersive 属性</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_immersive<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_IMMERSIVE<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 解析 android:systemUserOnly 属性</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_systemUserOnly<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_SYSTEM_USER_ONLY<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// 接下来，对于 activity 和 receiver 解析不同的属性！</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>receiver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        <span class="token comment">// 对于 activity 进入这个！</span>
	        <span class="token comment">// 解析 android:hardwareAccelerated 属性</span>
	        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_hardwareAccelerated<span class="token punctuation">,</span>
	                hardwareAccelerated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_HARDWARE_ACCELERATED<span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
	        <span class="token comment">// 解析 android:launchMode 属性</span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>launchMode <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_launchMode<span class="token punctuation">,</span> ActivityInfo<span class="token punctuation">.</span>LAUNCH_MULTIPLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token comment">// 解析 android:documentLaunchMode 属性</span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>documentLaunchMode <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_documentLaunchMode<span class="token punctuation">,</span>
	                ActivityInfo<span class="token punctuation">.</span>DOCUMENT_LAUNCH_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token comment">// 解析 android:maxRecents 属性</span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>maxRecents <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_maxRecents<span class="token punctuation">,</span>
	                ActivityManager<span class="token punctuation">.</span><span class="token function">getDefaultAppRecentsLimitStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token comment">// 解析 android:configChanges 属性</span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>configChanges <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_configChanges<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token comment">// 解析 android:windowSoftInputMode 属性</span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>softInputMode <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_windowSoftInputMode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token comment">// 解析 android:persistableMode 属性</span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>persistableMode <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_persistableMode<span class="token punctuation">,</span>
	                ActivityInfo<span class="token punctuation">.</span>PERSIST_ROOT_ONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token comment">// 解析 android:allowEmbedded 属性</span>
	        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_allowEmbedded<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_ALLOW_EMBEDDED<span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
	        <span class="token comment">// 解析 android:autoRemoveFromRecents 属性</span>
	        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_autoRemoveFromRecents<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_AUTO_REMOVE_FROM_RECENTS<span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
	        <span class="token comment">// 解析 android:relinquishTaskIdentity 属性</span>
	        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_relinquishTaskIdentity<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_RELINQUISH_TASK_IDENTITY<span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
	        <span class="token comment">// 解析 android:resumeWhilePausing 属性</span>
	        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_resumeWhilePausing<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_RESUME_WHILE_PAUSING<span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
	        <span class="token comment">// 解析 android:screenOrientation 属性</span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>screenOrientation <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_screenOrientation<span class="token punctuation">,</span>
	                SCREEN_ORIENTATION_UNSPECIFIED<span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token comment">// 解析 android:resizeableActivity android:supportsPictureInPicture 属性</span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>resizeMode <span class="token operator">=</span> RESIZE_MODE_UNRESIZEABLE<span class="token punctuation">;</span>
	        <span class="token keyword">final</span> <span class="token keyword">boolean</span> appDefault <span class="token operator">=</span> <span class="token punctuation">(</span>owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>privateFlags
	                <span class="token operator">&amp;</span> PRIVATE_FLAG_RESIZEABLE_ACTIVITIES<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	        <span class="token keyword">final</span> <span class="token keyword">boolean</span> resizeableSetExplicitly
	                <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">hasValue</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_resizeableActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token keyword">final</span> <span class="token keyword">boolean</span> resizeable <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_resizeableActivity<span class="token punctuation">,</span> appDefault<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	        <span class="token keyword">if</span> <span class="token punctuation">(</span>resizeable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_supportsPictureInPicture<span class="token punctuation">,</span>
	                    <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>resizeMode <span class="token operator">=</span> RESIZE_MODE_RESIZEABLE_AND_PIPABLE<span class="token punctuation">;</span>
	            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	                a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>resizeMode <span class="token operator">=</span> RESIZE_MODE_RESIZEABLE<span class="token punctuation">;</span>
	            <span class="token punctuation">}</span>
	        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N
	                <span class="token operator">||</span> resizeableSetExplicitly<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>resizeMode <span class="token operator">=</span> RESIZE_MODE_UNRESIZEABLE<span class="token punctuation">;</span>
	        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>a<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">isFixedOrientation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> FLAG_IMMERSIVE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>resizeMode <span class="token operator">=</span> RESIZE_MODE_FORCE_RESIZEABLE<span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
	        <span class="token comment">// 解析 android:alwaysFocusable 属性</span>
	        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_alwaysFocusable<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> FLAG_ALWAYS_FOCUSABLE<span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
	        <span class="token comment">// 解析 android:lockTaskMode 属性</span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>lockTaskLaunchMode <span class="token operator">=</span>
	                sa<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_lockTaskMode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token comment">// 解析 android:directBootAware 属性</span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>encryptionAware <span class="token operator">=</span> a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>directBootAware <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_directBootAware<span class="token punctuation">,</span>
	                <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token comment">// 解析 android:enableVrMode 属性</span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>requestedVrComponent <span class="token operator">=</span>
	            sa<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_enableVrMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	        <span class="token comment">// 对于 receiver，会进入这里！</span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>launchMode <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>LAUNCH_MULTIPLE<span class="token punctuation">;</span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>configChanges <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	        <span class="token comment">// 解析 android:singleUser 属性</span>
	        <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_singleUser<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_SINGLE_USER<span class="token punctuation">;</span>
	            <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>exported <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PARSE_IS_PRIVILEGED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Activity exported request ignored due to singleUser: "</span>
	                        <span class="token operator">+</span> a<span class="token punctuation">.</span>className <span class="token operator">+</span> <span class="token string">" at "</span> <span class="token operator">+</span> mArchiveSourcePath <span class="token operator">+</span> <span class="token string">" "</span>
	                        <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	                a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>exported <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	                setExported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	            <span class="token punctuation">}</span>
	        <span class="token punctuation">}</span>
	        <span class="token comment">// 解析 android:directBootAware 属性</span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>encryptionAware <span class="token operator">=</span> a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>directBootAware <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
	                R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifestActivity_directBootAware<span class="token punctuation">,</span>
	                <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>directBootAware<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>privateFlags <span class="token operator">|=</span>
	                ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PARTIALLY_DIRECT_BOOT_AWARE<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	
	    sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	    <span class="token comment">// 如果解析的是 receiver，针对 height-weight 类型的进程做处理</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>owner<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>privateFlags
	            <span class="token operator">&amp;</span>ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_CANT_SAVE_STATE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>processName <span class="token operator">==</span> owner<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Heavy-weight applications can not have receivers in main process"</span><span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
	    <span class="token punctuation">}</span>
	
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	
	    <span class="token keyword">int</span> outerDepth <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">int</span> type<span class="token punctuation">;</span>
	    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token operator">=</span>parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT
	           <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_TAG
	                   <span class="token operator">||</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> outerDepth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>TEXT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            <span class="token keyword">continue</span><span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
	
	        <span class="token keyword">if</span> <span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"intent-filter"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 解析 "intent-filter"</span>
	            ActivityIntentInfo intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityIntentInfo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">parseIntent</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
	            <span class="token punctuation">}</span>
	            <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">countActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"No actions in intent filter at "</span>
	                        <span class="token operator">+</span> mArchiveSourcePath <span class="token operator">+</span> <span class="token string">" "</span>
	                        <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	                a<span class="token punctuation">.</span>intents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	            <span class="token punctuation">}</span>
	        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>receiver <span class="token operator">&amp;&amp;</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"preferred"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 解析 "preferred"</span>
	            ActivityIntentInfo intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityIntentInfo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">parseIntent</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
	            <span class="token punctuation">}</span>
	            <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">countActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"No actions in preferred at "</span>
	                        <span class="token operator">+</span> mArchiveSourcePath <span class="token operator">+</span> <span class="token string">" "</span>
	                        <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	                <span class="token keyword">if</span> <span class="token punctuation">(</span>owner<span class="token punctuation">.</span>preferredActivityFilters <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                    owner<span class="token punctuation">.</span>preferredActivityFilters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>ActivityIntentInfo<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	                <span class="token punctuation">}</span>
	                owner<span class="token punctuation">.</span>preferredActivityFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	            <span class="token punctuation">}</span>
	        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"meta-data"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 解析 "meta-data"</span>
	            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>metaData <span class="token operator">=</span> <span class="token function">parseMetaData</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> a<span class="token punctuation">.</span>metaData<span class="token punctuation">,</span>
	                    outError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
	            <span class="token punctuation">}</span>
	        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>receiver <span class="token operator">&amp;&amp;</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"layout"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 解析 "layout"</span>
	            <span class="token function">parseLayout</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>RIGID_PARSER<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Problem in package "</span> <span class="token operator">+</span> mArchiveSourcePath <span class="token operator">+</span> <span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	                <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unknown element under &lt;receiver&gt;: "</span> <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	                            <span class="token operator">+</span> <span class="token string">" at "</span> <span class="token operator">+</span> mArchiveSourcePath <span class="token operator">+</span> <span class="token string">" "</span>
	                            <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unknown element under &lt;activity&gt;: "</span> <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	                            <span class="token operator">+</span> <span class="token string">" at "</span> <span class="token operator">+</span> mArchiveSourcePath <span class="token operator">+</span> <span class="token string">" "</span>
	                            <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	                <span class="token punctuation">}</span>
	                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
	                <span class="token keyword">continue</span><span class="token punctuation">;</span>
	            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	                <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                    outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Bad element under &lt;receiver&gt;: "</span> <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	                    outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Bad element under &lt;activity&gt;: "</span> <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	                <span class="token punctuation">}</span>
	                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
	            <span class="token punctuation">}</span>
	        <span class="token punctuation">}</span>
	    <span class="token punctuation">}</span>
	
	    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>setExported<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	        a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>exported <span class="token operator">=</span> a<span class="token punctuation">.</span>intents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	
	    <span class="token keyword">return</span> a<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">上述源码无它，唯有解析其标签属性和子标签而已！</font></p> 
<br> 
<h4><a id="font_faceCourier_New212_PackageParserparseMonolithicPackage_2140"></a><font face="Courier New">2.12 PackageParser.parseMonolithicPackage()方法</font></h4> 
<blockquote> 
 <p><font face="Courier New" size="3" color="RED">分析支持，读者估计心里有一个声音了我是谁，我在那里的恍惚感觉了。还是让我们来捋一捋，还记的在章节2.1中parsePackage中我们分了两步走:<br> 1.对于支持拆分的安装包走parseClusterPackage的分支逻辑<br><br> 2.对于不支持拆分的安装包走parseMonolithicPackage的逻辑分支</font></p> 
</blockquote> 
<p><font face="Courier New">前面的一系列章节重点分析了支持拆分的安装包的解析处理逻辑，而对于对于不支持apk拆分的安装包，PKMS采取了向下兼容的怀柔政策，通过使用PackageParser.parseMonolithicPackage进行解析，而Android系统中最最典型的不支持拆分的apk就是是 /system/framework/framework-res.apk，下面我们来看看这个方法：</font></p> 
<pre><code class="prism language-java"><span class="token comment">// 【 PackageParser.java ] </span>
    <span class="token annotation punctuation">@Deprecated</span>
    <span class="token comment">/*
    	接卸单个且不支持拆分的APK安装文件
    *、
    public Package parseMonolithicPackage(File apkFile, int flags) throws PackageParserException {
    	//   解析指定单个APK文件，获取PackageLite实例对象
        final PackageLite lite = parseMonolithicPackageLite(apkFile, flags); // 详见章节 【 2.13 】
        if (mOnlyPowerOffAlarmApps) {
			...
        }
        if (!mOnlyPowerOffAlarmApps &amp;&amp; mOnlyCoreApps) {
			...
        }

        final AssetManager assets = new AssetManager();
        try {
			// 解析Android包得到完整的Android包信息，注意是完整的包信息
            final Package pkg = parseBaseApk(apkFile, assets, flags);// 详见章节 【 2.7 】
            pkg.setCodePath(apkFile.getAbsolutePath());
            pkg.setUse32bitAbi(lite.use32bitAbi);
            return pkg;
        } finally {
            IoUtils.closeQuietly(assets);
        }
    }
</span></code></pre> 
<p><font face="Courier New">此处的处理逻辑和前面的支持拆分安装包的解析逻辑基本相同:</font></p> 
<ul><li> <p><font face="Courier New">首先调用方法parseMonolithicPackageLite先得到一个中间数据结构<strong>PacakgeLite</strong>，最终Android的包名、版本等信息都会保存在这个数据结构中(此处PacakgeLite就不存在有多个ApkLite的可能，因为当前解析的是单个不支持拆分的安装包)</font></p> </li><li> <p><font face="Courier New">然后接着调用<strong>PackageParser.parseBaseApk</strong>进行下一步的Android包处理逻辑，这个方法主要用来详细解析AndroidManifest.xml文件。其解析过程与<strong>AndroidManifest.xml</strong>的文件结构一一对应，譬如先解析&lt;application&gt;标签的内容，然后解析其下的&lt;activity&gt;,&lt;service&gt;等标签。最终将上述得到的解析信息封装成Package、此时I的Package中就基本上涵盖了AndroidManifest.xml中涉及的所有信息。</font></p> </li></ul> 
<br> 
<h4><a id="font_faceCourier_New213_PackageParserparseMonolithicPackageLite_2189"></a><font face="Courier New">2.13 PackageParser.parseMonolithicPackageLite()方法</font></h4> 
<p><font face="Courier New">果然没有玩出啥新花样，都是对前面已经分析过的源码的重新组装。</font></p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> PackageLite <span class="token function">parseMonolithicPackageLite</span><span class="token punctuation">(</span>File packageFile<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{<!-- --></span>
       	<span class="token comment">// 解析指定APK文件，获取Apk轻量级精简数据结构类实例</span>
        <span class="token keyword">final</span> ApkLite baseApk <span class="token operator">=</span> <span class="token function">parseApkLite</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 详见章节 【 2. 4 】</span>
        <span class="token keyword">final</span> String packagePath <span class="token operator">=</span> packageFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 根据得到的ApkLite信息填充返回PackageLite</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PackageLite</span><span class="token punctuation">(</span>packagePath<span class="token punctuation">,</span> baseApk<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p><font face="Courier New">收工，打卡下班</font></p> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_NewPackageParserAndroid_2217"></a><font face="Courier New">三.PackageParser解析Android包总结</font></h3> 
<p><font face="Courier New">  分析至此我们的PackageParser核心方法剖析就到此结束了！而我们也通过上述的方法将Android包的各种配件烹饪成了美味可口的Android包了，然后我们的PKMS服务就可以对上述的Android包进行下一步的加工了。</font></p> 
<p><font face="Courier New">虽然整个流程分析结束了，但是我们还是有必要再来回过头来重新看下，还记得我们最最开始梳理的简单解析伪代码图吗：</font></p> 
<pre><code class="prism language-bash">parsePackages<span class="token punctuation">(</span>File file<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
└── parseClusterPackage<span class="token punctuation">(</span>File packageDir<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    └── parseClusterPackageLite<span class="token punctuation">(</span>File packageDir<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    <span class="token operator">|</span>   └── parseApkLite<span class="token punctuation">(</span>File apkFile<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    <span class="token operator">|</span>       └── parseApkLite<span class="token punctuation">(</span>String codePath<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    └── parseBaseApk<span class="token punctuation">(</span><span class="token punctuation">)</span>
        └── parseBaseApplication<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">|</span>    └── parseActivity<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">|</span>    └── parseService<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">|</span>    └── <span class="token punctuation">..</span>.
        └── parseInstrumentation<span class="token punctuation">(</span><span class="token punctuation">)</span>
        └── <span class="token punctuation">..</span>.
└── parseMonolithicPackage<span class="token punctuation">(</span>File apkFile<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    └── parseMonolithicPackageLite<span class="token punctuation">(</span>File packageFile<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    <span class="token operator">|</span>   └── parseApkLite<span class="token punctuation">(</span>File apkFile<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    <span class="token operator">|</span>       └── parseApkLite<span class="token punctuation">(</span>String codePath<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
    └── parseBaseApk<span class="token punctuation">(</span><span class="token punctuation">)</span>
        └── parseBaseApplication<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">|</span>    └── parseActivity<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">|</span>    └── parseService<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">|</span>    └── <span class="token punctuation">..</span>.
        └── parseInstrumentation<span class="token punctuation">(</span><span class="token punctuation">)</span>
        └── <span class="token punctuation">..</span>.	
</code></pre> 
<p><font face="Courier New">对于上述逻辑，无论是解析支持拆分安装包还是不支持拆分类型的安装包，其核心的处理过程都不变那就是:</font></p> 
<ul><li><font face="Courier New">PackageParser首先解析出了ApkLite，得到每个Apk文件的简化信息（对于具有多个Apk文件的Package来说，将得到多个ApkLite）；</font></li><li><font face="Courier New">然后利用所有的ApkLite及XML中的其它信息，解析出PackageLite；</font></li><li><font face="Courier New">最后利用PackageLite中的信息(主要是通过它验证安装包的合法性)及XML中的其它信息，最终解析得出Package信息，从而得到一个全的Android包的信息数据结构类为后续的PKMS进一步处理打下基础</font></li></ul> 
<p><font face="Courier New">一个Android包的信息解析完了，那么我们有没有什么直观的手段可以查看呢！既然问了，那就肯定是有了，这里给大家安利一个好用的dumpsys命令，可以提供给大家查阅安装包的解析后的具体信息，这个命令的终极格式如下:</font></p> 
<pre><code class="prism language-bash">dumpsys package packagename
</code></pre> 
<p><font face="Courier New">我们来测试一下(由于篇幅，我精简了许多，输入的内容有上千行，非常详细):</font></p> 
<pre><code class="prism language-bash">dumpsys package com.android.settings
Activity Resolver Table:
  Full MIME Types:
	<span class="token punctuation">..</span>.

  Base MIME Types:
	<span class="token punctuation">..</span>.

  Schemes:
	<span class="token punctuation">..</span>.

  Non-Data Actions:
	<span class="token punctuation">..</span>.

Receiver Resolver Table:
  Schemes:
	<span class="token punctuation">..</span>.

  Non-Data Actions:
	<span class="token punctuation">..</span>.

Service Resolver Table:
  Non-Data Actions:
	<span class="token punctuation">..</span>.

Provider Resolver Table:
  Non-Data Actions:
	<span class="token punctuation">..</span>.

Registered ContentProviders:
	<span class="token punctuation">..</span>.

ContentProvider Authorities:
	<span class="token punctuation">..</span>.

Key Set Manager:
  <span class="token punctuation">[</span>com.android.settings<span class="token punctuation">]</span>
      Signing KeySets: 1

Packages:
  Package <span class="token punctuation">[</span>com.android.settings<span class="token punctuation">]</span> <span class="token punctuation">(</span>642f3ee<span class="token punctuation">)</span>:
    userId<span class="token operator">=</span>1000
    sharedUser<span class="token operator">=</span>SharedUserSetting<span class="token punctuation">{<!-- --></span>bfb509d android.uid.system/1000<span class="token punctuation">}</span>
    pkg<span class="token operator">=</span>Package<span class="token punctuation">{<!-- --></span>2802702 com.android.settings<span class="token punctuation">}</span>
    codePath<span class="token operator">=</span>/system/priv-app/XXXSettings
    resourcePath<span class="token operator">=</span>/system/priv-app/XXXSettings
    legacyNativeLibraryDir<span class="token operator">=</span>/system/priv-app/XXXSettings/lib
    primaryCpuAbi<span class="token operator">=</span>armeabi-v7a
    secondaryCpuAbi<span class="token operator">=</span>null
    versionCode<span class="token operator">=</span>25 minSdk<span class="token operator">=</span>25 targetSdk<span class="token operator">=</span>25
    versionName<span class="token operator">=</span>7.1.2
    splits<span class="token operator">=</span><span class="token punctuation">[</span>base<span class="token punctuation">]</span>
    apkSigningVersion<span class="token operator">=</span>2
    applicationInfo<span class="token operator">=</span>ApplicationInfo<span class="token punctuation">{<!-- --></span>947e04d com.android.settings<span class="token punctuation">}</span>
    flags<span class="token operator">=</span><span class="token punctuation">[</span> SYSTEM HAS_CODE PERSISTENT ALLOW_CLEAR_USER_DATA <span class="token punctuation">]</span>
    privateFlags<span class="token operator">=</span><span class="token punctuation">[</span> PRIVILEGED DEFAULT_TO_DEVICE_PROTECTED_STORAGE DIRECT_BOOT_AWARE RESIZEABLE_ACTIVITIES <span class="token punctuation">]</span>
    dataDir<span class="token operator">=</span>/data/user_de/0/com.android.settings
    supportsScreens<span class="token operator">=</span><span class="token punctuation">[</span>small, medium, large, xlarge, resizeable, anyDensity<span class="token punctuation">]</span>
    timeStamp<span class="token operator">=</span>2009-01-01 00:00:00
    firstInstallTime<span class="token operator">=</span>2009-01-01 00:00:00
    lastUpdateTime<span class="token operator">=</span>2009-01-01 00:00:00
    signatures<span class="token operator">=</span>PackageSignatures<span class="token punctuation">{<!-- --></span>9ff6813 <span class="token punctuation">[</span>b4addb29<span class="token punctuation">]</span><span class="token punctuation">}</span>
    installPermissionsFixed<span class="token operator">=</span>true installStatus<span class="token operator">=</span>1
    pkgFlags<span class="token operator">=</span><span class="token punctuation">[</span> SYSTEM HAS_CODE PERSISTENT ALLOW_CLEAR_USER_DATA <span class="token punctuation">]</span>
    requested permissions:
      android.permission.WRITE_MEDIA_STORAGE
	  <span class="token punctuation">..</span>.

Shared users:
  SharedUser <span class="token punctuation">[</span>android.uid.system<span class="token punctuation">]</span> <span class="token punctuation">(</span>bfb509d<span class="token punctuation">)</span>:
    userId<span class="token operator">=</span>1000
    <span class="token function">install</span> permissions:
      android.permission.BIND_INCALL_SERVICE: granted<span class="token operator">=</span>true
	  <span class="token punctuation">..</span>.


Dexopt state:
  <span class="token punctuation">[</span>com.android.settings<span class="token punctuation">]</span>
    Instruction Set: arm
      path: /system/priv-app/XXXSettings/XXXSettings.apk
      status: /data/dalvik-cache/arm/system@priv-app@XXXSettings@XXXSettings.apk@classes.dex <span class="token punctuation">[</span>compilation_filter<span class="token operator">=</span>speed, 
      status<span class="token operator">=</span>kOatUpToDate<span class="token punctuation">]</span>


Compiler stats:
  <span class="token punctuation">[</span>com.android.settings<span class="token punctuation">]</span>
    <span class="token punctuation">(</span>No recorded stats<span class="token punctuation">)</span>

</code></pre> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_New_2365"></a><font face="Courier New">四.写在最后</font></h3> 
<p><font face="Courier New">  说不出再见，到这里<a href="https://blog.csdn.net/tkwxty/article/details/114137504">Android包信息体和包解析器(上/中/下)</a>系列博客终于要落下帷幕了，这三篇博客我们重点分析了:</font></p> 
<ul><li> <p><font face="Courier New">包管理机制设计者如何从架构层出发设计Android包信息体</font></p> </li><li> <p><font face="Courier New">然后从实际源码角度出发，分析了包信息体的具体设计实现</font></p> </li><li> <p><font face="Courier New">接着从包管理机制设计者意图了解PackageParser包解析器，即它的概述和定义是什么</font></p> </li><li> <p><font face="Courier New">再接着PackageParser包解析器作为一个工具类,它的核心成员变量是什么(当然是和包信息体的封装有关)</font></p> </li><li> <p><font face="Courier New">最后PackageParser包解析器作为一个工具类,它的核心方法有那些(核心方法就是解析Android包)</font></p> </li></ul> 
<p><font face="Courier New">最终我们关于Android包解析的大法就修炼完毕，此时我们再回过头来看下面的类图也许真的就是手到擒来了！</font></p> 
<blockquote> 
 <p><img src="https://images2.imgbox.com/01/1a/8r4yfLo9_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<blockquote> 
 <p><font face="Courier New" size="3" color="RED">并且这里我大费周章的在PKMS启动系列博客中，单独的将Android包解析独立出来三篇都是为l了后续分析PKMS扫描安装包而做的准备的，只有理解了Android包数据结构存储，解析才能对后续的PKMS分析更加得心应手！</font></p> 
</blockquote> 
<p><font face="Courier New">好了，各位青山不改绿水长流，各位江湖见！当然各位读者的点赞和关注是我写作路上前进的最大动力了，如果有啥不对或者不爽的也可以踩一踩也无妨！在后续博客中我们将会继续分析PKMS启动扫描流程阶段，如果读者喜欢欢迎继续关注！如果读者对于此系列博客PKMS有兴趣，欢迎继续下一篇章<a href="https://blog.csdn.net/tkwxty/article/details/114964303">PKMS启动详解(七)之BOOT_PROGRESS_PMS_SYSTEM_SCAN_START阶段流程分析</a>之旅，让我带领读者一起扫描系统应用安装目录之旅！</font></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f27a7343fe3604e32b391c9d3fb60f2a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">UniApp：IOS篇：通用链接【Universal Links】配置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/686421b00c7ce575d72f9cb68abcfc5e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Application.persistentDataPath 的一个小坑</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>