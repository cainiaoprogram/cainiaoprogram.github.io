<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>开启OCSP提升HTTPS速度 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="开启OCSP提升HTTPS速度" />
<meta property="og:description" content="背景：根据客服对用户信息的反馈，部分IOS启动app很慢甚至超时，而安卓并无异常。
排查步骤 1.查看nginx的错误日志和服务端的处理日志，并没有发现异常超时的记录；2.通过还原用户使用场景，用户发送请求到服务器接收到请求，产生了6-10s的延迟，这个直接导致ios 触发原定的3s超时；3.了解到用户并非出于网络较差环境，或者使用科学上网，于是将问题定位到https验证；4.因为ios为了促进app审查，使用了https来与服务器通信，而安卓则是跳过验证，这点坐实了https验证的问题。 解决思路 1.检查https证书是否过期，发现各项证书均在有效期内；
2.通过ssllab.com测试域名的各项指标，发现TLS只支持到v1.0-v1.2，v1.3并无支持，而v1.3在验证速度上比历史版本块，其中原因v1.3引入以下特性，速度有很大提升：
相比过去的的版本，引入了新的密钥协商机制 — PSK支持 0-RTT 数据传输，在建立连接时节省了往返时间废弃了 3DES、RC4、AES-CBC 等加密组件，废弃了 SHA1、MD5 等哈希算法ServerHello 之后的所有握手消息采取了加密操作，可见明文大大减少不再允许对加密报文进行压缩、不再允许双方发起重协商DSA 证书不再允许在 TLS 1.3 中使用 3.开启OCSP(Online Certificate Status Protocal), 在nginx的server{}配置中增加以下配置
ssl_stapling on;ssl_stapling_verify on;ssl_trusted_certificate /etc/letsencrypt/live/xxx.xxx.com/fullchain.pem;resolver 8.8.8.8 8.8.4.4 1.1.1.1 valid=60s;resolver_timeout 2s;
然后重启nginx，在ssllab.com验证，OCSP stapling YES。 4.之后验证https速度和http差不多了" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/256b89647a02485b1a055269ceeef4ad/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-14T12:17:25+08:00" />
<meta property="article:modified_time" content="2020-04-14T12:17:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">开启OCSP提升HTTPS速度</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>背景：根据客服对用户信息的反馈，部分IOS启动app很慢甚至超时，而安卓并无异常。</p> 
</blockquote> 
<h4><a id="_2"></a>排查步骤</h4> 
<ul><li>1.查看nginx的错误日志和服务端的处理日志，并没有发现异常超时的记录；</li><li>2.通过还原用户使用场景，用户发送请求到服务器接收到请求，产生了6-10s的延迟，这个直接导致ios 触发原定的3s超时；</li><li>3.了解到用户并非出于网络较差环境，或者使用科学上网，于是将问题定位到https验证；</li><li>4.因为ios为了促进app审查，使用了https来与服务器通信，而安卓则是跳过验证，这点坐实了https验证的问题。</li></ul> 
<h4><a id="_8"></a>解决思路</h4> 
<ul><li> <p>1.检查https证书是否过期，发现各项证书均在有效期内；</p> </li><li> <p>2.通过ssllab.com测试域名的各项指标，发现TLS只支持到v1.0-v1.2，v1.3并无支持，而v1.3在验证速度上比历史版本块，其中原因v1.3引入以下特性，速度有很大提升：</p> 
  <ul><li>相比过去的的版本，引入了新的密钥协商机制 — PSK</li><li>支持 0-RTT 数据传输，在建立连接时节省了往返时间</li><li>废弃了 3DES、RC4、AES-CBC 等加密组件，废弃了 SHA1、MD5 等哈希算法</li><li>ServerHello 之后的所有握手消息采取了加密操作，可见明文大大减少</li><li>不再允许对加密报文进行压缩、不再允许双方发起重协商</li><li>DSA 证书不再允许在 TLS 1.3 中使用</li></ul> </li><li> <p>3.开启OCSP(Online Certificate Status Protocal), 在nginx的server{}配置中增加以下配置</p> 
  <ul><li>ssl_stapling on;</li><li>ssl_stapling_verify on;</li><li>ssl_trusted_certificate /etc/letsencrypt/live/xxx.xxx.com/fullchain.pem;</li><li>resolver 8.8.8.8 8.8.4.4 1.1.1.1 valid=60s;</li><li>resolver_timeout 2s;<br> 然后重启nginx，在ssllab.com验证，OCSP stapling YES。</li></ul> </li><li> <p>4.之后验证https速度和http差不多了</p> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1411900a10c325d1275ed9414612b2c0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JS如何找数组中的最大值</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7cae22f5d09bca62a73538875ef4a30f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">微信小程序监听全局变量的变化</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>