<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring Cloud Config - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Spring Cloud Config" />
<meta property="og:description" content="文章目录 概述搭建 Spring Cloud Config Server创建 Git 仓库引入依赖配置文件ConfigServerApplicationHTTP 接口 使用 Spring Cloud Config Client引入依赖配置文件OrderPropertiesDemoControllerUserApplication 多环境配置修改 Git 仓库 Spring Cloud Config采用Git存储时两种常用的配置策略自动配置刷新使用/actuator/refresh 接口：搭建 Spring Cloud Config Server搭建 Spring Cloud Config Client引入依赖配置文件@RefreshScope 基于 Spring Cloud Bus 实现搭建 Spring Cloud Config Server引入依赖配置文件 搭建 Spring Cloud Config Client引入依赖配置文件@RefreshScope 基于监听器LoggingRebinderDemoEnvironmentChangeListener 配置加密搭建 Spring Cloud Config Server安装 JCE配置文件EncryptionController 搭建 Spring Cloud Config Client非对称加密 与注册中心集成Spring Cloud Config ServerSpring Cloud Config Client 概述 Spring Cloud Config 是由 Spring Cloud 官方推出，基于 Spring Cloud 体系的配置中心。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e43a722247138879a6c8771f31661996/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-10T00:23:21+08:00" />
<meta property="article:modified_time" content="2022-04-10T00:23:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring Cloud Config</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_9" rel="nofollow">概述</a></li><li><a href="#_Spring_Cloud_Config_Server_24" rel="nofollow">搭建 Spring Cloud Config Server</a></li><li><ul><li><a href="#_Git__26" rel="nofollow">创建 Git 仓库</a></li><li><a href="#_34" rel="nofollow">引入依赖</a></li><li><a href="#_85" rel="nofollow">配置文件</a></li><li><a href="#ConfigServerApplication_120" rel="nofollow">ConfigServerApplication</a></li><li><a href="#HTTP__134" rel="nofollow">HTTP 接口</a></li></ul> 
  </li><li><a href="#_Spring_Cloud_Config_Client_185" rel="nofollow">使用 Spring Cloud Config Client</a></li><li><ul><li><a href="#_187" rel="nofollow">引入依赖</a></li><li><a href="#_233" rel="nofollow">配置文件</a></li><li><a href="#OrderProperties_267" rel="nofollow">OrderProperties</a></li><li><a href="#DemoController_300" rel="nofollow">DemoController</a></li><li><a href="#UserApplication_333" rel="nofollow">UserApplication</a></li></ul> 
  </li><li><a href="#_373" rel="nofollow">多环境配置</a></li><li><ul><li><a href="#_Git__378" rel="nofollow">修改 Git 仓库</a></li></ul> 
  </li><li><a href="#Spring_Cloud_ConfigGit_421" rel="nofollow">Spring Cloud Config采用Git存储时两种常用的配置策略</a></li><li><a href="#_446" rel="nofollow">自动配置刷新</a></li><li><ul><li><a href="#actuatorrefresh__452" rel="nofollow">使用/actuator/refresh 接口：</a></li><li><ul><li><a href="#_Spring_Cloud_Config_Server_455" rel="nofollow">搭建 Spring Cloud Config Server</a></li><li><a href="#_Spring_Cloud_Config_Client_457" rel="nofollow">搭建 Spring Cloud Config Client</a></li><li><ul><li><a href="#_459" rel="nofollow">引入依赖</a></li><li><a href="#_471" rel="nofollow">配置文件</a></li><li><a href="#RefreshScope_485" rel="nofollow">@RefreshScope</a></li></ul> 
   </li></ul> 
   </li><li><a href="#__Spring_Cloud_Bus__561" rel="nofollow">基于 Spring Cloud Bus 实现</a></li><li><ul><li><a href="#_Spring_Cloud_Config_Server_576" rel="nofollow">搭建 Spring Cloud Config Server</a></li><li><ul><li><a href="#_578" rel="nofollow">引入依赖</a></li><li><a href="#_594" rel="nofollow">配置文件</a></li></ul> 
    </li><li><a href="#_Spring_Cloud_Config_Client_626" rel="nofollow">搭建 Spring Cloud Config Client</a></li><li><ul><li><a href="#_629" rel="nofollow">引入依赖</a></li><li><a href="#_638" rel="nofollow">配置文件</a></li><li><a href="#RefreshScope_651" rel="nofollow">@RefreshScope</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_735" rel="nofollow">基于监听器</a></li><li><ul><li><ul><li><a href="#LoggingRebinder_744" rel="nofollow">LoggingRebinder</a></li><li><a href="#DemoEnvironmentChangeListener_780" rel="nofollow">DemoEnvironmentChangeListener</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_817" rel="nofollow">配置加密</a></li><li><ul><li><a href="#_Spring_Cloud_Config_Server_826" rel="nofollow">搭建 Spring Cloud Config Server</a></li><li><ul><li><a href="#_JCE_828" rel="nofollow">安装 JCE</a></li><li><a href="#_838" rel="nofollow">配置文件</a></li><li><a href="#EncryptionController_854" rel="nofollow">EncryptionController</a></li></ul> 
    </li><li><a href="#_Spring_Cloud_Config_Client_860" rel="nofollow">搭建 Spring Cloud Config Client</a></li><li><a href="#_891" rel="nofollow">非对称加密</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_948" rel="nofollow">与注册中心集成</a></li><li><ul><li><a href="#Spring_Cloud_Config_Server_952" rel="nofollow">Spring Cloud Config Server</a></li><li><a href="#Spring_Cloud_Config_Client_992" rel="nofollow">Spring Cloud Config Client</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_9"></a>概述</h2> 
<p>Spring Cloud Config 是由 Spring Cloud 官方推出，基于 Spring Cloud 体系的配置中心。</p> 
<p>相比 Nacos、Apollo 等其它配置中心来说，Spring Cloud Config 是一个<strong>轻量级</strong>的配置中心，和 Spring Cloud 的集成度会更好，不过功能上会薄弱一些。例如说，灰度发布、运维界面、配置回滚等等。因此，还是推荐使用 Apollo 或者 Nacos 嘿嘿~</p> 
<p>Spring Cloud Config 整体架构如下图所示：<br> <img src="https://images2.imgbox.com/98/0f/AeU7JQiR_o.png" alt="在这里插入图片描述"></p> 
<p>一共分成 Spring Cloud Config <strong>Client</strong> 和 <strong>Server</strong> 两个角色：</p> 
<ul><li><strong>Spring Cloud Config Server</strong> 支持从 <strong>Git、数据库、本地文件等多种存储器中，读取数据作为配置，并提供 HTTP API 给 Spring Cloud Config Client 使用。</strong></li><li><strong>Spring Cloud Config Client</strong> 在项目启动时，<strong>从 Spring Cloud Config Server 中读取到配置，并缓存在本地使用。</strong></li></ul> 
<p><strong>快速入门图片:</strong> <img src="https://images2.imgbox.com/c1/f6/mxBaW4a2_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_Spring_Cloud_Config_Server_24"></a>搭建 Spring Cloud Config Server</h2> 
<p>创建 <code>sc-config-server-git</code> 项目，搭建的使用 <code>Git</code> 作为存储器的 Spring Cloud Config <strong>Server</strong>。</p> 
<h3><a id="_Git__26"></a>创建 Git 仓库</h3> 
<p>① 创建一个 Git 仓库 <code>demo-config-server</code> ，作为 Spring Cloud Config Server 的 Git 存储器。如下图所示：<code>demo-config-server</code><br> <img src="https://images2.imgbox.com/4c/47/5BM2RaE5_o.png" alt="图片: https://uploader.shimo.im/f/pahpGqOKxFbH2jrl.png!thumbnail?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJhdWQiOiJhY2Nlc3NfcmVzb3VyY2UiLCJleHAiOjE2NDk0MjUwMzYsImciOiJnWHFtZVJQRXdyaXo1bXFvIiwiaWF0IjoxNjQ5NDI0NzM2LCJ1c2VySWQiOjc0OTQ1MzI3fQ.FqM-PqOwv3-NU6TqTghQewLjiASlRs1HUId--Xj53JQ"></p> 
<p>② 在仓库下，创建 <code>user-application.yml</code> 配置文件，如下图所示：<br> <code>user-application.yml</code> <img src="https://images2.imgbox.com/dd/d6/K6nFykt9_o.png" alt="在这里插入图片描述"></p> 
<p>稍后，我们创建的用户服务 <code>user-application</code>，就会通过 <code>Spring Cloud Config Server</code> 提供的 <code>HTTP</code> 接口，读取到 <code>user-application.yml</code> 配置文件的配置。<strong>注意，这里名字要对应上 。</strong></p> 
<h3><a id="_34"></a>引入依赖</h3> 
<p>首先在 <strong>pom.xml</strong> 文件中，引入 Spring Cloud Config Server 依赖如下：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sc-config-server-git<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.boot.version</span><span class="token punctuation">&gt;</span></span>2.2.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.boot.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.cloud.version</span><span class="token punctuation">&gt;</span></span>Hoxton.SR1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.cloud.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--
        引入 Spring Boot、Spring Cloud、Spring Cloud Alibaba 三者 BOM 文件，进行依赖版本的管理，防止不兼容。
        在 https://dwz.cn/mcLIfNKt 文章中，Spring Cloud Alibaba 开发团队推荐了三者的依赖关系
     --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.boot.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 引入 Spring Cloud Config Server 相关依赖，实现配置中心的服务端，并实现对其的自动配置 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-config-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>通过 spring-cloud-config-server 依赖，引入 Spring Cloud Config Server 相关依赖，实现配置中心的服务端，并实现对其的自动配置。</p> 
<h3><a id="_85"></a>配置文件</h3> 
<p>创建 <strong>application.yml</strong> 配置文件，引入 Spring Cloud Config Server 相关配置项。配置内容如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>config<span class="token punctuation">-</span>server
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> git <span class="token comment"># 使用的 Spring Cloud Config Server 的存储器方案</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token comment"># Spring Cloud Config Server 的 Git 存储器的配置项，对应 MultipleJGitEnvironmentProperties 类</span>
        <span class="token key atrule">git</span><span class="token punctuation">:</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//gitee.com/zhutongbing/demo<span class="token punctuation">-</span>config<span class="token punctuation">-</span>server.git <span class="token comment"># Git 仓库地址</span>
          <span class="token key atrule">search-paths</span><span class="token punctuation">:</span> / <span class="token comment"># 读取文件的根地址</span>
          <span class="token key atrule">default-label</span><span class="token punctuation">:</span> master <span class="token comment"># 使用的默认分支，默认为 master</span>
<span class="token comment">#          username: ${CODING_USERNAME} # 账号</span>
<span class="token comment">#          password: ${CODING_PASSWORD} # 密码</span>
          <span class="token key atrule">username</span><span class="token punctuation">:</span> gitee仓库的账号 <span class="token comment"># 账号</span>
          <span class="token key atrule">password</span><span class="token punctuation">:</span> gitee仓库的密码 <span class="token comment"># 密码</span>
<span class="token comment">#          force-pull: true #强制pull， 默认为false</span>
</code></pre> 
<p>① 设置 <code>spring.profiles.active </code>配置项为<code> git</code>，设置使用的 Spring Cloud Config Server 的存储器方案为 Git。Spring Cloud Config Server 是基于 <code>spring.profiles.active</code> 配置项来选择使用的存储器方案，如下图所示：<strong>EnvironmentRepositoryConfiguration 配置类</strong> <img src="https://images2.imgbox.com/ef/58/2HfIjFK4_o.png" alt="在这里插入图片描述"></p> 
<p>② <code>spring.cloud.config.server </code>为 Spring Cloud Config Server 的配置项，对应 <code>ConfigServerProperties </code>类。一般情况下，默认配置即可，因此本示例也是如此。<br> ③ <code>spring.cloud.config.server.git</code> 为 Spring Cloud Config Server 的 Git 存储器的配置项，对应 <code>MultipleJGitEnvironmentProperties</code> 类。</p> 
<ul><li><code>uri</code>：<strong>配置文件所在的 Git 仓库地址</strong>。</li><li><code>search-paths</code>：<strong>配置文件所在的根目录。</strong></li><li><code>default-label</code>：<strong>使用的默认分支，默认为 master</strong>。在 Spring Cloud Config Client 读取 Spring Cloud Config Server 的配置时，如果 Client 未传递 label 请求参数，则默认读取 Server 设置的 default-label 默认分支。</li><li><code>username</code> 和 <code>password</code> 为<strong>账号密码</strong>，有需要的时候配置。</li></ul> 
<h3><a id="ConfigServerApplication_120"></a>ConfigServerApplication</h3> 
<p>创建 <code>ConfigServerApplication</code> 类，作为 Spring Cloud Config Server 的启动类。代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableConfigServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigServerApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ConfigServerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过 <code>@EnableConfigServer</code> 注解，声明启动 Spring Cloud Config Server。</p> 
<h3><a id="HTTP__134"></a>HTTP 接口</h3> 
<p>Spring Cloud Config Server 的<code>EnvironmentController</code>类，提供了读取配置的 HTTP API 接口。简化代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/{name}/{profiles:.*[^-].*}"</span><span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_JSON_VALUE<span class="token punctuation">)</span>
 
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/{name}-{profiles}.properties"</span><span class="token punctuation">)</span>
 
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/{label}/{name}-{profiles}.properties"</span><span class="token punctuation">)</span>
 
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"{name}-{profiles}.json"</span><span class="token punctuation">)</span>
 
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/{label}/{name}-{profiles}.json"</span><span class="token punctuation">)</span>
 
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token string">"/{name}-{profiles}.yml"</span><span class="token punctuation">,</span> <span class="token string">"/{name}-{profiles}.yaml"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
 
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token string">"/{label}/{name}-{profiles}.yml"</span><span class="token punctuation">,</span> <span class="token string">"/{label}/{name}-{profiles}.yaml"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>每一个API实际是由三个参数的组合排列：</strong><br> ① <code>{name}</code>：<strong>配置文件的名字</strong>。Spring Cloud Config Client 默认约定，使用应用名 <code>spring.application.name</code> 读取对应的配置文件。</p> 
<p>例如说，对于应用名<code> spring.application.name</code> 为 <code>user-application</code> 时，会从 Spring Cloud Config Server 读取 <code>user-application.yaml</code> 等配置文件。<br> ② <code>{profiles}</code>：<strong>配置文件的 Profile，一般用于解决不同环境下的配置文件</strong>。Spring Cloud Config Client 默认约定，使用 <code>spring.profiles.active</code> 读取对应的 <code>Profile </code>配置文件。</p> 
<p>例如说，在 <code>spring.profiles.active</code> 为 dev 时，会从 Spring Cloud Config Server 读取 <code>user-application-dev.yaml </code>等配置文件。<strong>当然，不带有 Profile 的 user-application.yaml 配置文件也会被读取。</strong></p> 
<p>③<code> {label}</code>：<strong>标签</strong>。在使用 Spring Cloud Config Server 使用 Git 作为存储器时，<code>{label} </code>对应的是<strong>分支。</strong></p> 
<p><strong>下面，我们来进行下 HTTP API 的简单使用：</strong><br> ① 使用 ConfigServerApplication 类，启动 Spring Cloud Config Server。启动日志如下：</p> 
<pre><code class="prism language-java"><span class="token comment">// ... 省略部分非关键</span>

<span class="token comment">// 使用 Git 存储器</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">20.435</span>  INFO <span class="token number">15428</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">sc<span class="token punctuation">.</span></span>ConfigServerApplication</span>               <span class="token operator">:</span> <span class="token class-name">The</span> following profiles are active<span class="token operator">:</span> git

<span class="token comment">// 服务的端口为 8888</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">25.127</span>  INFO <span class="token number">15428</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>b<span class="token punctuation">.</span>w<span class="token punctuation">.</span>embedded<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span></span>TomcatWebServer</span>  <span class="token operator">:</span> <span class="token class-name">Tomcat</span> started on <span class="token function">port</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">8888</span> <span class="token punctuation">(</span>http<span class="token punctuation">)</span> <span class="token keyword">with</span> <span class="token namespace">context</span> path ''
</code></pre> 
<p><strong>访问 http://127.0.0.1:8888/user-application.yaml 地址，获得名字为 user-application 的配置文件，结果如下：</strong> <img src="https://images2.imgbox.com/e4/be/dWRCBp9h_o.png" alt="在这里插入图片描述"></p> 
<p><strong>另外，控制台可以看到 Spring Cloud Config Server 从 Git 拉取配置的日志如下：</strong></p> 
<pre><code class="prism language-java"><span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">49.527</span>  INFO <span class="token number">15428</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8888</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>e<span class="token punctuation">.</span></span>NativeEnvironmentRepository</span>  <span class="token operator">:</span> <span class="token class-name">Adding</span> property source<span class="token operator">:</span> file<span class="token operator">:</span><span class="token operator">/</span><span class="token class-name">C</span><span class="token operator">:</span><span class="token operator">/</span><span class="token class-name">Users</span><span class="token operator">/</span>TONGBI<span class="token operator">~</span><span class="token number">1</span><span class="token operator">/</span><span class="token class-name">AppData</span><span class="token operator">/</span><span class="token class-name">Local</span><span class="token operator">/</span><span class="token class-name">Temp</span><span class="token operator">/</span>config<span class="token operator">-</span>repo<span class="token operator">-</span><span class="token number">22506244931764226</span><span class="token operator">/</span>user<span class="token operator">-</span>application<span class="token punctuation">.</span>yml
</code></pre> 
<h2><a id="_Spring_Cloud_Config_Client_185"></a>使用 Spring Cloud Config Client</h2> 
<p>创建 <code>sc-config-user-application</code> 项目，使用 Spring Cloud Config <strong>Client</strong> 从 Spring Cloud Config <strong>Server</strong> 读取配置，并使用 <code>@ConfigurationProperties </code>和 <code>@Value</code> 注解来进一步读取对应的配置。</p> 
<h3><a id="_187"></a>引入依赖</h3> 
<p>在 pom.xml 文件中，引入 Spring Cloud Config Client 依赖如下：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.boot.version</span><span class="token punctuation">&gt;</span></span>2.2.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.boot.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.cloud.version</span><span class="token punctuation">&gt;</span></span>Hoxton.SR1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.cloud.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--
    引入 Spring Boot、Spring Cloud、Spring Cloud Alibaba 三者 BOM 文件，进行依赖版本的管理，防止不兼容。
    在 https://dwz.cn/mcLIfNKt 文章中，Spring Cloud Alibaba 开发团队推荐了三者的依赖关系
 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.boot.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 引入 SpringMVC 相关依赖，并实现对其的自动配置 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 引入 Spring Cloud Config Client 相关依赖，作为配置中心的客户端，并实现自动化配置 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="_233"></a>配置文件</h3> 
<p>创建 <code>bootstrap.yml </code>配置文件，引入 Spring Cloud Config <strong>Client</strong> 相关配置项。配置内容如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>application
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token comment"># Spring Cloud Config Client 配置项，对应 ConfigClientProperties 类</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">8888</span> <span class="token comment"># Spring Cloud Config Server 的地址</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span> <span class="token comment"># 读取的配置文件的名字，默认为 ${spring.application.name}</span>
</code></pre> 
<p><code>spring.cloud.config </code>为 Spring Cloud Config <strong>Client</strong> 的配置项，对应 <code>ConfigServerProperties</code> 类。</p> 
<ul><li><code>uri</code>：Spring Cloud Config <strong>Server</strong> 的地址。</li><li><code>name</code>：<strong>读取的配置文件的名字</strong>，默认为 <code>${spring.application.name}</code>。通过该默认值，实现了 Spring Cloud Config Client 的默认约定的读取。</li></ul> 
<blockquote> 
 <p>为什么要将 Spring Cloud Config Client 的配置项添加到 bootstrap.yaml 配置文件，而不像我们之前一样操作，添加到 application.yaml 配置文件中呢？</p> 
</blockquote> 
<p>在 Spring Cloud 应用中，会先创建一个 <code>Bootstrap Context</code>（<strong>引导</strong>上下文），比 Spring Boot 创建 <code>Application Context</code>（<strong>应用</strong>上下文）<strong>更早初始化</strong>。</p> 
<p>Bootstrap Context <strong>新增</strong>了一个 <code>bootstrap.yaml </code><strong>配置文件</strong>，保证和 Application Context 的 <code>application.yaml</code> <strong>配置文件的隔离</strong>。</p> 
<p>有了配置文件的隔离之后，Bootstrap Context 初始化的 <code>Bean</code> 从哪里来？Spring Cloud 新定义了专属于 Bootstrap Context 的自动化配置类的拓展点 <code>BootstrapConfiguration</code>，和 Spring Boot 为 Application Context 的自动化配置类的拓展点 <code>EnableAutoConfiguration</code>的隔离，保证两个 Context 创建各自的 Bean。以 Spring Cloud Alibaba Nacos 的 spring.factories 举例子，如下图所示：<img src="https://images2.imgbox.com/44/57/0hvKfhuP_o.png" alt="在这里插入图片描述"><br> Bootstrap Context 和 Application Context 做了这么多隔离，但是它们有一点是共享的，那就是 <code>Environment</code>。在 Spring 中，我们通过 Environment 获取属性配置，例如说 <code>spring.application.name </code>对应的值是多少。</p> 
<p>了解完这些之后，我们把它们串联在一起去思考一下，Bootstrap Context 的<strong>目的</strong>究竟是什么呢？通过 Bootstrap Context 的优先初始化，<strong>将配置加载到 Environment 中</strong>，提供给后面的 Application Context 使用。</p> 
<blockquote> 
 <p>举个贼重要的例子，稍后我们会在 bootstrap.yaml 添加 Spring Cloud Alibaba Nacos Config相关的配置，这样 Bootstrap Context 在初始化时，通过 NacosConfigBootstrapConfiguration 创建 Nacos 相关的 Bean，然后实现从 Nacos 配置中心加载配置到 Environment 中。</p> 
 <p>如果我们把 Spring Cloud Alibaba Nacos Config 相关的配置添加在 application.yaml中，那么可能无法保证 Nacos 相关的 Bean 被最先初始化，完成从 Nacos 获取配置，从而影响创建的 Bean。</p> 
</blockquote> 
<h3><a id="OrderProperties_267"></a>OrderProperties</h3> 
<p><strong>创建 OrderProperties 配置类，读取 order 配置项。代码如下：</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"order"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderProperties</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 订单支付超时时长，单位：秒。
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> payTimeoutSeconds<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 订单创建频率，单位：秒
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> createFrequencySeconds<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getPayTimeoutSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> payTimeoutSeconds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPayTimeoutSeconds</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> payTimeoutSeconds<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>payTimeoutSeconds <span class="token operator">=</span> payTimeoutSeconds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getCreateFrequencySeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> createFrequencySeconds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCreateFrequencySeconds</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> createFrequencySeconds<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>createFrequencySeconds <span class="token operator">=</span> createFrequencySeconds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>在类上，添加 <code>@Component </code>注解，保证该配置类可以作为一个 Bean 被扫描到。</li><li>在类上，添加 <code>@ConfigurationProperties</code> 注解，并设置<code>prefix = "order"</code>属性，这样它<strong>就可以读取前缀为 order 配置项，设置到配置类对应的属性上</strong>。</li></ul> 
<h3><a id="DemoController_300"></a>DemoController</h3> 
<p>创建 DemoController 类，提供测试 <code>@ConfigurationProperties</code> 和 <code>@Value </code>注入配置的两个 HTTP 接口。代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/demo"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderProperties</span> orderProperties<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 测试 @ConfigurationProperties 注解的配置属性类
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test01"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">OrderProperties</span> <span class="token function">test01</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> orderProperties<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"${order.pay-timeout-seconds}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> payTimeoutSeconds<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"${order.create-frequency-seconds}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> createFrequencySeconds<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 测试 @Value 注解的属性
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test02"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">test02</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"payTimeoutSeconds"</span><span class="token punctuation">,</span> payTimeoutSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"createFrequencySeconds"</span><span class="token punctuation">,</span> createFrequencySeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="UserApplication_333"></a>UserApplication</h3> 
<p>创建 UserApplication 类，作为应用启动类。代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">UserApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>测试</p> 
</blockquote> 
<p>① 使用 ConfigServerApplication 类，启动 Spring Cloud Config Server。<br> ② 使用 UserApplication 类，启动用户服务。在 IDEA 控制台中，可以看到 Spring Cloud Config Client 相关的日志如下：</p> 
<pre><code class="prism language-java"><span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">07.991</span>  INFO <span class="token number">6680</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>ConfigServicePropertySourceLocator</span> <span class="token operator">:</span> <span class="token class-name">Fetching</span> config from server at <span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8888</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">12.983</span>  INFO <span class="token number">6680</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>ConfigServicePropertySourceLocator</span> <span class="token operator">:</span> <span class="token class-name">Located</span> environment<span class="token operator">:</span> name<span class="token operator">=</span>user<span class="token operator">-</span>application<span class="token punctuation">,</span> profiles<span class="token operator">=</span><span class="token punctuation">[</span><span class="token keyword">default</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> version<span class="token operator">=</span><span class="token number">9579</span>cb8462b328fe0c509aeb42a7b726d9369de8<span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token keyword">null</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">12.983</span>  INFO <span class="token number">6680</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">b<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>PropertySourceBootstrapConfiguration</span> <span class="token operator">:</span> <span class="token class-name">Located</span> property source<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token class-name">BootstrapPropertySource</span> <span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span>'bootstrapProperties<span class="token operator">-</span>configClient'<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">BootstrapPropertySource</span> <span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span>'bootstrapProperties<span class="token operator">-</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>zhutongbing<span class="token operator">/</span>demo<span class="token operator">-</span>config<span class="token operator">-</span>server<span class="token punctuation">.</span>git<span class="token operator">/</span>user<span class="token operator">-</span>application<span class="token punctuation">.</span>yml'<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre> 
<p>③ 使用浏览器，访问 http://127.0.0.1:8080/demo/test01 接口，测试 <code>@ConfigurationProperties </code>注解的配置属性类，返回结果如下，符合预期：</p> 
<pre><code class="prism language-java"><span class="token punctuation">{<!-- --></span>
<span class="token string">"payTimeoutSeconds"</span><span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
<span class="token string">"createFrequencySeconds"</span><span class="token operator">:</span> <span class="token number">120</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>④ 使用浏览器，访问 http://127.0.0.1:8080/demo/test02 接口，测试<code> @Value</code>n 注解的属性，返回结果如下，符合预期：</p> 
<pre><code class="prism language-java"><span class="token punctuation">{<!-- --></span>
<span class="token string">"payTimeoutSeconds"</span><span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
<span class="token string">"createFrequencySeconds"</span><span class="token operator">:</span> <span class="token number">120</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_373"></a>多环境配置</h2> 
<p>通过 Spring Cloud Config <strong>Server</strong> 提供的 <code>{profiles} </code>参数，我们可以读取不同环境对应的 <code>{name}-{profiles}.yml</code> 配置文件。</p> 
<p>同时，在我们给项目设定 <code>spring.profiles.active </code>配置项后，Spring Cloud Config Client 会按照约定，以该配置项作为 <code>{profiles}</code> 参数，自动从 Spring Cloud Config <strong>Server</strong> 读取对应的 <code>{name}-{profiles}.yml </code>配置文件。<br> <font color="red">不过也要注意，Spring Cloud Config <strong>Client</strong> 还是会读取 <strong>{name}.yml</strong> 配置文件哈！</font></p> 
<h3><a id="_Git__378"></a>修改 Git 仓库</h3> 
<p>修改 Git 仓库，增加用户服务<code>user-application</code>的 <code>dev</code> 环境对应的 user-<code>application-dev.yml</code> 配置文件，和<code>prod</code>环境对应的<code>user-application-prod.yml</code>配置文件。<img src="https://images2.imgbox.com/dc/32/xA7mrOEX_o.png" alt=""><br> prod环境的与上述的一样：<strong>server.port=8084</strong></p> 
<blockquote> 
 <p>简单测试</p> 
</blockquote> 
<p>① 使用 ConfigServerApplication 类，启动 Spring Cloud Config Server。<br> 下面，我们使用命令行参数进行 <code>--spring.profiles.active </code>配置项，实现不同环境，读取不同配置文件。<br> ② <strong>开发环境</strong>示例：直接在 IDEA 中，增加<code>--spring.profiles.active=dev</code>到 Program arguments 中。如下图所示：<br> <img src="https://images2.imgbox.com/00/0c/HUmUv6VZ_o.png" alt="在这里插入图片描述"></p> 
<p>使用 <strong>UserApplication</strong> 应用，输出日志如下：</p> 
<pre><code class="prism language-java"># 省略其它日志<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
#  <span class="token class-name">Spring</span> <span class="token class-name">Cloud</span> <span class="token class-name">Config</span> 日志
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">21.635</span>  INFO <span class="token number">16716</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>ConfigServicePropertySourceLocator</span> <span class="token operator">:</span> <span class="token class-name">Fetching</span> config from server at <span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8888</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">23.276</span>  INFO <span class="token number">16716</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>ConfigServicePropertySourceLocator</span> <span class="token operator">:</span> <span class="token class-name">Located</span> environment<span class="token operator">:</span> name<span class="token operator">=</span>user<span class="token operator">-</span>application<span class="token punctuation">,</span> profiles<span class="token operator">=</span><span class="token punctuation">[</span>dev<span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> version<span class="token operator">=</span><span class="token number">079727</span>c63f8cc0be6935406c109f56da6091c1af<span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token keyword">null</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">23.276</span>  INFO <span class="token number">16716</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">b<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>PropertySourceBootstrapConfiguration</span> <span class="token operator">:</span> <span class="token class-name">Located</span> property source<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token class-name">BootstrapPropertySource</span> <span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span>'bootstrapProperties<span class="token operator">-</span>configClient'<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">BootstrapPropertySource</span> <span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span>'bootstrapProperties<span class="token operator">-</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>zhutongbing<span class="token operator">/</span>demo<span class="token operator">-</span>config<span class="token operator">-</span>server<span class="token punctuation">.</span>git<span class="token operator">/</span>user<span class="token operator">-</span>application<span class="token operator">-</span>dev<span class="token punctuation">.</span>yml'<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">BootstrapPropertySource</span> <span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span>'bootstrapProperties<span class="token operator">-</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>zhutongbing<span class="token operator">/</span>demo<span class="token operator">-</span>config<span class="token operator">-</span>server<span class="token punctuation">.</span>git<span class="token operator">/</span>user<span class="token operator">-</span>application<span class="token punctuation">.</span>yml'<span class="token punctuation">}</span><span class="token punctuation">]</span>

#<span class="token class-name">Tomcat</span>日志
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">25.258</span>  INFO <span class="token number">16716</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>b<span class="token punctuation">.</span>w<span class="token punctuation">.</span>embedded<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span></span>TomcatWebServer</span>  <span class="token operator">:</span> <span class="token class-name">Tomcat</span> initialized <span class="token keyword">with</span> <span class="token namespace">port</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">8082</span> <span class="token punctuation">(</span>http<span class="token punctuation">)</span>
</code></pre> 
<p>通过看到 Spring Cloud Config 日志，<strong>不仅仅读取了 user-application-dev.yml 配置文件，也读取了 user-application.yml。并且，前者的优先级高于后者。</strong><br> 同时，Tomcat 启动在 8082 端口，也符合读取 dev 环境读取 user-application-dev.yml 配置文件。<br> ③ 生产环境示例:<code>--spring.profiles.active=prod</code></p> 
<pre><code class="prism language-java"><span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">40.107</span>  INFO <span class="token number">3168</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>ConfigServicePropertySourceLocator</span> <span class="token operator">:</span> <span class="token class-name">Fetching</span> config from server at <span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8888</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">40.998</span>  INFO <span class="token number">3168</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>ConfigServicePropertySourceLocator</span> <span class="token operator">:</span> <span class="token class-name">Located</span> environment<span class="token operator">:</span> name<span class="token operator">=</span>user<span class="token operator">-</span>application<span class="token punctuation">,</span> profiles<span class="token operator">=</span><span class="token punctuation">[</span>prod<span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> version<span class="token operator">=</span><span class="token number">079727</span>c63f8cc0be6935406c109f56da6091c1af<span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token keyword">null</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">40.998</span>  INFO <span class="token number">3168</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">b<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>PropertySourceBootstrapConfiguration</span> <span class="token operator">:</span> <span class="token class-name">Located</span> property source<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token class-name">BootstrapPropertySource</span> <span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span>'bootstrapProperties<span class="token operator">-</span>configClient'<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">BootstrapPropertySource</span> <span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span>'bootstrapProperties<span class="token operator">-</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>zhutongbing<span class="token operator">/</span>demo<span class="token operator">-</span>config<span class="token operator">-</span>server<span class="token punctuation">.</span>git<span class="token operator">/</span>user<span class="token operator">-</span>application<span class="token operator">-</span>prod<span class="token punctuation">.</span>yml'<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">BootstrapPropertySource</span> <span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span>'bootstrapProperties<span class="token operator">-</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>zhutongbing<span class="token operator">/</span>demo<span class="token operator">-</span>config<span class="token operator">-</span>server<span class="token punctuation">.</span>git<span class="token operator">/</span>user<span class="token operator">-</span>application<span class="token punctuation">.</span>yml'<span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">41.013</span>  INFO <span class="token number">3168</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">sc<span class="token punctuation">.</span></span>UserApplication</span>                       <span class="token operator">:</span> <span class="token class-name">The</span> following profiles are active<span class="token operator">:</span> prod
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">41.560</span>  INFO <span class="token number">3168</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>context<span class="token punctuation">.</span>scope<span class="token punctuation">.</span></span>GenericScope</span>     <span class="token operator">:</span> <span class="token class-name">BeanFactory</span> id<span class="token operator">=</span><span class="token number">23</span>ec2cc1<span class="token operator">-</span>f7aa<span class="token operator">-</span><span class="token number">38</span>a3<span class="token operator">-</span>b80f<span class="token operator">-</span>e9d58b821699
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">42.029</span>  INFO <span class="token number">3168</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>b<span class="token punctuation">.</span>w<span class="token punctuation">.</span>embedded<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span></span>TomcatWebServer</span>  <span class="token operator">:</span> <span class="token class-name">Tomcat</span> initialized <span class="token keyword">with</span> <span class="token namespace">port</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">8084</span> <span class="token punctuation">(</span>http<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/17/4c/pbd36zp3_o.png" alt="在这里插入图片描述"><br> 因为 Spring Cloud Config Server 在使用 Git 作为存储器时，支持使用 <code>&lt;label&gt; </code>来选择不同的 <strong>Git 分支</strong>。所以，我们也可以选择给不同的环境，创建不同的 Git 分支。</p> 
<p>这样，我们就可以利用上 Git 分支提供的权限功能，让开发直接使用和修改 dev 对应的开发环境的分支，然后在没有问题之后，提供 Pull Request 到 prod 对应的生产环境的分支，进行审核和上线。如此，实现不同环境的配置的权限管理。</p> 
<h2><a id="Spring_Cloud_ConfigGit_421"></a>Spring Cloud Config采用Git存储时两种常用的配置策略</h2> 
<p><strong>第一种：多个项目公用一个Git仓库，用不同的目录区分项目</strong><br> 主要的配置项如下：</p> 
<pre><code class="prism language-yaml">spring.cloud.config.server.git.uri=https<span class="token punctuation">:</span>//github.com/dyc87112/config<span class="token punctuation">-</span>repo.git
spring.cloud.config.server.git.search<span class="token punctuation">-</span>paths=/<span class="token punctuation">{<!-- --></span>application<span class="token punctuation">}</span>
</code></pre> 
<p>这种模式下<strong>不同的项目会对应到<code>https://github.com/dyc87112/config-repo.git</code>仓库下的不同目录</strong>，如果项目中s<code>pring.application.name=user-service</code>，那么它的配置仓库会定位到<code>https://github.com/dyc87112/config-repo.git</code>仓库下的<code>/user-service</code><strong>目录</strong>。配置文件按<code>application-{profile}.properties</code>的格式存储，<code>{profile}</code>代表环境名。</p> 
<p><strong>优缺点分析</strong>：因为只使用一个Git库存储，所以当配置是由专人统一维护的时候比较方便。但是如果要做DevOps的话，权限控制上将变的非常的弱。</p> 
<p><strong>第二种：多个项目使用多个不同Git仓库</strong><br> 主要的配置项如下：</p> 
<pre><code class="prism language-java">spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>git<span class="token punctuation">.</span>uri<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>dyc87112<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>application<span class="token punctuation">}</span><span class="token punctuation">.</span>git
</code></pre> 
<p>这种模式下<strong>不同的项目会对应的不同的Git仓库</strong>，如果项目中<code>spring.application.name=user-service</code>，那么它的配置仓库会定位到<code>https://github.com/dyc87112/user-service.git</code>仓库下的配置。配置文件按<code>application-{profile}.properties</code>的格式存储，<code>{profile}</code>代表<strong>环境名</strong>。</p> 
<p><strong>优缺点分析</strong>：由于一个项目就有一个对应的存储配置的Git仓库，所以这种模式对于DevOps的应用支持较好，如果使用Gitlab作为Git服务端的话，还有不错的界面和权限管理来方便项目所属者使用和维护。如果团队不是DevOps模式管理的话，专人管理就会遇到有N多Git仓库要维护的困境。</p> 
<h2><a id="_446"></a>自动配置刷新</h2> 
<p>在项目启动时，Spring Cloud Config Client 从 Spring Cloud Config Server 读取到配置时，考虑到后续的访问效率，是将配置缓存在<strong>本地内存</strong>中。也就是说，后续我们使用到的配置，都是直接访问内存中的配置，无需重复去 Spring Cloud Config Server 读取。</p> 
<p>这样，就导致后续如果 Spring Cloud Config Server 配置发生变化时，项目是无法及时更新，即无法<strong>自动配置刷新</strong>！</p> 
<p>解决这个问题的方案有很多种，我们先来看第一种，<strong>直接使用 Spring Cloud Config Client 的 /actuator/refresh 接口，让 Spring Cloud Config Client 重新去 Spring Cloud Config Server 读取配置，从而刷新本地缓存。</strong></p> 
<h3><a id="actuatorrefresh__452"></a>使用/actuator/refresh 接口：</h3> 
<p>最终项目如下图：<img src="https://images2.imgbox.com/c8/6d/HlifsMsU_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_Spring_Cloud_Config_Server_455"></a>搭建 Spring Cloud Config Server</h4> 
<p>直接使用<code>sc-config-server-git</code> 项目即可。</p> 
<h4><a id="_Spring_Cloud_Config_Client_457"></a>搭建 Spring Cloud Config Client</h4> 
<p>从<code>sc-config-user-application </code>项目，复制出 <code>sc-config-user-application-auto-refresh-by-actuator </code>项目来使用 <strong>Spring Cloud Config Client</strong>。</p> 
<h5><a id="_459"></a>引入依赖</h5> 
<p>在 pom.xml 文件中，额外引入 Spring Boot Actuator 相关依赖。新增如下：</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 实现对 Actuator 的自动化配置 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>稍后调用的 <code>/actuator/refresh</code> 接口，是基于 <code>Actuator </code>做的拓展 <code>RefreshEndpoint </code>提供的。</p> 
<h5><a id="_471"></a>配置文件</h5> 
<p>创建 <code>application.yml</code> 配置文件，额外增加 Spring Boot Actuator 配置项。配置如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token comment"># Actuator HTTP 配置项，对应 WebEndpointProperties 配置类</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> refresh <span class="token comment"># 需要开放的端点。默认值只打开 health 和 info 两个端点。通过设置 * ，可以开放所有端点。</span>
</code></pre> 
<p>设置<code> management.endpoints.web.exposure.include</code> 为<code> refresh</code>，将 <code>/actuator/refresh</code> 接口开放出来。</p> 
<h5><a id="RefreshScope_485"></a>@RefreshScope</h5> 
<p>在 Spring Cloud 中，提供了<code>@RefreshScope</code>注解，可以声明在 <code>Bean</code> 上，<strong>实现该 Bean 的配置刷新。</strong></p> 
<p>将 <code>@RefreshScope </code>注解添加在 DemoController 类上，<strong>实现 @Value 注解的属性的刷新。</strong><br> <font color="red">注意，不加 @RefreshScope 注解的情况下，使用 @ConfigurationProperties 注解的属性，依然可以配置刷新。</font></p> 
<blockquote> 
 <p>简单测试</p> 
</blockquote> 
<p>① 使用 ConfigServerApplication 类，启动 Spring Cloud Config Server。使用 UserApplication 类，启动用户服务。<br> 使用 <code>curl </code>命令，请求 DemoController 提供的两个测试接口，获得当前的配置。过程如下：</p> 
<pre><code class="prism language-java"># 测试 `<span class="token annotation punctuation">@ConfigurationProperties</span>` 注解的配置属性类
$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>demo<span class="token operator">/</span>test01
<span class="token punctuation">{<!-- --></span><span class="token string">"payTimeoutSeconds"</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token string">"createFrequencySeconds"</span><span class="token operator">:</span><span class="token number">240</span><span class="token punctuation">}</span>
# 测试 `<span class="token annotation punctuation">@Value</span>` 注解的属性
$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>demo<span class="token operator">/</span>test02
<span class="token punctuation">{<!-- --></span><span class="token string">"createFrequencySeconds"</span><span class="token operator">:</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token string">"payTimeoutSeconds"</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">}</span>
</code></pre> 
<p>② 将 <code>Git</code> 中的<code>user-application.yml</code>配置文件，将<code>order.create-frequency-seconds</code>配置项修改成 480，并 Push 到 Git 仓库。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">order</span><span class="token punctuation">:</span>
  <span class="token key atrule">pay-timeout-seconds</span><span class="token punctuation">:</span> <span class="token number">60</span> <span class="token comment"># 订单支付超时时长，单位：秒。</span>
  <span class="token key atrule">create-frequency-seconds</span><span class="token punctuation">:</span> <span class="token number">480</span> <span class="token comment"># 订单创建频率，单位：秒</span>

</code></pre> 
<p>使用 <strong>curl</strong> 命令，请求 DemoController 提供的两个测试接口， 获取当前的配置</p> 
<pre><code class="prism language-java"># 测试 `<span class="token annotation punctuation">@ConfigurationProperties</span>` 注解的配置属性类
$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>demo<span class="token operator">/</span>test01
<span class="token punctuation">{<!-- --></span><span class="token string">"payTimeoutSeconds"</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token string">"createFrequencySeconds"</span><span class="token operator">:</span><span class="token number">240</span><span class="token punctuation">}</span>

# 测试 `<span class="token annotation punctuation">@Value</span>` 注解的属性
$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>demo<span class="token operator">/</span>test02
<span class="token punctuation">{<!-- --></span><span class="token string">"createFrequencySeconds"</span><span class="token operator">:</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token string">"payTimeoutSeconds"</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">}</span>

</code></pre> 
<p>发现配置没有变，<strong>因为我们没有通知 Spring Cloud Config Client 配置变化，重新去 Spring Cloud Config Server 重新拉取。</strong><br> ③ 使用 Postman 模拟 POST 请求用户服务的 <strong>http://127.0.0.1:8080/actuator/refresh</strong> 地址，通知用户刷新配置，<strong>触发 Spring Cloud Config Client 从 Spring Cloud Config Server 重新拉取配置</strong>。返回结果如下：</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>
    <span class="token string">"config.client.version"</span><span class="token punctuation">,</span>
    <span class="token string">"order.create-frequency-seconds"</span>
<span class="token punctuation">]</span>
</code></pre> 
<ul><li>返回结果是一个<strong>数组</strong>，<strong>告诉我们变化的配置项有哪些</strong>。这里，可以看到我们刚修改的 <code>"order.create-frequency-seconds"</code> 配置项，符合预期。</li></ul> 
<p>同时，在 IDEA 控制台看到用户服务的日志，可以发现从 Spring Cloud Config Server 重新读取了配置内容：</p> 
<pre><code class="prism language-java"><span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">19.337</span>  INFO <span class="token number">60921</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>ConfigServicePropertySourceLocator</span> <span class="token operator">:</span> <span class="token class-name">Fetching</span> config from server at <span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8888</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">21.506</span>  INFO <span class="token number">60921</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>ConfigServicePropertySourceLocator</span> <span class="token operator">:</span> <span class="token class-name">Located</span> environment<span class="token operator">:</span> name<span class="token operator">=</span>user<span class="token operator">-</span>application<span class="token punctuation">,</span> profiles<span class="token operator">=</span><span class="token punctuation">[</span><span class="token keyword">default</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> version<span class="token operator">=</span>c262a44be148d3dc2bfb4191f0bc18a22f7a67d5<span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token keyword">null</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">21.507</span>  INFO <span class="token number">60921</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">b<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>PropertySourceBootstrapConfiguration</span> <span class="token operator">:</span> <span class="token class-name">Located</span> property source<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token class-name">BootstrapPropertySource</span> <span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span>'bootstrapProperties<span class="token operator">-</span>configClient'<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">BootstrapPropertySource</span> <span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span>'bootstrapProperties<span class="token operator">-</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token class-name">YunaiV</span><span class="token operator">/</span>demo<span class="token operator">-</span>config<span class="token operator">-</span>server<span class="token punctuation">.</span>git<span class="token operator">/</span>user<span class="token operator">-</span>application<span class="token punctuation">.</span>yml'<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre> 
<p>使用 curl 命令，请求 DemoController 提供的两个测试接口，获得当前的配置。过程如下</p> 
<pre><code class="prism language-java"># 测试 `<span class="token annotation punctuation">@ConfigurationProperties</span>` 注解的配置属性类
$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>demo<span class="token operator">/</span>test01
<span class="token punctuation">{<!-- --></span><span class="token string">"payTimeoutSeconds"</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token string">"createFrequencySeconds"</span><span class="token operator">:</span><span class="token number">480</span><span class="token punctuation">}</span>

# 测试 `<span class="token annotation punctuation">@Value</span>` 注解的属性
$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>demo<span class="token operator">/</span>test02
<span class="token punctuation">{<!-- --></span><span class="token string">"createFrequencySeconds"</span><span class="token operator">:</span><span class="token number">480</span><span class="token punctuation">,</span><span class="token string">"payTimeoutSeconds"</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">}</span>

</code></pre> 
<p>配置成功刷新。</p> 
<p><strong>当前方案只刷新单节点，生产环境下基本是多节点的，因此再生产环境下我们一般不使用这个方案。</strong></p> 
<h3><a id="__Spring_Cloud_Bus__561"></a>基于 Spring Cloud Bus 实现</h3> 
<p>基于 Spring Cloud Bus 实现，可以<strong>通知到项目的所有节点，刷新本地缓存</strong>的配置。</p> 
<blockquote> 
 <p>Spring Cloud Bus 是事件、消息总线，用于在集群（例如，配置变化事件）中传播状态变化，可与 Spring Cloud Config 联合实现热部署。</p> 
</blockquote> 
<p>简单来说，Spring Cloud Bus 是基于 RabbitMQ、Kafka、RocketMQ 等消息队列，<strong>通过发送事件（消息），广播到订阅该事件（消息）的所有节点上</strong>。如此，我们就很好理解 Spring Cloud Config + Spring Cloud Bus 来实现自动配置刷新的整体架构，整体如下图所示：<br> <img src="https://images2.imgbox.com/d6/eb/ULApjOBu_o.png" alt="在这里插入图片描述"></p> 
<ul><li>在我们修改完 Spring Cloud Config <strong>Server</strong> 配置中心的配置时后，调用其<code>/monitor</code>接口，发布 <code>RefreshRemoteApplicationEvent </code>事件到 Spring Cloud Bus 中。</li><li>使用了 Spring Cloud Config <strong>Client</strong> 的项目，<strong>在启动时会订阅 RefreshRemoteApplicationEvent 事件</strong>。这样，在<strong>从 Spring Cloud Bus 接收到该事件时，会使用 Spring Cloud Config Client 重新从 Server 拉取配置，从而自动刷新本地缓存的配置。</strong><br> <font color="red">本质上，是基于消息队列实现广播消费，刷新本地缓存</font></li></ul> 
<p><img src="https://images2.imgbox.com/25/52/tldzsfPD_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_Spring_Cloud_Config_Server_576"></a>搭建 Spring Cloud Config Server</h4> 
<p>从<code>sc-config-user-application</code> 项目，复制出 <code>sc-config-server-git-auto-refresh-by-bus </code>项目来接入 Spring Cloud <code>Bus</code>。</p> 
<h5><a id="_578"></a>引入依赖</h5> 
<p>修改 pom.xml 文件中，额外引入 Spring Cloud Bus 相关依赖。</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 引入基于 RabbitMQ 的 Spring Cloud Bus 的实现的依赖，并实现对其的自动配置 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 引入 Spring Cloud Config Monitor 依赖，提供 `/monitor` 接口，用于刷新配置 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-config-monitor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="_594"></a>配置文件</h5> 
<p>修改 <code>application.yml</code> 配置文件，增加 <code>spring.rabbitmq </code>配置项，从而初始化 RabbitMQ 客户端，提供给 Spring Cloud Bus RabbitMQ 使用。完整配置如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>config<span class="token punctuation">-</span>server

  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> git <span class="token comment"># 使用的 Spring Cloud Config Server 的存储器方案</span>
  <span class="token comment"># Spring Cloud Config 相关配置项</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token comment"># Spring Cloud Config Server 的 Git 存储器的配置项，对应 MultipleJGitEnvironmentProperties 类</span>
        <span class="token key atrule">git</span><span class="token punctuation">:</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/YunaiV/demo<span class="token punctuation">-</span>config<span class="token punctuation">-</span>server.git <span class="token comment"># Git 仓库地址</span>
          <span class="token key atrule">search-paths</span><span class="token punctuation">:</span> / <span class="token comment"># 读取文件的根地址</span>
          <span class="token key atrule">default-label</span><span class="token punctuation">:</span> master <span class="token comment"># 使用的默认分支，默认为 master</span>
  <span class="token comment">#          username: ${CODING_USERNAME} # 账号</span>
  <span class="token comment">#          password: ${CODING_PASSWORD} # 密码</span>

  <span class="token comment"># RabbitMQ 相关配置项</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
</code></pre> 
<h4><a id="_Spring_Cloud_Config_Client_626"></a>搭建 Spring Cloud Config Client</h4> 
<p>从<code>sc-config-user-application </code>项目，复制出<code>sc-config-user-application-auto-refresh-by-bus </code>项目来接入 Spring Cloud Bus。</p> 
<h5><a id="_629"></a>引入依赖</h5> 
<p>修改<code>pom.xml</code>文件中，额外引入 <code>Spring Cloud Bus </code>相关依赖。新增如下：</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 引入基于 RabbitMQ 的 Spring Cloud Bus 的实现的依赖，并实现对其的自动配置 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="_638"></a>配置文件</h5> 
<p>创建 <code>application.yml </code>配置文件，增加<code>spring.rabbitmq</code>配置项，从而初始化 RabbitMQ 客户端，提供给 Spring Cloud Bus RabbitMQ 使用。配置如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token comment"># RabbitMQ 相关配置项</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest

</code></pre> 
<h5><a id="RefreshScope_651"></a>@RefreshScope</h5> 
<p>将 <code>@RefreshScope</code> 注解添加在 DemoController 类上，实现<code> @Value</code> 注解的属性的刷新。代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/demo"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RefreshScope</span> <span class="token comment">// 加我加我加我！</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// ... 省略其它代码</span>

<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>简单测试</p> 
</blockquote> 
<p>① 使用 ConfigServerApplication 类，启动 Spring Cloud Config Server。使用 UserApplication 类，启动用户服务。</p> 
<p>使用 curl 命令，请求 DemoController 提供的两个测试接口，获得当前的配置。过程如下：</p> 
<pre><code class="prism language-java"># 测试 `<span class="token annotation punctuation">@ConfigurationProperties</span>` 注解的配置属性类
$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>demo<span class="token operator">/</span>test01
<span class="token punctuation">{<!-- --></span><span class="token string">"payTimeoutSeconds"</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token string">"createFrequencySeconds"</span><span class="token operator">:</span><span class="token number">240</span><span class="token punctuation">}</span>

# 测试 `<span class="token annotation punctuation">@Value</span>` 注解的属性
$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>demo<span class="token operator">/</span>test02
<span class="token punctuation">{<!-- --></span><span class="token string">"createFrequencySeconds"</span><span class="token operator">:</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token string">"payTimeoutSeconds"</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">}</span>
</code></pre> 
<p>② 将 Git 中的 <code>user-application.yml</code> 配置文件，将<code>order.create-frequency-seconds</code>配置项修改成 480，并 Push 到 Git 仓库。最终内容如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">order</span><span class="token punctuation">:</span>
  <span class="token key atrule">pay-timeout-seconds</span><span class="token punctuation">:</span> <span class="token number">60</span> <span class="token comment"># 订单支付超时时长，单位：秒。</span>
  <span class="token key atrule">create-frequency-seconds</span><span class="token punctuation">:</span> <span class="token number">480</span> <span class="token comment"># 订单创建频率，单位：秒</span>
</code></pre> 
<p>使用 curl 命令，请求 DemoController 提供的两个测试接口，获得当前的配置。过程如下：</p> 
<pre><code class="prism language-java"># 测试 `<span class="token annotation punctuation">@ConfigurationProperties</span>` 注解的配置属性类
$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>demo<span class="token operator">/</span>test01
<span class="token punctuation">{<!-- --></span><span class="token string">"payTimeoutSeconds"</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token string">"createFrequencySeconds"</span><span class="token operator">:</span><span class="token number">240</span><span class="token punctuation">}</span>

# 测试 `<span class="token annotation punctuation">@Value</span>` 注解的属性
$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>demo<span class="token operator">/</span>test02
<span class="token punctuation">{<!-- --></span><span class="token string">"createFrequencySeconds"</span><span class="token operator">:</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token string">"payTimeoutSeconds"</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">}</span>
</code></pre> 
<p>配置没有发生变化，因为我们没有通知 Spring Cloud Config Client 配置变化，重新去 Spring Cloud Config Server 重新拉取。</p> 
<p>Postman 模拟 POST 请求 Spring Cloud Config Server 的 <code>http://127.0.0.1:8888/monitor </code>地址，<strong>实现 Spring Cloud Config Server 使用 Spring Cloud Bus 发送事件（消息）到 RabbitMQ 中</strong>。如下图所示：<br> <img src="https://images2.imgbox.com/cf/f8/6A14zdyS_o.png" alt="在这里插入图片描述"></p> 
<ul><li><code>path </code>参数，<strong>设置要自动配置刷新的服务名</strong>。这里设置为<code>*</code>表示通知所有服务 。<br> 此时在 IDEA 的控制台中，我们会看到 Spring Cloud Config Server 会打印 Spring Cloud Config Monitor 的日志如下：</li></ul> 
<pre><code class="prism language-java"><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">14</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">42.459</span> INFO <span class="token number">33375</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8888</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span></span>PropertyPathEndpoint</span> <span class="token operator">:</span> <span class="token class-name">Refresh</span> <span class="token keyword">for</span><span class="token operator">:</span> <span class="token operator">*</span>
</code></pre> 
<p>用户服务通过 Spring Cloud <strong>Bus</strong> 会接收到来自 <strong>RabbitMQ</strong> 的事件（消息），会触发 Spring Cloud Config Client 从 Spring Cloud Config Server 重新拉取配置。</p> 
<p>此时在 IDEA 的控制台中，我们会看到用户服务的日志，可以发现从 Spring Cloud Config Server 重新读取了配置内容：</p> 
<pre><code class="prism language-java"># <span class="token class-name">Spring</span> <span class="token class-name">Cloud</span> <span class="token class-name">Config</span> 相关日志
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">17.893</span>  INFO <span class="token number">33721</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>rKC4AuvtW_ZYw<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>ConfigServicePropertySourceLocator</span> <span class="token operator">:</span> <span class="token class-name">Fetching</span> config from server at <span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8888</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">18.945</span>  INFO <span class="token number">33721</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>rKC4AuvtW_ZYw<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>ConfigServicePropertySourceLocator</span> <span class="token operator">:</span> <span class="token class-name">Located</span> environment<span class="token operator">:</span> name<span class="token operator">=</span>user<span class="token operator">-</span>application<span class="token punctuation">,</span> profiles<span class="token operator">=</span><span class="token punctuation">[</span><span class="token keyword">default</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> version<span class="token operator">=</span><span class="token number">65469</span>edc06892d76d2b3d3e35b4cdd5ff71d3c52<span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token keyword">null</span>
# <span class="token class-name">Spring</span> <span class="token class-name">Cloud</span> <span class="token class-name">Bus</span> 相关日志
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">18.983</span>  INFO <span class="token number">33721</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>rKC4AuvtW_ZYw<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>bus<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span>RefreshListener</span>      <span class="token operator">:</span> <span class="token class-name">Received</span> remote refresh <span class="token class-name"><span class="token namespace">request<span class="token punctuation">.</span></span> Keys</span> refreshed <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre> 
<p>使用 curl 命令，请求 DemoController 提供的两个测试接口，获得当前的配置。</p> 
<pre><code class="prism language-java"># 测试 `<span class="token annotation punctuation">@ConfigurationProperties</span>` 注解的配置属性类
$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>demo<span class="token operator">/</span>test01
<span class="token punctuation">{<!-- --></span><span class="token string">"payTimeoutSeconds"</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token string">"createFrequencySeconds"</span><span class="token operator">:</span><span class="token number">480</span><span class="token punctuation">}</span>

# 测试 `<span class="token annotation punctuation">@Value</span>` 注解的属性
$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>demo<span class="token operator">/</span>test02
<span class="token punctuation">{<!-- --></span><span class="token string">"createFrequencySeconds"</span><span class="token operator">:</span><span class="token number">480</span><span class="token punctuation">,</span><span class="token string">"payTimeoutSeconds"</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">}</span>
</code></pre> 
<p>配置成功刷新</p> 
<h3><a id="_735"></a>基于监听器</h3> 
<p>通过 <code>@ConfigurationProperties</code> 或者 <code>@Value</code> + <code>@RefreshScope </code>注解，已经能够满足我们绝大多数场景下的自动刷新配置的功能。但是，在一些场景下，我们仍然需要实现对配置的监听，执行自定义的逻辑。</p> 
<p>在 Spring Cloud 中，在 <code>Environment </code>的属性配置发生变化时，会发布 <code>EnvironmentChangeEvent</code> 事件。这样，我们只需要实现 <code>EnvironmentChangeEvent </code>事件的<strong>监听器</strong>，就可以进行自定义的逻辑处理。</p> 
<p>例如说，Spring Cloud 内置了<code>LoggingRebinder</code><strong>监听器</strong>，实现了对 <code>EnvironmentChangeEvent </code>事件的监听，在发现 <code>logging.level </code>配置项发生变化时，重新设置日志组件的日志级别。如下图所示：<img src="https://images2.imgbox.com/21/dc/bVF60FYm_o.png" alt="在这里插入图片描述"><br> 下面，我们来演示 Spring Cloud 的 EnvironmentChangeEvent 的事件监听器，通过内置的 LoggingRebinder 监听器，以及稍后我们会自定义一个简单的监听器。最终项目如下图所示：<br> <img src="https://images2.imgbox.com/73/cb/YQLnt9b5_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="LoggingRebinder_744"></a>LoggingRebinder</h5> 
<p>通过 LoggingRebinder 监听器，我们可以实现日志级别的动态修改。</p> 
<p>先在 DemoController 类中，增加一个打印日志的 API 接口。代码如下：</p> 
<pre><code class="prism language-java"><span class="token comment">// DemoController.java</span>

<span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/logger"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[logger][测试一下]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后，开始我们来测试日志级别的动态修改的功能：</p> 
<p>① 在 Git 中的 <code>user-application.yml </code>配置文件，增加 <code>logging.level.cn.iocoder.springcloud.labx12.userapplication.controller.DemoController </code>配置项为 <code>INFO</code>，即让 DemoController 使用 INFO 日志级别。修改完成，记得推送到 Git 仓库噢。</p> 
<p><strong>然后，使用 ConfigServerApplication 类，启动 Spring Cloud Config Server。使用 UserApplication 类，启动用户服务。</strong></p> 
<p>最后，请求<code>http://127.0.0.1:8080/demo/logger</code>接口，控制台并未打印日志，因为当前日志级别是 INFO。</p> 
<p>② 在 Git 中的<code>user-application.yml</code>配置文件，增加 <code>logging.level.cn.iocoder.springcloud.labx12.userapplication.controller.DemoController </code>配置项为 <code>DEBUG</code>，即让 DemoController 使用<code>DEBUG</code>日志级别。修改完成，记得推送到 Git 仓库噢。</p> 
<p>然后，使用 Postman 模拟<code> POST</code> 请求用户服务的 <code>http://127.0.0.1:8080/actuator/refresh </code>地址，<strong>通知用户刷新配置，触发 Spring Cloud Config Client 从 Spring Cloud Config Server 重新拉取配置。</strong></p> 
<p>最终，控制台<strong>打印日志</strong>，因为当前日志级别是 DEBUG。日志内容如下：</p> 
<pre><code class="prism language-java"><span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">24.022</span> DEBUG <span class="token number">50417</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>i<span class="token punctuation">.</span>s<span class="token punctuation">.</span>l<span class="token punctuation">.</span>u<span class="token punctuation">.</span>controller<span class="token punctuation">.</span></span>DemoController</span>      <span class="token operator">:</span> <span class="token punctuation">[</span>logger<span class="token punctuation">]</span><span class="token punctuation">[</span>测试一下<span class="token punctuation">]</span>
</code></pre> 
<ul><li>符合预期。</li></ul> 
<h5><a id="DemoEnvironmentChangeListener_780"></a>DemoEnvironmentChangeListener</h5> 
<p>我们来实现一个自定义的 <code>DemoEnvironmentChangeListener</code> 监听器，打印下变化配置项的最新值。代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoEnvironmentChangeListener</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EnvironmentChangeEvent</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ConfigurableEnvironment</span> environment<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">EnvironmentChangeEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> event<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[onApplicationEvent][key({}) 最新 value 为 {}]"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>然后，开始我们来测试 <code>DemoEnvironmentChangeListener </code>的功能：</p> 
<p>① 使用 ConfigServerApplication 类，启动 Spring Cloud Config Server。使用 UserApplication 类，启动用户服务。</p> 
<p>② 在 Git 中的 user-application.yml 配置文件，增加 test 配置项为 true，只是为了修改下配置。<strong>修改完成，记得推送到 Git 仓库噢</strong>。</p> 
<p>然后，使用 Postman 模拟 POST 请求用户服务的 http://127.0.0.1:8080/actuator/refresh 地址，通知用户刷新配置，触发 Spring Cloud Config Client 从 Spring Cloud Config Server 重新拉取配置。</p> 
<p>最终，我们在 IDEA 控制台可以看到 DemoEnvironmentChangeListener 打印如下日志，符合预期：</p> 
<pre><code class="prism language-java"><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">14</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">29</span><span class="token operator">:</span><span class="token number">09.439</span>  INFO <span class="token number">50417</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token punctuation">.</span>i<span class="token punctuation">.</span>s<span class="token punctuation">.</span>l<span class="token punctuation">.</span>u<span class="token punctuation">.</span>l<span class="token punctuation">.</span>DemoEnvironmentChangeListener <span class="token operator">:</span> <span class="token punctuation">[</span>onApplicationEvent<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token function">key</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>client<span class="token punctuation">.</span>version<span class="token punctuation">)</span> 最新 value 为 b484b8cae6d99a392a0e7ce59fb23f44d3030b3e<span class="token punctuation">]</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">14</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">29</span><span class="token operator">:</span><span class="token number">09.439</span>  INFO <span class="token number">50417</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token punctuation">.</span>i<span class="token punctuation">.</span>s<span class="token punctuation">.</span>l<span class="token punctuation">.</span>u<span class="token punctuation">.</span>l<span class="token punctuation">.</span>DemoEnvironmentChangeListener <span class="token operator">:</span> <span class="token punctuation">[</span>onApplicationEvent<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token function">key</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span> 最新 value 为 <span class="token boolean">true</span><span class="token punctuation">]</span>
</code></pre> 
<h3><a id="_817"></a>配置加密</h3> 
<p>spring Cloud Config 是<strong>唯一</strong>内置配置加密的功能的配置中心，这点是比 Nacos 和 Apollo 强大的地方，它们都需要结合 Jasypt 来实现该功能，并且存在不兼容的问题。</p> 
<p>Spring Cloud Config 的配置的加解密行为，是在 <strong>Server</strong> 端完成，对 <strong>Client</strong> 端是<strong>完全透明</strong>的。</p> 
<p>例如说，我们将 <strong>xx-password</strong> 配置项加密存储到 Git 仓库后，Spring Cloud Config Client 在从 Spring Cloud Config Server 请求该配置项时，Server 会从 Git 仓库获取 xx-password 配置项，<strong>并解密</strong>返回给 Spring Cloud Config Client。</p> 
<p>下面，我们来演示 Spring Cloud Config 的配置加密的功能。<br> <img src="https://images2.imgbox.com/f6/e8/CoPuTgVH_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_Spring_Cloud_Config_Server_826"></a>搭建 Spring Cloud Config Server</h4> 
<p>直接使用<code>sc-config-server-git</code> 项目即可，开启配置加密功能。</p> 
<h5><a id="_JCE_828"></a>安装 JCE</h5> 
<p>因为 <strong>Spring Cloud Config Server</strong> 的配置加密功能，是基于<code> JCE</code>（Java Cryptography Extension）实现，在使用它实现<code> ACE</code> 加密时，会抛出如下异常：</p> 
<pre><code class="prism language-java"><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>InvalidKeyException</span><span class="token operator">:</span> <span class="token class-name">Illegal</span> key size
</code></pre> 
<p>原因是，默认安装的 JDK 或者 JRE 包含 JCE 的 policy 文件是受限.</p> 
<p>解决办法也很简单，去 Oracle 官方下载 Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files，然后覆盖掉 JDK 或 JRE 中的 local_policy.jar 和 US_export_policy.jar 即可。<a href="https://www.oracle.com/cn/technical-resources/" rel="nofollow">下载地址为</a><br> <img src="https://images2.imgbox.com/92/cf/TwXiScaH_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_838"></a>配置文件</h5> 
<p>创建 bootstrap.yml 配置文件，增加加密功能相关的配置项。配置如下：</p> 
<blockquote> 
 <p>一定要放在 bootstrap.yml 配置文件中，不然配置解密功能是无法生效的！</p> 
</blockquote> 
<pre><code class="prism language-yaml"><span class="token comment"># 加密配置项，对应 KeyProperties 类</span>
<span class="token key atrule">encrypt</span><span class="token punctuation">:</span>
  <span class="token comment"># 对称加密</span>
  <span class="token key atrule">key</span><span class="token punctuation">:</span> yudaoyuanma <span class="token comment"># 对称加密 key</span>
  <span class="token key atrule">salt</span><span class="token punctuation">:</span> dfaad7761f0729b35ec3b3543604eda7 <span class="token comment"># 对称加密 salt，默认为 "deadbeef"，必须是 16 进制</span>
</code></pre> 
<p><code>encrypt </code>为<strong>加密配置项</strong>，对应<code> KeyProperties</code> 类。Spring Cloud Config 支持<strong>对称加密和非对称加密</strong>，后者安全性更高。这里先采用对称加密：</p> 
<ul><li><code>key</code>：<strong>对称加密的 key</strong>。</li><li><code>salt</code>：<strong>对称加密的 salt</strong>，默认为 “deadbeef”。注意，生产环境下推荐自定义，必须是 <strong>16</strong> 进制，可以通过 Hex(16 进制)随机生成计算器 来生成。</li></ul> 
<h5><a id="EncryptionController_854"></a>EncryptionController</h5> 
<p>在 Spring Cloud Config <strong>Server</strong> 中，内置 <code>EncryptionController </code>提供加解密功能的 HTTP 接口，比较常用的有两个：</p> 
<ul><li>加密：<code>curl {CONFIG_SERVER}/encrypt -d 需要加密的字符串</code></li><li>解密：<code>curl {CONFIG_SERVER}/decrypt -d 需要解密的字符串</code></li></ul> 
<p>在后面，我们可以通过<code>/encrypt</code>接口来加密需要的配置项的<strong>值</strong>，然后添加到 Git 仓库中。</p> 
<h4><a id="_Spring_Cloud_Config_Client_860"></a>搭建 Spring Cloud Config Client</h4> 
<p>使用<code>sc-config-user-application</code> 项目即。</p> 
<p>为了方便读取稍后测试的 xx-password 配置项，我们在 DemoController 中添加读取该配置项的接口。代码如下：</p> 
<pre><code class="prism language-java"><span class="token comment">// DemoController.java</span>

<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"${xx-password:''}"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> xxPassword<span class="token punctuation">;</span>
    
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/xx_password"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">xxPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> xxPassword<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>简单测试</p> 
</blockquote> 
<p>① 使用 ConfigServerApplication 类，启动 Spring Cloud Config <strong>Server</strong>。<br> ② 调用 Spring Cloud Config <strong>Server</strong> 的 <code>/encrypt </code>接口，将 <code>"wosshimima" </code>进行<strong>解密</strong>。操作如下：</p> 
<pre><code class="prism language-java">$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8888</span><span class="token operator">/</span>encrypt <span class="token operator">-</span>d woshimima
<span class="token number">5f</span>ca0df4439ee4b2830195555934985442efee67fe1e4bb4cce6fde2ff081a10
</code></pre> 
<p>然后，添加<code>xx-password</code>配置项为 <code>5fca0df4439ee4b2830195555934985442efee67fe1e4bb4cce6fde2ff081a10 </code>到 Git 仓库中。如下图所示：<br> <img src="https://images2.imgbox.com/d5/dc/vl0d4ngl_o.png" alt="在这里插入图片描述"></p> 
<p>注意，需要使用<code>'{cipher}'</code>进行包裹，这样 Spring Cloud Config <strong>Server</strong> 才能<strong>知道该配置项的值是经过加密的，需要进行解密</strong>。</p> 
<h4><a id="_891"></a>非对称加密</h4> 
<blockquote> 
 <p>以下的操作都是在sc-config-server-git项目里进行操作的</p> 
</blockquote> 
<p>①使用 <code>keytool </code>命令来生成 <strong>Key Store</strong>。操作如下：</p> 
<pre><code class="prism language-java">keytool <span class="token operator">-</span>genkeypair <span class="token operator">-</span>alias mytestkey <span class="token operator">-</span>keyalg RSA <span class="token operator">-</span>dname <span class="token string">"CN=Config Server,OU=Unit,O=Organization,L=City,S=State,C=CN"</span> <span class="token operator">-</span>keypass nicainicai <span class="token operator">-</span>keystore configserver<span class="token punctuation">.</span>jks <span class="token operator">-</span>storepass buzhidao
</code></pre> 
<p>具体的参数含义如下：</p> 
<ul><li><code>-genkeypair</code>：<strong>创建密钥对</strong></li><li><code>-alias</code>：<strong>产生别名</strong>，默认为 <strong>“mykey”</strong></li><li><code>-keyalg</code>：指定<strong>密钥的算法</strong>，例如说 RSA、DSA。默认为 DSA</li><li><code>-dname</code>：指定<strong>证书拥有者信息</strong>，例如：<strong>“CN=名字与姓氏,OU=组织单位名称,O=组织名称,L=城市或区域名称,ST=州或省份名称,C=单位的两字母国家代码”</strong></li><li><code>-keypass</code>：指定<strong>别名条目的密码（私钥的密码）</strong></li><li><code>-keystore</code>：指定<strong>密钥库的名称</strong>（产生的各类信息将不在 <strong>.keystore</strong> 文件中）</li><li><code>-storepass</code>：指定<strong>密钥库的密码</strong>(<strong>获取 keystore 信息所需的密码</strong>)</li></ul> 
<p>执行完成后，在当前目录我们会获得 <code>configserver.jks</code>。 我们需要将它复制到 Spring Cloud Config <strong>Server</strong> 项目的 <strong>resources</strong> 目录下，如下图所示： <img src="https://images2.imgbox.com/8e/a3/co1ovENJ_o.png" alt="在这里插入图片描述"></p> 
<p>② 修改 <code>bootstrap.yml </code>配置文件，设置使用 <code>KeyStore</code>。完整配置如下：</p> 
<pre><code class="prism language-yaml"><span class="token comment"># 加密配置项，对应 KeyProperties 类</span>
<span class="token key atrule">encrypt</span><span class="token punctuation">:</span>
  <span class="token comment"># 对称加密</span>
<span class="token comment">#  key: yudaoyuanma # 对称加密 key</span>
<span class="token comment">#  salt: dfaad7761f0729b35ec3b3543604eda7 # 对称加密 salt，默认为 "deadbeef"，必须是 16 进制</span>
  <span class="token comment"># 非对应加密</span>
  <span class="token key atrule">key-store</span><span class="token punctuation">:</span>
    <span class="token key atrule">location</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>/configserver.jks <span class="token comment"># jks 文件所在的路径</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> buzhidao <span class="token comment"># 对应 storepass 参数</span>
    <span class="token key atrule">alias</span><span class="token punctuation">:</span> mytestkey <span class="token comment"># 对应 alias 参数</span>
    <span class="token key atrule">secret</span><span class="token punctuation">:</span> nicainicai <span class="token comment"># 对应 keypass 参数</span>
</code></pre> 
<p>③因为 Maven 配置下，不会将 <code>*.jks </code>打包到项目中，所以我们需要修改下 <code>pom.xml</code> 文件的 <code>&lt;build /&gt;</code> 属性如下：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resources</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resource</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span><span class="token punctuation">&gt;</span></span>src/main/resource<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>includes</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>**/*.yml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- 将 .yml 后缀包含进去 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>**/*.jks<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- 将 .jks 后缀包含进去 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>includes</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filtering</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filtering</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- 不进行过滤 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resource</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resources</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>④ 使用 ConfigServerApplication 类，启动 Spring Cloud Config Server。</p> 
<p>然后，调用 Spring Cloud Config Server 的 /encrypt 接口，将 “wosshimima” 进行解密</p> 
<h2><a id="_948"></a>与注册中心集成</h2> 
<p><img src="https://images2.imgbox.com/ce/ff/roWzojLa_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Spring_Cloud_Config_Server_952"></a>Spring Cloud Config Server</h3> 
<p>修改 pom.xml 文件，引入 <code>spring-cloud-starter-alibaba-nacos-discovery</code> 依赖。</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 引入 Spring Cloud Alibaba Nacos Discovery 相关依赖，将 Nacos 作为注册中心，并实现对其的自动配置 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>修改 application.yml 配置文件</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>config<span class="token punctuation">-</span>server
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> git <span class="token comment"># 使用的 Spring Cloud Config Server 的存储器方案</span>
  <span class="token comment"># Spring Cloud Config 相关配置项</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token comment"># Spring Cloud Config Server 的 Git 存储器的配置项，对应 MultipleJGitEnvironmentProperties 类</span>
        <span class="token key atrule">git</span><span class="token punctuation">:</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/YunaiV/demo<span class="token punctuation">-</span>config<span class="token punctuation">-</span>server.git <span class="token comment"># Git 仓库地址</span>
          <span class="token key atrule">search-paths</span><span class="token punctuation">:</span> / <span class="token comment"># 读取文件的根地址</span>
          <span class="token key atrule">default-label</span><span class="token punctuation">:</span> master <span class="token comment"># 使用的默认分支，默认为 master</span>
<span class="token comment">#          username: ${CODING_USERNAME} # 账号</span>
<span class="token comment">#          password: ${CODING_PASSWORD} # 密码</span>
    <span class="token comment"># Spring Cloud Nacos Discovery 相关配置项</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token comment"># Nacos 作为注册中心的配置项，对应 NacosDiscoveryProperties 配置类</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># Nacos 服务器地址</span>
        <span class="token key atrule">service</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span> <span class="token comment"># 注册到 Nacos 的服务名。默认值为 ${spring.application.name}。</span>
</code></pre> 
<h3><a id="Spring_Cloud_Config_Client_992"></a>Spring Cloud Config Client</h3> 
<pre><code class="prism language-xml"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 引入 SpringMVC 相关依赖，并实现对其的自动配置 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 引入 Spring Cloud Config Client 相关依赖，作为配置中心的客户端，并实现自动化配置 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 引入 Spring Cloud Alibaba Nacos Discovery 相关依赖，将 Nacos 作为注册中心，并实现对其的自动配置 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>  
</code></pre> 
<p>修改 bootstrap.yml 配置文件 ,增加 spring.cloud.nacos.discovery 配置项，实现 Spring Cloud Alibaba Nacos Discovery 的配置。完整配置如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>application
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token comment"># Spring Cloud Config Client 配置项，对应 ConfigClientProperties 类</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span> <span class="token comment"># 读取的配置文件的名字，默认为 ${spring.application.name}</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否使用注册发现，获取配置中心的地址，默认为 false</span>
        <span class="token key atrule">service-id</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>config<span class="token punctuation">-</span>server <span class="token comment"># 配置中心的服务名</span>
    <span class="token comment"># Spring Cloud Nacos Discovery 相关配置项</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token comment"># Nacos 作为注册中心的配置项，对应 NacosDiscoveryProperties 配置类</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># Nacos 服务器地址</span>
        <span class="token key atrule">service</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span> <span class="token comment"># 注册到 Nacos 的服务名。默认值为 ${spring.application.name}。</span>
</code></pre> 
<p>重点看下在 spring.cloud.config 配置项，我们去掉了 uri 配置项，并增加 discovery 配置项来配置和 Spring Cloud 注册中心的集成。这里我们设置 service-id 为 demo-config-server，就是我们搭建的 Spring Cloud Config Server 的服务名。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9529a165adc083f88293cd93f6de72e6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vmware16安装MacOS10.15图文（VIP典藏版）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/104a47d1cfe3b43c9a5b378b08597e0b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">论文翻译：2021_Performance optimizations on deep noise suppression models</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>