<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>scrapy--模拟登录--设置cookie - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="scrapy--模拟登录--设置cookie" />
<meta property="og:description" content="本文主要讲述模拟登录。
scrapy是怎么开始请求的 通过scrapy genspider 爬虫名.py 域名后观察对应的python文件
import scrapy class LoginSpider(scrapy.Spider): name = &#34;login&#34; allowed_domains = [&#34;17k.com&#34;] def parse(self, response, **kwargs): pass 思考start_urls = [&#34;https://17k.com&#34;]这个scrapy是怎么请求的。
可以看出类LoginSpider是继承scrapy.Spider。观察scrapy.Spider后发现scrapy.Spider中有一个方法start_requests。这个方法就是scrapy发送请求的地方。
def start_requests(self): if not self.start_urls and hasattr(self, &#34;start_url&#34;): raise AttributeError( &#34;Crawling could not start: &#39;start_urls&#39; not found &#34; &#34;or empty (but found &#39;start_url&#39; attribute instead, &#34; &#34;did you miss an &#39;s&#39;?)&#34; ) for url in self.start_urls: yield Request(url,dont_filter=True) 这个里面默认没有cookie，scrapy.spider给的start_requests（）其实是不满足需求的。按住Request进入观察
def __init__( self, url: str, callback: Optional[Callable] = None, method: str = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f0a9b8d069c0fb2d37381c0f3bf2a962/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-06T18:27:52+08:00" />
<meta property="article:modified_time" content="2023-06-06T18:27:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">scrapy--模拟登录--设置cookie</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>本文主要讲述模拟登录。</p> 
<h3><a id="scrapy_1"></a>scrapy是怎么开始请求的</h3> 
<p>通过scrapy genspider 爬虫名.py 域名后观察对应的python文件</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> scrapy


<span class="token keyword">class</span> <span class="token class-name">LoginSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">"login"</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"17k.com"</span><span class="token punctuation">]</span>
    

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

</code></pre> 
<p>思考<code>start_urls = ["https://17k.com"]</code>这个scrapy是怎么请求的。<br> 可以看出类LoginSpider是继承scrapy.Spider。观察scrapy.Spider后发现scrapy.Spider中有一个方法start_requests。这个方法就是scrapy发送请求的地方。</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>start_urls <span class="token keyword">and</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"start_url"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span>
                <span class="token string">"Crawling could not start: 'start_urls' not found "</span>
                <span class="token string">"or empty (but found 'start_url' attribute instead, "</span>
                <span class="token string">"did you miss an 's'?)"</span>
            <span class="token punctuation">)</span>
        <span class="token keyword">for</span> url <span class="token keyword">in</span> self<span class="token punctuation">.</span>start_urls<span class="token punctuation">:</span>
            <span class="token keyword">yield</span> Request<span class="token punctuation">(</span>url<span class="token punctuation">,</span>dont_filter<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<p>这个里面默认没有cookie，scrapy.spider给的start_requests（）其实是不满足需求的。按住Request进入观察</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        url<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        callback<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Callable<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        method<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"GET"</span><span class="token punctuation">,</span>
        headers<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        body<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Union<span class="token punctuation">[</span><span class="token builtin">bytes</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        cookies<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Union<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        meta<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        encoding<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"utf-8"</span><span class="token punctuation">,</span>
        priority<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        dont_filter<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
        errback<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Callable<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        flags<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        cb_kwargs<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
</code></pre> 
<p>发现cookie的定义<code>cookies: Optional[Union[dict, List[dict]]] = None,</code><br> 因此可以知道子类对父类提供的某个方法不满足要求。<br> 这种就需要我们去<strong>重写</strong>。这需要重写start_requests().</p> 
<h3><a id="cookie_55"></a>设置cookie</h3> 
<p>针对cookie有多种设置方法。</p> 
<h4><a id="cookie_57"></a>单个请求的cookie管理</h4> 
<h5><a id="_59"></a>方法一：直接从浏览器中复制。</h5> 
<p><strong>a.传入Request的cookies参数.cookie是字典。</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> scrapy


<span class="token keyword">class</span> <span class="token class-name">LoginSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">"login"</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"17k.com"</span><span class="token punctuation">]</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"https://user.17k.com/ck/author/shelf?page=1&amp;appKey=2406394919"</span><span class="token punctuation">]</span><span class="token comment">#该网站需要携带cookie才能正常访问。</span>
    <span class="token triple-quoted-string string">'''因此需要重写scrapy.Spider里的start_requests()方法。'''</span>

    <span class="token triple-quoted-string string">'''携带cookie有三种处理方法。scrapy里的cookie是字典源码： self.cookies = cookies or {}'''</span>

    <span class="token comment">#方法一：从浏览器中复制cookie</span>

    <span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        cookie_str<span class="token operator">=</span><span class="token string">'你的cookie'</span>
        <span class="token comment">#对cookie_str做字符串切割。</span>
        cookie_list<span class="token operator">=</span>cookie_str<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'; '</span><span class="token punctuation">)</span>

        cookie_dic<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token builtin">list</span> <span class="token keyword">in</span> cookie_list<span class="token punctuation">:</span>
            data<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span>
            k<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            v<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            cookie_dic<span class="token punctuation">[</span>k<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">=</span>v<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>self<span class="token punctuation">.</span>start_urls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                             cookies<span class="token operator">=</span>cookie_dic<span class="token punctuation">)</span><span class="token comment">#默认回调函数是parse（）</span>
        

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    
</code></pre> 
<p><strong>b.设置headers</strong><br> 需要把settings.py的COOKIES_ENABLED设置为false</p> 
<pre><code class="prism language-python">COOKIES_ENABLED <span class="token operator">=</span> <span class="token boolean">False</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"cookie"</span><span class="token punctuation">:</span><span class="token string">"填入cookie"</span>
    <span class="token punctuation">}</span>
    url <span class="token operator">=</span> <span class="token string">'请求url'</span>
    <span class="token keyword">yield</span> Request<span class="token punctuation">(</span>url<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>

</code></pre> 
<h5><a id="_114"></a>方法二：模拟登录流程。</h5> 
<p>scrapy请求中post参数data是不一样的。并不是字典。且名称也不一样，是body。body的值是浏览器中form data 的view source的</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> scrapy


<span class="token keyword">class</span> <span class="token class-name">LoginSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">"login"</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"17k.com"</span><span class="token punctuation">]</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"https://user.17k.com/ck/author/shelf?page=1&amp;appKey=2406394919"</span><span class="token punctuation">]</span><span class="token comment">#该网站需要携带cookie才能正常访问。</span>
    <span class="token triple-quoted-string string">'''因此需要重写scrapy.Spider里的start_requests()方法。'''</span>

    <span class="token comment">#方法二：根据模拟登录流程，获得cookie</span>

    <span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#这是发送post请求的一种方案，但是请求体不好。</span>
        user<span class="token operator">=</span><span class="token string">'******'</span>
        pwd<span class="token operator">=</span><span class="token string">'******'</span>
        url<span class="token operator">=</span><span class="token string">'https://passport.17k.com/ck/user/login'</span>
        <span class="token comment">#注意scrapy请求中post参数data是不一样的。并不是字典。且名称也不一样，是body。body的值是浏览器中form data 的view source的</span>

        <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>
                             method<span class="token operator">=</span><span class="token string">'post'</span><span class="token punctuation">,</span>
                             body<span class="token operator">=</span><span class="token string">'loginName={}&amp;password={}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span>pwd<span class="token punctuation">)</span>
                             <span class="token punctuation">)</span>
        <span class="token comment">#这样模拟登录后，就需要去请求start_urls。得到start_urls的请求源码。</span>


    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>LoginSpider<span class="token punctuation">.</span>start_urls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse_detail<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse_detail</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    

</code></pre> 
<p><strong>利用scrapy.FormRequest请求</strong></p> 
<pre><code class="prism language-python"> data<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">'loginName'</span><span class="token punctuation">:</span> <span class="token string">'********'</span><span class="token punctuation">,</span>
            <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">'*******'</span>
        <span class="token punctuation">}</span>
 <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>FormRequest <span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>
                             method<span class="token operator">=</span><span class="token string">'post'</span><span class="token punctuation">,</span>
                             formdata<span class="token operator">=</span>data
                             <span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> scrapy


<span class="token keyword">class</span> <span class="token class-name">LoginSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">"login"</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"17k.com"</span><span class="token punctuation">]</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"https://user.17k.com/ck/author/shelf?page=1&amp;appKey=2406394919"</span><span class="token punctuation">]</span>  <span class="token comment"># 该网站需要携带cookie才能正常访问。</span>
    <span class="token triple-quoted-string string">'''因此需要重写scrapy.Spider里的start_requests()方法。'''</span>

    <span class="token comment"># 方法二：根据模拟登录流程，获得cookie</span>

    <span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 这是发送post请求的一种方案，但是请求体不好。</span>
        data<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">'loginName'</span><span class="token punctuation">:</span> <span class="token string">'*******'</span><span class="token punctuation">,</span>
            <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">'*******'</span>
        <span class="token punctuation">}</span>

        url <span class="token operator">=</span> <span class="token string">'https://passport.17k.com/ck/user/login'</span>
        <span class="token comment"># 注意scrapy请求中post参数data是不一样的。并不是字典。且名称也不一样，是body。body的值是浏览器中form data 的view source的</span>

        <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>FormRequest <span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>
                             method<span class="token operator">=</span><span class="token string">'post'</span><span class="token punctuation">,</span>
                             formdata<span class="token operator">=</span>data
                             <span class="token punctuation">)</span>
        <span class="token comment"># 这样模拟登录后，就需要去请求start_urls。得到start_urls的请求源码。</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>LoginSpider<span class="token punctuation">.</span>start_urls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse_detail<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse_detail</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>


</code></pre> 
<p>FormRequest 与 Request 区别<br> 官方文档如下，在文档中，几乎看不到差别。</p> 
<p>The FormRequest class adds a new argument to the constructor. The remaining arguments are the same as for the Request class and are not documented here.<br> Parameters: formdata (dict or iterable of tuples) – is a dictionary (or iterable of (key, value) tuples) containing HTML Form data which will be url-encoded and assigned to the body of the request.</p> 
<p>简单说就是FormRequest新增加了一个参数formdata，接受包含表单数据的字典或者可迭代的元组，并将其转化为请求的body。并且FormRequest是继承Request的。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">FormRequest</span><span class="token punctuation">(</span>Request<span class="token punctuation">)</span><span class="token punctuation">:</span>
 
  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    formdata <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'formdata'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> formdata <span class="token keyword">and</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'method'</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
      kwargs<span class="token punctuation">[</span><span class="token string">'method'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'POST'</span>
 
    <span class="token builtin">super</span><span class="token punctuation">(</span>FormRequest<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
 
    <span class="token keyword">if</span> formdata<span class="token punctuation">:</span>
      items <span class="token operator">=</span> formdata<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>formdata<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token keyword">else</span> formdata
      querystr <span class="token operator">=</span> _urlencode<span class="token punctuation">(</span>items<span class="token punctuation">,</span> self<span class="token punctuation">.</span>encoding<span class="token punctuation">)</span>
      <span class="token keyword">if</span> self<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">b'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">b'application/x-www-form-urlencoded'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_set_body<span class="token punctuation">(</span>querystr<span class="token punctuation">)</span>
      <span class="token keyword">else</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_set_url<span class="token punctuation">(</span>self<span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string">'&amp;'</span> <span class="token keyword">if</span> <span class="token string">'?'</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>url <span class="token keyword">else</span> <span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">+</span> querystr<span class="token punctuation">)</span>
      <span class="token comment">###</span>
 
 
<span class="token keyword">def</span> <span class="token function">_urlencode</span><span class="token punctuation">(</span>seq<span class="token punctuation">,</span> enc<span class="token punctuation">)</span><span class="token punctuation">:</span>
  values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>to_bytes<span class="token punctuation">(</span>k<span class="token punctuation">,</span> enc<span class="token punctuation">)</span><span class="token punctuation">,</span> to_bytes<span class="token punctuation">(</span>v<span class="token punctuation">,</span> enc<span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token keyword">for</span> k<span class="token punctuation">,</span> vs <span class="token keyword">in</span> seq
       <span class="token keyword">for</span> v <span class="token keyword">in</span> <span class="token punctuation">(</span>vs <span class="token keyword">if</span> is_listlike<span class="token punctuation">(</span>vs<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">[</span>vs<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">return</span> urlencode<span class="token punctuation">(</span>values<span class="token punctuation">,</span> doseq<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

</code></pre> 
<p>最终我们传递的{‘key’: ‘value’, ‘k’: ‘v’}会被转化为’key=value&amp;k=v’ 并且默认的method是POST，再来看看Request</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>object_ref<span class="token punctuation">)</span><span class="token punctuation">:</span>
 
  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> url<span class="token punctuation">,</span> callback<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'GET'</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
         cookies<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> meta<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> priority<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
         dont_filter<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> errback<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
 
    self<span class="token punctuation">.</span>_encoding <span class="token operator">=</span> encoding <span class="token comment"># this one has to be set first</span>
    self<span class="token punctuation">.</span>method <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/29e1d6faf3bd5f2eca61b58f1bb46358/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">qt程序诡异bug一例,ctrl&#43;c，ctrl&#43;x，剪贴板无法使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/df4b4d585b3aa7579d4e18501928814a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java程序执行流程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>