<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>微信、支付宝、银联支付 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="微信、支付宝、银联支付" />
<meta property="og:description" content="1.微信支付 1.1 了解微信支付相关基础知识
参考地址：
https://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/ico-guide/chapter1_1.shtml
1.1.1 理解三种账号：
公众平台：服务号、订阅号，统称公众号，和小程序。
商户平台：微信支付。
开放平台：APP、网站、公众号（服务号、订阅号）。
1.1.2 设置相关参数
API密钥（KEY）：用于接口API的签名计算。
APIv3密钥：在微信支付接口V3版本，为了保证安全性，微信支付在回调通知和平台证书下载接口中，对关键信息进行了AES-256-GCM加密。API v3密钥是解密时使用的对称密钥。
支付目录：JSAPI支付（公众号支付）、H5支付都要求发起支付请求的页面域名必须在商户平台配置后才可正常调用微信支付
授权域名：获取用户身份标识openid时，要求请求来源域名必须在公众平台配置过，才被允许获取用户身份标识openid
1.1.3 下载证书
api证书：微信退款的时候会用到
1.1.4 两种模式
普通商户：信息、资金流：微信支付—&gt;直连商户
普通服务商：服务商下可签约特约商户、资金流直接到商户，服务商可以参与分成
1.2 了解微信支付产品
了解完这些可以再了解一下微信的几种方式来确定你需要使用的api文档，微信官方了解地址：
https://pay.weixin.qq.com/static/product/product_index.shtml
1.3 了解微信支付api文档
目前有两版api文档，自助支付的话使用V2版即可，V3版给定制商户使用的。
SDK下载地址：
https://pay.weixin.qq.com/wiki/doc/api/micropay.php?chapter=11_1
开发步骤：
1）获取商户信息：appid、mch_id，如果是服务商，需要签约特殊商户来获取子商户sub_appid和sub_mch_id
2）生成签名，参考https://pay.weixin.qq.com/wiki/doc/api/micropay.php?chapter=4_3，微信SDK会帮你实现
3）包装请求参数：转xml格式，SDK也会帮你实现
4）分析请求结果，然后进行业务处理
5）如果是退款和撤销支付的话，需要携带证书
付款码支付代码参考：
微信配置pojo类参考：实现微信提供的抽象配置类
/** * 商户微信配置信息 */ public class WxPayAppConfig implements WXPayConfig { /** * appID */ private String appID; /** * 商户号 */ private String mchID; /** * API 密钥 */ private String key; /** * API证书绝对路径 (本项目放在了 resources/cert/wxpay/apiclient_cert." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d820d13570a4b13a35658ffe3ef2f068/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-20T17:32:34+08:00" />
<meta property="article:modified_time" content="2020-03-20T17:32:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">微信、支付宝、银联支付</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1_0"></a><strong>1.微信支付</strong></h3> 
<p><strong>1.1 了解微信支付相关基础知识</strong><br> 参考地址：</p> 
<blockquote> 
 <p>https://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/ico-guide/chapter1_1.shtml</p> 
</blockquote> 
<p><strong>1.1.1 理解三种账号：</strong><br> 公众平台：服务号、订阅号，统称公众号，和小程序。<br> 商户平台：微信支付。<br> 开放平台：APP、网站、公众号（服务号、订阅号）。<br> <strong>1.1.2 设置相关参数</strong><br> <strong>API密钥（KEY）</strong>：用于接口API的签名计算。<br> <strong>APIv3密钥</strong>：在<em>微信支付接口V3版本</em>，为了保证安全性，微信支付在回调通知和平台证书下载接口中，对关键信息进行了AES-256-GCM加密。API v3密钥是解密时使用的对称密钥。<br> <strong>支付目录</strong>：JSAPI支付（公众号支付）、H5支付都要求发起支付请求的页面域名必须在商户平台配置后才可正常调用微信支付<br> <strong>授权域名</strong>：获取用户身份标识openid时，要求请求来源域名必须在公众平台配置过，才被允许获取用户身份标识openid<br> <strong>1.1.3 下载证书</strong><br> api证书：微信退款的时候会用到<br> <strong>1.1.4 两种模式</strong><br> 普通商户：信息、资金流：微信支付—&gt;直连商户<br> 普通服务商：服务商下可签约特约商户、资金流直接到商户，服务商可以参与分成</p> 
<p><strong>1.2 了解微信支付产品</strong><br> 了解完这些可以再了解一下微信的几种方式来确定你需要使用的api文档，微信官方了解地址：</p> 
<blockquote> 
 <p>https://pay.weixin.qq.com/static/product/product_index.shtml</p> 
</blockquote> 
<p><strong>1.3 了解微信支付api文档</strong><br> 目前有两版api文档，自助支付的话使用V2版即可，V3版给定制商户使用的。<br> SDK下载地址：</p> 
<blockquote> 
 <p>https://pay.weixin.qq.com/wiki/doc/api/micropay.php?chapter=11_1</p> 
</blockquote> 
<p><strong>开发步骤：</strong><br> 1）获取商户信息：appid、mch_id，如果是服务商，需要签约特殊商户来获取子商户sub_appid和sub_mch_id<br> 2）生成签名，参考https://pay.weixin.qq.com/wiki/doc/api/micropay.php?chapter=4_3，微信SDK会帮你实现<br> 3）包装请求参数：转xml格式，SDK也会帮你实现<br> 4）分析请求结果，然后进行业务处理<br> 5）如果是退款和撤销支付的话，需要携带证书</p> 
<p><strong>付款码支付代码参考：</strong><br> 微信配置pojo类参考：实现微信提供的抽象配置类</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 商户微信配置信息
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxPayAppConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WXPayConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * appID
     */</span>
    <span class="token keyword">private</span> String appID<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 商户号
     */</span>
    <span class="token keyword">private</span> String mchID<span class="token punctuation">;</span>

    <span class="token comment">/**
     * API 密钥
     */</span>
    <span class="token keyword">private</span> String key<span class="token punctuation">;</span>

    <span class="token comment">/**
     * API证书绝对路径 (本项目放在了 resources/cert/wxpay/apiclient_cert.p12")
     */</span>
    <span class="token keyword">private</span> String certPath<span class="token punctuation">;</span>

    <span class="token comment">/**
     * HTTP(S) 连接超时时间，单位毫秒
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> httpConnectTimeoutMs <span class="token operator">=</span> <span class="token number">8000</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * HTTP(S) 读数据超时时间，单位毫秒
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> httpReadTimeoutMs <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 微信支付异步通知地址
     */</span>
    <span class="token keyword">private</span> String payNotifyUrl<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 微信退款异步通知地址
     */</span>
    <span class="token keyword">private</span> String refundNotifyUrl<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取商户证书内容（这里证书需要到微信商户平台进行下载）
     *
     * @return 商户证书内容
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> InputStream <span class="token function">getCertStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>certPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>微信支付代码参考：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 微信付款码支付接口（注：用户付款码条形码规则：18位纯数字，以10、11、12、13、14、15开头）
     *
     * @param key:      商户key           必填
     * @param mchId:    商户mchid       必填
     * @param appId:    商户appid       必填
     * @param authCode: 付款码，     必填
     * @param subMchId: 子商户mchid，有服务商的子商户必填
     * @param orderNo:  订单编号，    必填
     * @param amount:   实际支付金额， 必填
     * @param body:     订单描述       必填
     * @param ip:       请求ip地址，       必填
     * @param certPath: 证书请求路径，必填
     * @return
     */</span>
    <span class="token keyword">public</span> ResultMap <span class="token function">micropay</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> String mchId<span class="token punctuation">,</span> String appId<span class="token punctuation">,</span> String authCode<span class="token punctuation">,</span> String subMchId<span class="token punctuation">,</span> String orderNo<span class="token punctuation">,</span> <span class="token keyword">double</span> amount<span class="token punctuation">,</span> String body<span class="token punctuation">,</span> String ip<span class="token punctuation">,</span> String certPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//        Map&lt;String, String&gt; returnMap = new HashMap&lt;&gt;();</span>
<span class="token comment">//        Map&lt;String, String&gt; responseMap = new HashMap&lt;&gt;();</span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> requestMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ResultMap returnMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResultMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>mchId<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>certPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                wxPayAppConfig<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                wxPayAppConfig<span class="token punctuation">.</span><span class="token function">setMchID</span><span class="token punctuation">(</span>mchId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                wxPayAppConfig<span class="token punctuation">.</span><span class="token function">setAppID</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                wxPayAppConfig<span class="token punctuation">.</span><span class="token function">setCertPath</span><span class="token punctuation">(</span>certPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> wxPayAppConfig<span class="token punctuation">.</span><span class="token function">getCertStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> ResultMap<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"证书路径不对或证书内容为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> ResultMap<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"商户系统参数必填"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            WXPay wxpay <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WXPay</span><span class="token punctuation">(</span>wxPayAppConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>                                     <span class="token comment">// 商品描述</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">,</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">// 商户订单号</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"auth_code"</span><span class="token punctuation">,</span> authCode<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">// 付款码</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"sub_mch_id"</span><span class="token punctuation">,</span> subMchId<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">// 子商户mchId</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"total_fee"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>amount <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 总金额</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"spbill_create_ip"</span><span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">// 终端IP</span>
<span class="token comment">//            requestMap.put("notify_url", wxPayAppConfig.getPayNotifyUrl());   // 接收微信支付异步通知回调地址</span>
<span class="token comment">//            Map&lt;String, String&gt; resultMap = wxpay.microPay(requestMap); //直接支付，若是没有输密码，或是其他原因没有重试机制</span>
            Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">microPayWithPos</span><span class="token punctuation">(</span>requestMap<span class="token punctuation">,</span> wxpay<span class="token punctuation">,</span> wxPayAppConfig<span class="token punctuation">.</span><span class="token function">getHttpConnectTimeoutMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获取返回码</span>
            String returnCode <span class="token operator">=</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"return_code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String returnMsg <span class="token operator">=</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"return_msg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//若返回码为SUCCESS，则会返回一个result_code,再对该result_code进行判断</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"SUCCESS"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>returnCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String resultCode <span class="token operator">=</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"result_code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String errCodeDes <span class="token operator">=</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"err_code_des"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"SUCCESS"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>resultCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"订单号：{}，交易金额：{}"</span><span class="token punctuation">,</span> orderNo<span class="token punctuation">,</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"cash_fee"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    returnMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> resultMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"FAIL"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>resultCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"订单号：{}，错误描述：{}"</span><span class="token punctuation">,</span> orderNo<span class="token punctuation">,</span> errCodeDes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    returnMap <span class="token operator">=</span> ResultMap<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>errCodeDes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"USERPAYING"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>resultCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"订单号：{}，错误描述：{}"</span><span class="token punctuation">,</span> orderNo<span class="token punctuation">,</span> errCodeDes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    returnMap <span class="token operator">=</span> ResultMap<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>errCodeDes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"订单号：{}，错误描述：{}"</span><span class="token punctuation">,</span> orderNo<span class="token punctuation">,</span> returnMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                returnMap <span class="token operator">=</span> ResultMap<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>returnMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> returnMap<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"订单号：{}，错误信息：{}"</span><span class="token punctuation">,</span> orderNo<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ResultMap<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"微信付款码支付失败"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 提交刷卡支付，针对软POS，尽可能做成功
     * 内置重试机制，最多60s
     *
     * @param reqData
     * @param connectTimeoutMs
     * @return
     * @throws Exception
     */</span>
    <span class="token keyword">public</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> <span class="token function">microPayWithPos</span><span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> reqData<span class="token punctuation">,</span> WXPay wxpay<span class="token punctuation">,</span> <span class="token keyword">int</span> connectTimeoutMs<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> remainingTimeMs <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> startTimestampMs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> lastResult <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Exception lastException <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            startTimestampMs <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">;</span>
            <span class="token keyword">int</span> readTimeoutMs <span class="token operator">=</span> remainingTimeMs <span class="token operator">-</span> connectTimeoutMs<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>readTimeoutMs <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    lastResult <span class="token operator">=</span> wxpay<span class="token punctuation">.</span><span class="token function">microPay</span><span class="token punctuation">(</span>reqData<span class="token punctuation">,</span> connectTimeoutMs<span class="token punctuation">,</span> readTimeoutMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    String returnCode <span class="token operator">=</span> lastResult<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"return_code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        String resultCode <span class="token operator">=</span> lastResult<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"result_code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        String errCode <span class="token operator">=</span> lastResult<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"err_code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// 看错误码，若支付结果未知，则重试提交刷卡支付</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>errCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"SYSTEMERROR"</span><span class="token punctuation">)</span> <span class="token operator">||</span> errCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"BANKERROR"</span><span class="token punctuation">)</span> <span class="token operator">||</span> errCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"USERPAYING"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                remainingTimeMs <span class="token operator">=</span> remainingTimeMs <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTimestampMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>remainingTimeMs <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"microPayWithPos: "</span> <span class="token operator">+</span> errCode <span class="token operator">+</span> <span class="token string">"----try micropay again"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>remainingTimeMs <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                HashMap<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> requestMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">,</span> reqData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                wxpay<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span>requestMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        HashMap<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> requestMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">,</span> reqData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        wxpay<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span>requestMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    lastResult <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    lastException <span class="token operator">=</span> ex<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastResult <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> lastException<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> lastResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>微信退款代码参考：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 微信付款码支付退款
     *
     * @param key:           商户key           必填
     * @param mchId:         商户mchid       必填
     * @param appId:         商户appid       必填
     * @param subMchId:      子商户mchid，有服务商的子商户必填
     * @param orderNo:       订单编号       二选一，次选
     * @param transactionId: 微信订单号 二选一，优选
     * @param totalFee:      订单金额     必填
     * @param refundFee:     申请退款金额   必填
     * @param refundReason:  退款原因
     * @param outRefundNo:   退款订单号    必填
     * @param certPath:      证书路径，服务商的商户是服务商的证书，普通商户是商户的证书   必填
     * @return
     */</span>
    <span class="token keyword">public</span> ResultMap <span class="token function">refund</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> String mchId<span class="token punctuation">,</span> String appId<span class="token punctuation">,</span> String subMchId<span class="token punctuation">,</span> String orderNo<span class="token punctuation">,</span> String transactionId<span class="token punctuation">,</span> <span class="token keyword">double</span> totalFee<span class="token punctuation">,</span> <span class="token keyword">double</span> refundFee<span class="token punctuation">,</span> String refundReason<span class="token punctuation">,</span> String outRefundNo<span class="token punctuation">,</span> String certPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        ResultMap returnMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResultMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> ResultMap<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"订单编号不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>refundFee <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> ResultMap<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"退款金额必须大于0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>mchId<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>certPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            wxPayAppConfig<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            wxPayAppConfig<span class="token punctuation">.</span><span class="token function">setMchID</span><span class="token punctuation">(</span>mchId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            wxPayAppConfig<span class="token punctuation">.</span><span class="token function">setAppID</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            wxPayAppConfig<span class="token punctuation">.</span><span class="token function">setCertPath</span><span class="token punctuation">(</span>certPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> wxPayAppConfig<span class="token punctuation">.</span><span class="token function">getCertStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> ResultMap<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"证书路径不对或证书内容为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> ResultMap<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"商户系统参数必填"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> responseMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> requestMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        WXPay wxpay <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WXPay</span><span class="token punctuation">(</span>wxPayAppConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"transaction_id"</span><span class="token punctuation">,</span> transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">,</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"sub_mch_id"</span><span class="token punctuation">,</span> subMchId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"out_refund_no"</span><span class="token punctuation">,</span> outRefundNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"total_fee"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>totalFee <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"refund_fee"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>refundFee <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//所需退款金额</span>
        requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"refund_desc"</span><span class="token punctuation">,</span> refundReason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            responseMap <span class="token operator">=</span> wxpay<span class="token punctuation">.</span><span class="token function">refund</span><span class="token punctuation">(</span>requestMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String return_code <span class="token operator">=</span> responseMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"return_code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//返回状态码</span>
        String return_msg <span class="token operator">=</span> responseMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"return_msg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//返回信息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"SUCCESS"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>return_code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            String result_code <span class="token operator">=</span> responseMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"result_code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//业务结果</span>
            String err_code_des <span class="token operator">=</span> responseMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"err_code_des"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//错误代码描述</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"SUCCESS"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>result_code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//表示退款申请接受成功，结果通过退款查询接口查询</span>
                <span class="token comment">//修改用户订单状态为退款申请中或已退款。退款异步通知根据需求，可选</span>
                <span class="token comment">//</span>
                <span class="token keyword">return</span> returnMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"date"</span><span class="token punctuation">,</span> responseMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"订单号:{}错误信息:{}"</span><span class="token punctuation">,</span> orderNo<span class="token punctuation">,</span> err_code_des<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ResultMap<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err_code_des<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"订单号:{}错误信息:{}"</span><span class="token punctuation">,</span> orderNo<span class="token punctuation">,</span> return_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ResultMap<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>return_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p>以上是微信支付部分讲解。</p> 
<h3><a id="2_329"></a>2.支付宝支付</h3> 
<p><strong>2.1 商户入驻支付宝并创建应用</strong><br> 官方参考指南：</p> 
<blockquote> 
 <p>https://opendocs.alipay.com/open/200/105304</p> 
</blockquote> 
<p>自己整理参考指南：https://blog.csdn.net/weixin_42556829/article/details/105051497<br> 主要为了使商户入驻支付宝，创建属于自己的收款应用，产生1.APPID 2.支付宝公钥 3.商户应用公钥 4.商户应用私钥，用户后面支付的商户配置信息。<br> <strong>2.2 开发参考指南</strong><br> 支付宝SDK下载地址</p> 
<blockquote> 
 <p>https://opendocs.alipay.com/open/194/105201</p> 
</blockquote> 
<p>支付宝支付API官方地址：</p> 
<blockquote> 
 <p>https://opendocs.alipay.com/apis/api_1/alipay.trade.pay</p> 
</blockquote> 
<p>个人感觉api有点乱，可以从产品介绍找对应的接口地址比较好一点，参考：<em>https://opendocs.alipay.com/open/194/105072</em></p> 
<p><strong>2.3 代码参考</strong></p> 
<p>支付宝支付代码：</p> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String ALIPAY_TRADE_GATEWAY <span class="token operator">=</span> <span class="token string">"https://openapi.alipay.com/gateway.do"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SIGN_TYPE <span class="token operator">=</span> <span class="token string">"MD5"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String INPUT_CHARSET <span class="token operator">=</span> <span class="token string">"utf-8"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String PRODUCT_CODE <span class="token operator">=</span> <span class="token string">"BARCODE_PAY_OFFLINE"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String DYNAMIC_ID_TYPE <span class="token operator">=</span> <span class="token string">"barcode"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String FORMAT <span class="token operator">=</span> <span class="token string">"JSON"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SCENE <span class="token operator">=</span> <span class="token string">"bar_code"</span><span class="token punctuation">;</span>
    
<span class="token comment">/**
     * 支付宝付款码支付
     * @param appId：商户appid
     * @param privateKey：商户私钥
     * @param alipayPulicKey：支付宝公钥
     * @param outTradeNo：订单号
     * @param authCode：付款码
     * @param totalAmount：支付金额，单位元
     * @param subject：订单标题，                     以上必填
     * @param alipayServicePid：系统商编号  isv服务商下的商户可填
     * 该参数作为系统商返佣数据提取的依据，请填写系统商签约协议的PID
     * @param alipayStoreId：口碑门店id，若没有为null
     * @param alipaySignType：生成签名的算法类型，默认：RSA，阿里推荐RSA2
     * @param scene：支付场景：默认bar_code，条码支付
     * @param appAuthToken：第三方应用授权token，ISV服务商下的商户可填
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> ResultMap <span class="token function">tradePayRequest</span><span class="token punctuation">(</span>String appId<span class="token punctuation">,</span> String privateKey<span class="token punctuation">,</span> String alipayPulicKey<span class="token punctuation">,</span> String outTradeNo<span class="token punctuation">,</span> String authCode<span class="token punctuation">,</span> String totalAmount<span class="token punctuation">,</span> String subject<span class="token punctuation">,</span> String alipayServicePid<span class="token punctuation">,</span> String alipayStoreId<span class="token punctuation">,</span> String alipaySignType<span class="token punctuation">,</span> String scene<span class="token punctuation">,</span> String appAuthToken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        AlipayClient alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span>ALIPAY_TRADE_GATEWAY<span class="token punctuation">,</span> appId<span class="token punctuation">,</span> privateKey<span class="token punctuation">,</span> FORMAT<span class="token punctuation">,</span> INPUT_CHARSET<span class="token punctuation">,</span> alipayPulicKey<span class="token punctuation">,</span>alipaySignType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        AlipayTradePayRequest payRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradePayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>scene<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            scene <span class="token operator">=</span> SCENE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> requestMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">,</span> outTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"scene"</span><span class="token punctuation">,</span> scene<span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"auth_code"</span><span class="token punctuation">,</span> authCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"total_amount"</span><span class="token punctuation">,</span> totalAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"subject"</span><span class="token punctuation">,</span> subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>alipayStoreId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"alipay_store_id"</span><span class="token punctuation">,</span> alipayStoreId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>appAuthToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"app_auth_token"</span><span class="token punctuation">,</span> appAuthToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>alipayServicePid<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> extendParamsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            extendParamsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"sys_service_provider_id"</span><span class="token punctuation">,</span> alipayServicePid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"extend_params"</span><span class="token punctuation">,</span> extendParamsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            payRequest<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>requestMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"AlipayTradeUtils.tradePayRequest - Map转Json异常 - "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" - "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            AlipayTradePayResponse response <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>payRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token string">"10000"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResultMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> ResultMap<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>response<span class="token operator">!=</span>null<span class="token operator">?</span>response<span class="token punctuation">.</span><span class="token function">getSubMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token string">"支付失败，支付宝未返回。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AlipayApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"AlipayTradeUtils.tradePayRequest - 获取Response异常 - "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" - "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ResultMap<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" - "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3_418"></a>3.银联支付</h3> 
<p><strong>1.商户注册</strong><br> 进行商户注册获取配置信息，参考地址：</p> 
<blockquote> 
 <p>https://ump.chinaums.com/v2/pages/perp/mobileRegist.jsp?id=10059</p> 
</blockquote> 
<p><strong>2.开发文档</strong><br> 开发API参考地址：</p> 
<blockquote> 
 <p>https://open.chinaums.com/resources/?code=151539797785864&amp;url=b7abc3a6-0c49-43d4-ad7d-f6dd16ff35eb</p> 
</blockquote> 
<p>SDK下载地址：https://open.chinaums.com/resources/?code=101528298407846&amp;url=8838eff5-3809-4f8e-aae2-2c5b00ef265e<br> 各种支付方式的API参考文档地址：https://open.chinaums.com/resources/?code=651539656974952&amp;url=b7abc3a6-0c49-43d4-ad7d-f6dd16ff35eb</p> 
<p><strong>3.代码参考</strong></p> 
<pre><code class="prism language-java"><span class="token comment">//    private String umsUrl = "http://58.247.0.18:29015/"</span>
<span class="token comment">//    private String umsUrl = "https://api-mop.chinaums.com/"</span>
    <span class="token keyword">private</span> String umsUrl <span class="token operator">=</span> PropertyUtils<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token string">"ums.umsUrl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 银联B2C扫码支付
     * @param params
     * @return
     */</span>
    def <span class="token function">umsPay</span><span class="token punctuation">(</span>Map params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        LogUtil<span class="token punctuation">.</span><span class="token function">logInfo</span><span class="token punctuation">(</span><span class="token string">"银联扫码支付参："</span> <span class="token operator">+</span> <span class="token punctuation">(</span>params as JSON<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        String enabled <span class="token operator">=</span> PropertyUtils<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token string">"ums.enabled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>enabled<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> enabled<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApiRest</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"银联支付服务已停止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ApiRest r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApiRest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String url <span class="token operator">=</span> umsUrl<span class="token punctuation">;</span>
<span class="token comment">//        String url = "https://test-api-open.chinaums.com/";</span>

        <span class="token comment">//交易金额</span>
        String transactionAmount <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"transactionAmount"</span><span class="token punctuation">)</span>
        <span class="token comment">//交易币种:156</span>
        String transactionCurrencyCode <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"transactionCurrencyCode"</span><span class="token punctuation">)</span>
        <span class="token comment">//商户订单号</span>
        String merchantOrderId <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"merchantOrderId"</span><span class="token punctuation">)</span>
        <span class="token comment">//商户备注</span>
        String merchantRemark <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"merchantRemark"</span><span class="token punctuation">)</span>
        <span class="token comment">//支付方式，E_CASH – 电子现金，SOUNDWAVE– 声波，NFC – NFC，CODE_SCAN– 扫码，MANUAL –手输</span>
        String payMode <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"payMode"</span><span class="token punctuation">)</span>
        <span class="token comment">//支付码</span>
        String payCode <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"payCode"</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>transactionAmount<span class="token punctuation">)</span><span class="token operator">||</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>transactionCurrencyCode<span class="token punctuation">)</span><span class="token operator">||</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>merchantOrderId<span class="token punctuation">)</span><span class="token operator">||</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>merchantRemark<span class="token punctuation">)</span><span class="token operator">||</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>payMode<span class="token punctuation">)</span><span class="token operator">||</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>payCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> ApiRest<span class="token punctuation">.</span>INVALID_PARAMS_ERROR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//获取商户支付信息 开始</span>
            SysPayAccount sysPayAccount <span class="token operator">=</span> <span class="token function">findSysPayAccount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"tenantId"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"branchId"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"pBranchId"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"umsPay"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sysPayAccount <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                r<span class="token punctuation">.</span><span class="token function">setIsSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
                r<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token string">"NOACCOUNT"</span><span class="token punctuation">)</span>
                r<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span><span class="token string">"商户未开通或未设置支付宝支付功能"</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> r<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            LogUtil<span class="token punctuation">.</span><span class="token function">logInfo</span><span class="token punctuation">(</span><span class="token string">"银联支付账号："</span> <span class="token operator">+</span> <span class="token punctuation">(</span>sysPayAccount as JSON<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">savePayLogEvent</span><span class="token punctuation">(</span><span class="token string">"PayService.umsPay"</span><span class="token punctuation">,</span> <span class="token string">"银联扫码支付："</span> <span class="token operator">+</span> <span class="token punctuation">(</span>sysPayAccount as JSON<span class="token punctuation">)</span><span class="token punctuation">,</span> sysPayAccount<span class="token punctuation">.</span>umsMid<span class="token punctuation">,</span> sysPayAccount<span class="token punctuation">.</span>tenantId<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

            <span class="token comment">//开发者ID</span>
            String appId <span class="token operator">=</span> sysPayAccount<span class="token punctuation">.</span><span class="token function">getUmsAppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//开发者秘钥</span>
            String appKey <span class="token operator">=</span> sysPayAccount<span class="token punctuation">.</span><span class="token function">getUmsAppkey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//商户号</span>
            String merchantCode <span class="token operator">=</span> sysPayAccount<span class="token punctuation">.</span><span class="token function">getUmsMid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//终端编号</span>
            String terminalCode <span class="token operator">=</span> sysPayAccount<span class="token punctuation">.</span><span class="token function">getUmsTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment">//transactionCurrencyCode</span>
<span class="token comment">//            String transactionCurrencyCode = "156"</span>
<span class="token comment">//            String payMode = "CODE_SCAN"</span>
            <span class="token comment">//获取access token</span>
<span class="token comment">//            String accessToken = CacheUtils.get("_ums_access_token:"+(String) params.get("branchId"))</span>
<span class="token comment">//            if (StringUtils.isEmpty(accessToken)){<!-- --></span>
<span class="token comment">//                TokenResponse tokenResponse = getUmsToken(appId, appKey, url)</span>
<span class="token comment">//                accessToken = tokenResponse.getAccessToken()</span>
<span class="token comment">//                CacheUtils.set("_ums_access_token:"+(String) params.get("branchId"),accessToken,3000)</span>
<span class="token comment">//            }</span>

            <span class="token comment">//实例化客户端</span>
            OpenApiClient openApiClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultOpenApiClient</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> appId<span class="token punctuation">,</span> appKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//根据请求接口拼装参数</span>
            UmsPayRequest umsPayRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UmsPayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            def requestMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"merchantCode"</span><span class="token punctuation">,</span> merchantCode<span class="token punctuation">)</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"terminalCode"</span><span class="token punctuation">,</span> terminalCode<span class="token punctuation">)</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"transactionCurrencyCode"</span><span class="token punctuation">,</span> transactionCurrencyCode<span class="token punctuation">)</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"payMode"</span><span class="token punctuation">,</span> payMode<span class="token punctuation">)</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"transactionAmount"</span><span class="token punctuation">,</span> transactionAmount<span class="token punctuation">)</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"merchantRemark"</span><span class="token punctuation">,</span> merchantRemark<span class="token punctuation">)</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"merchantOrderId"</span><span class="token punctuation">,</span> merchantOrderId<span class="token punctuation">)</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"payCode"</span><span class="token punctuation">,</span> payCode<span class="token punctuation">)</span>
            requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"storeId"</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"branchId"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment">//商品信息,数组-JSON</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"goods"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"goods"</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"goods"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//商户冗余信息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"srcReserved"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"srcReserved"</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"srcReserved"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//是否限制信用卡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"limitCreditCard"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"limitCreditCard"</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"limitCreditCard"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//操作员编号</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"operatorId"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"operatorId"</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"operatorId"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//业务标识，标识接入的具体业务，除非特殊说明，一般不需要上送</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"bizIdentifier"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bizIdentifier"</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"bizIdentifier"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//商品标识</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"goodsTag"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"goodsTag"</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"goodsTag"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            umsPayRequest<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">(</span>requestMap as JSON<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//            if (StringUtils.isNotEmpty(accessToken)){<!-- --></span>
<span class="token comment">//                umsPayRequest.setNeedToken(false)</span>
<span class="token comment">//            }</span>
            <span class="token comment">//请求调用返回</span>
            BankVerifyResponse bankVerifyResponse <span class="token operator">=</span> openApiClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>umsPayRequest<span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            System.out.print("PayService.umsPay,返回结果"+bankVerifyResponse.data)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"00"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>bankVerifyResponse<span class="token punctuation">.</span>errCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//返回处理 示例仅对于当前接口，具体返回格式处理，请以真实接口为准进行处理</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>bankVerifyResponse<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>bankVerifyResponse<span class="token punctuation">.</span><span class="token function">getResultCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>bankVerifyResponse<span class="token punctuation">.</span><span class="token function">getResultInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//保存订单记录</span>
                com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>JSONObject parse <span class="token operator">=</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>bankVerifyResponse<span class="token punctuation">.</span>errInfo<span class="token punctuation">)</span>
                <span class="token function">savePayInfo</span><span class="token punctuation">(</span>parse<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"thirdPartyBuyerId"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parse<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"orderId"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"merchantOrderId"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> params<span class="token punctuation">[</span><span class="token string">"payCode"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> params<span class="token punctuation">[</span><span class="token string">"tenantId"</span><span class="token punctuation">]</span> <span class="token operator">?</span> params<span class="token punctuation">[</span><span class="token string">"tenantId"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asType</span><span class="token punctuation">(</span>BigInteger<span class="token punctuation">)</span> <span class="token operator">:</span> BigInteger<span class="token punctuation">.</span>ZERO<span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"branchId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asType</span><span class="token punctuation">(</span>BigInteger<span class="token punctuation">)</span><span class="token punctuation">,</span> parse<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"transactionAmount"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asType</span><span class="token punctuation">(</span>BigDecimal<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">,</span> params<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span><span class="token operator">?</span>params<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asType</span><span class="token punctuation">(</span>Integer<span class="token punctuation">)</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> params<span class="token punctuation">[</span><span class="token string">"opFrom"</span><span class="token punctuation">]</span> <span class="token operator">?</span> params<span class="token punctuation">[</span><span class="token string">"opFrom"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asType</span><span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span>
                r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApiRest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                r<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">"银联支付成功"</span>
                r<span class="token punctuation">.</span>data <span class="token operator">=</span> bankVerifyResponse<span class="token punctuation">.</span>errInfo
                r<span class="token punctuation">.</span>code <span class="token operator">=</span> bankVerifyResponse<span class="token punctuation">.</span>errCode
                r<span class="token punctuation">.</span>isSuccess <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApiRest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                r<span class="token punctuation">.</span>isSuccess <span class="token operator">=</span> <span class="token boolean">false</span>
                r<span class="token punctuation">.</span>code <span class="token operator">=</span> bankVerifyResponse<span class="token punctuation">.</span>errCode
                r<span class="token punctuation">.</span>data <span class="token operator">=</span> bankVerifyResponse<span class="token punctuation">.</span>errInfo
                r<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">"银联支付失败"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>isSuccess <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">"银联支付异常"</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>error <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            LogUtil<span class="token punctuation">.</span><span class="token function">logError</span><span class="token punctuation">(</span><span class="token string">"PayService.umsPay for Usages in All Places...(${params}) - ${e.getMessage()}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d33698dfe9e4953a3caa12047b4a961e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【论文阅读】LIME：Low-light Image Enhancement via Illumination Map Estimation(笔记最全篇）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4946e3070f3525456bb8601a3514544a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">第六章 异常机制（尚学堂java300集笔记，含自写编程题答案）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>