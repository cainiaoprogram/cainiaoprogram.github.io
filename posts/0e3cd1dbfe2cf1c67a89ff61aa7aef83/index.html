<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STP总结 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STP总结" />
<meta property="og:description" content="生成树协议：
企业网三层架构—》冗余----》线路冗余—》二层桥接环路
导致问题：
1、广播风暴
2、MAC地址表翻滚 —在一台交换机上，同一个MAC地址只能映射唯一的接口；但同一个接口可以映射多个不同的MAC地址；
3、同一数据帧的重复拷贝
4、以上3个条件最终导致设备工作过载，导致重启保护
生成树：在一个二层交换网络中，生成一棵树型结构，逻辑的阻塞部分接口，使得从根到所有的节点仅存在唯一的路径；当最佳路径故障时，自动打开部分阻塞端口，来实现线路备份的作用；
生成树在生成过程中，应该尽量的生成一棵星型结构，且最短路径树；
存在算法： 802.1D PVST PVST&#43;(CISCO) RSTP(802.1w) MSTP(802.1S)
一、802.1D 一个交换网络内仅存在一棵生成树实例；
交换机间使用BPDU—桥协议数据单元 – 交换机间沟通互动收发的数据
配置BPDU—只有根网桥可以发送，在交换网络初始状态时，所有交换机均定义本地为根网桥，进行BPDU的发送；使得网络中所有交换机均收到其他设备的BPDU，之后基于数据中的参数进行比对，选举出根网桥；再所有非根网桥不再发送BPDU，而是仅接收和转发根网桥的BPDU；周期2s发送，hold time 20s；
TCN—拓扑变更消息（也是BPDU）： 本地交换机链路故障后，STP重新收敛，为了快速刷新全网所有交换机的MAC表，将向本地所有STP接口发送TCN（标记位中的TCN位置1），邻居交换机收到TCN后，先标记为ACK位为回复，用于可靠传输消息；之后将TCN逐级转发到根网桥处，由根网桥回复TC消息来逐级回复到所有交换机；使所有交换机临时将MAC表的老换时间修改为15s（默认的，转发延时）
选举— 根网桥 根端口 指定端口 非指定端口（阻塞端口）
【1】根网桥 – 在一棵生成树实例中，有且仅有一台交换机为root；
BPDU中的桥ID来决定
桥ID= 网桥优先级（0-65535公有） 默认32768 &#43; MAC地址（只有存在svi接口的交换机才拥有mac地址，若存在多个mac选数值最小）
根网桥的选举 先比较优先级，小优； 若优先级相同，比较mac，数值小优；
即1、比较BPDU中的BID=网桥优先级&#43;MAC地址（背板地址池中数值最小一透明交换机无MAC二层交换机存在一个三层以上交换机存在多个)
网桥优先级0-65535默认32768越小越好
先比较网桥优先级，数值越小越好
若优先级相同,比较mac地址，数值越来越小
PID=端口ID=接口优先级&#43;接口编号优先级O-255 默认128新折
【2】根端口—在每台非根网桥上，有且仅有一个接口；本地离根网桥最近的接口（最短、星型），接收来自根网桥的BPDU，转发用户的流量（该接口不阻塞）
规则：
1、比较从根网桥发出后，通过该接口进入时最小的cost值；
2、入向cost值相同，比较该接口对端设备的BID，小优
3、对端BID也相同，比较该接口对端设备的接口的PID；先优先级小，若优先级一致，编号小
4、连对端PID也相同，比较本地PID，小优；
PID=端口ID 接口优先级（0-240，步长16，默认128） 接口编号
【3】指定端口，在每一段存在STP的物理链路上，有且仅有一个；转发来自根网桥的BPDU，同时可以转发用户流量（不阻塞）；默认根网桥上所有接口为指定端口；
1、比较从根网桥发出后，通过该接口进入这段链路时的cost值最小（出向）
2、若出向cost值相同，必须本地的BID，小优；
3、本地BID相同，比较本地的PID；
4、本地PID，相同，直接阻塞该端口；
【4】非指定端口（阻塞端口）当以上所有角色全部选举完成后，剩余没有任何角色的接口为非指定；
该接口逻辑阻塞，实际可以接收到信息，但不转发；
cost值：不同带宽 存在不同cost
802.1d标准： 802.1T标准" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0e3cd1dbfe2cf1c67a89ff61aa7aef83/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-22T15:17:52+08:00" />
<meta property="article:modified_time" content="2023-08-22T15:17:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STP总结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>生成树协议：<br> 企业网三层架构—》冗余----》线路冗余—》二层桥接环路<br> 导致问题：<br> 1、广播风暴<br> 2、MAC地址表翻滚 —在一台交换机上，同一个MAC地址只能映射唯一的接口；但同一个接口可以映射多个不同的MAC地址；<br> 3、同一数据帧的重复拷贝<br> 4、以上3个条件最终导致设备工作过载，导致重启保护</p> 
<p>生成树：在一个二层交换网络中，生成一棵树型结构，逻辑的阻塞部分接口，使得从根到所有的节点仅存在唯一的路径；当最佳路径故障时，自动打开部分阻塞端口，来实现线路备份的作用；<br> 生成树在生成过程中，应该尽量的生成一棵星型结构，且最短路径树；<br> 存在算法： 802.1D PVST PVST+(CISCO) RSTP(802.1w) MSTP(802.1S)</p> 
<p>一、802.1D 一个交换网络内仅存在一棵生成树实例；<br> 交换机间使用BPDU—桥协议数据单元 – 交换机间沟通互动收发的数据</p> 
<p>配置BPDU—只有根网桥可以发送，在交换网络初始状态时，所有交换机均定义本地为根网桥，进行BPDU的发送；使得网络中所有交换机均收到其他设备的BPDU，之后基于数据中的参数进行比对，选举出根网桥；再所有非根网桥不再发送BPDU，而是仅接收和转发根网桥的BPDU；周期2s发送，hold time 20s；</p> 
<p>TCN—拓扑变更消息（也是BPDU）： 本地交换机链路故障后，STP重新收敛，为了快速刷新全网所有交换机的MAC表，将向本地所有STP接口发送TCN（标记位中的TCN位置1），邻居交换机收到TCN后，先标记为ACK位为回复，用于可靠传输消息；之后将TCN逐级转发到根网桥处，由根网桥回复TC消息来逐级回复到所有交换机；使所有交换机临时将MAC表的老换时间修改为15s（默认的，转发延时）</p> 
<p>选举— 根网桥 根端口 指定端口 非指定端口（阻塞端口）</p> 
<p>【1】根网桥 – 在一棵生成树实例中，有且仅有一台交换机为root；<br> BPDU中的桥ID来决定<br> 桥ID= 网桥优先级（0-65535公有） 默认32768 + MAC地址（只有存在svi接口的交换机才拥有mac地址，若存在多个mac选数值最小）<br> 根网桥的选举 先比较优先级，小优； 若优先级相同，比较mac，数值小优；<br> 即1、比较BPDU中的BID=网桥优先级+MAC地址（背板地址池中数值最小一透明交换机无MAC二层交换机存在一个三层以上交换机存在多个)<br> 网桥优先级0-65535默认32768越小越好<br> 先比较网桥优先级，数值越小越好<br> 若优先级相同,比较mac地址，数值越来越小<br> PID=端口ID=接口优先级+接口编号优先级O-255 默认128新折</p> 
<p>【2】根端口—在每台非根网桥上，有且仅有一个接口；本地离根网桥最近的接口（最短、星型），接收来自根网桥的BPDU，转发用户的流量（该接口不阻塞）</p> 
<p>规则：<br> 1、比较从根网桥发出后，通过该接口进入时最小的cost值；<br> 2、入向cost值相同，比较该接口对端设备的BID，小优<br> 3、对端BID也相同，比较该接口对端设备的接口的PID；先优先级小，若优先级一致，编号小<br> 4、连对端PID也相同，比较本地PID，小优；<br> PID=端口ID 接口优先级（0-240，步长16，默认128） 接口编号</p> 
<p>【3】指定端口，在每一段存在STP的物理链路上，有且仅有一个；转发来自根网桥的BPDU，同时可以转发用户流量（不阻塞）；默认根网桥上所有接口为指定端口；<br> 1、比较从根网桥发出后，通过该接口进入这段链路时的cost值最小（出向）<br> 2、若出向cost值相同，必须本地的BID，小优；<br> 3、本地BID相同，比较本地的PID；<br> 4、本地PID，相同，直接阻塞该端口；<br> 【4】非指定端口（阻塞端口）当以上所有角色全部选举完成后，剩余没有任何角色的接口为非指定；<br> 该接口逻辑阻塞，实际可以接收到信息，但不转发；</p> 
<p>cost值：不同带宽 存在不同cost<br> 802.1d标准： 802.1T标准<br> 10M = 100 1000M= 20000<br> 100M=19 100M=200000<br> 1000M=4<br> 10000M=2</p> 
<p>100000M=1</p> 
<p>[SWA]stp pathcost-standard ? 默认华为使用802.1t标准<br> dot1d-1998 IEEE 802.1D-1998<br> dot1t IEEE 802.1T<br> legacy Legacy</p> 
<p>生成协议中，至少应该将根网桥干涉到汇聚层处；</p> 
<p>接口状态：<br> down：没有BPDU收发，一旦可以进行BPDU收发进入下一状态<br> 侦听：强制15s；所有交换机进行BPDU收发，选举所有角色；接口角色为非指定端口直接进入阻塞状态；<br> 若为指定端口和根端口进入下一状态；<br> 学习：强制15s； 指定端口和根端口学习所有接口连接设备的MAC地址，生成MAC表；之后进入下一状<br> 态；<br> 转发：指端端口和根端口进入，可以转发用户报文；<br> 阻塞：逻辑阻塞；<br> 注：只有到接口进入到转发状态后，才能为用户转发数据报文，之前的30s不能转发任何数据；</p> 
<p>收敛时间：<br> 初次收敛—30s = 15侦听+15s学习<br> 结构变化：<br> 存在直连检测：本地存在阻塞端口，若其他端口断开，该阻塞端口马上进入15是侦听（选举）；结果若为<br> 启用，那么将再进入15s学习—总30s<br> 没有直连检测：本地不存在阻塞端口，若某个端口断开，将发送次优BPDU（以本地为根）给其他邻居交换机，其他交换机无视该数据，进行20s hold time计时，到时时阻塞接口进入15s侦听，15s学习=总50s</p> 
<p>802.1D 缺点：<br> 1、收敛慢<br> 2、链路利用率低</p> 
<p>802.1配置命令：<br> [sw1]stp mode stp 修改为802.1d算法，当下华为默认为MSTP；<br> [sw1]stp priority 4096 修改网桥优先级</p> 
<p>[sw1-GigabitEthernet0/0/1]stp cost ? 修改接口cost值<br> INTEGER&lt;1-200000000&gt; Port path cost</p> 
<p>[sw1-GigabitEthernet0/0/1]stp port priority ? 修改接口优先级<br> INTEGER&lt;0-240&gt; Port priority, in steps of 16<br> 二、PVST cisco私有 基于vlan的生成树协议<br> 在每个vlan内，存在一棵树，每个树的工作原理同802.1d一致；不同vlan的BPDU区别在于优先级；<br> 优先级=4096倍数+vlan id 人为仅可修改4096倍数备份，且只能修改为4096的整倍<br> 仅支持 trunk干道封装为ISL（cisco私有封装）</p> 
<p>三、PVST + 在PVST的基础，兼容802.1q的trunk封装；且设计了部分的加速；<br> 端口加速（进入层连接用户的接口） 上行链路加速-针对直连检测 骨干加速—针对次优BPDU<br> 缺点：1、收敛慢（加速不彻底） 2、树多（仅cisco存在单独的芯片，友商无法负荷）</p> 
<p>四、快速生成树<br> cisco的RSTP — 基于vlan的快速生成树 - 一个vlan一棵树 pvst+的升级<br> 公有RSTP（802.1w） — 整个交换网络一棵树 802.1d的升级<br> 快速的原理：<br> 1、取消了计时器，而是在一个状态工作完成后，直接进入下一状态；<br> 2、分段式同步，两台设备间逐级收敛；使用请求和同意标记；依赖标记位的第1和第6位<br> 3、BPDU的保活为6s；hello time 2s；<br> 4、将端口加速（边缘接口）、上行链路加速、骨干加速集成了<br> 5、兼容802.1d和PVST，但802.1d和PVST没有使用标记位中的第1-6位，故不能快速收敛；因此如果网络中有一台设备不支持快速收敛，那么其他开启快速收敛的设备也不能快速；<br> 当tcn消息出现时，不需要等待根网桥的BPDU，就可以刷新本地的cam表；</p> 
<p>切记:接口默认为半双工时，即便允许RSTP，依然基于慢速的802.1D算法来收敛；<br> [sw1]stp mode rstp<br> 边缘接口—用于连接PC的接口，一旦被设定为边缘接口；将不再进行BPDU的发送，且不进行STP的收敛，直接为转发状态； 但若该接口收到了对端的BPDU，将失去边缘特性，重新正常收敛；<br> [sw1]interface GigabitEthernet 0/0/1<br> [sw1-GigabitEthernet0/0/1]stp edged-port enable</p> 
<p>[sw1]stp priority ? 修改网桥优先级<br> INTEGER&lt;0-61440&gt; Bridge priority, in steps of 4096</p> 
<p>[sw1]stp root ? 快速定义根网桥角色<br> primary Primary root switch<br> secondary Secondary root switch</p> 
<p>[sw1-GigabitEthernet0/0/1]stp port priority ? 修改接口优先级<br> INTEGER&lt;0-240&gt; Port priority, in steps of 16</p> 
<p>[sw1-GigabitEthernet0/0/1]stp cost ? 修改接口cost<br> INTEGER&lt;1-200000000&gt; Port path cost</p> 
<p>五、MSTP/MST/802.1S 华为设备默认使用该协议<br> 继承了快速生成树的基础； 将多个vlan放置于一个组内，基于每个组一棵生成树；<br> 不同组间的BPDU中优先级= 4096倍数+组号<br> [r1]stp mode mstp<br> 默认存在组0，且所有vlan默认处于该组；优先级= 32768+0<br> 分组<br> [sw1]stp enable<br> [sw1]stp region-configuration<br> [sw1-mst-region]region-name a 所有设备应在一个组内<br> [sw1-mst-region]instance 1 vlan 1 to 5<br> [sw1-mst-region]instance 2 vlan 6 to 10<br> [sw1-mst-region]active region-configuration 激活当前配置（必须配置该指令）<br> 切记：若将创建某个组，但该组内的vlan，在本交换机上没有创建，同时没有为该vlan服务的接口；该组将没有任何信息；整个交换网络中所有设备的分组信息必须完全一致；<br> 定义本地为组1 的主根，组2 的备份根<br> stp instance 1 root primary 优先级修改为0<br> stp instance 2 root secondary 优先级修改为4096</p> 
<p>[sw1]stp instance 1 priority ?<br> INTEGER&lt;0-61440&gt; Bridge priority, in steps of 4096</p> 
<p>[sw1]interface GigabitEthernet 0/0/1<br> [sw1-GigabitEthernet0/0/1]stp instance 1 cost ?<br> INTEGER&lt;1-200000000&gt; Port path cost</p> 
<p>[sw1-GigabitEthernet0/0/1]stp instance 1 port priority ?<br> INTEGER&lt;0-240&gt; Port priority, in steps of 16<br>  </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/78e7bd332fa0b6f6cc5bbfc81a92aae6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">eNSP综合小实验：VRRP、MSTP、Eth-Trunk、NAT、DHCP等</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c2c65716b98ee7939cf8062480fdadfe/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python小脚本——批量将PDF文件转换成图片</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>