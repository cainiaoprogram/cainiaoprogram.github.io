<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RTMDet训练流程（OpenMMLab AI实战营笔记7） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="RTMDet训练流程（OpenMMLab AI实战营笔记7）" />
<meta property="og:description" content="这次课程是使用rtmdet进行目标检测的课程
文章简介 我们先简单介绍一下rtmdet
paper：RTMDet: An Empirical Study of Designing Real-Time Object Detectors
GitHub： RTMDet
在本文中，我们的目标是设计一种高效的实时物体检测器，它超越了 YOLO 系列，并且可以轻松扩展到许多物体识别任务，例如实例分割和旋转物体检测。为了获得更高效的模型架构，我们探索了一种 在主干和颈部具有兼容能力的架构，该架构 由一个 由大核深度卷积组成的基本构建块 构建。我们在动态标签分配中 计算匹配成本时 进一步 引入软标签 以提高准确性。结合更好的训练技术，由此产生的名为 RTMDet 的目标检测器在 NVIDIA 3090 GPU 上以 300&#43; FPS 的速度在 COCO 上实现了 52.8% 的 AP，优于当前主流的工业检测器。RTMDet 针对各种应用场景实现了 tiny/small/medium/large/extra-large 模型大小的最佳 参数-精度权衡，并在实时实例分割和旋转目标检测方面获得了最新的性能。我们希望实验结果可以为设计用于许多目标识别任务的多功能实时目标检测器提供新的见解。
这里，我们简单阐述一下RTMDet设计的基本思想，也就是希望设计一个BackBone和Neck部分可以进行融合的目标检测架构，从而让目标检测更轻量化。能突破yolo的速度。
MMDetection MMDetection
RTMDet的代码已在MMDetection复现并开源，我们这里使用RTMDet进行气球检测。colab
所有的代码也可以在我的colab中查看
colab 代码 安装基本工具 （MMDetection，MMYOLO） %pip install -U &#34;openmim==0.3.7&#34; !mim install &#34;mmengine==0.7.1&#34; !mim install &#34;mmcv==2.0.0&#34; !git clone -b tutorials https://github.com/open-mmlab/mmdetection.git %cd mmdetection %pip install -e ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d936431bf369906030d1057e2c9fb404/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-11T12:13:48+08:00" />
<meta property="article:modified_time" content="2023-06-11T12:13:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">RTMDet训练流程（OpenMMLab AI实战营笔记7）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>这次课程是使用rtmdet进行目标检测的课程</p> 
</blockquote> 
<h3><a id="_1"></a>文章简介</h3> 
<p>我们先简单介绍一下rtmdet<br> paper：<a href="https://arxiv.org/abs/2212.07784/" rel="nofollow">RTMDet: An Empirical Study of Designing Real-Time Object Detectors</a><br> GitHub： <a href="https://github.com/open-mmlab/mmdetection/tree/3.x/configs/rtmdet">RTMDet</a></p> 
<p>在本文中，我们的目标是设计一种高效的实时物体检测器，它超越了 YOLO 系列，并且可以轻松扩展到许多物体识别任务，例如实例分割和旋转物体检测。为了获得更高效的模型架构，我们探索了一种 在主干和颈部具有兼容能力的架构，该架构 由一个 由大核深度卷积组成的基本构建块 构建。我们在动态标签分配中 计算匹配成本时 进一步 引入软标签 以提高准确性。结合更好的训练技术，由此产生的名为 RTMDet 的目标检测器在 NVIDIA 3090 GPU 上以 300+ FPS 的速度在 COCO 上实现了 52.8% 的 AP，优于当前主流的工业检测器。RTMDet 针对各种应用场景实现了 tiny/small/medium/large/extra-large 模型大小的最佳 参数-精度权衡，并在实时实例分割和旋转目标检测方面获得了最新的性能。我们希望实验结果可以为设计用于许多目标识别任务的多功能实时目标检测器提供新的见解。</p> 
<p><img src="https://images2.imgbox.com/16/eb/d5EmeRmN_o.png" alt="整体框架流程"><br> 这里，我们简单阐述一下RTMDet设计的基本思想，也就是希望设计一个BackBone和Neck部分可以进行融合的目标检测架构，从而让目标检测更轻量化。能突破yolo的速度。</p> 
<h3><a id="MMDetection_11"></a>MMDetection</h3> 
<ul><li>MMDetection<br> RTMDet的代码已在MMDetection复现并开源，我们这里使用RTMDet进行气球检测。</li><li>colab<br> 所有的代码也可以在我的colab中查看<br> <a href="https://colab.research.google.com/drive/156tR2wQr06HrOERktEcyLkZHMh8syk6e" rel="nofollow">colab</a></li></ul> 
<h3><a id="_18"></a>代码</h3> 
<ul><li>安装基本工具 （MMDetection，MMYOLO）</li></ul> 
<pre><code class="prism language-bash">%pip <span class="token function">install</span> -U <span class="token string">"openmim==0.3.7"</span>
<span class="token operator">!</span>mim <span class="token function">install</span> <span class="token string">"mmengine==0.7.1"</span>
<span class="token operator">!</span>mim <span class="token function">install</span> <span class="token string">"mmcv==2.0.0"</span>

<span class="token operator">!</span>git clone -b tutorials https://github.com/open-mmlab/mmdetection.git
%cd mmdetection

%pip <span class="token function">install</span> -e <span class="token builtin class-name">.</span>
</code></pre> 
<ul><li>下载数据集</li></ul> 
<pre><code class="prism language-bash"><span class="token operator">!</span>wget https://download.openmmlab.com/mmyolo/data/balloon_dataset.zip
<span class="token operator">!</span>unzip -q balloon_dataset.zip -d data
</code></pre> 
<ul><li>数据集label转coco<br> 在这里下载的数据集并不是coco格式的，不能直接在MMDetection这个框架下进行训练。所以需要转换操作。</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os<span class="token punctuation">.</span>path <span class="token keyword">as</span> osp
<span class="token keyword">import</span> mmengine<span class="token punctuation">,</span> mmcv

<span class="token keyword">def</span> <span class="token function">convert_balloon_to_coco</span><span class="token punctuation">(</span>ann_file<span class="token punctuation">,</span> out_file<span class="token punctuation">,</span> image_prefix<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data_infos <span class="token operator">=</span> mmengine<span class="token punctuation">.</span>load<span class="token punctuation">(</span>ann_file<span class="token punctuation">)</span>

    annotations <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    obj_count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>mmengine<span class="token punctuation">.</span>track_iter_progress<span class="token punctuation">(</span>data_infos<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        filename <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span>
        img_path <span class="token operator">=</span> osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>image_prefix<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
        height<span class="token punctuation">,</span> width <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>

        images<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
            <span class="token builtin">id</span><span class="token operator">=</span>idx<span class="token punctuation">,</span>
            file_name<span class="token operator">=</span>filename<span class="token punctuation">,</span>
            height<span class="token operator">=</span>height<span class="token punctuation">,</span>
            width<span class="token operator">=</span>width<span class="token punctuation">)</span><span class="token punctuation">)</span>

        bboxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        masks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> _<span class="token punctuation">,</span> obj <span class="token keyword">in</span> v<span class="token punctuation">[</span><span class="token string">'regions'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">assert</span> <span class="token keyword">not</span> obj<span class="token punctuation">[</span><span class="token string">'region_attributes'</span><span class="token punctuation">]</span>
            obj <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token string">'shape_attributes'</span><span class="token punctuation">]</span>
            px <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token string">'all_points_x'</span><span class="token punctuation">]</span>
            py <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token string">'all_points_y'</span><span class="token punctuation">]</span>
            poly <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>px<span class="token punctuation">,</span> py<span class="token punctuation">)</span><span class="token punctuation">]</span>
            poly <span class="token operator">=</span> <span class="token punctuation">[</span>p <span class="token keyword">for</span> x <span class="token keyword">in</span> poly <span class="token keyword">for</span> p <span class="token keyword">in</span> x<span class="token punctuation">]</span>

            x_min<span class="token punctuation">,</span> y_min<span class="token punctuation">,</span> x_max<span class="token punctuation">,</span> y_max <span class="token operator">=</span> <span class="token punctuation">(</span>
                <span class="token builtin">min</span><span class="token punctuation">(</span>px<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>py<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>px<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>py<span class="token punctuation">)</span><span class="token punctuation">)</span>


            data_anno <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
                image_id<span class="token operator">=</span>idx<span class="token punctuation">,</span>
                <span class="token builtin">id</span><span class="token operator">=</span>obj_count<span class="token punctuation">,</span>
                category_id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
                bbox<span class="token operator">=</span><span class="token punctuation">[</span>x_min<span class="token punctuation">,</span> y_min<span class="token punctuation">,</span> x_max <span class="token operator">-</span> x_min<span class="token punctuation">,</span> y_max <span class="token operator">-</span> y_min<span class="token punctuation">]</span><span class="token punctuation">,</span>
                area<span class="token operator">=</span><span class="token punctuation">(</span>x_max <span class="token operator">-</span> x_min<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y_max <span class="token operator">-</span> y_min<span class="token punctuation">)</span><span class="token punctuation">,</span>
                segmentation<span class="token operator">=</span><span class="token punctuation">[</span>poly<span class="token punctuation">]</span><span class="token punctuation">,</span>
                iscrowd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            annotations<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data_anno<span class="token punctuation">)</span>
            obj_count <span class="token operator">+=</span> <span class="token number">1</span>

    coco_format_json <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
        images<span class="token operator">=</span>images<span class="token punctuation">,</span>
        annotations<span class="token operator">=</span>annotations<span class="token punctuation">,</span>
        categories<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'id'</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'balloon'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    mmengine<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>coco_format_json<span class="token punctuation">,</span> out_file<span class="token punctuation">)</span>

convert_balloon_to_coco<span class="token punctuation">(</span><span class="token string">'data/balloon/train/via_region_data.json'</span><span class="token punctuation">,</span> <span class="token string">'data/balloon/train/annotation_coco.json'</span><span class="token punctuation">,</span> <span class="token string">'data/balloon/train'</span><span class="token punctuation">)</span>
convert_balloon_to_coco<span class="token punctuation">(</span><span class="token string">'data/balloon/val/via_region_data.json'</span><span class="token punctuation">,</span> <span class="token string">'data/balloon/val/annotation_coco.json'</span><span class="token punctuation">,</span> <span class="token string">'data/balloon/val'</span><span class="token punctuation">)</span>
</code></pre> 
<p>这样，我们就把所有数据转换成coco格式。</p> 
<ul><li>生成 Config<br> 在使用MMDetection或者所有MM进行训练时，我们都是需要创建一个Config文件用于保存参数，然后再进行训练。这样做的好处是。我们可以为每个训练任务创建一个Config文件，而不是每次修改之前的文件。可以理解成编程里，我们拥有一个父类。每次训练任务都生成新的子类进行继承。</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># 当前路径位于 mmdetection/tutorials, 配置将写到 mmdetection/tutorials 路径下</span>

config_balloon <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
_base_ = 'configs/rtmdet/rtmdet_tiny_8xb32-300e_coco.py'

data_root = 'data/balloon/'

metainfo = {
    'classes': ('balloon',),
    'palette': [
        (220, 20, 60),
    ]
}
num_classes = 1

max_epochs = 40
train_batch_size_per_gpu = 12
train_num_workers = 4

val_batch_size_per_gpu = 1
val_num_workers = 2

# RTMDet 训练过程分成 2 个 stage, 第二个 stage 会切换数据增强 pipeline
num_epochs_stage2 = 5

base_lr = 12 * 0.004 / (32*8)

# 采用 COCO 预训练权重
load_from = 'https://download.openmmlab.com/mmdetection/v3.0/rtmdet/rtmdet_tiny_8xb32-300e_coco/rtmdet_tiny_8xb32-300e_coco_20220902_112414-78e30dcc.pth'  # noqa

model = dict(
    backbone=dict(frozen_stages=4),
    bbox_head=dict(dict(num_classes=num_classes)))

train_dataloader = dict(
    batch_size=train_batch_size_per_gpu,
    num_workers=train_num_workers,
    pin_memory=False,
    dataset=dict(
        data_root=data_root,
        metainfo=metainfo,
        ann_file='train/annotation_coco.json',
        data_prefix=dict(img='train/')))

val_dataloader = dict(
    batch_size=val_batch_size_per_gpu,
    num_workers=val_num_workers,
    dataset=dict(
        metainfo=metainfo,
        data_root=data_root,
        ann_file='val/annotation_coco.json',
        data_prefix=dict(img='val/')))

test_dataloader = val_dataloader

# 默认的学习率调度器是 warmup 1000, 但是 cat 数据集太小了，需要修改 为 30 iter
param_scheduler = [
    dict(
        type='LinearLR',
        start_factor=1.0e-5,
        by_epoch=False,
        begin=0,
        end=30),
    dict(
        type='CosineAnnealingLR',
        eta_min=base_lr * 0.05,
        begin=max_epochs // 2,  # max_epoch 也改变了
        end=max_epochs,
        T_max=max_epochs // 2,
        by_epoch=True,
        convert_to_iter_based=True),
]
optim_wrapper = dict(optimizer=dict(lr=base_lr))

# 第二 stage 切换 pipeline 的 epoch 时刻也改变了
_base_.custom_hooks[1].switch_epoch = max_epochs - num_epochs_stage2

val_evaluator = dict(ann_file=data_root + 'val/annotation_coco.json')
test_evaluator = val_evaluator

# 一些打印设置修改
default_hooks = dict(
    checkpoint=dict(interval=10, max_keep_ckpts=2, save_best='auto'),  # 同时保存最好性能权重
    logger=dict(type='LoggerHook', interval=5))
train_cfg = dict(max_epochs=max_epochs, val_interval=10)
"""</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'rtmdet_tiny_1xb12-40e_balloon.py'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>config_balloon<span class="token punctuation">)</span>
</code></pre> 
<ul><li>训练</li></ul> 
<pre><code class="prism language-bash"><span class="token operator">!</span>python tools/train.py rtmdet_tiny_1xb12-40e_balloon.py
</code></pre> 
<ul><li>测试</li></ul> 
<pre><code class="prism language-python">!python tools<span class="token operator">/</span>test<span class="token punctuation">.</span>py rtmdet_tiny_1xb12<span class="token operator">-</span>40e_balloon<span class="token punctuation">.</span>py work_dirs<span class="token operator">/</span>rtmdet_tiny_1xb12<span class="token operator">-</span>40e_balloon<span class="token operator">/</span>best_coco<span class="token operator">/</span>bbox_mAP_epoch_40<span class="token punctuation">.</span>pth
</code></pre> 
<p>这样就完成了训练。</p> 
<h3><a id="_203"></a>可视化</h3> 
<p>更多可视化过程请参考我的colab文件中，其中还包含了热力图等可视化。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a42b48abe8a58e36b63f79269a048ba6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">二十二、高级网络技术及应用——策略路由与路由策略</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b7141d74047065e8589b62d4d3b0225e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">设计模式系列之抽象工厂模式(Abstract Factory)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>