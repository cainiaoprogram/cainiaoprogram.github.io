<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>spring boot中实现动态定时任务 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="spring boot中实现动态定时任务" />
<meta property="og:description" content="在网上找的资料最后整理出来的, 不过找不到原文章地址了, 感谢原作者的奉献
这里总共创建以下几个类:
DynamicCronJob: 动态定时任务, 包含了对定时任务的启动, 停止, 重启. 添加定时任务的功能没有加, 可以自行添加, 参考启动功能
ScheduledTaskConfig: 动态定时任务配置, 这是一个配置类, 配置ThreadPoolTaskScheduler线程池的, 还有就是初始化存放所有动态定时任务的map, 初始化map也就死创建一个map对象, 具体的初始化方法在下面的ScheduledTaskEnum枚举类中. 也可以在使用别的方式初始化, 这里有一个前提, 因为这个是配合数据库执行的, 每次重启项目都会将数据库中正常状态的定时任务取出来添加到执行map中 并执行, 所以要在别的地方初始化需要在这之前执行
ScheduledTaskJob: 动态定时任务的实体类, 包含了对应数据库的字段以及要执行的runnable
ScheduledTaskEnum: 动态定时任务枚举, 每一个要执行的定时任务都在这里添加一个枚举类型, 有两个属性, 第一个是定时任务的任务编码, 第二个就是定时任务的runnable, 还包括初始化存放所有动态定时任务的map, 放在这里是因为不需要动态添加定时任务, 放在这里可以在初始化map的时候设定map的容量, 如果需要动态添加定时任务则直接在ScheduledTaskConfig中初始化
ScheduledTaskRunner: 项目启动完毕后需要自启的任务, 主要就是用来执行初始化启动所有有效动态定时任务, 从数据库中获取有效的任务信息, 跟ScheduledTaskConfig中初始化的内容不一样, 这里是初始化执行所有的有效定时任务, 配置类中是初始化存放所有动态定时任务的map的
InsuranceTask: 具体的执行任务类, 这个是自定义的, 按照自己的需求创建类名, 成员属性, 定时任务要执行的方法等, 需要实现runnable接口, 成员属性无法直接注入, 需要将成员属性写成静态属性, 再使用set方法注入
提示: 代码中的ResultVO是一个统一返回对象, 包含code属性, msg属性和data属性, ResultVOUtil是统一返回对象的工具类, success是成功, code为0, msg为成功, 参数为data, error为失败, 需要自定义code和msg, 第一个参数是code, 第二个参数时msg
接下来是代码(未优化过, 功能已实现, 可以正常使用O(∩_∩)O):" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/73a6bd74251df901e56461000389a7a9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-04T16:04:34+08:00" />
<meta property="article:modified_time" content="2020-08-04T16:04:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">spring boot中实现动态定时任务</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>在网上找的资料最后整理出来的, 不过找不到原文章地址了, 感谢原作者的奉献</p> 
</blockquote> 
<p>这里总共创建以下几个类:</p> 
<blockquote> 
 <p><code>DynamicCronJob:</code> 动态定时任务, 包含了对定时任务的启动, 停止, 重启. 添加定时任务的功能没有加, 可以自行添加, 参考启动功能<br> <code>ScheduledTaskConfig:</code> 动态定时任务配置, 这是一个配置类, 配置<strong>ThreadPoolTaskScheduler</strong>线程池的, 还有就是初始化存放所有动态定时任务的map, 初始化map也就死创建一个map对象, 具体的初始化方法在下面的<strong>ScheduledTaskEnum</strong>枚举类中. 也可以在使用别的方式初始化, 这里有一个前提, 因为这个是配合数据库执行的, 每次重启项目都会将数据库中正常状态的定时任务取出来添加到执行map中 并执行, 所以要在别的地方初始化需要在这之前执行<br> <code>ScheduledTaskJob:</code> 动态定时任务的实体类, 包含了对应数据库的字段以及要执行的runnable<br> <code>ScheduledTaskEnum:</code> 动态定时任务枚举, 每一个要执行的定时任务都在这里添加一个枚举类型, 有两个属性, 第一个是定时任务的任务编码, 第二个就是定时任务的runnable, 还包括初始化存放所有动态定时任务的map, 放在这里是因为不需要动态添加定时任务, 放在这里可以在初始化map的时候设定map的容量, 如果需要动态添加定时任务则直接在<strong>ScheduledTaskConfig</strong>中初始化<br> <code>ScheduledTaskRunner:</code> 项目启动完毕后需要自启的任务, 主要就是用来执行初始化启动所有有效动态定时任务, 从数据库中获取有效的任务信息, 跟<strong>ScheduledTaskConfig</strong>中初始化的内容不一样, 这里是初始化执行所有的有效定时任务, 配置类中是初始化存放所有动态定时任务的map的<br> <code>InsuranceTask:</code> 具体的执行任务类, 这个是自定义的, 按照自己的需求创建类名, 成员属性, 定时任务要执行的方法等, 需要实现runnable接口, 成员属性无法直接注入, 需要将成员属性写成静态属性, 再使用set方法注入</p> 
</blockquote> 
<blockquote> 
 <p>提示: 代码中的<strong>ResultVO</strong>是一个统一返回对象, 包含code属性, msg属性和data属性, <strong>ResultVOUtil</strong>是统一返回对象的工具类, success是成功, code为0, msg为成功, 参数为data, error为失败, 需要自定义code和msg, 第一个参数是code, 第二个参数时msg</p> 
</blockquote> 
<p>接下来是代码(未优化过, 功能已实现, 可以正常使用O(∩_∩)O):</p> 
<blockquote> 
 <p>DynamicCronJob:</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">import</span> com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>ScheduledTaskJob<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>ScheduledTaskEnum<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>CollectionUtils<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ThreadPoolTaskScheduler<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>support<span class="token punctuation">.</span>CronTrigger<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Component<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ConcurrentHashMap<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ScheduledFuture<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span>ReentrantLock<span class="token punctuation">;</span>

<span class="token comment">/**
 * 动态定时任务
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicCronJob</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 可重入锁</span>
    <span class="token keyword">private</span> ReentrantLock lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 定时任务线程池</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> ThreadPoolTaskScheduler threadPoolTaskScheduler<span class="token punctuation">;</span>

    <span class="token comment">// 所有定时任务存放Map</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> ScheduledTaskJob<span class="token punctuation">&gt;</span></span> scheduledTaskJobMap<span class="token punctuation">;</span>

    <span class="token comment">// 存放已经启动的任务map</span>
    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ScheduledFuture<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;&gt;</span> scheduledFutureMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 根据任务编码 启动任务
     *
     * @param tasksCode 任务编码
     * @return
     */</span>
    <span class="token keyword">public</span> ResultVO <span class="token function">start</span><span class="token punctuation">(</span>String tasksCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 添加锁放一个线程启动，防止多人启动多次</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 校验是否已经启动</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStart</span><span class="token punctuation">(</span>tasksCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> ResultVOUtil<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"当前任务已经启动，无需重复启动!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 校验任务是否存在</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scheduledTaskJobMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>tasksCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> ResultVOUtil<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"不存在这个任务, 请先添加!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 启动任务</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doStartTask</span><span class="token punctuation">(</span>tasksCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 释放锁</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> ResultVOUtil<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据任务编码 停止任务
     *
     * @param tasksCode 任务编码
     * @return
     */</span>
    <span class="token keyword">public</span> ResultVO <span class="token function">stop</span><span class="token punctuation">(</span>String tasksCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当前任务实例是否存在</span>
        <span class="token keyword">boolean</span> taskStartFlag <span class="token operator">=</span> scheduledFutureMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>tasksCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>taskStartFlag<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 获取任务实例</span>
            ScheduledFuture<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> scheduledFuture <span class="token operator">=</span> scheduledFutureMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tasksCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 关闭实例</span>
            scheduledFuture<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"停止任务任务[{}]"</span><span class="token punctuation">,</span> tasksCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> ResultVOUtil<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>taskStartFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据任务编码 重启任务
     *
     * @param tasksCode 任务编码
     * @return
     */</span>
    <span class="token keyword">public</span> ResultVO <span class="token function">restart</span><span class="token punctuation">(</span>String tasksCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"正在重新启动任务[{}]"</span><span class="token punctuation">,</span> tasksCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 先停止</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span>tasksCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 再启动</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>tasksCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 初始化启动所有有效动态定时任务
     *
     * @param scheduledTaskJobs 有效动态定时任务
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initAllTask</span><span class="token punctuation">(</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>ScheduledTaskJob<span class="token punctuation">&gt;</span></span> scheduledTaskJobs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"启动所有有效动态定时任务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>CollectionUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>scheduledTaskJobs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>ScheduledTaskJob scheduledTaskJob <span class="token operator">:</span> scheduledTaskJobs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 任务编码</span>
            String taskCode <span class="token operator">=</span> scheduledTaskJob<span class="token punctuation">.</span><span class="token function">getTasksCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置任务</span>
            scheduledTaskJob<span class="token punctuation">.</span><span class="token function">setRunnable</span><span class="token punctuation">(</span>ScheduledTaskEnum<span class="token punctuation">.</span><span class="token function">findRunnableByTaskCode</span><span class="token punctuation">(</span>taskCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将任务添加到所有任务的map中</span>
            scheduledTaskJobMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>taskCode<span class="token punctuation">,</span> scheduledTaskJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 校验是否已经启动</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStart</span><span class="token punctuation">(</span>taskCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 启动任务</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doStartTask</span><span class="token punctuation">(</span>taskCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/********************************************* 私有方法 *****************************************/</span>

    <span class="token comment">/**
     * 启动任务
     *
     * @param tasksCode 任务编码
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doStartTask</span><span class="token punctuation">(</span>String tasksCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ScheduledTaskJob scheduledTaskJob <span class="token operator">=</span> scheduledTaskJobMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tasksCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ScheduledFuture<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> scheduledFuture <span class="token operator">=</span> threadPoolTaskScheduler<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>scheduledTaskJob<span class="token punctuation">.</span><span class="token function">getRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                triggerContext <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">CronTrigger</span><span class="token punctuation">(</span>scheduledTaskJob<span class="token punctuation">.</span><span class="token function">getCronExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextExecutionTime</span><span class="token punctuation">(</span>triggerContext<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"任务[{}]启动完成, cron表达式为: [{}]"</span><span class="token punctuation">,</span> tasksCode<span class="token punctuation">,</span> scheduledTaskJob<span class="token punctuation">.</span><span class="token function">getCronExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将启动的任务放入map</span>
        scheduledFutureMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tasksCode<span class="token punctuation">,</span> scheduledFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 任务是否已经启动
     *
     * @param tasksCode 任务编码
     * @return
     */</span>
    <span class="token keyword">private</span> Boolean <span class="token function">isStart</span><span class="token punctuation">(</span>String tasksCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 校验是否已经启动</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledFutureMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>tasksCode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>scheduledFutureMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tasksCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>ScheduledTaskConfig:</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">import</span> com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>ScheduledTaskJob<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>ScheduledTaskEnum<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Bean<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ThreadPoolTaskScheduler<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment">/**
 * 动态定时任务配置
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledTaskConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 定时任务线程池
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> ThreadPoolTaskScheduler <span class="token function">threadPoolTaskScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ThreadPoolTaskScheduler threadPoolTaskScheduler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTaskScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadPoolTaskScheduler<span class="token punctuation">.</span><span class="token function">setPoolSize</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadPoolTaskScheduler<span class="token punctuation">.</span><span class="token function">setThreadNamePrefix</span><span class="token punctuation">(</span><span class="token string">"taskExecutor-"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadPoolTaskScheduler<span class="token punctuation">.</span><span class="token function">setWaitForTasksToCompleteOnShutdown</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadPoolTaskScheduler<span class="token punctuation">.</span><span class="token function">setAwaitTerminationSeconds</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> threadPoolTaskScheduler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 初始化所有动态定时任务的map
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> ScheduledTaskJob<span class="token punctuation">&gt;</span></span> <span class="token function">scheduledTaskJobMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> ScheduledTaskEnum<span class="token punctuation">.</span><span class="token function">initScheduledTaskMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<blockquote> 
 <p>ScheduledTaskJob:</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">import</span> lombok<span class="token punctuation">.</span>Data<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>Entity<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>Id<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>Transient<span class="token punctuation">;</span>

<span class="token comment">/**
 * 动态定时任务
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledTaskJob</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token function">ScheduledTaskJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">ScheduledTaskJob</span><span class="token punctuation">(</span>Runnable runnable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>runnable <span class="token operator">=</span> runnable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 主键
     */</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> Integer id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 任务编码
     */</span>
    <span class="token keyword">private</span> String tasksCode<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 任务名称
     */</span>
    <span class="token keyword">private</span> String tasksName<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 任务说明
     */</span>
    <span class="token keyword">private</span> String tasksDesc<span class="token punctuation">;</span>

    <span class="token comment">/**
     * cron表达式
     */</span>
    <span class="token keyword">private</span> String cronExpression<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 是否可用: 0 - 否, 1 - 是
     */</span>
    <span class="token keyword">private</span> Integer state<span class="token punctuation">;</span>

    <span class="token comment">/**************************************** 非数据库字段 **************************************/</span>

    <span class="token annotation punctuation">@Transient</span>
    <span class="token keyword">private</span> Runnable runnable<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<blockquote> 
 <p>ScheduledTaskEnum:</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">import</span> com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>InsuranceTask<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>ScheduledTaskJob<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ConcurrentHashMap<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>Stream<span class="token punctuation">;</span>

<span class="token comment">/**
 * 动态定时任务枚举
 * ! key 需要与数据库保持一致
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> ScheduledTaskEnum <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 定时任务类型枚举
     */</span>
    <span class="token function">INSURANCE</span><span class="token punctuation">(</span><span class="token string">"insuranceTask"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InsuranceTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 定时任务编码
     */</span>
    <span class="token keyword">private</span> String taskCode<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 定时任务
     */</span>
    <span class="token keyword">private</span> Runnable runnable<span class="token punctuation">;</span>

    <span class="token function">ScheduledTaskEnum</span><span class="token punctuation">(</span>String taskCode<span class="token punctuation">,</span> Runnable runnable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taskCode <span class="token operator">=</span> taskCode<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>runnable <span class="token operator">=</span> runnable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getTaskCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> taskCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTaskCode</span><span class="token punctuation">(</span>String taskCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taskCode <span class="token operator">=</span> taskCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Runnable <span class="token function">getRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> runnable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRunnable</span><span class="token punctuation">(</span>Runnable runnable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>runnable <span class="token operator">=</span> runnable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据任务编码获取任务
     *
     * @param taskCode 任务编码
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> Runnable <span class="token function">findRunnableByTaskCode</span><span class="token punctuation">(</span>String taskCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>ScheduledTaskEnum<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">-</span><span class="token operator">&gt;</span> item<span class="token punctuation">.</span><span class="token function">getTaskCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>taskCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAny</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>ScheduledTaskEnum<span class="token operator">:</span><span class="token operator">:</span>getRunnable<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 初始化所有动态定时任务的map, 放在这里是因为不需要动态添加定时任务, 放在这里可以在初始化map的时候设定map的容量
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> ScheduledTaskJob<span class="token punctuation">&gt;</span></span> <span class="token function">initScheduledTaskMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"初始化所有动态定时任务的map"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>ScheduledTaskEnum<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<blockquote> 
 <p>ScheduledTaskRunner:</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">import</span> com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>DynamicCronJob<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>ScheduledTaskJob<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>ApplicationArguments<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>ApplicationRunner<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Order<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Component<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>EntityManager<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>PersistenceContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token comment">/**
 * 项目启动完毕后需要自启的任务, Order注解的执行优先级是按value值从小到大顺序
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledTaskRunner</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationRunner</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> DynamicCronJob dynamicCronJob<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@PersistenceContext</span>
    <span class="token keyword">private</span> EntityManager entityManager<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span>ApplicationArguments args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>ScheduledTaskJob<span class="token punctuation">&gt;</span></span> resultList <span class="token operator">=</span> entityManager<span class="token punctuation">.</span><span class="token function">createNativeQuery</span><span class="token punctuation">(</span><span class="token string">"select stj.* from scheduled_task_job stj where stj.state = 1"</span><span class="token punctuation">,</span> ScheduledTaskJob<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResultList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entityManager<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entityManager<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dynamicCronJob<span class="token punctuation">.</span><span class="token function">initAllTask</span><span class="token punctuation">(</span>resultList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<blockquote> 
 <p>InsuranceTask:</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Component<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>Collectors<span class="token punctuation">;</span>

<span class="token comment">/**
 * 成员变量需要静态化成员变量然后使用set注入
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InsuranceTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> XXX xxx<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> YYY yyy<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 要执行的定时任务</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/************************ set方法, 实现Runnable接口因为安全问题无法直接在成员变量上注入 *************************/</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setXXX</span><span class="token punctuation">(</span>XXX xxx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        InsuranceTask<span class="token punctuation">.</span>xxx <span class="token operator">=</span> xxx<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${yyy.yy.y}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setYYY</span><span class="token punctuation">(</span>String yyy<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        InsuranceTask<span class="token punctuation">.</span>yyy <span class="token operator">=</span> yyy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>下面是业务代码:</p> 
<blockquote> 
 <p>controller:</p> 
</blockquote> 
<pre><code class="prism language-java">   <span class="token comment">/**
     * 根据任务编码获取cron表达式
     *
     * @param tasksCode 任务编码
     * @return
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/findCronExpressionByTaskCode"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> ResultVO <span class="token function">findCronExpressionByTaskCode</span><span class="token punctuation">(</span>String tasksCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>ScheduledTaskJob<span class="token punctuation">&gt;</span></span> resultList <span class="token operator">=</span> entityManager<span class="token punctuation">.</span><span class="token function">createNativeQuery</span><span class="token punctuation">(</span><span class="token string">"select stj.* from scheduled_task_job stj where stj.tasks_code = ?1 and stj.state = 1"</span><span class="token punctuation">,</span> ScheduledTaskJob<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> tasksCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResultList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entityManager<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entityManager<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> ResultVOUtil<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"未获取到有效数据!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> ResultVOUtil<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>resultList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCronExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据任务编码修改cron表达式
     *
     * @param tasksCode      任务编码
     * @param cronExpression cron表达式
     * @param userCode       用户编码
     * @return
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/updateCronExpressionByTaskCode"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> ResultVO <span class="token function">updateCronExpressionByTaskCode</span><span class="token punctuation">(</span>String tasksCode<span class="token punctuation">,</span> String cronExpression<span class="token punctuation">,</span> String userCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> ResultVOUtil<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>securityMgmtService<span class="token punctuation">.</span><span class="token function">updateCronExpressionByTaskCode</span><span class="token punctuation">(</span>tasksCode<span class="token punctuation">,</span> cronExpression<span class="token punctuation">,</span> userCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>service: 重置定时任务我是放在service中的, 因为需要修改数据库. 然后在service中注入所有定时任务存放Map和动态定时任务类来获取定时任务信息, 修改定时任务的cron表达式和修改后重启定时任务</p> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token comment">// 所有定时任务存放Map</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> ScheduledTaskJob<span class="token punctuation">&gt;</span></span> scheduledTaskJobMap<span class="token punctuation">;</span>
    <span class="token comment">// 动态定时任务类</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> DynamicCronJob dynamicCronJob<span class="token punctuation">;</span>
    
   <span class="token comment">/**
     * 根据任务编码修改cron表达式
     *
     * @param taskCode       任务编码
     * @param cronExpression cron表达式
     * @param userCode       用户编码
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> Propagation<span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span> isolation <span class="token operator">=</span> Isolation<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">36000</span><span class="token punctuation">,</span> rollbackFor <span class="token operator">=</span> Exception<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Integer <span class="token function">updateCronExpressionByTaskCode</span><span class="token punctuation">(</span>String taskCode<span class="token punctuation">,</span> String cronExpression<span class="token punctuation">,</span> String userCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> update <span class="token operator">=</span> entityManager<span class="token punctuation">.</span><span class="token function">createNativeQuery</span><span class="token punctuation">(</span><span class="token string">"update scheduled_task_job set cron_expression = ?2 where tasks_code = ?1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> taskCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> cronExpression<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entityManager<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entityManager<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 换成新的cron表达式再重新启动</span>
        ScheduledTaskJob scheduledTaskJob <span class="token operator">=</span> scheduledTaskJobMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>taskCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 旧的cron表达式</span>
        String oldCronExpression <span class="token operator">=</span> scheduledTaskJob<span class="token punctuation">.</span><span class="token function">getCronExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重新设定cron表达式</span>
        scheduledTaskJob<span class="token punctuation">.</span><span class="token function">setCronExpression</span><span class="token punctuation">(</span>cronExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dynamicCronJob<span class="token punctuation">.</span><span class="token function">restart</span><span class="token punctuation">(</span>taskCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"用户[{}]修改了[xxx]的定时任务, 原cron表达式为: [{}], 修改后cron表达式为: [{}]"</span><span class="token punctuation">,</span> userCode<span class="token punctuation">,</span> oldCronExpression<span class="token punctuation">,</span> cronExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4e7aaeba4bd1405f2739b99cc6fe2763/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">elasticsearch  ik分词器</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f5b6c1858c044bb1463d6c5c7f136d82/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java设计模式之单例模式（Singleton Pattern）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>