<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android资源管理框架-------之Bag资源信息的获取(七) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android资源管理框架-------之Bag资源信息的获取(七)" />
<meta property="og:description" content="前文我们以Integer为例介绍了最简单的资源的获取，说它是最简单的主要是基于以下两个点：第一，它没有Bag；第二，它是values类型的资源，资源索引表里存放的是最终值，而不是资源路径等资源相关的信息，我们不需要再根据这些信息去取得最终值（比如去加载图片，然后创建drawable对象等等）。我们在这篇文章里主要针对第一点，也就是介绍一下带有Bag的资源，android是怎么去获取这些资源相关的信息的（对于非values类型的资源，我们从resources.arsc里只能获取到资源信息，而不是资源本身）。
我们经常用到的带有Bag的资源主要包括：各种array（array、string-array、integer-array）、plurals、style等，我们一个一个分开说。
string-array资源的获取 我们知道各种array是一种非常典型的带有Bag的资源，它的Bag的key是^index_%d，其中%d表示0,1,2,3…等索引号；它的value就是我们在item标签中的值了。假设我们在apk的资源文件中有如下的array：
&lt;string-array name=&#34;camera_modes&#34; translatable=&#34;false&#34;&gt; &lt;item&gt;photo&lt;/item&gt; &lt;item&gt;video&lt;/item&gt; &lt;item&gt;refocus&lt;/item&gt; &lt;item&gt;photosphere&lt;/item&gt; &lt;item&gt;panorama&lt;/item&gt; &lt;item&gt;@android:string/gcma&lt;/item&gt; &lt;!--这里引用了系统包中的资源--&gt; &lt;/string-array&gt; 前文我们介绍过integer资源的获取过程，它最主要的过程是在native层的ResTable对象里，通过getResource方法，根据我们传过来的资源Id，找到对应的ResTable_entry，进而找到Res_value获取我们需要的资源信息。不过，带有Bag的资源，其流程不太一样下面我们详细分析。Resources类中String数组获取的相关方法有三个:
public CharSequence[] getTextArray(int id) throws NotFoundException
public String[] getStringArray(int id) throws NotFoundException
public TypedArray obtainTypedArray(int id) throws NotFoundException
这三个方法的区别是什么呢？首先，getTextArray和getStringArray方法只能用来获取字符串类型的资源。也就是说，他们所对应的资源必须是string-array或者array（是array的时候要注意，它的每一个item都必须是一个字符串，或者是一个字符串的引用即一个指向字符串资源的id，形如@android:string/cance这种）。至于getTextArray和getStringArray方法的区别，和Resources类中getText与getString方法的区别一样：前者获取到的字符串是带style的（比如加粗、斜体等），而后者则是纯文本的。前者返回的是一个CharSequence数组，后者返回的是一个String数组。其实我们知道在底层的ResStringPool中是有存储一个字符串的style信息的，所以我们可以通过getTextArray将其返回。另外，多说一句String本身也是CharSequence接口的实现类，getTextArray方法返回的CharSequence接口的实现类到底是哪个呢？是android自己实现的android.text.SpannedString类，这个跟本文关系不大，就不展开说了。
相比前两者，obtainTypedArray方法则灵活得多，它可以用来获取各种类型的资源数组，比如CharSequence、String、Integer、Boolean、Float、Color、ColorList、Drawable、Dimension、Fraction或者资源Id等等，与它对应的xml中资源可以是array、integer-array、string-array等都可以。但是它的用法和前面的那两个不太一样，这个方法不会直接返回对应的资源数组，而是返回一个TypedArray对象，我们可以从这个对象中获取想要的资源。为什么这个方法可以这么灵活呢？是因为这个方法返回TypedArray的时候，并不会对里面的内容做类型检查，而前面的那两个方法则会做类型检查，如果不是String，则不会往结果里写数据。这三个方法实现上有所不同，但获取资源时的原理是相通的，我们就以getStringArray方法为例来简要分析其实现过程：
//frameworks/base/base/core/java/android/content/res/Resources.java public String[] getStringArray(int id) throws NotFoundException { String[] res = mAssets.getResourceStringArray(id); if (res != null) { return res; } throw new NotFoundException(&#34;String array resource ID #0x&#34; &#43; Integer.toHexString(id)); } mAssets是AssetManager的一个实例，进入Assetmanager类：
//frameworks/base/core/java/android/content/res/AssetManager.java final String[] getResourceStringArray(final int id) { String[] retArray = getArrayStringResource(id); return retArray; } private native final String[] getArrayStringResource(int arrayRes); 没有什么好说的，进入jni层：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/df693801c60d03d2a858920d4a2362cf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-11-13T21:13:39+08:00" />
<meta property="article:modified_time" content="2019-11-13T21:13:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android资源管理框架-------之Bag资源信息的获取(七)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>        前文我们以Integer为例介绍了最简单的资源的获取，说它是最简单的主要是基于以下两个点：第一，它没有Bag；第二，它是values类型的资源，资源索引表里存放的是最终值，而不是资源路径等资源相关的信息，我们不需要再根据这些信息去取得最终值（比如去加载图片，然后创建drawable对象等等）。我们在这篇文章里主要针对第一点，也就是介绍一下带有Bag的资源，android是怎么去获取这些资源相关的信息的（对于非values类型的资源，我们从resources.arsc里只能获取到资源信息，而不是资源本身）。</p> 
<p>        我们经常用到的带有Bag的资源主要包括：各种array（array、string-array、integer-array）、plurals、style等，我们一个一个分开说。</p> 
<h4><a id="stringarray_4"></a>string-array资源的获取</h4> 
<p>        我们知道各种array是一种非常典型的带有Bag的资源，它的Bag的key是<code>^index_%d</code>，其中<code>%d</code>表示0,1,2,3…等索引号；它的value就是我们在item标签中的值了。假设我们在apk的资源文件中有如下的array：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string-array</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>camera_modes<span class="token punctuation">"</span></span> <span class="token attr-name">translatable</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span>photo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span>video<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span>refocus<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span>photosphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span>panorama<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span>@android:string/gcma<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!--这里引用了系统包中的资源--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string-array</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>        前文我们介绍过integer资源的获取过程，它最主要的过程是在native层的<code>ResTable</code>对象里，通过<code>getResource</code>方法，根据我们传过来的资源Id，找到对应的<code>ResTable_entry</code>，进而找到<code>Res_value</code>获取我们需要的资源信息。不过，带有Bag的资源，其流程不太一样下面我们详细分析。<code>Resources</code>类中String数组获取的相关方法有三个:<br>         <code>public CharSequence[] getTextArray(int id) throws NotFoundException</code><br>         <code>public String[] getStringArray(int id) throws NotFoundException</code><br>         <code>public TypedArray obtainTypedArray(int id) throws NotFoundException</code></p> 
<p>        这三个方法的区别是什么呢？首先，<code>getTextArray</code>和<code>getStringArray</code>方法只能用来获取字符串类型的资源。也就是说，他们所对应的资源必须是<code>string-array</code>或者<code>array</code>（是<code>array</code>的时候要注意，它的每一个item都必须是一个字符串，或者是一个字符串的引用即一个指向字符串资源的id，形如<code>@android:string/cance</code>这种）。至于<code>getTextArray</code>和<code>getStringArray</code>方法的区别，和<code>Resources</code>类中<code>getText</code>与<code>getString</code>方法的区别一样：前者获取到的字符串是带style的（比如加粗、斜体等），而后者则是纯文本的。前者返回的是一个<code>CharSequence</code>数组，后者返回的是一个<code>String</code>数组。其实我们知道在底层的<code>ResStringPool</code>中是有存储一个字符串的style信息的，所以我们可以通过<code>getTextArray</code>将其返回。另外，多说一句<code>String</code>本身也是<code>CharSequence</code>接口的实现类，<code>getTextArray</code>方法返回的<code>CharSequence</code>接口的实现类到底是哪个呢？是android自己实现的<code>android.text.SpannedString</code>类，这个跟本文关系不大，就不展开说了。</p> 
<p>        相比前两者，<code>obtainTypedArray</code>方法则灵活得多，它可以用来获取各种类型的资源数组，比如<code>CharSequence</code>、<code>String</code>、<code>Integer</code>、<code>Boolean</code>、<code>Float</code>、<code>Color</code>、<code>ColorList</code>、<code>Drawable</code>、<code>Dimension</code>、<code>Fraction</code>或者资源Id等等，与它对应的xml中资源可以是<code>array</code>、<code>integer-array</code>、<code>string-array</code>等都可以。但是它的用法和前面的那两个不太一样，这个方法不会直接返回对应的资源数组，而是返回一个<code>TypedArray</code>对象，我们可以从这个对象中获取想要的资源。为什么这个方法可以这么灵活呢？是因为这个方法返回<code>TypedArray</code>的时候，并不会对里面的内容做类型检查，而前面的那两个方法则会做类型检查，如果不是String，则不会往结果里写数据。这三个方法实现上有所不同，但获取资源时的原理是相通的，我们就以<code>getStringArray</code>方法为例来简要分析其实现过程：</p> 
<pre><code class="prism language-java"><span class="token comment">//frameworks/base/base/core/java/android/content/res/Resources.java</span>
<span class="token keyword">public</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
    String<span class="token punctuation">[</span><span class="token punctuation">]</span> res <span class="token operator">=</span> mAssets<span class="token punctuation">.</span><span class="token function">getResourceStringArray</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token string">"String array resource ID #0x"</span>
                     <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>        mAssets是AssetManager的一个实例，进入<code>Assetmanager</code>类：</p> 
<pre><code class="prism language-java"><span class="token comment">//frameworks/base/core/java/android/content/res/AssetManager.java</span>
<span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getResourceStringArray</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    String<span class="token punctuation">[</span><span class="token punctuation">]</span> retArray <span class="token operator">=</span> <span class="token function">getArrayStringResource</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> retArray<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getArrayStringResource</span><span class="token punctuation">(</span><span class="token keyword">int</span> arrayRes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>        没有什么好说的，进入jni层：</p> 
<pre><code class="prism language-cpp"><span class="token comment">//frameworks/base/core/jni/android_util_AssetManager.cpp</span>
<span class="token keyword">static</span> jobjectArray <span class="token function">android_content_AssetManager_getArrayStringResource</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">,</span>
                                                                        jint arrayResId<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//熟悉的老套路，从java层保存的地址直接拿到native层的AssetManager对象</span>
    AssetManager<span class="token operator">*</span> am <span class="token operator">=</span> <span class="token function">assetManagerForJavaObject</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>am <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//拿到ResTable对象，所有资源相关的信息都在里面</span>
    <span class="token keyword">const</span> ResTable<span class="token operator">&amp;</span> <span class="token function">res</span><span class="token punctuation">(</span>am<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 一个Bag也就是我们string-array中的一个item
     * 对应一个bag_entry结构
     */</span>
    <span class="token keyword">const</span> ResTable<span class="token operator">::</span>bag_entry<span class="token operator">*</span> startOfBag<span class="token punctuation">;</span>
    <span class="token comment">//拿到Bag的数目，具体到我们的例子，N = 6，我们有6个item</span>
    <span class="token keyword">const</span> ssize_t N <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">lockBag</span><span class="token punctuation">(</span>arrayResId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>startOfBag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//存储最终结果</span>
    jobjectArray array <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">NewObjectArray</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> g_stringClass<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ExceptionCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        res<span class="token punctuation">.</span><span class="token function">unlockBag</span><span class="token punctuation">(</span>startOfBag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Res_value value<span class="token punctuation">;</span>
    <span class="token comment">//指向第一个Bag，也就是我们资源中的第一个item</span>
    <span class="token keyword">const</span> ResTable<span class="token operator">::</span>bag_entry<span class="token operator">*</span> bag <span class="token operator">=</span> startOfBag<span class="token punctuation">;</span>
    size_t strLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//遍历每一个Bag，可以认为是遍历每一个我们资源文件中的item</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>i<span class="token punctuation">)</span><span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> bag<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//拿到其Res_value</span>
        value <span class="token operator">=</span> bag<span class="token operator">-</span><span class="token operator">&gt;</span>map<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        jstring str <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        <span class="token comment">//当然，如果它不是一个string，而是一个指向string资源的Id（也就是一个引用），我们要解析这个引用</span>
        <span class="token comment">//直到得到的终结果不再是引用为止。</span>
        ssize_t block <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">resolveReference</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">,</span> bag<span class="token operator">-</span><span class="token operator">&gt;</span>stringBlock<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> THROW_ON_BAD_ID</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">==</span> BAD_INDEX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">jniThrowException</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"java/lang/IllegalStateException"</span><span class="token punctuation">,</span> <span class="token string">"Bad resource!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> array<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token comment">//注意，类型检查，只有我们得到的结果是TYPE_STRING，我们才会写入返回结果数组</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>dataType <span class="token operator">==</span> Res_value<span class="token operator">::</span>TYPE_STRING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//拿到对应包中的String Pool</span>
            <span class="token keyword">const</span> ResStringPool<span class="token operator">*</span> pool <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">getTableStringBlock</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//拿到最终的字符串</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str8 <span class="token operator">=</span> pool<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">string8At</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>strLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>str8 <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                str <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>str8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">const</span> <span class="token keyword">char16_t</span><span class="token operator">*</span> str16 <span class="token operator">=</span> pool<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">stringAt</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>strLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                str <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">NewString</span><span class="token punctuation">(</span>str16<span class="token punctuation">,</span> strLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// If one of our NewString{UTF} calls failed due to memory, an</span>
            <span class="token comment">// exception will be pending.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ExceptionCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                res<span class="token punctuation">.</span><span class="token function">unlockBag</span><span class="token punctuation">(</span>startOfBag<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//放到返回结果里，需要注意的是，此时的str是纯文本信息，不包括文本的style</span>
            env<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetObjectArrayElement</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> i<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// str is not NULL at that point, otherwise ExceptionCheck would have been true.</span>
            <span class="token comment">// If we have a large amount of strings in our array, we might</span>
            <span class="token comment">// overflow the local reference table of the VM.</span>
            env<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">.</span><span class="token function">unlockBag</span><span class="token punctuation">(</span>startOfBag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> array<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>        引用的解析过程，我们在<a href="https://blog.csdn.net/dayong198866/article/details/98249980">Android资源管理中的Theme和Style-------之实现（二）</a>已经详细介绍过，这里不再重复。需要强调的是，引用有可能是跨包的，比如我们经常在我们的apk中引用系统包中的资源。所以，在引用解析的过程中，我们要更新block值，毕竟block就是包（确切地说是对应的PackageGroup在ResTable中）的索引值。</p> 
<p>        <code>android_content_AssetManager_getArrayStringResource</code>方法的实现比较简单，根据资源ID拿到所有的Bag（每一个item），然后从每个Bag里取出对应的值并进行引用的解析，如果它是TYPE_STRING，则把拿到的字符串写入最终结果数组，最后把这个最终结果数组返回。这整个过程中最关键的就是Bag的获取，也就是<code>ResTable</code>对象的<code>lockBag</code>方法了。在介绍这个方法前，先看两个Bag相关的数据结构：</p> 
<pre><code class="prism language-cpp"><span class="token comment">//frameworks/base/libs/androidfw/ResourceTypes.cpp</span>
<span class="token keyword">struct</span> ResTable<span class="token operator">::</span>bag_set
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * numAttrs表示一个bag_set结构体后面跟了多少个bag_entry
     * 从变量的命名来看，作者写这些数据结构最初是为了处理
     * style或者theme中的属性的，后来用到了所有的bag资源，哈哈
     */</span>
    size_t numAttrs<span class="token punctuation">;</span>
    <span class="token comment">/**
     * availAttrs,bag_set后面的内存能放多少个bag_entry.
     * 初看bag_set这个结构体感觉很不解，主要是bag_set和bag_entry
     * 采用了动态内存管理，availAttrs这个变量仅作内存分配时使用，跟资源本身无关
     * 当往bag_set后面添加bag_entry的时候，发现numAttrs == availAttrs，也就是
     * 坑儿满了的时候，就会再去动态扩展内存。
     */</span>
    size_t availAttrs<span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> typeSpecFlags<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-cpp"> <span class="token comment">//frameworks/base/include/androidfw/ResourceTypes.h</span>
<span class="token keyword">struct</span> bag_entry <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 表示这个bag所属的entry，也就是我们的这个string-array所在的
     * 资源包在ResTable中的索引
     */</span>
    ssize_t stringBlock<span class="token punctuation">;</span>
    <span class="token comment">/**
     * ResTable_map 的key是一个ResTable_ref,也就是一个资源的引用或者说是ID
     * 对应与我们前面说的^index_%d
     * ResTable_map 的 value则是一个Res_value,对应于每一个item的值
     */</span>
    ResTable_map map<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>        我们先说一下Bag的组织形式。一个包中的所有Bag资源会缓存在它所在的<code>PackageGroup</code>里面的bags变量里，它的类型是<code>ByteBucketArray&lt;bag_set**&gt;*</code>，<code>ByteBucketArray</code>中按照不同的type和entry对所有的bag资源分类，而每一个bag_set结构体表示一个entry（也就是一个资源项）的所有bag资源。比如，我们例子中camera_modes这个<code>string-array</code>的所有bag都放在一个<code>bag_set</code>里面。一个<code>bag_set</code>后面会跟N个<code>bag_entry</code>，一个<code>bag_entry</code>表示一个Bag资源项，也就是我们string-array的一个item了。其实一个大多数情况下，<code>bag_entry</code>中一个map字段，足以表达完整的Bag信息了，比如map中的value值表示一个字符串的资源ID（也就是一个ResTable_ref）的时候，我们直接根据这个ID就可以获得字符串了，stringBlock这个变量是不需要使用的；当map中的value值不是ID而直接是一个字符串的时候，stringBlock也是没有必要的：试想当我们给camera_modes这个string-array的item赋值为<code>@android:string/gcma</code>的时候，map中Res_value的值将会是0x01******，根据这个ID，自然知道这个字符串在哪个包中；当我们在APK中给item直接赋值一个字符串"photo"时，你说"photo"这个字符串会在哪个包中，当然是在当前包，也就是camera_modes这个string-array所在的包中了。那么为什么还要有stringBlock这个字段呢，这个问题困扰了我好久，大家可以先考虑一下，后面我们再继续说这个问题，接下来看我们的重头戏：</p> 
<pre><code class="prism language-cpp"><span class="token comment">//frameworks/base/libs/androidfw/ResourceTypes.cpp</span>

ssize_t ResTable<span class="token operator">::</span><span class="token function">lockBag</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> resID<span class="token punctuation">,</span> <span class="token keyword">const</span> bag_entry<span class="token operator">*</span><span class="token operator">*</span> outBag<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//线程安全互斥锁</span>
    mLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ssize_t err <span class="token operator">=</span> <span class="token function">getBagLocked</span><span class="token punctuation">(</span>resID<span class="token punctuation">,</span> outBag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//printf("*** get failed!  unlocking\n");</span>
        mLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t ResTable<span class="token operator">::</span><span class="token function">getBagLocked</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> resID<span class="token punctuation">,</span> <span class="token keyword">const</span> bag_entry<span class="token operator">*</span><span class="token operator">*</span> outBag<span class="token punctuation">,</span>
        <span class="token keyword">uint32_t</span><span class="token operator">*</span> outTypeSpecFlags<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token comment">/*除了resID是输入参数外，都是输出参数*/</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mError <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mError<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//拿到PackageGroup、Type、Entry的索引</span>
    <span class="token keyword">const</span> ssize_t p <span class="token operator">=</span> <span class="token function">getResourcePackageIndex</span><span class="token punctuation">(</span>resID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> t <span class="token operator">=</span> <span class="token function">Res_GETTYPE</span><span class="token punctuation">(</span>resID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> e <span class="token operator">=</span> <span class="token function">Res_GETENTRY</span><span class="token punctuation">(</span>resID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Invalid package identifier when getting bag for resource number 0x%08x"</span><span class="token punctuation">,</span> resID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> BAD_INDEX<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"No type identifier when getting bag for resource number 0x%08x"</span><span class="token punctuation">,</span> resID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> BAD_INDEX<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//printf("Get bag: id=0x%08x, p=%d, t=%d\n", resID, p, t);</span>
    <span class="token comment">//得到PackageGroup对象，合法性检查</span>
    PackageGroup<span class="token operator">*</span> <span class="token keyword">const</span> grp <span class="token operator">=</span> mPackageGroups<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>grp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Bad identifier when getting bag for resource number 0x%08x"</span><span class="token punctuation">,</span> resID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> BAD_INDEX<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//拿到TypeList，合法性检查</span>
    <span class="token keyword">const</span> TypeList<span class="token operator">&amp;</span> typeConfigs <span class="token operator">=</span> grp<span class="token operator">-</span><span class="token operator">&gt;</span>types<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>typeConfigs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Type identifier 0x%x does not exist."</span><span class="token punctuation">,</span> t<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> BAD_INDEX<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//对entry的index做合法性检查</span>
    <span class="token keyword">const</span> size_t NENTRY <span class="token operator">=</span> typeConfigs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>entryCount<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>NENTRY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Entry identifier 0x%x is larger than entry count 0x%x"</span><span class="token punctuation">,</span>
             e<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>typeConfigs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>entryCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> BAD_INDEX<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// First see if we've already computed this bag...</span>
    <span class="token comment">/**
     * 在PackageGroup中，是有对Bag资源做缓存的，先去查缓存
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>grp<span class="token operator">-</span><span class="token operator">&gt;</span>bags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//bags根据资源的type、entry的index做了分类</span>
        bag_set<span class="token operator">*</span><span class="token operator">*</span> typeSet <span class="token operator">=</span> grp<span class="token operator">-</span><span class="token operator">&gt;</span>bags<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>typeSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            bag_set<span class="token operator">*</span> set <span class="token operator">=</span> typeSet<span class="token punctuation">[</span>e<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>set<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//缓存里面有</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>set <span class="token operator">!=</span> <span class="token punctuation">(</span>bag_set<span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>outTypeSpecFlags <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token operator">*</span>outTypeSpecFlags <span class="token operator">=</span> set<span class="token operator">-</span><span class="token operator">&gt;</span>typeSpecFlags<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//返回缓存里的数据，bag_set后面跟着所有的bag_entry</span>
                    <span class="token operator">*</span>outBag <span class="token operator">=</span> <span class="token punctuation">(</span>bag_entry<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>set<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//ALOGI("Found existing bag for: %p\n", (void*)resID);</span>
                    <span class="token comment">//返回bag的数量</span>
                    <span class="token keyword">return</span> set<span class="token operator">-</span><span class="token operator">&gt;</span>numAttrs<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Attempt to retrieve bag 0x%08x which is invalid or in a cycle."</span><span class="token punctuation">,</span>
                     resID<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> BAD_INDEX<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Bag not found, we need to compute it!</span>
    <span class="token comment">/**
     * 如果缓存中木有查到，那么说明我们是第一次获取,
     * 我们就只能自己去解析resources.arsc中对应的数据块来获取了
     */</span>

    <span class="token comment">//尚未给bags初始化，那就先初始化</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>grp<span class="token operator">-</span><span class="token operator">&gt;</span>bags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        grp<span class="token operator">-</span><span class="token operator">&gt;</span>bags <span class="token operator">=</span> <span class="token keyword">new</span> ByteBucketArray<span class="token operator">&lt;</span>bag_set<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>grp<span class="token operator">-</span><span class="token operator">&gt;</span>bags<span class="token punctuation">)</span> <span class="token keyword">return</span> NO_MEMORY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//尚未查寻过该type的bag</span>
    bag_set<span class="token operator">*</span><span class="token operator">*</span> typeSet <span class="token operator">=</span> grp<span class="token operator">-</span><span class="token operator">&gt;</span>bags<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>typeSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        typeSet <span class="token operator">=</span> <span class="token punctuation">(</span>bag_set<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span>NENTRY<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bag_set<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>typeSet<span class="token punctuation">)</span> <span class="token keyword">return</span> NO_MEMORY<span class="token punctuation">;</span>
        grp<span class="token operator">-</span><span class="token operator">&gt;</span>bags<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> typeSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Mark that we are currently working on this one.</span>
    typeSet<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>bag_set<span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0xFFFFFFFF</span><span class="token punctuation">;</span>

    <span class="token function">TABLE_NOISY</span><span class="token punctuation">(</span><span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Building bag: %p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>resID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Now collect all bag attributes</span>
    Entry entry<span class="token punctuation">;</span>
    <span class="token comment">//先获取camera_modes这个string-array对应的Entry</span>
    status_t err <span class="token operator">=</span> <span class="token function">getEntry</span><span class="token punctuation">(</span>grp<span class="token punctuation">,</span> t<span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mParams<span class="token punctuation">,</span> <span class="token operator">&amp;</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * entry.entry表示resources.arsc中对应的ResTable_entry
     * 确切地说是ResTable_map_entry，因为它有Bag资源
     * 并且ResTable_map_entry是可以有parent的，这么设计
     * 是考虑到style和theme是可以继承的
     */</span>
    <span class="token keyword">const</span> <span class="token keyword">uint16_t</span> entrySize <span class="token operator">=</span> <span class="token function">dtohs</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>entry<span class="token operator">-</span><span class="token operator">&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> parent <span class="token operator">=</span> entrySize <span class="token operator">&gt;=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ResTable_map_entry<span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token function">dtohl</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> ResTable_map_entry<span class="token operator">*</span><span class="token punctuation">)</span>entry<span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>parent<span class="token punctuation">.</span>ident<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//count表示我们的bag的数量，当然，不算parent的    </span>
    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> count <span class="token operator">=</span> entrySize <span class="token operator">&gt;=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ResTable_map_entry<span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token function">dtohl</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> ResTable_map_entry<span class="token operator">*</span><span class="token punctuation">)</span>entry<span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>count<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//bag的个数，不包括parent</span>
    size_t N <span class="token operator">=</span> count<span class="token punctuation">;</span>

    <span class="token function">TABLE_NOISY</span><span class="token punctuation">(</span><span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Found map: size=%p parent=%p count=%d\n"</span><span class="token punctuation">,</span>
                     entrySize<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// If this map inherits from another, we need to start</span>
    <span class="token comment">// with its parent's values.  Otherwise start out empty.</span>
    <span class="token function">TABLE_NOISY</span><span class="token punctuation">(</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Creating new bag, entrySize=0x%08x, parent=0x%08x\n"</span><span class="token punctuation">,</span>
                       entrySize<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// This is what we are building.</span>
    bag_set<span class="token operator">*</span> set <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">//如果有parent</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">uint32_t</span> resolvedParent <span class="token operator">=</span> parent<span class="token punctuation">;</span>

        <span class="token comment">// Bags encode a parent reference without using the standard</span>
        <span class="token comment">// Res_value structure. That means we must always try to</span>
        <span class="token comment">// resolve a parent reference in case it is actually a</span>
        <span class="token comment">// TYPE_DYNAMIC_REFERENCE.</span>
        <span class="token comment">/**
         * 上面的注释说的很明显，parent是个资源的ID或者说引用，而不是标准的Res_value，
         * 我们得考虑编译时和运行时同一个资源共享库的包ID不一致的问题
         * 有关资源共享库和DYNAMIC_REFERENCE的概念，请看这里：
         * https://blog.csdn.net/dayong198866/article/details/95226237
         */</span>
        status_t err <span class="token operator">=</span> grp<span class="token operator">-</span><span class="token operator">&gt;</span>dynamicRefTable<span class="token punctuation">.</span><span class="token function">lookupResourceId</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>resolvedParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Failed resolving bag parent id 0x%08x"</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> UNKNOWN_ERROR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//存储parent的bag，考虑style的情况，style是可以有parent的</span>
        <span class="token keyword">const</span> bag_entry<span class="token operator">*</span> parentBag<span class="token punctuation">;</span>
        <span class="token keyword">uint32_t</span> parentTypeSpecFlags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//递归调用，拿到parent的所有bag，当然包括parent的parent的parent...</span>
        <span class="token keyword">const</span> ssize_t NP <span class="token operator">=</span> <span class="token function">getBagLocked</span><span class="token punctuation">(</span>resolvedParent<span class="token punctuation">,</span> <span class="token operator">&amp;</span>parentBag<span class="token punctuation">,</span> <span class="token operator">&amp;</span>parentTypeSpecFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//我们这个资源的所有bag的数量，不考虑parent和自身都有的</span>
        <span class="token keyword">const</span> size_t NT <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>NP <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> NP <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> N<span class="token punctuation">;</span>
        <span class="token comment">//我们直接分配sizeof(bag_set) + NT个bag_entry的内存，考虑到自身有可能</span>
        <span class="token comment">//会重写parent的bag，所以NT个足够，但是不一定都能用上，可能用不完的，但我们就分配这么多啦</span>
        set <span class="token operator">=</span> <span class="token punctuation">(</span>bag_set<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>bag_set<span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>bag_entry<span class="token punctuation">)</span><span class="token operator">*</span>NT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>set <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> NO_MEMORY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>NP <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//把parent的bag拷贝过来，放到bag_set后面。</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>set<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> parentBag<span class="token punctuation">,</span> NP<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>bag_entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//更新当前已经解析了的bag的数目</span>
            set<span class="token operator">-</span><span class="token operator">&gt;</span>numAttrs <span class="token operator">=</span> NP<span class="token punctuation">;</span>
            <span class="token function">TABLE_NOISY</span><span class="token punctuation">(</span><span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Initialized new bag with %d inherited attributes.\n"</span><span class="token punctuation">,</span> NP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">TABLE_NOISY</span><span class="token punctuation">(</span><span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Initialized new bag with no inherited attributes.\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            set<span class="token operator">-</span><span class="token operator">&gt;</span>numAttrs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//表示分配了NT个内存</span>
        set<span class="token operator">-</span><span class="token operator">&gt;</span>availAttrs <span class="token operator">=</span> NT<span class="token punctuation">;</span>
        set<span class="token operator">-</span><span class="token operator">&gt;</span>typeSpecFlags <span class="token operator">=</span> parentTypeSpecFlags<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//没有parent的话，那就直接分配 bag_set + N个bag_entry的内存啦</span>
        set <span class="token operator">=</span> <span class="token punctuation">(</span>bag_set<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>bag_set<span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>bag_entry<span class="token punctuation">)</span><span class="token operator">*</span>N<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>set <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> NO_MEMORY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//一个坑儿而也没占呢</span>
        set<span class="token operator">-</span><span class="token operator">&gt;</span>numAttrs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//分配了N个坑儿</span>
        set<span class="token operator">-</span><span class="token operator">&gt;</span>availAttrs <span class="token operator">=</span> N<span class="token punctuation">;</span>
        set<span class="token operator">-</span><span class="token operator">&gt;</span>typeSpecFlags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    set<span class="token operator">-</span><span class="token operator">&gt;</span>typeSpecFlags <span class="token operator">|</span><span class="token operator">=</span> entry<span class="token punctuation">.</span>specFlags<span class="token punctuation">;</span>


    <span class="token comment">//到这里parent相关的东西算是处理完了，开始处理自身的bag</span>

    <span class="token comment">// Now merge in the new attributes...</span>
    <span class="token comment">/**
     * entry的类型为ResTable::Entry，它内部的entry成员也就是entry.entry指向resources.arsc
     * 中的ResTable_entry在内存中的地址，而entry.entry后面跟着的就是N个ResTable_map,
     * 也就是我们要找的bag了，所以curOff表示我们要找的首个bag相对与entry.type的偏移量
     */</span>
    size_t curOff <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>uintptr_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>entry<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>uintptr_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">+</span> <span class="token function">dtohs</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>entry<span class="token operator">-</span><span class="token operator">&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ResTable_map<span class="token operator">*</span> map<span class="token punctuation">;</span>
    <span class="token comment">//bag_entry放在bag_set后面</span>
    bag_entry<span class="token operator">*</span> entries <span class="token operator">=</span> <span class="token punctuation">(</span>bag_entry<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>set<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    size_t curEntry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">TABLE_NOISY</span><span class="token punctuation">(</span><span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Starting with set %p, entries=%p, avail=%d\n"</span><span class="token punctuation">,</span>
                 set<span class="token punctuation">,</span> entries<span class="token punctuation">,</span> set<span class="token operator">-</span><span class="token operator">&gt;</span>availAttrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> count<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">TABLE_NOISY</span><span class="token punctuation">(</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now at %p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>curOff<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>curOff <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token function">dtohl</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>type<span class="token operator">-</span><span class="token operator">&gt;</span>header<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token operator">-</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ResTable_map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"ResTable_map at %d is beyond type chunk data %d"</span><span class="token punctuation">,</span>
                 <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>curOff<span class="token punctuation">,</span> <span class="token function">dtohl</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>type<span class="token operator">-</span><span class="token operator">&gt;</span>header<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> BAD_TYPE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//拿到ResTable_map的地址</span>
        map <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> ResTable_map<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>entry<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">+</span> curOff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        N<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">//就是ResTable_map中键值对儿中的键或者key，对应一个资源id</span>
        <span class="token comment">//对应与string-array中的^index_%d</span>
        <span class="token keyword">uint32_t</span> newName <span class="token operator">=</span> <span class="token function">htodl</span><span class="token punctuation">(</span>map<span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">.</span>ident<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">Res_INTERNALID</span><span class="token punctuation">(</span>newName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Attributes don't have a resource id as the name. They specify</span>
            <span class="token comment">// other data, which would be wrong to change via a lookup.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>grp<span class="token operator">-</span><span class="token operator">&gt;</span>dynamicRefTable<span class="token punctuation">.</span><span class="token function">lookupResourceId</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>newName<span class="token punctuation">)</span> <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Failed resolving ResTable_map name at %d with ident 0x%08x"</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> curOff<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> newName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> UNKNOWN_ERROR<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/**
         * 需要说明的是bag_set后面跟的bag_entry是按照id也就是map-&gt;name.ident升序排列的
         * 所以当这里添加一个bag的时候，也会按照顺序插入。
         */</span>
        <span class="token keyword">bool</span> isInside<span class="token punctuation">;</span>
        <span class="token keyword">uint32_t</span> oldName <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 找到合适的插入位置，就是最后一个比当前map-&gt;name.ident小的哪个bag的下一个位置
         * 或者当前所有bag_entry的末尾
         */</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>isInside<span class="token operator">=</span><span class="token punctuation">(</span>curEntry <span class="token operator">&lt;</span> set<span class="token operator">-</span><span class="token operator">&gt;</span>numAttrs<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>oldName<span class="token operator">=</span>entries<span class="token punctuation">[</span>curEntry<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span>name<span class="token punctuation">.</span>ident<span class="token punctuation">)</span> <span class="token operator">&lt;</span> newName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">TABLE_NOISY</span><span class="token punctuation">(</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"#%d: Keeping existing attribute: 0x%08x\n"</span><span class="token punctuation">,</span>
                         curEntry<span class="token punctuation">,</span> entries<span class="token punctuation">[</span>curEntry<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span>name<span class="token punctuation">.</span>ident<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            curEntry<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//这种情况表示这是一个新的bag，尚未加入到bag_set后面</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>isInside<span class="token punctuation">)</span> <span class="token operator">||</span> oldName <span class="token operator">!=</span> newName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// This is a new attribute...  figure out what to do with it.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>set<span class="token operator">-</span><span class="token operator">&gt;</span>numAttrs <span class="token operator">&gt;=</span> set<span class="token operator">-</span><span class="token operator">&gt;</span>availAttrs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Need to alloc more memory...</span>
                <span class="token comment">//内存不够，那就追加内存</span>
                <span class="token keyword">const</span> size_t newAvail <span class="token operator">=</span> set<span class="token operator">-</span><span class="token operator">&gt;</span>availAttrs<span class="token operator">+</span>N<span class="token punctuation">;</span>
                set <span class="token operator">=</span> <span class="token punctuation">(</span>bag_set<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">realloc</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span>
                                        <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bag_set<span class="token punctuation">)</span>
                                        <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bag_entry<span class="token punctuation">)</span><span class="token operator">*</span>newAvail<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>set <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> NO_MEMORY<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//更新坑儿的个数和起始地址</span>
                set<span class="token operator">-</span><span class="token operator">&gt;</span>availAttrs <span class="token operator">=</span> newAvail<span class="token punctuation">;</span>
                entries <span class="token operator">=</span> <span class="token punctuation">(</span>bag_entry<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>set<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">TABLE_NOISY</span><span class="token punctuation">(</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Reallocated set %p, entries=%p, avail=%d\n"</span><span class="token punctuation">,</span>
                             set<span class="token punctuation">,</span> entries<span class="token punctuation">,</span> set<span class="token operator">-</span><span class="token operator">&gt;</span>availAttrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isInside<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Going in the middle, need to make space.</span>
                <span class="token comment">//把第curEntry个以及它后面的bag往后移动一个位置</span>
                <span class="token comment">//这样就把第curEntry个位置空出来了，</span>
                <span class="token comment">//空出来的这个位置就是留给当前bag的，实现当前bag的插入</span>
                <span class="token function">memmove</span><span class="token punctuation">(</span>entries<span class="token operator">+</span>curEntry<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> entries<span class="token operator">+</span>curEntry<span class="token punctuation">,</span>
                        <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bag_entry<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>set<span class="token operator">-</span><span class="token operator">&gt;</span>numAttrs<span class="token operator">-</span>curEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                set<span class="token operator">-</span><span class="token operator">&gt;</span>numAttrs<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">TABLE_NOISY</span><span class="token punctuation">(</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"#%d: Inserting new attribute: 0x%08x\n"</span><span class="token punctuation">,</span>
                         curEntry<span class="token punctuation">,</span> newName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//走到这里表示第curEntry个位置的bag，已经放入bag_set</span>
            <span class="token comment">//后面了，这样我们直接复用，不再新增bag_entry结构</span>
            <span class="token function">TABLE_NOISY</span><span class="token punctuation">(</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"#%d: Replacing existing attribute: 0x%08x\n"</span><span class="token punctuation">,</span>
                         curEntry<span class="token punctuation">,</span> oldName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//当前bag插入的位置</span>
        bag_entry<span class="token operator">*</span> cur <span class="token operator">=</span> entries<span class="token operator">+</span>curEntry<span class="token punctuation">;</span>
        <span class="token comment">/**
         * stringBlock的值，果然被设置成了entry也就是我们的string-array所在的包在ResTable中的索引
         */</span>
        cur<span class="token operator">-</span><span class="token operator">&gt;</span>stringBlock <span class="token operator">=</span> entry<span class="token punctuation">.</span>package<span class="token operator">-</span><span class="token operator">&gt;</span>header<span class="token operator">-</span><span class="token operator">&gt;</span>index<span class="token punctuation">;</span>
        cur<span class="token operator">-</span><span class="token operator">&gt;</span>map<span class="token punctuation">.</span>name<span class="token punctuation">.</span>ident <span class="token operator">=</span> newName<span class="token punctuation">;</span>
        cur<span class="token operator">-</span><span class="token operator">&gt;</span>map<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">copyFrom_dtoh</span><span class="token punctuation">(</span>map<span class="token operator">-</span><span class="token operator">&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//map.value可能是动态引用，那么还需要去DynamicRefTable中更新一下</span>
        <span class="token comment">//packageId，这样我们使用bag资源的时候就可以不用再去考虑这个问题了</span>
        status_t err <span class="token operator">=</span> grp<span class="token operator">-</span><span class="token operator">&gt;</span>dynamicRefTable<span class="token punctuation">.</span><span class="token function">lookupResourceValue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cur<span class="token operator">-</span><span class="token operator">&gt;</span>map<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Reference item(0x%08x) in bag could not be resolved."</span><span class="token punctuation">,</span> cur<span class="token operator">-</span><span class="token operator">&gt;</span>map<span class="token punctuation">.</span>value<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> UNKNOWN_ERROR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">TABLE_NOISY</span><span class="token punctuation">(</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Setting entry #%d %p: block=%d, name=0x%08x, type=%d, data=0x%08x\n"</span><span class="token punctuation">,</span>
                     curEntry<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> cur<span class="token operator">-</span><span class="token operator">&gt;</span>stringBlock<span class="token punctuation">,</span> cur<span class="token operator">-</span><span class="token operator">&gt;</span>map<span class="token punctuation">.</span>name<span class="token punctuation">.</span>ident<span class="token punctuation">,</span>
                     cur<span class="token operator">-</span><span class="token operator">&gt;</span>map<span class="token punctuation">.</span>value<span class="token punctuation">.</span>dataType<span class="token punctuation">,</span> cur<span class="token operator">-</span><span class="token operator">&gt;</span>map<span class="token punctuation">.</span>value<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// On to the next!</span>
        curEntry<span class="token operator">++</span><span class="token punctuation">;</span>
        pos<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">//这两行代码没看懂，为啥不这么写呢？</span>
        <span class="token comment">// curOff += sizeof(*map)；</span>
        <span class="token keyword">const</span> size_t size <span class="token operator">=</span> <span class="token function">dtohs</span><span class="token punctuation">(</span>map<span class="token operator">-</span><span class="token operator">&gt;</span>value<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        curOff <span class="token operator">+</span><span class="token operator">=</span> size <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>map<span class="token punctuation">)</span><span class="token operator">-</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>map<span class="token operator">-</span><span class="token operator">&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 前面的代码中isInside为false的情况下，也就是
     * bag添加到最末尾的情况下，不会走set-&gt;numAttrs++
     * 然后在这里加了个判断，打补丁的味道很重，额，貌似补丁打的位置也不好
     * 这个代码差评，哈哈
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curEntry <span class="token operator">&gt;</span> set<span class="token operator">-</span><span class="token operator">&gt;</span>numAttrs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        set<span class="token operator">-</span><span class="token operator">&gt;</span>numAttrs <span class="token operator">=</span> curEntry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// And this is it...</span>
    <span class="token comment">//终于可以收尾了，直接放到typeSet里，这样更新了缓存，以后再获取就不用</span>
    <span class="token comment">//再去解析了，直接缓存里拿</span>
    typeSet<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">=</span> set<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>set<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>outTypeSpecFlags <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>outTypeSpecFlags <span class="token operator">=</span> set<span class="token operator">-</span><span class="token operator">&gt;</span>typeSpecFlags<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//输出bag_entry</span>
        <span class="token operator">*</span>outBag <span class="token operator">=</span> <span class="token punctuation">(</span>bag_entry<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>set<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">TABLE_NOISY</span><span class="token punctuation">(</span><span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Returning %d attrs\n"</span><span class="token punctuation">,</span> set<span class="token operator">-</span><span class="token operator">&gt;</span>numAttrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//输出bag的数量</span>
        <span class="token keyword">return</span> set<span class="token operator">-</span><span class="token operator">&gt;</span>numAttrs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> BAD_INDEX<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>        <code>getBagLocked</code>方法比较长，并且有递归，阅读的时候需要些耐心，总体来说它主要做的包括：先根据resID的package、type、entry索引，去<code>PackageGroup</code>的缓存中查寻，如果查到，则返回，查不到的话，再去内存中的resources.arsc中去解析。解析的时候，先去加载parent的Bag，这是一个递归的过程，并且加载完成后，里面的<code>bag_entry</code>是按照bag的key值升序排列的。加载完parent的bag，就是解析和加载自身的bag了，这个过程其实就是选择一个合适的位置，在顺序表中做一个插入或者更新操作。更新是因为，一个资源自身的bag可以重写其parent的bag，最后更新缓存，返回结果。另外，在添加一个一个的bag的过程中，还会根据情况动态扩展分配内存。</p> 
<p>        到这里，string-array这种带有Bag的资源信息的获取过程就算结束了。我们看到，其获取过程并不像不带Bag的那些资源那样直接到<code>ResTable</code>中调用<code>getResource</code>方法，拿到对应的<code>ResTable::Entry</code>，进而获取到对应的<code>Res_value</code>，消除动态引用，再解析一下普通引用就完事儿了；它在获取到对应的<code>ResTable::Entry</code>后，要根据这个<code>ResTable::Entry</code>，去拿到它所对应的所有Bag，毕竟我们关心的数据都放在Bag里，然后再对这些Bag做处理，才能得到最终的结果。</p> 
<h4><a id="style_533"></a>style资源的获取</h4> 
<p>        style也是一种典型的带有Bag的资源，一个item就是一个Bag，Bag的key是item中的属性，value则是属性的值。我们说的style资源的获取就是指，获取style中某些属性的值。其在<code>Resources</code>类 中对应的方法是：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> TypedArray <span class="token function">obtainStyledAttributes</span><span class="token punctuation">(</span><span class="token keyword">int</span> resid<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> attrs<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> len <span class="token operator">=</span> attrs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">final</span> TypedArray array <span class="token operator">=</span> TypedArray<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>Resources<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    array<span class="token punctuation">.</span>mTheme <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    AssetManager<span class="token punctuation">.</span><span class="token function">applyStyle</span><span class="token punctuation">(</span>mTheme<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> resid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> array<span class="token punctuation">.</span>mData<span class="token punctuation">,</span> array<span class="token punctuation">.</span>mIndices<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> array<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>        <code>AssetManager.applyStyle</code>这个方法的实现，我们在<a href="https://blog.csdn.net/dayong198866/article/details/98249980">Android资源管理中的Theme和Style-------之实现（二）</a>中已经做过详细的介绍，这里不再赘述，其核心依然是要调用<code>ResTable</code>的<code>getBagLocked</code>方法，获取所有的Bag，再将这些Bag的<code>Res_value</code>中的字段封装到<code>TypedArray</code>中返回。</p> 
<p>        还记得我们在前面抛出的那个问题吗，也就是<code>bag_entry</code>的那个<code>stringBlock</code>字段是否多余，它存在的意义是什么？这里就不卖关子了，直接给出答案：不多余。在不考虑parent的情况下这个字段确实没有什么意义，但是考虑到parent的时候，就不一样了，看下面的这个例子：<br>         假设系统资源包中有这么个style：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Widget.CompoundButton.Switch<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token style language-css">
    &lt;item name=<span class="token string">"textOn"</span>&gt;on&lt;/item&gt;
    &lt;item name=<span class="token string">"textOff"</span>&gt;off&lt;/item&gt;
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>        假设我们的APK中有这么个style：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Widget.CompoundButton.Switch.DarkSwitch<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token style language-css">
    &lt;item name=<span class="token string">"android:background"</span>&gt;@color/dark_grey&lt;/item&gt;
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>        我们知道<code>Widget.CompoundButton.Switch.DarkSwitch</code>继承自<code>Widget.CompoundButton.Switch</code>，假设<code>bag_entry</code>中没有<code>stringBlock</code>字段，那么当我们在APK中去获取<code>android:textOn</code>这个属性的值的时候，我们将会得到什么呢？</p> 
<p>        根据前面的步骤，我们在获取Bag的时候，先去获取parent的，也就是<code>Widget.CompoundButton.Switch</code>的，我们得到的<code>bag_entry</code>中没有<code>stringBlock</code>字段，<code>bag_entry.map.value.data</code>的值将会是on这个字符串在系统的Global String Pool中的索引。然后，<code>getBagLocked</code>方法，把parent的<code>textOn</code>这个Bag copy到我们的APK包中的<code>bag_set</code>后面，然后在后面加入<code>android:background</code>这个Bag。我们获取到<code>textOn</code>这个Bag的时候，由于没有<code>stringBlock</code>字段，默认就是从当前包，也就是我们的APK包的的Global String Pool中根据<code>bag_entry.map.value.data</code>的值，也就是那个索引去查找字符串。这明显不对，应该去系统资源包而不是我们APK的资源包中去获取对应的string。所以说，在考虑parent也就是继承的时候，<code>stringBlock</code>这个字段是必须的。</p> 
<h4><a id="plurals_564"></a>plurals资源的获取</h4> 
<p>        plurals资源的获取，则主要是指<code>Resources</code>类的<code>getQuantityText</code>方法。关于这个方法的功能网上介绍的很多，这里就不再说了。我们直接看其实现：</p> 
<pre><code class="prism language-java"><span class="token comment">//frameworks/base/base/core/java/android/content/res/Resources.java</span>
<span class="token keyword">public</span> CharSequence <span class="token function">getQuantityText</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token keyword">int</span> quantity<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//会根据locale信息，创建对应的rule对象</span>
    NativePluralRules rule <span class="token operator">=</span> <span class="token function">getPluralRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//attrForQuantityCode（rule.quantityForInt(quantity)）</span>
    <span class="token comment">//则会根据不同的quantityCode，返回不同的bag ID</span>
    <span class="token comment">/**
     * private static int attrForQuantityCode(int quantityCode) {
        switch (quantityCode) {
            case NativePluralRules.ZERO: return 0x01000005;
            case NativePluralRules.ONE:  return 0x01000006;
            case NativePluralRules.TWO:  return 0x01000007;
            case NativePluralRules.FEW:  return 0x01000008;
            case NativePluralRules.MANY: return 0x01000009;
            default:                     return ID_OTHER;
        }
      }
     */</span>
    CharSequence res <span class="token operator">=</span> mAssets<span class="token punctuation">.</span><span class="token function">getResourceBagText</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>
            <span class="token function">attrForQuantityCode</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">quantityForInt</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    res <span class="token operator">=</span> mAssets<span class="token punctuation">.</span><span class="token function">getResourceBagText</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> ID_OTHER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token string">"Plural resource ID #0x"</span> <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">" quantity="</span> <span class="token operator">+</span> quantity
                <span class="token operator">+</span> <span class="token string">" item="</span> <span class="token operator">+</span> <span class="token function">stringForQuantityCode</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">quantityForInt</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>        我们看到<code>getQuantityText</code>方法会根据不同的QuantityCode去获取对应的字符串，如果没有获取到，则会以<code>ID_OTHER</code>这个QuantityCode再去获取一次。如果还没获取到，这抛出异常。和前面的style与各种array的获取不太一样的是，这里我们只是从众多的Bag中根据QuantityCode选择一个合适的，看具体实现：</p> 
<pre><code class="prism language-java"><span class="token comment">//frameworks/base/core/java/android/content/res/AssetManager.java</span>
<span class="token keyword">final</span> CharSequence <span class="token function">getResourceBagText</span><span class="token punctuation">(</span><span class="token keyword">int</span> ident<span class="token punctuation">,</span> <span class="token keyword">int</span> bagEntryId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        TypedValue tmpValue <span class="token operator">=</span> mValue<span class="token punctuation">;</span>
        <span class="token comment">//loadResourceBagValue是个native方法，</span>
        <span class="token keyword">int</span> block <span class="token operator">=</span> <span class="token function">loadResourceBagValue</span><span class="token punctuation">(</span>ident<span class="token punctuation">,</span> bagEntryId<span class="token punctuation">,</span> tmpValue<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//类型检查，根据block到对应的Global String Pool中根据tmpValue.data这个索引值，拿到具体的字符串</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpValue<span class="token punctuation">.</span>type <span class="token operator">==</span> TypedValue<span class="token punctuation">.</span>TYPE_STRING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> mStringBlocks<span class="token punctuation">[</span>block<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tmpValue<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> tmpValue<span class="token punctuation">.</span><span class="token function">coerceToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>        <code>loadResourceBagValue</code>方法的实现很简单：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> jint <span class="token function">android_content_AssetManager_loadResourceBagValue</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">,</span>
                                                           jint ident<span class="token punctuation">,</span> jint bagEntryId<span class="token punctuation">,</span>
                                                           jobject outValue<span class="token punctuation">,</span> jboolean resolve<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//还是熟悉的老套路，从java层保存的地址直接拿到native层的AssetManager对象</span>
    AssetManager<span class="token operator">*</span> am <span class="token operator">=</span> <span class="token function">assetManagerForJavaObject</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>am <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//拿到ResTable对象后才算开始干活，哈哈</span>
    <span class="token keyword">const</span> ResTable<span class="token operator">&amp;</span> <span class="token function">res</span><span class="token punctuation">(</span>am<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Now lock down the resource object and start pulling stuff from it.</span>
    res<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ssize_t block <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    Res_value value<span class="token punctuation">;</span>

    <span class="token keyword">const</span> ResTable<span class="token operator">::</span>bag_entry<span class="token operator">*</span> entry <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> typeSpecFlags<span class="token punctuation">;</span>
    <span class="token comment">//熟悉的代码，拿到所有的bag</span>
    ssize_t entryCount <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">getBagLocked</span><span class="token punctuation">(</span>ident<span class="token punctuation">,</span> <span class="token operator">&amp;</span>entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>typeSpecFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//从这些bag中选择对应的QuantityCode的bag</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>ssize_t i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>entryCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span>bagEntryId<span class="token punctuation">)</span> <span class="token operator">==</span> entry<span class="token operator">-</span><span class="token operator">&gt;</span>map<span class="token punctuation">.</span>name<span class="token punctuation">.</span>ident<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            block <span class="token operator">=</span> entry<span class="token operator">-</span><span class="token operator">&gt;</span>stringBlock<span class="token punctuation">;</span>
            value <span class="token operator">=</span> entry<span class="token operator">-</span><span class="token operator">&gt;</span>map<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        entry<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    res<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>jint<span class="token operator">&gt;</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">uint32_t</span> ref <span class="token operator">=</span> ident<span class="token punctuation">;</span>
    <span class="token comment">//resolve为true，所以这里还需要对引用做解析</span>
    <span class="token comment">//但是要不要先解析动态引用呢？不需要！还记得getBagLocked方法已经解析过动态引用了吗？</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        block <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">resolveReference</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">,</span> block<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ref<span class="token punctuation">,</span> <span class="token operator">&amp;</span>typeSpecFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> THROW_ON_BAD_ID</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">==</span> BAD_INDEX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">jniThrowException</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"java/lang/IllegalStateException"</span><span class="token punctuation">,</span> <span class="token string">"Bad resource!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
    <span class="token punctuation">}</span>
    <span class="token comment">//copy到输出参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">copyValue</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> outValue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">,</span> value<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> block<span class="token punctuation">,</span> typeSpecFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//return block值</span>
    <span class="token keyword">return</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>jint<span class="token operator">&gt;</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>        plurals资源的获取，也就是<code>getQuantityText</code>的实现相对简单得多，需要说明的也就是plurals资源的bag中，key就是QuantityCode，value则是我们每一个Quantity的具体值。另外大家不知道有没有发现，QuantityCode也是形如0xpptteeee的资源ID，并且其tt部分是0x00，总算知道为啥我们平常用到的资源的type index都是从0x01开始的了，原来0x00被plurals的QuantityCode占用啦！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6ac71c78c6afb831c9890d32db2d25e9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring Data JPA 学习</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f38bb5115874e747adb82b236623187c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">防火墙配置NAT 多出口</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>