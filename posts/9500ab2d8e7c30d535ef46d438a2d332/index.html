<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>7 集中式日志和分布式跟踪 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="7 集中式日志和分布式跟踪" />
<meta property="og:description" content="文章目录 日志聚合模式日志集中化的简单解决方案使用日志并输出分布式跟踪Spring Cloud Sleuth实现分布式跟踪 小结 前面的文章： 1、 1 一个测试驱动的Spring Boot应用程序开发 2、 2 使用React构造前端应用 3、 3 试驱动的Spring Boot应用程序开发数据层示例 4、 4 向微服务架构转变 5、 5 转向事件驱动的架构 6、 6 网关和配置服务器 代码：下载
前面的系统中已经涉及几个组件生成的日志（Multiplication、Gamification、Gateway、Consul、RabbitMQ），其中某些组件可能有多个实例，很多日志输出是独立运行的，很难获得系统活动的整体视图。如果用户报告错误，很难找出哪个组件或实例出现故障。在一个屏幕上安排多个日志窗口会有用，但当微服务实例数量增加时，这就不是那么容易解决的了。
要很好地维护像微服务架构这样的分布式系统，需要一个中心位置，在那里可以访问所有聚合日志并进行搜索。
日志聚合模式 通常是将所有的日志输出从应用程序发送到另一个组件，该组件将它们聚合在一起，另外，希望日志能保留一段时间，因此，需要数据存储功能。理想情况下，应该能够浏览这些日志，搜索并过滤每个微服务、实例、类等信息，为此，许多工具提供了一个用户界面，用于连接到聚合日志存储。如图所示：
Gamification Multiplication Gateway 分析/查询/过滤 发送日志 发送日志 发送日志 集中式日志 日志聚合 过滤和搜索 日志记录代理 日志记录代理 日志记录代理 用户 实现集中式日志记录时，最好的做法是应用程序逻辑不逻辑此模式，服务应该只使用公共接口来输出消息，将这些日志传送到中央聚合器的日志记录代理独立工作，捕获应用程序产生的输出。
现在有这种模式的多种实现，包括免费和付费的解决方案，其中最受欢迎的是ELK堆栈：Elasticsearch、Logstash和Kibana。
随着时间的推移，建立ELK堆栈已经越来越容易，但仍然不是一项容易的任务，这里不使用ELK实现，就不做介绍了。
日志集中化的简单解决方案 要实现集中式日志处理，需要建立一个新的微服务，来汇总来自Spring Boot应用程序的日志，为了简单起见，不用数据层来保存日志，只接收来自其他服务的日志，并输出到标准输出中。这种方案有助于实现分布式跟踪。
要实现日志输出，需要使用已有的工具RabbitMQ，要捕获应用程序中的每个日志记录行并以RabbitMQ消息的形式发送，因为Spring Boot一直使用Logback，不需要修改应用程序中的代码，就可以由外部配置文件驱动。
在Logback中，将日志行写入特定目标的逻辑部分称为附加程序，此日志记录库包含一些内置的附加程序，用于将消息输出到控制台（ConsoleAppender）或文件（FileAppender和RollingFileAppender）。不需要配置，因为Spring Boot在其依赖项中包含了一些默认的Logback配置，还设置了输出的消息格式。
Spring AMQP提供了一个Logback AMQP日志记录附加程序，可以满足其需要，该附加程序接收每一行日志并为RabbitMQ中的给定交换生成一条消息，其中包含格式和其他一些自定义的选项。
首先准备要添加的Logback配置。Spring Boot可以在应用程序资源文件夹（src/main/resources）中创建一个logback-spring.xml文件来扩展默认值，该文件将在应用程序初始化时自动获取。AMQP附加程序文档列出了所有参数及其含义：
applicationId：Application ID — 应用ID - 如果 pattern 包括 %X{applicationId}，则添加到 routing key 中。将其设置为应用程序名称，便于在汇总日志时区分源。host：连接到的RabbitMQ主机。由于环境的不同，将该值连接到spring." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/9500ab2d8e7c30d535ef46d438a2d332/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-09T08:36:17+08:00" />
<meta property="article:modified_time" content="2024-01-09T08:36:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">7 集中式日志和分布式跟踪</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_13" rel="nofollow">日志聚合模式</a></li><li><a href="#_39" rel="nofollow">日志集中化的简单解决方案</a></li><li><a href="#_94" rel="nofollow">使用日志并输出</a></li><li><a href="#_322" rel="nofollow">分布式跟踪</a></li><li><ul><li><a href="#Spring_Cloud_Sleuth_327" rel="nofollow">Spring Cloud Sleuth</a></li><li><a href="#_348" rel="nofollow">实现分布式跟踪</a></li></ul> 
  </li><li><a href="#_450" rel="nofollow">小结</a></li></ul> 
</div> 
<br> 前面的文章： 
<br> 1、 
<a href="https://blog.csdn.net/ZhangCurie/article/details/134475842">1 一个测试驱动的Spring Boot应用程序开发</a> 
<br> 2、 
<a href="https://blog.csdn.net/ZhangCurie/article/details/134553385">2 使用React构造前端应用</a> 
<br> 3、 
<a href="https://blog.csdn.net/ZhangCurie/article/details/134576807">3 试驱动的Spring Boot应用程序开发数据层示例</a> 
<br> 4、 
<a href="https://blog.csdn.net/ZhangCurie/article/details/134614535">4 向微服务架构转变</a> 
<br> 5、 
<a href="https://blog.csdn.net/ZhangCurie/article/details/134752757">5 转向事件驱动的架构</a> 
<br> 6、 
<a href="https://blog.csdn.net/ZhangCurie/article/details/134965124">6 网关和配置服务器</a> 
<p></p> 
<p>代码：<a href="https://download.csdn.net/download/ZhangCurie/88684659">下载</a></p> 
<p>前面的系统中已经涉及几个组件生成的日志（Multiplication、Gamification、Gateway、Consul、RabbitMQ），其中某些组件可能有多个实例，很多日志输出是独立运行的，很难获得系统活动的整体视图。如果用户报告错误，很难找出哪个组件或实例出现故障。在一个屏幕上安排多个日志窗口会有用，但当微服务实例数量增加时，这就不是那么容易解决的了。<br> 要很好地维护像微服务架构这样的分布式系统，需要一个中心位置，在那里可以访问所有聚合日志并进行搜索。</p> 
<h2><a id="_13"></a>日志聚合模式</h2> 
<p>通常是将所有的日志输出从应用程序发送到另一个组件，该组件将它们聚合在一起，另外，希望日志能保留一段时间，因此，需要数据存储功能。理想情况下，应该能够浏览这些日志，搜索并过滤每个微服务、实例、类等信息，为此，许多工具提供了一个用户界面，用于连接到聚合日志存储。如图所示：</p> 
<div class="mermaid"> 
 <svg id="mermaid-svg-jhKtPVK5kWNkewz4" width="713.88330078125" xmlns="http://www.w3.org/2000/svg" height="385" viewbox="0 0 713.88330078125 385" class="mermaid-svg"> 
  <style>#mermaid-svg-jhKtPVK5kWNkewz4 {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-jhKtPVK5kWNkewz4 .error-icon{fill:#552222;}#mermaid-svg-jhKtPVK5kWNkewz4 .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-jhKtPVK5kWNkewz4 .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-jhKtPVK5kWNkewz4 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-jhKtPVK5kWNkewz4 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-jhKtPVK5kWNkewz4 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-jhKtPVK5kWNkewz4 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-jhKtPVK5kWNkewz4 .marker{fill:#333333;stroke:#333333;}#mermaid-svg-jhKtPVK5kWNkewz4 .marker.cross{stroke:#333333;}#mermaid-svg-jhKtPVK5kWNkewz4 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-jhKtPVK5kWNkewz4 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-jhKtPVK5kWNkewz4 .cluster-label text{fill:#333;}#mermaid-svg-jhKtPVK5kWNkewz4 .cluster-label span{color:#333;}#mermaid-svg-jhKtPVK5kWNkewz4 .label text,#mermaid-svg-jhKtPVK5kWNkewz4 span{fill:#333;color:#333;}#mermaid-svg-jhKtPVK5kWNkewz4 .node rect,#mermaid-svg-jhKtPVK5kWNkewz4 .node circle,#mermaid-svg-jhKtPVK5kWNkewz4 .node ellipse,#mermaid-svg-jhKtPVK5kWNkewz4 .node polygon,#mermaid-svg-jhKtPVK5kWNkewz4 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-jhKtPVK5kWNkewz4 .node .label{text-align:center;}#mermaid-svg-jhKtPVK5kWNkewz4 .node.clickable{cursor:pointer;}#mermaid-svg-jhKtPVK5kWNkewz4 .arrowheadPath{fill:#333333;}#mermaid-svg-jhKtPVK5kWNkewz4 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-jhKtPVK5kWNkewz4 .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-jhKtPVK5kWNkewz4 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-jhKtPVK5kWNkewz4 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-jhKtPVK5kWNkewz4 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-jhKtPVK5kWNkewz4 .cluster text{fill:#333;}#mermaid-svg-jhKtPVK5kWNkewz4 .cluster span{color:#333;}#mermaid-svg-jhKtPVK5kWNkewz4 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-jhKtPVK5kWNkewz4 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style> 
  <g transform="translate(0, 0)"> 
   <marker id="flowchart-pointEnd" class="marker flowchart" viewbox="0 0 10 10" refx="9" refy="5" markerunits="userSpaceOnUse" markerwidth="12" markerheight="12" orient="auto"> 
    <path d="M 0 0 L 10 5 L 0 10 z" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <marker id="flowchart-pointStart" class="marker flowchart" viewbox="0 0 10 10" refx="0" refy="5" markerunits="userSpaceOnUse" markerwidth="12" markerheight="12" orient="auto"> 
    <path d="M 0 5 L 10 10 L 10 0 z" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <marker id="flowchart-circleEnd" class="marker flowchart" viewbox="0 0 10 10" refx="11" refy="5" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <circle cx="5" cy="5" r="5" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></circle> 
   </marker> 
   <marker id="flowchart-circleStart" class="marker flowchart" viewbox="0 0 10 10" refx="-1" refy="5" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <circle cx="5" cy="5" r="5" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></circle> 
   </marker> 
   <marker id="flowchart-crossEnd" class="marker cross flowchart" viewbox="0 0 11 11" refx="12" refy="5.2" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <path d="M 1,1 l 9,9 M 10,1 l -9,9" class="arrowMarkerPath" style="stroke-width: 2px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <marker id="flowchart-crossStart" class="marker cross flowchart" viewbox="0 0 11 11" refx="-1" refy="5.2" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <path d="M 1,1 l 9,9 M 10,1 l -9,9" class="arrowMarkerPath" style="stroke-width: 2px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <g class="root"> 
    <g class="clusters"> 
     <g class="cluster default" id="ga"> 
      <rect style="" rx="0" ry="0" x="524.8833312988281" y="8" width="181" height="91"></rect> 
      <g class="cluster-label" transform="translate(569.3249969482422, 13)"> 
       <foreignobject width="92.11666870117188" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">Gamification</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="cluster default" id="m"> 
      <rect style="" rx="0" ry="0" x="323.8833312988281" y="8" width="181" height="91"></rect> 
      <g class="cluster-label" transform="translate(365.1333312988281, 13)"> 
       <foreignobject width="98.5" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">Multiplication</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="cluster default" id="g"> 
      <rect style="" rx="0" ry="0" x="122.88333129882812" y="8" width="181" height="91"></rect> 
      <g class="cluster-label" transform="translate(182.14166259765625, 13)"> 
       <foreignobject width="62.48333740234375" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">Gateway</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="edgePaths"> 
     <path d="M64.38333129882812,74L64.38333129882812,78.16666666666667C64.38333129882812,82.33333333333333,64.38333129882812,90.66666666666667,64.38333129882812,101.16666666666667C64.38333129882812,111.66666666666667,64.38333129882812,124.33333333333333,93.88333129882812,147.10153640614564C123.38333129882812,169.8697394789579,182.38333129882812,202.73947895791582,211.88333129882812,219.17434869739478L241.38333129882812,235.60921843687373" id="L-u-c-0" class=" edge-thickness-normal edge-pattern-solid flowchart-link LS-u LE-c" style="fill:none;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M213.38333129882812,74L213.38333129882812,78.16666666666667C213.38333129882812,82.33333333333333,213.38333129882812,90.66666666666667,213.38333129882812,101.16666666666667C213.38333129882812,111.66666666666667,213.38333129882812,124.33333333333333,218.04999796549478,137.12106135986733C222.71666463216147,149.9087893864013,232.04999796549478,162.81757877280265,236.71666463216147,169.27197346600332L241.38333129882812,175.726368159204" id="L-g1-c-0" class=" edge-thickness-normal edge-pattern-solid flowchart-link LS-g1 LE-c" style="fill:none;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M414.3833312988281,74L414.3833312988281,78.16666666666667C414.3833312988281,82.33333333333333,414.3833312988281,90.66666666666667,414.3833312988281,101.16666666666667C414.3833312988281,111.66666666666667,414.3833312988281,124.33333333333333,409.71666463216144,137.12106135986733C405.0499979654948,149.9087893864013,395.71666463216144,162.81757877280265,391.0499979654948,169.27197346600332L386.3833312988281,175.726368159204" id="L-m1-c-0" class=" edge-thickness-normal edge-pattern-solid flowchart-link LS-m1 LE-c" style="fill:none;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M615.3833312988281,74L615.3833312988281,78.16666666666667C615.3833312988281,82.33333333333333,615.3833312988281,90.66666666666667,615.3833312988281,101.16666666666667C615.3833312988281,111.66666666666667,615.3833312988281,124.33333333333333,577.2166646321615,148.26257600884466C539.0499979654948,172.191818684356,462.71666463216144,207.38363736871202,424.5499979654948,224.97954671089L386.3833312988281,242.575456053068" id="L-ga1-c-0" class=" edge-thickness-normal edge-pattern-solid flowchart-link LS-ga1 LE-c" style="fill:none;" marker-end="url(#flowchart-pointEnd)"></path> 
    </g> 
    <g class="edgeLabels"> 
     <g class="edgeLabel" transform="translate(64.38333129882812, 137)"> 
      <g class="label" transform="translate(-56.383331298828125, -13)"> 
       <foreignobject width="112.76666259765625" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">分析/查询/过滤</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(213.38333129882812, 137)"> 
      <g class="label" transform="translate(-32, -13)"> 
       <foreignobject width="64" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">发送日志</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(414.3833312988281, 137)"> 
      <g class="label" transform="translate(-32, -13)"> 
       <foreignobject width="64" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">发送日志</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(615.3833312988281, 137)"> 
      <g class="label" transform="translate(-32, -13)"> 
       <foreignobject width="64" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">发送日志</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="nodes"> 
     <g class="root" transform="translate(233.88333129882812, 167)"> 
      <g class="clusters"> 
       <g class="cluster default" id="c"> 
        <rect style="" rx="0" ry="0" x="8" y="8" width="145" height="202"></rect> 
        <g class="cluster-label" transform="translate(40.5, 13)"> 
         <foreignobject width="80" height="26"> 
          <div style="display: inline-block; white-space: nowrap;"> 
           <span class="nodeLabel">集中式日志</span> 
          </div> 
         </foreignobject> 
        </g> 
       </g> 
      </g> 
      <g class="edgePaths"></g> 
      <g class="edgeLabels"></g> 
      <g class="nodes"> 
       <g class="node default default" id="flowchart-c1-297" transform="translate(80.5, 63.5)"> 
        <rect class="basic label-container" style="" rx="0" ry="0" x="-39.5" y="-20.5" width="79" height="41"></rect> 
        <g class="label" style="" transform="translate(-32, -13)"> 
         <foreignobject width="64" height="26"> 
          <div style="display: inline-block; white-space: nowrap;"> 
           <span class="nodeLabel">日志聚合</span> 
          </div> 
         </foreignobject> 
        </g> 
       </g> 
       <g class="node default default" id="flowchart-c2-298" transform="translate(80.5, 154.5)"> 
        <rect class="basic label-container" style="" rx="0" ry="0" x="-47.5" y="-20.5" width="95" height="41"></rect> 
        <g class="label" style="" transform="translate(-40, -13)"> 
         <foreignobject width="80" height="26"> 
          <div style="display: inline-block; white-space: nowrap;"> 
           <span class="nodeLabel">过滤和搜索</span> 
          </div> 
         </foreignobject> 
        </g> 
       </g> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-ga1-296" transform="translate(615.3833312988281, 53.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-55.5" y="-20.5" width="111" height="41"></rect> 
      <g class="label" style="" transform="translate(-48, -13)"> 
       <foreignobject width="96" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">日志记录代理</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-m1-295" transform="translate(414.3833312988281, 53.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-55.5" y="-20.5" width="111" height="41"></rect> 
      <g class="label" style="" transform="translate(-48, -13)"> 
       <foreignobject width="96" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">日志记录代理</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-g1-294" transform="translate(213.38333129882812, 53.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-55.5" y="-20.5" width="111" height="41"></rect> 
      <g class="label" style="" transform="translate(-48, -13)"> 
       <foreignobject width="96" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">日志记录代理</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-u-299" transform="translate(64.38333129882812, 53.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-23.5" y="-20.5" width="47" height="41"></rect> 
      <g class="label" style="" transform="translate(-16, -13)"> 
       <foreignobject width="32" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">用户</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
   </g> 
  </g> 
 </svg> 
</div> 
<p>实现集中式日志记录时，最好的做法是应用程序逻辑不逻辑此模式，服务应该只使用公共接口来输出消息，将这些日志传送到中央聚合器的日志记录代理独立工作，捕获应用程序产生的输出。<br> 现在有这种模式的多种实现，包括免费和付费的解决方案，其中最受欢迎的是ELK堆栈：Elasticsearch、Logstash和Kibana。<br> 随着时间的推移，建立ELK堆栈已经越来越容易，但仍然不是一项容易的任务，这里不使用ELK实现，就不做介绍了。</p> 
<h2><a id="_39"></a>日志集中化的简单解决方案</h2> 
<p>要实现集中式日志处理，需要建立一个新的微服务，来汇总来自Spring Boot应用程序的日志，为了简单起见，不用数据层来保存日志，只接收来自其他服务的日志，并输出到标准输出中。这种方案有助于实现分布式跟踪。<br> 要实现日志输出，需要使用已有的工具RabbitMQ，要捕获应用程序中的每个日志记录行并以RabbitMQ消息的形式发送，因为Spring Boot一直使用Logback，不需要修改应用程序中的代码，就可以由外部配置文件驱动。<br> 在Logback中，将日志行写入特定目标的逻辑部分称为附加程序，此日志记录库包含一些内置的附加程序，用于将消息输出到控制台（ConsoleAppender）或文件（FileAppender和RollingFileAppender）。不需要配置，因为Spring Boot在其依赖项中包含了一些默认的Logback配置，还设置了输出的消息格式。<br> Spring AMQP提供了一个Logback AMQP日志记录附加程序，可以满足其需要，该附加程序接收每一行日志并为RabbitMQ中的给定交换生成一条消息，其中包含格式和其他一些自定义的选项。<br> 首先准备要添加的Logback配置。Spring Boot可以在应用程序资源文件夹（src/main/resources）中创建一个logback-spring.xml文件来扩展默认值，该文件将在应用程序初始化时自动获取。AMQP附加程序文档列出了所有参数及其含义：</p> 
<ul><li>applicationId：Application ID — 应用ID - 如果 pattern 包括 %X{applicationId}，则添加到 routing key 中。将其设置为应用程序名称，便于在汇总日志时区分源。</li><li>host：连接到的RabbitMQ主机。由于环境的不同，将该值连接到spring.rabbitmq.host，Spring可以使用springProperty标签来设置。应该给Logback的host属性起一个名字RabbitMQHost，并使用语法${rabbitMQHost:-localhost}来使用该属性值（如果以设置）或使用默认的localhost（默认使用:-分隔设置）。</li><li>routingKeyPattern：Logging 子系统的 pattern format，用于生成 routing key。如果要在消费者端进行过滤，需要将其设置为applicationId和level（用%p表示）的串联，以提供更大的灵活性。</li><li>exchangeName：要发布日志事件的 exchange 的名称。默认情况下，会是一个主题交换，可定义为logs.topic。</li><li>declareExchange：是否在这个 appender 启动时声明配置的 exchange。如果尚未创建交换，则设为true。</li><li>durable：当 declareExchange 为 true 时，durable 标志被设置为这个值。以便交换在服务器重新启动后继续存在。</li><li>deliveryMode：设为 PERSISTENT，以便存储日志消息，直到聚合器使用为止。PERSISTENT 或 NON_PERSISTENT，以确定 RabbitMQ 是否应该持久化消息。</li><li>generateId：用于确定 messageId 属性是否被设置为唯一值。设为true，每条消息有唯一标识。</li><li>charset：将 String 转换为 byte[] 时使用的字符集。默认：null（使用系统默认字符集）。如果当前平台不支持该字符集，将退回到使用系统字符集。最好设为UTF-8，以确保使用相同的编码。</li></ul> 
<p>Gamification项目的logback-spring.xml内容如下：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org/springframework/boot/logging/logback/defaults.xml<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org/springframework/boot/logging/logback/console-appender.xml<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>springProperty</span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>context<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rabbitMQHost<span class="token punctuation">"</span></span> <span class="token attr-name">source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring.rabbitmq.host<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>AMQP<span class="token punctuation">"</span></span>
              <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.amqp.rabbit.logback.AmqpAppender<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>%d{HH:mm:ss.SSS} [%t] %logger{36} - %msg<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layout</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>applicationId</span><span class="token punctuation">&gt;</span></span>gamification<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>applicationId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>${rabbitMQHost:-localhost}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>routingKeyPattern</span><span class="token punctuation">&gt;</span></span>%property{applicationId}.%p<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>routingKeyPattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exchangeName</span><span class="token punctuation">&gt;</span></span>logs.topic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exchangeName</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generateId</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>generateId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>charset</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>charset</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>durable</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>durable</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>declareExchange</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>declareExchange</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>deliveryMode</span><span class="token punctuation">&gt;</span></span>PERSISTENT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>deliveryMode</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>INFO<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CONSOLE<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>AMQP<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>从中可以看到如何将自定义模式添加到附加程序中的，这就可以对消息进行编码，不仅包括消息（%msg），还包括一些额外的信息，如时间（%d{hh:mm:ss.SSS}）、线程名（[%t]）和记录器类（%logger{36}）等。文件最后配置根记录器（默认记录器），使用某个包含的文件中定义的CONSOLE附加程序和新定义的AMQP附加程序。<br> 现在需要在其他项目中添加类似的文件，并修改相应的applicationId值。<br> 除了设置日志生成器外，还可以将附加程序用于连接到RabbitMQ的类的日志级别调整为WARN，可避免当RabbitMQ服务器不可用时生成数百条日志，可添加到application配置中：</p> 
<pre><code class="prism language-properties">logging.level.org.springframework.amqp.rabbit.connection.CachingConnectionFactory=WARN
</code></pre> 
<p>启动应用程序时，日志不仅输出到控制台，还在RabbitMQ服务器的logs.topic交换中生成消息，可在RabbitMQ的Web界面进行验证，如图所示：<br> <img src="https://images2.imgbox.com/5b/e8/A6KnnbUp_o.png" alt="logs.topic"></p> 
<h2><a id="_94"></a>使用日志并输出</h2> 
<p>已经将所有日志发布到交换了，现在就来构建一个新的微服务，来使用这些消息并将之输出。<br> 创建一个新的项目：logs，使用Maven和Jdk21，支持依赖：RabbitMQ、Spring Web、Validation、Spring Boot Actuator、Lombok、Consul Configuration等，不需要服务发现，因此不添加Consul Discovery，如图所示：<br> <img src="https://images2.imgbox.com/53/c0/IrOY3gwc_o.png" alt="new"><br> 打开pom.xml，结果如下：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.2.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.zhangjuli<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>logs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>logs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>logs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>21<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>2023.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-validation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-consul-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbit-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>在src/main/resources/application.properties文件中配置如下：</p> 
<pre><code class="prism language-properties">spring.application.name=logs
server.port=8580
spring.config.import=consul:
spring.cloud.consul.config.prefix=config
spring.cloud.consul.config.format=yaml
spring.cloud.consul.config.default-context=defaults
spring.cloud.consul.config.data-key=application.yml
</code></pre> 
<p>现在需要一个Spring Boot配置类来声明交换、要使用的消息队列，以及将队列附加到主题交换的绑定对象，并使用绑定键模式来使用所有这些对象（#），AMQPConfiguration类如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>zhangjuli<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>configuration</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Juli Zhang, &lt;a href="mailto:zhjl@lut.edu.cn"&gt;Contact me&lt;/a&gt; &lt;br&gt;
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AMQPConfiguration</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TopicExchange</span> <span class="token function">logsExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">ExchangeBuilder</span><span class="token punctuation">.</span><span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token string">"logs.topic"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">logsQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token string">"logs.queue"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">logsBinding</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Queue</span> logsQueue<span class="token punctuation">,</span>
                               <span class="token keyword">final</span> <span class="token class-name">TopicExchange</span> logsExchange<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>logsQueue<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>logsExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下面使用@RabbitListener注解创建一个简单服务，使用相应的log.info()、log.error()或log.warn()将作为RabbitMQ消息头传递的接收消息的日志记录级别映射到Logs微服务中的日志记录级别。注意，这里使用@Header注解将AMQP消息头提取为方法参数，还使用日志记录Marker将应用程序名称（appId）添加到日志行，而不必将其作为消息的一部分进行串联，这是SLF4J标准的灵活用法，可将上下文值添加到日志中。接收RabbitMQ日志消息的消费者类如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>zhangjuli<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>consumer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Marker</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">MarkerFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Header</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Juli Zhang, &lt;a href="mailto:zhjl@lut.edu.cn"&gt;Contact me&lt;/a&gt; &lt;br&gt;
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogsConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"logs.queue"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> msg<span class="token punctuation">,</span>
                    <span class="token annotation punctuation">@Header</span><span class="token punctuation">(</span><span class="token string">"level"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> level<span class="token punctuation">,</span>
                    <span class="token annotation punctuation">@Header</span><span class="token punctuation">(</span><span class="token string">"amqp_appId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> appId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Marker</span> marker <span class="token operator">=</span> <span class="token class-name">MarkerFactory</span><span class="token punctuation">.</span><span class="token function">getMarker</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>level<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token string">"INFO"</span> <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>marker<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"ERROR"</span> <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>marker<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"WARN"</span> <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>marker<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后，定义日志输出，因为要聚合来自不同服务的多个日志，相关属性是应用程序名称，logback-spring.xml如下：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CONSOLE<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.classic.PatternLayout<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Pattern</span><span class="token punctuation">&gt;</span></span>
                [%-15marker] %highlight(%-5level) %msg%n
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Pattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layout</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>INFO<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CONSOLE<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>重新启动整个系统，就可以在Logs控制台看到所有日志信息，例如：</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>multiplication <span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token number">17</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">57.018</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">10080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>z<span class="token punctuation">.</span>m<span class="token punctuation">.</span>challenge<span class="token punctuation">.</span></span>ChallengeServiceImpl</span> <span class="token operator">-</span> attempt<span class="token operator">:</span> <span class="token class-name">ChallengeAttempt</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">352</span><span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">202</span><span class="token punctuation">,</span> alias<span class="token operator">=</span>noise7<span class="token punctuation">)</span><span class="token punctuation">,</span> factorA<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> factorB<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">,</span> resultAttempt<span class="token operator">=</span><span class="token number">3000</span><span class="token punctuation">,</span> correct<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>gamification   <span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token number">17</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">57.046</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span></span>RabbitListenerEndpointContainer</span>#<span class="token number">0</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>z<span class="token punctuation">.</span>g<span class="token punctuation">.</span>game<span class="token punctuation">.</span></span>GameEventHandler</span> <span class="token operator">-</span> 已接收到成功挑战事件：<span class="token number">352</span>
<span class="token punctuation">[</span>gamification   <span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token number">17</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">57.101</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span></span>RabbitListenerEndpointContainer</span>#<span class="token number">0</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>z<span class="token punctuation">.</span>g<span class="token punctuation">.</span>game<span class="token punctuation">.</span></span>GameServiceImpl</span> <span class="token operator">-</span> 用户 noise7 的尝试 <span class="token number">352</span> 得分 <span class="token number">10</span>
<span class="token punctuation">[</span>gamification   <span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token number">17</span><span class="token operator">:</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">01.856</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">8081</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>z<span class="token punctuation">.</span>g<span class="token punctuation">.</span>game<span class="token punctuation">.</span></span>LeaderBoardController</span> <span class="token operator">-</span> 查询排行榜
<span class="token punctuation">[</span>gamification   <span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token number">17</span><span class="token operator">:</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">01.856</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">8081</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>z<span class="token punctuation">.</span>g<span class="token punctuation">.</span>game<span class="token punctuation">.</span></span>LeaderBoardController</span> <span class="token operator">-</span> 查询排行榜
</code></pre> 
<p>这个简单的日志聚合器没有花费多少时间，现在可以在同一源中搜索日志，并看到所有服务中近乎实时的输出流。其过程如图所示：</p> 
<div class="mermaid"> 
 <svg id="mermaid-svg-EAkilrh899alA6mh" width="747.6083374023438" xmlns="http://www.w3.org/2000/svg" height="1366.5484619140625" viewbox="0 0 747.6083374023438 1366.5484619140625" class="mermaid-svg"> 
  <style>#mermaid-svg-EAkilrh899alA6mh {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-EAkilrh899alA6mh .error-icon{fill:#552222;}#mermaid-svg-EAkilrh899alA6mh .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-EAkilrh899alA6mh .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-EAkilrh899alA6mh .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-EAkilrh899alA6mh .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-EAkilrh899alA6mh .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-EAkilrh899alA6mh .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-EAkilrh899alA6mh .marker{fill:#333333;stroke:#333333;}#mermaid-svg-EAkilrh899alA6mh .marker.cross{stroke:#333333;}#mermaid-svg-EAkilrh899alA6mh svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-EAkilrh899alA6mh .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-EAkilrh899alA6mh .cluster-label text{fill:#333;}#mermaid-svg-EAkilrh899alA6mh .cluster-label span{color:#333;}#mermaid-svg-EAkilrh899alA6mh .label text,#mermaid-svg-EAkilrh899alA6mh span{fill:#333;color:#333;}#mermaid-svg-EAkilrh899alA6mh .node rect,#mermaid-svg-EAkilrh899alA6mh .node circle,#mermaid-svg-EAkilrh899alA6mh .node ellipse,#mermaid-svg-EAkilrh899alA6mh .node polygon,#mermaid-svg-EAkilrh899alA6mh .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-EAkilrh899alA6mh .node .label{text-align:center;}#mermaid-svg-EAkilrh899alA6mh .node.clickable{cursor:pointer;}#mermaid-svg-EAkilrh899alA6mh .arrowheadPath{fill:#333333;}#mermaid-svg-EAkilrh899alA6mh .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-EAkilrh899alA6mh .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-EAkilrh899alA6mh .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-EAkilrh899alA6mh .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-EAkilrh899alA6mh .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-EAkilrh899alA6mh .cluster text{fill:#333;}#mermaid-svg-EAkilrh899alA6mh .cluster span{color:#333;}#mermaid-svg-EAkilrh899alA6mh div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-EAkilrh899alA6mh :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style> 
  <g transform="translate(0, 0)"> 
   <marker id="flowchart-pointEnd" class="marker flowchart" viewbox="0 0 10 10" refx="9" refy="5" markerunits="userSpaceOnUse" markerwidth="12" markerheight="12" orient="auto"> 
    <path d="M 0 0 L 10 5 L 0 10 z" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <marker id="flowchart-pointStart" class="marker flowchart" viewbox="0 0 10 10" refx="0" refy="5" markerunits="userSpaceOnUse" markerwidth="12" markerheight="12" orient="auto"> 
    <path d="M 0 5 L 10 10 L 10 0 z" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <marker id="flowchart-circleEnd" class="marker flowchart" viewbox="0 0 10 10" refx="11" refy="5" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <circle cx="5" cy="5" r="5" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></circle> 
   </marker> 
   <marker id="flowchart-circleStart" class="marker flowchart" viewbox="0 0 10 10" refx="-1" refy="5" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <circle cx="5" cy="5" r="5" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></circle> 
   </marker> 
   <marker id="flowchart-crossEnd" class="marker cross flowchart" viewbox="0 0 11 11" refx="12" refy="5.2" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <path d="M 1,1 l 9,9 M 10,1 l -9,9" class="arrowMarkerPath" style="stroke-width: 2px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <marker id="flowchart-crossStart" class="marker cross flowchart" viewbox="0 0 11 11" refx="-1" refy="5.2" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <path d="M 1,1 l 9,9 M 10,1 l -9,9" class="arrowMarkerPath" style="stroke-width: 2px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <g class="root"> 
    <g class="clusters"> 
     <g class="cluster default" id="ga"> 
      <rect style="" rx="0" ry="0" x="112.44999694824219" y="778.5043182373047" width="283.6000061035156" height="91"></rect> 
      <g class="cluster-label" transform="translate(208.19166564941406, 783.5043182373047)"> 
       <foreignobject width="92.11666870117188" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">Gamification</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="cluster default" id="g"> 
      <rect style="" rx="0" ry="0" x="16" y="177" width="723.6083374023438" height="91"></rect> 
      <g class="cluster-label" transform="translate(361.8041687011719, 182)"> 
       <foreignobject width="32" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">网关</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="edgePaths"> 
     <path d="M547.9125061035156,1067.5043182373045L547.8291727701823,1085.0043182373045C547.745839436849,1102.5043182373045,547.5791727701823,1137.5043182373047,547.495839436849,1159.1709849039714C547.4125061035156,1180.837651570638,547.4125061035156,1189.1709849039714,547.4125061035156,1193.337651570638L547.4125061035156,1197.5043182373047" id="L-l-lq-0" class=" edge-thickness-normal edge-pattern-dotted flowchart-link LS-l LE-lq" style="fill:none;stroke-width:2px;stroke-dasharray:3;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M547.4125061035156,1267.548439025879L547.4125061035156,1271.7151056925456C547.4125061035156,1275.8817723592122,547.4125061035156,1284.2151056925456,547.4125061035156,1292.548439025879C547.4125061035156,1300.8817723592122,547.4125061035156,1309.2151056925456,547.4125061035156,1313.3817723592122L547.4125061035156,1317.548439025879" id="L-lq-c-0" class=" edge-thickness-normal edge-pattern-dotted flowchart-link LS-lq LE-c" style="fill:none;stroke-width:2px;stroke-dasharray:3;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M345.30000305175787,572.5L345.2166697184245,578.75C345.1333363850911,585,344.9666697184245,597.5,344.8833363850911,610.0833333333334C344.8000030517578,622.6666666666666,344.8000030517578,635.3333333333334,344.8000030517578,641.6666666666666L344.8000030517578,648" id="L-a-q-0" class=" edge-thickness-normal edge-pattern-dotted flowchart-link LS-a LE-q" style="fill:none;stroke-width:2px;stroke-dasharray:3;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M372.27916717529297,49L372.27916717529297,59.666666666666664C372.27916717529297,70.33333333333333,372.27916717529297,91.66666666666667,372.27916717529297,113C372.27916717529297,134.33333333333334,372.27916717529297,155.66666666666666,372.27916717529297,166.33333333333334L372.27916717529297,177" id="L-b-g-0" class=" edge-thickness-normal edge-pattern-solid flowchart-link LS-b LE-g" style="fill:none;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M308.77916717529297,231.63512586302807L266.6493059794108,237.69593821919003C224.51944478352866,243.75675057535204,140.2597223917643,255.87837528767602,98.12986119588216,270.439187643838C56,285,56,302,56,328.25C56,354.5,56,390,56,421.1666666666667C56,452.3333333333333,56,479.1666666666667,56,500.1666666666667C56,521.1666666666666,56,536.3333333333334,56,553.6666666666666C56,571,56,590.5,56,613.2920265197754C56,636.0840530395508,56,662.1681060791016,56,686.0854924519857C56,710.0028788248698,56,731.7535985310873,56,746.7956250508627C56,761.8376515706381,56,770.1709849039713,56,781.9209849039713C56,793.6709849039713,56,808.8376515706381,56,824.0043182373047C56,839.1709849039713,56,854.3376515706381,56,868.2543182373047C56,882.1709849039713,56,894.8376515706381,64.78333282470703,909.8481937818323C73.56666564941406,924.8587359930262,91.13333129882812,942.2131537487479,99.91666412353516,950.8903626266087L108.69999694824219,959.5675715044696" id="L-g1-r-0" class=" edge-thickness-normal edge-pattern-dotted flowchart-link LS-g1 LE-r" style="fill:none;stroke-width:2px;stroke-dasharray:3;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M218.53296703296704,844.5043182373047L209.4441391941392,848.6709849039713C200.35531135531133,852.8376515706381,182.17765567765568,861.1709849039713,173.08882783882783,871.6709849039713C164,882.1709849039713,164,894.8376515706381,165.48992791850503,907.5043182373047C166.9798558370101,920.1709849039713,169.95971167402016,932.8376515706381,171.4496395925252,939.1709849039713L172.93956751103025,945.5043182373047" id="L-ga1-r-0" class=" edge-thickness-normal edge-pattern-dotted flowchart-link LS-ga1 LE-r" style="fill:none;stroke-width:2px;stroke-dasharray:3;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M304,869.5043182373047L304,875.8376515706381C304,882.1709849039713,304,894.8376515706381,299.11103103601107,907.5043182373047C294.2220620720221,920.1709849039713,284.4441241440441,932.8376515706381,279.5551551800552,939.1709849039713L274.6661862160662,945.5043182373047" id="L-ga-r-0" class=" edge-thickness-normal edge-pattern-dotted flowchart-link LS-ga LE-r" style="fill:none;stroke-width:2px;stroke-dasharray:3;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M460.1536270994577,481L463.687745483272,485.1666666666667C467.22186386708637,489.3333333333333,474.2901006347151,497.6666666666667,477.8242190185294,509.4166666666667C481.35833740234375,521.1666666666666,481.35833740234375,536.3333333333334,481.35833740234375,553.6666666666666C481.35833740234375,571,481.35833740234375,590.5,481.35833740234375,613.2920265197754C481.35833740234375,636.0840530395508,481.35833740234375,662.1681060791016,481.35833740234375,686.0854924519857C481.35833740234375,710.0028788248698,481.35833740234375,731.7535985310873,481.35833740234375,746.7956250508627C481.35833740234375,761.8376515706381,481.35833740234375,770.1709849039713,481.35833740234375,781.9209849039713C481.35833740234375,793.6709849039713,481.35833740234375,808.8376515706381,481.35833740234375,824.0043182373047C481.35833740234375,839.1709849039713,481.35833740234375,854.3376515706381,472.1034762064616,868.2543182373047C462.8486150105794,882.1709849039713,444.3388926188151,894.8376515706381,411.56250254313153,915.4401958800613C378.78611246744794,936.0427401894846,331.74305470784503,964.5811621416645,308.22152582804364,978.8503731177544L284.6999969482422,993.1195840938445" id="L-m-r-0" class=" edge-thickness-normal edge-pattern-dotted flowchart-link LS-m LE-r" style="fill:none;stroke-width:2px;stroke-dasharray:3;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M485.5791702270508,468.32569464555763L496.2090314229329,474.6047455379647C506.8388926188151,480.8837964303718,528.0986150105795,493.44189821518586,538.7284762064616,507.3042824409263C549.3583374023438,521.1666666666666,549.3583374023438,536.3333333333334,549.3583374023438,553.6666666666666C549.3583374023438,571,549.3583374023438,590.5,549.3583374023438,613.2920265197754C549.3583374023438,636.0840530395508,549.3583374023438,662.1681060791016,549.3583374023438,686.0854924519857C549.3583374023438,710.0028788248698,549.3583374023438,731.7535985310873,549.3583374023438,746.7956250508627C549.3583374023438,761.8376515706381,549.3583374023438,770.1709849039713,549.3583374023438,781.9209849039713C549.3583374023438,793.6709849039713,549.3583374023438,808.8376515706381,549.3583374023438,824.0043182373047C549.3583374023438,839.1709849039713,549.3583374023438,854.3376515706381,536.1034762064616,868.2543182373047C522.8486150105795,882.1709849039713,496.3388926188151,894.8376515706381,494.10756295933714,920.9209849039713C491.87623329985917,947.0043182373047,513.9232963726676,986.5043182373047,524.9468279090717,1006.2543182373047L535.9703594454759,1026.0043182373047" id="L-m-l-0" class=" edge-thickness-normal edge-pattern-dotted flowchart-link LS-m LE-l" style="fill:none;stroke-width:2px;stroke-dasharray:3;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M354.8000030517578,869.5043182373047L379.97153091430664,875.8376515706381C405.14305877685547,882.1709849039713,455.4861145019531,894.8376515706381,486.6493993205704,921.0043182373047C517.8126841391877,947.1709849039713,529.7961980513245,986.8376515706381,535.787955007393,1006.6709849039713L541.7797119634614,1026.5043182373047" id="L-ga-l-0" class=" edge-thickness-normal edge-pattern-dotted flowchart-link LS-ga LE-l" style="fill:none;stroke-width:2px;stroke-dasharray:3;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M662.9416732788086,268L662.9416732788086,276.5C662.9416732788086,285,662.9416732788086,302,662.9416732788086,328.25C662.9416732788086,354.5,662.9416732788086,390,662.9416732788086,421.1666666666667C662.9416732788086,452.3333333333333,662.9416732788086,479.1666666666667,662.9416732788086,500.1666666666667C662.9416732788086,521.1666666666666,662.9416732788086,536.3333333333334,662.9416732788086,553.6666666666666C662.9416732788086,571,662.9416732788086,590.5,662.9416732788086,613.2920265197754C662.9416732788086,636.0840530395508,662.9416732788086,662.1681060791016,662.9416732788086,686.0854924519857C662.9416732788086,710.0028788248698,662.9416732788086,731.7535985310873,662.9416732788086,746.7956250508627C662.9416732788086,761.8376515706381,662.9416732788086,770.1709849039713,662.9416732788086,781.9209849039713C662.9416732788086,793.6709849039713,662.9416732788086,808.8376515706381,662.9416732788086,824.0043182373047C662.9416732788086,839.1709849039713,662.9416732788086,854.3376515706381,662.9416732788086,868.2543182373047C662.9416732788086,882.1709849039713,662.9416732788086,894.8376515706381,646.6098911321992,921.0043182373047C630.2781089855898,947.1709849039713,597.614544692371,986.8376515706381,581.2827625457617,1006.6709849039713L564.9509803991523,1026.5043182373047" id="L-g-l-0" class=" edge-thickness-normal edge-pattern-dotted flowchart-link LS-g LE-l" style="fill:none;stroke-width:2px;stroke-dasharray:3;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M413.0791702270508,268L413.0791702270508,276.5C413.0791702270508,285,413.0791702270508,302,413.0791702270508,319C413.0791702270508,336,413.0791702270508,353,413.0791702270508,361.5L413.0791702270508,370" id="L-g-m-0" class=" edge-thickness-normal edge-pattern-solid flowchart-link LS-g LE-m" style="fill:none;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M181.6999969482422,268L181.6999969482422,276.5C181.6999969482422,285,181.6999969482422,302,181.6999969482422,328.25C181.6999969482422,354.5,181.6999969482422,390,181.6999969482422,421.1666666666667C181.6999969482422,452.3333333333333,181.6999969482422,479.1666666666667,181.6999969482422,500.1666666666667C181.6999969482422,521.1666666666666,181.6999969482422,536.3333333333334,181.6999969482422,553.6666666666666C181.6999969482422,571,181.6999969482422,590.5,181.6999969482422,613.2920265197754C181.6999969482422,636.0840530395508,181.6999969482422,662.1681060791016,181.6999969482422,686.0854924519857C181.6999969482422,710.0028788248698,181.6999969482422,731.7535985310873,181.6999969482422,746.7956250508627C181.6999969482422,761.8376515706381,181.6999969482422,770.1709849039713,181.6999969482422,774.3376515706381L181.6999969482422,778.5043182373047" id="L-g-ga-0" class=" edge-thickness-normal edge-pattern-solid flowchart-link LS-g LE-ga" style="fill:none;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M366.00471335464385,481L362.47059497082955,485.1666666666667C358.9364765870152,489.3333333333333,351.8682398193865,497.6666666666667,348.3341214355722,506C344.8000030517578,514.3333333333334,344.8000030517578,522.6666666666666,344.8000030517578,526.8333333333334L344.8000030517578,531" id="L-m-a-0" class=" edge-thickness-normal edge-pattern-dotted flowchart-link LS-m LE-a" style="fill:none;stroke-width:2px;stroke-dasharray:3;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M344.8000030517578,728.5043182373047L344.8000030517578,732.6709849039713C344.8000030517578,736.8376515706381,344.8000030517578,745.1709849039713,344.8000030517578,753.5043182373047C344.8000030517578,761.8376515706381,344.8000030517578,770.1709849039713,344.8000030517578,774.3376515706381L344.8000030517578,778.5043182373047" id="L-q-ga-0" class=" edge-thickness-normal edge-pattern-dotted flowchart-link LS-q LE-ga" style="fill:none;stroke-width:2px;stroke-dasharray:3;" marker-end="url(#flowchart-pointEnd)"></path> 
    </g> 
    <g class="edgeLabels"> 
     <g class="edgeLabel"> 
      <g class="label" transform="translate(0, 0)"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel"> 
      <g class="label" transform="translate(0, 0)"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel"> 
      <g class="label" transform="translate(0, 0)"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(372.27916717529297, 113)"> 
      <g class="label" transform="translate(-50.93333435058594, -39)"> 
       <foreignobject width="101.86666870117188" height="78"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">-发送尝试<br>-获取用户别名<br>-获取排行榜</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(56, 610)"> 
      <g class="label" transform="translate(-48, -13)"> 
       <foreignobject width="96" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">查找服务实例</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(164, 907.5043182373047)"> 
      <g class="label" transform="translate(-88, -13)"> 
       <foreignobject width="176" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">注册表自身（每个实例）</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(304, 907.5043182373047)"> 
      <g class="label" transform="translate(-32, -13)"> 
       <foreignobject width="64" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">获取配置</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(481.35833740234375, 688.2521591186523)"> 
      <g class="label" transform="translate(-32, -13)"> 
       <foreignobject width="64" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">获取配置</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(549.3583374023438, 688.2521591186523)"> 
      <g class="label" transform="translate(-16, -13)"> 
       <foreignobject width="32" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">日志</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(505.8291702270508, 907.5043182373047)"> 
      <g class="label" transform="translate(-16, -13)"> 
       <foreignobject width="32" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">日志</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(662.9416732788086, 610)"> 
      <g class="label" transform="translate(-16, -13)"> 
       <foreignobject width="32" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">日志</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(413.0791702270508, 319)"> 
      <g class="label" transform="translate(-50.93333435058594, -26)"> 
       <foreignobject width="101.86666870117188" height="52"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">-发送尝试<br>-获取用户别名</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(181.6999969482422, 551.5)"> 
      <g class="label" transform="translate(-42.93333435058594, -13)"> 
       <foreignobject width="85.86666870117188" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">-获取排行榜</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel"> 
      <g class="label" transform="translate(0, 0)"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel"> 
      <g class="label" transform="translate(0, 0)"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="nodes"> 
     <g class="node default default" id="flowchart-ga1-359" transform="translate(263.25, 824.0043182373047)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-47.5" y="-20.5" width="95" height="41"></rect> 
      <g class="label" style="" transform="translate(-40, -13)"> 
       <foreignobject width="80" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">注册服务者</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="root" transform="translate(333.0791702270508, 362)"> 
      <g class="clusters"> 
       <g class="cluster default" id="m"> 
        <rect style="" rx="0" ry="0" x="8" y="8" width="145" height="111"></rect> 
        <g class="cluster-label" transform="translate(31.25, 13)"> 
         <foreignobject width="98.5" height="26"> 
          <div style="display: inline-block; white-space: nowrap;"> 
           <span class="nodeLabel">Multiplication</span> 
          </div> 
         </foreignobject> 
        </g> 
       </g> 
      </g> 
      <g class="edgePaths"></g> 
      <g class="edgeLabels"></g> 
      <g class="nodes"> 
       <g class="node default default" id="flowchart-m1-358" transform="translate(80.5, 63.5)"> 
        <rect class="basic label-container" style="" rx="0" ry="0" x="-47.5" y="-20.5" width="95" height="41"></rect> 
        <g class="label" style="" transform="translate(-40, -13)"> 
         <foreignobject width="80" height="26"> 
          <div style="display: inline-block; white-space: nowrap;"> 
           <span class="nodeLabel">注册服务者</span> 
          </div> 
         </foreignobject> 
        </g> 
       </g> 
      </g> 
     </g> 
     <g class="root" transform="translate(124.19999694824219, 937.5043182373047)"> 
      <g class="clusters"> 
       <g class="cluster default" id="r"> 
        <rect style="" rx="0" ry="0" x="-7.5" y="8" width="176" height="202"></rect> 
        <g class="cluster-label" transform="translate(-7.5, 13)"> 
         <foreignobject width="176" height="26"> 
          <div style="display: inline-block; white-space: nowrap;"> 
           <span class="nodeLabel">服务注册表和配置服务器</span> 
          </div> 
         </foreignobject> 
        </g> 
       </g> 
      </g> 
      <g class="edgePaths"></g> 
      <g class="edgeLabels"></g> 
      <g class="nodes"> 
       <g class="node default default" id="flowchart-r1-354" transform="translate(80.5, 63.5)"> 
        <rect class="basic label-container" style="" rx="0" ry="0" x="-47.5" y="-20.5" width="95" height="41"></rect> 
        <g class="label" style="" transform="translate(-40, -13)"> 
         <foreignobject width="80" height="26"> 
          <div style="display: inline-block; white-space: nowrap;"> 
           <span class="nodeLabel">服务注册表</span> 
          </div> 
         </foreignobject> 
        </g> 
       </g> 
       <g class="node default default" id="flowchart-r2-355" transform="translate(80.5, 154.5)"> 
        <rect class="basic label-container" style="" rx="0" ry="0" x="-47.5" y="-20.5" width="95" height="41"></rect> 
        <g class="label" style="" transform="translate(-40, -13)"> 
         <foreignobject width="80" height="26"> 
          <div style="display: inline-block; white-space: nowrap;"> 
           <span class="nodeLabel">集中式配置</span> 
          </div> 
         </foreignobject> 
        </g> 
       </g> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-g1-349" transform="translate(372.27916717529297, 222.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-63.5" y="-20.5" width="127" height="41"></rect> 
      <g class="label" style="" transform="translate(-56, -13)"> 
       <foreignobject width="112" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">服务发现客户端</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-g2-350" transform="translate(544.1083374023438, 222.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-47.5" y="-20.5" width="95" height="41"></rect> 
      <g class="label" style="" transform="translate(-40, -13)"> 
       <foreignobject width="80" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">负载均衡器</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-g3-351" transform="translate(673.1083374023438, 222.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-31.5" y="-20.5" width="63" height="41"></rect> 
      <g class="label" style="" transform="translate(-24, -13)"> 
       <foreignobject width="48" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">路由器</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-b-348" transform="translate(372.27916717529297, 28.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-31.5" y="-20.5" width="63" height="41"></rect> 
      <g class="label" style="" transform="translate(-24, -13)"> 
       <foreignobject width="48" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">浏览器</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-a-366" transform="translate(344.8000030517578, 551.5)"> 
      <polygon points="-13.666666666666666,0 136.16666666666666,0 156.66666666666666,-41 6.833333333333333,-41" class="label-container" transform="translate(-71.5,20.5)" style=""></polygon> 
      <g class="label" style="" transform="translate(-64, -13)"> 
       <foreignobject width="128" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">尝试（主题交换）</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-q-367" transform="translate(344.8000030517578, 688.2521591186523)"> 
      <path style="" d="M 0,13.168107619380502 a 69.55833435058594,13.168107619380502 0,0,0 139.11666870117188 0 a 69.55833435058594,13.168107619380502 0,0,0 -139.11666870117188 0 l 0,54.1681076193805 a 69.55833435058594,13.168107619380502 0,0,0 139.11666870117188 0 l 0,-54.1681076193805" transform="translate(-69.55833435058594,-40.25216142907075)"></path> 
      <g class="label" style="" transform="translate(-62.05833435058594, -13)"> 
       <foreignobject width="124.11666870117188" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">Gamification队列</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-l-369" transform="translate(547.4125061035156, 1046.5043182373047)"> 
      <polygon points="-13.666666666666666,0 136.16666666666666,0 156.66666666666666,-41 6.833333333333333,-41" class="label-container" transform="translate(-71.5,20.5)" style=""></polygon> 
      <g class="label" style="" transform="translate(-64, -13)"> 
       <foreignobject width="128" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">日志（主题交换）</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-lq-372" transform="translate(547.4125061035156, 1232.5263786315918)"> 
      <path style="" d="M 0,9.681372549019608 a 39.5,9.681372549019608 0,0,0 79 0 a 39.5,9.681372549019608 0,0,0 -79 0 l 0,50.681372549019606 a 39.5,9.681372549019608 0,0,0 79 0 l 0,-50.681372549019606" transform="translate(-39.5,-35.02205882352941)"></path> 
      <g class="label" style="" transform="translate(-32, -13)"> 
       <foreignobject width="64" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">日志队列</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-c-373" transform="translate(547.4125061035156, 1338.048439025879)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-47.5" y="-20.5" width="95" height="41"></rect> 
      <g class="label" style="" transform="translate(-40, -13)"> 
       <foreignobject width="80" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">集中式日志</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
   </g> 
  </g> 
 </svg> 
</div> 
<h2><a id="_322"></a>分布式跟踪</h2> 
<p>将所有日志放在一个位置能提高可观察性，但不具备可追溯性，在微服务之间了解并发用户和事件链的情况就是一个难题，尤其是当事件链具有触发了相同操作的多个事件类型分支时，更是困难。<br> 为解决此问题，需要关联同一进程链中的所有操作和事件。一种简单的方法是在用于处理不同操作的所有HTTP调用、RabbitMQ消息和Java线程中注入相同的标识符，然后，可在所有相关日志中输出此标识符。<br> 在系统中使用用户标识符，如果将来所有功能都将围绕用户操作而构建，就可以在每个事件和调用中传播一个userId字段，然后，将其记录在不同的服务中，以便将日志与特定用户相关联，这会改善可追溯性。但是，也可能在短时间内收到来自同一用户的多个操作，例如，两次尝试在一秒内解决乘法问题，这些操作分散在实例中。这种情况下，很难区分微服务的各个流。理想情况下，每种操作都应该有一个唯一的标识符，该标识符是在链的起点生成的。此外，最好是透明地传播，而不必在所有服务中显式地对其可追溯性问题进行建模。<br> 在Spring中，实现分布式跟踪的工具是Sleuth。</p> 
<h3><a id="Spring_Cloud_Sleuth_327"></a>Spring Cloud Sleuth</h3> 
<p>Sleuth是Spring Cloud系列的一部分，使用Brave库来实现分布式跟踪，通过关联span的工作单元在不同组件之间构建跟踪。例如，一个span正在检查Multiplication微服务中的尝试，而另一个span正在基于RabbitMQ事件添加分数和徽章。每个span都有一个不同的唯一标识符，但都属于同一个跟踪，因此具有相同的跟踪标识符。此外，每个span都链接到父级，而根级除外，根级是原始操作。如图所示：</p> 
<div class="mermaid"> 
 <svg id="mermaid-svg-dVPpUPkAkVp21ypX" width="165.51666259765625" xmlns="http://www.w3.org/2000/svg" height="473" viewbox="0 0 165.51666259765625 473" class="mermaid-svg"> 
  <style>#mermaid-svg-dVPpUPkAkVp21ypX {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-dVPpUPkAkVp21ypX .error-icon{fill:#552222;}#mermaid-svg-dVPpUPkAkVp21ypX .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-dVPpUPkAkVp21ypX .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-dVPpUPkAkVp21ypX .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-dVPpUPkAkVp21ypX .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-dVPpUPkAkVp21ypX .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-dVPpUPkAkVp21ypX .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-dVPpUPkAkVp21ypX .marker{fill:#333333;stroke:#333333;}#mermaid-svg-dVPpUPkAkVp21ypX .marker.cross{stroke:#333333;}#mermaid-svg-dVPpUPkAkVp21ypX svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-dVPpUPkAkVp21ypX .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-dVPpUPkAkVp21ypX .cluster-label text{fill:#333;}#mermaid-svg-dVPpUPkAkVp21ypX .cluster-label span{color:#333;}#mermaid-svg-dVPpUPkAkVp21ypX .label text,#mermaid-svg-dVPpUPkAkVp21ypX span{fill:#333;color:#333;}#mermaid-svg-dVPpUPkAkVp21ypX .node rect,#mermaid-svg-dVPpUPkAkVp21ypX .node circle,#mermaid-svg-dVPpUPkAkVp21ypX .node ellipse,#mermaid-svg-dVPpUPkAkVp21ypX .node polygon,#mermaid-svg-dVPpUPkAkVp21ypX .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-dVPpUPkAkVp21ypX .node .label{text-align:center;}#mermaid-svg-dVPpUPkAkVp21ypX .node.clickable{cursor:pointer;}#mermaid-svg-dVPpUPkAkVp21ypX .arrowheadPath{fill:#333333;}#mermaid-svg-dVPpUPkAkVp21ypX .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-dVPpUPkAkVp21ypX .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-dVPpUPkAkVp21ypX .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-dVPpUPkAkVp21ypX .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-dVPpUPkAkVp21ypX .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-dVPpUPkAkVp21ypX .cluster text{fill:#333;}#mermaid-svg-dVPpUPkAkVp21ypX .cluster span{color:#333;}#mermaid-svg-dVPpUPkAkVp21ypX div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-dVPpUPkAkVp21ypX :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style> 
  <g transform="translate(0, 0)"> 
   <marker id="flowchart-pointEnd" class="marker flowchart" viewbox="0 0 10 10" refx="9" refy="5" markerunits="userSpaceOnUse" markerwidth="12" markerheight="12" orient="auto"> 
    <path d="M 0 0 L 10 5 L 0 10 z" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <marker id="flowchart-pointStart" class="marker flowchart" viewbox="0 0 10 10" refx="0" refy="5" markerunits="userSpaceOnUse" markerwidth="12" markerheight="12" orient="auto"> 
    <path d="M 0 5 L 10 10 L 10 0 z" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <marker id="flowchart-circleEnd" class="marker flowchart" viewbox="0 0 10 10" refx="11" refy="5" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <circle cx="5" cy="5" r="5" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></circle> 
   </marker> 
   <marker id="flowchart-circleStart" class="marker flowchart" viewbox="0 0 10 10" refx="-1" refy="5" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <circle cx="5" cy="5" r="5" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></circle> 
   </marker> 
   <marker id="flowchart-crossEnd" class="marker cross flowchart" viewbox="0 0 11 11" refx="12" refy="5.2" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <path d="M 1,1 l 9,9 M 10,1 l -9,9" class="arrowMarkerPath" style="stroke-width: 2px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <marker id="flowchart-crossStart" class="marker cross flowchart" viewbox="0 0 11 11" refx="-1" refy="5.2" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <path d="M 1,1 l 9,9 M 10,1 l -9,9" class="arrowMarkerPath" style="stroke-width: 2px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <g class="root"> 
    <g class="clusters"></g> 
    <g class="edgePaths"> 
     <path d="M82.75833129882812,127L82.75833129882812,131.16666666666666C82.75833129882812,135.33333333333334,82.75833129882812,143.66666666666666,82.75833129882812,152C82.75833129882812,160.33333333333334,82.75833129882812,168.66666666666666,82.75833129882812,172.83333333333334L82.75833129882812,177" id="L-a-m-0" class=" edge-thickness-normal edge-pattern-solid flowchart-link LS-a LE-m" style="fill:none;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M82.75833129882812,296L82.75833129882812,300.1666666666667C82.75833129882812,304.3333333333333,82.75833129882812,312.6666666666667,82.75833129882812,321C82.75833129882812,329.3333333333333,82.75833129882812,337.6666666666667,82.75833129882812,341.8333333333333L82.75833129882812,346" id="L-m-c-0" class=" edge-thickness-normal edge-pattern-solid flowchart-link LS-m LE-c" style="fill:none;" marker-end="url(#flowchart-pointEnd)"></path> 
    </g> 
    <g class="edgeLabels"> 
     <g class="edgeLabel"> 
      <g class="label" transform="translate(0, 0)"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel"> 
      <g class="label" transform="translate(0, 0)"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="nodes"> 
     <g class="node default default" id="flowchart-a-391" transform="translate(82.75833129882812, 67.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-65.11666870117188" y="-59.5" width="130.23333740234375" height="119"></rect> 
      <g class="label" style="" transform="translate(-57.616668701171875, -52)"> 
       <foreignobject width="115.23333740234375" height="104"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">Gateway<br>Trace id:100<br>Parent Span id:-<br>Span id:200</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-m-392" transform="translate(82.75833129882812, 236.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-74.75833129882812" y="-59.5" width="149.51666259765625" height="119"></rect> 
      <g class="label" style="" transform="translate(-67.25833129882812, -52)"> 
       <foreignobject width="134.51666259765625" height="104"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">Multiplication<br>Trace id:100<br>Parent Span id:200<br>Span id:201</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-c-393" transform="translate(82.75833129882812, 405.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-74.75833129882812" y="-59.5" width="149.51666259765625" height="119"></rect> 
      <g class="label" style="" transform="translate(-67.25833129882812, -52)"> 
       <foreignobject width="134.51666259765625" height="104"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">Gamification<br>Trace id:100<br>Parent Span id:201<br>Span id:202</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
   </g> 
  </g> 
 </svg> 
</div> 
<p>在更高级的系统中，可能会有复杂的跟踪结构，其中多个span具有相同的父级，如图所示：</p> 
<div class="mermaid"> 
 <svg id="mermaid-svg-ujRZfZMcoxemMEis" width="427.745849609375" xmlns="http://www.w3.org/2000/svg" height="679" viewbox="0 0 427.745849609375 679" class="mermaid-svg"> 
  <style>#mermaid-svg-ujRZfZMcoxemMEis {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-ujRZfZMcoxemMEis .error-icon{fill:#552222;}#mermaid-svg-ujRZfZMcoxemMEis .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-ujRZfZMcoxemMEis .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-ujRZfZMcoxemMEis .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-ujRZfZMcoxemMEis .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-ujRZfZMcoxemMEis .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-ujRZfZMcoxemMEis .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-ujRZfZMcoxemMEis .marker{fill:#333333;stroke:#333333;}#mermaid-svg-ujRZfZMcoxemMEis .marker.cross{stroke:#333333;}#mermaid-svg-ujRZfZMcoxemMEis svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-ujRZfZMcoxemMEis .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-ujRZfZMcoxemMEis .cluster-label text{fill:#333;}#mermaid-svg-ujRZfZMcoxemMEis .cluster-label span{color:#333;}#mermaid-svg-ujRZfZMcoxemMEis .label text,#mermaid-svg-ujRZfZMcoxemMEis span{fill:#333;color:#333;}#mermaid-svg-ujRZfZMcoxemMEis .node rect,#mermaid-svg-ujRZfZMcoxemMEis .node circle,#mermaid-svg-ujRZfZMcoxemMEis .node ellipse,#mermaid-svg-ujRZfZMcoxemMEis .node polygon,#mermaid-svg-ujRZfZMcoxemMEis .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-ujRZfZMcoxemMEis .node .label{text-align:center;}#mermaid-svg-ujRZfZMcoxemMEis .node.clickable{cursor:pointer;}#mermaid-svg-ujRZfZMcoxemMEis .arrowheadPath{fill:#333333;}#mermaid-svg-ujRZfZMcoxemMEis .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-ujRZfZMcoxemMEis .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-ujRZfZMcoxemMEis .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-ujRZfZMcoxemMEis .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-ujRZfZMcoxemMEis .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-ujRZfZMcoxemMEis .cluster text{fill:#333;}#mermaid-svg-ujRZfZMcoxemMEis .cluster span{color:#333;}#mermaid-svg-ujRZfZMcoxemMEis div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-ujRZfZMcoxemMEis :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style> 
  <g transform="translate(0, 0)"> 
   <marker id="flowchart-pointEnd" class="marker flowchart" viewbox="0 0 10 10" refx="9" refy="5" markerunits="userSpaceOnUse" markerwidth="12" markerheight="12" orient="auto"> 
    <path d="M 0 0 L 10 5 L 0 10 z" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <marker id="flowchart-pointStart" class="marker flowchart" viewbox="0 0 10 10" refx="0" refy="5" markerunits="userSpaceOnUse" markerwidth="12" markerheight="12" orient="auto"> 
    <path d="M 0 5 L 10 10 L 10 0 z" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <marker id="flowchart-circleEnd" class="marker flowchart" viewbox="0 0 10 10" refx="11" refy="5" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <circle cx="5" cy="5" r="5" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></circle> 
   </marker> 
   <marker id="flowchart-circleStart" class="marker flowchart" viewbox="0 0 10 10" refx="-1" refy="5" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <circle cx="5" cy="5" r="5" class="arrowMarkerPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></circle> 
   </marker> 
   <marker id="flowchart-crossEnd" class="marker cross flowchart" viewbox="0 0 11 11" refx="12" refy="5.2" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <path d="M 1,1 l 9,9 M 10,1 l -9,9" class="arrowMarkerPath" style="stroke-width: 2px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <marker id="flowchart-crossStart" class="marker cross flowchart" viewbox="0 0 11 11" refx="-1" refy="5.2" markerunits="userSpaceOnUse" markerwidth="11" markerheight="11" orient="auto"> 
    <path d="M 1,1 l 9,9 M 10,1 l -9,9" class="arrowMarkerPath" style="stroke-width: 2px; stroke-dasharray: 1px, 0px;"></path> 
   </marker> 
   <g class="root"> 
    <g class="clusters"></g> 
    <g class="edgePaths"> 
     <path d="M231.5999984741211,127L231.5999984741211,131.16666666666666C231.5999984741211,135.33333333333334,231.5999984741211,143.66666666666666,231.5999984741211,152C231.5999984741211,160.33333333333334,231.5999984741211,168.66666666666666,231.5999984741211,172.83333333333334L231.5999984741211,177" id="L-g-m-0" class=" edge-thickness-normal edge-pattern-solid flowchart-link LS-g LE-m" style="fill:none;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M194.06521464359423,296L187.33628981123084,306.6666666666667C180.6073649788675,317.3333333333333,167.14951531414079,338.6666666666667,160.42059048177742,363.0833333333333C153.69166564941406,387.5,153.69166564941406,415,153.69166564941406,428.75L153.69166564941406,442.5" id="L-m-ga-0" class=" edge-thickness-normal edge-pattern-solid flowchart-link LS-m LE-ga" style="fill:none;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M289.84134315768716,296L300.2823685351332,306.6666666666667C310.7233939125792,317.3333333333333,331.6054446674712,338.6666666666667,342.04647004491727,366.5C352.4874954223633,394.3333333333333,352.4874954223633,428.6666666666667,352.4874954223633,463C352.4874954223633,497.3333333333333,352.4874954223633,531.6666666666666,346.9800662279599,559.5C341.47263703355657,587.3333333333334,330.45777864474985,608.6666666666666,324.9503494503465,619.3333333333334L319.44292025594314,630" id="L-m-d-0" class=" edge-thickness-normal edge-pattern-solid flowchart-link LS-m LE-d" style="fill:none;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M138.31500747828807,483.5L128.0013952903377,497.25C117.68778310238736,511,97.06055872648665,538.5,86.74694653853629,562.9166666666666C76.43333435058594,587.3333333333334,76.43333435058594,608.6666666666666,76.43333435058594,619.3333333333334L76.43333435058594,630" id="L-ga-r-0" class=" edge-thickness-normal edge-pattern-solid flowchart-link LS-ga LE-r" style="fill:none;" marker-end="url(#flowchart-pointEnd)"></path> 
     <path d="M169.06832382054006,483.5L179.38193600849044,497.25C189.69554819644077,511,210.32277257234148,538.5,230.47096720759214,562.9166666666666C250.61916184284277,587.3333333333334,270.28832673744336,608.6666666666666,280.12290918474366,619.3333333333334L289.95749163204397,630" id="L-ga-d-0" class=" edge-thickness-normal edge-pattern-solid flowchart-link LS-ga LE-d" style="fill:none;" marker-end="url(#flowchart-pointEnd)"></path> 
    </g> 
    <g class="edgeLabels"> 
     <g class="edgeLabel"> 
      <g class="label" transform="translate(0, 0)"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(153.69166564941406, 360)"> 
      <g class="label" transform="translate(-67.25833129882812, -39)"> 
       <foreignobject width="134.51666259765625" height="78"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">Trace id:100<br>Parent Span id:201<br>Span id:202</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(352.4874954223633, 463)"> 
      <g class="label" transform="translate(-67.25833129882812, -39)"> 
       <foreignobject width="134.51666259765625" height="78"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">Trace id:100<br>Parent Span id:201<br>Span id:900</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(76.43333435058594, 566)"> 
      <g class="label" transform="translate(-67.25833129882812, -39)"> 
       <foreignobject width="134.51666259765625" height="78"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">Trace id:100<br>Parent Span id:202<br>Span id:800</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="translate(230.9499969482422, 566)"> 
      <g class="label" transform="translate(-67.25833129882812, -39)"> 
       <foreignobject width="134.51666259765625" height="78"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel">Trace id:100<br>Parent Span id:202<br>Span id:600</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="nodes"> 
     <g class="node default default" id="flowchart-g-407" transform="translate(231.5999984741211, 67.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-65.11666870117188" y="-59.5" width="130.23333740234375" height="119"></rect> 
      <g class="label" style="" transform="translate(-57.616668701171875, -52)"> 
       <foreignobject width="115.23333740234375" height="104"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">Gateway<br>Trace id:100<br>Parent Span id:-<br>Span id:200</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-m-408" transform="translate(231.5999984741211, 236.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-74.75833129882812" y="-59.5" width="149.51666259765625" height="119"></rect> 
      <g class="label" style="" transform="translate(-67.25833129882812, -52)"> 
       <foreignobject width="134.51666259765625" height="104"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">Multiplication<br>Trace id:100<br>Parent Span id:200<br>Span id:201</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-ga-409" transform="translate(153.69166564941406, 463)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-53.55833435058594" y="-20.5" width="107.11666870117188" height="41"></rect> 
      <g class="label" style="" transform="translate(-46.05833435058594, -13)"> 
       <foreignobject width="92.11666870117188" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">Gamification</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-r-412" transform="translate(76.43333435058594, 650.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-68.43333435058594" y="-20.5" width="136.86666870117188" height="41"></rect> 
      <g class="label" style="" transform="translate(-60.93333435058594, -13)"> 
       <foreignobject width="121.86666870117188" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">Rewards &amp; Bonus</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="node default default" id="flowchart-d-413" transform="translate(308.8583297729492, 650.5)"> 
      <rect class="basic label-container" style="" rx="0" ry="0" x="-34.474998474121094" y="-20.5" width="68.94999694824219" height="41"></rect> 
      <g class="label" style="" transform="translate(-26.974998474121094, -13)"> 
       <foreignobject width="53.94999694824219" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="nodeLabel">Reports</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
   </g> 
  </g> 
 </svg> 
</div> 
<p>为了透明地注入这些值，Sleuth使用SLF4J的映射诊断上下文（MDC）对象，该对象是一个日志记录上下文，其生命周期仅限于当前线程，还可以在上下文中注入自定义字段，可传播并在日志中使用这些值。<br> Spring Boot在Sleuth中自动配置了一些内置的拦截器，用于自动检查和修改HTTP调用和RabbitMQ消息，还集成了Kafka、gRPC和其他通信接口。拦截器的工作方式类似：对于传入的通信，检查是否在调用或消息中添加了跟踪标头，并将其放入MDC中；当作为客户端进行调用或发布数据时，拦截器会从MDC中获取这些字段并将标头添加到请求或消息中。<br> Sleuth有时与Zipkin结合使用，可以跟踪采样来测量每个span中以及整个链中所花费的时间。这些数据可以发送到Zipkin服务器，该服务器提供一个UI，可查看跟踪层次结构以及每个服务完成其工作所需的时间。这里不会使用Zipkin，因为其不适用具有trace和span标识符的集中式日志记录系统。</p> 
<h3><a id="_348"></a>实现分布式跟踪</h3> 
<p>Spring Cloud Sleuth为REST API和RabbitMQ消息提供了拦截器，Spring Boot进行自动配置，因此，实现分布式跟踪并不困难。这里使用Zipkin来进行跟踪。<br> 首先，在Multiplication、Gamification、Gateway、Logs中添加Spring Cloud Sleuth启动器，如下所示：</p> 
<pre><code class="prism language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.micrometer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>micrometer-tracing-bridge-brave<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.zipkin.reporter2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zipkin-reporter-brave<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>只有添加了对应的依赖项，才会将trace和span标识符注入每个受支持的通信通道和MDC对象中，默认的Spring Boot日志记录模式也会自动调整，用于在日志中输出trace和span值。<br> 为了使日志更详细并查看trace标识符，在ChallengeAttemptController中添加一条日志信息，以便每次用户发送尝试时输出一条消息，如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>zhangjuli<span class="token punctuation">.</span>multiplication<span class="token punctuation">.</span>challenge</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>validation<span class="token punctuation">.</span></span><span class="token class-name">Valid</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">RequiredArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">ResponseEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Juli Zhang, &lt;a href="mailto:zhjl@lut.edu.cn"&gt;Contact me&lt;/a&gt; &lt;br&gt;
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/attempts"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChallengeAttemptController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChallengeService</span> challengeService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChallengeAttempt</span><span class="token punctuation">&gt;</span></span> <span class="token function">postResult</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token annotation punctuation">@Valid</span> <span class="token class-name">ChallengeAttemptDTO</span> challengeAttemptDTO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"从{}收到新的尝试。"</span><span class="token punctuation">,</span> challengeAttemptDTO<span class="token punctuation">.</span><span class="token function">getUserAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>challengeService<span class="token punctuation">.</span><span class="token function">verifyAttempt</span><span class="token punctuation">(</span>challengeAttemptDTO<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ChallengeAttempt</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getStatistics</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> alias<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>challengeService<span class="token punctuation">.</span><span class="token function">getStatisticsForUser</span><span class="token punctuation">(</span>alias<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>另外，还想在集中式日志中包含trace和parent标识符，要将来自MDC上下文（由Sleuth使用Brave注入）中的属性X-B3-TraceId和X-B3-SpanId手动添加到Logs项目的logback-spring.xml中。这些标头是OpenZipkin的B3 Propagation规范的一部分，由Sleuth的拦截器包含在MDC中，代码如下：</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>configuration<span class="token punctuation">&gt;</span></span>
    <span class="token operator">&lt;</span>appender name<span class="token operator">=</span><span class="token string">"CONSOLE"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"ch.qos.logback.core.ConsoleAppender"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>layout <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"ch.qos.logback.classic.PatternLayout"</span><span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Pattern</span><span class="token punctuation">&gt;</span></span>
                <span class="token punctuation">[</span><span class="token operator">%</span><span class="token number">70</span>marker<span class="token punctuation">]</span> <span class="token operator">%</span><span class="token function">highlight</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token operator">-</span><span class="token number">5l</span>evel<span class="token punctuation">)</span> <span class="token operator">%</span>msg<span class="token operator">%</span>n
            <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token class-name">Pattern</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>layout<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>appender<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>root level<span class="token operator">=</span><span class="token string">"INFO"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>appender<span class="token operator">-</span>ref ref<span class="token operator">=</span><span class="token string">"CONSOLE"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>root<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>configuration<span class="token operator">&gt;</span>
</code></pre> 
<p>另外，修改LogsConsumer 类，让日志信息能够显示traceId和spanId，以便追踪，如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>zhangjuli<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>consumer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Marker</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">MarkerFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Header</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Juli Zhang, &lt;a href="mailto:zhjl@lut.edu.cn"&gt;Contact me&lt;/a&gt; &lt;br&gt;
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogsConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"logs.queue"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> msg<span class="token punctuation">,</span>
                    <span class="token annotation punctuation">@Header</span><span class="token punctuation">(</span><span class="token string">"level"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> level<span class="token punctuation">,</span>
                    <span class="token annotation punctuation">@Header</span><span class="token punctuation">(</span><span class="token string">"amqp_appId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> appId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Marker</span> marker <span class="token operator">=</span> <span class="token class-name">MarkerFactory</span><span class="token punctuation">.</span><span class="token function">getMarker</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>level<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token string">"INFO"</span> <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>marker<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"ERROR"</span> <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>marker<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"WARN"</span> <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>marker<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>重启服务后，就会发挥作用，当然，还需要安装Zipkin服务器，可使用docker容器，命令很简单：<code>docker run -d -p 9411:9411 openzipkin/zipkin</code>，可以看到Multiplication和Gamification的日志，带有trace标识符，如下所示：</p> 
<pre><code class="prism language-java"><span class="token number">2023</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">26</span><span class="token constant">T11</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">37.693</span><span class="token operator">+</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span>  <span class="token constant">INFO</span> <span class="token number">44448</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>multiplication<span class="token punctuation">]</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">10080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">658</span>a4a8152b5ca6ff46e57bc2c704440<span class="token operator">-</span>deb6e42026ec20e9<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>z<span class="token punctuation">.</span>m<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>ChallengeAttemptController</span>       <span class="token operator">:</span> 从noise7收到新的尝试。
<span class="token number">2023</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">26</span><span class="token constant">T11</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">37.700</span><span class="token operator">+</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span>  <span class="token constant">INFO</span> <span class="token number">44448</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>multiplication<span class="token punctuation">]</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">10080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">658</span>a4a8152b5ca6ff46e57bc2c704440<span class="token operator">-</span>deb6e42026ec20e9<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>z<span class="token punctuation">.</span>m<span class="token punctuation">.</span>challenge<span class="token punctuation">.</span></span>ChallengeServiceImpl</span>     <span class="token operator">:</span> attempt<span class="token operator">:</span> <span class="token class-name">ChallengeAttempt</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">457</span><span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">202</span><span class="token punctuation">,</span> alias<span class="token operator">=</span>noise7<span class="token punctuation">)</span><span class="token punctuation">,</span> factorA<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> factorB<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">,</span> resultAttempt<span class="token operator">=</span><span class="token number">3000</span><span class="token punctuation">,</span> correct<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token number">2023</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">26</span><span class="token constant">T11</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">38.390</span><span class="token operator">+</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span>  <span class="token constant">INFO</span> <span class="token number">44448</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>multiplication<span class="token punctuation">]</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">10080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">658</span>a4a823f424e031efe5eb3dec5988c<span class="token operator">-</span><span class="token number">81180d</span><span class="token number">75</span>a911d673<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>z<span class="token punctuation">.</span>multiplication<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span>UserController</span>   <span class="token operator">:</span> 解析用户别名：<span class="token punctuation">[</span><span class="token number">154</span><span class="token punctuation">,</span> <span class="token number">202</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">,</span> <span class="token number">152</span><span class="token punctuation">]</span>
<span class="token number">2023</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">26</span><span class="token constant">T11</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">43.448</span><span class="token operator">+</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span>  <span class="token constant">INFO</span> <span class="token number">44448</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>multiplication<span class="token punctuation">]</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">10080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">658</span>a4a87a383b6ed58ed38f84f4d56f3<span class="token operator">-</span>d05b566e3550cfdb<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>z<span class="token punctuation">.</span>multiplication<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span>UserController</span>   <span class="token operator">:</span> 解析用户别名：<span class="token punctuation">[</span><span class="token number">154</span><span class="token punctuation">,</span> <span class="token number">202</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">,</span> <span class="token number">152</span><span class="token punctuation">]</span>
</code></pre> 
<p>将所有日志连同traceId和spanId输出到更复杂的集中式日志工具（如ELK）时，效果更好，可以使用这些标识符来执行过滤后的文本搜索。</p> 
<h2><a id="_450"></a>小结</h2> 
<p>文章介绍了日志聚合模式，以解决微服务实施过程中面临的问题，每个微服务都有日志输出，不便于了解整个系统的状态，通过日志集中化解决方案，将所有日志引导到一个中央位置，还可以在其中看到单个进程运行的完整轨迹，可使用Sleuth、Zipkin实现分布式跟踪，以便发现存在的问题。</p> 
<p>后续文章：<br> <a href="https://blog.csdn.net/ZhangCurie/article/details/135236343">容器化微服务</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5dc57779b31718989bd4fa1b64ccb296/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">从假数据到动态表格：一个简单的JavaScript和HTML示例</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e7c47584b0906a122f64cba12a908e35/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MathType7.6安装教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>