<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Golang并发控制--context的使用 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Golang并发控制--context的使用" />
<meta property="og:description" content="我们已经知道WaitGroup可以用于并发控制，但当遇到更复杂的场景时，例如主动取消goroutine或者使超时的goroutine自动退出等，WaitGroup就无能为力。
这个时候，就是context大有用武之地。
包context定义了Context类型，它跨API边界和进程之间携带截止日期，取消信号和其他请求范围的值。
对服务器的传入请求应创建一个Context，对服务器的传出调用应接受一个Context。它们之间的函数调用链必须传播Context，或者传递使用WithCancel，WithDeadline，WithTimeout或WithValue创建的派生Context。当取消一个context后，所有从这个context派生的context也会被取消。
WithCancel，WithDeadline和WithTimeout函数接受Context（父）并返回派生的Context（子）和CancelFunc。调用CancelFunc会取消子项及其子项，删除父项对子项的引用，并停止任何关联的计时器。未能调用CancelFunc会泄漏子项及其子项，直到取消父项或计时器触发。 go vet工具检查CancelFuncs是否在所有控制流路径上使用。
使用Contexts的程序应遵循这些规则，以使各包之间的接口保持一致，并启用静态分析工具来检查上下文传播：
不要将Contexts存储在结构类型中;相反，将Context明确传递给需要它的每个函数。Context应该是第一个参数，通常命名为ctx：func DoSomething(ctx context.Context, arg Arg) error { // ... use ctx ... }即使函数允许，也不要传递nil Context。如果您不确定要使用哪个Context，请传递context.TODO。仅将context values用于进程间和跨API的请求范围数据，而不是将其作为可选参数传递给函数。可以将相同的Context传递给在不同goroutine中运行的函数;上下文对于多个goroutine同时使用是安全的。 以上说明来自context包说明，如果感觉翻译的不够清楚，可以查看context的说明。(实在翻译不下去了 = =！)
Context定义如下：
type Context interface { Deadline() (deadline time.Time, ok bool) Done() &lt;-chan struct{} Err() error Value(key interface{}) interface{} } 说了这么多，现在来看下例子吧。
并发控制 Cancel Example 通过使用WithCancel可以主动取消一个或多个goroutine的执行，以实现对并发的控制。
package main import ( &#34;context&#34; &#34;fmt&#34; &#34;time&#34; ) func PrintTask(ctx context.Context) { for { select { case &lt;- ctx.Done(): return default: time." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d2269f310d91ce66f8ef6201c9a25259/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-06-19T11:06:39+08:00" />
<meta property="article:modified_time" content="2018-06-19T11:06:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Golang并发控制--context的使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>我们已经知道<code>WaitGroup</code>可以用于并发控制，但当遇到更复杂的场景时，例如主动取消goroutine或者使超时的goroutine自动退出等，<code>WaitGroup</code>就无能为力。</p> 
<p>这个时候，就是<code>context</code>大有用武之地。</p> 
<p>包<code>context</code>定义了<code>Context</code>类型，它跨API边界和进程之间携带截止日期，取消信号和其他请求范围的值。</p> 
<p>对服务器的传入请求应创建一个Context，对服务器的传出调用应接受一个Context。它们之间的函数调用链必须传播Context，或者传递使用WithCancel，WithDeadline，WithTimeout或WithValue创建的派生Context。当取消一个<code>context</code>后，所有从这个<code>context</code>派生的<code>context</code>也会被取消。</p> 
<p>WithCancel，WithDeadline和WithTimeout函数接受Context（父）并返回派生的Context（子）和<code>CancelFunc</code>。调用<code>CancelFunc</code>会取消子项及其子项，删除父项对子项的引用，并停止任何关联的计时器。未能调用<code>CancelFunc</code>会泄漏子项及其子项，直到取消父项或计时器触发。 go vet工具检查<code>CancelFuncs</code>是否在所有控制流路径上使用。</p> 
<p>使用<code>Contexts</code>的程序应遵循这些规则，以使各包之间的接口保持一致，并启用静态分析工具来检查上下文传播：</p> 
<ul><li>不要将<code>Contexts</code>存储在结构类型中;相反，将Context明确传递给需要它的每个函数。Context应该是第一个参数，通常命名为ctx：<code>func DoSomething(ctx context.Context, arg Arg) error { // ... use ctx ... }</code></li><li>即使函数允许，也不要传递nil <code>Context</code>。如果您不确定要使用哪个<code>Context</code>，请传递context.TODO。</li><li>仅将<code>context values</code>用于进程间和跨API的请求范围数据，而不是将其作为可选参数传递给函数。</li><li>可以将相同的Context传递给在不同goroutine中运行的函数;上下文对于多个goroutine同时使用是安全的。</li></ul> 
<p>以上说明来自<code>context</code>包说明，如果感觉翻译的不够清楚，可以查看<code>context</code>的说明。(实在翻译不下去了 = =！)</p> 
<p><code>Context</code>定义如下：</p> 
<pre><code>type Context interface {
    Deadline() (deadline time.Time, ok bool)

    Done() &lt;-chan struct{}

    Err() error
   
    Value(key interface{}) interface{}
} 
</code></pre> 
<p>说了这么多，现在来看下例子吧。</p> 
<h3><a id="_Cancel_Example_49"></a>并发控制 Cancel Example</h3> 
<p>通过使用WithCancel可以主动取消一个或多个goroutine的执行，以实现对并发的控制。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main 

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">PrintTask</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
	
		<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
		
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span> ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"A man must walk down many roads."</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	
	<span class="token punctuation">}</span>


<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token function">PrintTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">PrintTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">PrintTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"main exit..."</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


</code></pre> 
<p>WithCancel函数原型如下</p> 
<pre><code>func WithCancel(parent Context) (ctx Context, cancel CancelFunc) 
</code></pre> 
<p>WithCancel返回两个结果，一个是context(parent的副本，并带有新的<code>Done</code> channel), 一个是cancel函数。</p> 
<p>当调用cancel函数或者parent的<code>Done</code> channel关闭时，新返回的<code>Done</code> channel就会被关闭。</p> 
<p>例子中，调用cancel函数，关闭了<code>Done</code> channel后，进而PrintTask就会结束。</p> 
<p>output</p> 
<blockquote> 
 <p>A man must walk down many roads.</p> 
</blockquote> 
<blockquote> 
 <p>A man must walk down many roads.</p> 
</blockquote> 
<blockquote> 
 <p>A man must walk down many roads.</p> 
</blockquote> 
<blockquote> 
 <p>main exit…</p> 
</blockquote> 
<h3><a id="_Timeout_Example_127"></a>并发超时控制 Timeout Example</h3> 
<p>WithTimeout可以实现并发超时控制，使goroutine执行超时时自动结束。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main 

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>


<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	timeout <span class="token operator">:=</span> <span class="token number">50</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Millisecond
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
	
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// do something</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		done<span class="token operator">&lt;-</span> <span class="token number">1</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">select</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"work done on time"</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment">// timeout</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>


	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"main exit..."</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>



</code></pre> 
<p>例子中，使用<code>WithTimeout()</code>函数，其实现上，直接调用</p> 
<pre><code>WithDeadline(parent, time.Now().Add(timeout))
</code></pre> 
<p><code>WithDeadline</code>函数定义如下：</p> 
<pre><code>func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc)
</code></pre> 
<p>传入参数：</p> 
<ul><li><code>Context</code>类型的变量<code>parent</code></li><li><code>timeout</code>超时时间</li></ul> 
<p>返回两个结果:</p> 
<ul><li><code>Context</code>类型的变量</li><li>取消函数cancel</li></ul> 
<p>当出现超时，或者调用取消函数cancel，或者<code>parent</code>的<code>Done</code>channel被关闭时，<br> 新返回的context的<code>Done</code> channel将被关闭。</p> 
<p>output:</p> 
<blockquote> 
 <p>context deadline exceeded</p> 
</blockquote> 
<blockquote> 
 <p>main exit…</p> 
</blockquote> 
<h2><a id="_203"></a>更多参考</h2> 
<p><a href="https://blog.csdn.net/lanyang123456/article/details/90345484">golang context学习记录1</a><br> <a href="https://blog.csdn.net/lanyang123456/article/details/90345636">golang context学习记录2</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/da59d0a83d95914d543d553c256cecc9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">c#方法重写与方法重载</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7bfee1460bf62b86da8f8c112a647faa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java基础算法详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>