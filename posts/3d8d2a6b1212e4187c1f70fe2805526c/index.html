<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用Sqlite构建服务端简易DBProxy数据库代理 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用Sqlite构建服务端简易DBProxy数据库代理" />
<meta property="og:description" content="使用Sqlite构建服务端简易DBProxy数据库代理 目前博主构建的建议数据库代理（DBProxy）是依附于主线程单独开一个线程处理的（注意，这里只开了一个线程，这个线程依附于主线程）。单独开一个线程管理DBProxy，主要目的是不想让存盘（文件操作）的耗时影响到主线程，即我们将存盘操作从同步策略变换为异步策略。
关于Sqlite的封装可参考：https://ufgnix0802.blog.csdn.net/article/details/128192088
关于C&#43;&#43;11的线程库封装可参考：https://ufgnix0802.blog.csdn.net/article/details/128069481
关于单例类模块的实现可参考：https://ufgnix0802.blog.csdn.net/article/details/128121759
以下代码仅供思路，不做演示。
DBProxy.h #pragma once class IDBModule { public: IDBModule() {} virtual ~IDBModule() {} bool virtual DBExec(U::DB::DBSqlite* pSqlite) = 0; bool virtual OnDBExec() = 0; bool virtual Release() = 0; }; class DBProxy { SINGLETON_CLASS_FUNC_DECL(DBProxy) public: int Init(const char* dbPath); bool UnInit(); bool Start(); bool Stop(); //同步初始化场景和商城 bool GamaServiceSubmoduleConfig(class Scene* scene, class Shop* shop); bool PostHandlerEvent(IDBModule* iDBModule); bool OnPostHandlerEvent(IDBModule* iDBModule); private: U::DB::DBSqlite m_sqlite; U::THREAD::Thread m_thread; //任务队列 std::mutex m_mutexWork; std::vector&lt;IDBModule*&gt; m_workArr; int m_version; //数据库版本号 }; DBProxy." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3d8d2a6b1212e4187c1f70fe2805526c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-27T16:42:08+08:00" />
<meta property="article:modified_time" content="2022-12-27T16:42:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用Sqlite构建服务端简易DBProxy数据库代理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="SqliteDBProxy_0"></a>使用Sqlite构建服务端简易DBProxy数据库代理</h2> 
<p>  目前博主构建的建议数据库代理（DBProxy）是依附于主线程单独开一个线程处理的（<font color="red"><strong>注意，这里只开了一个线程，这个线程依附于主线程</strong></font>）。单独开一个线程管理DBProxy，主要目的是不想让存盘（文件操作）的耗时影响到主线程，即我们将存盘操作从同步策略变换为异步策略。</p> 
<blockquote> 
 <p>关于Sqlite的封装可参考：<strong><a href="https://ufgnix0802.blog.csdn.net/article/details/128192088" rel="nofollow">https://ufgnix0802.blog.csdn.net/article/details/128192088</a></strong></p> 
 <p>关于C++11的线程库封装可参考：<strong><a href="https://ufgnix0802.blog.csdn.net/article/details/128069481" rel="nofollow">https://ufgnix0802.blog.csdn.net/article/details/128069481</a></strong></p> 
 <p>关于单例类模块的实现可参考：<strong><a href="https://ufgnix0802.blog.csdn.net/article/details/128121759" rel="nofollow">https://ufgnix0802.blog.csdn.net/article/details/128121759</a></strong></p> 
</blockquote> 
<p>  以下代码仅供思路，不做演示。</p> 
<h3><a id="DBProxyh_12"></a>DBProxy.h</h3> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token keyword">class</span> <span class="token class-name">IDBModule</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">IDBModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">IDBModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">bool</span> <span class="token keyword">virtual</span> <span class="token function">DBExec</span><span class="token punctuation">(</span>U<span class="token double-colon punctuation">::</span>DB<span class="token double-colon punctuation">::</span>DBSqlite<span class="token operator">*</span> pSqlite<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> <span class="token keyword">virtual</span> <span class="token function">OnDBExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> <span class="token keyword">virtual</span> <span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">class</span> <span class="token class-name">DBProxy</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">SINGLETON_CLASS_FUNC_DECL</span><span class="token punctuation">(</span>DBProxy<span class="token punctuation">)</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">int</span>  <span class="token function">Init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> dbPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">UnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//同步初始化场景和商城</span>
    <span class="token keyword">bool</span> <span class="token function">GamaServiceSubmoduleConfig</span><span class="token punctuation">(</span><span class="token keyword">class</span> <span class="token class-name">Scene</span><span class="token operator">*</span> scene<span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">Shop</span><span class="token operator">*</span> shop<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> <span class="token function">PostHandlerEvent</span><span class="token punctuation">(</span>IDBModule<span class="token operator">*</span> iDBModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">OnPostHandlerEvent</span><span class="token punctuation">(</span>IDBModule<span class="token operator">*</span> iDBModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    U<span class="token double-colon punctuation">::</span>DB<span class="token double-colon punctuation">::</span>DBSqlite   m_sqlite<span class="token punctuation">;</span>
    U<span class="token double-colon punctuation">::</span>THREAD<span class="token double-colon punctuation">::</span>Thread m_thread<span class="token punctuation">;</span>

    <span class="token comment">//任务队列</span>
    std<span class="token double-colon punctuation">::</span>mutex              m_mutexWork<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>IDBModule<span class="token operator">*</span><span class="token operator">&gt;</span> m_workArr<span class="token punctuation">;</span>

    <span class="token keyword">int</span> m_version<span class="token punctuation">;</span>  <span class="token comment">//数据库版本号</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="DBProxycpp_56"></a>DBProxy.cpp</h3> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"DBProxy.h"</span></span>

<span class="token function">SINGLETON_CLASS_IMPL</span><span class="token punctuation">(</span>DBProxy<span class="token punctuation">)</span>

<span class="token comment">//0， 表示存在数据库且数据库代理初始化成功</span>
<span class="token comment">//1， 表示不存在数据库且数据库代理初始化成功</span>
<span class="token comment">//-1，表示初始化失败</span>
<span class="token keyword">int</span> <span class="token class-name">DBProxy</span><span class="token double-colon punctuation">::</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> dbPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span> <span class="token operator">!=</span> dbPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span>   result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> pErr   <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    m_version    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    LOG_TRACE <span class="token operator">&lt;&lt;</span> <span class="token string">"初始化数据库"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_sqlite<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>dbPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        LOG_ERROR <span class="token operator">&lt;&lt;</span> <span class="token string">"init m_sqlite err..."</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    m_sqlite<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">"select versio from dbver;"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pErr<span class="token punctuation">,</span> 
        <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span>   column_size<span class="token punctuation">,</span>
            <span class="token keyword">char</span><span class="token operator">*</span> column_value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            <span class="token keyword">char</span><span class="token operator">*</span> column_name<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        m_version <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>column_value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//如果数据库不存在，那么创建数据库，读取配置文件进行模块初始化</span>
    <span class="token comment">//如果数据库存在，  那么同步读取数据库，初始化模块</span>

    <span class="token comment">//如果不存在数据库，则创建数据库</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_version<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        LOG_TRACE <span class="token operator">&lt;&lt;</span> <span class="token string">"没有找到基础数据库，创建数据库，版本号:100"</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sql <span class="token operator">=</span> <span class="token string">"        \
            CREATE TABLE `dbver` ( \
            `versio` int NULL,     \
            PRIMARY KEY (`versio`) \
            )"</span><span class="token punctuation">;</span>
        pErr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        m_sqlite<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建数据库</span>
        m_sqlite<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pErr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOG_ERROR <span class="token operator">&lt;&lt;</span> pErr<span class="token punctuation">;</span>
            pErr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//插入版本号</span>
        m_sqlite<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">"insert into dbver values ('100');"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pErr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOG_ERROR <span class="token operator">&lt;&lt;</span> pErr<span class="token punctuation">;</span>
            pErr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//启动外键</span>
        m_sqlite<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">"PRAGMA foreign_keys = ON;"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pErr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOG_ERROR <span class="token operator">&lt;&lt;</span> pErr<span class="token punctuation">;</span>
            pErr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        sql <span class="token operator">=</span> <span class="token string">"                             \
			CREATE TABLE \"Players\" (      \
			    \"PlayerID\" TEXT NOT NULL, \
			    \"Password\" TEXT NOT NULL, \
			    \"CreateTime\" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, \
				PRIMARY KEY(\"PlayerID\")   \
				); \
			CREATE INDEX \"PlayerIndex\" ON \"Players\" (\"PlayerID\"); \
			"</span><span class="token punctuation">;</span>

        <span class="token comment">//创建一张玩家管理表</span>
        m_sqlite<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pErr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOG_ERROR <span class="token operator">&lt;&lt;</span> pErr<span class="token punctuation">;</span>
            pErr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        sql <span class="token operator">=</span> <span class="token string">"                                   \
			CREATE TABLE \"Scenes\" (             \
			    \"SceneID\" INTEGER NOT NULL,     \
			    \"Width\"  INTEGER NOT NULL,      \
			    \"Length\" INTEGER NOT NULL,      \
			    \"MarkRoleID\" INTEGER NOT NULL,  \
			    \"CreateTime\" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, \
				PRIMARY KEY(\"SceneID\")          \
				); \
			CREATE INDEX \"SceneIndex\" ON \"Scenes\" (\"SceneID\");         \
			"</span><span class="token punctuation">;</span>

        <span class="token comment">//创建一张场景管理表</span>
        m_sqlite<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pErr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOG_ERROR <span class="token operator">&lt;&lt;</span> pErr<span class="token punctuation">;</span>
            pErr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        sql <span class="token operator">=</span> <span class="token string">"                              \
			CREATE TABLE \"Roles\" (         \
			    \"RoleID\" INTEGER NOT NULL, \
			    \"SceneID\" INTEGER NOT NULL,\
			    \"PlayerID\" TEXT NOT NULL,  \
			    \"RotX\" REAL NOT NULL,      \
			    \"RotY\" REAL NOT NULL,      \
			    \"Speed\" INTEGER NOT NULL,  \
                \"PosX\" REAL NOT NULL,      \
			    \"PosY\" REAL NOT NULL,      \
			    \"CreateTime\" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,   \
				PRIMARY KEY(\"RoleID\"),     \
                FOREIGN KEY \(\"PlayerID\"\) REFERENCES Players\(\"PlayerID\"\) \
                FOREIGN KEY \(\"SceneID\"\) REFERENCES Scenes\(\"SceneID\"\) \
				); \
			CREATE INDEX \"RoleIndex\" ON \"Roles\" (\"RoleID\"); \
			"</span><span class="token punctuation">;</span>

        <span class="token comment">//创建一张角色管理表</span>
        m_sqlite<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pErr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOG_ERROR <span class="token operator">&lt;&lt;</span> pErr<span class="token punctuation">;</span>
            pErr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        sql <span class="token operator">=</span> <span class="token string">"                              \
			CREATE TABLE \"Bags\" (          \
			    \"RoleID\" INTEGER NOT NULL, \
			    \"Bag\" BLOB NOT NULL,       \
			    \"CreateTime\" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, \
				PRIMARY KEY(\"RoleID\"),     \
                FOREIGN KEY \(\"RoleID\"\) REFERENCES Roles\(\"RoleID\"\)    \
				); \
			CREATE INDEX \"BagIndex\" ON \"Bags\" (\"RoleID\"); \
			"</span><span class="token punctuation">;</span>
        <span class="token comment">//创建一张背包管理表</span>
        m_sqlite<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pErr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOG_ERROR <span class="token operator">&lt;&lt;</span> pErr<span class="token punctuation">;</span>
            pErr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        sql <span class="token operator">=</span> <span class="token string">"                               \
			CREATE TABLE \"RoleMoneys\" (     \
			    \"RoleID\" INTEGER NOT NULL,  \
			    \"Money\"  INTEGER NOT NULL,  \
			    \"CreateTime\" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, \
				PRIMARY KEY(\"RoleID\"),      \
                FOREIGN KEY \(\"RoleID\"\) REFERENCES Roles\(\"RoleID\"\)    \
				); \
			CREATE INDEX \"MoneyIndex\" ON \"RoleMoneys\" (\"RoleID\");      \
			"</span><span class="token punctuation">;</span>
        <span class="token comment">//创建一张角色金钱管理表</span>
        m_sqlite<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pErr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOG_ERROR <span class="token operator">&lt;&lt;</span> pErr<span class="token punctuation">;</span>
            pErr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        sql <span class="token operator">=</span> <span class="token string">"                                \
			CREATE TABLE \"Shops\" (           \
			    \"ShopID\" INTEGER NOT NULL,   \
			    \"Shop\" BLOB NOT NULL,        \
			    \"CreateTime\" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, \
				PRIMARY KEY(\"ShopID\")        \
				); \
			CREATE INDEX \"ShopIndex\" ON \"Shops\" (\"ShopID\");            \
			"</span><span class="token punctuation">;</span>
        <span class="token comment">//创建一张商城管理表</span>
        m_sqlite<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pErr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOG_ERROR <span class="token operator">&lt;&lt;</span> pErr<span class="token punctuation">;</span>
            pErr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        m_sqlite<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//设置版本号</span>
        m_version <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
        result    <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        result    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    LOG_TRACE <span class="token operator">&lt;&lt;</span> <span class="token string">"当前数据库版本号:"</span> <span class="token operator">&lt;&lt;</span> m_version<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_thread<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    m_workArr<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LOG_TRACE <span class="token operator">&lt;&lt;</span> <span class="token string">"DB sqlite init success..."</span><span class="token punctuation">;</span>
Exit<span class="token operator">:</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">DBProxy</span><span class="token double-colon punctuation">::</span><span class="token function">UnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_sqlite<span class="token punctuation">.</span><span class="token function">UnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    m_thread<span class="token punctuation">.</span><span class="token function">UnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_workArr<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">DBProxy</span><span class="token double-colon punctuation">::</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    LOG_TRACE <span class="token operator">&lt;&lt;</span> <span class="token string">"启动数据库线程"</span><span class="token punctuation">;</span>
    m_thread<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span>U<span class="token double-colon punctuation">::</span>THREAD<span class="token double-colon punctuation">::</span>Thread<span class="token operator">*</span> pThread<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>pThread<span class="token operator">-&gt;</span><span class="token function">IsRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//处理任务队列</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_workArr<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>IDBModule<span class="token operator">*</span><span class="token operator">&gt;</span> workArr<span class="token punctuation">;</span>
                <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
                    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">__</span><span class="token punctuation">(</span>m_mutexWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    m_workArr<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>workArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    m_workArr<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> work <span class="token operator">:</span> workArr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">OnPostHandlerEvent</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//else {<!-- --></span>
            <span class="token comment">//    //休息1ms</span>
            <span class="token comment">//    pThread-&gt;Wait();</span>
            <span class="token comment">//}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">DBProxy</span><span class="token double-colon punctuation">::</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    m_sqlite<span class="token punctuation">.</span><span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_thread<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">DBProxy</span><span class="token double-colon punctuation">::</span><span class="token function">GamaServiceSubmoduleConfig</span><span class="token punctuation">(</span><span class="token keyword">class</span> <span class="token class-name">Scene</span><span class="token operator">*</span> scene<span class="token punctuation">,</span>
    <span class="token keyword">class</span> <span class="token class-name">Shop</span><span class="token operator">*</span> shop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span> <span class="token operator">!=</span> scene<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span> <span class="token operator">!=</span> shop<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span>  sql<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> pError    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span>  result    <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">//数据库同步读，初始化场景及商城</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token string">"SELECT * FROM Scenes WHERE SceneID = %d;"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_sqlite<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//查询场景表</span>
    m_sqlite<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pError<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span>scene<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> column_size<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> column_value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token keyword">char</span><span class="token operator">*</span> column_name<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        scene<span class="token operator">-&gt;</span><span class="token function">Init</span><span class="token punctuation">(</span>
            <span class="token function">atoi</span><span class="token punctuation">(</span>column_value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">atoi</span><span class="token punctuation">(</span>column_value<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">atoi</span><span class="token punctuation">(</span>column_value<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">NET_UV_LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> pError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pError <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">sprintf</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token string">"SELECT * FROM Shops WHERE ShopID = %d;"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_sqlite<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pError<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span>shop<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> column_size<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> column_value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token keyword">char</span><span class="token operator">*</span> column_name<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        TCCamp<span class="token double-colon punctuation">::</span>ShopSaveData saveData<span class="token punctuation">;</span>
        TCCamp<span class="token double-colon punctuation">::</span>PBShopItem   pbShopItem<span class="token punctuation">;</span>

        ShopItem<span class="token operator">*</span> shopItem <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

        saveData<span class="token punctuation">.</span><span class="token function">ParseFromArray</span><span class="token punctuation">(</span>column_value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>column_value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> saveData<span class="token punctuation">.</span><span class="token function">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pbShopItem <span class="token operator">=</span> saveData<span class="token punctuation">.</span><span class="token function">items</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            shopItem <span class="token operator">=</span> <span class="token punctuation">(</span>ShopItem<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">MALLOC</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ShopItem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span><span class="token punctuation">(</span>shopItem<span class="token punctuation">)</span> <span class="token function">ShopItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            shopItem<span class="token operator">-&gt;</span><span class="token function">Init</span><span class="token punctuation">(</span>
                pbShopItem<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                pbShopItem<span class="token punctuation">.</span><span class="token function">price</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                pbShopItem<span class="token punctuation">.</span><span class="token function">personallimitmaxcount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                pbShopItem<span class="token punctuation">.</span><span class="token function">globallimitcount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                pbShopItem<span class="token punctuation">.</span><span class="token function">globallimitmaxcount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                pbShopItem<span class="token punctuation">.</span><span class="token function">starttime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                pbShopItem<span class="token punctuation">.</span><span class="token function">endtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            shop<span class="token operator">-&gt;</span><span class="token function">AddShopItem</span><span class="token punctuation">(</span>shopItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">NET_UV_LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> pError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pError <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    m_sqlite<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
Exit<span class="token operator">:</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">DBProxy</span><span class="token double-colon punctuation">::</span><span class="token function">PostHandlerEvent</span><span class="token punctuation">(</span>IDBModule<span class="token operator">*</span> iDBModule<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">__</span><span class="token punctuation">(</span>m_mutexWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_workArr<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>iDBModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">DBProxy</span><span class="token double-colon punctuation">::</span><span class="token function">OnPostHandlerEvent</span><span class="token punctuation">(</span>IDBModule<span class="token operator">*</span> iDBModule<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    iDBModule<span class="token operator">-&gt;</span><span class="token function">DBExec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_sqlite<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//iDBModule-&gt;Release();</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="DBLogin_379"></a>使用实例（这里构建一个DBLogin，即登录数据库操作模块）</h3> 
<pre><code class="prism language-cpp"><span class="token comment">//登录DB</span>
<span class="token keyword">class</span> <span class="token class-name">DBLogin</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">IDBModule</span></span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">bool</span> <span class="token function">Init</span><span class="token punctuation">(</span>ReqEvent<span class="token operator">*</span> req<span class="token punctuation">,</span> GameService<span class="token operator">*</span> gameService<span class="token punctuation">,</span> PlayerMgr<span class="token operator">*</span> playerMgr<span class="token punctuation">,</span>
        std<span class="token double-colon punctuation">::</span>string playerID<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string pwd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        m_reqEvent    <span class="token operator">=</span> req<span class="token punctuation">;</span>
        m_gameService <span class="token operator">=</span> gameService<span class="token punctuation">;</span>
        m_playerMgr   <span class="token operator">=</span> playerMgr<span class="token punctuation">;</span>

        m_playerID <span class="token operator">=</span> playerID<span class="token punctuation">;</span>
        m_pwd      <span class="token operator">=</span> pwd<span class="token punctuation">;</span>

        m_count <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        m_code  <span class="token operator">=</span> TCCamp<span class="token double-colon punctuation">::</span>PB_RESULT_CODE<span class="token double-colon punctuation">::</span>SUCCESS<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> <span class="token function">UnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        m_reqEvent    <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        m_gameService <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        m_playerMgr   <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 通过 IDBModule 继承</span>
    <span class="token comment">// 子线程</span>
    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">DBExec</span><span class="token punctuation">(</span>U<span class="token double-colon punctuation">::</span>DB<span class="token double-colon punctuation">::</span>DBSqlite<span class="token operator">*</span> pSqlite<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">bool</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span>  index  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>string selectPwd<span class="token punctuation">;</span>
        <span class="token keyword">bool</span> bFind <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        U<span class="token double-colon punctuation">::</span>DB<span class="token double-colon punctuation">::</span>SQLITE3_RESULT_CODE nRet<span class="token punctuation">;</span>

        <span class="token keyword">char</span>  sql<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> pError    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">nullptr</span> <span class="token operator">==</span> m_reqEvent<span class="token operator">-&gt;</span>TCP_SESSION<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        m_reqEvent<span class="token operator">-&gt;</span>CUR_STATUS <span class="token operator">=</span> ReqEvent<span class="token double-colon punctuation">::</span>TRACE_STATUS<span class="token double-colon punctuation">::</span>QUERYING<span class="token punctuation">;</span>
        <span class="token comment">//查询玩家表</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>sql
            <span class="token punctuation">,</span> <span class="token string">"SELECT PlayerID, Password FROM Players WHERE PlayerID = '%s';"</span>
            <span class="token punctuation">,</span> m_playerID<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        nRet <span class="token operator">=</span> pSqlite<span class="token operator">-&gt;</span><span class="token function">Exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pError
            <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>selectPwd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bFind<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> column_size<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> column_value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token keyword">char</span><span class="token operator">*</span> column_name<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            bFind <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            selectPwd <span class="token operator">=</span> column_value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">NET_UV_LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> pError<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pError <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            m_code <span class="token operator">=</span> TCCamp<span class="token double-colon punctuation">::</span>PB_RESULT_CODE<span class="token double-colon punctuation">::</span>SERVER_ERROR<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bFind<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_code <span class="token operator">=</span> TCCamp<span class="token double-colon punctuation">::</span>PB_RESULT_CODE<span class="token double-colon punctuation">::</span>LOGIN_ACCOUNT_NOT_EXIST<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//判断密码是否正确</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_pwd <span class="token operator">!=</span> selectPwd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_code <span class="token operator">=</span> TCCamp<span class="token double-colon punctuation">::</span>PB_RESULT_CODE<span class="token double-colon punctuation">::</span>LOGIN_PASSWORD_ERROR<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//正确则初始化角色列表</span>
        <span class="token comment">//查询角色表</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>sql
            <span class="token punctuation">,</span> <span class="token string">"SELECT RoleID FROM Roles WHERE PlayerID = '%s';"</span>
            <span class="token punctuation">,</span> m_playerID<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        nRet <span class="token operator">=</span> pSqlite<span class="token operator">-&gt;</span><span class="token function">Exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pError
            <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> column_size<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> column_value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token keyword">char</span><span class="token operator">*</span> column_name<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_roleArrs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>column_value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">NET_UV_LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> pError<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pError <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            m_code <span class="token operator">=</span> TCCamp<span class="token double-colon punctuation">::</span>PB_RESULT_CODE<span class="token double-colon punctuation">::</span>SERVER_ERROR<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> Exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    Exit<span class="token operator">:</span>
        m_reqEvent<span class="token operator">-&gt;</span>CUR_STATUS <span class="token operator">=</span> ReqEvent<span class="token double-colon punctuation">::</span>TRACE_STATUS<span class="token double-colon punctuation">::</span>FINISH<span class="token punctuation">;</span>
        <span class="token comment">//投递至GameService主线程</span>
        m_gameService<span class="token operator">-&gt;</span><span class="token function">PostMsg</span><span class="token punctuation">(</span>POST_COM_KEY<span class="token double-colon punctuation">::</span>PCK_DB_OPERATION<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 主线程</span>
    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">OnDBExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//将player添加至playerMgr中</span>
        <span class="token comment">//清理cache缓冲队列</span>
        <span class="token comment">//回应客户端</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_reqEvent<span class="token operator">-&gt;</span>TCP_SESSION<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            TCCamp<span class="token double-colon punctuation">::</span>AccountLoginRsp rsp<span class="token punctuation">;</span>
            rsp<span class="token punctuation">.</span><span class="token function">set_result</span><span class="token punctuation">(</span>m_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_code <span class="token operator">==</span> TCCamp<span class="token double-colon punctuation">::</span>PB_RESULT_CODE<span class="token double-colon punctuation">::</span>SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Player<span class="token operator">*</span> player <span class="token operator">=</span> <span class="token punctuation">(</span>Player<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">MALLOC</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Player<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">new</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span> <span class="token function">Player</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span> <span class="token operator">!=</span> player<span class="token punctuation">)</span><span class="token punctuation">;</span>
                player<span class="token operator">-&gt;</span><span class="token function">Init</span><span class="token punctuation">(</span>m_playerID<span class="token punctuation">,</span> m_pwd<span class="token punctuation">,</span> m_reqEvent<span class="token operator">-&gt;</span>TCP_SESSION<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> roleID <span class="token operator">:</span> m_roleArrs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    player<span class="token operator">-&gt;</span><span class="token function">AddRole</span><span class="token punctuation">(</span>roleID<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                m_playerMgr<span class="token operator">-&gt;</span><span class="token function">AddPlayer</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            LOG_INFO <span class="token operator">&lt;&lt;</span> <span class="token string">"playerID:"</span> <span class="token operator">&lt;&lt;</span> m_playerID <span class="token operator">&lt;&lt;</span> <span class="token string">" login..."</span><span class="token punctuation">;</span>
            m_reqEvent<span class="token operator">-&gt;</span>TCP_SESSION<span class="token operator">-&gt;</span><span class="token function">Send</span><span class="token punctuation">(</span>TCCamp<span class="token double-colon punctuation">::</span>SERVER_CMD<span class="token double-colon punctuation">::</span>SERVER_LOGIN_RSP<span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        m_playerMgr<span class="token operator">-&gt;</span><span class="token function">RemoveReqEvent</span><span class="token punctuation">(</span>m_reqEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*--m_count;
        if (m_count == 0) {
            UnInit();
            delete this;
        }*/</span>

        <span class="token function">UnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    ReqEvent<span class="token operator">*</span>    m_reqEvent<span class="token punctuation">;</span>
    GameService<span class="token operator">*</span> m_gameService<span class="token punctuation">;</span>
    PlayerMgr<span class="token operator">*</span>   m_playerMgr<span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>string  m_playerID<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string  m_pwd<span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span> m_roleArrs<span class="token punctuation">;</span>

    <span class="token keyword">int</span>  m_count<span class="token punctuation">;</span>
    TCCamp<span class="token double-colon punctuation">::</span>PB_RESULT_CODE m_code<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    DBLogin<span class="token operator">*</span>  dbLogin <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    
    dbLogin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">DBLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dbLogin<span class="token operator">-&gt;</span><span class="token function">Init</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> m_gameService<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> 
        loginReq<span class="token operator">-&gt;</span><span class="token function">accountid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        loginReq<span class="token operator">-&gt;</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//抛至数据库代理</span>
    <span class="token class-name">DBProxy</span><span class="token double-colon punctuation">::</span><span class="token function">Ins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PostHandlerEvent</span><span class="token punctuation">(</span>dbLogin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/11d437df2bd56dd849643bac56aa3773/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">修改mysql表中的一个字段类型</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7d30e41e70b9d867e9f065b7d611f820/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【redisson】【redis】redisson初始化失败</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>