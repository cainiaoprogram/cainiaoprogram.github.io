<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>AlphaFold2代码阅读（三） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="AlphaFold2代码阅读（三）" />
<meta property="og:description" content="2021SC@SDUSC
前言 看了Evoformer的代码，一如既往地晦涩难懂，所以在看代码的同时阅读了论文，果然感觉好了很多。
一、class EvoformerIteration 1.代码 class EvoformerIteration(hk.Module): def __init__(self, config, global_config, is_extra_msa, name=&#39;evoformer_iteration&#39;): super().__init__(name=name) self.config = config self.global_config = global_config self.is_extra_msa = is_extra_msa def __call__(self, activations, masks, is_training=True, safe_key=None): c = self.config gc = self.global_config msa_act, pair_act = activations[&#39;msa&#39;], activations[&#39;pair&#39;] if safe_key is None: safe_key = prng.SafeKey(hk.next_rng_key()) msa_mask, pair_mask = masks[&#39;msa&#39;], masks[&#39;pair&#39;] dropout_wrapper_fn = functools.partial( dropout_wrapper, is_training=is_training, global_config=gc) safe_key, *sub_keys = safe_key.split(10) sub_keys = iter(sub_keys) msa_act = dropout_wrapper_fn( MSARowAttentionWithPairBias( c." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f2992cee517eb4a4295819dbb550cf4e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-31T20:10:15+08:00" />
<meta property="article:modified_time" content="2021-10-31T20:10:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">AlphaFold2代码阅读（三）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>2021SC@SDUSC</p> 
<hr color="#000000" size='1"'> 
<h2><a id="_8"></a>前言</h2> 
<p>看了Evoformer的代码，一如既往地晦涩难懂，所以在看代码的同时阅读了论文，果然感觉好了很多。</p> 
<hr color="#000000" size='1"'> 
<h2><a id="class_EvoformerIteration_15"></a>一、class EvoformerIteration</h2> 
<h3><a id="1_16"></a>1.代码</h3> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">EvoformerIteration</span><span class="token punctuation">(</span>hk<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
 
  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">,</span> global_config<span class="token punctuation">,</span> is_extra_msa<span class="token punctuation">,</span>
               name<span class="token operator">=</span><span class="token string">'evoformer_iteration'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>config <span class="token operator">=</span> config
    self<span class="token punctuation">.</span>global_config <span class="token operator">=</span> global_config
    self<span class="token punctuation">.</span>is_extra_msa <span class="token operator">=</span> is_extra_msa

  <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> activations<span class="token punctuation">,</span> masks<span class="token punctuation">,</span> is_training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> safe_key<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
 
    c <span class="token operator">=</span> self<span class="token punctuation">.</span>config
    gc <span class="token operator">=</span> self<span class="token punctuation">.</span>global_config

    msa_act<span class="token punctuation">,</span> pair_act <span class="token operator">=</span> activations<span class="token punctuation">[</span><span class="token string">'msa'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> activations<span class="token punctuation">[</span><span class="token string">'pair'</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> safe_key <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
      safe_key <span class="token operator">=</span> prng<span class="token punctuation">.</span>SafeKey<span class="token punctuation">(</span>hk<span class="token punctuation">.</span>next_rng_key<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    msa_mask<span class="token punctuation">,</span> pair_mask <span class="token operator">=</span> masks<span class="token punctuation">[</span><span class="token string">'msa'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> masks<span class="token punctuation">[</span><span class="token string">'pair'</span><span class="token punctuation">]</span>

    dropout_wrapper_fn <span class="token operator">=</span> functools<span class="token punctuation">.</span>partial<span class="token punctuation">(</span>
        dropout_wrapper<span class="token punctuation">,</span>
        is_training<span class="token operator">=</span>is_training<span class="token punctuation">,</span>
        global_config<span class="token operator">=</span>gc<span class="token punctuation">)</span>

    safe_key<span class="token punctuation">,</span> <span class="token operator">*</span>sub_keys <span class="token operator">=</span> safe_key<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    sub_keys <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>sub_keys<span class="token punctuation">)</span>

    msa_act <span class="token operator">=</span> dropout_wrapper_fn<span class="token punctuation">(</span>
        MSARowAttentionWithPairBias<span class="token punctuation">(</span>
            c<span class="token punctuation">.</span>msa_row_attention_with_pair_bias<span class="token punctuation">,</span> gc<span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'msa_row_attention_with_pair_bias'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        msa_act<span class="token punctuation">,</span>
        msa_mask<span class="token punctuation">,</span>
        safe_key<span class="token operator">=</span><span class="token builtin">next</span><span class="token punctuation">(</span>sub_keys<span class="token punctuation">)</span><span class="token punctuation">,</span>
        pair_act<span class="token operator">=</span>pair_act<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>is_extra_msa<span class="token punctuation">:</span>
      attn_mod <span class="token operator">=</span> MSAColumnAttention<span class="token punctuation">(</span>
          c<span class="token punctuation">.</span>msa_column_attention<span class="token punctuation">,</span> gc<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'msa_column_attention'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
      attn_mod <span class="token operator">=</span> MSAColumnGlobalAttention<span class="token punctuation">(</span>
          c<span class="token punctuation">.</span>msa_column_attention<span class="token punctuation">,</span> gc<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'msa_column_global_attention'</span><span class="token punctuation">)</span>
    msa_act <span class="token operator">=</span> dropout_wrapper_fn<span class="token punctuation">(</span>
        attn_mod<span class="token punctuation">,</span>
        msa_act<span class="token punctuation">,</span>
        msa_mask<span class="token punctuation">,</span>
        safe_key<span class="token operator">=</span><span class="token builtin">next</span><span class="token punctuation">(</span>sub_keys<span class="token punctuation">)</span><span class="token punctuation">)</span>

    msa_act <span class="token operator">=</span> dropout_wrapper_fn<span class="token punctuation">(</span>
        Transition<span class="token punctuation">(</span>c<span class="token punctuation">.</span>msa_transition<span class="token punctuation">,</span> gc<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'msa_transition'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        msa_act<span class="token punctuation">,</span>
        msa_mask<span class="token punctuation">,</span>
        safe_key<span class="token operator">=</span><span class="token builtin">next</span><span class="token punctuation">(</span>sub_keys<span class="token punctuation">)</span><span class="token punctuation">)</span>

    pair_act <span class="token operator">=</span> dropout_wrapper_fn<span class="token punctuation">(</span>
        OuterProductMean<span class="token punctuation">(</span>
            config<span class="token operator">=</span>c<span class="token punctuation">.</span>outer_product_mean<span class="token punctuation">,</span>
            global_config<span class="token operator">=</span>self<span class="token punctuation">.</span>global_config<span class="token punctuation">,</span>
            num_output_channel<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>pair_act<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'outer_product_mean'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        msa_act<span class="token punctuation">,</span>
        msa_mask<span class="token punctuation">,</span>
        safe_key<span class="token operator">=</span><span class="token builtin">next</span><span class="token punctuation">(</span>sub_keys<span class="token punctuation">)</span><span class="token punctuation">,</span>
        output_act<span class="token operator">=</span>pair_act<span class="token punctuation">)</span>

    pair_act <span class="token operator">=</span> dropout_wrapper_fn<span class="token punctuation">(</span>
        TriangleMultiplication<span class="token punctuation">(</span>c<span class="token punctuation">.</span>triangle_multiplication_outgoing<span class="token punctuation">,</span> gc<span class="token punctuation">,</span>
                               name<span class="token operator">=</span><span class="token string">'triangle_multiplication_outgoing'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        pair_act<span class="token punctuation">,</span>
        pair_mask<span class="token punctuation">,</span>
        safe_key<span class="token operator">=</span><span class="token builtin">next</span><span class="token punctuation">(</span>sub_keys<span class="token punctuation">)</span><span class="token punctuation">)</span>
    pair_act <span class="token operator">=</span> dropout_wrapper_fn<span class="token punctuation">(</span>
        TriangleMultiplication<span class="token punctuation">(</span>c<span class="token punctuation">.</span>triangle_multiplication_incoming<span class="token punctuation">,</span> gc<span class="token punctuation">,</span>
                               name<span class="token operator">=</span><span class="token string">'triangle_multiplication_incoming'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        pair_act<span class="token punctuation">,</span>
        pair_mask<span class="token punctuation">,</span>
        safe_key<span class="token operator">=</span><span class="token builtin">next</span><span class="token punctuation">(</span>sub_keys<span class="token punctuation">)</span><span class="token punctuation">)</span>

    pair_act <span class="token operator">=</span> dropout_wrapper_fn<span class="token punctuation">(</span>
        TriangleAttention<span class="token punctuation">(</span>c<span class="token punctuation">.</span>triangle_attention_starting_node<span class="token punctuation">,</span> gc<span class="token punctuation">,</span>
                          name<span class="token operator">=</span><span class="token string">'triangle_attention_starting_node'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        pair_act<span class="token punctuation">,</span>
        pair_mask<span class="token punctuation">,</span>
        safe_key<span class="token operator">=</span><span class="token builtin">next</span><span class="token punctuation">(</span>sub_keys<span class="token punctuation">)</span><span class="token punctuation">)</span>
    pair_act <span class="token operator">=</span> dropout_wrapper_fn<span class="token punctuation">(</span>
        TriangleAttention<span class="token punctuation">(</span>c<span class="token punctuation">.</span>triangle_attention_ending_node<span class="token punctuation">,</span> gc<span class="token punctuation">,</span>
                          name<span class="token operator">=</span><span class="token string">'triangle_attention_ending_node'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        pair_act<span class="token punctuation">,</span>
        pair_mask<span class="token punctuation">,</span>
        safe_key<span class="token operator">=</span><span class="token builtin">next</span><span class="token punctuation">(</span>sub_keys<span class="token punctuation">)</span><span class="token punctuation">)</span>

    pair_act <span class="token operator">=</span> dropout_wrapper_fn<span class="token punctuation">(</span>
        Transition<span class="token punctuation">(</span>c<span class="token punctuation">.</span>pair_transition<span class="token punctuation">,</span> gc<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'pair_transition'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        pair_act<span class="token punctuation">,</span>
        pair_mask<span class="token punctuation">,</span>
        safe_key<span class="token operator">=</span><span class="token builtin">next</span><span class="token punctuation">(</span>sub_keys<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">'msa'</span><span class="token punctuation">:</span> msa_act<span class="token punctuation">,</span> <span class="token string">'pair'</span><span class="token punctuation">:</span> pair_act<span class="token punctuation">}</span>

</code></pre> 
<p>  看完这段代码，知道这段代码主要是实现了一个Evoformer Block，这个Evoformer Block应该会迭代很多次。<br> 其中__call__函数的参数如下：<br> 参数:<br> activations: 包含activations的字典:<br> msa: MSA 激活, shape是[N_seq, N_res, c_m].<br> pair: pair 激活, shape是[N_res, N_res, c_z].<br> masks:masks的字典:<br> msa: MSA mask, shape 是[N_seq, N_res].<br> pair: pair mask, shape是 [N_res, N_res].<br> is_training:模块是否处于培训模式<br> safe_key: prng.SafeKey封装rng密钥<br> 返回值:<br> 输出（outputs）</p> 
<p>为了能更深入的理解这部分代码，所以我要结合论文理解了。</p> 
<h3><a id="2_144"></a>2.理解代码</h3> 
<p><em><strong>以下是我阅读了这部分论文后做出的总结。首先要从整体的网络结构说起。</strong></em></p> 
<p><strong>网络结构</strong></p> 
<p>  AlphaFold2通过结合基于蛋白质结构的进化、物理和几何约束，开发了新型神经网络架构和训练方法，大大提高了结构预测的准确性，其架构如下图所示：</p> 
<p><img src="https://images2.imgbox.com/34/0e/kjuYLfKK_o.png" alt="在这里插入图片描述"></p> 
<p>  该网络包括两个主要阶段，即主干模块和结构模块。主干模块由重复堆叠的Evoformer模块构成，以生成已处理的MSA和残基对（配对的氨基酸）的表示。<br>   其中MSA是指多重序列比对，表示对一组蛋白质序列的演化关系、同源关系的分析结果，例如氨基酸的突变情况，通常用于揭示蛋白质二级结构与三级结构甚至个别氨基酸的保守性。</p> 
<p><strong>Evoformer模块</strong></p> 
<p>  Evoformer 模块包含了许多新颖的基于注意力和非基于注意力的组件。Evoformer的关键创新是提出了在 MSA 内交换信息的新机制，并且其配对表示允许直接推理空间和进化关系。主干模块之后是结构模块。该模块的输出是蛋白质的每个残基的旋转和平移信息，从而引入了明确的 3-D 结构。这些表示以所有旋转角度和所有位置坐标进行初始化，并能快速收敛至具有精确原子细节的高度准确的蛋白质结构。</p> 
<p>这一模块的关键创新包括：</p> 
<p>（1）通过打破链原子结构，允许同时对结构的所有部分进行局部细化。</p> 
<p>（2）提出一种新颖的等变Transformer架构，允许网络隐式推理未表示的侧链原子。</p> 
<p>（3）提出一个损失项，给残基的方向正确性提供关键权重。</p> 
<p>在结构模块和整个网络中，通过重复将最终损失应用于输出，然后将输出递归地馈送到相同模块来强化迭代细化。使用整个网络的迭代细化，显着提高了准确性，而额外的训练时间很少。</p> 
<p><strong>Evoformer模块关键原理</strong></p> 
<p>  Evoformer模块的关键原理是将蛋白质结构预测视为 3-D 空间中的图推理问题，其中图的边缘由邻近的残基定义，配对表示（以数组表示）的元素则编码有关残基之间关系的信息，如下图所示：<img src="https://images2.imgbox.com/c9/fe/AmCPCXIf_o.png" alt="在这里插入图片描述"><br>   对于MSA 表示数组，其列编码输入序列的各个残基，而行表示这些残基出现的序列。在这个框架内，定义了许多更新操作，这些更新操作应用于每个块中，其中不同的更新操作被串联应用。与之前的工作不同，这些操作将持续应用于每个模块中，而不是只在网络中应用一次，这使得从不断演化的 MSA 表示和配对表示之间可以进行连续通信。</p> 
<p><strong>预测过程解释</strong></p> 
<p>  AlphaFold2 是如何预测蛋白质结构的呢？AlphaFold2为网络中的 48 个 Evoformer 模块中各自单独训练了一个结构模块，同时保持主网络的所有参数保持不变。在前几个模块之后产生的轨迹非常平滑，表明 AlphaFold2 对蛋白质结构进行了不断的增量改进，直到它不能再改进。</p> 
<hr color="#000000" size='1"'> 
<h2><a id="_186"></a>总结</h2> 
<p>结合论文看代码，果然对EvoformerIteration的理解更加深入了。<br> 随着对AlphaFold2理解的越来越多，我觉得我应该系统的学习一下深度学习。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ecb6403e0a3e86f72303479bec07c7bf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">极化SAR影像分类降维方探讨</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/91efeec6cc6d24f55f31b0328c45ec8e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Error creating bean with name ‘org.springframework.security.oauth2.config.annotation.web.configurati</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>