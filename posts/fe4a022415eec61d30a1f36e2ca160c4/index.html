<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>目标检测之—MTCNN实现人脸检测 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="目标检测之—MTCNN实现人脸检测" />
<meta property="og:description" content="摘要 MTCNN算法，这个算法可以将人脸检测和特征点检测结合起来，并且MTCNN的级联结构对现代的人脸识别也产生了很大的影响。本文为大家介绍MTCNN的算法原理和训练技巧，随后解析MTCNN算法的代码以及DEMO演示。论文地址。
一，原理 人脸检测，解决两个问题：
1)识别图片中有没有人脸？
2)如果有，人脸在哪？因此，许多人脸应用(人脸识别、特征分析)的基础是人脸检测。
MTCNN:(Multi-task Cascaded Convolutional Neural Networks) 翻译为：
多任务级联卷积神经网络，MTCNN在刚出来的时候是表现非常优秀的，目前已经不是最优的了，该网络的进步意义在于：第一次将人脸检测和人脸特征点定位结合起来，以及采用三个网络级联使用和图像金字塔缩放的思想。
（1）MTCNN侦测第一阶段
通过P-Net（Proposal Network），获得候选窗口和边界回归值。同时候选窗口根据边界框进行校正，再利用NMS（非极大值抑制）去除重复的候选框。
（2）MTCNN侦测第二阶段
经过PNet处理后的候选框输入到R-Net（Refine Network），RNet对这些候选的框体对应的图片进一步侦测，最后在卷积的最后一层使用全连接网络进行分类，然后再次使用NMS去除这时重复的候选框，留下部分候选框。
（3）MTCNN侦测第三阶段
O-net(Output Network)对上层网络输出的结果进行进一步的侦测，同样对这些重复的候选框使用了NMS，并最终输出各个候选框的置信度以及标定每个候选框中人脸的5个特征点。
以上只是三个级联网络的大致使用流程，其中涉及了很多图像变换操作，IOU，NMS的计算，而且三个网络的要求精度为：Onet &gt;Rnet&gt;Pnet。让我们直接上摘自论文的经典流程图：
​​
可以看出，MTCNN网络在对单独一个人脸侦测过程是从最开始的输出很多候选框到最终确定为一个人脸框及5个特征点。
二、网络结构图 如下：
代码：
import torch import torch.nn as nn &#34;&#34;&#34; 对网络结构进行了改进，Depthwise Conv&#34;&#34;&#34; class PNet(nn.Module): def __init__(self): super(PNet, self).__init__() self.pre_layer = nn.Sequential( nn.Conv2d(3, 8, 3, 1), nn.PReLU(), nn.MaxPool2d(2, 2), nn.Conv2d(8, 16, 3, 1, groups=4), nn.PReLU(), nn.Conv2d(16, 32, 3, 1, groups=8), nn.PReLU()) self.conv4_1 = nn.Conv2d(32, 1, kernel_size=1, stride=1) self." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/fe4a022415eec61d30a1f36e2ca160c4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-26T17:28:43+08:00" />
<meta property="article:modified_time" content="2020-05-26T17:28:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">目标检测之—MTCNN实现人脸检测</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a><strong>摘要</strong></h3> 
<p>MTCNN算法，这个算法可以将人脸检测和特征点检测结合起来，并且MTCNN的级联结构对现代的人脸识别也产生了很大的影响。本文为大家介绍MTCNN的算法原理和训练技巧，随后解析MTCNN算法的代码以及DEMO演示。<a href="https://arxiv.org/ftp/arxiv/papers/1604/1604.02878.pdf" rel="nofollow">论文地址</a>。</p> 
<h3><a id="_3"></a>一，原理</h3> 
<p>人脸检测，解决两个问题：</p> 
<p>1)识别图片中有没有人脸？</p> 
<p>2)如果有，人脸在哪？因此，许多人脸应用(人脸识别、特征分析)的基础是人脸检测。</p> 
<p>MTCNN:(Multi-task Cascaded Convolutional Neural Networks) 翻译为：<br> 多任务级联卷积神经网络，MTCNN在刚出来的时候是表现非常优秀的，目前已经不是最优的了，该网络的进步意义在于：第一次将人脸检测和人脸特征点定位结合起来，以及采用三个网络级联使用和图像金字塔缩放的思想。</p> 
<p>（1）MTCNN侦测第一阶段<br> 通过P-Net（Proposal Network），获得候选窗口和边界回归值。同时候选窗口根据边界框进行校正，再利用NMS（非极大值抑制）去除重复的候选框。<br> （2）MTCNN侦测第二阶段<br> 经过PNet处理后的候选框输入到R-Net（Refine Network），RNet对这些候选的框体对应的图片进一步侦测，最后在卷积的最后一层使用全连接网络进行分类，然后再次使用NMS去除这时重复的候选框，留下部分候选框。<br> （3）MTCNN侦测第三阶段<br> O-net(Output Network)对上层网络输出的结果进行进一步的侦测，同样对这些重复的候选框使用了NMS，并最终输出各个候选框的置信度以及标定每个候选框中人脸的5个特征点。<br> 以上只是三个级联网络的大致使用流程，其中涉及了很多图像变换操作，IOU，NMS的计算，而且三个网络的要求精度为：Onet &gt;Rnet&gt;Pnet。让我们直接上摘自论文的经典流程图：<br> ​​<br> <img src="https://images2.imgbox.com/f5/f9/SgFKcLPS_o.png" alt="侦测流程"><br> 可以看出，MTCNN网络在对单独一个人脸侦测过程是从最开始的输出很多候选框到最终确定为一个人脸框及5个特征点。</p> 
<h3><a id="_24"></a>二、网络结构图</h3> 
<p>如下：<br> <img src="https://images2.imgbox.com/4b/0f/qQa9LlLS_o.png" alt="网络结构"><br> 代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token triple-quoted-string string">""" 对网络结构进行了改进，Depthwise Conv"""</span>

<span class="token keyword">class</span> <span class="token class-name">PNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>PNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>pre_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> groups<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> groups<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>conv4_1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv4_2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>pre_layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        cls <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv4_1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        offset <span class="token operator">=</span> self<span class="token punctuation">.</span>conv4_2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">,</span> offset


<span class="token keyword">class</span> <span class="token class-name">RNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pre_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 22*22*28</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 11*11*28</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>groups<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 9*9*48</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 4*4*48</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 3*3*64</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>prelu4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv5_1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv5_2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>pre_layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>prelu4<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        cls <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv5_1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        offset <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5_2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">,</span> offset


<span class="token keyword">class</span> <span class="token class-name">ONet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ONet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pre_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 46*46*32</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 23*23*32</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 21*21*64</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 10*10*64</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> groups<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 8*8*64</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 4*4*64</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 3*3*128</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>prelu5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv6_1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv6_2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>pre_layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>prelu5<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        cls <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv6_1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        offset <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6_2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">,</span> offset
  <span class="token triple-quoted-string string">""" 带有landmark的Onet"""</span>
<span class="token keyword">class</span> <span class="token class-name">ONet_</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ONet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pre_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 46*46*32</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 23*23*32</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 21*21*64</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 10*10*64</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> groups<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 8*8*64</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 4*4*64</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 3*3*128</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>prelu5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv6_1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv6_2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv6_3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>pre_layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>prelu5<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        cls <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv6_1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        offset <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6_2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        landmark <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6_3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> landmark


</code></pre> 
<p>对于网络结构可以后面看代码具体了解，还可以对网络进行改进。。重点看每个网络的输入部分；P-Net的输入为：12x12x3，即一张12x12像素的三通道RGB图像所对应的数组。然而真实的拍张照片一个人脸的大小怎么也比12x12大吧？所以MTCNN使用图像金字塔通过对一幅图像的缩放来产生一系列最小边长不小于12的图像输入我们的侦测网络中，因为像素很小，所以网络对每张图像的响应是很快的，但是由于图像数量太多，导致网络整体的侦测速度较慢，这里不再展开叙述。<br> 所以我们知道了，R网络可以侦测的最小图像大小为24x24，O网络为48x48。要是我们的原始图像里的人脸小于48*48这个值，MTCNN就不具备侦测能力了——这是<strong>错误理解</strong>。<br> <a href="https://baijiahao.baidu.com/s?id=1638209720769473610&amp;wfr=spider&amp;for=pc" rel="nofollow">图像金字塔</a>是对图像进行缩放，也就是说把一张比如200x200的图像可以缩放为12x12大小，在这个缩放过程中，无论图像中人脸大小为多少，都能被放进12x12大的框中然后被输入网络进行侦测。</p> 
<h3><a id="_159"></a>三，网络训练</h3> 
<p><strong>1、损失函数</strong></p> 
<p>MTCNN对人脸的特征描述分为：<br> （1）对人脸和非人脸的分类问题；<br> （2）对人脸边界框的回归问题；<br> （3）对人脸的特征点的回归问题。<br> 对于<strong>人脸分类问题</strong>的目标函数为<br> <img src="https://images2.imgbox.com/8f/da/xGivad51_o.png" alt="BCELoss"><br> 对<strong>边界框回归</strong>的目标函数为<br> <img src="https://images2.imgbox.com/51/8d/z4A9ODX6_o.png" alt="MSELoss"><br> 对<strong>人脸5个特征点回归</strong>的目标函数为<br> <img src="https://images2.imgbox.com/8b/14/AYuZ2SX2_o.png" alt="MSELoss"><br> 综合起来的<strong>损失函数</strong>为<br> <img src="https://images2.imgbox.com/a9/64/UJtwzT5r_o.png" alt="多任务联合损失函数"><br> 原论文在P,R网络中设置：<strong>αdet = 1，αbox =0.5，αlandmark = 0.50</strong>，而在O网络中将<strong>αlandmark设为1</strong>，其他不变。这是常见的多任务联合损失函数的定义。</p> 
<p><strong>2，数据集生成</strong></p> 
<p>我使用的是CelebA数据集，使用前需要对数据集进行预处理。<br> 论文中生成训练时需要的<strong>正样本：负样本：部分样本</strong>比例为 1：3：1。<br> IOU值（即两幅图像有重叠部分时，交集比并集的值）。其中IOU值大于0.65作为正样本，0.65&gt;iou&gt;0.4的样本为部分样本，iou&lt;0.4的为负样本。（这个取值范围可以根据自己数据集生成后的效果进行调整，要求是正样本的图片包含了一个完整的人脸，部分样本要能够让我们直接看出来这是一张人脸，负样本里看不出来这是一张人脸。）<br> <img src="https://images2.imgbox.com/06/09/UfavpZlT_o.png" alt="IOU"><br> <img src="https://images2.imgbox.com/7a/eb/9VcO5Stv_o.png" alt="IOU">生成数据集的**<a href="https://toocy7.blog.csdn.net/article/details/106165599" rel="nofollow">代码链接**</a>：主要是通过获取原始图片的中心坐标和宽高后，对中心点进行一定偏移，生成不同的（W*H）大小的图像并判断图像与原始图像的IOU值，归为各自的样本分类，并对图像进行Resize操作为12x12、24x24、48x48大小的样本集，在TXT文档中保存的图像中心点对原始图像中心点的偏移量，及左上角和右下角的偏移量，对于O网络，还生成5个特征点坐标的偏移量。有了各自对应的偏移量，我们就可以反算回原图的坐标啦。</p> 
<p><strong>3 ，编辑工具代码</strong></p> 
<p>为了满足MTCNN训练和侦测使用需要的工具代码主要有三部分：IOU、NMS和转换正方形。代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>box<span class="token punctuation">,</span> boxes<span class="token punctuation">,</span> isMin<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    :param box: [N 1] x1,y1,x2,y2 0123
    :param boxes: [N,4]--&gt;[x1,y1,x2,y2]
    :param isMin:calculate the minimum inter area
    :return:[n, iou]
    """</span>
    box_area <span class="token operator">=</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    area <span class="token operator">=</span> <span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    xx1 <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    yy1 <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    xx2 <span class="token operator">=</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    yy2 <span class="token operator">=</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    w <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> xx2 <span class="token operator">-</span> xx1<span class="token punctuation">)</span>
    h <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> yy2 <span class="token operator">-</span> yy1<span class="token punctuation">)</span>
    inter <span class="token operator">=</span> w <span class="token operator">*</span> h
    <span class="token keyword">if</span> isMin<span class="token punctuation">:</span>
        ious <span class="token operator">=</span> np<span class="token punctuation">.</span>true_divide<span class="token punctuation">(</span>inter<span class="token punctuation">,</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>box_area<span class="token punctuation">,</span> area<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        ious <span class="token operator">=</span> np<span class="token punctuation">.</span>true_divide<span class="token punctuation">(</span>inter<span class="token punctuation">,</span> <span class="token punctuation">(</span>box_area<span class="token operator">+</span>area<span class="token operator">-</span>inter<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> ious


<span class="token keyword">def</span> <span class="token function">nms</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> thresh<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> isMin<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    :param boxes: [x1 y1 x2 y2 cls] * n cls&gt;cls&gt;cls --&gt; iou --&gt;
    :param thresh:iou condition
    :param isMin: p-r: False , o:True
    :return: np.arrays ([x,y,x1,y1,conf]* N)
    """</span>
    <span class="token keyword">if</span> boxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    a_boxes <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">-</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argsort<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 切片和返回排序的索引按照最大到最小排列</span>
    r_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">while</span> a_boxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># 大于1行以上</span>
        a_box <span class="token operator">=</span> a_boxes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        b_boxes <span class="token operator">=</span> a_boxes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        r_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a_box<span class="token punctuation">)</span>  <span class="token comment"># 每次都保留cls最大的box</span>
        index <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>iou<span class="token punctuation">(</span>a_box<span class="token punctuation">,</span> b_boxes<span class="token punctuation">,</span> isMin<span class="token punctuation">)</span> <span class="token operator">&lt;</span> thresh<span class="token punctuation">)</span>
        <span class="token comment"># np.where 返回索引值</span>
        a_boxes <span class="token operator">=</span> b_boxes<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    x <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">if</span> a_boxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        r_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a_boxes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>r_boxes<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">nms2</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> thresh<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> isMin<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    包含iou计算的nms，对图像中 H &lt; 50 及 inter面积 &lt; 5000的box进行侦测
    :param boxes: [x1 y1 x2 y2 cls] * n cls&gt;cls&gt;cls --&gt; iou --&gt;
    :param thresh:iou condition
    :param isMin: p-r: False , o:True
    :return: np.arrays ([x,y,x1,y1,conf]* N)
    """</span>
    <span class="token keyword">if</span> boxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    a_boxes <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">-</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argsort<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 切片和返回排序的索引按照最大到最小排列</span>
    r_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">while</span> a_boxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># 大于1行以上</span>
        
        a_box <span class="token operator">=</span> a_boxes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        b_boxes <span class="token operator">=</span> a_boxes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        r_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a_box<span class="token punctuation">)</span>  <span class="token comment"># 每次都保留cls最大的box</span>
        box_area <span class="token operator">=</span> <span class="token punctuation">(</span>a_box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> a_box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>a_box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> a_box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        area <span class="token operator">=</span> <span class="token punctuation">(</span>b_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> b_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>b_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> b_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        xx1 <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>b_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a_box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        yy1 <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>b_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a_box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        xx2 <span class="token operator">=</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>b_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a_box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        yy2 <span class="token operator">=</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>b_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a_box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        w <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> xx2 <span class="token operator">-</span> xx1<span class="token punctuation">)</span>
        h <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> yy2 <span class="token operator">-</span> yy1<span class="token punctuation">)</span>
        index_h <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>h <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">)</span>
        inter <span class="token operator">=</span> w<span class="token punctuation">[</span>index_h<span class="token punctuation">]</span> <span class="token operator">*</span> h<span class="token punctuation">[</span>index_h<span class="token punctuation">]</span>
        index1 <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>inter <span class="token operator">&lt;</span> <span class="token number">5000</span><span class="token punctuation">)</span>
        area <span class="token operator">=</span> area<span class="token punctuation">[</span>index1<span class="token punctuation">]</span>
        inter <span class="token operator">=</span> inter<span class="token punctuation">[</span>index1<span class="token punctuation">]</span>
        <span class="token keyword">if</span> isMin<span class="token punctuation">:</span>
            ious <span class="token operator">=</span> np<span class="token punctuation">.</span>true_divide<span class="token punctuation">(</span>inter<span class="token punctuation">,</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>box_area<span class="token punctuation">,</span> area<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            ious <span class="token operator">=</span> np<span class="token punctuation">.</span>true_divide<span class="token punctuation">(</span>inter<span class="token punctuation">,</span> <span class="token punctuation">(</span>box_area <span class="token operator">+</span> area <span class="token operator">-</span> inter<span class="token punctuation">)</span><span class="token punctuation">)</span>
        index <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>ious <span class="token operator">&lt;</span> thresh<span class="token punctuation">)</span>
        a_boxes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b_boxes<span class="token punctuation">[</span>index1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> a_boxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        r_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a_boxes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>r_boxes<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">convert_to_squre</span><span class="token punctuation">(</span>bbox<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    :param bbox: x1,y1,x2,y2
    :return: square box of x1,y1,x2,y2
    """</span>
    sq_box <span class="token operator">=</span> bbox<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> bbox<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    h <span class="token operator">=</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    w <span class="token operator">=</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    
    max_len <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">)</span>
    
    sq_box<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>w <span class="token operator">-</span> max_len<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span>
    sq_box<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>h <span class="token operator">-</span> max_len<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span>
    sq_box<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> sq_box<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> max_len
    sq_box<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> sq_box<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> max_len
    
    <span class="token keyword">return</span> sq_box

</code></pre> 
<p>为什么需要呢？</p> 
<p><strong>IOU：重复部分占两个候选框并集面积的衡量。</strong></p> 
<p>网络对需要侦测的图片输出结果为: 置信度和边框坐标。由于检测过程中使用图像金字塔对输入图像进行缩放，网络对图像的人脸区域会生成很多候选框。这些候选框不能全部都输入后面的网络，这样会增加这个侦测所用的时间，而且，我们只需要得到对一个人脸唯一的最优的一个候选框，所有与该候选框具有重复部分的候选框我们都可以通过筛选来去除掉。<br> 那么，重复部分的面积越大，两个框为同一个人脸的概率就越大；面积越小，概率越小。所以这里我们相当于引入了一个超参数对这个条件进行约束。同理，这里在我们生成数据集样本时，也用到了IOU，在这里我们认为：<br> <strong>iou &gt;0.65</strong> 的图像，我们认为图像中心点虽然有一定的偏移，但是图像里还是一个完整的人脸，因为他偏移的不多，就可以作为我们的正样本来使用。<br> <img src="https://images2.imgbox.com/9f/4c/nvfvsC2L_o.png" alt="Positive"><br> 部分样本呢，我们选择的是 <strong>0.65&gt;iou&gt;0.4,</strong> 跟正样本类似，能看到图像里是一个人脸，但是他偏移的多一些。所以我们用正样本和部分样本一起来进行三个网络的偏移量训练。这是<strong>回归任务</strong>哦。<br> <img src="https://images2.imgbox.com/43/86/bdPi3r2C_o.png" alt="Part"><br> 负样本：当<strong>iou&lt;0.3</strong>时，嗯。。。。这图片里肯定不是个人脸。所以：我们用负样本和正样本去训练网络识别是否有人脸。这是<strong>分类任务</strong>哦。<br> <img src="https://images2.imgbox.com/b7/42/jkRag8As_o.png" alt="Negative"><br> <strong>NMS:抑制不是极大值的元素，搜索局部的极大值。</strong></p> 
<p>先假设有6个矩形框，根据分类器类别分类概率做排序，从大到小分别属于人脸的概率分别为：<br> <strong>概率：蓝色&gt;红色 &gt;绿色</strong><br> 图中几乎每两个框都有相交，只要有相交的就有IOU值，不相交就为0。<br> 1、首先对所有框进行置信度排序：蓝色0&gt;红色 5&gt;绿色… （编号1-4）；<br> 2、蓝色0不动，其他所有框都跟蓝色0大佬作IOU计算，得到一个排列：<strong>绿色3&gt;绿色4&gt;绿色2&gt;红色5&gt;绿色1=0；</strong><br> PS：从图上可以看出来吧？<br> 3、<strong>去除其中大于阈值的框，比如0.3；</strong><br> 4、这时，绿色3、4因为重复面积太多被删除了，<strong>绿色1、2和红色5留下，同时保留蓝色大佬；</strong><br> 5、对绿色1、2和红色5进行置信度排序：红色5 &gt; 绿色2 &gt; 绿色1；<br> 6、红色5大佬不动，其他所有框跟红色5作IOU计算，<strong>排列：绿色2 &gt; 绿色1 &gt; 0.3；</strong><br> 7、绿色1、2也走了。。。<br> 结果：<strong>蓝色、红色</strong> 嗯。。。是我们想要的！<br> <img src="https://images2.imgbox.com/3a/a1/LVks8LpQ_o.png" alt="NMS"><br> <strong>转正方形 ：MTCNN使用的级联思想是：Pnet–&gt;Rnet–&gt;Onet，在这中间流动的是我们的图片和上一层网络侦测的结果。</strong></p> 
<p>但是通过网络预测处理的box（x1,x2,y1,y2）不是正方形的，而后面网络想要对这些预测框进行准确的侦测的基础是，<strong>输入网络的图片必须是固定大小的</strong>。所以我们需要将box转换为正方形。<br> <img src="https://images2.imgbox.com/f8/66/m7Z1BCAh_o.png" alt="convert"><br> 常用的resize，reshape操作一般会改变图像的实际分辨率和像素间的位置关系。这不是我们想要的。而且，这里得到只是一组**人脸图像对应的坐标值，而不是原始的图像。**所以我们想到了，将box变成一个正方形区域，这样在原图上对应的图像区域就包含有以前box，同时也得到图像的更多更完整的信息。上图:<strong>红色框是Pnet检测出的box，蓝色框是转为正方形后的box。</strong><br> <img src="https://images2.imgbox.com/6d/d1/gPtjBxeb_o.png" alt="Output"><br> <strong>4 ，开始训练网络</strong><br> P网络Loss：0.01<br> R网络Loss：0.002<br> O网络Loss：0.0005<br> 训练时间：PNet 1~2小时，RNet 1小时 ONet 1.5小时。<br> 基于Pytorch这里只是训练O-net，其他两个网络的训练需要导入其他两个网络，并变动Mydataset返回的参数为img_data, cls, offset，且训练时不需要landmark_loss。<br> 代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> opt
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset
<span class="token keyword">import</span> os
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms


<span class="token keyword">class</span> <span class="token class-name">Mydataset</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>path <span class="token operator">=</span> path
        self<span class="token punctuation">.</span>dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"positive.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"negative.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"part.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        strs <span class="token operator">=</span> self<span class="token punctuation">.</span>dataset<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
        img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">,</span> strs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        cls <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        offset <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        land <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>strs<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
        img_data <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
        <span class="token keyword">return</span> img_data<span class="token punctuation">,</span> cls<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> land


<span class="token keyword">class</span> <span class="token class-name">ONet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ONet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pre_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 46*46*32</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 23*23*32</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 21*21*64</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 10*10*64</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> groups<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 8*8*64</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 4*4*64</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 3*3*128</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>prelu5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv6_1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv6_2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv6_3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>pre_layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>prelu5<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        cls <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv6_1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        offset <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6_2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        landmark <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6_3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> landmark


<span class="token keyword">class</span> <span class="token class-name">Trainer</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> net<span class="token punctuation">,</span> save_path<span class="token punctuation">,</span> dataset_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cpu'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>net <span class="token operator">=</span> net<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>save_path <span class="token operator">=</span> save_path
        self<span class="token punctuation">.</span>data_path <span class="token operator">=</span> dataset_path
        self<span class="token punctuation">.</span>cls_fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>offset_fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>opt <span class="token operator">=</span> opt<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'No parameters'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> stop_value<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_load <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>Mydataset<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_path<span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> e <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>img_data_<span class="token punctuation">,</span> cls_<span class="token punctuation">,</span> offset_<span class="token punctuation">,</span> landmark_<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>data_load<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token triple-quoted-string string">"""标签"""</span>
                img_data_ <span class="token operator">=</span> img_data_<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
                cls_ <span class="token operator">=</span> cls_<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
                offset_ <span class="token operator">=</span> offset_<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
                landmark_ <span class="token operator">=</span> landmark_<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
                <span class="token triple-quoted-string string">"""网络输出"""</span>
                x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> self<span class="token punctuation">.</span>net<span class="token punctuation">(</span>img_data_<span class="token punctuation">)</span>
                x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                y <span class="token operator">=</span> y<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
                z <span class="token operator">=</span> z<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
                <span class="token triple-quoted-string string">""" 分类损失"""</span>
                mask_cls <span class="token operator">=</span> torch<span class="token punctuation">.</span>lt<span class="token punctuation">(</span>cls_<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
                cls <span class="token operator">=</span> torch<span class="token punctuation">.</span>masked_select<span class="token punctuation">(</span>cls_<span class="token punctuation">,</span> mask_cls<span class="token punctuation">)</span>
                out_cls <span class="token operator">=</span> torch<span class="token punctuation">.</span>masked_select<span class="token punctuation">(</span>x<span class="token punctuation">,</span> mask_cls<span class="token punctuation">)</span>
                cls_loss <span class="token operator">=</span> self<span class="token punctuation">.</span>cls_fc<span class="token punctuation">(</span>out_cls<span class="token punctuation">,</span> cls<span class="token punctuation">)</span>
                <span class="token triple-quoted-string string">"""偏移损失"""</span>
                mask_off <span class="token operator">=</span> torch<span class="token punctuation">.</span>gt<span class="token punctuation">(</span>cls_<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                offset <span class="token operator">=</span> torch<span class="token punctuation">.</span>masked_select<span class="token punctuation">(</span>offset_<span class="token punctuation">,</span> mask_off<span class="token punctuation">)</span>
                out_offset <span class="token operator">=</span> torch<span class="token punctuation">.</span>masked_select<span class="token punctuation">(</span>y<span class="token punctuation">,</span> mask_off<span class="token punctuation">)</span>
                offset_loss <span class="token operator">=</span> self<span class="token punctuation">.</span>offset_fc<span class="token punctuation">(</span>out_offset<span class="token punctuation">,</span> offset<span class="token punctuation">)</span>
                <span class="token triple-quoted-string string">"""位置损失"""</span>
                mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>gt<span class="token punctuation">(</span>cls_<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                landmark <span class="token operator">=</span> torch<span class="token punctuation">.</span>masked_select<span class="token punctuation">(</span>landmark_<span class="token punctuation">,</span> mask<span class="token punctuation">)</span>
                out_landmark <span class="token operator">=</span> torch<span class="token punctuation">.</span>masked_select<span class="token punctuation">(</span>z<span class="token punctuation">,</span> mask<span class="token punctuation">)</span>
                landmark_loss <span class="token operator">=</span> self<span class="token punctuation">.</span>offset_fc<span class="token punctuation">(</span>out_landmark<span class="token punctuation">,</span> landmark<span class="token punctuation">)</span>
        
                loss <span class="token operator">=</span> cls_loss <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> offset_loss <span class="token operator">+</span> landmark_loss
                <span class="token comment"># loss = cls_loss + offset_loss </span>
                self<span class="token punctuation">.</span>opt<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
                loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>opt<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
                a <span class="token operator">=</span> cls_loss<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                b <span class="token operator">=</span> offset_loss<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                c <span class="token operator">=</span> landmark_loss<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># print(c)</span>
                loss2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> loss<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'e:{} i: {}  loss:{}/{}--cls损失：{}——偏移坐标损失：{}——5位置坐标损失:{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> i<span class="token punctuation">,</span> loss2<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment"># losses.append(loss)</span>
                <span class="token comment"># plt.clf()</span>
                <span class="token comment"># plt.plot(losses)</span>
                <span class="token comment"># plt.pause(0.01)</span>
                <span class="token keyword">if</span> e <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">and</span> i <span class="token operator">%</span> <span class="token number">500</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>save_path<span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Saved'</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> loss <span class="token operator">&lt;</span> stop_value<span class="token punctuation">:</span>
                    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>save_path<span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'保存模型参数成功'</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    net <span class="token operator">=</span> ONet<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t <span class="token operator">=</span> Trainer<span class="token punctuation">(</span>net<span class="token punctuation">,</span> <span class="token string">'./params/Onet_Landmark.pth'</span><span class="token punctuation">,</span> r<span class="token string">'C:\MTCNN_data\48'</span><span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token number">0.0005</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>五、侦测流程</strong><br> 自制侦测流程图：<br> <img src="https://images2.imgbox.com/cf/1b/aYxn6MyV_o.png" alt="侦测流程图"><br> 侦测中因为P网络输出的Box是经过图像金字塔和卷积池化后的偏移量，在我们进行NMS操作前，要经过坐标的反算来得到Box对应的原图上真正的坐标位置。<br> <img src="https://images2.imgbox.com/d1/3b/0FW45LlP_o.png" alt="坐标反算"><br> 侦测代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> time
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> MTCNN_last_version <span class="token keyword">import</span> Tools
<span class="token keyword">from</span> MTCNN_last_version<span class="token punctuation">.</span>Tools <span class="token keyword">import</span> convert_to_squre
<span class="token keyword">from</span> MTCNN_last_version<span class="token punctuation">.</span>Module <span class="token keyword">import</span> RNet<span class="token punctuation">,</span> PNet
<span class="token keyword">from</span> MTCNN_last_version<span class="token punctuation">.</span>Train_Onet_Landmark <span class="token keyword">import</span> ONet  <span class="token comment"># Landmark</span>
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> ImageDraw
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms


<span class="token keyword">class</span> <span class="token class-name">Detector</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pp<span class="token operator">=</span>r<span class="token string">'./params/Pnet2048.pth'</span><span class="token punctuation">,</span> rp<span class="token operator">=</span>r<span class="token string">'./params/Rnet.pth'</span><span class="token punctuation">,</span>
                 op<span class="token operator">=</span>r<span class="token string">'./params/Onet_Landmark.pth'</span><span class="token punctuation">,</span> isCuda<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>isCuda <span class="token operator">=</span> isCuda
        self<span class="token punctuation">.</span>pnet <span class="token operator">=</span> PNet<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rnet <span class="token operator">=</span> RNet<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>onet <span class="token operator">=</span> ONet<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>isCuda<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>pnet<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>rnet<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>onet<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>pnet<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rnet<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>onet<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>pnet<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>pp<span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rnet<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>rp<span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>onet<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>op<span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>__transfrom <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                               transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                                                    std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">detect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">:</span>
        empty <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        t1 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        p_boxes <span class="token operator">=</span> self<span class="token punctuation">.</span>__pnet_detect<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Pbox'</span><span class="token punctuation">,</span> p_boxes<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
        <span class="token keyword">if</span> p_boxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> empty
        t2 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        t_p <span class="token operator">=</span> t2 <span class="token operator">-</span> t1
        t3 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        r_boxes <span class="token operator">=</span> self<span class="token punctuation">.</span>__rnet_detect<span class="token punctuation">(</span>image<span class="token punctuation">,</span> p_boxes<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Rbox'</span><span class="token punctuation">,</span> r_boxes<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
        <span class="token keyword">if</span> r_boxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> empty
        t4 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        t_r <span class="token operator">=</span> t4 <span class="token operator">-</span> t3
        t5 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        o_boxes <span class="token operator">=</span> self<span class="token punctuation">.</span>__onet_detect<span class="token punctuation">(</span>image<span class="token punctuation">,</span> r_boxes<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Obox'</span><span class="token punctuation">,</span> o_boxes<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
        <span class="token keyword">if</span> o_boxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> empty
        t6 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        t_o <span class="token operator">=</span> t6 <span class="token operator">-</span> t5
        t_sum <span class="token operator">=</span> t_p <span class="token operator">+</span> t_r <span class="token operator">+</span> t_o
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'t_sum :{} t_p: {} t_r: {} t_o: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>t_sum<span class="token punctuation">,</span> t_p<span class="token punctuation">,</span> t_r<span class="token punctuation">,</span> t_o<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> o_boxes
    
    <span class="token keyword">def</span> <span class="token function">__pnet_detect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        img <span class="token operator">=</span> x
        w<span class="token punctuation">,</span> h <span class="token operator">=</span> img<span class="token punctuation">.</span>size
        min_side <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
        scale <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">while</span> min_side <span class="token operator">&gt;</span> <span class="token number">12</span><span class="token punctuation">:</span>
            img_data <span class="token operator">=</span> self<span class="token punctuation">.</span>__transfrom<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>isCuda<span class="token punctuation">:</span>
                img_data <span class="token operator">=</span> img_data<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            img_data<span class="token punctuation">.</span>unsqueeze_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            _cls<span class="token punctuation">,</span> _offset <span class="token operator">=</span> self<span class="token punctuation">.</span>pnet<span class="token punctuation">(</span>img_data<span class="token punctuation">)</span>
            cls<span class="token punctuation">,</span> offset <span class="token operator">=</span> _cls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> _offset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data
            <span class="token triple-quoted-string string">""" 优化使用切片提高速度"""</span>
            cls <span class="token operator">=</span> cls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
            offset <span class="token operator">=</span> offset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
            mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>gt<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">)</span>
            idxs <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>mask<span class="token punctuation">)</span>
            offset <span class="token operator">=</span> offset<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> idxs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> idxs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
            cls <span class="token operator">=</span> cls<span class="token punctuation">[</span>mask<span class="token punctuation">]</span>
            boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__box<span class="token punctuation">(</span>idxs<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> cls<span class="token punctuation">,</span> scale<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># indexes = torch.nonzero(torch.gt(cls, 0.75))</span>
            <span class="token comment"># for idx in indexes:</span>
            <span class="token comment">#     boxes.append(self.__box(idx, offset, cls[idx[0], idx[1]], scale))</span>
            scale <span class="token operator">*=</span> <span class="token number">0.709</span>
            _w <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>w <span class="token operator">*</span> scale<span class="token punctuation">)</span>
            _h <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> scale<span class="token punctuation">)</span>
            img <span class="token operator">=</span> img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>_w<span class="token punctuation">,</span> _h<span class="token punctuation">)</span><span class="token punctuation">)</span>
            min_side <span class="token operator">=</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>_w<span class="token punctuation">,</span> _h<span class="token punctuation">)</span>
        
        <span class="token comment"># return Tools.nms(np.array(boxes), thresh=0.3)</span>
        <span class="token keyword">return</span> Tools<span class="token punctuation">.</span>nms<span class="token punctuation">(</span>np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> thresh<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span>
        <span class="token comment"># return Tools.nms_(np.array(boxes), thresh=0.3)  # 返回：对图像中 H &lt; 50 及 inter面积 &lt; 5000的box进行侦测</span>
    
    <span class="token keyword">def</span> <span class="token function">__box</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> start_index<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> cls<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> side_len<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># _x1 = int(start_index[1] * stride) / scale  # 宽，W，x</span>
        <span class="token comment"># _y1 = int(start_index[0] * stride) / scale  # 高，H,y</span>
        <span class="token comment"># _x2 = int(start_index[1] * stride + side_len) / scale</span>
        <span class="token comment"># _y2 = int(start_index[0] * stride + side_len) / scale</span>
        <span class="token triple-quoted-string string">""" 优化使用切片提高速度"""</span>
        _x1 <span class="token operator">=</span> <span class="token punctuation">(</span>start_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> stride<span class="token punctuation">)</span> <span class="token operator">/</span> scale
        _y1 <span class="token operator">=</span> <span class="token punctuation">(</span>start_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> stride<span class="token punctuation">)</span> <span class="token operator">/</span> scale
        _x2 <span class="token operator">=</span> <span class="token punctuation">(</span>start_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> stride <span class="token operator">+</span> side_len<span class="token punctuation">)</span> <span class="token operator">/</span> scale
        _y2 <span class="token operator">=</span> <span class="token punctuation">(</span>start_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> stride <span class="token operator">+</span> side_len<span class="token punctuation">)</span> <span class="token operator">/</span> scale
        ow <span class="token operator">=</span> _x2 <span class="token operator">-</span> _x1  <span class="token comment"># 12</span>
        oh <span class="token operator">=</span> _y2 <span class="token operator">-</span> _y1
        <span class="token comment"># _offset = offset[:, start_index[0], start_index[1]]</span>
        <span class="token comment"># x1 = _x1 + ow * _offset[0]</span>
        <span class="token comment"># y1 = _y1 + oh * _offset[1]</span>
        <span class="token comment"># x2 = _x2 + ow * _offset[2]</span>
        <span class="token comment"># y2 = _y2 + oh * _offset[3]</span>
        x1 <span class="token operator">=</span> _x1 <span class="token operator">+</span> ow <span class="token operator">*</span> offset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        y1 <span class="token operator">=</span> _y1 <span class="token operator">+</span> oh <span class="token operator">*</span> offset<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        x2 <span class="token operator">=</span> _x2 <span class="token operator">+</span> ow <span class="token operator">*</span> offset<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        y2 <span class="token operator">=</span> _y2 <span class="token operator">+</span> oh <span class="token operator">*</span> offset<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
        <span class="token comment"># return [x1, y1, x2, y2, cls]</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> cls<span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__rnet_detect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        _img_dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        pnet_boxes <span class="token operator">=</span> convert_to_squre<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
        <span class="token keyword">for</span> _box <span class="token keyword">in</span> pnet_boxes<span class="token punctuation">:</span>
            _x1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            _y1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            _x2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            _y2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            
            img <span class="token operator">=</span> image<span class="token punctuation">.</span>crop<span class="token punctuation">(</span><span class="token punctuation">(</span>_x1<span class="token punctuation">,</span> _y1<span class="token punctuation">,</span> _x2<span class="token punctuation">,</span> _y2<span class="token punctuation">)</span><span class="token punctuation">)</span>
            img <span class="token operator">=</span> img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            img_data <span class="token operator">=</span> self<span class="token punctuation">.</span>__transfrom<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            _img_dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>img_data<span class="token punctuation">)</span>
        
        img_dataset <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>_img_dataset<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>isCuda<span class="token punctuation">:</span>
            img_dataset <span class="token operator">=</span> img_dataset<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
        _cls<span class="token punctuation">,</span> _offset <span class="token operator">=</span> self<span class="token punctuation">.</span>rnet<span class="token punctuation">(</span>img_dataset<span class="token punctuation">)</span>
        _cls <span class="token operator">=</span> _cls<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
        _cls <span class="token operator">=</span> _cls<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        offset <span class="token operator">=</span> _offset<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># indexes, _ = np.where(_cls &gt; 0.95)</span>
        idx<span class="token punctuation">,</span> _ <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>_cls <span class="token operator">&gt;</span> <span class="token number">0.95</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment"># for idx in indexes:</span>
        <span class="token comment">#     _box = pnet_boxes[idx]</span>
        <span class="token comment">#     _x1 = int(_box[0])</span>
        <span class="token comment">#     _y1 = int(_box[1])</span>
        <span class="token comment">#     _x2 = int(_box[2])</span>
        <span class="token comment">#     _y2 = int(_box[3])</span>
        _x1 <span class="token operator">=</span> <span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        _y1 <span class="token operator">=</span> <span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        _x2 <span class="token operator">=</span> <span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        _y2 <span class="token operator">=</span> <span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        ow <span class="token operator">=</span> _x2 <span class="token operator">-</span> _x1
        oh <span class="token operator">=</span> _y2 <span class="token operator">-</span> _y1

        x1 <span class="token operator">=</span> _x1 <span class="token operator">+</span> ow <span class="token operator">*</span> offset<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        y1 <span class="token operator">=</span> _y1 <span class="token operator">+</span> oh <span class="token operator">*</span> offset<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        x2 <span class="token operator">=</span> _x2 <span class="token operator">+</span> ow <span class="token operator">*</span> offset<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        y2 <span class="token operator">=</span> _y2 <span class="token operator">+</span> oh <span class="token operator">*</span> offset<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
        cls <span class="token operator">=</span> _cls<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        <span class="token comment"># boxes.append([x1, y1, x2, y2, cls])</span>
        a <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> cls<span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
        <span class="token comment"># return Tools.nms(np.array(boxes), 0.3)</span>

        <span class="token keyword">return</span> Tools<span class="token punctuation">.</span>nms<span class="token punctuation">(</span>np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">__onet_detect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">,</span> _rnet_box<span class="token punctuation">)</span><span class="token punctuation">:</span>
        _img_data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        rnet_box <span class="token operator">=</span> convert_to_squre<span class="token punctuation">(</span>_rnet_box<span class="token punctuation">)</span>
        <span class="token keyword">for</span> _box <span class="token keyword">in</span> rnet_box<span class="token punctuation">:</span>
            _x1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            _y1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            _x2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            _y2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            img <span class="token operator">=</span> image<span class="token punctuation">.</span>crop<span class="token punctuation">(</span><span class="token punctuation">(</span>_x1<span class="token punctuation">,</span> _y1<span class="token punctuation">,</span> _x2<span class="token punctuation">,</span> _y2<span class="token punctuation">)</span><span class="token punctuation">)</span>
            img <span class="token operator">=</span> img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            img_data <span class="token operator">=</span> self<span class="token punctuation">.</span>__transfrom<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            _img_data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>img_data<span class="token punctuation">)</span>
        
        img_dataset <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>_img_data<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>isCuda<span class="token punctuation">:</span>
            img_dataset <span class="token operator">=</span> img_dataset<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
        _cls<span class="token punctuation">,</span> _offset<span class="token punctuation">,</span> fll_ <span class="token operator">=</span> self<span class="token punctuation">.</span>onet<span class="token punctuation">(</span>img_dataset<span class="token punctuation">)</span>
        <span class="token comment"># _cls = _cls[:, 0]</span>
        <span class="token comment"># _offset_4 = _offset_4[:, :]</span>
        <span class="token comment"># _offset_10 = _offset_10[:, :]</span>
        _cls <span class="token operator">=</span> _cls<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        offset <span class="token operator">=</span> _offset<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        fll <span class="token operator">=</span> fll_<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># idxs = np.where(cls &gt; self.opt.o_cls)[0]</span>
        indexes<span class="token punctuation">,</span> _ <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>_cls <span class="token operator">&gt;</span> <span class="token number">0.95</span><span class="token punctuation">)</span>
        <span class="token comment"># _x1 = (_box[:, 0])</span>
        <span class="token comment"># _y1 = (_box[:, 1])</span>
        <span class="token comment"># _x2 = (_box[:, 2])</span>
        <span class="token comment"># _y2 = (_box[:, 3])</span>
        <span class="token keyword">for</span> idx <span class="token keyword">in</span> indexes<span class="token punctuation">:</span>
            _box <span class="token operator">=</span> rnet_box<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
            _x1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            _y1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            _x2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            _y2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>_box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            
            ow <span class="token operator">=</span> _x2 <span class="token operator">-</span> _x1
            oh <span class="token operator">=</span> _y2 <span class="token operator">-</span> _y1
            
            x1 <span class="token operator">=</span> _x1 <span class="token operator">+</span> ow <span class="token operator">*</span> offset<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            y1 <span class="token operator">=</span> _y1 <span class="token operator">+</span> oh <span class="token operator">*</span> offset<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            x2 <span class="token operator">=</span> _x2 <span class="token operator">+</span> ow <span class="token operator">*</span> offset<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
            y2 <span class="token operator">=</span> _y2 <span class="token operator">+</span> oh <span class="token operator">*</span> offset<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
            cls <span class="token operator">=</span> _cls<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            fllx1 <span class="token operator">=</span> _x1 <span class="token operator">+</span> ow <span class="token operator">*</span> fll<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            flly1 <span class="token operator">=</span> _y1 <span class="token operator">+</span> oh <span class="token operator">*</span> fll<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            fllx2 <span class="token operator">=</span> _x1 <span class="token operator">+</span> ow <span class="token operator">*</span> fll<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
            flly2 <span class="token operator">=</span> _y1 <span class="token operator">+</span> oh <span class="token operator">*</span> fll<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
            fllx3 <span class="token operator">=</span> _x1 <span class="token operator">+</span> ow <span class="token operator">*</span> fll<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
            flly3 <span class="token operator">=</span> _y1 <span class="token operator">+</span> oh <span class="token operator">*</span> fll<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
            fllx4 <span class="token operator">=</span> _x1 <span class="token operator">+</span> ow <span class="token operator">*</span> fll<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>
            flly4 <span class="token operator">=</span> _y1 <span class="token operator">+</span> oh <span class="token operator">*</span> fll<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>
            fllx5 <span class="token operator">=</span> _x1 <span class="token operator">+</span> ow <span class="token operator">*</span> fll<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>
            flly5 <span class="token operator">=</span> _y1 <span class="token operator">+</span> oh <span class="token operator">*</span> fll<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>
            boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> cls<span class="token punctuation">,</span> fllx1<span class="token punctuation">,</span> flly1<span class="token punctuation">,</span> fllx2<span class="token punctuation">,</span> flly2<span class="token punctuation">,</span> fllx3<span class="token punctuation">,</span> flly3<span class="token punctuation">,</span> fllx4<span class="token punctuation">,</span> flly4<span class="token punctuation">,</span> fllx5<span class="token punctuation">,</span> flly5<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> Tools<span class="token punctuation">.</span>nms<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> isMin<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    t01 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> grad<span class="token punctuation">:</span>
        image_file <span class="token operator">=</span> r<span class="token string">'C:\Projects\MTCNN_last_version\211.jpg'</span>
        detect <span class="token operator">=</span> Detector<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>image_file<span class="token punctuation">)</span> <span class="token keyword">as</span> img<span class="token punctuation">:</span>
            boxes <span class="token operator">=</span> detect<span class="token punctuation">.</span>detect<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>boxes<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
            imgDraw <span class="token operator">=</span> ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            <span class="token keyword">for</span> box <span class="token keyword">in</span> boxes<span class="token punctuation">:</span>
                x1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                y1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                x2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                y2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token triple-quoted-string string">'''5 - 14'''</span>
                fllx1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                flly1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                fllx2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                flly2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                fllx3 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                flly3 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                fllx4 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                flly4 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                fllx5 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                flly5 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                box2 <span class="token operator">=</span> <span class="token punctuation">[</span>fllx1<span class="token punctuation">,</span> flly1<span class="token punctuation">,</span> fllx2<span class="token punctuation">,</span> flly2<span class="token punctuation">,</span> fllx3<span class="token punctuation">,</span> flly3<span class="token punctuation">,</span> fllx4<span class="token punctuation">,</span> flly4<span class="token punctuation">,</span> fllx5<span class="token punctuation">,</span> flly5<span class="token punctuation">]</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    imgDraw<span class="token punctuation">.</span>chord<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>start<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token number">360</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> fill<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">)</span>
                imgDraw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token operator">-</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fill<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">)</span>
                imgDraw<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">)</span><span class="token punctuation">,</span> outline<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
            t02 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>t02 <span class="token operator">-</span> t01<span class="token punctuation">)</span>
            img<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>网络改进：</strong><br> <strong>1、for循环的改进</strong></p> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">""" 优化使用切片提高速度"""</span>
            cls <span class="token operator">=</span> cls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
            offset <span class="token operator">=</span> offset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
            mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>gt<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">)</span>
            idxs <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>mask<span class="token punctuation">)</span>
            offset <span class="token operator">=</span> offset<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> idxs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> idxs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
            cls <span class="token operator">=</span> cls<span class="token punctuation">[</span>mask<span class="token punctuation">]</span>
</code></pre> 
<p><strong>2、深度可分离卷积结构（Depthwise separable convolution）</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">RNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pre_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 22*22*28</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 11*11*28</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>groups<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 9*9*48</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 4*4*48</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 3*3*64</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>prelu4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv5_1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv5_2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>pre_layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>prelu4<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        cls <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv5_1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        offset <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5_2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">,</span> offset
</code></pre> 
<p>附件上传一份自己做的PPT。<br> MTCNN真的不难，只是过程太繁琐，很难一下理清楚。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/db24b8b3dcf56039cc6d9970cb6a9c86/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">与BSN的链码进行通信互动</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3abf4fbaf2dd4e02fcedf562c3f8ff8c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数据预处理Part4——数据离散化</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>