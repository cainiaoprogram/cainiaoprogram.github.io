<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>微信、QQOAuth 2.0前后端登录代码 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="微信、QQOAuth 2.0前后端登录代码" />
<meta property="og:description" content="由于不同的第三方平台的授权方式不同，包括授权的端点、授权的参数等等，因此，下面我们提供了分别用于QQ、微信、钉钉OAuth 2.0的前端和后端代码。
首先是QQ OAuth 2.0的前端代码，它使用QQ提供的connect.qq.com授权端点进行授权，并处理授权的回调：
&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset=&#34;utf-8&#34;&gt; &lt;title&gt;QQ OAuth 2.0&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;h1&gt;QQ OAuth 2.0&lt;/h1&gt; &lt;script src=&#34;https://open.mobile.qq.com/sdk/qqapi.js?_bid=152&#34;&gt;&lt;/script&gt; &lt;script&gt; var appId = &#39;YOUR_APP_ID_HERE&#39;, redirectUri = encodeURIComponent(&#39;http://localhost:8080/oauth/callback/qq&#39;), scope = &#39;get_user_info&#39;; qq.login(function(res) { if (res.errMsg == &#39;login:ok&#39;) { var access_token = res.access_token, expires_in = res.expires_in, openid = res.openid; // Send OAuth login data to server-side var xhr = new XMLHttpRequest(); xhr.open(&#39;POST&#39;, &#39;http://localhost:8080/oauth2/callback&#39;, true); xhr.setRequestHeader(&#39;Content-type&#39;, &#39;application/x-www-form-urlencoded&#39;); xhr.onreadystatechange = function() { if (this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2392fbe693be6e396cec1eb58b8bf09e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-14T17:45:00+08:00" />
<meta property="article:modified_time" content="2023-04-14T17:45:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">微信、QQOAuth 2.0前后端登录代码</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>由于不同的第三方平台的授权方式不同，包括授权的端点、授权的参数等等，因此，下面我们提供了分别用于QQ、微信、钉钉OAuth 2.0的前端和后端代码。</p> 
<p>首先是QQ OAuth 2.0的前端代码，它使用QQ提供的<code>connect.qq.com</code>授权端点进行授权，并处理授权的回调：</p> 
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;QQ OAuth 2.0&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;h1&gt;QQ OAuth 2.0&lt;/h1&gt;

&lt;script src="https://open.mobile.qq.com/sdk/qqapi.js?_bid=152"&gt;&lt;/script&gt;

&lt;script&gt;
    var appId = 'YOUR_APP_ID_HERE',
        redirectUri = encodeURIComponent('http://localhost:8080/oauth/callback/qq'),
        scope = 'get_user_info';

    qq.login(function(res) {
        if (res.errMsg == 'login:ok') {
            var access_token = res.access_token,
                expires_in = res.expires_in,
                openid = res.openid;

            // Send OAuth login data to server-side
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'http://localhost:8080/oauth2/callback', true);
            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 &amp;&amp; this.status == 200) {
                    // Handle successful login
                    window.location.href = "/";
                }
            };
            xhr.send('provider=qq&amp;access_token=' + access_token + '&amp;expires_in=' + expires_in + '&amp;openid=' + openid);
        }
    }, {
        clientId: appId,
        scope: scope,
        redirectURI: redirectUri
    });
&lt;/script&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre> 
<p>接下来是QQ OAuth 2.0的后端代码，它将处理来自QQ的OAuth回调，并从回调中提取访问令牌等数据：</p> 
<pre><code>import java.io.IOException;
import java.util.Properties;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.NameValuePair;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClientBuilder;
import org.apache.http.message.BasicNameValuePair;
import org.json.JSONException;
import org.json.JSONObject;

public class QQOAuth2CallbackServlet extends HttpServlet {

    private static final String CALLBACK_PATH = "/oauth/callback/qq";
    private static final String AUTHORIZATION_ENDPOINT = "https://graph.qq.com/oauth2.0/authorize";
    private static final String TOKEN_ENDPOINT = "https://graph.qq.com/oauth2.0/token";
    private static final String USERINFO_ENDPOINT = "https://graph.qq.com/user/get_user_info";

    private static final String APP_ID = "YOUR_APP_ID_HERE";
    private static final String APP_KEY = "YOUR_APP_KEY_HERE";
    private static final String REDIRECT_URI = "http://localhost:8080/oauth/callback/qq";

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String code = req.getParameter("code");
        String state = req.getParameter("state");

        String access_token = "";
        String openid = "";

        String token_url = TOKEN_ENDPOINT + "?grant_type=authorization_code&amp;client_id="
                + APP_ID + "&amp;client_secret=" + APP_KEY + "&amp;code=" + code + "&amp;redirect_uri="
                + REDIRECT_URI;

        CloseableHttpClient httpclient = HttpClientBuilder.create().build();
        HttpPost httpPost = new HttpPost(token_url);

        HttpResponse response = httpclient.execute(httpPost);
        HttpEntity entity = response.getEntity();

        if (entity != null) {
            String content = EntityUtils.toString(entity);
            String[] items = content.split("&amp;");
            for (String item : items) {
                if (item.startsWith("access_token=")) {
                    access_token = item.substring(13);
                } else if (item.startsWith("expires_in=")) {
                    // 这个令牌将在多少秒后过期
                    int expiresIn = Integer.parseInt(item.substring(11));
                } else if (item.startsWith("refresh_token=")) {
                    // 如果支持刷新令牌，那么这里将包含一个用于获取新访问令牌的令牌
                    String refresh_token = item.substring(14);
                }
            }
        }

        // 使用令牌请求QQ的OpenID
        CloseableHttpClient httpclient2 = HttpClientBuilder.create().build();
        HttpPost httpPost2 = new HttpPost(
                "https://graph.qq.com/oauth2.0/me?access_token=" + access_token);

        HttpResponse response2 = httpclient2.execute(httpPost2);
        HttpEntity entity2 = response2.getEntity();

        if (entity2 != null) {
            String content = EntityUtils.toString(entity2);
            content = content.replace("callback( ", "");
            content = content.replace(" );", "");

            JSONObject json = new JSONObject(content);
            openid = json.getString("openid");
        }

        // 使用QQ的 openid 获取用户信息
        CloseableHttpClient httpclient3 = HttpClientBuilder.create().build();
        HttpPost httpPost3 = new HttpPost(USERINFO_ENDPOINT + "?access_token=" + access_token
                + "&amp;oauth_consumer_key=" + APP_ID + "&amp;openid=" + openid);

        HttpResponse response3 = httpclient3.execute(httpPost3);
        HttpEntity entity3 = response3.getEntity();

        if (entity3 != null) {
            String content = EntityUtils.toString(entity3);
            JSONObject json = new JSONObject(content);

            String nickname = json.getString("nickname");
            String gender = json.getString("gender");
            String avatar = json.getString("figureurl_qq_2");
            int province = json.getInt("province");
            int city = json.getInt("city");

            // do something with user info
        }

        // redirect user to homepage after successful authentication
        resp.sendRedirect("/");
    }
}
</code></pre> 
<p>下面是微信OAuth 2.0的前端代码，它使用微信提供的<code>open.weixin.qq.com</code>授权端点进行授权，并处理授权的回调：</p> 
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;WeChat OAuth 2.0&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;h1&gt;WeChat OAuth 2.0&lt;/h1&gt;

&lt;script src="//res.wx.qq.com/connect/sdk/jsfile/sdk/versions/version1.6.0/mmversion.js"&gt;&lt;/script&gt;

&lt;script&gt;
    var appId = 'YOUR_APP_ID_HERE',
        redirectUri = encodeURIComponent('http://localhost:8080/oauth/callback/weixin'),
        scope = 'snsapi_login';

    document.addEventListener("WeixinJSBridgeReady", function () {
        WeixinJSBridge.invoke('getLoginStatus', {}, function (res) {
            if (res.err_msg == "login:ok") {
                var code = res.code;

                // Send OAuth login data to server-side
                var xhr = new XMLHttpRequest();
                xhr.open('POST', 'http://localhost:8080/oauth2/callback', true);
                xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr.onreadystatechange = function() {
                    if (this.readyState == 4 &amp;&amp; this.status == 200) {
                        // Handle successful login
                        window.location.href = "/";
                    }
                };
                xhr.send('provider=weixin&amp;code=' + code);
            } else {
                WeixinJSBridge.invoke('authorize', {
                    scope: scope,
                    state: 'wx_login'
                }, function(res) {});
            }
        });
    }, false);
&lt;/script&gt;

&lt;/body</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fc47bb0c9fd766dc0e1ddd445610e9f7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">什么是 BitB 网络钓鱼攻击？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0ddc726d450b226ddd426c76766fc9d4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">解决vue3&#43;vite跨域失败问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>