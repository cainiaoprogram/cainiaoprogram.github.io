<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Sentinel 流量治理组件教程 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Sentinel 流量治理组件教程" />
<meta property="og:description" content="前言 官网首页：home | Sentinel (sentinelguard.io)
随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 是面向分布式、多语言异构化服务架构的流量治理组件，主要以流量为切入点，从流量路由、流量控制、流量整形、熔断降级、系统自适应过载保护、热点流量防护等多个维度来帮助开发者保障微服务的稳定性。
基本概念 资源 资源是 Sentinel 的关键概念。它可以是 Java 应用程序中的任何内容，例如，由应用程序提供的服务，或由应用程序调用的其它应用提供的服务，甚至可以是一段代码。在接下来的文档中，我们都会用资源来描述代码块。
只要通过 Sentinel API 定义的代码，就是资源，能够被 Sentinel 保护起来。大部分情况下，可以使用方法签名，URL，甚至服务名称作为资源名来标示资源。
规则 围绕资源的实时状态设定的规则，可以包括流量控制规则、熔断降级规则以及系统保护规则。所有规则可以动态实时调整。
功能和设计理念 流量控制 流量控制在网络传输中是一个常用的概念，它用于调整网络包的发送数据。然而，从系统稳定性角度考虑，在处理请求的速度上，也有非常多的讲究。任意时间到来的请求往往是随机不可控的，而系统的处理能力是有限的。我们需要根据系统的处理能力对流量进行控制。Sentinel 作为一个调配器，可以根据需要把随机的请求调整成合适的形状，如下图所示：
流量控制有以下几个角度:
资源的调用关系，例如资源的调用链路，资源和资源之间的关系；运行指标，例如 QPS、线程池、系统负载等；控制的效果，例如直接限流、冷启动、排队等。 Sentinel 的设计理念是让您自由选择控制的角度，并进行灵活组合，从而达到想要的效果。
熔断降级 除了流量控制以外，降低调用链路中的不稳定资源也是 Sentinel 的使命之一。由于调用关系的复杂性，如果调用链路中的某个资源出现了不稳定，最终会导致请求发生堆积。这个问题和 Hystrix 里面描述的问题是一样的。
Sentinel 和 Hystrix 的原则是一致的: 当调用链路中某个资源出现不稳定，例如，表现为 timeout，异常比例升高的时候，则对这个资源的调用进行限制，并让请求快速失败，避免影响到其它的资源，最终产生雪崩的效果。
系统负载保护 Sentinel 同时提供系统维度的自适应保护能力。防止雪崩，是系统防护中重要的一环。当系统负载较高的时候，如果还持续让请求进入，可能会导致系统崩溃，无法响应。在集群环境下，网络负载均衡会把本应这台机器承载的流量转发到其它的机器上去。如果这个时候其它的机器也处在一个边缘状态的时候，这个增加的流量就会导致这台机器也崩溃，最后导致整个集群不可用。
针对这个情况，Sentinel 提供了对应的保护机制，让系统的入口流量和系统的负载达到一个平衡，保证系统在能力范围之内处理最多的请求。
快速开始 Sentinel 是分为两个部分
控制台（Dashboard）：控制台主要负责管理推送规则、监控、集群限流分配管理、机器发现等。核心库（Java 客户端）：不依赖任何框架/库，能够运行于 Java 7 及以上的版本的运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。 控制台 在这里我们看下控制台的使用
首先获取控制台 jar 包：Release v1.8.6 · alibaba/Sentinel (github." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3ebc52386c3d0e6f18726fa09a024b84/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-21T11:40:19+08:00" />
<meta property="article:modified_time" content="2023-12-21T11:40:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Sentinel 流量治理组件教程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_2"></a>前言</h3> 
<p><img src="https://images2.imgbox.com/02/e5/UeOmDkqB_o.png" alt="image.png"></p> 
<p>官网首页：<a href="https://sentinelguard.io/zh-cn/index.html" rel="nofollow">home | Sentinel (sentinelguard.io)</a></p> 
<p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 是面向分布式、多语言异构化服务架构的流量治理组件，主要以流量为切入点，从流量路由、流量控制、流量整形、熔断降级、系统自适应过载保护、热点流量防护等多个维度来帮助开发者保障微服务的稳定性。</p> 
<h3><a id="_11"></a>基本概念</h3> 
<h4><a id="_13"></a>资源</h4> 
<p>资源是 Sentinel 的关键概念。它可以是 Java 应用程序中的任何内容，例如，由应用程序提供的服务，或由应用程序调用的其它应用提供的服务，甚至可以是一段代码。在接下来的文档中，我们都会用资源来描述代码块。</p> 
<p>只要通过 Sentinel API 定义的代码，就是资源，能够被 Sentinel 保护起来。大部分情况下，可以使用方法签名，URL，甚至服务名称作为资源名来标示资源。</p> 
<h4><a id="_19"></a>规则</h4> 
<p>围绕资源的实时状态设定的规则，可以包括流量控制规则、熔断降级规则以及系统保护规则。所有规则可以动态实时调整。</p> 
<h3><a id="_23"></a>功能和设计理念</h3> 
<h4><a id="_25"></a>流量控制</h4> 
<p>流量控制在网络传输中是一个常用的概念，它用于调整网络包的发送数据。然而，从系统稳定性角度考虑，在处理请求的速度上，也有非常多的讲究。任意时间到来的请求往往是随机不可控的，而系统的处理能力是有限的。我们需要根据系统的处理能力对流量进行控制。Sentinel 作为一个调配器，可以根据需要把随机的请求调整成合适的形状，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/cd/0f/LG1ZWkDz_o.png" alt="image.png"></p> 
<p>流量控制有以下几个角度:</p> 
<ul><li>资源的调用关系，例如资源的调用链路，资源和资源之间的关系；</li><li>运行指标，例如 QPS、线程池、系统负载等；</li><li>控制的效果，例如直接限流、冷启动、排队等。</li></ul> 
<p>Sentinel 的设计理念是让您自由选择控制的角度，并进行灵活组合，从而达到想要的效果。</p> 
<h4><a id="_40"></a>熔断降级</h4> 
<p>除了流量控制以外，降低调用链路中的不稳定资源也是 Sentinel 的使命之一。由于调用关系的复杂性，如果调用链路中的某个资源出现了不稳定，最终会导致请求发生堆积。这个问题和 <a href="https://github.com/Netflix/Hystrix/wiki#what-problem-does-hystrix-solve">Hystrix</a> 里面描述的问题是一样的。</p> 
<p><img src="https://images2.imgbox.com/3d/02/rbKL1Mkl_o.png" alt="image.png"></p> 
<p>Sentinel 和 Hystrix 的原则是一致的: 当调用链路中某个资源出现不稳定，例如，表现为 timeout，异常比例升高的时候，则对这个资源的调用进行限制，并让请求快速失败，避免影响到其它的资源，最终产生雪崩的效果。</p> 
<h4><a id="_48"></a>系统负载保护</h4> 
<p>Sentinel 同时提供<a href="https://sentinelguard.io/zh-cn/docs/system-adaptive-protection.html" rel="nofollow">系统维度的自适应保护能力</a>。防止雪崩，是系统防护中重要的一环。当系统负载较高的时候，如果还持续让请求进入，可能会导致系统崩溃，无法响应。在集群环境下，网络负载均衡会把本应这台机器承载的流量转发到其它的机器上去。如果这个时候其它的机器也处在一个边缘状态的时候，这个增加的流量就会导致这台机器也崩溃，最后导致整个集群不可用。</p> 
<p>针对这个情况，Sentinel 提供了对应的保护机制，让系统的入口流量和系统的负载达到一个平衡，保证系统在能力范围之内处理最多的请求。</p> 
<h3><a id="_55"></a>快速开始</h3> 
<p>Sentinel 是分为两个部分</p> 
<ul><li>控制台（Dashboard）：控制台主要负责管理推送规则、监控、集群限流分配管理、机器发现等。</li><li>核心库（Java 客户端）：不依赖任何框架/库，能够运行于 Java 7 及以上的版本的运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。</li></ul> 
<h4><a id="_63"></a>控制台</h4> 
<p>在这里我们看下控制台的使用</p> 
<p>首先获取控制台 jar 包：<a href="https://github.com/alibaba/Sentinel/releases/tag/1.8.6">Release v1.8.6 · alibaba/Sentinel (github.com)</a></p> 
<pre><code class="prism language-bash"><span class="token function">java</span>  <span class="token parameter variable">-server</span> <span class="token parameter variable">-Xms64m</span> <span class="token parameter variable">-Xmx256m</span>  <span class="token parameter variable">-Dserver.port</span><span class="token operator">=</span><span class="token number">8849</span> <span class="token parameter variable">-Dcsp.sentinel.dashboard.server</span><span class="token operator">=</span>localhost:8849 <span class="token parameter variable">-Dproject.name</span><span class="token operator">=</span>sentinel-dashboard <span class="token parameter variable">-jar</span> /root/dev/sentinel/sentinel-dashboard-1.8.6.jar
</code></pre> 
<p>上述命令中我们指定几个 JVM 参数</p> 
<p><code>-Dserver.port=8849</code>: 通过Java系统属性设置应用程序的端口号为8849。这意味着应用程序将在8849端口上监听传入的网络请求</p> 
<p><code>-Dcsp.sentinel.dashboard.server=localhost:8849</code>: 通过Java系统属性设置Sentinel控制台的服务器地址为localhost:8849。这是为了告诉Sentinel控制台与当前应用程序实例通信的地址</p> 
<p>Sentinel 客户端的端口也可以通过启动参数 <code>-Dcsp.sentinel.api.port</code> 进行配置（不指定默认是 <strong>8719</strong>）</p> 
<p>从 Sentinel 1.6.0 起，Sentinel 控制台引入基本的<strong>登录</strong>功能，默认用户名和密码都是 <code>sentinel</code>。可以参考 <a href="https://github.com/alibaba/Sentinel/wiki/%E6%8E%A7%E5%88%B6%E5%8F%B0#%E9%89%B4%E6%9D%83">鉴权模块文档</a> 配置用户名和密码（<code>-Dsentinel.dashboard.auth.username</code> 和 <code>-Dsentinel.dashboard.auth.password</code>）</p> 
<p><img src="https://images2.imgbox.com/08/18/behkBFJk_o.png" alt="image.png"></p> 
<blockquote> 
 <p>注：上面我使用的是 linux 启动 sentinel，但是下面为了操作方便均在 windows 上演示</p> 
</blockquote> 
<p>为了使得客户端接入控制台，需要：</p> 
<ul><li>客户端需要引入 Transport 模块来与 Sentinel 控制台进行通信。您可以通过 <code>pom.xml</code> 引入 JAR 包</li></ul> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-transport-simple-http<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.8.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ul><li>启动时加入 JVM 参数 <code>-Dcsp.sentinel.dashboard.server=consoleIp:port</code> 指定控制台地址和端口 （前面已经指定）。更多的参数参见 <a href="https://sentinelguard.io/zh-cn/docs/startup-configuration.html" rel="nofollow">启动参数文档</a>。</li><li>确保应用端有访问量</li></ul> 
<p>Sentinel 可以简单的分为 Sentinel 核心库和 Dashboard。核心库不依赖 Dashboard，但是结合<br> Dashboard 可以取得最好的效果。<br> 使用 Sentinel 来进行熔断保护，主要分为几个步骤:</p> 
<blockquote> 
 <p>注：若您的应用为 Spring Boot 或 Spring Cloud 应用，您可以通过 Spring 配置文件来指定配置，详情请参考 <a href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba/wiki/Sentinel">Spring Cloud Alibaba Sentinel 文档</a></p> 
</blockquote> 
<h4><a id="_109"></a>定义资源</h4> 
<p><strong>资源</strong>是 Sentinel 的关键概念。它可以是 Java 应用程序中的任何内容，例如，由应用程序提供的服务，或由应用程序调用的其它应用提供的服务，RPC 接口方法，甚至可以是一段代码。</p> 
<p>只要通过 Sentinel API 定义的代码，就是资源，能够被 Sentinel 保护起来。大部分情况下，可以使用方法签名，URL，甚至服务名称作为资源名来标示资源。</p> 
<p>把需要控制流量的代码用 Sentinel的关键代码 SphU.entry(“资源名”) 和 entry.exit() 包围起来即可。</p> 
<p>导入依赖</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starter-alibaba-sentinel --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2022.0.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre> 
<p>配置 application.yml</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8849</span>   <span class="token comment">#sentinel控制台的请求地址</span>
</code></pre> 
<p>@SentinelResource 注解</p> 
<blockquote> 
 <p>注意：注解方式埋点不支持 private 方法。</p> 
</blockquote> 
<p><code>@SentinelResource</code> 用于定义资源，并提供可选的异常处理和 fallback 配置项。 <code>@SentinelResource</code> 注解包含以下属性：</p> 
<ul><li>value：资源名称，必需项（不能为空）</li><li>entryType：entry 类型，可选项（默认为 EntryType.OUT）</li><li>blockHandler / blockHandlerClass</li></ul> 
<h4><a id="_150"></a>定义规则</h4> 
<p>规则主要有流控规则、 熔断降级规则、系统规则、权限规则、热点参数规则等</p> 
<p>硬编码方式定义系统规则</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initSystemRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SystemRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SystemRule</span> rule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rule<span class="token punctuation">.</span><span class="token function">setHighestSystemLoad</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SystemRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>加载不同规则</p> 
<pre><code class="prism language-java"><span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span></span> rules<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修改流控规则</span>
<span class="token class-name">DegradeRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRule</span><span class="token punctuation">&gt;</span></span> rules<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修改降级规则</span>
<span class="token class-name">SystemRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SystemRule</span><span class="token punctuation">&gt;</span></span> rules<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修改系统规则</span>
<span class="token class-name">AuthorityRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthorityRule</span><span class="token punctuation">&gt;</span></span> rules<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修改授权规则</span>
</code></pre> 
<p>官方 demo：<a href="https://github.com/alibaba/Sentinel/tree/master/sentinel-demo">Sentinel/sentinel-demo at master · alibaba/Sentinel (github.com)</a></p> 
<p>基础示例 <a href="https://github.com/alibaba/Sentinel/tree/master/sentinel-demo/sentinel-demo-basic">demo</a></p> 
<h3><a id="_181"></a>熔断降级</h3> 
<p>在 sentinel 中熔断策略分为慢调用比例 (<code>SLOW_REQUEST_RATIO</code>)，异常比例 (<code>ERROR_RATIO</code>)，异常数 (<code>ERROR_COUNT</code>)</p> 
<p>异常降级<strong>仅针对业务异常</strong>，对 Sentinel 限流降级本身的异常（<code>BlockException</code>）不生效</p> 
<p>Sentinel 提供以下几种熔断策略</p> 
<ul><li>慢调用比例 (<code>SLOW_REQUEST_RATIO</code>)：选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。</li><li>异常比例 (<code>ERROR_RATIO</code>)：当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是 <code>[0.0, 1.0]</code>，代表 0% - 100%。</li><li>异常数 (<code>ERROR_COUNT</code>)：当单位统计时长内的异常数目超过阈值之后会自动进行熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。</li></ul> 
<p>慢调用比例熔断 <a href="https://github.com/alibaba/Sentinel/blob/master/sentinel-demo/sentinel-demo-basic/src/main/java/com/alibaba/csp/sentinel/demo/degrade/SlowRatioCircuitBreakerDemo.java">demo</a></p> 
<h3><a id="_196"></a>具体应用</h3> 
<p>下面将会在 springboot 中使用配置文件配置规则</p> 
<p>application. yml 配置流控和降级规则文件位置</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  
  <span class="token key atrule">application</span><span class="token punctuation">:</span>  
    <span class="token key atrule">name</span><span class="token punctuation">:</span> lin<span class="token punctuation">-</span>cms<span class="token punctuation">-</span>spring<span class="token punctuation">-</span>boot  
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>  
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>  
      <span class="token key atrule">datasource</span><span class="token punctuation">:</span>  
        <span class="token key atrule">ds1</span><span class="token punctuation">:</span>  
          <span class="token key atrule">file</span><span class="token punctuation">:</span>  
            <span class="token key atrule">data-type</span><span class="token punctuation">:</span> json  
            <span class="token key atrule">file</span><span class="token punctuation">:</span> <span class="token string">'classpath: flowrule.json'</span>  
            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> flow  
        <span class="token key atrule">ds2</span><span class="token punctuation">:</span>  
          <span class="token key atrule">file</span><span class="token punctuation">:</span>  
            <span class="token key atrule">data-type</span><span class="token punctuation">:</span> json  
            <span class="token key atrule">file</span><span class="token punctuation">:</span> <span class="token string">'classpath: degraderule.json'</span>  
            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> degrade  
      <span class="token comment"># 立即加载  </span>
      <span class="token key atrule">eager</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>  
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8849</span>   <span class="token comment">#sentinel控制台的请求地址</span>
</code></pre> 
<p>然后配置规则</p> 
<p>flowrule.json</p> 
<pre><code class="prism language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"resource"</span><span class="token operator">:</span> <span class="token string">"getBook"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"controlBehavior"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"count"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token string-property property">"grade"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"limitApp"</span><span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"strategy"</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>degraderule.json</p> 
<pre><code class="prism language-json"><span class="token punctuation">[</span>  
  <span class="token punctuation">{<!-- --></span>  
    <span class="token string-property property">"resource"</span><span class="token operator">:</span> <span class="token string">"getBooks"</span><span class="token punctuation">,</span>  
    <span class="token string-property property">"limitApp"</span><span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>  
    <span class="token string-property property">"grade"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>  
    <span class="token string-property property">"count"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>  
    <span class="token string-property property">"slowRatioThreshold"</span><span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>  
    <span class="token string-property property">"minRequestAmount"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>  
    <span class="token string-property property">"statIntervalMs"</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>  
    <span class="token string-property property">"timeWindow"</span><span class="token operator">:</span> <span class="token number">10</span>  
  <span class="token punctuation">}</span>  
<span class="token punctuation">]</span>
</code></pre> 
<p>具体规则及参数说明请看[该文档](<a href="https://sentinelguard.io/zh-cn/docs/circuit-breaking.html" rel="nofollow">circuit-breaking | Sentinel (sentinelguard.io)</a>)</p> 
<p>参数对应常量值可以参考 RuleConstant，该类位于 com.alibaba.csp.sentinel.slots.block</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">RuleConstant</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">FLOW_GRADE_THREAD</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//限流 基于线程数 </span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">FLOW_GRADE_QPS</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//限流 基于QPS</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEGRADE_GRADE_RT</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//降级 代表一秒内该资源的平均响应时间 </span>
    <span class="token comment">/**
     * Degrade by biz exception ratio in the current {@link IntervalProperty#INTERVAL} second(s).
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEGRADE_GRADE_EXCEPTION_RATIO</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 降级 异常比例</span>
    <span class="token comment">/**
     * Degrade by biz exception count in the last 60 seconds.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEGRADE_GRADE_EXCEPTION_COUNT</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">// 降级， 异常数</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">AUTHORITY_WHITE</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 认证， 白名单</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">AUTHORITY_BLACK</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 认证， 黑名单</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STRATEGY_DIRECT</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 根据调用方限流策略</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STRATEGY_RELATE</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 关联流量限流策略</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STRATEGY_CHAIN</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 根据调用链入口限流策略</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CONTROL_BEHAVIOR_DEFAULT</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 限流行为，直接拒绝</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CONTROL_BEHAVIOR_WARM_UP</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 限流行为，WARM_UP </span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CONTROL_BEHAVIOR_RATE_LIMITER</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">// 限流行为，匀速排队</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CONTROL_BEHAVIOR_WARM_UP_RATE_LIMITER</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">LIMIT_APP_DEFAULT</span> <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">LIMIT_APP_OTHER</span> <span class="token operator">=</span> <span class="token string">"other"</span><span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_SAMPLE_COUNT</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_WINDOW_INTERVAL_MS</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
 
    <span class="token keyword">private</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后使用 Apifox 或是 JMeter 进行流控测试，可以看到 QPS 流控生效</p> 
<p><img src="https://images2.imgbox.com/db/39/jvQguYnN_o.png" alt="image.png"></p> 
<p>直接测试熔断接口可能不会有直观的结果，接口上设置线程休眠 <code>Thread.sleep(50)</code> 效果更加直观</p> 
<p><a href="https://sentinelguard.io/zh-cn/docs/system-adaptive-protection.html" rel="nofollow">系统保护规则</a>、<a href="https://sentinelguard.io/zh-cn/docs/parameter-flow-control.html" rel="nofollow">热点限流规则</a>、<a href="https://sentinelguard.io/zh-cn/docs/origin-authority-control.html" rel="nofollow">黑白名单规则</a></p> 
<h3><a id="_311"></a>参考链接</h3> 
<ul><li><a href="https://www.cnblogs.com/crazymakercircle/p/14285001.html#autoid-h3-2-5-0" rel="nofollow">sentinel （史上最全+入门教程）- 疯狂创客圈</a></li><li><a href="https://developer.aliyun.com/article/783342" rel="nofollow">超详细的Sentinel入门-阿里云开发者社区 (aliyun.com)</a></li><li><a href="https://github.com/alibaba/Sentinel/tree/master/sentinel-dashboard">Sentinel/sentinel-dashboard at master </a></li><li><a href="https://blog.csdn.net/u013792404/article/details/101287064">Sentinel使用配置文件配置限流规则</a></li><li><a href="https://apifox.com/apiskills/postman-pressure-testing-guide/?utm_source=google_dsa&amp;utm_medium=g&amp;utm_campaign=20543997484&amp;utm_content=156047449829&amp;utm_term=&amp;gad_source=1&amp;gclid=CjwKCAiAvoqsBhB9EiwA9XTWGdIF2sOrkUAXbm7BHYddB9_TeuhDMR4TMGC8cF1Zh9bZ-XJ5frXdpRoC4tIQAvD_BwE" rel="nofollow">Postman 压测指南：让 API 性能测试变得简单易行 (apifox.com)</a></li><li><a href="https://apifox.com/apiskills/postman-jmeter-stresstest/" rel="nofollow">Postman压测和JMeter压测的区别 (apifox.com)</a></li></ul> 
<blockquote> 
 <p>本文由博客一文多发平台 <a href="https://openwrite.cn?from=article_bottom" rel="nofollow">OpenWrite</a> 发布！</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2bb82404118d2d9cdfdd860ff57e0874/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">前端实现文件下载(a标签文件下载</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/10f798caf58704c83cdee8412873387d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">git stash 用法总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>