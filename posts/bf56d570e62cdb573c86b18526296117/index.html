<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>websocket - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="websocket" />
<meta property="og:description" content="文章目录 什么是websocket？HTTP与WebSocket的关系快速入门SpringBoot&#43;WebSocket 实时监控异常消息 什么是websocket？ WebSocket 协议是基于 TCP 的一种新的网络协议。它实现了客户端与服务器之间的全双工通信，既然是全双工，就说明了服务器可以主动发送信息给客户端。
为什么不使用 HTTP 协议呢？
这是因为HTTP是单工通信，通信只能由客户端发起，客户端请求一下，服务器处理一下,于是 websocket 应运而生。
WebSocket 相比普通的 Socket 来说，仅仅是借助 HTTP 协议完成握手，创建连接。后续的所有通信，都和 HTTP 协议无关。
HTTP与WebSocket的关系 结论：
WebSocket和HTTP都是基于TCP协议的两个不同的协议WebSocket依赖于HTTP连接 问题：
WebSocket依赖于HTTP连接，那么它如何从连接的HTTP协议转化为WebSocket协议？WebSocket为什么要依赖于HTTP协议的连接？ 每个WebSocket连接都始于一个HTTP请求。
具体来说，WebSocket协议在第一次握手连接时，通过HTTP协议在传送WebSocket支持的版本号，协议的字版本号，原始地址，主机地址等等一些列字段给服务器端：
GET /chat HTTP/1.1 Host: server.example.com Upgrade: websocket Connection: Upgrade Sec-WebSocket-Key:dGhlIHNhbXBsZSBub25jZQ== Origin: http://example.com Sec-WebSocket-Version: 13 注意，关键的地方是，这里面有个Upgrade首部，用来把当前的HTTP请求升级到WebSocket协议，这是HTTP协议本身的内容，是为了扩展支持其他的通讯协议。
如果服务器支持新的协议，则必须返回101：
HTTP/1.1 101 Switching Protocols Upgrade: websocket Connection: Upgrade Sec-WebSocket-Accept:s3pPLMBiTxaQ9kYGzzhZRbK&#43;xOo= 至此，HTTP请求物尽其用，如果成功触发onopen事件，否则触发onerror事件，后面的传输则不再依赖HTTP协议。
快速入门 1、 在 pom.xml 文件中，引入相关依赖。
&lt;dependencies&gt; &lt;!-- 实现对 WebSocket 相关依赖的引入，方便~ --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-websocket&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/bf56d570e62cdb573c86b18526296117/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-16T15:53:51+08:00" />
<meta property="article:modified_time" content="2022-04-16T15:53:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">websocket</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#websocket_1" rel="nofollow">什么是websocket？</a></li><li><a href="#HTTPWebSocket_14" rel="nofollow">HTTP与WebSocket的关系</a></li><li><a href="#_51" rel="nofollow">快速入门</a></li><li><a href="#SpringBootWebSocket__135" rel="nofollow">SpringBoot+WebSocket 实时监控异常</a></li><li><a href="#_354" rel="nofollow">消息</a></li></ul> 
</div> 
<p></p> 
<h2><a id="websocket_1"></a>什么是websocket？</h2> 
<ul><li>WebSocket 协议是基于 TCP 的一种新的网络协议。</li><li>它实现了客户端与服务器之间的<strong>全双工通信</strong>，既然是全双工，就说明了<strong>服务器可以主动发送信息给客户端</strong>。<br> <img src="https://images2.imgbox.com/9f/d2/DQTBWDpQ_o.png" alt="在这里插入图片描述"></li></ul> 
<p>为什么不使用 HTTP 协议呢？</p> 
<p>这是因为HTTP是单工通信，通信只能由客户端发起，客户端请求一下，服务器处理一下,于是 websocket 应运而生。<br> <img src="https://images2.imgbox.com/3d/5a/YQ2TDbE8_o.png" alt="在这里插入图片描述"></p> 
<p>WebSocket 相比普通的 Socket 来说，<font color="red">仅仅是借助 HTTP 协议完成握手，创建连接。后续的所有通信，都和 HTTP 协议无关。</font></p> 
<h2><a id="HTTPWebSocket_14"></a>HTTP与WebSocket的关系</h2> 
<blockquote> 
 <p>结论：</p> 
</blockquote> 
<ol><li>WebSocket和HTTP都是基于<strong>TCP</strong>协议的两个不同的协议</li><li><strong>WebSocket依赖于HTTP连接</strong></li></ol> 
<blockquote> 
 <p>问题：</p> 
</blockquote> 
<ol><li>WebSocket依赖于HTTP连接，那么它如何从连接的HTTP协议转化为WebSocket协议？</li><li>WebSocket为什么要依赖于HTTP协议的连接？</li></ol> 
<p>每个WebSocket连接都始于一个HTTP请求。</p> 
<p>具体来说，<strong>WebSocket协议在第一次握手连接时，通过HTTP协议在传送WebSocket支持的版本号</strong>，协议的字版本号，原始地址，主机地址等等一些列字段给服务器端：</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>chat <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
Host<span class="token operator">:</span> server<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com
Upgrade<span class="token operator">:</span> websocket
Connection<span class="token operator">:</span> Upgrade
Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Key<span class="token operator">:</span>dGhlIHNhbXBsZSBub25jZQ<span class="token operator">==</span>
Origin<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com
Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Version<span class="token operator">:</span> <span class="token number">13</span>
</code></pre> 
<p>注意，关键的地方是，这里面有个<code>Upgrade</code>首部，用来<strong>把当前的HTTP请求升级到WebSocket协议</strong>，<strong>这是HTTP协议本身的内容，是为了扩展支持其他的通讯协议。</strong></p> 
<p>如果服务器支持新的协议，则必须返回101：</p> 
<pre><code class="prism language-json"><span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">101</span> Switching Protocols
Upgrade<span class="token operator">:</span> websocket
Connection<span class="token operator">:</span> Upgrade
Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Accept<span class="token operator">:</span>s3pPLMBiTxaQ9kYGzzhZRbK<span class="token operator">+</span>xOo<span class="token operator">=</span>
</code></pre> 
<p><strong>至此，HTTP请求物尽其用，如果成功触发onopen事件，否则触发onerror事件，后面的传输则不再依赖HTTP协议。</strong></p> 
<h2><a id="_51"></a>快速入门</h2> 
<p>1、 在 pom.xml 文件中，引入相关依赖。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 实现对 WebSocket 相关依赖的引入，方便~ --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-websocket<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- 引入 Fastjson ，实现对 JSON 的序列化，因为后续我们会使用它解析消息 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.62<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>2、 创建 WebsocketServerEndpoint 类，定义 Websocket 服务的端点（EndPoint）。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@ServerEndpoint</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebsocketServerEndpoint</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@OnOpen</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onOpen</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token class-name">EndpointConfig</span> config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[onOpen][session({}) 接入]"</span><span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@OnMessage</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[onOpen][session({}) 接收到一条消息({})]"</span><span class="token punctuation">,</span> session<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生产环境下，请设置成 debug 级别</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@OnClose</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClose</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token class-name">CloseReason</span> closeReason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[onClose][session({}) 连接关闭。关闭原因是({})}]"</span><span class="token punctuation">,</span> session<span class="token punctuation">,</span> closeReason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@OnError</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[onClose][session({}) 发生异常]"</span><span class="token punctuation">,</span> session<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<ul><li>在类上，添加 <code>@Controller</code>注解，保证创建一个 <code>WebsocketServerEndpoint Bean</code> 。</li><li>在类上，添加 JSR-356 定义的 <code>@ServerEndpoint</code> 注解，标记这是一个 <code>WebSocket EndPoint</code> ，路径为<code>/</code>。</li><li><code>WebSocket</code> 一共有四个事件，分别对应使用 JSR-356 定义的<code>@OnOpen</code>、<code>@OnMessage</code>、<code>@OnClose</code>、<code>@OnError</code>注解。</li></ul> 
<p>3、创建 WebsocketServerEndpoint 配置类</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token comment">// @EnableWebSocket // 无需添加该注解，因为我们并不是使用 Spring WebSocket</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketConfiguration</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ServerEndpointExporter</span> <span class="token function">serverEndpointExporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServerEndpointExporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>该 Bean 的作用，是扫描添加有 @ServerEndpoint 注解的 Bean 。</strong></p> 
<p>4、创建 Application.java 类，配置 @SpringBootApplication 注解即可</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试 WebSocket 连接,使用 <a href="http://www.easyswoole.com/wstool.html" rel="nofollow"> WEBSOCKET 在线测试工具</a><br> <img src="https://images2.imgbox.com/a9/8e/hlA6q9Hc_o.png" alt="在这里插入图片描述"><br> 查看一下控制台：<br> <img src="https://images2.imgbox.com/a0/4c/h8CzicJp_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="SpringBootWebSocket__135"></a>SpringBoot+WebSocket 实时监控异常</h2> 
<p>首先熟悉下Demo的结构，构建一个spring boot项目：<br> <img src="https://images2.imgbox.com/ee/aa/GnXDc40M_o.png" alt="在这里插入图片描述"></p> 
<p>1、导依赖</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 实现对 WebSocket 相关依赖的引入，方便~ --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-websocket<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.6.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 引入 Fastjson ，实现对 JSON 的序列化，因为后续我们会使用它解析消息 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.62<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>2、WebSocketConfig配置类</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>server<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">ServerEndpointExporter</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 启用spring boot 对WebSocket的支持,</span>
    <span class="token comment">// 注入一个ServerEndpointExporter,该Bean会自动注册使用@ServerEndpoint注解申明的websocket endpoint【扫描添加有 @ServerEndpoint 注解的 Bean】</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ServerEndpointExporter</span> <span class="token function">serverEndpointExporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServerEndpointExporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p><strong>@ServerEndpoint</strong>。这个注解告诉容器给定的类应该被认为是一个 WebSocket 端点。必需value元素指定<br> <strong>WebSocket 端点的路径</strong></p> 
 <p>@ServerEndpoint 注解这是一个类层次的注解，它的功能主要是<strong>将目前的类定义成一个 websocket<br> 服务器端。注解的值将被用于监听用户连接的终端访问 URL 地址，客户端可以通过这个 URL 来连接到 WebSocket 服务器端</strong></p> 
</blockquote> 
<p>3、WebSocketServer类，用来进行服务端和客户端之间的交互</p> 
<pre><code class="prism language-bash"><span class="token function">import</span> lombok.extern.slf4j.Slf4j<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.stereotype.Component<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.stereotype.Service<span class="token punctuation">;</span>
<span class="token function">import</span> javax.websocket.*<span class="token punctuation">;</span>
<span class="token function">import</span> javax.websocket.server.PathParam<span class="token punctuation">;</span>
<span class="token function">import</span> javax.websocket.server.ServerEndpoint<span class="token punctuation">;</span>
<span class="token function">import</span> java.io.IOException<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.concurrent.CopyOnWriteArraySet<span class="token punctuation">;</span>
@Component
@Slf4j
@Service
@ServerEndpoint<span class="token punctuation">(</span><span class="token string">"/api/websocket/{sid}"</span><span class="token punctuation">)</span>
public class WebSocketServer <span class="token punctuation">{<!-- --></span>
    //当前在线连接数
    private static int onlineCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    //存放每个客户端对应的MyWebSocket对象
    private static CopyOnWriteArraySet<span class="token operator">&lt;</span>WebSocketServer<span class="token operator">&gt;</span> webSocketSet <span class="token operator">=</span> new CopyOnWriteArraySet<span class="token operator">&lt;</span>WebSocketServer<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    private Session session<span class="token punctuation">;</span>
    //接收sid
    private String sid <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

    /**
     * 连接建立成功调用的方法
     */
    @OnOpen
    public void onOpen<span class="token punctuation">(</span>Session session, @PathParam<span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span> String sid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        this.session <span class="token operator">=</span> session<span class="token punctuation">;</span>
        webSocketSet.add<span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>     //加入set中
        this.sid <span class="token operator">=</span> sid<span class="token punctuation">;</span>
        addOnlineCount<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           //在线数加1
        try <span class="token punctuation">{<!-- --></span>
            sendMessage<span class="token punctuation">(</span><span class="token string">"conn_success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log.info<span class="token punctuation">(</span><span class="token string">"有新窗口开始监听:"</span> + sid + <span class="token string">",当前在线人数为:"</span> + getOnlineCount<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log.error<span class="token punctuation">(</span><span class="token string">"websocket IO Exception"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    /**
     * 连接关闭调用的方法
     */
    @OnClose
    public void <span class="token function-name function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        webSocketSet.remove<span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>  //从set中删除
        subOnlineCount<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           //在线数减1
        log.info<span class="token punctuation">(</span><span class="token string">"释放的sid为："</span>+sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log.info<span class="token punctuation">(</span><span class="token string">"有一连接关闭！当前在线人数为"</span> + getOnlineCount<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    /**
     * 收到客户端消息后调用的方法
     * @ Param message 客户端发送过来的消息
     */
    @OnMessage
    public void onMessage<span class="token punctuation">(</span>String message, Session session<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log.info<span class="token punctuation">(</span><span class="token string">"收到来自窗口"</span> + sid + <span class="token string">"的信息:"</span> + message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        //群发消息
        <span class="token keyword">for</span> <span class="token punctuation">(</span>WebSocketServer item <span class="token builtin class-name">:</span> webSocketSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            try <span class="token punctuation">{<!-- --></span>
                item.sendMessage<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    /**
     * @ Param session
     * @ Param error
     */
    @OnError
    public void onError<span class="token punctuation">(</span>Session session, Throwable error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log.error<span class="token punctuation">(</span><span class="token string">"发生错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        error.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    /**
     * 实现服务器主动推送
     */
    public void sendMessage<span class="token punctuation">(</span>String message<span class="token punctuation">)</span> throws IOException <span class="token punctuation">{<!-- --></span>
        this.session.getBasicRemote<span class="token punctuation">(</span><span class="token punctuation">)</span>.sendText<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    /**
     * 群发自定义消息
     */
    public static void sendInfo<span class="token punctuation">(</span>String message, @PathParam<span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span> String sid<span class="token punctuation">)</span> throws IOException <span class="token punctuation">{<!-- --></span>
        log.info<span class="token punctuation">(</span><span class="token string">"推送消息到窗口"</span> + sid + <span class="token string">"，推送内容:"</span> + message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>WebSocketServer item <span class="token builtin class-name">:</span> webSocketSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            try <span class="token punctuation">{<!-- --></span>
                //为null则全部推送
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sid <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
//                    item.sendMessage<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item.sid.equals<span class="token punctuation">(</span>sid<span class="token punctuation">))</span> <span class="token punctuation">{<!-- --></span>
                    item.sendMessage<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    public static synchronized int <span class="token function-name function">getOnlineCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">return</span> onlineCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    public static synchronized void <span class="token function-name function">addOnlineCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        WebSocketServer.onlineCount++<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    public static synchronized void <span class="token function-name function">subOnlineCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        WebSocketServer.onlineCount--<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    public static CopyOnWriteArraySet<span class="token operator">&lt;</span>WebSocketServer<span class="token operator">&gt;</span> <span class="token function-name function">getWebSocketSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">return</span> webSocketSet<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>4、WebSocketController类，用于进行接口测试</p> 
<pre><code class="prism language-bash"><span class="token function">import</span> org.springframework.stereotype.Controller<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.web.bind.annotation.GetMapping<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.web.bind.annotation.PathVariable<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.web.bind.annotation.RequestMapping<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.web.bind.annotation.ResponseBody<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.web.servlet.ModelAndView<span class="token punctuation">;</span>
<span class="token function">import</span> java.io.IOException<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.HashMap<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.Map<span class="token punctuation">;</span>
@Controller<span class="token punctuation">(</span><span class="token string">"web_Scoket_system"</span><span class="token punctuation">)</span>
@RequestMapping<span class="token punctuation">(</span><span class="token string">"/api/socket"</span><span class="token punctuation">)</span>
public class SystemController <span class="token punctuation">{<!-- --></span>
    //页面请求
    @GetMapping<span class="token punctuation">(</span><span class="token string">"/index/{userId}"</span><span class="token punctuation">)</span>
    public ModelAndView socket<span class="token punctuation">(</span>@PathVariable String userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ModelAndView mav <span class="token operator">=</span> new ModelAndView<span class="token punctuation">(</span><span class="token string">"/socket1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mav.addObject<span class="token punctuation">(</span><span class="token string">"userId"</span>, userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin class-name">return</span> mav<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    //推送数据接口
    @ResponseBody
    @RequestMapping<span class="token punctuation">(</span><span class="token string">"/socket/push/{cid}"</span><span class="token punctuation">)</span>
    public Map pushToWeb<span class="token punctuation">(</span>@PathVariable String cid, String message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Map<span class="token operator">&lt;</span>String,Object<span class="token operator">&gt;</span> result <span class="token operator">=</span> new HashMap<span class="token operator">&lt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        try <span class="token punctuation">{<!-- --></span>
            WebSocketServer.sendInfo<span class="token punctuation">(</span>message, cid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            result.put<span class="token punctuation">(</span><span class="token string">"code"</span>, cid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            result.put<span class="token punctuation">(</span><span class="token string">"msg"</span>, message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token builtin class-name">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>5、配置application.yml</p> 
<pre><code class="prism language-yaml"><span class="token comment">#端口</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">18801</span>
 
<span class="token comment">#密码，因为接口不需要权限，所以加了个密码做校验</span>
<span class="token key atrule">mySocket</span><span class="token punctuation">:</span>
  <span class="token key atrule">myPwd</span><span class="token punctuation">:</span> jae_123
</code></pre> 
<p>6、测试</p> 
<ul><li>打开前端页面，进行WebSocket连接<br> 控制台输出，连接成功<img src="https://images2.imgbox.com/34/a4/FVkecRFV_o.png" alt="在这里插入图片描述"></li><li>因为是模拟数据，所以全部显示正常，没有异常提交时的页面呈现</li></ul> 
<p><img src="https://images2.imgbox.com/03/67/jVPqyyWe_o.png" alt=""></p> 
<ul><li>接下来，我们用接口测试工具Postman提交一个异常</li></ul> 
<p><img src="https://images2.imgbox.com/5c/69/gklQ5raA_o.png" alt=""></p> 
<p><strong>注意id为3的这个数据的状态变化</strong><br> <img src="https://images2.imgbox.com/c4/2d/2mMDll38_o.png" alt=""></p> 
<h2><a id="_354"></a>消息</h2> 
<p>在 HTTP 协议中，是基于 <strong>Request/Response</strong> 请求响应的<strong>同步</strong>模型，进行交互。在 <code>Websocket</code>协议中，是基于<code>Message</code> 消息的<strong>异步</strong>模型，进行交互。</p> 
<p>因为 WebSocket 协议，不像 HTTP 协议有 URI 可以区分不同的 API 请求操作，所以我们需要在 WebSocket 的 Message 里，增加能够标识消息类型，这里我们采用 <strong>type</strong> 字段。</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    type<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token comment">// 消息类型</span>
    body<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token comment">// 消息体</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>type 字段，消息类型。通过该字段，我们知道使用哪个 MessageHandler 消息处理器。</li><li>body 字段，消息体。不同的消息类型，会有不同的消息体。</li><li>Message 采用 JSON 格式编码，主要考虑便捷性</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6929dc1cbc5e16832ad3df0146717ebf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【系统分析师之路】如何备考系统分析师与架构师（软件水平考试）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f3f69602bd30f4818fe062cdad2e22d2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">idea中依赖找不到，例如dependency ‘mysql-connector-java‘not found</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>