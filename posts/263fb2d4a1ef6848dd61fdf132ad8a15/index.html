<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>postgresql 日志配置 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="postgresql 日志配置" />
<meta property="og:description" content="PostgreSQL有3种日志，分别是pg_log（数据库运行日志）、pg_xlog（WAL 日志，即重做日志）、pg_clog（事务提交日志，记录的是事务的元数据） pg_log默认是关闭的，需要设置参数启用此日志。pg_xlog和pg_clog都是强制打开的，无法关闭。 1.启用pg_log并配置日志参数 log_destination = &#39;csvlog&#39; logging_collector = on log_directory = &#39;pg_log&#39; log_filename = &#39;postgresql-%Y-%m-%d_%H%M%S.log&#39; log_rotation_age = 1d log_rotation_size = 100MB log_min_messages = info # 记录执行慢的SQL log_min_duration_statement = 60 log_checkpoints = on log_connections = on log_disconnections = on log_duration = on log_line_prefix = &#39;%m&#39; # 监控数据库中长时间的锁 log_lock_waits = on # 记录DDL操作 log_statement = &#39;ddl&#39; 2.重启PostgreSQL即可在$PGDATA/pg_log/ 下看到新生成的日志。 pg_ctl restart -m fast
--日志文件目录 日志的目录可以通过参数 log_directory 来设置，下面是我的参数设置。
log_directory = &#39;/var/applog/pg_log&#39; [postgres@pg_log]$ ll /var/applog/pg_log -rw------- 1 postgres postgres 4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/263fb2d4a1ef6848dd61fdf132ad8a15/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-08-13T18:17:47+08:00" />
<meta property="article:modified_time" content="2015-08-13T18:17:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">postgresql 日志配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    PostgreSQL有3种日志，分别是pg_log（数据库运行日志）、pg_xlog（WAL 日志，即重做日志）、pg_clog（事务提交日志，记录的是事务的元数据） 
<br> 
<br> 
<br> pg_log默认是关闭的，需要设置参数启用此日志。pg_xlog和pg_clog都是强制打开的，无法关闭。 
<br> 
<br> 
<br> 
<br> 
<br> 
<br> 
<br> 1.启用pg_log并配置日志参数 
<br> log_destination = 'csvlog' 
<br> logging_collector = on 
<br> log_directory = 'pg_log' 
<br> log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' 
<br> log_rotation_age = 1d 
<br> log_rotation_size = 100MB 
<br> log_min_messages = info 
<br> # 记录执行慢的SQL 
<br> log_min_duration_statement = 60 
<br> log_checkpoints = on 
<br> log_connections = on 
<br> log_disconnections = on 
<br> log_duration = on 
<br> log_line_prefix = '%m' 
<br> # 监控数据库中长时间的锁 
<br> log_lock_waits = on 
<br> # 记录DDL操作 
<br> log_statement = 'ddl' 
<br> 
<br> 
<br> 2.重启PostgreSQL即可在$PGDATA/pg_log/ 下看到新生成的日志。 
<br> 
<p>pg_ctl restart -m fast</p> 
<p><br> </p> 
<p></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Arial; font-size:14px; line-height:26px"> <strong><span style="color:rgb(0,0,255)">--日志文件目录   <br> </span></strong>   日志的目录可以通过参数  log_directory 来设置，下面是我的参数设置。<br>    log_directory = '/var/applog/pg_log'  <br>     <br> [postgres@pg_log]$ ll /var/applog/pg_log    <br> -rw------- 1 postgres postgres 4.8M Mar 14 23:57 postgresql-2011-03-14_000000.csv<br> -rw------- 1 postgres postgres    0 Mar 14 00:00 postgresql-2011-03-14_000000.log<br> -rw------- 1 postgres postgres 294K Mar 15 15:10 postgresql-2011-03-15_000000.csv<br> -rw------- 1 postgres postgres    0 Mar 15 00:00 postgresql-2011-03-15_000000.log</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Arial; font-size:14px; line-height:26px"> <span style="color:rgb(0,0,255)"><strong>--CSV日志文件内容<br> </strong></span>2011-03-15 00:07:03.513 CST,"wapportal","wapportal_216",4137,"172.16.3.43:59356",4d7e361f.1029,3,"idle",2011-03-14 23:37:03 CST,,0,LOG,00000,"disconnection: session time: 0:30:00.086 user=wapportal database=wapportal_216 host=172.16.3.43 port=59356",,,,,,,,,""<br> 2011-03-15 00:07:03.514 CST,,,5173,"",4d7e3d27.1435,1,"",2011-03-15 00:07:03 CST,,0,LOG,00000,"connection received: host=172.16.3.43 port=51135",,,,,,,,,""</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Arial; font-size:14px; line-height:26px">    上面两条是 postgresql-2011-03-15_000000.csv 日志文件的部分内容 ,由于日志文件的可读性<br>  较差，于是可以通过下面方法将CSV日志导入到数据库表里。详细如下</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Arial; font-size:14px; line-height:26px">  <br> <span style="color:rgb(0,0,255); font-size:14px"><strong>将CSV日志导入数据库表里   <br> </strong></span><span style="color:rgb(0,0,255)"><strong>1--调整参数<br> </strong></span>log_destination = 'csvlog'<br> logging_collector = on</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Arial; font-size:14px; line-height:26px">     这两个参数修改后，PG SERVER 需要重启。</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Arial; font-size:14px; line-height:26px"> <strong><span style="color:rgb(0,0,255)">2--创建日志记录表<br> </span></strong>CREATE TABLE postgres_log<br> (<br>   log_time timestamp(3) with time zone,<br>   user_name text,<br>   database_name text,<br>   process_id integer,<br>   connection_from text,<br>   session_id text,<br>   session_line_num bigint,<br>   command_tag text,<br>   session_start_time timestamp with time zone,<br>   virtual_transaction_id text,<br>   transaction_id bigint,<br>   error_severity text,<br>   sql_state_code text,<br>   message text,<br>   detail text,<br>   hint text,<br>   internal_query text,<br>   internal_query_pos integer,<br>   context text,<br>   query text,<br>   query_pos integer,<br>   location text,<br>   application_name text,<br>   PRIMARY KEY (session_id, session_line_num)<br> );</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Arial; font-size:14px; line-height:26px"> NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "postgres_log_pkey" for table "postgres_log"<br> CREATE TABLE;</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Arial; font-size:14px; line-height:26px">     备注：创建日志表 postgres_log 用来保存 CSV日志数据。</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Arial; font-size:14px; line-height:26px"> <strong><span style="color:rgb(0,0,255)">3--导入操作系统 csv 日志到表 postgres_log 表<br> </span></strong>skytf=# copy skytf.postgres_log from '/var/applog/pg_log/postgresql-2011-03-14_000000.csv' with csv;<br> COPY 26031</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Arial; font-size:14px; line-height:26px"> skytf=# copy skytf.postgres_log from '/var/applog/pg_log/postgresql-2011-03-15_000000.csv' with csv;<br> COPY 1297</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Arial; font-size:14px; line-height:26px">       备注：文件形式导入导出数据需要以超级用户 postgres 连接到目标库。</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Arial; font-size:14px; line-height:26px"> <strong><span style="color:rgb(0,0,255)">4--常用日志分析sql<br> </span></strong>skytf=# select min(log_time),max(log_time) from skytf.postgres_log;<br>             min             |            max             <br> ----------------------------+----------------------------<br>  2011-03-14 14:04:07.275+08 | 2011-03-16 05:04:34.427+08<br> (1 row)</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Arial; font-size:14px; line-height:26px"> skytf=&gt; select log_time,database_name,user_name,application_name,message from postgres_log where message like '%duration%';<br>           log_time          | database_name | user_name | application_name |                                                    mess<br> age                                                    <br> ----------------------------+---------------+-----------+------------------+--------------------------------------------------------<br> -------------------------------------------------------<br>  2011-03-15 00:23:38.957+08 | db_lbs        | lbs       |                  | duration: 1297.440 ms  execute &lt;unnamed&gt;:    SELECT cit<br> yname,province,the_geom as the_geom FROM china_city   <br> .......<br>     <br>        为了显示方便，上面只取一条记录。</p> 
<br>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/55308bdc8558ed4f59a134ae54f48cfc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">java中构造方法私有化</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dd093f02a85ce5623ccd33800cc4eaef/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">免费升级win10专业版正式版之路</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>