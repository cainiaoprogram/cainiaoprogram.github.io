<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring Security Auth/Acl 实践指南 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Spring Security Auth/Acl 实践指南" />
<meta property="og:description" content="导语 本文旨在使用简单的业务场景，重点介绍 Spring Security Authentication/Authorization 和 Spring Security Acl 实践过程的关键知识点，并给出相应的代码和配置示例，主要包含以下三个部分：
Web Api Authentication/AuthorizationMethod Authentication/AuthorizationAcl 完整的示例位于 example/spring-security 中，仓库地址：https://github.com/njdi/example.git。
Web Api Authentication/Authorization 假设有三个接口：
/web/guest：任意用户可访问；/web/user：访问时需要提供用户名和密码，且访问用户必须拥有角色 USER；/web/admin：访问时需要提供用户名和密码，且访问用户必须拥有角色 ADMIN； 其中，用户名和密码就是 Authentication（认证），拥有指定角色就是 Authorization（鉴权）。
示例接口 添加 Maven 依赖 spring-security/pom.xml
&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt; &lt;/dependency&gt; https://github.com/njdi/example/blob/main/pom.xml
https://github.com/njdi/example/blob/main/spring-security/pom.xml
实现接口 Main
package io.njdi.example.spring.security; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; @SpringBootApplication public class Main { public static void main(String[] args) { SpringApplication.run(Main.class, args); } } https://github.com/njdi/example/blob/main/spring-security/src/main/java/io/njdi/example/spring/security/Main.java
WebController
package io.njdi.example.spring.security.controller; import org." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d7ae68cfcc93240f9855ba4f2e79cdc0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-14T19:58:16+08:00" />
<meta property="article:modified_time" content="2022-02-14T19:58:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring Security Auth/Acl 实践指南</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>导语</h2> 
<p>本文旨在使用简单的业务场景，重点介绍 Spring Security Authentication/Authorization 和 Spring Security Acl 实践过程的关键知识点，并给出相应的代码和配置示例，主要包含以下三个部分：</p> 
<ul><li>Web Api Authentication/Authorization</li><li>Method Authentication/Authorization</li><li>Acl</li></ul> 
<blockquote> 
 <p>完整的示例位于 example/spring-security 中，仓库地址：https://github.com/njdi/example.git。</p> 
</blockquote> 
<h2><a id="Web_Api_AuthenticationAuthorization_10"></a>Web Api Authentication/Authorization</h2> 
<p>假设有三个接口：</p> 
<ul><li>/web/guest：任意用户可访问；</li><li>/web/user：访问时需要提供用户名和密码，且访问用户必须拥有角色 USER；</li><li>/web/admin：访问时需要提供用户名和密码，且访问用户必须拥有角色 ADMIN；</li></ul> 
<p>其中，用户名和密码就是 Authentication（认证），拥有指定角色就是 Authorization（鉴权）。</p> 
<h3><a id="_20"></a>示例接口</h3> 
<h4><a id="_Maven__22"></a>添加 Maven 依赖</h4> 
<p><strong>spring-security/pom.xml</strong></p> 
<pre><code class="prism language-text">    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt;
    &lt;/dependency&gt;
</code></pre> 
<blockquote> 
 <p>https://github.com/njdi/example/blob/main/pom.xml<br> https://github.com/njdi/example/blob/main/spring-security/pom.xml</p> 
</blockquote> 
<h4><a id="_41"></a>实现接口</h4> 
<p><strong>Main</strong></p> 
<pre><code class="prism language-text">package io.njdi.example.spring.security;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class Main {
  public static void main(String[] args) {
    SpringApplication.run(Main.class, args);
  }
}

</code></pre> 
<blockquote> 
 <p>https://github.com/njdi/example/blob/main/spring-security/src/main/java/io/njdi/example/spring/security/Main.java</p> 
</blockquote> 
<p><strong>WebController</strong></p> 
<pre><code class="prism language-text">package io.njdi.example.spring.security.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/web")
public class WebController {
  @GetMapping("/guest")
  public String helloGuest() {
    return "hello guest";
  }

  @GetMapping("/user")
  public String helloUser() {
    return "hello user";
  }

  @GetMapping("/admin")
  public String helloAdmin() {
    return "hello admin";
  }
}
</code></pre> 
<blockquote> 
 <p>https://github.com/njdi/example/blob/main/spring-security/src/main/java/io/njdi/example/spring/security/controller/WebController.java</p> 
</blockquote> 
<h4><a id="_93"></a>访问接口</h4> 
<p><strong>编译</strong></p> 
<pre><code class="prism language-text">cd example/spring-security

mvn clean package -Dmaven.test.skip=true
</code></pre> 
<p><strong>启动应用</strong></p> 
<pre><code class="prism language-text">java -cp spring-security/target/example-spring-security-0.1.jar:spring-security/target/example-spring-security-0.1-lib/* io.njdi.example.spring.security.Main
</code></pre> 
<p><strong>访问接口</strong></p> 
<pre><code class="prism language-text">curl http://localhost:8080/web/guest
curl http://localhost:8080/web/user
curl http://localhost:8080/web/admin
</code></pre> 
<blockquote> 
 <p>目前接口无任何认证/鉴权机制，均可正常访问且返回结果：hello guest、hello user 和 hello admin。</p> 
</blockquote> 
<h3><a id="_119"></a>认证/鉴权</h3> 
<h4><a id="_121"></a>配置认证/鉴权</h4> 
<h5><a id="_Maven__123"></a>添加 Maven 依赖</h5> 
<p><strong>spring-security/pom.xml</strong></p> 
<pre><code class="prism language-text">    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;mysql&lt;/groupId&gt;
      &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
    &lt;/dependency&gt;
</code></pre> 
<blockquote> 
 <p>用户名、密码和角色信息的存储机制有多种实现方式，可参考：https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/storage.html。</p> 
</blockquote> 
<blockquote> 
 <p>本文使用数据库（<strong>MySQL</strong>），需要添加 jdbc 和 mysql 相关依赖。</p> 
</blockquote> 
<h5><a id="_148"></a>创建数据库/数据表</h5> 
<p>假设数据库名称：spring_security，创建数据表：</p> 
<pre><code class="prism language-text">create table users(
    username varchar(50) not null primary key,
    password varchar(500) not null,
    enabled boolean not null
);

create table authorities (
    username varchar(50) not null,
    authority varchar(50) not null,
    constraint fk_authorities_users foreign key(username) references users(username)
);

create unique index ix_auth_username on authorities (username,authority);
</code></pre> 
<blockquote> 
 <p>数据表创建语句可参考：https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/jdbc.html#servlet-authentication-jdbc-schema-user。</p> 
</blockquote> 
<blockquote> 
 <p>数据库使用 <strong>MySQL</strong> 时，数据表创建语句需要进行调整，可参考：https://github.com/njdi/example/blob/main/spring-security/sql/auth.sql。</p> 
</blockquote> 
<h5><a id="_172"></a>配置数据源</h5> 
<p><strong>spring-security/application.yml</strong></p> 
<pre><code class="prism language-text">spring:
  datasource:
    url: jdbc:mysql://mysql_dev:13306/spring_security?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true
    username: spring_security
    password: spring_security
    hikari:
      keepaliveTime: 30000
      maxLifetime: 600000
      maximumPoolSize: 30
</code></pre> 
<blockquote> 
 <p>https://github.com/njdi/example/blob/main/spring-security/src/main/resources/application.yml。</p> 
</blockquote> 
<h5><a id="_190"></a>创建认证/鉴权配置类</h5> 
<p><strong>SpringSecurityConfig</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>认证/鉴权配置类（<strong>@Configuration</strong>）需要继承 <strong>WebSecurityConfigurerAdapter</strong>，通过重写若干方法完成认证/鉴权的具体配置，本文仅使用 <strong>configure</strong> 方法。</p> 
<blockquote> 
 <p>https://github.com/njdi/example/blob/main/spring-security/src/main/java/io/njdi/example/spring/security/conf/SpringSecurityConfig.java</p> 
</blockquote> 
<h5><a id="_210"></a>注入认证/鉴权实例</h5> 
<p>Spring Security 认证/鉴权的实现过程依赖于 <a href="https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/user-details-service.html" rel="nofollow">UserDetailsService</a>，用于完成用户名、密码和角色等相关信息的检索/存储。本文需要使用数据库的实现 <strong>JdbcUserDetailsManager</strong>。</p> 
<p><strong>SpringSecurityConfig</strong></p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">JdbcUserDetailsManager</span> <span class="token function">createJdbcUserDetailsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcUserDetailsManager</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p><strong>JdbcUserDetailsManager</strong> 实例的创建依赖于数据源实例 <strong>dataSource</strong>，如前文所述，我们添加了 Maven 依赖 <strong>spring-boot-starter-jdbc</strong>，它会帮助我们自动注入数据库实例。</p> 
</blockquote> 
<h4><a id="_229"></a>声明认证/鉴权</h4> 
<p>某个接口需要什么样的认证/鉴权需要通过重写 <strong>WebSecurityConfigurerAdapter.configure</strong> 方法实现：</p> 
<p><strong>SpringSecurityConfig</strong></p> 
<pre><code class="prism language-java">    http<span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span>STATELESS<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span>authorize <span class="token operator">-&gt;</span> authorize<span class="token punctuation">.</span><span class="token function">mvcMatchers</span><span class="token punctuation">(</span><span class="token string">"/web/guest"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">mvcMatchers</span><span class="token punctuation">(</span><span class="token string">"/web/user"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">mvcMatchers</span><span class="token punctuation">(</span><span class="token string">"/web/admin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"ADMIN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>mvcMatchers("/web/guest").permitAll()，表示接口 /web/guest 可以被任意用户访问；<br> mvcMatchers("/web/user").hasRole(“USER”)，表示接口 /web/user 可以被拥有角色 USER 的用户访问；<br> mvcMatchers("/web/admin").hasRole(“ADMIN”)，表示接口 /web/admin 可以被拥有角色 ADMIN 的用户访问。</p> 
<blockquote> 
 <p>用户拥有角色的前提是用户必须可以被认证。</p> 
</blockquote> 
<blockquote> 
 <p>SessionCreationPolicy.STATELESS 用于声明接口服务是无状态的，可以禁用名称为 JSESSIONID 的 Cookie；disable() 用于禁用一些我们不需要的功能。</p> 
</blockquote> 
<p>编译启动应用，再次访问接口：</p> 
<pre><code class="prism language-text">curl http://localhost:8080/web/guest
hello guest

curl http://localhost:8080/web/user
{"timestamp":"2022-02-13T03:52:34.754+00:00","status":403,"error":"Forbidden","path":"/web/user"}

curl http://localhost:8080/web/admin
{"timestamp":"2022-02-13T03:52:40.910+00:00","status":403,"error":"Forbidden","path":"/web/admin"}
</code></pre> 
<p>我们会发现：接口 /web/guest 可以正常访问；接口 /web/user 和 /web/admin 会提示 <strong>403</strong>，没有权限访问，表示声明的接口认证/鉴权已生效。</p> 
<blockquote> 
 <p>注意，目前我们仅声明访问接口需要认证/鉴权，即需要用户属于指定角色；但是并没有声明具体使用哪一种认证/鉴权机制，即如何判断用户是谁，以及用户属于哪些角色。</p> 
</blockquote> 
<p>Spring Security 内置多种<a href="https://docs.spring.io/spring-security/reference/servlet/authentication/index.html#servlet-authentication-mechanisms" rel="nofollow">认证机制</a>和一种标准的<a href="https://docs.spring.io/spring-security/reference/servlet/authorization/index.html" rel="nofollow">鉴权机制</a>；有时我们可能会遇到已提供的认证机制不满足我们需求的情况，假如我们要求通过请求头属性提供用户名和密码来进行认证：</p> 
<ul><li>spring.security.user</li><li>spring.security.password</li></ul> 
<p>Spring Security 自身不支持这种认证机制，这时就需要我们自定义认证机制。</p> 
<h4><a id="_279"></a>自定义认证机制</h4> 
<p>Spring Security 本质上就是通过 <strong>过滤器链</strong> 实现的，自定义认证实际上就是提供一个我们自定义认证逻辑的 <strong>过滤器</strong>：</p> 
<ol><li>从请求头获取用户名和密码；</li><li>校验用户名和密码是否匹配；</li><li>如果匹配，则设置环境上下文，标识认证通过；</li><li>如果不匹配，则 <strong>什么也不做</strong>，继续执行 <strong>过滤器链</strong> 上的下一个过滤器；</li></ol> 
<p>然后，把这个 <strong>过滤器</strong> 添加到 <strong>过滤器链</strong> 上合适的位置。</p> 
<blockquote> 
 <p>过滤器链可参考：https://docs.spring.io/spring-security/reference/servlet/architecture.html#servlet-security-filters。</p> 
</blockquote> 
<blockquote> 
 <p>服务启动时，可以通过日志查看过滤器链上具体有哪些过滤器：<br> 2022-02-14 11:06:15.212 INFO 71515 — [ main] o.s.s.web.DefaultSecurityFilterChain : Will secure any request with […]</p> 
</blockquote> 
<p><strong>AuthenticationFilter</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> LOGGER <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JdbcUserDetailsManager</span> manager<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">AuthenticationFilter</span><span class="token punctuation">(</span><span class="token class-name">JdbcUserDetailsManager</span> manager<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>manager <span class="token operator">=</span> manager<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">String</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
                                  <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> user <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"spring.security.user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"spring.security.password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"user: {}, password: {}"</span><span class="token punctuation">,</span> user<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">authenticate</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>

    filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>https://github.com/njdi/example/blob/main/spring-security/src/main/java/io/njdi/example/spring/security/filter/AuthenticationFilter.java</p> 
</blockquote> 
<p>自定义过滤器 <strong>AuthenticationFilter</strong> 继承自 <strong>OncePerRequestFilter</strong>，需要我们重写 <strong>doFilterInternal</strong> 方法实现自定义认证逻辑。</p> 
<blockquote> 
 <p>为什么需要继承 <strong>OncePerRequestFilter</strong> ？<br> <strong>OncePerRequestFilter</strong> 可以保证我们自定义的过滤器在一次请求的处理过程中仅被执行一次。</p> 
</blockquote> 
<p><strong>doFilterInternal</strong> 执行逻辑如下：</p> 
<ol><li>获取用户名和密码 request.getHeader()；</li><li>检验用户名和密码，完成认证 authenticate()；</li><li>继续执行过滤器链的下一个过滤器 filterChain.doFilter()；</li></ol> 
<blockquote> 
 <p><strong>filterChain.doFilter()</strong> 需要特别注意。</p> 
</blockquote> 
<p><strong>authenticate()</strong></p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">String</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 用户名或密码为空</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>manager<span class="token punctuation">.</span><span class="token function">userExists</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 用户不存在</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> manager<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> encodedPassword <span class="token operator">=</span> userDetails<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">PasswordEncoder</span> encoder <span class="token operator">=</span> <span class="token class-name">PasswordEncoderFactories</span><span class="token punctuation">.</span><span class="token function">createDelegatingPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>encoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> encodedPassword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 密码不匹配</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
      用户认证通过
     */</span>
    <span class="token class-name">UsernamePasswordAuthenticationToken</span> token <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>
                    userDetails<span class="token punctuation">,</span>
                    userDetails<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 用户角色</span>
                    userDetails<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"userDetails.getAuthorities(): {}"</span><span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span>
            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><strong>authenticate()</strong> 的实现依赖于 <strong>JdbcUserDetailsManager</strong> 实例 <strong>manager</strong> ：</p> 
<ol><li>如果用户名或密码为空，直接返回；</li><li>如果用户不存在 manager.userExists()，直接返回；</li><li>根据用户名检索用户 manager.loadUserByUsername()，包含：用户名、密码（加密）和角色（多个）；</li><li>如果密码不匹配 encoder.matches() ，直接返回；</li><li>用户认证通过，设置环境上下文 SecurityContextHolder.setContext()；</li></ol> 
<blockquote> 
 <p><strong>UsernamePasswordAuthenticationToken</strong> 有两个重载的构造函数，调用不同的构造函数会将实例属性 <strong>authenticated</strong> 设置为不同的值：true 或 false，表示认证通过或不通过。</p> 
</blockquote> 
<p>自定义认证过滤器 <strong>AuthenticationFilter</strong> 实现完成之后，需要将其添加到 <strong>过滤器链</strong> 上合适的位置：</p> 
<p><strong>SpringSecurityConfig</strong></p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Bean</span>
  <span class="token class-name">AuthenticationFilter</span> <span class="token function">createAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationFilter</span><span class="token punctuation">(</span><span class="token function">createJdbcUserDetailsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    http<span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span>STATELESS<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span>authorize <span class="token operator">-&gt;</span> authorize<span class="token punctuation">.</span><span class="token function">mvcMatchers</span><span class="token punctuation">(</span><span class="token string">"/web/guest"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">mvcMatchers</span><span class="token punctuation">(</span><span class="token string">"/web/user"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">mvcMatchers</span><span class="token punctuation">(</span><span class="token string">"/web/admin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"ADMIN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span><span class="token function">createAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">BasicAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>什么是 <strong>合适</strong> 的位置？<br> 实际取决于整个 <strong>过滤器链</strong> 的逻辑。<strong>BasicAuthenticationFilter</strong> 是用于 <strong>Basic</strong> 认证的，我们自定义的过滤器也是认证的，放在它的 <strong>周围</strong> 肯定是没有错的。</p> 
</blockquote> 
<h4><a id="_422"></a>添加用户</h4> 
<p>目前系统里没有任何用户，我们需要通过 <strong>JdbcUserDetailsManager</strong> 实现用户的增/删/查/改，这里以测试用例的方式演示用户增加：</p> 
<p><strong>添加 Maven 依赖</strong></p> 
<pre><code class="prism language-text">    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;junit&lt;/groupId&gt;
      &lt;artifactId&gt;junit&lt;/artifactId&gt;
    &lt;/dependency&gt;
</code></pre> 
<p><strong>JdbcUserDetailsManagerTestCase</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcUserDetailsManagerTestCase</span> <span class="token punctuation">{<!-- --></span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">JdbcUserDetailsManager</span> manager<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">UserDetails</span> user <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>
            <span class="token comment">// 123456</span>
            <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"{bcrypt}$2a$10$Z3/1/TTZsraq.9jWiXfkTumjy1XTwMk9Q.Pb8mUd83c/eSaviSuRC"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">UserDetails</span> admin <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span>
            <span class="token comment">// adcdef</span>
            <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"{bcrypt}$2a$10$vlDmj4YMosNAa59rLEmLqOiruJIqDdOKXZxa83ai/YGsm2sgVg58e"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"ADMIN"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>https://github.com/njdi/example/blob/main/spring-security/src/test/java/io/njdi/example/spring/security/test/JdbcUserDetailsManagerTestCase.java</p> 
</blockquote> 
<blockquote> 
 <p>roles() 可以设置多个角色。</p> 
</blockquote> 
<p>我们添加了两个用户：</p> 
<ul><li>用户名：user，密码：123456，角色：USER</li><li>用户名：admin，密码：abcdefg，角色：ADMIN</li></ul> 
<p>编译启动应用，使用已创建的用户访问接口：</p> 
<pre><code class="prism language-text">curl -H "spring.security.user: user" -H "spring.security.password: 123456" http://localhost:8080/web/user
hello user

curl -H "spring.security.user: admin" -H "spring.security.password: abcdef" http://localhost:8080/web/admin
hello admin
</code></pre> 
<p>使用用户 user 可以访问接口 /web/user，使用用户 admin 可以访问接口 /web/admin；但是使用用户 admin 不可以访问接口 /web/user，即：角色 ADMIN 的用户不可以访问属于角色 USER 的接口。</p> 
<p>如果用户 admin 想访问接口 /web/user，可以通过两种方式实现：</p> 
<ol><li>用户 admin 同时设置角色 USER 和角色 ADMIN，添加用户时可以通过 <strong>roles()</strong> 方法设置；</li><li>角色 ADMIN 包含 角色 USER，即：角色 USER 的用户可以访问的接口，角色 ADMIN 的用户也可以访问；</li></ol> 
<h4><a id="_497"></a>角色层级</h4> 
<p>Spring Security 支持角色之间的 <strong>包含</strong> 关系：</p> 
<p><strong>SpringSecurityConfig</strong></p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Bean</span>
  <span class="token class-name">RoleHierarchy</span> <span class="token function">hierarchy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">RoleHierarchyImpl</span> hierarchy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoleHierarchyImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hierarchy<span class="token punctuation">.</span><span class="token function">setHierarchy</span><span class="token punctuation">(</span><span class="token string">"ROLE_ADMIN &gt; ROLE_USER"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> hierarchy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>角色 ADMIN 包含 角色 USER。</p> 
<blockquote> 
 <p>hierarchy.setHierarchy() 支持多个 <strong>关系对</strong>。</p> 
</blockquote> 
<blockquote> 
 <p>如果角色名称不带有 ROLE_ 前缀，Spring Security 会为我们自动添加。</p> 
</blockquote> 
<p>编译启动应用，使用用户 admin 访问接口 /web/user：</p> 
<pre><code class="prism language-text">curl -H "spring.security.user: admin" -H "spring.security.password: abcdef" http://localhost:8080/web/user
hello user
</code></pre> 
<p>可以访问。</p> 
<h4><a id="_528"></a>自定义认证/鉴权失败处理器</h4> 
<p>访问接口时，如果</p> 
<ul><li>认证失败，如：用户名或密码不匹配；</li><li>鉴权失败，如：用户没有相应的的接口角色；</li></ul> 
<p>均会返回如下的结果：</p> 
<pre><code class="prism language-text">{"timestamp":"2022-02-14T04:07:42.031+00:00","status":403,"error":"Forbidden","path":"/web/user"}
</code></pre> 
<p>如果我们想实现认证失败返回 <strong>401</strong>，鉴权失败返回 <strong>403</strong>，可以通过自定义认证/鉴权失败处理器实现。</p> 
<p>自定义认证失败处理器（<strong>AuthenticationEntryPoint</strong>）：</p> 
<p><strong>SpringSecurityConfig</strong></p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Bean</span>
  <span class="token class-name">AuthenticationEntryPoint</span> <span class="token function">createAuthenticationEntryPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> authException<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"401"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>自定义鉴权失败处理器（<strong>AccessDeniedHandler</strong>）：</p> 
<p><strong>SpringSecurityConfig</strong></p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Bean</span>
  <span class="token class-name">AccessDeniedHandler</span> <span class="token function">createAccessDeniedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> accessDeniedException<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"403"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>使用自定义认证失败处理器和鉴权失败处理器：</p> 
<p><strong>SpringSecurityConfig</strong></p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    http<span class="token punctuation">.</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">authenticationEntryPoint</span><span class="token punctuation">(</span><span class="token function">createAuthenticationEntryPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">accessDeniedHandler</span><span class="token punctuation">(</span><span class="token function">createAccessDeniedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>编译启动应用，使用错误的用户名和密码访问接口，或者访问没有权限的接口：</p> 
<pre><code class="prism language-text">curl -H "spring.security.user: user" -H "spring.security.password: 111111" http://localhost:8080/web/user
401

curl -H "spring.security.user: user" -H "spring.security.password: 123456" http://localhost:8080/web/admin
403
</code></pre> 
<p>按预期正常返回。</p> 
<h2><a id="Method_AuthenticationAuthorization_592"></a>Method Authentication/Authorization</h2> 
<p>认证和鉴权不但可以声明在接口上（<strong>mvcMatchers</strong>），还可以声明在方法上，如：Controller/Service/Dao 层方法。</p> 
<p>假设有三个接口：</p> 
<p>/method/guest：任意用户可访问；<br> /method/user：访问时需要提供用户名和密码，且访问用户必须拥有角色 USER；<br> /method/admin：访问时需要提供用户名和密码，且访问用户必须拥有角色 ADMIN；</p> 
<p>使用与前文类似的认证和鉴权要求，仅接口路径略有不同。</p> 
<p><strong>MethodController</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/method"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodController</span> <span class="token punctuation">{<!-- --></span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/guest"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">helloGuest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">"hello guest"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">helloUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">"hello user"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/admin"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">helloAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">"hello admin"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>https://github.com/njdi/example/blob/main/spring-security/src/main/java/io/njdi/example/spring/security/controller/MethodController.java</p> 
</blockquote> 
<p>编译启动应用，访问接口：</p> 
<pre><code class="prism language-text">curl http://localhost:8080/method/guest
hello guest

curl http://localhost:8080/method/user
hello user

curl http://localhost:8080/method/admin
hello admin
</code></pre> 
<p>均可以正常访问。</p> 
<p>这次我们在接口方法 helloGuest()、helloUser()、helloAdmin() 上面声明认证和鉴权。</p> 
<h3><a id="_646"></a>启动方法认证和鉴权</h3> 
<p><strong>Main</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableMethodSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Main</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>@EnableMethodSecurity</strong> 启用方法认证和鉴权。</p> 
<h3><a id="_662"></a>声明方法认证和鉴权</h3> 
<p><strong>MethodController</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/method"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodController</span> <span class="token punctuation">{<!-- --></span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/guest"</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"permitAll"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">helloGuest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">"hello guest"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasRole('USER')"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">helloUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">"hello user"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/admin"</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasRole('ADMIN')"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">helloAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">"hello admin"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>@PreAuthorize</strong> 表示在方法运行前执行认证和鉴权，支持使用 <strong>表达式</strong> 声明具体的认证和鉴权：</p> 
<ul><li>permitAll 表示任意用户可访问；</li><li>hasRole 表示拥有指定角色的用户可访问；</li></ul> 
<blockquote> 
 <p>方法认证和鉴权还支持其它注解，可参考：https://docs.spring.io/spring-security/reference/servlet/authorization/method-security.html。</p> 
</blockquote> 
<blockquote> 
 <p>方法认证和鉴权支持的表达式列表，可参考：https://docs.spring.io/spring-security/reference/servlet/authorization/expression-based.html#el-common-built-in。</p> 
</blockquote> 
<h2><a id="Acl_699"></a>Acl</h2> 
<p>目前我们已经可以实现对接口或方法层面（接口本质上也是方法）的认证和鉴权，如果我们想更细粒度的控制接口或方法中 <strong>对象</strong> 层面的认证和鉴权：</p> 
<ul><li>用户仅可以访问有权限的对象</li></ul> 
<p>就需要使用 Spring Security Acl。</p> 
<p>假设存在对象 Entity:</p> 
<p><strong>Entity</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Entity</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">Entity</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>https://github.com/njdi/example/blob/main/spring-security/src/main/java/io/njdi/example/spring/security/controller/Entity.java</p> 
</blockquote> 
<blockquote> 
 <p>Spring Security Acl 要求对象必须拥有 <strong>getId</strong> 方法，且方法返回值必须与 <strong>long</strong> 兼容；而且对象类不可以是 <strong>内部类</strong>。</p> 
</blockquote> 
<p>假设存在三个接口：</p> 
<ul><li>/acl/get：查询并返回指定 id 的对象；</li><li>/acl/get2：同 /acl/get，详情见后；</li><li>/acl/gets：查询并返回所有的对象列表；</li></ul> 
<p><strong>AclController</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/acl"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AclController</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entity</span><span class="token punctuation">&gt;</span></span> entities<span class="token punctuation">;</span>

  <span class="token punctuation">{<!-- --></span>
    entities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    entities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Entity</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    entities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Entity</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    entities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Entity</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">Entity</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>entity <span class="token operator">-&gt;</span> entity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get2"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">Entity</span> <span class="token function">get2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>entity <span class="token operator">-&gt;</span> entity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/gets"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entity</span><span class="token punctuation">&gt;</span></span> <span class="token function">gets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> entities<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>https://github.com/njdi/example/blob/main/spring-security/src/main/java/io/njdi/example/spring/security/controller/AclController.java</p> 
</blockquote> 
<p>编译启动应用，访问接口：</p> 
<pre><code class="prism language-text">curl http://localhost:8080/acl/get?id=1
{"id":1}

curl http://localhost:8080/acl/get2?id=1
{"id":1}

curl http://localhost:8080/acl/gets
[{"id":1},{"id":2},{"id":3}]
</code></pre> 
<h3><a id="_Maven__783"></a>添加 Maven 依赖</h3> 
<pre><code class="prism language-text">    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
      &lt;artifactId&gt;spring-security-acl&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-starter-cache&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;org.ehcache&lt;/groupId&gt;
      &lt;artifactId&gt;ehcache&lt;/artifactId&gt;
    &lt;/dependency&gt;
</code></pre> 
<blockquote> 
 <p>Spring Security Acl 实现依赖于缓存，这里使用 Ehcache。</p> 
</blockquote> 
<h3><a id="_804"></a>启用缓存</h3> 
<p><strong>Main</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableMethodSecurity</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Main</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>@EnableCaching</strong> 表明启用缓存。</p> 
<h3><a id="_821"></a>创建数据表</h3> 
<p>数据表中存储着用户和对象之间的授权关系。</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> acl_sid <span class="token punctuation">(</span>
    id <span class="token keyword">BIGINT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    principal <span class="token keyword">BOOLEAN</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    sid <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> unique_acl_sid <span class="token punctuation">(</span>sid<span class="token punctuation">,</span> principal<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> acl_class <span class="token punctuation">(</span>
    id <span class="token keyword">BIGINT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    class <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    class_id_type <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> uk_acl_class <span class="token punctuation">(</span>class<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> acl_object_identity <span class="token punctuation">(</span>
    id <span class="token keyword">BIGINT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    object_id_class <span class="token keyword">BIGINT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    object_id_identity <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    parent_object <span class="token keyword">BIGINT</span> <span class="token keyword">UNSIGNED</span><span class="token punctuation">,</span>
    owner_sid <span class="token keyword">BIGINT</span> <span class="token keyword">UNSIGNED</span><span class="token punctuation">,</span>
    entries_inheriting <span class="token keyword">BOOLEAN</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> uk_acl_object_identity <span class="token punctuation">(</span>object_id_class<span class="token punctuation">,</span> object_id_identity<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">CONSTRAINT</span> fk_acl_object_identity_parent <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>parent_object<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> acl_object_identity <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">CONSTRAINT</span> fk_acl_object_identity_class <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>object_id_class<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> acl_class <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">CONSTRAINT</span> fk_acl_object_identity_owner <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>owner_sid<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> acl_sid <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> acl_entry <span class="token punctuation">(</span>
    id <span class="token keyword">BIGINT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    acl_object_identity <span class="token keyword">BIGINT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    ace_order <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    sid <span class="token keyword">BIGINT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    mask <span class="token keyword">INTEGER</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    granting <span class="token keyword">BOOLEAN</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    audit_success <span class="token keyword">BOOLEAN</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    audit_failure <span class="token keyword">BOOLEAN</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> unique_acl_entry <span class="token punctuation">(</span>acl_object_identity<span class="token punctuation">,</span> ace_order<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">CONSTRAINT</span> fk_acl_entry_object <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>acl_object_identity<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> acl_object_identity <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">CONSTRAINT</span> fk_acl_entry_acl <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>sid<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> acl_sid <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>https://github.com/njdi/example/blob/main/spring-security/sql/acl.sql</p> 
</blockquote> 
<blockquote> 
 <p>数据表创建语句可参考：https://docs.spring.io/spring-security/reference/servlet/appendix/database-schema.html#_mysql_and_mariadb，实际使用时需要添加字段 <strong>acl_class.class_id_type</strong>。</p> 
</blockquote> 
<h3><a id="_Acl__872"></a>创建 Acl 配置类及注入相关实例</h3> 
<p><strong>AclConfig</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AclConfig</span> <span class="token punctuation">{<!-- --></span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">CacheManager</span> cacheManager<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">AuditLogger</span> <span class="token function">createAuditLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">AclAuthorizationStrategy</span> <span class="token function">createAclAuthorizationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">PermissionGrantingStrategy</span> <span class="token function">createPermissionGrantingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">AclCache</span> <span class="token function">createAclCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">LookupStrategy</span> <span class="token function">createLookupStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">AclService</span> <span class="token function">createAclService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">MethodSecurityExpressionHandler</span> <span class="token function">createMethodSecurityExpressionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>https://github.com/njdi/example/blob/main/spring-security/src/main/java/io/njdi/example/spring/security/conf/AclConfig.java</p> 
</blockquote> 
<p><strong>AuditLogger</strong></p> 
<p>用于记录 Acl 日志。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">AuditLogger</span> <span class="token function">createAuditLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConsoleAuditLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><strong>AclAuthorizationStrategy</strong></p> 
<p>用于判断什么样的用户可以管理 Acl 权限授予或回收。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">AclAuthorizationStrategy</span> <span class="token function">createAclAuthorizationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> role <span class="token operator">=</span> <span class="token string">"ROLE_ADMIN"</span><span class="token punctuation">;</span>
    <span class="token class-name">GrantedAuthority</span> grantedAuthority <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AclAuthorizationStrategyImpl</span><span class="token punctuation">(</span>grantedAuthority<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里设置为具有角色 ADMIN 的用户可以管理 Acl 权限的授予或回收。</p> 
<p><strong>PermissionGrantingStrategy</strong></p> 
<p>用于判断用户是否被授予权限。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">PermissionGrantingStrategy</span> <span class="token function">createPermissionGrantingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultPermissionGrantingStrategy</span><span class="token punctuation">(</span><span class="token function">createAuditLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><strong>AclCache</strong></p> 
<p>Acl 专用缓存。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">AclCache</span> <span class="token function">createAclCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Cache</span> cache <span class="token operator">=</span> cacheManager<span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token string">"aclCache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SpringCacheBasedAclCache</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> <span class="token function">createPermissionGrantingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">createAclAuthorizationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><strong>LookupStrategy</strong></p> 
<p>Acl 查询策略。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">LookupStrategy</span> <span class="token function">createLookupStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">BasicLookupStrategy</span> basicLookupStrategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicLookupStrategy</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">,</span> <span class="token function">createAclCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">createAclAuthorizationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">createPermissionGrantingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    basicLookupStrategy<span class="token punctuation">.</span><span class="token function">setAclClassIdSupported</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> basicLookupStrategy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>注意 <strong>basicLookupStrategy.setAclClassIdSupported(true)</strong> 的使用，与数据库添加字段 <strong>acl_class.class_id_type</strong> 有关。</p> 
</blockquote> 
<p><strong>AclService</strong></p> 
<p>用于管理 Acl 权限的授予或回收。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">AclService</span> <span class="token function">createAclService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">JdbcMutableAclService</span> jdbcMutableAclService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcMutableAclService</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">,</span> <span class="token function">createLookupStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">createAclCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    jdbcMutableAclService<span class="token punctuation">.</span><span class="token function">setClassIdentityQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT @@IDENTITY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jdbcMutableAclService<span class="token punctuation">.</span><span class="token function">setSidIdentityQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT @@IDENTITY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    jdbcMutableAclService<span class="token punctuation">.</span><span class="token function">setAclClassIdSupported</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> jdbcMutableAclService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>注意 <strong>jdbcMutableAclService.setClassIdentityQuery(“SELECT @@IDENTITY”)</strong> 和 <strong>jdbcMutableAclService.setSidIdentityQuery(“SELECT @@IDENTITY”)</strong> 的使用，与数据库使用 MySQL 有关。</p> 
</blockquote> 
<blockquote> 
 <p>注意 <strong>jdbcMutableAclService.setAclClassIdSupported(true)</strong> 的使用，与数据库添加字段 <strong>acl_class.class_id_type</strong> 有关。</p> 
</blockquote> 
<p><strong>MethodSecurityExpressionHandler</strong></p> 
<p>方法表达式处理器，联动 AclService 校验权限。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">MethodSecurityExpressionHandler</span> <span class="token function">createMethodSecurityExpressionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">PermissionEvaluator</span> permissionEvaluator
            <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AclPermissionEvaluator</span><span class="token punctuation">(</span><span class="token function">createAclService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">DefaultMethodSecurityExpressionHandler</span> methodSecurityExpressionHandler <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">DefaultMethodSecurityExpressionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    methodSecurityExpressionHandler<span class="token punctuation">.</span><span class="token function">setPermissionEvaluator</span><span class="token punctuation">(</span>permissionEvaluator<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> methodSecurityExpressionHandler<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>Spring Security Acl 涉及类较多，建议查看相关类的 JavaDoc 了解详情。</p> 
</blockquote> 
<h3><a id="_Acl_1037"></a>添加 Acl</h3> 
<p><strong>添加 Maven 依赖</strong></p> 
<pre><code class="prism language-text">    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
      &lt;artifactId&gt;spring-security-test&lt;/artifactId&gt;
    &lt;/dependency&gt;
</code></pre> 
<p><strong>AclTestCase</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AclTestCase</span> <span class="token punctuation">{<!-- --></span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">JdbcMutableAclService</span> aclService<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Test</span>
  <span class="token annotation punctuation">@WithMockUser</span>
  <span class="token annotation punctuation">@Transactional</span>
  <span class="token annotation punctuation">@Rollback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ObjectIdentity</span> oi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectIdentityImpl</span><span class="token punctuation">(</span><span class="token class-name">Entity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MutableAcl</span> acl<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      acl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MutableAcl</span><span class="token punctuation">)</span> aclService<span class="token punctuation">.</span><span class="token function">readAclById</span><span class="token punctuation">(</span>oi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NotFoundException</span> nfe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      acl <span class="token operator">=</span> aclService<span class="token punctuation">.</span><span class="token function">createAcl</span><span class="token punctuation">(</span>oi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Sid</span> sid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GrantedAuthoritySid</span><span class="token punctuation">(</span><span class="token string">"ROLE_USER"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Permission</span> permission <span class="token operator">=</span> <span class="token class-name">BasePermission</span><span class="token punctuation">.</span>READ<span class="token punctuation">;</span>

    acl<span class="token punctuation">.</span><span class="token function">insertAce</span><span class="token punctuation">(</span>acl<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> permission<span class="token punctuation">,</span> sid<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    aclService<span class="token punctuation">.</span><span class="token function">updateAcl</span><span class="token punctuation">(</span>acl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>@WithMockUser 用于模拟用户，如前文所述，Acl 角色 ADMIN 的用户可授予或回收，实际使用默认即可。</p> 
</blockquote> 
<p>ID 为 <strong>1</strong> 的对象（Entity）的 <strong>读</strong>（READ）权限被授予给角色 <strong>USER</strong>，即：属于角色 USER 的用户可以读取 ID 为 1 的对象。</p> 
<blockquote> 
 <p>用户和角色的对应关系在前文中的认证和鉴权部分已定义。</p> 
</blockquote> 
<h3><a id="_Acl_1086"></a>声明 Acl</h3> 
<p><strong>AclController</strong></p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get"</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasPermission(#id, 'io.njdi.example.spring.security.controller.Entity', 'read')"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">Entity</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>entity <span class="token operator">-&gt;</span> entity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>#id 表示使用请求参数 id 的值作为 ID 执行 Acl 校验。</p> 
</blockquote> 
<p>访问接口 /acl/get 或调用方法 get 之前，要求用户具有指定 ID 对象的读权限：</p> 
<pre><code class="prism language-text">curl -H "spring.security.user: user" -H "spring.security.password: 123456" http://localhost:8080/acl/get?id=1
{"id":1}

curl -H "spring.security.user: user" -H "spring.security.password: 123456" http://localhost:8080/acl/get?id=2
403
</code></pre> 
<p>用户 user 属于角色 USER，仅可以访问 ID 为 1 的 Entity 对象；访问ID 不为 1 的 Entity 对象会返回 403。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get2"</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@PostAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasPermission(returnObject, 'read')"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">Entity</span> <span class="token function">get2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>entity <span class="token operator">-&gt;</span> entity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>访问接口 /acl/get2 或调用方法 get2 之后，要求用户具有返回对象的读权限，本质上也是基于 Entity ID 校验。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/gets"</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"isAuthenticated()"</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@PostFilter</span><span class="token punctuation">(</span><span class="token string">"hasPermission(filterObject, 'read')"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entity</span><span class="token punctuation">&gt;</span></span> <span class="token function">gets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> entities<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>访问接口 /acl/gets 或调用方法 gets 之前，要求用户必须被认证；之后，要求 <strong>过滤</strong> 用户不具备读权限的对象：</p> 
<pre><code class="prism language-text">curl -H "spring.security.user: user" -H "spring.security.password: 111111" http://localhost:8080/acl/gets
401

curl -H "spring.security.user: user" -H "spring.security.password: 123456" http://localhost:8080/acl/gets
[{"id":1}]
</code></pre> 
<p>认证不通过，返回 401；认证通过，仅返回 ID 为 1 的对象，其余对象未授权，会被过滤掉。</p> 
<h2><a id="_1143"></a>结语</h2> 
<p>Spring Security Auth/Acl 提供的功能十分强大，设计的也很精巧，天然具备和 SpringBoot 应用整合的优势；但是整个体系十分庞大，涉及的概念也非常多，刚开始接触的时候仅借助官方的示例并不能很好地上手，很容易遇到一些“坑”，希望本文的内容能够对大家有所帮助。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/363e17a607dc333fbd984fdd640fe7c4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何计算地址总线和数据总线</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b6e4110c294f70f821399d39d8eee2c5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">对Java反序列化数据绕WAF新姿势的补充</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>