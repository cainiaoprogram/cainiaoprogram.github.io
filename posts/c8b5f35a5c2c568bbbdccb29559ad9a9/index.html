<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>记录一个Arduino调用MPU6050的姿态解算算法代码 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="记录一个Arduino调用MPU6050的姿态解算算法代码" />
<meta property="og:description" content="提示：文章写完后，目录可以自动生成，如何生成可参考右边的帮助文档
文章目录 Arduino风格代码 Arduino风格代码 /* MPU6050 Basic Example with IMU by: Kris Winer date: May 10, 2014 license: Beerware - Use this code however you&#39;d like. If you find it useful you can buy me a beer some time. Demonstrate MPU-6050 basic functionality including initialization, accelerometer trimming, sleep mode functionality as well as parameterizing the register addresses. Added display functions to allow display to on breadboard monitor. No DMP use." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c8b5f35a5c2c568bbbdccb29559ad9a9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-09T20:12:19+08:00" />
<meta property="article:modified_time" content="2023-11-09T20:12:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">记录一个Arduino调用MPU6050的姿态解算算法代码</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>提示：文章写完后，目录可以自动生成，如何生成可参考右边的帮助文档</p> 
</blockquote> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Arduino_9" rel="nofollow">Arduino风格代码</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="Arduino_9"></a>Arduino风格代码</h2> 
<pre><code class="prism language-c"><span class="token comment">/* MPU6050 Basic Example with IMU
  by: Kris Winer
  date: May 10, 2014
  license: Beerware - Use this code however you'd like. If you
  find it useful you can buy me a beer some time.

  Demonstrate  MPU-6050 basic functionality including initialization, accelerometer trimming, sleep mode functionality as well as
  parameterizing the register addresses. Added display functions to allow display to on breadboard monitor.
  No DMP use. We just want to get out the accelerations, temperature, and gyro readings.

  SDA and SCL should have external pull-up resistors (to 3.3V).
  10k resistors worked for me. They should be on the breakout
  board.

  Hardware setup:
  MPU6050 Breakout --------- Arduino
  3.3V --------------------- 3.3V
  SDA ----------------------- A4
  SCL ----------------------- A5
  GND ---------------------- GND

  Note: The MPU6050 is an I2C sensor and uses the Arduino Wire library.
  Because the sensor is not 5V tolerant, we are using a 3.3 V 8 MHz Pro Mini or a 3.3 V Teensy 3.1.
  We have disabled the internal pull-ups used by the Wire library in the Wire.h/twi.c utility file.
  We are also using the 400 kHz fast I2C mode by setting the TWI_FREQ  to 400000L /twi.h utility file.
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Wire.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"MPU6050lib.h"</span></span>
MPU6050lib mpu<span class="token punctuation">;</span>

<span class="token keyword">float</span> aRes<span class="token punctuation">,</span> gRes<span class="token punctuation">;</span> <span class="token comment">// scale resolutions per LSB for the sensors</span>
<span class="token comment">// Pin definitions</span>
<span class="token keyword">int</span> intPin <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>  <span class="token comment">// These can be changed, 2 and 3 are the Arduinos ext int pins</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">blinkPin</span> <span class="token expression"><span class="token number">13</span>  </span><span class="token comment">// Blink LED on Teensy or Pro Mini when updating</span></span>
boolean blinkOn <span class="token operator">=</span> false<span class="token punctuation">;</span>
<span class="token class-name">int16_t</span> accelCount<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// Stores the 16-bit signed accelerometer sensor output</span>
<span class="token keyword">float</span> ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> az<span class="token punctuation">;</span>       <span class="token comment">// Stores the real accel value in g's</span>
<span class="token class-name">int16_t</span> gyroCount<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// Stores the 16-bit signed gyro sensor output</span>
<span class="token keyword">float</span> gyrox<span class="token punctuation">,</span> gyroy<span class="token punctuation">,</span> gyroz<span class="token punctuation">;</span>       <span class="token comment">// Stores the real gyro value in degrees per seconds</span>
<span class="token keyword">float</span> gyroBias<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> accelBias<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// Bias corrections for gyro and accelerometer</span>
<span class="token class-name">int16_t</span> tempCount<span class="token punctuation">;</span>   <span class="token comment">// Stores the real internal chip temperature in degrees Celsius</span>
<span class="token keyword">float</span> temperature<span class="token punctuation">;</span>
<span class="token keyword">float</span> SelfTest<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> q<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">}</span><span class="token punctuation">;</span>            <span class="token comment">// vector to hold quaternion</span>
<span class="token class-name">uint32_t</span> <span class="token class-name">delt_t</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// used to control display output rate</span>
<span class="token class-name">uint32_t</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// used to control display output rate</span>
<span class="token keyword">float</span> pitch<span class="token punctuation">,</span> yaw<span class="token punctuation">,</span> roll<span class="token punctuation">;</span>
<span class="token comment">// parameters for 6 DoF sensor fusion calculations</span>
<span class="token keyword">float</span> GyroMeasError <span class="token operator">=</span> PI <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">40.0f</span> <span class="token operator">/</span> <span class="token number">180.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// gyroscope measurement error in rads/s (start at 60 deg/s), then reduce after ~10 s to 3</span>
<span class="token keyword">float</span> beta <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">3.0f</span> <span class="token operator">/</span> <span class="token number">4.0f</span><span class="token punctuation">)</span> <span class="token operator">*</span> GyroMeasError<span class="token punctuation">;</span>  <span class="token comment">// compute beta</span>
<span class="token keyword">float</span> GyroMeasDrift <span class="token operator">=</span> PI <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2.0f</span> <span class="token operator">/</span> <span class="token number">180.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// gyroscope measurement drift in rad/s/s (start at 0.0 deg/s/s)</span>
<span class="token keyword">float</span> zeta <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">3.0f</span> <span class="token operator">/</span> <span class="token number">4.0f</span><span class="token punctuation">)</span> <span class="token operator">*</span> GyroMeasDrift<span class="token punctuation">;</span>  <span class="token comment">// compute zeta, the other free parameter in the Madgwick scheme usually set to a small or zero value</span>
<span class="token keyword">float</span> deltat <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>                              <span class="token comment">// integration interval for both filter schemes</span>
<span class="token class-name">uint32_t</span> lastUpdate <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> firstUpdate <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>         <span class="token comment">// used to calculate integration interval</span>
<span class="token class-name">uint32_t</span> Now <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                 <span class="token comment">// used to calculate integration interval</span>

<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  Wire<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">9600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Set up the interrupt pin, its set as active high, push-pull</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>intPin<span class="token punctuation">,</span> INPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">digitalWrite</span><span class="token punctuation">(</span>intPin<span class="token punctuation">,</span> LOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>blinkPin<span class="token punctuation">,</span> OUTPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">digitalWrite</span><span class="token punctuation">(</span>blinkPin<span class="token punctuation">,</span> HIGH<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Read the WHO_AM_I register, this is a good test of communication</span>
  <span class="token class-name">uint8_t</span> c <span class="token operator">=</span> mpu<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span>MPU6050_ADDRESS<span class="token punctuation">,</span> WHO_AM_I_MPU6050<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Read WHO_AM_I register for MPU-6050</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"I AM "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">" I Should Be "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0x68</span><span class="token punctuation">)</span> <span class="token comment">// WHO_AM_I should always be 0x68</span>
  <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MPU6050 is online..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mpu<span class="token punctuation">.</span><span class="token function">MPU6050SelfTest</span><span class="token punctuation">(</span>SelfTest<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Start by performing self test and reporting values</span>
    <span class="token comment">//    Serial.print("x-axis self test: acceleration trim within : "); Serial.print(SelfTest[0],1); Serial.println("% of factory value");</span>
    <span class="token comment">//    Serial.print("y-axis self test: acceleration trim within : "); Serial.print(SelfTest[1],1); Serial.println("% of factory value");</span>
    <span class="token comment">//    Serial.print("z-axis self test: acceleration trim within : "); Serial.print(SelfTest[2],1); Serial.println("% of factory value");</span>
    <span class="token comment">//    Serial.print("x-axis self test: gyration trim within : "); Serial.print(SelfTest[3],1); Serial.println("% of factory value");</span>
    <span class="token comment">//    Serial.print("y-axis self test: gyration trim within : "); Serial.print(SelfTest[4],1); Serial.println("% of factory value");</span>
    <span class="token comment">//    Serial.print("z-axis self test: gyration trim within : "); Serial.print(SelfTest[5],1); Serial.println("% of factory value");</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>SelfTest<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">1.0f</span> <span class="token operator">&amp;&amp;</span> SelfTest<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">1.0f</span> <span class="token operator">&amp;&amp;</span> SelfTest<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">1.0f</span> <span class="token operator">&amp;&amp;</span> SelfTest<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">1.0f</span> <span class="token operator">&amp;&amp;</span> SelfTest<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">1.0f</span> <span class="token operator">&amp;&amp;</span> SelfTest<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">1.0f</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Pass Selftest!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      mpu<span class="token punctuation">.</span><span class="token function">calibrateMPU6050</span><span class="token punctuation">(</span>gyroBias<span class="token punctuation">,</span> accelBias<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Calibrate gyro and accelerometers, load biases in bias registers</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MPU6050 bias"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" x\t  y\t  z  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> accelBias<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token char">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> accelBias<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token char">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> accelBias<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" mg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>gyroBias<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token char">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>gyroBias<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token char">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>gyroBias<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" o/s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


      mpu<span class="token punctuation">.</span><span class="token function">initMPU6050</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MPU6050 initialized for active data mode...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Initialize device for active mode read of acclerometer, gyroscope, and temperature</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Could not connect to MPU6050: 0x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">;</span> <span class="token comment">// Loop forever if communication doesn't happen</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">// If data ready bit set, all data registers have new data</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mpu<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span>MPU6050_ADDRESS<span class="token punctuation">,</span> INT_STATUS<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// check if data ready interrupt</span>
    mpu<span class="token punctuation">.</span><span class="token function">readAccelData</span><span class="token punctuation">(</span>accelCount<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Read the x/y/z adc values</span>
    aRes <span class="token operator">=</span> mpu<span class="token punctuation">.</span><span class="token function">getAres</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Now we'll calculate the accleration value into actual g's</span>
    ax <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>accelCount<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> aRes<span class="token punctuation">;</span> <span class="token comment">// get actual g value, this depends on scale being set</span>
    ay <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>accelCount<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> aRes<span class="token punctuation">;</span>
    az <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>accelCount<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> aRes<span class="token punctuation">;</span>

    mpu<span class="token punctuation">.</span><span class="token function">readGyroData</span><span class="token punctuation">(</span>gyroCount<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Read the x/y/z adc values</span>
    gRes <span class="token operator">=</span> mpu<span class="token punctuation">.</span><span class="token function">getGres</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Calculate the gyro value into actual degrees per second</span>
    gyrox <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>gyroCount<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> gRes<span class="token punctuation">;</span> <span class="token comment">// get actual gyro value, this depends on scale being set</span>
    gyroy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>gyroCount<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> gRes<span class="token punctuation">;</span>
    gyroz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>gyroCount<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> gRes<span class="token punctuation">;</span>

    tempCount <span class="token operator">=</span> mpu<span class="token punctuation">.</span><span class="token function">readTempData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Read the x/y/z adc values</span>
    temperature <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> tempCount<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">340.</span> <span class="token operator">+</span> <span class="token number">36.53</span><span class="token punctuation">;</span> <span class="token comment">// Temperature in degrees Centigrade</span>
  <span class="token punctuation">}</span>

  Now <span class="token operator">=</span> <span class="token function">micros</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  deltat <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Now <span class="token operator">-</span> lastUpdate<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000000.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// set integration time by time elapsed since last filter update</span>
  lastUpdate <span class="token operator">=</span> Now<span class="token punctuation">;</span>
  <span class="token comment">//    if(lastUpdate - firstUpdate &gt; 10000000uL) {<!-- --></span>
  <span class="token comment">//      beta = 0.041; // decrease filter gain after stabilized</span>
  <span class="token comment">//      zeta = 0.015; // increase gyro bias drift gain after stabilized</span>
  <span class="token comment">//    }</span>
  <span class="token comment">// Pass gyro rate as rad/s</span>
  <span class="token function">MadgwickQuaternionUpdate</span><span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> az<span class="token punctuation">,</span> gyrox <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">180.0f</span><span class="token punctuation">,</span> gyroy <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">180.0f</span><span class="token punctuation">,</span> gyroz <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">180.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Serial print and/or display at 0.5 s rate independent of data rates</span>
  <span class="token class-name">delt_t</span> <span class="token operator">=</span> <span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> count<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">delt_t</span> <span class="token operator">&gt;</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// update LCD once per half-second independent of read rate</span>
    <span class="token function">digitalWrite</span><span class="token punctuation">(</span>blinkPin<span class="token punctuation">,</span> blinkOn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
        Serial.print("ax = "); Serial.print((int)1000*ax);
        Serial.print(" ay = "); Serial.print((int)1000*ay);
        Serial.print(" az = "); Serial.print((int)1000*az); Serial.println(" mg");

        Serial.print("gyrox = "); Serial.print( gyrox, 1);
        Serial.print(" gyroy = "); Serial.print( gyroy, 1);
        Serial.print(" gyroz = "); Serial.print( gyroz, 1); Serial.println(" deg/s");

        Serial.print("q0 = "); Serial.print(q[0]);
        Serial.print(" qx = "); Serial.print(q[1]);
        Serial.print(" qy = "); Serial.print(q[2]);
        Serial.print(" qz = "); Serial.println(q[3]);
    */</span>
    <span class="token comment">// Define output variables from updated quaternion---these are Tait-Bryan angles, commonly used in aircraft orientation.</span>
    <span class="token comment">// In this coordinate system, the positive z-axis is down toward Earth.</span>
    <span class="token comment">// Yaw is the angle between Sensor x-axis and Earth magnetic North (or true North if corrected for local declination, looking down on the sensor positive yaw is counterclockwise.</span>
    <span class="token comment">// Pitch is angle between sensor x-axis and Earth ground plane, toward the Earth is positive, up toward the sky is negative.</span>
    <span class="token comment">// Roll is angle between sensor y-axis and Earth ground plane, y-axis up is positive roll.</span>
    <span class="token comment">// These arise from the definition of the homogeneous rotation matrix constructed from quaternions.</span>
    <span class="token comment">// Tait-Bryan angles as well as Euler angles are non-commutative; that is, the get the correct orientation the rotations must be</span>
    <span class="token comment">// applied in the correct order which for this configuration is yaw, pitch, and then roll.</span>
    <span class="token comment">// For more see http://en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles which has additional links.</span>
    yaw   <span class="token operator">=</span> <span class="token function">atan2</span><span class="token punctuation">(</span><span class="token number">2.0f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> q<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> q<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> q<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> q<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> q<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> q<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> q<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*</span> q<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pitch <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">asin</span><span class="token punctuation">(</span><span class="token number">2.0f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> q<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> q<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    roll  <span class="token operator">=</span> <span class="token function">atan2</span><span class="token punctuation">(</span><span class="token number">2.0f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> q<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> q<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> q<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> q<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> q<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> q<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> q<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> q<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*</span> q<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pitch <span class="token operator">*=</span> <span class="token number">180.0f</span> <span class="token operator">/</span> PI<span class="token punctuation">;</span>
    yaw   <span class="token operator">*=</span> <span class="token number">180.0f</span> <span class="token operator">/</span> PI<span class="token punctuation">;</span>
    roll  <span class="token operator">*=</span> <span class="token number">180.0f</span> <span class="token operator">/</span> PI<span class="token punctuation">;</span>

    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Yaw, Pitch, Roll: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>yaw<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">", "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>pitch<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">", "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>roll<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//    Serial.print("average rate = "); Serial.print(1.0f/deltat, 2); Serial.println(" Hz");</span>

    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" x\t  y\t  z  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> ax<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token char">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> ay<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token char">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> az<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" mg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>gyrox<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token char">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>gyroy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token char">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>gyroz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" o/s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>yaw<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token char">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pitch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token char">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>roll<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" ypr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"rt: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token number">1.0f</span> <span class="token operator">/</span> deltat<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" Hz"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    blinkOn <span class="token operator">=</span> <span class="token operator">~</span>blinkOn<span class="token punctuation">;</span>
    count <span class="token operator">=</span> <span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Implementation of Sebastian Madgwick's "...efficient orientation filter for... inertial/magnetic sensor arrays"</span>
<span class="token comment">// (see http://www.x-io.co.uk/category/open-source/ for examples and more details)</span>
<span class="token comment">// which fuses acceleration and rotation rate to produce a quaternion-based estimate of relative</span>
<span class="token comment">// device orientation -- which can be converted to yaw, pitch, and roll. Useful for stabilizing quadcopters, etc.</span>
<span class="token comment">// The performance of the orientation filter is at least as good as conventional Kalman-based filtering algorithms</span>
<span class="token comment">// but is much less computationally intensive---it can be performed on a 3.3 V Pro Mini operating at 8 MHz!</span>
        <span class="token keyword">void</span> <span class="token function">MadgwickQuaternionUpdate</span><span class="token punctuation">(</span><span class="token keyword">float</span> ax<span class="token punctuation">,</span> <span class="token keyword">float</span> ay<span class="token punctuation">,</span> <span class="token keyword">float</span> az<span class="token punctuation">,</span> <span class="token keyword">float</span> gyrox<span class="token punctuation">,</span> <span class="token keyword">float</span> gyroy<span class="token punctuation">,</span> <span class="token keyword">float</span> gyroz<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">float</span> q1 <span class="token operator">=</span> q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> q2 <span class="token operator">=</span> q<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> q3 <span class="token operator">=</span> q<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> q4 <span class="token operator">=</span> q<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token comment">// short name local variable for readability</span>
            <span class="token keyword">float</span> norm<span class="token punctuation">;</span>                                               <span class="token comment">// vector norm</span>
            <span class="token keyword">float</span> f1<span class="token punctuation">,</span> f2<span class="token punctuation">,</span> f3<span class="token punctuation">;</span>                                         <span class="token comment">// objetive funcyion elements</span>
            <span class="token keyword">float</span> J_11or24<span class="token punctuation">,</span> J_12or23<span class="token punctuation">,</span> J_13or22<span class="token punctuation">,</span> J_14or21<span class="token punctuation">,</span> J_32<span class="token punctuation">,</span> J_33<span class="token punctuation">;</span> <span class="token comment">// objective function Jacobian elements</span>
            <span class="token keyword">float</span> qDot1<span class="token punctuation">,</span> qDot2<span class="token punctuation">,</span> qDot3<span class="token punctuation">,</span> qDot4<span class="token punctuation">;</span>
            <span class="token keyword">float</span> hatDot1<span class="token punctuation">,</span> hatDot2<span class="token punctuation">,</span> hatDot3<span class="token punctuation">,</span> hatDot4<span class="token punctuation">;</span>
            <span class="token keyword">float</span> gerrx<span class="token punctuation">,</span> gerry<span class="token punctuation">,</span> gerrz<span class="token punctuation">,</span> gbiasx<span class="token punctuation">,</span> gbiasy<span class="token punctuation">,</span> gbiasz<span class="token punctuation">;</span>        <span class="token comment">// gyro bias error</span>

            <span class="token comment">// Auxiliary variables to avoid repeated arithmetic</span>
            <span class="token keyword">float</span> _halfq1 <span class="token operator">=</span> <span class="token number">0.5f</span> <span class="token operator">*</span> q1<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _halfq2 <span class="token operator">=</span> <span class="token number">0.5f</span> <span class="token operator">*</span> q2<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _halfq3 <span class="token operator">=</span> <span class="token number">0.5f</span> <span class="token operator">*</span> q3<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _halfq4 <span class="token operator">=</span> <span class="token number">0.5f</span> <span class="token operator">*</span> q4<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _2q1 <span class="token operator">=</span> <span class="token number">2.0f</span> <span class="token operator">*</span> q1<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _2q2 <span class="token operator">=</span> <span class="token number">2.0f</span> <span class="token operator">*</span> q2<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _2q3 <span class="token operator">=</span> <span class="token number">2.0f</span> <span class="token operator">*</span> q3<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _2q4 <span class="token operator">=</span> <span class="token number">2.0f</span> <span class="token operator">*</span> q4<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _2q1q3 <span class="token operator">=</span> <span class="token number">2.0f</span> <span class="token operator">*</span> q1 <span class="token operator">*</span> q3<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _2q3q4 <span class="token operator">=</span> <span class="token number">2.0f</span> <span class="token operator">*</span> q3 <span class="token operator">*</span> q4<span class="token punctuation">;</span>

            <span class="token comment">// Normalise accelerometer measurement</span>
            norm <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>ax <span class="token operator">*</span> ax <span class="token operator">+</span> ay <span class="token operator">*</span> ay <span class="token operator">+</span> az <span class="token operator">*</span> az<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>norm <span class="token operator">==</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// handle NaN</span>
            norm <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token operator">/</span>norm<span class="token punctuation">;</span>
            ax <span class="token operator">*=</span> norm<span class="token punctuation">;</span>
            ay <span class="token operator">*=</span> norm<span class="token punctuation">;</span>
            az <span class="token operator">*=</span> norm<span class="token punctuation">;</span>
            
            <span class="token comment">// Compute the objective function and Jacobian</span>
            f1 <span class="token operator">=</span> _2q2 <span class="token operator">*</span> q4 <span class="token operator">-</span> _2q1 <span class="token operator">*</span> q3 <span class="token operator">-</span> ax<span class="token punctuation">;</span>
            f2 <span class="token operator">=</span> _2q1 <span class="token operator">*</span> q2 <span class="token operator">+</span> _2q3 <span class="token operator">*</span> q4 <span class="token operator">-</span> ay<span class="token punctuation">;</span>
            f3 <span class="token operator">=</span> <span class="token number">1.0f</span> <span class="token operator">-</span> _2q2 <span class="token operator">*</span> q2 <span class="token operator">-</span> _2q3 <span class="token operator">*</span> q3 <span class="token operator">-</span> az<span class="token punctuation">;</span>
            J_11or24 <span class="token operator">=</span> _2q3<span class="token punctuation">;</span>
            J_12or23 <span class="token operator">=</span> _2q4<span class="token punctuation">;</span>
            J_13or22 <span class="token operator">=</span> _2q1<span class="token punctuation">;</span>
            J_14or21 <span class="token operator">=</span> _2q2<span class="token punctuation">;</span>
            J_32 <span class="token operator">=</span> <span class="token number">2.0f</span> <span class="token operator">*</span> J_14or21<span class="token punctuation">;</span>
            J_33 <span class="token operator">=</span> <span class="token number">2.0f</span> <span class="token operator">*</span> J_11or24<span class="token punctuation">;</span>
          
            <span class="token comment">// Compute the gradient (matrix multiplication)</span>
            hatDot1 <span class="token operator">=</span> J_14or21 <span class="token operator">*</span> f2 <span class="token operator">-</span> J_11or24 <span class="token operator">*</span> f1<span class="token punctuation">;</span>
            hatDot2 <span class="token operator">=</span> J_12or23 <span class="token operator">*</span> f1 <span class="token operator">+</span> J_13or22 <span class="token operator">*</span> f2 <span class="token operator">-</span> J_32 <span class="token operator">*</span> f3<span class="token punctuation">;</span>
            hatDot3 <span class="token operator">=</span> J_12or23 <span class="token operator">*</span> f2 <span class="token operator">-</span> J_33 <span class="token operator">*</span>f3 <span class="token operator">-</span> J_13or22 <span class="token operator">*</span> f1<span class="token punctuation">;</span>
            hatDot4 <span class="token operator">=</span> J_14or21 <span class="token operator">*</span> f1 <span class="token operator">+</span> J_11or24 <span class="token operator">*</span> f2<span class="token punctuation">;</span>
            
            <span class="token comment">// Normalize the gradient</span>
            norm <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>hatDot1 <span class="token operator">*</span> hatDot1 <span class="token operator">+</span> hatDot2 <span class="token operator">*</span> hatDot2 <span class="token operator">+</span> hatDot3 <span class="token operator">*</span> hatDot3 <span class="token operator">+</span> hatDot4 <span class="token operator">*</span> hatDot4<span class="token punctuation">)</span><span class="token punctuation">;</span>
            hatDot1 <span class="token operator">/=</span> norm<span class="token punctuation">;</span>
            hatDot2 <span class="token operator">/=</span> norm<span class="token punctuation">;</span>
            hatDot3 <span class="token operator">/=</span> norm<span class="token punctuation">;</span>
            hatDot4 <span class="token operator">/=</span> norm<span class="token punctuation">;</span>
            
            <span class="token comment">// Compute estimated gyroscope biases</span>
            gerrx <span class="token operator">=</span> _2q1 <span class="token operator">*</span> hatDot2 <span class="token operator">-</span> _2q2 <span class="token operator">*</span> hatDot1 <span class="token operator">-</span> _2q3 <span class="token operator">*</span> hatDot4 <span class="token operator">+</span> _2q4 <span class="token operator">*</span> hatDot3<span class="token punctuation">;</span>
            gerry <span class="token operator">=</span> _2q1 <span class="token operator">*</span> hatDot3 <span class="token operator">+</span> _2q2 <span class="token operator">*</span> hatDot4 <span class="token operator">-</span> _2q3 <span class="token operator">*</span> hatDot1 <span class="token operator">-</span> _2q4 <span class="token operator">*</span> hatDot2<span class="token punctuation">;</span>
            gerrz <span class="token operator">=</span> _2q1 <span class="token operator">*</span> hatDot4 <span class="token operator">-</span> _2q2 <span class="token operator">*</span> hatDot3 <span class="token operator">+</span> _2q3 <span class="token operator">*</span> hatDot2 <span class="token operator">-</span> _2q4 <span class="token operator">*</span> hatDot1<span class="token punctuation">;</span>
            
            <span class="token comment">// Compute and remove gyroscope biases</span>
            gbiasx <span class="token operator">+=</span> gerrx <span class="token operator">*</span> deltat <span class="token operator">*</span> zeta<span class="token punctuation">;</span>
            gbiasy <span class="token operator">+=</span> gerry <span class="token operator">*</span> deltat <span class="token operator">*</span> zeta<span class="token punctuation">;</span>
            gbiasz <span class="token operator">+=</span> gerrz <span class="token operator">*</span> deltat <span class="token operator">*</span> zeta<span class="token punctuation">;</span>
            gyrox <span class="token operator">-=</span> gbiasx<span class="token punctuation">;</span>
            gyroy <span class="token operator">-=</span> gbiasy<span class="token punctuation">;</span>
            gyroz <span class="token operator">-=</span> gbiasz<span class="token punctuation">;</span>
            
            <span class="token comment">// Compute the quaternion derivative</span>
            qDot1 <span class="token operator">=</span> <span class="token operator">-</span>_halfq2 <span class="token operator">*</span> gyrox <span class="token operator">-</span> _halfq3 <span class="token operator">*</span> gyroy <span class="token operator">-</span> _halfq4 <span class="token operator">*</span> gyroz<span class="token punctuation">;</span>
            qDot2 <span class="token operator">=</span>  _halfq1 <span class="token operator">*</span> gyrox <span class="token operator">+</span> _halfq3 <span class="token operator">*</span> gyroz <span class="token operator">-</span> _halfq4 <span class="token operator">*</span> gyroy<span class="token punctuation">;</span>
            qDot3 <span class="token operator">=</span>  _halfq1 <span class="token operator">*</span> gyroy <span class="token operator">-</span> _halfq2 <span class="token operator">*</span> gyroz <span class="token operator">+</span> _halfq4 <span class="token operator">*</span> gyrox<span class="token punctuation">;</span>
            qDot4 <span class="token operator">=</span>  _halfq1 <span class="token operator">*</span> gyroz <span class="token operator">+</span> _halfq2 <span class="token operator">*</span> gyroy <span class="token operator">-</span> _halfq3 <span class="token operator">*</span> gyrox<span class="token punctuation">;</span>

            <span class="token comment">// Compute then integrate estimated quaternion derivative</span>
            q1 <span class="token operator">+=</span> <span class="token punctuation">(</span>qDot1 <span class="token operator">-</span><span class="token punctuation">(</span>beta <span class="token operator">*</span> hatDot1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> deltat<span class="token punctuation">;</span>
            q2 <span class="token operator">+=</span> <span class="token punctuation">(</span>qDot2 <span class="token operator">-</span><span class="token punctuation">(</span>beta <span class="token operator">*</span> hatDot2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> deltat<span class="token punctuation">;</span>
            q3 <span class="token operator">+=</span> <span class="token punctuation">(</span>qDot3 <span class="token operator">-</span><span class="token punctuation">(</span>beta <span class="token operator">*</span> hatDot3<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> deltat<span class="token punctuation">;</span>
            q4 <span class="token operator">+=</span> <span class="token punctuation">(</span>qDot4 <span class="token operator">-</span><span class="token punctuation">(</span>beta <span class="token operator">*</span> hatDot4<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> deltat<span class="token punctuation">;</span>

            <span class="token comment">// Normalize the quaternion</span>
            norm <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>q1 <span class="token operator">*</span> q1 <span class="token operator">+</span> q2 <span class="token operator">*</span> q2 <span class="token operator">+</span> q3 <span class="token operator">*</span> q3 <span class="token operator">+</span> q4 <span class="token operator">*</span> q4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// normalise quaternion</span>
            norm <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token operator">/</span>norm<span class="token punctuation">;</span>
            q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> q1 <span class="token operator">*</span> norm<span class="token punctuation">;</span>
            q<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> q2 <span class="token operator">*</span> norm<span class="token punctuation">;</span>
            q<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> q3 <span class="token operator">*</span> norm<span class="token punctuation">;</span>
            q<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> q4 <span class="token operator">*</span> norm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/02add2531eee5c555d696000b5a89c3c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">嵌软工程师要掌握的硬件知识1：一文了解什么是PN结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ed29610f5b6dfd706682d9ea49a43249/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">利用三次样条插值调整鱼眼扭曲程度</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>