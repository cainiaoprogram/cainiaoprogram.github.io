<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android–多线程之Handler下载图片源码 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android–多线程之Handler下载图片源码" />
<meta property="og:description" content="Android的消息传递机制是另外一种形式的“事件处理”，这种机制主要是为了解决Android应用中多线程的问题，在Android中不允许Activity新启动的线程访问该Activity里的UI组件，这样会导致新启动的线程无法改变UI组件的属性值。但实际开发中，很多地方需要在工作线程中改变UI组件的属性值，比如下载网络图片、动画等等。本篇博客主要介绍Handler是如何发送与处理线程上传递来的消息，并讲解Message的几种传递数据的方式，最后均会以小Demo来演示。
Handler
Handler ，它直接继承自Object，一个Handler允许发送和处理Message或者Runnable对象，并且会关联到主线程的MessageQueue中。每个Handler具有一个单独的线程，并且关联到一个消息队列的线程，就是说一个Handler有一个固有的消息队列。当实例化一个Handler的时候，它就承载在一个线程和消息队列的线程，这个Handler可以把Message或Runnable压入到消息队列，并且从消息队列中取出Message或Runnable，进而操作它们。
Handler主要有两个作用：
在工作线程中发送消息。在UI线程中获取、处理消息。 上面介绍到Handler可以把一个Message对象或者Runnable对象压入到消息队列中，进而在UI线程中获取Message或者执行Runnable对象，所以Handler把压入消息队列有两大体系，Post和sendMessage：
Post：Post允许把一个Runnable对象入队到消息队列中。它的方法有：post(Runnable)、postAtTime(Runnable,long)、postDelayed(Runnable,long)。sendMessage：sendMessage允许把一个包含消息数据的Message对象压入到消息队列中。它的方法有：sendEmptyMessage(int)、sendMessage(Message)、sendMessageAtTime(Message,long)、sendMessageDelayed(Message,long)。 从上面的各种方法可以看出，不管是post还是sendMessage都具有多种方法，它们可以设定Runnable对象和Message对象被入队到消息队列中，是立即执行还是延迟执行。
Post
对于Handler的Post方式来说，它会传递一个Runnable对象到消息队列中，在这个Runnable对象中，重写run()方法。一般在这个run()方法中写入需要在UI线程上的操作。
在Handler中，关于Post方式的方法有：
boolean post(Runnable r)：把一个Runnable入队到消息队列中，UI线程从消息队列中取出这个对象后，立即执行。boolean postAtTime(Runnable r,long uptimeMillis)：把一个Runnable入队到消息队列中，UI线程从消息队列中取出这个对象后，在特定的时间执行。boolean postDelayed(Runnable r,long delayMillis)：把一个Runnable入队到消息队列中，UI线程从消息队列中取出这个对象后，延迟delayMills秒执行void removeCallbacks(Runnable r)：从消息队列中移除一个Runnable对象。 有一点值得注意的是，对于Post方式而言，它其中Runnable对象的run()方法的代码，均执行在UI线程上，所以对于这段代码而言，不能执行在UI线程上的操作，一样无法使用post方式执行，比如说访问网络，下面提供一个例子，使用post方式从互联网上获取一张图片，并且显示在ImageView中。
package com.bgxt.datatimepickerdemo; import org.apache.http.HttpResponse; import org.apache.http.client.HttpClient; import org.apache.http.client.methods.HttpGet; import org.apache.http.impl.client.DefaultHttpClient; import org.apache.http.util.EntityUtils; import android.app.Activity; import android.app.ProgressDialog; import android.graphics.Bitmap; import android.graphics.BitmapFactory; import android.os.Bundle; import android.os.Handler; import android.view.View; import android.widget.Button; import android.widget.ImageView; public class HandlerPostActivity2 extends Activity { private Button btnDown; private ImageView ivImage; private static String image_path = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0ed14e1d7a24fa4deca8f110de59b9d3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-09-25T11:41:17+08:00" />
<meta property="article:modified_time" content="2016-09-25T11:41:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android–多线程之Handler下载图片源码</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> Android的消息传递机制是另外一种形式的“事件处理”，这种机制主要是为了解决Android应用中多线程的问题，在Android中不允许Activity新启动的线程访问该Activity里的UI组件，这样会导致新启动的线程无法改变UI组件的属性值。但实际开发中，很多地方需要在工作线程中改变UI组件的属性值，比如下载网络图片、动画等等。本篇博客主要介绍Handler是如何发送与处理线程上传递来的消息，并讲解Message的几种传递数据的方式，最后均会以小Demo来演示。</p> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> <span style="text-indent:0px">Handler</span></p> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> 　　 <a target="_blank" href="http://developer.android.com/reference/android/os/Handler.html" rel="nofollow,noindex noopener noreferrer" style="color:rgb(148,148,148); text-decoration:none; outline:none 0px; border-bottom-width:1px; border-bottom-style:dashed; border-bottom-color:rgb(148,148,148); font-style:italic; font-weight:bold">Handler</a> ，它直接继承自Object，一个Handler允许发送和处理Message或者Runnable对象，并且会关联到主线程的MessageQueue中。每个Handler具有一个单独的线程，并且关联到一个消息队列的线程，就是说一个Handler有一个固有的消息队列。当实例化一个Handler的时候，它就承载在一个线程和消息队列的线程，这个Handler可以把Message或Runnable压入到消息队列，并且从消息队列中取出Message或Runnable，进而操作它们。</p> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> Handler主要有两个作用：</p> 
<ul style="padding:0px; margin:0px 0px 0.75em 25px; list-style-type:none; font-size:16px; line-height:27.2px; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"><li style="line-height:1.7em; list-style-type:disc">在工作线程中发送消息。</li><li style="line-height:1.7em; list-style-type:disc">在UI线程中获取、处理消息。</li></ul> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> 上面介绍到Handler可以把一个Message对象或者Runnable对象压入到消息队列中，进而在UI线程中获取Message或者执行Runnable对象，所以Handler把压入消息队列有两大体系，Post和sendMessage：</p> 
<ul style="padding:0px; margin:0px 0px 0.75em 25px; list-style-type:none; font-size:16px; line-height:27.2px; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"><li style="line-height:1.7em; list-style-type:disc">Post：Post允许把一个Runnable对象入队到消息队列中。它的方法有：post(Runnable)、postAtTime(Runnable,long)、postDelayed(Runnable,long)。</li><li style="line-height:1.7em; list-style-type:disc">sendMessage：sendMessage允许把一个包含消息数据的Message对象压入到消息队列中。它的方法有：sendEmptyMessage(int)、sendMessage(Message)、sendMessageAtTime(Message,long)、sendMessageDelayed(Message,long)。</li></ul> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> 从上面的各种方法可以看出，不管是post还是sendMessage都具有多种方法，它们可以设定Runnable对象和Message对象被入队到消息队列中，是立即执行还是延迟执行。</p> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> <span style="text-indent:0px">Post</span></p> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> 对于Handler的Post方式来说，它会传递一个Runnable对象到消息队列中，在这个Runnable对象中，重写run()方法。一般在这个run()方法中写入需要在UI线程上的操作。</p> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> 在Handler中，关于Post方式的方法有：</p> 
<ul style="padding:0px; margin:0px 0px 0.75em 25px; list-style-type:none; font-size:16px; line-height:27.2px; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"><li style="line-height:1.7em; list-style-type:disc">boolean post(Runnable r)：把一个Runnable入队到消息队列中，UI线程从消息队列中取出这个对象后，立即执行。</li><li style="line-height:1.7em; list-style-type:disc">boolean postAtTime(Runnable r,long uptimeMillis)：把一个Runnable入队到消息队列中，UI线程从消息队列中取出这个对象后，在特定的时间执行。</li><li style="line-height:1.7em; list-style-type:disc">boolean postDelayed(Runnable r,long delayMillis)：把一个Runnable入队到消息队列中，UI线程从消息队列中取出这个对象后，延迟delayMills秒执行</li><li style="line-height:1.7em; list-style-type:disc">void removeCallbacks(Runnable r)：从消息队列中移除一个Runnable对象。</li></ul> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> 有一点值得注意的是，对于Post方式而言，它其中Runnable对象的run()方法的代码，均执行在UI线程上，所以对于这段代码而言，不能执行在UI线程上的操作，一样无法使用post方式执行，比如说访问网络，下面提供一个例子，使用post方式从互联网上获取一张图片，并且显示在ImageView中。</p> 
<pre><code class="language-java"><span class="keyword" style="font-weight:bold">package</span> com.bgxt.datatimepickerdemo;

<span class="keyword" style="font-weight:bold">import</span> org.apache.http.HttpResponse;
<span class="keyword" style="font-weight:bold">import</span> org.apache.http.client.HttpClient;
<span class="keyword" style="font-weight:bold">import</span> org.apache.http.client.methods.HttpGet;
<span class="keyword" style="font-weight:bold">import</span> org.apache.http.impl.client.DefaultHttpClient;
<span class="keyword" style="font-weight:bold">import</span> org.apache.http.util.EntityUtils;

<span class="keyword" style="font-weight:bold">import</span> <span class="wp_keywordlink_affiliate"><a target="_blank" href="http://www.itbbu.com/tag/androido" rel="nofollow noopener noreferrer" title="查看android中的全部文章" style="color:rgb(148,148,148); text-decoration:none; outline:none 0px; border-bottom-width:1px; border-bottom-style:dashed; border-bottom-color:rgb(148,148,148); font-style:italic; font-weight:bold">android</a></span>.app.Activity;
<span class="keyword" style="font-weight:bold">import</span> <span class="wp_keywordlink_affiliate"><a target="_blank" href="http://www.itbbu.com/tag/androido" rel="nofollow noopener noreferrer" title="查看android中的全部文章" style="color:rgb(148,148,148); text-decoration:none; outline:none 0px; border-bottom-width:1px; border-bottom-style:dashed; border-bottom-color:rgb(148,148,148); font-style:italic; font-weight:bold">android</a></span>.app.ProgressDialog;
<span class="keyword" style="font-weight:bold">import</span> <span class="wp_keywordlink_affiliate"><a target="_blank" href="http://www.itbbu.com/tag/androido" rel="nofollow noopener noreferrer" title="查看android中的全部文章" style="color:rgb(148,148,148); text-decoration:none; outline:none 0px; border-bottom-width:1px; border-bottom-style:dashed; border-bottom-color:rgb(148,148,148); font-style:italic; font-weight:bold">android</a></span>.graphics.Bitmap;
<span class="keyword" style="font-weight:bold">import</span> android.graphics.BitmapFactory;
<span class="keyword" style="font-weight:bold">import</span> android.os.Bundle;
<span class="keyword" style="font-weight:bold">import</span> android.os.Handler;
<span class="keyword" style="font-weight:bold">import</span> android.view.View;
<span class="keyword" style="font-weight:bold">import</span> android.widget.Button;
<span class="keyword" style="font-weight:bold">import</span> android.widget.ImageView;

<span class="keyword" style="font-weight:bold">public</span> <span class="class" style="color:rgb(68,85,136); font-weight:bold"><span class="keyword" style="color:rgb(51,51,51)">class</span> <span class="title">HandlerPostActivity2</span> <span class="keyword" style="color:rgb(51,51,51)">extends</span> <span class="title">Activity</span> {<!-- --></span>
<span class="indent">  </span><span class="keyword" style="font-weight:bold">private</span> Button btnDown;
<span class="indent">  </span><span class="keyword" style="font-weight:bold">private</span> ImageView ivImage;
<span class="indent">  </span><span class="keyword" style="font-weight:bold">private</span> <span class="keyword" style="font-weight:bold">static</span> String image_path = <span class="string" style="color:rgb(221,17,68)">"http://ww4.sinaimg.cn/bmiddle/786013a5jw1e7akotp4bcj20c80i3aao.jpg"</span>;
<span class="indent">  </span><span class="keyword" style="font-weight:bold">private</span> ProgressDialog dialog;
<span class="indent">  </span><span class="comment" style="color:rgb(153,153,136); font-style:italic">// 一个静态的Handler，Handler建议声明为静态的</span>
<span class="indent">  </span><span class="keyword" style="font-weight:bold">private</span> <span class="keyword" style="font-weight:bold">static</span>  Handler handler=<span class="keyword" style="font-weight:bold">new</span> Handler();
<span class="indent">  </span><span class="annotation">@Override</span>
<span class="indent">  </span><span class="keyword" style="font-weight:bold">protected</span> <span class="keyword" style="font-weight:bold">void</span> onCreate(Bundle savedInstanceState) {
<span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">super</span>.onCreate(savedInstanceState);
<span class="indent">  </span><span class="indent">  </span>setContentView(R.layout.asynctask_activity);
<span class="indent">  </span><span class="indent">  </span>
<span class="indent">  </span><span class="indent">  </span>btnDown = (Button) findViewById(R.id.btnDown);
<span class="indent">  </span><span class="indent">  </span>ivImage = (ImageView) findViewById(R.id.ivSinaImage);

<span class="indent">  </span><span class="indent">  </span>dialog = <span class="keyword" style="font-weight:bold">new</span> ProgressDialog(<span class="keyword" style="font-weight:bold">this</span>);
<span class="indent">  </span><span class="indent">  </span>dialog.setTitle(<span class="string" style="color:rgb(221,17,68)">"提示"</span>);
<span class="indent">  </span><span class="indent">  </span>dialog.setMessage(<span class="string" style="color:rgb(221,17,68)">"正在下载，请稍后..."</span>);
<span class="indent">  </span><span class="indent">  </span>dialog.setCancelable(<span class="keyword" style="font-weight:bold">false</span>);
<span class="indent">  </span><span class="indent">  </span>
<span class="indent">  </span><span class="indent">  </span>btnDown.setOnClickListener(<span class="keyword" style="font-weight:bold">new</span> View.OnClickListener() {			
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="annotation">@Override</span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">public</span> <span class="keyword" style="font-weight:bold">void</span> onClick(View v) {
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="comment" style="color:rgb(153,153,136); font-style:italic">// 开启一个子线程，用于下载图片</span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">new</span> Thread(<span class="keyword" style="font-weight:bold">new</span> MyThread()).start();
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="comment" style="color:rgb(153,153,136); font-style:italic">// 显示对话框</span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>dialog.show();
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span><span class="indent">  </span>});
<span class="indent">  </span>}
<span class="indent">  </span>
<span class="indent">  </span><span class="keyword" style="font-weight:bold">public</span> <span class="class" style="color:rgb(68,85,136); font-weight:bold"><span class="keyword" style="color:rgb(51,51,51)">class</span> <span class="title">MyThread</span> <span class="keyword" style="color:rgb(51,51,51)">implements</span> <span class="title">Runnable</span> {<!-- --></span>

<span class="indent">  </span><span class="indent">  </span><span class="annotation">@Override</span>
<span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">public</span> <span class="keyword" style="font-weight:bold">void</span> run() {
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="comment" style="color:rgb(153,153,136); font-style:italic">// 下载一个图片</span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>HttpClient httpClient = <span class="keyword" style="font-weight:bold">new</span> DefaultHttpClient();
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>HttpGet httpGet = <span class="keyword" style="font-weight:bold">new</span> HttpGet(image_path);
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>HttpResponse httpResponse = <span class="keyword" style="font-weight:bold">null</span>;
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">try</span> {
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>httpResponse = httpClient.execute(httpGet);
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">if</span> (httpResponse.getStatusLine().getStatusCode() == <span class="number" style="color:rgb(0,153,153)">200</span>) {
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">byte</span>[] data = EntityUtils.toByteArray(httpResponse
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>.getEntity());
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="comment" style="color:rgb(153,153,136); font-style:italic">// 得到一个Bitmap对象，并且为了使其在post内部可以访问，必须声明为final</span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">final</span> Bitmap bmp=BitmapFactory.decodeByteArray(data, <span class="number" style="color:rgb(0,153,153)">0</span>, data.length);
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>handler.post(<span class="keyword" style="font-weight:bold">new</span> Runnable() {						
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="annotation">@Override</span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">public</span> <span class="keyword" style="font-weight:bold">void</span> run() {
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="comment" style="color:rgb(153,153,136); font-style:italic">// 在Post中操作UI组件ImageView</span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>ivImage.setImageBitmap(bmp);
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>});
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="comment" style="color:rgb(153,153,136); font-style:italic">// 隐藏对话框</span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>dialog.dismiss();
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>} <span class="keyword" style="font-weight:bold">catch</span> (Exception e) {
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>e.printStackTrace();
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span><span class="indent">  </span>}

<span class="indent">  </span>}
}</code></pre> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> <span style="text-indent:0px">Message</span></p> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> Handler如果使用sendMessage的方式把消息入队到消息队列中，需要传递一个Message对象，而在Handler中，需要重写handleMessage()方法，用于获取工作线程传递过来的消息，此方法运行在UI线程上。下面先介绍一下Message。</p> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> Message是一个final类，所以不可被继承。Message封装了线程中传递的消息，如果对于一般的数据，Message提供了getData()和setData()方法来获取与设置数据，其中操作的数据是一个Bundle对象，这个Bundle对象提供一系列的getXxx()和setXxx()方法用于传递基本数据类型的键值对，对于基本数据类型，使用起来很简单，这里不再详细讲解。而对于复杂的数据类型，如一个对象的传递就要相对复杂一些。在Bundle中提供了两个方法，专门用来传递对象的，但是这两个方法也有相应的限制，需要实现特定的接口，当然，一些Android自带的类，其实已经实现了这两个接口中的某一个，可以直接使用。方法如下：</p> 
<div style="font-size:16px; line-height:27.2px; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> 
 <p style="margin-top:0px; margin-bottom:0.75em; line-height:1.7em; text-indent:1em"> putParcelable(String key,Parcelable value)：需要传递的对象类实现Parcelable接口。</p> 
 <p style="margin-top:0px; margin-bottom:0.75em; line-height:1.7em; text-indent:1em"> pubSerializable(String key,Serializable value)：需要传递的对象类实现Serializable接口。</p> 
 <p style="margin-top:0px; margin-bottom:0.75em; line-height:1.7em; text-indent:1em"> 还有另外一种方式在Message中传递对象，那就是使用Message自带的obj属性传值，它是一个Object类型，所以可以传递任意类型的对象，Message自带的有如下几个属性：</p> 
</div> 
<div style="font-size:16px; line-height:27.2px; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> 
 <p style="margin-top:0px; margin-bottom:0.75em; line-height:1.7em; text-indent:1em"> int arg1：参数一，用于传递不复杂的数据，复杂数据使用setData()传递。</p> 
 <p style="margin-top:0px; margin-bottom:0.75em; line-height:1.7em; text-indent:1em"> int arg2：参数二，用于传递不复杂的数据，复杂数据使用setData()传递。</p> 
 <p style="margin-top:0px; margin-bottom:0.75em; line-height:1.7em; text-indent:1em"> Object obj：传递一个任意的对象。</p> 
 <p style="margin-top:0px; margin-bottom:0.75em; line-height:1.7em; text-indent:1em"> int what：定义的消息码，一般用于设定消息的标志。</p> 
 <p style="margin-top:0px; margin-bottom:0.75em; line-height:1.7em; text-indent:1em"> 对于Message对象，一般并不推荐直接使用它的构造方法得到，而是建议通过使用Message.obtain()这个静态的方法或者Handler.obtainMessage()获取。Message.obtain()会从消息池中获取一个Message对象，如果消息池中是空的，才会使用构造方法实例化一个新Message，这样有利于消息资源的利用。并不需要担心消息池中的消息过多，它是有上限的，上限为10个。Handler.obtainMessage()具有多个重载方法，如果查看源码，会发现其实Handler.obtainMessage()在内部也是调用的Message.obtain()。</p> 
</div> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> 既然Message是在线程间传递消息，那么先以一个Demo讲解一下Message的使用，还是常规的从互联网上下载一张图片的Demo，下载后使用ImageView控件展示：</p> 
<pre><code class="language-java"><span class="keyword" style="font-weight:bold">package</span> com.bgxt.datatimepickerdemo;

<span class="keyword" style="font-weight:bold">import</span> org.apache.http.HttpResponse;
<span class="keyword" style="font-weight:bold">import</span> org.apache.http.client.HttpClient;
<span class="keyword" style="font-weight:bold">import</span> org.apache.http.client.methods.HttpGet;
<span class="keyword" style="font-weight:bold">import</span> org.apache.http.impl.client.DefaultHttpClient;
<span class="keyword" style="font-weight:bold">import</span> org.apache.http.util.EntityUtils;

<span class="keyword" style="font-weight:bold">import</span> android.app.Activity;
<span class="keyword" style="font-weight:bold">import</span> android.app.ProgressDialog;
<span class="keyword" style="font-weight:bold">import</span> android.graphics.Bitmap;
<span class="keyword" style="font-weight:bold">import</span> android.graphics.BitmapFactory;
<span class="keyword" style="font-weight:bold">import</span> android.os.Bundle;
<span class="keyword" style="font-weight:bold">import</span> android.os.Handler;
<span class="keyword" style="font-weight:bold">import</span> android.os.Message;
<span class="keyword" style="font-weight:bold">import</span> android.view.View;
<span class="keyword" style="font-weight:bold">import</span> android.widget.Button;
<span class="keyword" style="font-weight:bold">import</span> android.widget.ImageView;

<span class="keyword" style="font-weight:bold">public</span> <span class="class" style="color:rgb(68,85,136); font-weight:bold"><span class="keyword" style="color:rgb(51,51,51)">class</span> <span class="title">HandlerMessageActivity1</span> <span class="keyword" style="color:rgb(51,51,51)">extends</span> <span class="title">Activity</span> {<!-- --></span>
<span class="indent">  </span><span class="keyword" style="font-weight:bold">private</span> Button btnDown;
<span class="indent">  </span><span class="keyword" style="font-weight:bold">private</span> ImageView ivImage;
<span class="indent">  </span><span class="keyword" style="font-weight:bold">private</span> <span class="keyword" style="font-weight:bold">static</span> String image_path = <span class="string" style="color:rgb(221,17,68)">"http://ww4.sinaimg.cn/bmiddle/786013a5jw1e7akotp4bcj20c80i3aao.jpg"</span>;
<span class="indent">  </span><span class="keyword" style="font-weight:bold">private</span> ProgressDialog dialog;
<span class="indent">  </span><span class="keyword" style="font-weight:bold">private</span> <span class="keyword" style="font-weight:bold">static</span> <span class="keyword" style="font-weight:bold">int</span> IS_FINISH = <span class="number" style="color:rgb(0,153,153)">1</span>;

<span class="indent">  </span><span class="annotation">@Override</span>
<span class="indent">  </span><span class="keyword" style="font-weight:bold">protected</span> <span class="keyword" style="font-weight:bold">void</span> onCreate(Bundle savedInstanceState) {
<span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">super</span>.onCreate(savedInstanceState);
<span class="indent">  </span><span class="indent">  </span>setContentView(R.layout.asynctask_activity);

<span class="indent">  </span><span class="indent">  </span>btnDown = (Button) findViewById(R.id.btnDown);
<span class="indent">  </span><span class="indent">  </span>ivImage = (ImageView) findViewById(R.id.ivSinaImage);

<span class="indent">  </span><span class="indent">  </span>dialog = <span class="keyword" style="font-weight:bold">new</span> ProgressDialog(<span class="keyword" style="font-weight:bold">this</span>);
<span class="indent">  </span><span class="indent">  </span>dialog.setTitle(<span class="string" style="color:rgb(221,17,68)">"提示信息"</span>);
<span class="indent">  </span><span class="indent">  </span>dialog.setMessage(<span class="string" style="color:rgb(221,17,68)">"正在下载，请稍后..."</span>);
<span class="indent">  </span><span class="indent">  </span>dialog.setCancelable(<span class="keyword" style="font-weight:bold">false</span>);

<span class="indent">  </span><span class="indent">  </span>btnDown.setOnClickListener(<span class="keyword" style="font-weight:bold">new</span> View.OnClickListener() {
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="annotation">@Override</span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">public</span> <span class="keyword" style="font-weight:bold">void</span> onClick(View v) {
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">new</span> Thread(<span class="keyword" style="font-weight:bold">new</span> MyThread()).start();
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>dialog.show();
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span><span class="indent">  </span>});
<span class="indent">  </span>}

<span class="indent">  </span><span class="keyword" style="font-weight:bold">private</span>  Handler handler = <span class="keyword" style="font-weight:bold">new</span> Handler() {
<span class="indent">  </span><span class="indent">  </span><span class="comment" style="color:rgb(153,153,136); font-style:italic">// 在Handler中获取消息，重写handleMessage()方法</span>
<span class="indent">  </span><span class="indent">  </span><span class="annotation">@Override</span>
<span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">public</span> <span class="keyword" style="font-weight:bold">void</span> handleMessage(Message msg) {			
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="comment" style="color:rgb(153,153,136); font-style:italic">// 判断消息码是否为1</span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">if</span>(msg.what==IS_FINISH){
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">byte</span>[] data=(<span class="keyword" style="font-weight:bold">byte</span>[])msg.obj;
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>Bitmap bmp=BitmapFactory.decodeByteArray(data, <span class="number" style="color:rgb(0,153,153)">0</span>, data.length);
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>ivImage.setImageBitmap(bmp);
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>dialog.dismiss();
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span>};

<span class="indent">  </span><span class="keyword" style="font-weight:bold">public</span> <span class="class" style="color:rgb(68,85,136); font-weight:bold"><span class="keyword" style="color:rgb(51,51,51)">class</span> <span class="title">MyThread</span> <span class="keyword" style="color:rgb(51,51,51)">implements</span> <span class="title">Runnable</span> {<!-- --></span>

<span class="indent">  </span><span class="indent">  </span><span class="annotation">@Override</span>
<span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">public</span> <span class="keyword" style="font-weight:bold">void</span> run() {
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>HttpClient httpClient = <span class="keyword" style="font-weight:bold">new</span> DefaultHttpClient();
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>HttpGet httpGet = <span class="keyword" style="font-weight:bold">new</span> HttpGet(image_path);
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>HttpResponse httpResponse = <span class="keyword" style="font-weight:bold">null</span>;
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">try</span> {
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>httpResponse = httpClient.execute(httpGet);
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">if</span> (httpResponse.getStatusLine().getStatusCode() == <span class="number" style="color:rgb(0,153,153)">200</span>) {
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="font-weight:bold">byte</span>[] data = EntityUtils.toByteArray(httpResponse
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>.getEntity());
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="comment" style="color:rgb(153,153,136); font-style:italic">// 获取一个Message对象，设置what为1</span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>Message msg = Message.obtain();
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>msg.obj = data;
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>msg.what = IS_FINISH;
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="comment" style="color:rgb(153,153,136); font-style:italic">// 发送这个消息到消息队列中</span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>handler.sendMessage(msg);
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>} <span class="keyword" style="font-weight:bold">catch</span> (Exception e) {
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>e.printStackTrace();
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span>}
}</code></pre> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> <span style="text-indent:0px">下载地址 ： </span> <a target="_blank" href="http://www.itbbu.com/wp-content/uploads/2014/10/ThreadDemo.zip" rel="nofollow,noindex noopener noreferrer" style="color:rgb(148,148,148); text-decoration:none; outline:none 0px; border-bottom-width:1px; border-bottom-style:dashed; border-bottom-color:rgb(148,148,148); font-style:italic; font-weight:bold">ThreadDemo</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b2bd2de176643b9fb60412b0ff4d1301/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Cesium学习笔记（4）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8d37a8537b3df58e4517e13e6f7834ee/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">spring boot修改代码后无需重启设置</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>