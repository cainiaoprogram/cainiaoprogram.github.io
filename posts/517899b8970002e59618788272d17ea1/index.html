<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>prometheus应用与实践 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="prometheus应用与实践" />
<meta property="og:description" content="prometheus应用与实践 一、架构 二、指标类型 1、Counter(计数器) ​ 特点： 只增不减，除非监控系统发生了重置。
​ 适用场景：描述服务的请求数、已完成的任务数、错误发生的次数等 。
​ API：
//将counter值加1. increment(1L) // 将指定值加到counter值上，如果指定值&lt;0 会发生异常. increment(val) ​ PromQL ：
//通过rate()函数获取HTTP请求量的增长率 rate(http_requests_total[5m]) //查询当前系统中，访问量前10的HTTP地址 topk(10, http_requests_total) 2、Guage（仪表盘） ​ 特点： 可增可减 ，反映数据的实时性。
​ 适用场景： 内存使用率这种指标数据，也可以表示能随时增加或减少的“总数”，例如：当前并发请求的数量
​ API：
//将指定值赋予gauge值上 set(val) 3、 Histogram（直方图） ​ 特点： 一段时间范围内对数据进行采样（通常是请求持续时间或响应大小等），并将其计入可配置的存储桶（bucket）中，后续可通过指定区间筛选样本，也可以统计样本总数，数据展示为直方图。
​ 适用场景： 监控样本的分布情况。
4、 Summary（摘要） ​ 特点：对数据样本的简要描述（如：80%样本的平均响应时间为5s）
​ 适用场景：性能的总结。
三、案例 案例一：prometheus使用 global: scrape_interval: 30s # 设置监测频率（默认1min）. evaluation_interval: 30s # 设置告警频率（默认1min） # scrape_timeout is set to the global default (10s)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/517899b8970002e59618788272d17ea1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-09T15:37:06+08:00" />
<meta property="article:modified_time" content="2020-04-09T15:37:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">prometheus应用与实践</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="prometheus_1"></a>prometheus应用与实践</h2> 
<h3><a id="_3"></a>一、架构</h3> 
<p><img src="https://images2.imgbox.com/bc/29/OxALse2O_o.png" alt="img"></p> 
<h3><a id="_7"></a>二、指标类型</h3> 
<h4><a id="1Counter_9"></a>1、Counter(计数器)</h4> 
<p>​ 特点： 只增不减，除非监控系统发生了重置。</p> 
<p>​ 适用场景：描述服务的请求数、已完成的任务数、错误发生的次数等 。</p> 
<p>​ API：</p> 
<pre><code>//将counter值加1.
increment(1L)
// 将指定值加到counter值上，如果指定值&lt;0 会发生异常.
increment(val)
</code></pre> 
<p>​ PromQL ：</p> 
<pre><code>//通过rate()函数获取HTTP请求量的增长率
rate(http_requests_total[5m])
//查询当前系统中，访问量前10的HTTP地址
topk(10, http_requests_total)
</code></pre> 
<h4><a id="2Guage_33"></a>2、Guage（仪表盘）</h4> 
<p>​ 特点： 可增可减 ，反映数据的实时性。</p> 
<p>​ 适用场景： 内存使用率这种指标数据，也可以表示能随时增加或减少的“总数”，例如：当前并发请求的数量</p> 
<p>​ API：</p> 
<pre><code>//将指定值赋予gauge值上
set(val)
</code></pre> 
<h4><a id="3_Histogram_46"></a>3、 Histogram（直方图）</h4> 
<p>​ 特点： 一段时间范围内对数据进行采样（通常是请求持续时间或响应大小等），并将其计入可配置的存储桶（bucket）中，后续可通过指定区间筛选样本，也可以统计样本总数，数据展示为直方图。</p> 
<p>​ 适用场景： 监控样本的分布情况。</p> 
<h4><a id="4_Summary_52"></a>4、 Summary（摘要）</h4> 
<p>​ 特点：对数据样本的简要描述（如：80%样本的平均响应时间为5s）</p> 
<p>​ 适用场景：性能的总结。</p> 
<h3><a id="_58"></a>三、案例</h3> 
<h4><a id="prometheus_60"></a>案例一：prometheus使用</h4> 
<pre><code>global:
  scrape_interval:     30s # 设置监测频率（默认1min）.
  evaluation_interval: 30s # 设置告警频率（默认1min）
  # scrape_timeout is set to the global default (10s).
scrape_configs:
  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.
  - job_name: 'prometheus'
    # Override the global default and scrape targets from this job every 5 seconds.
    scrape_interval: 5s
    static_configs:
      - targets: ['localhost:9090']
  - job_name: 'gateway'
    honor_labels: true
    static_configs:
      - targets: ['pushgateway:9091']
        labels:
          instance: node-244
  - job_name: 'consul'
    static_configs:
      - targets: ['10.150.27.241:9507']
        labels:
          instance: consul_241
  - job_name: 'ehl-stdp-monitor-wfycl'
    metrics_path: '/actuator/prometheus'
    scrape_interval: 300s
    static_configs:
    - targets: ['10.150.27.242:8079']

</code></pre> 
<h4><a id="springbootprometheus_api_93"></a>案例二：springboot集成prometheus api</h4> 
<h5><a id="1pom_95"></a>1.引入pom</h5> 
<pre><code>&lt;dependency&gt;
	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
	&lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
	&lt;groupId&gt;io.micrometer&lt;/groupId&gt;
	&lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre> 
<h5><a id="2_108"></a>2.配置参数</h5> 
<pre><code>management:
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      applicateion: ${spring.application.name}
  endpoints:
    web:
      exposure:
        include: "*"
</code></pre> 
<h5><a id="3_124"></a>3.初始化</h5> 
<pre><code>@Bean
MeterRegistryCustomizer&lt;MeterRegistry&gt; configurer(
        @Value("${spring.application.name}") String applicationName) {
    return (registry) -&gt; registry.config().commonTags("application", applicationName);
}
</code></pre> 
<h5><a id="4_134"></a>4.埋点</h5> 
<pre><code>import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.Metrics;

Public class Count {
//第一步：注入此方法
       @Autowired
       private MeterRegistry registry;
//第二步：编辑指标项
private static final Counter pushTotalOK = Counter.builder("kafka_consumer_passcar_2").description("卡口过车数据kafka消费成功").tags("topic",topic,"code", "1").register(registry);
    public void execute() {
        logger.info("视频专网kafka接收线程启动成功");
        while (true) {
            ConsumerRecords&lt;String,String&gt; records = consumer.poll(100);
            for (ConsumerRecord&lt;String,String&gt; record: records) {
                String content = record.value();
                PassCarKafkaReceiveLog.logger.info(content);
                //解析数据
                try{
                    StandardCar standardCar = StandardCarUtil.transformJsonString(content);
                    StandardCar passCar = transIpAndPort(standardCar);
                    if (passCar == null) {
                        return;
                    }
//第三步：在业务逻辑中嵌入改指标项。Count型默认累加1，还可以指定累加值
                     pushTotal.increment(1D);
                     passCarHandleFace.handle(passCar);
                }catch (Exception e){
                    logger.error(e.getMessage());
                }
            }
        }

    }
}
</code></pre> 
<h5><a id="5prometheusyml_173"></a>5.编写prometheus.yml</h5> 
<p>方案一：</p> 
<pre><code>  - job_name: 'ehl-stdp-kafkaTohttp-fi-motor'  //微服务application-name
    metrics_path: '/actuator/prometheus'
    scrape_interval: 5s  //抓取频率
    static_configs:
- targets: ['50.1.228.123:8745']  //微服务ip、port
</code></pre> 
<p>方案二：</p> 
<pre><code>  - job_name: 'consul'
    consul_sd_configs:
    - server:   '{<!-- -->{consul_host_ip}}:8500'
      services: ['efs-server']
    relabel_configs:
     - source_labels: [__metrics_path__]
       separator: ;
       regex: /metrics
       target_label: __metrics_path__
       replacement: /actuator/prometheus
       action: replace
</code></pre> 
<h4><a id="javasparkpushgateway_api_201"></a>案例三：java/spark集成pushgateway api</h4> 
<h5><a id="1_pom_203"></a>1. 引入pom</h5> 
<pre><code>&lt;dependency&gt;
	&lt;groupId&gt;io.prometheus&lt;/groupId&gt;
	&lt;artifactId&gt;simpleclient&lt;/artifactId&gt;
	&lt;version&gt;0.6.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- The client --&gt;
&lt;dependency&gt;
	&lt;groupId&gt;io.prometheus&lt;/groupId&gt;
	&lt;artifactId&gt;simpleclient_pushgateway&lt;/artifactId&gt;
	&lt;version&gt;0.6.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre> 
<h5><a id="2__219"></a>2. 埋点</h5> 
<pre><code>    public static void executeCountJob(String gatewayIpAndPort,String kkbh, Double total) throws Exception {
        CollectorRegistry registry = new CollectorRegistry();
		//埋点
        Gauge counterTotal = Gauge.build()
                .name("total_txll_" + kkbh)
                .help("卡口通行流量")
                .labelNames("device_tag", "monitor_tag", "token_tag")
                .register(registry);

        counterTotal.labels("kk_device", "gc_data", kkbh).set(total);

        PushGateway pg = new PushGateway("10.150.27.242:9591");
        pg.pushAdd(registry, "stdp_monitor_passcar_history24_job");
    }
</code></pre> 
<h3><a id="http__238"></a>四、http 接口</h3> 
<p>官网： https://prometheus.io/docs/prometheus/latest/querying/api/</p> 
<h4><a id="1_242"></a>1、实时数据</h4> 
<pre><code>//单一指标项查询
http://{0}:{1}/api/v1/query?query={2}
//指标项模糊查询
http://{0}:{1}/api/v1/query?query={__name__=~"{2}"}
//单一标签查询
http://{0}:{1}/api/v1/query?query={__name__=~"gauge_car_txll_mean30.*"}and{token_tag="2000000000000"}
//标签模糊查询
http://{0}:{1}/api/v1/query?query={__name__=~"gauge_car_txll_mean30.*"}and{token_tag=~"2000000000000|600041039000"}
</code></pre> 
<h4><a id="2_255"></a>2、历史数据</h4> 
<pre><code>//单一指标项查询
http://10.150.27.242:9527/api/v1/query_range?query="gauge_car_txll_mean30_2000000000000"&amp;start=2019-11-02T14:46:33Z&amp;end=2019-11-03T14:46:33Z&amp;step=60s
//指标项模糊查询
http://10.150.27.242:9527/api/v1/query_range?query={__name__=~"gauge_car_txll_mean30.*"}&amp;start=2019-11-02T14:46:33Z&amp;end=2019-11-03T14:46:33Z&amp;step=60s
//单一标签查询
http://10.150.27.242:9527/api/v1/query_range?query={__name__=~"gauge_car_txll_mean30.*"}and{token_tag="2000000000000"}&amp;start=2019-11-02T14:46:33Z&amp;end=2019-11-03T14:46:33Z&amp;step=60s
//标签模糊查询
http://10.150.27.242:9527/api/v1/query_range?query={__name__=~"gauge_car_txll_mean30.*"}and{token_tag=~"2000000000000|600041039000"}&amp;start=2019-11-02T14:46:33Z&amp;end=2019-11-03T14:46:33Z&amp;step=60s
</code></pre> 
<h4><a id="3_268"></a>3、案例分享</h4> 
<h3><a id="_270"></a>五、扩展</h3> 
<h4><a id="1PromQL_272"></a>1、PromQL语法/面板持久化</h4> 
<h4><a id="2consulmetrics_274"></a>2、consul统一管理metrics信息</h4> 
<h4><a id="3_276"></a>3、告警</h4>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/141e4cf9c6a4f2130c8501e955d9be6b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何将char转换为String？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/318e6fc0cb632c689c792a3b11af0409/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">达梦数据库 作业计划备份失败（错误-8007，备份文件创建失败）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>