<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Go 编码建议——风格篇 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Go 编码建议——风格篇" />
<meta property="og:description" content="文章目录 1.格式化主体风格占位符 2.代码行行长度换行方式不必要的空行括号和空格行数 3.字符串4.依赖管理依赖规范import 规范 5.初始化初始化 struct初始化 map初始化 slice申明变量避免使用 init() 6.错误处理书写风格error 处理panic 处理recover 处理类型断言 7.注释通用包注释函数注释结构体注释变量和常量注释类型注释接口注释 8.命名规范通用规则项目命名包命名文件命名函数命名结构体命名接口命名量命名通用常量命名 方法接收器命名错误命名避免使用内置名称 9.流程控制ifforrangeswitchreturngoto程序退出方式 10.函数入参&amp;返回值成员函数局部变量defer减少嵌套（圈复杂度）魔法字面量函数分组与顺序 11.单元测试12.杂项12.1 基本类型偏执通用场景结构体 12.2 单一职责包&amp;文件函数 12.3 goroutine12.4 应用服务12.5 常用工具 参考文献 !!! 提示：本文停止更新，内容已迁移至开源书籍 《Go 编码建议》，欢迎大家协同共建。
为形成统一的 Go 编码风格，提高代码的可读性、可靠性和易维护性，在官方 Google Go Code Review Comments 的基础上，给出编码风格建议。使用时，可根据实际情况进行了调整和补充。
1.格式化 主体风格 代码必须用 gofmt 工具格式化。 gofmt 使用制表符进行缩进，使用空白符进行对齐。
IDE 在保存代码时可设置自动执行 gofmt，如 GoLand 的 Settings &gt; Tools &gt; File Watchers 中可勾选 go fmt 并指定作用范围。
占位符 通过%v打印错误信息，%v前建议加冒号。 // Bad logger.Errorf(&#34;num %d, err %s&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/76d989bb32424259da19b119e91c3ec5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-28T17:05:11+08:00" />
<meta property="article:modified_time" content="2023-08-28T17:05:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Go 编码建议——风格篇</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1_6" rel="nofollow">1.格式化</a></li><li><ul><li><a href="#_7" rel="nofollow">主体风格</a></li><li><a href="#_16" rel="nofollow">占位符</a></li></ul> 
  </li><li><a href="#2_31" rel="nofollow">2.代码行</a></li><li><ul><li><a href="#_32" rel="nofollow">行长度</a></li><li><a href="#_40" rel="nofollow">换行方式</a></li><li><a href="#_51" rel="nofollow">不必要的空行</a></li><li><a href="#_96" rel="nofollow">括号和空格</a></li><li><a href="#_117" rel="nofollow">行数</a></li></ul> 
  </li><li><a href="#3_121" rel="nofollow">3.字符串</a></li><li><a href="#4_152" rel="nofollow">4.依赖管理</a></li><li><ul><li><a href="#_153" rel="nofollow">依赖规范</a></li><li><a href="#import__161" rel="nofollow">import 规范</a></li></ul> 
  </li><li><a href="#5_248" rel="nofollow">5.初始化</a></li><li><ul><li><a href="#_struct_249" rel="nofollow">初始化 struct</a></li><li><a href="#_map_324" rel="nofollow">初始化 map</a></li><li><a href="#_slice_362" rel="nofollow">初始化 slice</a></li><li><a href="#_441" rel="nofollow">申明变量</a></li><li><a href="#_init_601" rel="nofollow">避免使用 init()</a></li></ul> 
  </li><li><a href="#6_669" rel="nofollow">6.错误处理</a></li><li><ul><li><a href="#_670" rel="nofollow">书写风格</a></li><li><a href="#error__682" rel="nofollow">error 处理</a></li><li><a href="#panic__764" rel="nofollow">panic 处理</a></li><li><a href="#recover__846" rel="nofollow">recover 处理</a></li><li><a href="#_892" rel="nofollow">类型断言</a></li></ul> 
  </li><li><a href="#7_909" rel="nofollow">7.注释</a></li><li><ul><li><a href="#_916" rel="nofollow">通用</a></li><li><a href="#_923" rel="nofollow">包注释</a></li><li><a href="#_941" rel="nofollow">函数注释</a></li><li><a href="#_986" rel="nofollow">结构体注释</a></li><li><a href="#_1002" rel="nofollow">变量和常量注释</a></li><li><a href="#_1028" rel="nofollow">类型注释</a></li><li><a href="#_1039" rel="nofollow">接口注释</a></li></ul> 
  </li><li><a href="#8_1043" rel="nofollow">8.命名规范</a></li><li><ul><li><a href="#_1046" rel="nofollow">通用规则</a></li><li><a href="#_1069" rel="nofollow">项目命名</a></li><li><a href="#_1081" rel="nofollow">包命名</a></li><li><a href="#_1100" rel="nofollow">文件命名</a></li><li><a href="#_1104" rel="nofollow">函数命名</a></li><li><a href="#_1117" rel="nofollow">结构体命名</a></li><li><a href="#_1135" rel="nofollow">接口命名</a></li><li><a href="#_1158" rel="nofollow">量命名</a></li><li><ul><li><a href="#_1159" rel="nofollow">通用</a></li><li><a href="#_1235" rel="nofollow">常量命名</a></li></ul> 
   </li><li><a href="#_1248" rel="nofollow">方法接收器命名</a></li><li><a href="#_1253" rel="nofollow">错误命名</a></li><li><a href="#_1286" rel="nofollow">避免使用内置名称</a></li></ul> 
  </li><li><a href="#9_1350" rel="nofollow">9.流程控制</a></li><li><ul><li><a href="#if_1351" rel="nofollow">if</a></li><li><a href="#for_1527" rel="nofollow">for</a></li><li><a href="#range_1567" rel="nofollow">range</a></li><li><a href="#switch_1583" rel="nofollow">switch</a></li><li><a href="#return_1597" rel="nofollow">return</a></li><li><a href="#goto_1614" rel="nofollow">goto</a></li><li><a href="#_1617" rel="nofollow">程序退出方式</a></li></ul> 
  </li><li><a href="#10_1674" rel="nofollow">10.函数</a></li><li><ul><li><a href="#_1675" rel="nofollow">入参&amp;返回值</a></li><li><a href="#_1729" rel="nofollow">成员函数</a></li><li><a href="#_1733" rel="nofollow">局部变量</a></li><li><a href="#defer_1744" rel="nofollow">defer</a></li><li><a href="#_1785" rel="nofollow">减少嵌套（圈复杂度）</a></li><li><a href="#_1867" rel="nofollow">魔法字面量</a></li><li><a href="#_1899" rel="nofollow">函数分组与顺序</a></li></ul> 
  </li><li><a href="#11_1939" rel="nofollow">11.单元测试</a></li><li><a href="#12_2011" rel="nofollow">12.杂项</a></li><li><ul><li><a href="#121__2012" rel="nofollow">12.1 基本类型偏执</a></li><li><ul><li><a href="#_2015" rel="nofollow">通用场景</a></li><li><a href="#_2020" rel="nofollow">结构体</a></li></ul> 
   </li><li><a href="#122__2025" rel="nofollow">12.2 单一职责</a></li><li><ul><li><a href="#_2026" rel="nofollow">包&amp;文件</a></li><li><a href="#_2031" rel="nofollow">函数</a></li></ul> 
   </li><li><a href="#123_goroutine_2041" rel="nofollow">12.3 goroutine</a></li><li><a href="#124__2049" rel="nofollow">12.4 应用服务</a></li><li><a href="#125__2053" rel="nofollow">12.5 常用工具</a></li></ul> 
  </li><li><a href="#_2062" rel="nofollow">参考文献</a></li></ul> 
</div> 
<p></p> 
<p><strong>!!! 提示：本文停止更新，内容已迁移至开源书籍 <a href="https://dablelv.github.io/go-coding-advice/" rel="nofollow">《Go 编码建议》</a>，欢迎大家协同共建。</strong></p> 
<p>为形成统一的 Go 编码风格，提高代码的可读性、可靠性和易维护性，在官方 <a href="https://github.com/golang/go/wiki/CodeReviewComments">Google Go Code Review Comments</a> 的基础上，给出编码风格建议。使用时，可根据实际情况进行了调整和补充。</p> 
<h2><a id="1_6"></a>1.格式化</h2> 
<h3><a id="_7"></a>主体风格</h3> 
<ul><li>代码必须用 <a href="https://pkg.go.dev/cmd/gofmt" rel="nofollow">gofmt</a> 工具格式化。</li></ul> 
<p>gofmt 使用制表符进行缩进，使用空白符进行对齐。</p> 
<p>IDE 在保存代码时可设置自动执行 gofmt，如 GoLand 的 Settings &gt; Tools &gt; File Watchers 中可勾选 go fmt 并指定作用范围。</p> 
<img src="https://images2.imgbox.com/20/0c/SvYwXcNk_o.png" width="60%"> 
<h3><a id="_16"></a>占位符</h3> 
<ul><li>通过<code>%v</code>打印错误信息，<code>%v</code>前建议加冒号。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
logger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"num %d, err %s"</span><span class="token punctuation">,</span> num<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// Good</span>
logger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"num:%d, err:%v"</span><span class="token punctuation">,</span> num<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>字符串占位符，如果输入数据来自外部，建议使用<code>%q</code>进行安全转义。</li><li>格式化字符串中多个占位符之间需要有空格。</li></ul> 
<pre><code class="prism language-go">fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v这里要空格%v"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="2_31"></a>2.代码行</h2> 
<h3><a id="_32"></a>行长度</h3> 
<p>一行代码不要超过<strong>120</strong>列，超过的情况，使用合理的方法换行。</p> 
<p>例外场景：</p> 
<ul><li>import 模块语句</li><li>struct tag</li><li>工具生成的代码</li></ul> 
<h3><a id="_40"></a>换行方式</h3> 
<p>采用惰性换行，换行前应尽可能占满当前行不留空位。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v %v %v %v %v %v %v %v %v %v %v %v %v %v\n"</span><span class="token punctuation">,</span>
<span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span><span class="token number">89</span><span class="token punctuation">,</span> <span class="token number">144</span><span class="token punctuation">,</span> <span class="token number">233</span><span class="token punctuation">)</span>

<span class="token comment">// Good</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v %v %v %v %v %v %v %v %v %v %v %v %v %v\n"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span>
<span class="token number">89</span><span class="token punctuation">,</span> <span class="token number">144</span><span class="token punctuation">,</span> <span class="token number">233</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_51"></a>不必要的空行</h3> 
<ul><li>函数体第一行不要换行。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">// func body</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// func body</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>函数调用和对调用结果的处理，是紧密相连的，不能加空行</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
res<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> res<span class="token punctuation">.</span>Ret <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
res<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> res<span class="token punctuation">.</span>Ret <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>return 语句前不要换行</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// func body</span>
	
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// func body</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_96"></a>括号和空格</h3> 
<ul><li>遵循 gofmt 的逻辑。</li><li>运算符和操作数之间要留空格。</li><li>作为输入参数或者数组下标时，运算符和操作数之间不需要空格，紧凑展示。</li></ul> 
<pre><code class="prism language-go"><span class="token keyword">var</span> i <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">2</span> 					<span class="token comment">// 运算符和操作数之间要留空格</span>
v <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">{<!-- --></span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">}</span><span class="token punctuation">[</span>i<span class="token operator">-</span>i<span class="token punctuation">]</span>  <span class="token comment">// i-i 作为下标不留空格</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%f\n"</span><span class="token punctuation">,</span> v<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>				<span class="token comment">// v+1 作为入参不要留空格</span>
</code></pre> 
<ul><li>不要添加没必要的括号。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">if</span> foo <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">if</span> foo <span class="token operator">&amp;&amp;</span> <span class="token function">int</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_117"></a>行数</h3> 
<ul><li>函数长度不能超过 80 行。</li><li>文件长度不能超过 800 行。</li></ul> 
<h2><a id="3_121"></a>3.字符串</h2> 
<ul><li>字符串字面量<br> Go 支持使用<a href="https://golang.org/ref/spec#raw_string_lit" rel="nofollow">原始字符串字面值</a>，可以使用反引号来表示原生字符串。在需要转义的场景下，我们应该尽量使用使用反引号表示字符串，避免转义。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
wantError <span class="token operator">:=</span> <span class="token string">"unknown name:\"test\""</span>

<span class="token comment">// Good</span>
wantError <span class="token operator">:=</span> <span class="token string">`unknown error:"test"`</span>
</code></pre> 
<ul><li>不要使用字符串表示 list 和 map 结构。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">var</span> Receivers <span class="token operator">=</span> <span class="token string">"tom,jerry,spike"</span>

<span class="token comment">// Good</span>
<span class="token keyword">var</span> Receivers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"tom"</span><span class="token punctuation">,</span><span class="token string">"jerry"</span><span class="token punctuation">,</span><span class="token string">"spike"</span><span class="token punctuation">}</span>
</code></pre> 
<ul><li>字符串拼接</li></ul> 
<p>行内字符串拼接时，出于性能的考虑，待拼接字符串数量较少（&lt;=3）且不涉及类型转换时，使用运算符 + 而非<code>fmt.Sprintf()</code>。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
str <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"rsp code is %v"</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
str <span class="token operator">:=</span> <span class="token string">"rsp code is "</span> <span class="token operator">+</span> code <span class="token string">" and msg is"</span> <span class="token operator">+</span> msg  

<span class="token comment">// Good</span>
str <span class="token operator">:=</span> <span class="token string">"rsp code is "</span> <span class="token operator">+</span> code
str <span class="token operator">:=</span>  fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"rsp code is %v and msg is %v"</span><span class="token punctuation">,</span> code<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="4_152"></a>4.依赖管理</h2> 
<h3><a id="_153"></a>依赖规范</h3> 
<ul><li>go1.11 以上必须使用 go modules 模式。</li></ul> 
<pre><code class="prism language-go"><span class="token keyword">go</span> mod init git<span class="token punctuation">.</span>code<span class="token punctuation">.</span>oa<span class="token punctuation">.</span>com<span class="token operator">/</span>group<span class="token operator">/</span>myrepo
</code></pre> 
<ul><li>使用 go modules 作为依赖管理的项目不要提交 vendor 目录。</li><li>使用 go modules 管理依赖的项目， <code>go.sum</code>文件必须提交，不要添加到<code>.gitignore</code>规则中。</li></ul> 
<h3><a id="import__161"></a>import 规范</h3> 
<ul><li>使用 <a href="https://pkg.go.dev/golang.org/x/tools@v0.1.10/cmd/goimports" rel="nofollow">goimports</a> 工具自动格式化引入的包名，import 规范原则上以 goimports 规则为准。</li></ul> 
<p><a href="https://pkg.go.dev/golang.org/x/tools@v0.1.10/cmd/goimports" rel="nofollow">goimports</a> 会自动添加依赖的包，并移除未引用的包。把依赖包按字母序升序排列，并对包进行分组管理。通过空行隔开，默认分为标准库包和非标准库包（第三方包和内部包）。</p> 
<ul><li>导入的包按照先后顺序应该分为三组： 
  <ul><li>标准包</li><li>外部包</li><li>内部包</li></ul> </li></ul> 
<p>带域名的包名都属于外部包，如 <code>github.com/xxx/xxx</code>。内部包是指不能被外部 import 的包。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"os"</span>
	<span class="token string">"go.uber.org/atomic"</span>
	<span class="token string">"golang.org/x/sync/errgroup"</span>
	<span class="token string">"myproject/models"</span>
    <span class="token string">"myproject/controller"</span>
<span class="token punctuation">)</span>

<span class="token comment">// Good</span>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"encoding/json"</span>
    <span class="token string">"strings"</span>
	
	<span class="token string">"go.uber.org/atomic"</span>
	<span class="token string">"golang.org/x/sync/errgroup"</span>
	
	<span class="token string">"myproject/models"</span>
    <span class="token string">"myproject/controller"</span>
<span class="token punctuation">)</span>
</code></pre> 
<ul><li>不要使用相对路径导入内部包，应该使用完整的路径引入包。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"../net"</span>
<span class="token punctuation">)</span>

<span class="token comment">// Good</span>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"xxxx.com/proj/net"</span>
<span class="token punctuation">)</span>
</code></pre> 
<ul><li>必要时给包起个别名</li></ul> 
<p>包名和 git 路径名不一致时，或者多个相同包名冲突时，使用别名代替会有更好的可读性。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	elastic <span class="token string">"github.com/olivere/elastic/v7"</span>
<span class="token punctuation">)</span>

<span class="token comment">// Good</span>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	elastic <span class="token string">"github.com/olivere/elastic/v7"</span>
<span class="token punctuation">)</span>
</code></pre> 
<ul><li>通用的功能包，应该放在 public 目录下，而不是具体业务目录下。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">import</span> <span class="token string">"github.com/xxxxxxxx/XXXServer/pkg/formatlog"</span>

<span class="token comment">// Good</span>
<span class="token keyword">import</span> <span class="token string">"github.com/xxxxxxxx/utils/formatlog"</span>
</code></pre> 
<ul><li><code>import .</code> 只能用于测试文件，且必须是为了解决循环依赖，才能使用。</li></ul> 
<pre><code class="prism language-go"><span class="token keyword">package</span> foo_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bar/testutil"</span> <span class="token comment">// also imports "foo"</span>
	<span class="token punctuation">.</span> <span class="token string">"foo"</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>在这种情况下，测试文件不能在包 foo 中，因为它使用 bar/testutil，后者导入 foo。所以我们使用<code>import .</code>形式导入包 foo，让测试文件假装是包 foo 的一部分，尽管它不是。除了这一种情况，不要使用<code>import .</code>，因为它使程序难以阅读，比如使用 Baz 这样的标识符，不知道其是顶级标识符还是导入包中的顶级标识符。</p> 
<ul><li>引入第三方包要慎重。</li></ul> 
<p>如引入 Github 上的包要确认活跃度，不知名的包可能会被下架或出现不兼容的版本升级情况，必要情况下可 fork 一份。</p> 
<pre><code class="prism language-go"><span class="token comment">// 该包已经 404 了。</span>
github<span class="token punctuation">.</span>com<span class="token operator">/</span>astaxie<span class="token operator">/</span>beego<span class="token operator">/</span>orm
</code></pre> 
<h2><a id="5_248"></a>5.初始化</h2> 
<h3><a id="_struct_249"></a>初始化 struct</h3> 
<ul><li>字面量初始化结构体时指明字段名。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
k <span class="token operator">:=</span> User<span class="token punctuation">{<!-- --></span><span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token string">"Doe"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span>

<span class="token comment">// Good</span>
k <span class="token operator">:=</span> User<span class="token punctuation">{<!-- --></span>
    FirstName<span class="token punctuation">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span>
    LastName<span class="token punctuation">:</span> <span class="token string">"Doe"</span><span class="token punctuation">,</span>
    Admin<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>例外：如果有 <strong>3</strong> 个或更少的字段，则可以在测试表中省略字段名称。</p> 
<pre><code class="prism language-go">tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
  op Operation
  want <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">{<!-- --></span>Add<span class="token punctuation">,</span> <span class="token string">"add"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>Subtract<span class="token punctuation">,</span> <span class="token string">"subtract"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>省略结构中的零值字段。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
user <span class="token operator">:=</span> User<span class="token punctuation">{<!-- --></span>
  FirstName<span class="token punctuation">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span>
  LastName<span class="token punctuation">:</span> <span class="token string">"Doe"</span><span class="token punctuation">,</span>
  MiddleName<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  Admin<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
user <span class="token operator">:=</span> User<span class="token punctuation">{<!-- --></span>
  FirstName<span class="token punctuation">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span>
  LastName<span class="token punctuation">:</span> <span class="token string">"Doe"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>例外：在字段名提供有意义上下文的地方可以显示指定零值。如表驱动单元测试中的测试用例，即使字段为零值，限制指定零值，通过字段名可清晰地表达用例的含义。</p> 
<pre><code class="prism language-go">tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
  give <span class="token builtin">string</span>
  want <span class="token builtin">int</span>
<span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">{<!-- --></span>give<span class="token punctuation">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span> want<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>声明零值结构使用关键字 var。</li></ul> 
<p>如果在声明中省略了结构的所有字段，请使用 var 声明结构，因为这样更加简洁，其各个字段值为字段类型对应的零值。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
user <span class="token operator">:=</span> User<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">var</span> user User
</code></pre> 
<ul><li>初始化结构指针变量使用字面量</li></ul> 
<p>初始化结构指针变量时，请使用<code>&amp;T{}</code>代替<code>new(T)</code>，与结构体初始化保持一致的代码风格。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
sval <span class="token operator">:=</span> T<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> <span class="token string">"foo"</span><span class="token punctuation">}</span>

<span class="token comment">// inconsistent</span>
sptr <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>
sptr<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">"bar"</span>

<span class="token comment">// Good</span>
sval <span class="token operator">:=</span> T<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> <span class="token string">"foo"</span><span class="token punctuation">}</span>

sptr <span class="token operator">:=</span> <span class="token operator">&amp;</span>T<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> <span class="token string">"bar"</span><span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_map_324"></a>初始化 map</h3> 
<p>初始化 map 优先使用 make() 函数而不是字面量，因为这样看起来更容易和申明区分开来。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">var</span> <span class="token punctuation">(</span>
  <span class="token comment">// m1 读写安全</span>
  <span class="token comment">// m2 在写入时会 panic</span>
  m1 <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span>T1<span class="token punctuation">]</span>T2<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  m2 <span class="token keyword">map</span><span class="token punctuation">[</span>T1<span class="token punctuation">]</span>T2
<span class="token punctuation">)</span>
<span class="token comment">// 声明和初始化在视觉上很相似</span>

<span class="token comment">// Good</span>
<span class="token keyword">var</span> <span class="token punctuation">(</span>
  <span class="token comment">// m1 读写安全</span>
  <span class="token comment">// m2 在写入时会 panic</span>
  m1 <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>T1<span class="token punctuation">]</span>T2<span class="token punctuation">)</span>
  m2 <span class="token keyword">map</span><span class="token punctuation">[</span>T1<span class="token punctuation">]</span>T2
<span class="token punctuation">)</span>
<span class="token comment">// 声明和初始化在视觉上是不同的</span>
</code></pre> 
<p>尽可能的情况下，请在初始化时提供 map 容量大小。</p> 
<p>例外：如果 map 包含固定的元素列表，则使用字面量初始化 map，这样可以在初始化时指定元素。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>T1<span class="token punctuation">]</span>T2<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
m<span class="token punctuation">[</span>k1<span class="token punctuation">]</span> <span class="token operator">=</span> v1
m<span class="token punctuation">[</span>k2<span class="token punctuation">]</span> <span class="token operator">=</span> v2
m<span class="token punctuation">[</span>k3<span class="token punctuation">]</span> <span class="token operator">=</span> v3

<span class="token comment">// Good</span>
m <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span>T1<span class="token punctuation">]</span>T2<span class="token punctuation">{<!-- --></span>
  k1<span class="token punctuation">:</span> v1<span class="token punctuation">,</span>
  k2<span class="token punctuation">:</span> v2<span class="token punctuation">,</span>
  k3<span class="token punctuation">:</span> v3<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_slice_362"></a>初始化 slice</h3> 
<ul><li>非零值 slice 使用<code>make()</code>初始化，并指定容量。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
nums <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token comment">// Good</span>
nums <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> CAP<span class="token punctuation">)</span>
</code></pre> 
<ul><li>空切片使用 var 声明</li></ul> 
<p>不管是全局切片还是局部切片，使用 var 申明 nil 切片，代码会更加简洁清晰。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 长度为 0 的非 nil 切片</span>
	nums <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// nil 切片</span>
	<span class="token keyword">var</span> nums <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>nil 是一个有效的 slice。</li></ul> 
<p>nil 是一个有效的长度为 0 的 slice，这意味着，</p> 
<p>（1）不应明确返回长度为零的切片，应该返回 nil 来代替。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（2）要检查切片是否为空，请始终使用 len(s) == 0 而非 nil。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span>s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> s <span class="token operator">==</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span>s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（3）零值切片（用 var 声明的切片）可立即使用，无需调用 make() 创建。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
nums <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token comment">// or, nums := make([]int)</span>

<span class="token keyword">if</span> add1 <span class="token punctuation">{<!-- --></span>
  nums <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> add2 <span class="token punctuation">{<!-- --></span>
  nums <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">var</span> nums <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>

<span class="token keyword">if</span> add1 <span class="token punctuation">{<!-- --></span>
  nums <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> add2 <span class="token punctuation">{<!-- --></span>
  nums <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>记住，虽然 nil 切片是有效的切片，但它不等于长度为 0 的切片（一个为 nil，另一个不是），并且在不同的情况下（例如序列化），这两个切片的处理方式可能不同。</p> 
<h3><a id="_441"></a>申明变量</h3> 
<ul><li>就近申明：变量申明的位置尽量靠近使用的地方。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span>m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	info<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> m<span class="token punctuation">[</span><span class="token string">"key"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span>Info<span class="token punctuation">)</span>
	<span class="token operator">...</span>
	<span class="token keyword">return</span> <span class="token function">handle</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span>m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
	info<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> m<span class="token punctuation">[</span><span class="token string">"key"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span>Info<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token function">handle</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>相似的声明放在一组。</li></ul> 
<p>对于变量、常量的声明，相似的声明应该放在一组。类型的定义同样适用。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token number">2</span>

<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token number">2</span>

<span class="token keyword">type</span> Area <span class="token builtin">float64</span>
<span class="token keyword">type</span> Volume <span class="token builtin">float64</span>

<span class="token comment">// Good</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
  a <span class="token operator">=</span> <span class="token number">1</span>
  b <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
  c <span class="token operator">=</span> <span class="token number">1</span>
  d <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> <span class="token punctuation">(</span>
  Area <span class="token builtin">float64</span>
  Volume <span class="token builtin">float64</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>仅将相关的声明放在一组，不要将不相关的声明放在一组。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">type</span> Operation <span class="token builtin">int</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
  Add Operation <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token operator">+</span> <span class="token number">1</span>
  Subtract
  Multiply
  EnvVar <span class="token operator">=</span> <span class="token string">"MY_ENV"</span>
<span class="token punctuation">)</span>

<span class="token comment">// Good</span>
<span class="token keyword">type</span> Operation <span class="token builtin">int</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
  Add Operation <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token operator">+</span> <span class="token number">1</span>
  Subtract
  Multiply
<span class="token punctuation">)</span>

<span class="token keyword">const</span> EnvVar <span class="token operator">=</span> <span class="token string">"MY_ENV"</span>
</code></pre> 
<p>另外，分组使用的位置没有限制，如我们也可以在函数内部使用它们。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
  red <span class="token operator">:=</span> color<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">0xff0000</span><span class="token punctuation">)</span>
  green <span class="token operator">:=</span> color<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">0x00ff00</span><span class="token punctuation">)</span>
  blue <span class="token operator">:=</span> color<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">0x0000ff</span><span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">var</span> <span class="token punctuation">(</span>
    red   <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">0xff0000</span><span class="token punctuation">)</span>
    green <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">0x00ff00</span><span class="token punctuation">)</span>
    blue  <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">0x0000ff</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>全局变量申明使用 var 关键字并省略类型。</li></ul> 
<p>全局变量使用 var 关键字申明，一般情况下其类型与表达式的类型一致，这种情况下可省略其类型。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">var</span> s <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token function">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token string">"A"</span> <span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token comment">// 由于 F 已经明确了返回一个字符串类型，因此我们没有必要显式指定类型。</span>
<span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token function">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token string">"A"</span> <span class="token punctuation">}</span>
</code></pre> 
<p>如果表达式的类型与所需的类型不完全匹配，请指定类型。</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> myError <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>myError<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token string">"error"</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span> myError <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> myError<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">}</span>

<span class="token comment">// F 返回一个 myError 类型的实例，但是我们要 error 类型。</span>
<span class="token keyword">var</span> _e <span class="token builtin">error</span> <span class="token operator">=</span> <span class="token function">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>局部变量使用短变量声明形式（<code>:=</code>）。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">"foo"</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	s <span class="token operator">:=</span> <span class="token string">"foo"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（1）例外：如果是相似的一组变量，请使用 var 声明到一组。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	s1 <span class="token operator">:=</span> <span class="token string">"foo"</span>
	s2 <span class="token operator">:=</span> <span class="token string">"bar"</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		s1 <span class="token operator">=</span> <span class="token string">"foo"</span>
		s2 <span class="token operator">=</span> <span class="token string">"bar"</span>
	<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（2）例外：局部零值变量使用 var。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	i <span class="token operator">:=</span> <span class="token function">in64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 冗余显示指明 0。</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> i <span class="token builtin">int64</span>	<span class="token comment">// 默认为相应类型的零值。</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>如果全局变量仅在单个函数内使用，则应该定义为局部变量。</li></ul> 
<h3><a id="_init_601"></a>避免使用 init()</h3> 
<p>尽可能避免使用 init()，当 init() 不可避免时，init() 应该做到：<br> （1）无论程序环境或调用如何，行为都必须是完全确定的；<br> （2）避免依赖其他 init() 函数的顺序或副作用。虽然 init() 顺序是明确的，但代码可以更改， 因此 init() 函数之间的关系可能会使代码变得脆弱和容易出错；<br> （3）避免访问或操作全局变量和环境状态，如机器信息、环境变量、工作目录、程序参数/输入等；<br> （4）避免 I/O，包括文件系统、网络和系统调用。</p> 
<p>不能满足这些要求的代码可能要在 main() 函数中被调用（或程序生命周期中的其他地方），或作为 main() 函数本身的一部分。特别是打算给其他程序使用的库应该特别注意代码行为的完全确定性， 而不是执行“init magic”。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">type</span> Foo <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> _defaultFoo Foo
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _defaultFoo <span class="token operator">=</span> Foo<span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">var</span> _defaultFoo <span class="token operator">=</span> Foo<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token comment">// 或者为了更好的可测试性</span>
<span class="token keyword">var</span> _defaultFoo <span class="token operator">=</span> <span class="token function">defaultFoo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">defaultFoo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Foo <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> Foo<span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Bad</span>
<span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> _config Config
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Bad: 基于当前目录</span>
    cwd<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// Bad: I/O</span>
    raw<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>
        path<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token string">"config.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    yaml<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_config<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">loadConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Config <span class="token punctuation">{<!-- --></span>
    cwd<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// handle err</span>
    raw<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>
        path<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token string">"config.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// handle err</span>
    <span class="token keyword">var</span> config Config
    yaml<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">)</span>
    <span class="token keyword">return</span> config
<span class="token punctuation">}</span>
</code></pre> 
<p>凡事无绝对，在某些情况下，init() 可能更可取或是必要的：<br> （1）不能表示为单个赋值的复杂表达式；<br> （2）可插入的钩子，如 database/sql、编码类型注册表等；<br> （3）对 <a href="https://cloud.google.com/functions/docs/bestpractices/tips#use_global_variables_to_reuse_objects_in_future_invocations" rel="nofollow">Google Cloud Functions</a> 和其他形式的确定性预计算的优化。</p> 
<h2><a id="6_669"></a>6.错误处理</h2> 
<h3><a id="_670"></a>书写风格</h3> 
<ul><li>与标准库风格保持一致，首字母小写且不加结束标点符号。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">var</span> ErrRecordNotFound <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Record not found"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ErrRecordNotFound <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"record not found."</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ErrRecordNotFound <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Record not found."</span><span class="token punctuation">)</span>

<span class="token comment">// Good</span>
<span class="token keyword">var</span> ErrRecordNotFound <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"record not found"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="error__682"></a>error 处理</h3> 
<ul><li>需显示处理 error。</li></ul> 
<p>如果 error 作为函数的值返回，必须对 error 进行处理，或使用空白标识符忽略。对于<code>defer xx.Close()</code>可以不用显式处理。</p> 
<ul><li>error 作为函数的返回值且有多个返回值的时候，error 必须是最后一个参数</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">do</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">do</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>采用独立的错误流进行处理。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// handle error</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// normal code</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// handle error</span>
    <span class="token keyword">return</span> <span class="token comment">// or continue, etc.</span>
<span class="token punctuation">}</span>
<span class="token comment">// normal code</span>
</code></pre> 
<ul><li>Fail Fast 原则。</li></ul> 
<p>如果出现失败应该立即返回error，如果继续处理，则属于特殊情况需要添加注释。</p> 
<ul><li>如果函数返回值需用于初始化其他变量，则采用下面的方式。</li></ul> 
<pre><code class="prism language-go">x<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// error handling</span>
    <span class="token keyword">return</span> <span class="token comment">// or continue, etc.</span>
<span class="token punctuation">}</span>
<span class="token comment">// use x</span>
</code></pre> 
<ul><li>错误判断独立处理，不与其他变量组合判断。</li></ul> 
<p>一个可能引发的问题就是 err 如果为 nil，但是满足其他逻辑进入到 if 块内，读取 err 值将引发 panic。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> y <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> err   <span class="token comment">// 当y与err都为空时，函数的调用者会出现错误的调用逻辑</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
<span class="token keyword">if</span> y <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"some error"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>生成带参数的 error 使用 fmt.Errorf。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"module xxx: %v"</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// Good</span>
fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"module xxx: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
</code></pre> 
<ul><li>不要包装系统调用错误，并给出一些没意义的附加信息。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
err <span class="token operator">:=</span> exe<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"run error %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">return</span> exe<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="panic__764"></a>panic 处理</h3> 
<ul><li>不要随便 panic。</li></ul> 
<p>在业务逻辑处理中禁止使用 panic。因为 panic 是级联失败（cascading failures）的主要根源。如果发生错误，该函数应该返回错误，让调用方决定如何处理它。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">run</span><span class="token punctuation">(</span>args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"an argument is required"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">run</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">run</span><span class="token punctuation">(</span>args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"an argument is required"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">run</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>panic/recover 不是错误处理的合适策略，仅当发生不可恢复的异常（如 nil 引用）时，才可以 panic。</p> 
<p>在 main 包中程序初始化是一个例外，如程序启动时，文件无法打开或数据库无法连接导致程序无法正常运行可使用 panic。</p> 
<p>对于其它的包，可导出的接口也不能有 panic。</p> 
<ul><li>在 main 包中使用 log.Fatal 或 log.Fatalf 结束程序而不是 panic。</li></ul> 
<p>如果 main 中需要使用 panic，建议使用 log.Fatal 或 log.Fatalf 来取代 panic，因为这样可以记录错误的同时结束程序，方便排查问题。</p> 
<ul><li>panic 只能在当前 Goroutine 被捕获。</li></ul> 
<p>panic 捕获最晚要在当前 Goroutine 最顶层将其捕获，在其他 Goroutine 中无法捕获当前 Goroutine 的 panic。每个自行启动的 Goroutine，必须在入口处捕获 panic，并打印详细堆栈信息或进行其它处理。</p> 
<p>下面是一个反面示例，其他 Goroutine 中无法捕获当前 Goroutine 的 panic。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"======begin work======"</span><span class="token punctuation">)</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"nil pointer exception"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"======after work======"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>程序将意外终止并输出：</p> 
<pre><code>======begin work======
panic: nil pointer exception

goroutine 6 [running]:
main.main.func2()
        /Users/dablelv/work/code/test/main.go:16 +0x65
created by main.main
        /Users/dablelv/work/code/test/main.go:14 +0x48
</code></pre> 
<h3><a id="recover__846"></a>recover 处理</h3> 
<ul><li>recover 用于捕获 runtime 的异常，禁止滥用 recover。</li><li>recover 只有在 defer 中调用才会生效。</li></ul> 
<p>必须在 defer 中使用，一般用来捕获程序运行期间发生异常抛出的 panic 或程序主动抛出的 panic。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"log"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// do something or record log</span>
            log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exec panic error: "</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token comment">// log.Println(debug.Stack())</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">)</span> <span class="token comment">//手动抛出 panic</span>
<span class="token punctuation">}</span>

<span class="token comment">// getOne 模拟 slice 越界运行时抛出的 panic。</span>
<span class="token keyword">func</span> <span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// do something or record log</span>
            log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exec panic error: "</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token comment">// log.Println(debug.Stack())</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">}</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello,"</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行结果：</p> 
<pre><code>2022/03/27 10:48:42 exec panic error:  runtime error: index out of range [4] with length 3
2022/03/27 10:48:42 exec panic error:  44
</code></pre> 
<h3><a id="_892"></a>类型断言</h3> 
<ul><li>类型断言使用 comma ok 式</li></ul> 
<p>类型断言的单个返回值形式如果断言失败将产生 panic。因此，请始终使用 comma ok 式。如果不关心是否成功，ok 可显示使用空标识符（下划线）忽略。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
t <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>

<span class="token comment">// Good</span>
t<span class="token punctuation">,</span> ok <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 优雅地处理错误。</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果不关心是否成功，可显示忽略 ok。</span>
t<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="7_909"></a>7.注释</h2> 
<p>在编码阶段同步写好类型、变量、函数、包注释，注释可以通过<code>godoc</code>导出生成文档。</p> 
<p>程序中每一个被导出的（大写的）名字，都应该有一个文档注释。</p> 
<p>所有注释掉的代码在提交 Code Review 前都应该被删除，除非添加注释讲解为什么不删除， 并且标明后续处理建议（比如删除计划）。</p> 
<h3><a id="_916"></a>通用</h3> 
<ul><li>不要用注释删除代码。</li><li>// 后面要有空格。</li><li>中英文之间应该有空格。</li><li>特殊实现需要注释。</li><li>注释结束添加点或句号，参考标准库源码注释。</li></ul> 
<h3><a id="_923"></a>包注释</h3> 
<ul><li>每个包都应该有一个包注释。</li><li>包如果有多个 go 文件，只需要出现在一个 go 文件中（一般是和包同名的文件）即可。</li><li>格式为：“// Package 包名 包信息描述”。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Package math provides basic constants and mathematical functions.</span>
<span class="token keyword">package</span> math

<span class="token comment">// 或者</span>

<span class="token comment">/*
Package template implements data-driven templates for generating textual
output such as HTML.
....
*/</span>
<span class="token keyword">package</span> template
</code></pre> 
<h3><a id="_941"></a>函数注释</h3> 
<ul><li>导出的函数和方法（结构体或接口下的函数称为方法）都必须有注释。</li></ul> 
<p>注释描述函数或方法功能、调用方等信息。格式为：“// 函数名 函数信息描述”。</p> 
<p>注意，如果方法的接收器为不可导出类型，可以不注释，但需要质疑该方法可导出的必要性。</p> 
<pre><code class="prism language-go"><span class="token comment">// NewtAttrModel 是属性数据层操作类的工厂方法</span>
<span class="token keyword">func</span> <span class="token function">NewAttrModel</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>common<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token operator">*</span>AttrModel <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// TODO</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>避免参数语义不明确。</li></ul> 
<p>函数调用中意义不明确的实参可能会损害代码可读性。当参数名称的含义不明显时，请为参数添加 C 样式注释 (<code>/* ... */</code>)</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token comment">// func printInfo(name string, isLocal, done bool)</span>
<span class="token function">printInfo</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

<span class="token comment">// Good </span>
<span class="token comment">// func printInfo(name string, isLocal, done bool)</span>
<span class="token function">printInfo</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* isLocal */</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* done */</span><span class="token punctuation">)</span>
</code></pre> 
<p>对于上面的示例代码，还有一种更好的处理方式是将上面的 bool 类型换成自定义类型。将来，该参数可以支持不仅仅局限于两个状态（true/false）。</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Region <span class="token builtin">int</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
  UnknownRegion Region <span class="token operator">=</span> <span class="token boolean">iota</span>
  Local
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Status <span class="token builtin">int</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
  StatusReady Status<span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token operator">+</span> <span class="token number">1</span>
  StatusDone
  <span class="token comment">// Maybe we will have a StatusInProgress in the future.</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">printInfo</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> region Region<span class="token punctuation">,</span> status Status<span class="token punctuation">)</span>
</code></pre> 
<ul><li>非导出的函数，如果比较简单，不需要注释。</li><li>解析函数应该注明解析字符串的范例，并明确不能处理的异常情况。</li></ul> 
<h3><a id="_986"></a>结构体注释</h3> 
<ul><li>每个需要导出的自定义结构体或者接口都必须有注释说明。</li></ul> 
<p>注释对结构进行简要介绍，放在结构体定义的前一行。格式为：“// 结构体名 结构体信息描述”。</p> 
<ul><li>必要情况下字段给出注释。</li></ul> 
<p>结构体内的可导出成员变量名，如果是个生僻词或意义不明确的词，必须要单独给出注释，放在成员变量的前一行或同一行的末尾。</p> 
<pre><code class="prism language-go"><span class="token comment">// User 用户结构定义了用户基础信息</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    Name  <span class="token builtin">string</span>
    Email <span class="token builtin">string</span>
    Demographic <span class="token builtin">string</span> <span class="token comment">// 族群</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_1002"></a>变量和常量注释</h3> 
<ul><li>每个需要导出的变量和常量都必须有注释说明。</li></ul> 
<p>注释对变量和常量进行简要介绍，放在常量或变量定义的前一行。独行注释格式为：“// 变量名 描述”，斜线后面紧跟一个空格。</p> 
<pre><code class="prism language-go"><span class="token comment">// FlagConfigFile 配置文件的命令行参数名。</span>
<span class="token keyword">const</span> FlagConfigFile <span class="token operator">=</span> <span class="token string">"--config"</span>

<span class="token comment">// FullName 返回指定用户名的完整名称。</span>
<span class="token keyword">var</span> FullName <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>username <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"fake-%s"</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>大块变量或常量定义时的注释方式。</li></ul> 
<p>块注释即在代码块前给出一个总的说明，然后每行变量或常量的末尾给出详细注释，这样看起来更加简洁。</p> 
<pre><code class="prism language-go"><span class="token comment">// 命令行参数。</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
    FlagConfigFile1 <span class="token operator">=</span> <span class="token string">"--config"</span> <span class="token comment">// 配置文件的命令行参数名 1。</span>
    FlagConfigFile2 <span class="token operator">=</span> <span class="token string">"--config"</span> <span class="token comment">// 配置文件的命令行参数名 2。</span>
    FlagConfigFile3 <span class="token operator">=</span> <span class="token string">"--config"</span> <span class="token comment">// 配置文件的命令行参数名 3。</span>
    FlagConfigFile4 <span class="token operator">=</span> <span class="token string">"--config"</span> <span class="token comment">// 配置文件的命令行参数名 4。</span>
<span class="token punctuation">)</span>
</code></pre> 
<ul><li>命名清晰的地方，不要添加无意义的注释。</li></ul> 
<h3><a id="_1028"></a>类型注释</h3> 
<ul><li>每个需要导出的类型定义（type definition）和类型别名（type aliases）都必须有注释说明。</li><li>该注释对类型进行简要介绍，放在定义的前一行。</li><li>格式为：“// 类型名 描述”。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// StorageClass 存储类型</span>
<span class="token keyword">type</span> StorageClass <span class="token builtin">string</span>

<span class="token comment">// FakeTime 标准库时间的类型别名</span>
<span class="token keyword">type</span> FakeTime <span class="token operator">=</span> time<span class="token punctuation">.</span>Time
</code></pre> 
<h3><a id="_1039"></a>接口注释</h3> 
<ul><li>导出与非导出接口均需要有注释。</li><li>需要描述谁，在什么场景下，如何使用接口。</li></ul> 
<h2><a id="8_1043"></a>8.命名规范</h2> 
<p>命名是代码规范中很重要的一部分，统一的命名规范有利于提高代码的可读性，好的命名仅仅通过命名就可以获取到足够多的信息。</p> 
<h3><a id="_1046"></a>通用规则</h3> 
<ul><li> <p>不要用宽泛、无意义的名字，如：</p> 
  <ul><li>util</li><li>helper</li><li>info</li><li>common</li></ul> </li><li> <p>缩略语要么全小写，要么全大写。</p> </li></ul> 
<pre><code>// Bad
Md5
Uid

// Good
MD5
md5
UID
uid
</code></pre> 
<ul><li>非缩略语则应该使用驼峰命名。</li><li>不要使用2/4来表达英文 to/for。</li><li>如无必要，不要起和包相同的名字。</li></ul> 
<h3><a id="_1069"></a>项目命名</h3> 
<ul><li>小写，如果有多个单词使用连字符分隔。</li></ul> 
<pre><code class="prism language-shell">// Bad
GoEcharts
goecharts
goEcharts

// Good
go-echarts
</code></pre> 
<h3><a id="_1081"></a>包命名</h3> 
<ul><li>保持 package 的名字和目录一致。</li><li>尽量采取有意义、简短的包名，尽量不要和标准库冲突。</li><li>包名应该为小写单词，不要使用下划线或者混合大小写，使用多级目录来划分层级。</li><li>简单明了的包命名，如：time、list、http。</li><li>不用复数。如 net/url 而不是net/urls。</li><li>包名谨慎使用缩写。当缩写是程序员广泛熟知的词时，可以使用缩写。例如： 
  <ul><li>strconv (string conversion)</li></ul> 
  <ul><li>syscall (system call)</li><li>fmt (formatted I/O)</li></ul> </li><li>不要使用大而全的无意义包名。</li></ul> 
<p>如 <code>util、common、misc、global</code>。package 名字应该追求清晰且越来越收敛，符合‘单一职责’原则，而不是像<code>common</code>一样，什么都能往里面放，越来越膨胀，让依赖关系变得复杂，不利于阅读、复用、重构。注意，<code>xxx/utils/encryption</code>这样的包名是允许的。</p> 
<ul><li>只有一个源文件的包，包名应该和文件名保持一致。</li><li>不要轻易使用别名。</li></ul> 
<p>更多可参考 <a href="https://blog.golang.org/package-names" rel="nofollow">Package names - The Go Blog</a> 和 <a href="https://rakyll.org/style-packages/" rel="nofollow">Style guideline for Go packages</a>。</p> 
<h3><a id="_1100"></a>文件命名</h3> 
<ul><li>采用有意义、简短的文件名。</li><li>文件名应该采用小写，并且使用下划线分割各个单词。</li></ul> 
<h3><a id="_1104"></a>函数命名</h3> 
<ul><li>函数名必须遵循驼峰式，首字母根据访问控制决定使用大写或小写。</li><li>代码生成工具自动生成的代码可排除此规则（如协议生成文件 xxx.pb.go，<a href="https://github.com/cweill/gotests">gotests</a> 工具自动生成文件 xxx_test.go 里面的下划线）。</li><li>函数应该以动词开头。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">panicLinesParsing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f VerifyFlow<span class="token punctuation">)</span> <span class="token function">DataETL</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> datas <span class="token punctuation">[</span><span class="token punctuation">]</span>Data<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">parsePanicLines</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f VerifyFlow<span class="token punctuation">)</span> <span class="token function">ETLData</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> datas <span class="token punctuation">[</span><span class="token punctuation">]</span>Data<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_1117"></a>结构体命名</h3> 
<ul><li>采用驼峰命名方式，首字母根据访问控制采用大写或者小写。</li><li>结构体名应该是名词或名词短语，如 Customer、WikiPage、Account、AddressParser，它不应是动词。</li><li>避免使用 Data、Info 这类意义太宽泛的结构体名。</li><li>结构体的定义和初始化格式采用多行。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// User 多行定义。</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    Name  <span class="token builtin">string</span>
    Email <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// 多行初始化。</span>
u <span class="token operator">:=</span> User<span class="token punctuation">{<!-- --></span>
    UserName<span class="token punctuation">:</span> <span class="token string">"john"</span><span class="token punctuation">,</span>
    Email<span class="token punctuation">:</span>    <span class="token string">"john@example.com"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_1135"></a>接口命名</h3> 
<ul><li>命名规则基本保持和结构体命名规则一致。</li><li>单个函数的接口名以 er 作为后缀，例如 Reader，Writer。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Reader 字节数组读取接口。</span>
<span class="token keyword">type</span> Reader <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Read 读取整个给定的字节数据并返回读取的长度</span>
    <span class="token function">Read</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>两个函数的接口名综合两个函数名。</li><li>三个以上函数的接口名，类似于结构体名。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Car 小汽车结构申明。</span>
<span class="token keyword">type</span> Car <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Start ...</span>
    <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>
    <span class="token comment">// Stop ...</span>
    <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token comment">// Recover ...</span>
    <span class="token function">Recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_1158"></a>量命名</h3> 
<h4><a id="_1159"></a>通用</h4> 
<ul><li>量名不应该以类型作为前缀/后缀。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// map</span>
filterHandlerMap <span class="token operator">-</span><span class="token operator">&gt;</span> opToHandler

<span class="token comment">// slice</span>
uidSlice <span class="token operator">-</span><span class="token operator">&gt;</span> uids

<span class="token comment">// array</span>
uidArray <span class="token operator">-</span><span class="token operator">&gt;</span> uids 

<span class="token comment">// 二维切片或数组。</span>
<span class="token comment">// 比如多个班级下的学生ID。</span>
uidSliceSlice <span class="token operator">-</span><span class="token operator">&gt;</span> classesUIDs
</code></pre> 
<ul><li>量名应该是名词，进行时和过去式可以做形容词，成为量名的一部分。</li><li>特有名词时，需遵循以下规则： 
  <ul><li>如果变量为私有，且特有名词为首个单词，则使用小写，如 apiClient；</li><li>其他情况都应该使用该名词原有的写法，如 APIClient、repoID、UserID；</li><li>错误示例：UrlArray，应该写成 urlArray 或者 URLArray；</li><li>详细的专有名词列表可参考<a href="https://github.com/golang/lint/blob/738671d3881b9731cc63024d5d88cf28db875626/lint.go#L770">这里</a>。</li></ul> </li><li>尽量不要用拼音命名。</li><li>量名遵循驼峰式，根据是否导出决定首字母大小写。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// 导出全局变量。</span>
<span class="token keyword">var</span> AppVersion <span class="token operator">=</span> <span class="token string">"1.0.0"</span>
<span class="token comment">// 未导出全局变量。</span>
<span class="token keyword">var</span> appVersion <span class="token operator">=</span> <span class="token string">"1.0.0"</span>

<span class="token comment">// 导出全局常量。</span>
<span class="token keyword">const</span> AppVersion <span class="token operator">=</span> <span class="token string">"1.0.0"</span>
<span class="token comment">// 未导出全局常量。</span>
<span class="token keyword">const</span> appVersion <span class="token operator">=</span> <span class="token string">"1.0.0"</span>
</code></pre> 
<ul><li>若量类型为 bool 类型，则名称应以 Has，Is，Can 或 Allow 等单词开头。</li><li>私有量和局部量规范一致，均以小写字母开头。</li><li>作用域较小的名字（局部变量/函数参数），尽量使用简短的名字。</li></ul> 
<p>如 c 比 lineCount 要好，i 比 sliceIndex 要好。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
lineCount <span class="token operator">:=</span> <span class="token function">getlineCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> sliceIndex <span class="token operator">:=</span> <span class="token keyword">range</span> msgs <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
c <span class="token operator">:=</span> <span class="token function">getlineCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> msgs <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>作用域较大的名字（全局变量），不要使用缩写，要有明确的意义。</li></ul> 
<p>如 lineCount 要比 c 好，sliceIndex 要比 i 好。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">var</span> c<span class="token punctuation">,</span> i <span class="token builtin">int</span>

<span class="token comment">// Good</span>
<span class="token keyword">var</span> lineCount<span class="token punctuation">,</span> sliceIndex <span class="token builtin">int</span>
</code></pre> 
<ul><li>全局量中不要包含格式化字符，否则必然违反就近原则。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">var</span> <span class="token punctuation">(</span>
	tGitHost     <span class="token operator">=</span> <span class="token string">"https://git.code.oa.com"</span>
	mrCommitsUri <span class="token operator">=</span> <span class="token string">"/api/v3/projects/%s/merge_request/%s/commits"</span>
<span class="token punctuation">)</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">getMRCommitsUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"/api/v3/projects/%s/merge_request/%s/commits"</span><span class="token punctuation">,</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token string">"bar"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1235"></a>常量命名</h4> 
<ul><li>如果是枚举类型的常量，需要先创建相应类型：</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Scheme 传输协议。</span>
<span class="token keyword">type</span> Scheme <span class="token builtin">string</span>

<span class="token comment">// 传输协议。</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
    HTTP Scheme <span class="token operator">=</span> <span class="token string">"http"</span> 	<span class="token comment">// HTTP 明文传输协议</span>
    HTTPS Scheme <span class="token operator">=</span> <span class="token string">"https"</span> 	<span class="token comment">// HTTPS 加密传输协议</span>
<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_1248"></a>方法接收器命名</h3> 
<ul><li>推荐以类名第一个英文首字母的小写作为接收器的命名。</li><li>接收器的名称在函数超过 20 行的时候不要用单字符。</li><li>命名不能采用 me，this，self 这类易混淆名称。</li></ul> 
<h3><a id="_1253"></a>错误命名</h3> 
<p>对于存储为全局变量的错误值，根据是否导出，使用前缀 Err 或 err。</p> 
<pre><code class="prism language-go"><span class="token keyword">var</span> <span class="token punctuation">(</span>
  <span class="token comment">// 导出以下两个错误，以便此包的用户可以将它们与errors.Is 进行匹配。</span>
  ErrBrokenLink <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"link is broken"</span><span class="token punctuation">)</span>
  ErrCouldNotOpen <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"could not open"</span><span class="token punctuation">)</span>

  <span class="token comment">// 这个错误没有被导出，因为我们不想让它成为我们公共 API 的一部分。</span>
  errNotFound <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"not found"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>对于自定义错误类型，请改用后缀 Error。</p> 
<pre><code class="prism language-go"><span class="token comment">// 这个错误被导出，以便这个包的用户可以将它与 errors.As 匹配。</span>
<span class="token keyword">type</span> NotFoundError <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
  File <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>NotFoundError<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"file %q not found"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>File<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 这个错误没有被导出，因为我们不想让它成为公共 API 的一部分。</span>
<span class="token comment">// 但我们仍然可以在的包内将其和 errors.As 一起使用。</span>
<span class="token keyword">type</span> resolveError <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
  Path <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>resolveError<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"resolve %q"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_1286"></a>避免使用内置名称</h3> 
<p>Go 语言规范 <a href="https://golang.org/ref/spec" rel="nofollow">language specification</a> 概述了几个内置的，不应在 Go 项目中使用的标识符<a href="https://golang.org/ref/spec#Predeclared_identifiers" rel="nofollow">predeclared identifiers</a>。</p> 
<pre><code>Types:
	bool byte complex64 complex128 error float32 float64
	int int8 int16 int32 int64 rune string
	uint uint8 uint16 uint32 uint64 uintptr

Constants:
	true false iota

Zero value:
	nil

Functions:
	append cap close complex copy delete imag len
	make new panic print println real recover
</code></pre> 
<p>在使用预先分配的标识符时编译器不会报告错误，但是诸如<code>go vet</code>之类的工具会正确地指出这些和其他情况下的隐式问题。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token comment">// 作用域内隐式覆盖 error interface</span>
<span class="token keyword">var</span> <span class="token builtin">error</span> <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">handleErrorMessage</span><span class="token punctuation">(</span><span class="token builtin">error</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 作用域隐藏内置 error</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Foo <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 虽然这些使用内置标识符的自定义字段可以编译通过，但对 error 或 string 字符串的搜索存在二义性</span>
    <span class="token builtin">error</span>  <span class="token builtin">error</span>
    <span class="token builtin">string</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f Foo<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// error 和 f.error 在视觉上是相似的</span>
    <span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f Foo<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// string and f.string 在视觉上是相似的</span>
    <span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">var</span> errorMessage <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">handleErrorMessage</span><span class="token punctuation">(</span>msg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Foo <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// error 和 string 现在是明确的</span>
    err <span class="token builtin">error</span>
    str <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f Foo<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> f<span class="token punctuation">.</span>err
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f Foo<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> f<span class="token punctuation">.</span>str
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="9_1350"></a>9.流程控制</h2> 
<h3><a id="if_1351"></a>if</h3> 
<ul><li>最小化变量作用域。</li></ul> 
<p>if 接受初始化语句，尽可能缩小变量作用域。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
err <span class="token operator">:=</span> file<span class="token punctuation">.</span><span class="token function">Chmod</span><span class="token punctuation">(</span><span class="token number">0664</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> file<span class="token punctuation">.</span><span class="token function">Chmod</span><span class="token punctuation">(</span><span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre> 
<p>如果需要在 if 之外使用函数调用的结果，则不应尝试缩小范围。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">if</span> data<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
  err <span class="token operator">=</span> cfg<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>

  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
data<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token keyword">if</span> err <span class="token operator">:=</span> cfg<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> err
<span class="token punctuation">}</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token boolean">nil</span>
</code></pre> 
<ul><li>if 对两个值进行判断时，被比较的值放在左边。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">if</span> <span class="token boolean">nil</span> <span class="token operator">!=</span> err <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// error handling</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">==</span> errorCode <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// do something</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// error handling</span>
<span class="token punctuation">}</span>   
<span class="token keyword">if</span> errorCode <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// do something</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>if 对于 bool 类型的变量，应直接进行真假判断。</li></ul> 
<pre><code class="prism language-go"><span class="token keyword">var</span> allowUserLogin <span class="token builtin">bool</span>
<span class="token comment">// Bad</span>
<span class="token keyword">if</span> allowUserLogin <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// do something</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> allowUserLogin <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// do something</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">if</span> allowUserLogin <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// do something</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token operator">!</span>allowUserLogin <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// do something</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>不必要的 else。</li></ul> 
<p>如果在 if 的两个分支中都设置变量，则可以将其替换为单个 if。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">var</span> a <span class="token builtin">int</span>
<span class="token keyword">if</span> b <span class="token punctuation">{<!-- --></span>
  a <span class="token operator">=</span> <span class="token number">100</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
  a <span class="token operator">=</span> <span class="token number">10</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
a <span class="token operator">:=</span> <span class="token number">10</span>
<span class="token keyword">if</span> b <span class="token punctuation">{<!-- --></span>
  a <span class="token operator">=</span> <span class="token number">100</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>又如 if else 通常可以简写为 if return。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">Foo</span><span class="token punctuation">(</span>bar <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> bar <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// ...</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// ...</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> bar <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// ...</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>多个相似 if 用 switch 替换。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> key <span class="token operator">==</span> pathKey <span class="token punctuation">{<!-- --></span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> key <span class="token operator">==</span> urlKey <span class="token punctuation">{<!-- --></span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">switch</span> key <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> pathKey<span class="token punctuation">:</span>
		<span class="token operator">...</span>
	<span class="token keyword">case</span> urlKey<span class="token punctuation">:</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>使用 == “” 判断字符串是否为空，这样更加直观。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">if</span> str <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>把简单的逻辑判断放前面，复杂的逻辑判断放后面。</li><li>不要使用双重否定。</li><li>判断条件较为复杂时，考虑封装成函数。</li><li>使用了 else if 则需要以 else 结束。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">if</span> foo <span class="token operator">==</span> <span class="token string">"a"</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> foo <span class="token operator">==</span> <span class="token string">"b"</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">if</span> foo <span class="token operator">==</span> <span class="token string">"a"</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> foo <span class="token operator">==</span> <span class="token string">"b"</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 需要有一个缺省处理逻辑</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="for_1527"></a>for</h3> 
<ul><li>最小化变量作用域。</li></ul> 
<p>for 接受初始化语句，尽可能缩小变量作用域。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
sum <span class="token operator">:=</span> <span class="token number">0</span>
i <span class="token operator">:=</span> <span class="token number">0</span>
<span class="token keyword">for</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
    sum <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
sum <span class="token operator">:=</span> <span class="token number">0</span>
<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
    sum <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>循环变量的地址不要存储。</li></ul> 
<p>循环变量的地址指向的是同一个变量，我们可以通过赋值给一个同名的变量，通过变量逃逸，来达到取不同地址的目的。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ints <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> ints <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v<span class="token punctuation">)</span> <span class="token comment">// 打印的是相同的地址</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ints <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> ints <span class="token punctuation">{<!-- --></span>
		v <span class="token operator">:=</span> v
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v<span class="token punctuation">)</span> <span class="token comment">// 打印的是不同的地址</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="range_1567"></a>range</h3> 
<ul><li>如果只需要第一项（key），就丢弃第二个（value）。</li></ul> 
<pre><code class="prism language-go"><span class="token keyword">for</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> key<span class="token punctuation">.</span><span class="token function">expired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">delete</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>如果只需要第二项，则把第一项置为空标识符（下划线）。</li></ul> 
<pre><code class="prism language-go">sum <span class="token operator">:=</span> <span class="token number">0</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> array <span class="token punctuation">{<!-- --></span>
    sum <span class="token operator">+=</span> v
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="switch_1583"></a>switch</h3> 
<ul><li>必须要有 default。</li></ul> 
<pre><code class="prism language-go"><span class="token keyword">switch</span> os <span class="token operator">:=</span> runtime<span class="token punctuation">.</span>GOOS<span class="token punctuation">;</span> os <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token string">"darwin"</span><span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"MAC OS"</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token string">"linux"</span><span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Linux."</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token comment">// freebsd, openbsd,</span>
        <span class="token comment">// plan9, windows...</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s.\n"</span><span class="token punctuation">,</span> os<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="return_1597"></a>return</h3> 
<ul><li>尽早 return，一旦有错误发生，马上返回。</li></ul> 
<pre><code class="prism language-go">f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

d<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token function">codeUsing</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> d<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="goto_1614"></a>goto</h3> 
<p>业务代码禁止使用 goto，其他框架或底层源码推荐尽量不用。</p> 
<h3><a id="_1617"></a>程序退出方式</h3> 
<ul><li>使用<code>os.Exit</code>或者<code>log.Fatal*</code>退出程序，而不是<code>panic</code>。</li><li>在 main() 中退出程序且只退出一次。</li></ul> 
<p>仅在 main() 函数中调用<code>os.Exit</code>或<code>log.Fatal*</code>且只调用一次。如果有多个错误场景停止程序执行，请将该逻辑放在单独的函数并从中返回错误。 这会精简<code>main()</code>函数，并将所有关键业务逻辑放入一个单独的、可测试的函数中。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">package</span> main
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  args <span class="token operator">:=</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"missing file"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  name <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 如果我们调用 log.Fatal f.Close 将不会被执行</span>
  b<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">package</span> main
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
  args <span class="token operator">:=</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"missing file"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  name <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>
  <span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  b<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当程序的多个函数具有退出能力时会存在一些问题：<br> （1）不明显的控制流：任何函数都可以退出程序，因此很难对控制流进行推理；<br> （2）难以测试：退出程序的函数也将退出调用它的测试，这使得函数很难测试，并跳过了尚未被运行的其他代码；<br> （3）跳过清理：当函数退出程序时，会跳过已经进入 defer 队列里的函数调用，这增加了跳过重要清理任务的风险。</p> 
<h2><a id="10_1674"></a>10.函数</h2> 
<h3><a id="_1675"></a>入参&amp;返回值</h3> 
<ul><li>入参和返回值均以小写字母开头。</li><li>入参和返回值个数均不能超过 <strong>5</strong> 个，如果超过，请封装成新的类型。</li><li>尽量用值传递，非指针传递。</li><li>类型为 map，slice，chan，interface 不要传递指针。</li><li>返回值超过 3 个，或有相同类型的返回值，或者从上下文中不清楚返回值的含义，使用命名返回，其它情况不建议使用命名返回。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Parent1 ...</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>Node<span class="token punctuation">)</span> <span class="token function">Parent1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Node

<span class="token comment">// Parent2 ...</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>Node<span class="token punctuation">)</span> <span class="token function">Parent2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

<span class="token comment">// Location ...</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>Foo<span class="token punctuation">)</span> <span class="token function">Location</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>lat<span class="token punctuation">,</span> long <span class="token builtin">float64</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>入参和返回值顺序根据关联性排在一起。</li><li>尽量用 error 表示执行是否成功，而不是用 bool 或者 int。</li><li>表示执行状态的返回值应该放在最后。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
ret<span class="token punctuation">,</span> info <span class="token operator">:=</span> <span class="token function">ModifyUserInfo</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>

<span class="token comment">// Good</span>
info<span class="token punctuation">,</span> ret <span class="token operator">:=</span> <span class="token function">ModifyUserInfo</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
</code></pre> 
<ul><li>不要返回多个用于控制流程的状态。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
isContinue<span class="token punctuation">,</span> retCode <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">processUnity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Good</span>
retCode <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">processUnity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>如果传入的参数通常是固定的，考虑通过实现多个函数实现默认参数。</li></ul> 
<p>如下面这个函数的第二个参数是没有必要的，大部分时候都是 +1，一个 IncCounter() 和一个 IncCounterN() 即可。可参考标准库包的 Split() 和 SplitN()。</p> 
<pre><code class="prism language-go">metrics<span class="token punctuation">.</span><span class="token function">IncrCounter</span><span class="token punctuation">(</span>cntCacheMissKey<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>批量查询函数返回值使用 slice 还是 map。</li></ul> 
<p>有时后我们需要根据多个 ID 查询对应的值，可能会出现部分失败的情况，如某个 ID 不存在。如果不允许部分失败，使用 slice 返回值，如果允许部分失败使用 map。</p> 
<pre><code class="prism language-go"><span class="token comment">// GetUserInfoBatch 批量获取用户信息（需全部成功）。</span>
<span class="token keyword">func</span> <span class="token function">GetUserInfoBatch</span><span class="token punctuation">(</span>uids <span class="token operator">...</span><span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>UserInfo<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">// GetUserInfoBatch 批量获取用户信息（允许部分失败）。</span>
<span class="token keyword">func</span> <span class="token function">GetUserInfoBatch</span><span class="token punctuation">(</span>uids <span class="token operator">...</span><span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint64</span><span class="token punctuation">]</span>UserInfo<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_1729"></a>成员函数</h3> 
<ul><li>如果方法不使用类的成员，应该实现为非成员函数。</li><li>如果非成员函数要使用类的多个属性时，应该实现为成员函数。</li></ul> 
<h3><a id="_1733"></a>局部变量</h3> 
<ul><li>如果局部变量仅被使用一次，且不能起到解释逻辑的作用时，应该删除局部变量，直接内联。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
ids <span class="token operator">:=</span> <span class="token function">GetIDs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">Foo</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span>

<span class="token comment">// Good</span>
<span class="token function">Foo</span><span class="token punctuation">(</span><span class="token function">GetIDs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="defer_1744"></a>defer</h3> 
<ul><li>当存在资源管理时，应紧跟 defer 函数进行资源的释放。</li><li>判断是否有错误发生之后，再 defer 释放资源。</li></ul> 
<pre><code class="prism language-go">resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
<span class="token comment">// 如果操作成功，再 defer Close()</span>
<span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>禁止在循环中使用 defer，举例如下：</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// 不要这样使用</span>
<span class="token keyword">func</span> <span class="token function">filterSomething</span><span class="token punctuation">(</span>values <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> values <span class="token punctuation">{<!-- --></span>
        fields<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token comment">// 示例，实际不要这么查询，防止 SQL 注入</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">defer</span> fields<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 继续使用fields</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 应当使用如下的方式：</span>
<span class="token keyword">func</span> <span class="token function">filterSomething</span><span class="token punctuation">(</span>values <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> values <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            fields<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token comment">// 示例，实际不要这么查询，防止 SQL 注入</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">defer</span> fields<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 继续使用 fields</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>正常逻辑不应该在 defer 中执行。</li></ul> 
<h3><a id="_1785"></a>减少嵌套（圈复杂度）</h3> 
<ul><li>嵌套深度不能超过<strong>4层</strong>。</li></ul> 
<p>从函数名开始算第一层，当函数的嵌套深度超过<strong>4层</strong>，往往会导致圈复杂度过高，函数变得复杂不可读，我们可以通过拆分函数的方式来减少嵌套深度。</p> 
<pre><code class="prism language-go"><span class="token comment">// AddArea 添加成功或出错</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>BookingService<span class="token punctuation">)</span> <span class="token function">AddArea</span><span class="token punctuation">(</span>areas <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    s<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> s<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> area <span class="token operator">:=</span> <span class="token keyword">range</span> areas <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> has <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>areas <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> area <span class="token operator">==</span> has <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> srverr<span class="token punctuation">.</span>ErrAreaConflict
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        s<span class="token punctuation">.</span>areas <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>areas<span class="token punctuation">,</span> area<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>areaOrders<span class="token punctuation">[</span>area<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>AreaOrder<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 建议调整为这样：</span>

<span class="token comment">// AddArea 添加成功或出错</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>BookingService<span class="token punctuation">)</span> <span class="token function">AddArea</span><span class="token punctuation">(</span>areas <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    s<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> s<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> area <span class="token operator">:=</span> <span class="token keyword">range</span> areas <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">HasArea</span><span class="token punctuation">(</span>area<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> srverr<span class="token punctuation">.</span>ErrAreaConflict
        <span class="token punctuation">}</span>
        s<span class="token punctuation">.</span>areas <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>areas<span class="token punctuation">,</span> area<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>areaOrders<span class="token punctuation">[</span>area<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>AreaOrder<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// HasArea ...</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>BookingService<span class="token punctuation">)</span> <span class="token function">HasArea</span><span class="token punctuation">(</span>area <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> has <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>areas <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> area <span class="token operator">==</span> has <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>单函数圈复杂度最大值 &lt;=10。</li><li>条件不满足或出现错误应尽早返回。</li></ul> 
<p>代码也可以优先处理条件不满足或错误的情况，尽早返回或继续循环来减少嵌套。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> data <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> v<span class="token punctuation">.</span>F1 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
    v <span class="token operator">=</span> <span class="token function">process</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
      v<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Invalid v: %v"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> data <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> v<span class="token punctuation">.</span>F1 <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Invalid v: %v"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
    <span class="token keyword">continue</span>
  <span class="token punctuation">}</span>

  v <span class="token operator">=</span> <span class="token function">process</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>
  v<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_1867"></a>魔法字面量</h3> 
<ul><li>除了 0 和 1，不要使用魔法数字。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token function">getArea</span><span class="token punctuation">(</span>r <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token number">3.14</span> <span class="token operator">*</span> r <span class="token operator">*</span> r
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">getLength</span><span class="token punctuation">(</span>r <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token number">3.14</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">*</span> r
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token comment">// PI 圆周率</span>
<span class="token keyword">const</span> PI <span class="token operator">=</span> <span class="token number">3.14</span>

<span class="token keyword">func</span> <span class="token function">getArea</span><span class="token punctuation">(</span>r <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> PI <span class="token operator">*</span> r <span class="token operator">*</span> r
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">getLength</span><span class="token punctuation">(</span>r <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> PI <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">*</span> r
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>如果字符串字面量出现 <strong>&gt;=2</strong> 次，则禁止使用，用一个有名称的常量代替，可读性更好。</li></ul> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
rsp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// Good</span>
<span class="token keyword">const</span> JsonContentType <span class="token operator">=</span> <span class="token string">"application/json"</span>
rsp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_1899"></a>函数分组与顺序</h3> 
<ul><li>函数应该放在 <code>struct</code>, <code>const</code>, <code>var</code>的后面。</li><li>构造函数应该放在其他函数之前，如<code>newXYZ()/NewXYZ()</code>。</li><li>导出的函数应该放在非导出函数前面</li><li>同一文件中的函数应按接收者分组。</li><li>由于函数是按接收者分组的，因此普通工具函数应在文件末尾出现。</li><li>函数应按粗略的调用顺序排序。</li></ul> 
<p>按照上面的规则，下面给出好坏文件内容布局示例。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>something<span class="token punctuation">)</span> <span class="token function">Cost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token function">calcCost</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>weights<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> something <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">calcCost</span><span class="token punctuation">(</span>n <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>something<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>something <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>something<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Good</span>
<span class="token keyword">type</span> something <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>something <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>something<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>something<span class="token punctuation">)</span> <span class="token function">Cost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token function">calcCost</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>weights<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>something<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">calcCost</span><span class="token punctuation">(</span>n <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span><span class="token operator">...</span><span class="token punctuation">}</span>
</code></pre> 
<h2><a id="11_1939"></a>11.单元测试</h2> 
<ul><li>单元测试文件名命名规范为 example_test.go。</li><li>测试用例的函数名称必须以 Test 开头，例如 TestExample。</li><li>单测文件行数限制是普通文件的 2 倍（1600 行）。单测函数行数限制也是普通函数的2倍（160行）。圈复杂度、列数限制、 import 分组等其他规范细节和普通文件保持一致。</li><li>由于单测文件内的函数都是不对外的，所有可导出函数可以没有注释，但是结构体定义时尽量不要导出。</li><li>每个重要的可导出函数都要首先编写测试用例，测试用例和正规代码一起提交方便进行回归测试。</li><li>表驱动测试.</li></ul> 
<p>使用表驱动的方式编写用例，代码看上去会更简洁。</p> 
<pre><code class="prism language-go"><span class="token comment">// Bad</span>
<span class="token comment">// func TestSplitHostPort(t *testing.T)</span>

host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span><span class="token string">"192.0.2.0:8000"</span><span class="token punctuation">)</span>
require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"192.0.2.0"</span><span class="token punctuation">,</span> host<span class="token punctuation">)</span>
assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"8000"</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span>

host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> err <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span><span class="token string">"192.0.2.0:http"</span><span class="token punctuation">)</span>
require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"192.0.2.0"</span><span class="token punctuation">,</span> host<span class="token punctuation">)</span>
assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"http"</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span>

host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> err <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span><span class="token string">":8000"</span><span class="token punctuation">)</span>
require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> host<span class="token punctuation">)</span>
assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"8000"</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span>

host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> err <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span><span class="token string">"1:8"</span><span class="token punctuation">)</span>
require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> host<span class="token punctuation">)</span>
assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span>

<span class="token comment">// Good</span>
<span class="token comment">// func TestSplitHostPort(t *testing.T)</span>

tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
  give     <span class="token builtin">string</span>
  wantHost <span class="token builtin">string</span>
  wantPort <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">{<!-- --></span>
    give<span class="token punctuation">:</span>     <span class="token string">"192.0.2.0:8000"</span><span class="token punctuation">,</span>
    wantHost<span class="token punctuation">:</span> <span class="token string">"192.0.2.0"</span><span class="token punctuation">,</span>
    wantPort<span class="token punctuation">:</span> <span class="token string">"8000"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    give<span class="token punctuation">:</span>     <span class="token string">"192.0.2.0:http"</span><span class="token punctuation">,</span>
    wantHost<span class="token punctuation">:</span> <span class="token string">"192.0.2.0"</span><span class="token punctuation">,</span>
    wantPort<span class="token punctuation">:</span> <span class="token string">"http"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    give<span class="token punctuation">:</span>     <span class="token string">":8000"</span><span class="token punctuation">,</span>
    wantHost<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    wantPort<span class="token punctuation">:</span> <span class="token string">"8000"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    give<span class="token punctuation">:</span>     <span class="token string">"1:8"</span><span class="token punctuation">,</span>
    wantHost<span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
    wantPort<span class="token punctuation">:</span> <span class="token string">"8"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tt <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{<!-- --></span>
  t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>give<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>give<span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>wantHost<span class="token punctuation">,</span> host<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>wantPort<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="12_2011"></a>12.杂项</h2> 
<h3><a id="121__2012"></a>12.1 基本类型偏执</h3> 
<p>有时候你会看到某个类里有很多基本类型字段，但是你隐约地能区分出某些字段好像应该在一起，如手机号和带区号的电话号码、描述某个日期范围的开始日期和结束日期，它们应该有一个真实的载体，如联系方式类和时间范围类，而不应全部零散放在一个大类型中。</p> 
<h4><a id="_2015"></a>通用场景</h4> 
<ul><li>复杂的执行/错误信息，需要定义结构体保存。</li><li>出现状态/类型等字眼时，需要使用枚举。</li><li>时间类型尽量使用内置定义，如 time.Second，不要使用 int。</li></ul> 
<h4><a id="_2020"></a>结构体</h4> 
<ul><li>一个文件中出现多个结构体时，需要注意观察是否有重复的成员。</li><li>一个结构体中，成员较多，且多个成员有明显关联关系，需要封装新的结构体。</li><li>意义不明的成员变量，应该定义类型描述作用。</li></ul> 
<h3><a id="122__2025"></a>12.2 单一职责</h3> 
<h4><a id="_2026"></a>包&amp;文件</h4> 
<ul><li>需要判断当前文件是否应该归属于当前包，主要以职责进行判断。</li><li>导出的函数/变量的职责必须与包&amp;文件职责高度一致。</li><li>除了包的主逻辑文件中内容允许导出，包内的辅助函数都应该是非导出的。</li></ul> 
<h4><a id="_2031"></a>函数</h4> 
<ul><li>一个函数只负责一个职责。 
  <ul><li>配置文件的读取，和对象初始化应该分开，不要让对象自己根据配置文件初始化，保证构造函数足够简单</li><li>解析、校验、计算的逻辑应该进行分离</li><li>读、写、计算的逻辑应该进行分离</li><li>rpc、db 相关操作需要独立封装</li></ul> </li><li>一个函数内不应该混杂多个实现细节，需要将独立的逻辑封装成函数。</li><li>一次循环尽量只做一件事，不用担心多次循环。</li><li>同一层级的逻辑细节不要拆分。</li></ul> 
<h3><a id="123_goroutine_2041"></a>12.3 goroutine</h3> 
<ul><li>启动的 goroutine 最好有 recover。</li></ul> 
<p>因为其他 goroutine 是无法捕当前 goroutine 抛出的异常。如果启动的 goroutine 没有 recover，很容易发生 panic 导致整个进程退出。</p> 
<ul><li>遇到 goroutine一定要梳理清楚 goroutine 的退出机制，防止泄漏。</li><li>如果要开启多个线程执行一组动作，并且要等待全部完成后继续后续逻辑，考虑使用 <a href="https://pkg.go.dev/golang.org/x/sync/errgroup" rel="nofollow">errgroup.Group</a>。</li></ul> 
<h3><a id="124__2049"></a>12.4 应用服务</h3> 
<ul><li>应用服务建议有 README.md 说明文档，介绍服务功能、使用方法、部署时的限制与要求、基础环境依赖等</li><li>应用服务必须要有接口测试</li></ul> 
<h3><a id="125__2053"></a>12.5 常用工具</h3> 
<p>Go 本身在代码规范方面做了很多努力，很多限制都是语法要求，例如左大括号不换行，引用的包或者定义的变量不使用会报错。此外 Go 还是提供了很多好用的工具帮助我们进行代码的规范。</p> 
<ul><li>gofmt ，大部分的格式问题可以通过 gofmt 解决， gofmt 自动格式化代码，保证所有的 go 代码与官方推荐的格式保持一致，于是所有格式有关问题，都以 gofmt 的结果为准。</li><li>goimports ，此工具在 gofmt 的基础上增加了自动删除和引入包。</li><li>go vet ，vet 工具可以帮我们静态分析我们的源码存在的各种问题，例如多余的代码，提前 return 的逻辑， struct 的 tag 是否符合标准等。编译前先执行代码静态分析。</li><li>golint ，类似 javascript 中的 jslint 的工具，主要功能就是检测代码中不规范的地方。</li></ul> 
<hr> 
<h2><a id="_2062"></a>参考文献</h2> 
<p><a href="https://github.com/golang/go/wiki/CodeReviewComments">Go Code Review Comments</a><br> <a href="https://github.com/uber-go/guide">github.com/uber-go/guide</a><br> <a href="https://roamresearch.com/#/app/ShareRoamSpace/page/" rel="nofollow">Golang Readability 考点汇总</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/68327ff3c154e4eafa75361d594e3da0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JVM-性能优化工具 MAT</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ee6925827d705d61da990476cdd89cb9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">DUST数据下载及分析1：批量下载NASA Merra2的nc数据并提取所需指标层转为TIFF</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>