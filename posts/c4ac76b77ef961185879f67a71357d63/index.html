<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql数据库误删库/表的恢复实战 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql数据库误删库/表的恢复实战" />
<meta property="og:description" content="这篇博文是对前期学习的一个综合总结。
一、企业场景全量和增量的频率是怎么做的？
1.中小公司，全量一般是每天一次，业务流量低谷执行全备，备份时会锁表。
2.大公司周备，每周六00点一次全量，其他时间通过binlog做增量。（优点：节省备份时间，减小备份压力。缺点：增量的binlog文件副本太多，还原会很麻烦。）
3.一主多从，使用一个从库专门做备份，必要时可以做延时同步。
二、mysql的mysqldump备份什么时候派上用场？
1.迁移或者升级数据库时。
2.增加从库时候。
3.人为的sql语句误操作。
三、本次模拟的就是人为的误操作后进行紧急恢复。
1）误删数据库
一、工作场景
（1）两台数据库，主从状态，binlog日志开启。（主从配置http://blog.csdn.net/sj349781478/article/details/77519698）
（2）MySQL数据库每晚12:00自动完全备份。
0 0 * * * root mysqldump -u root -p -S /data/mysql3308/mysql3308.sock --all-databases --single-transaction --flush-logs --master-data=2 --events| gzip &gt; /opt/database_`date &#39;&#43;%m-%d-%Y&#39;`.sql.gz （3）某天早上上班，9点左右，接到反馈前端应用使用异常，程序报数据库不存在。
（4）进行紧急恢复！（利用备份的数据文件以及增量的binlog文件进行数据恢复.)
二、数据恢复思路
（1）利用全备的sql文件中记录的CHANGE MASTER语句，binlog文件及其位置点信息，找出binlog文件中增量的那部分。
（2）用mysqlbinlog命令将上述的binlog文件导出为sql文件，并剔除其中的drop语句。
（3）通过全备文件和增量binlog文件的导出sql文件，就可以恢复到完整的数据。
三、实例说明
场景：以全备的data数据库为例，data库中有cost表，全量备份时表中有三条记录，后续有插入的三条记录，某一时刻被误操作删除了data库。
1）发现库被删除：前端报故障过来说data库访问不了，或者监控发现data不存在；
2）向领导反馈或对外发布通知，数据库故障紧急维护；
3）刷新binlog，防止后续新增的在恢复过程中，会继续写入语句到该binlog，最终导致增量恢复数据部分变得比较混乱；
# mysqladmin -uroot -p -S /data/mysql3308/mysql3308.sock flush-logs
4）对当天凌晨备份的数据进行恢复（恢复时间与数据量大小成正比）；
# gunzip &lt; /opt/database_09-03-2017.sql.gz | mysql -uroot -p -S /data/mysql3308/mysql3308.sock
5）查看全备之后新增的binlog文件点
# gunzip database_09-03-2017.sql.gz" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c4ac76b77ef961185879f67a71357d63/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-09-03T20:38:49+08:00" />
<meta property="article:modified_time" content="2017-09-03T20:38:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql数据库误删库/表的恢复实战</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>这篇博文是对前期学习的一个综合总结。</p> 
<p><strong><span style="color:#cc66cc">一、企业场景全量和增量的频率是怎么做的？</span></strong><br> 1.中小公司，全量一般是每天一次，业务流量低谷执行全备，备份时会锁表。<br> 2.大公司周备，每周六00点一次全量，其他时间通过binlog做增量。（优点：节省备份时间，减小备份压力。缺点：增量的binlog文件副本太多，还原会很麻烦。）<br> 3.一主多从，使用一个从库专门做备份，必要时可以做延时同步。<br> <br> <strong><span style="color:#cc66cc">二、mysql的mysqldump备份什么时候派上用场？</span></strong><br> 1.迁移或者升级数据库时。<br> 2.增加从库时候。<br> 3.人为的sql语句误操作。<br> <br> <strong><span style="color:#cc66cc">三、本次模拟的就是人为的误操作后进行紧急恢复。</span></strong></p> 
<p><strong><span style="color:#999900">1）误删数据库</span></strong></p> 
<p></p> 
<p><span style="color:rgb(255,0,0)"><strong>一、工作场景<br> </strong></span></p> 
<p>（1）两台数据库，主从状态，binlog日志开启。（主从配置http://blog.csdn.net/sj349781478/article/details/77519698）<br> </p> 
<p>（2）MySQL数据库每晚12:00自动完全备份。</p> 
<p></p> 
<pre style="margin-top:0px; margin-bottom:0px; word-wrap:break-word"><span style="font-size:10px"><span style="color:#800000; white-space:pre-wrap; font-family:'Courier New'!important"><span style="line-height:13.8462px"><strong>0</strong></span></span><span style="font-family:Courier New"><span style="white-space:pre-wrap"> </span></span><span style="color:#800000; white-space:pre-wrap; font-family:'Courier New'!important"><span style="line-height:13.8462px"><strong>0</strong></span></span><span style="font-family:Courier New"><span style="white-space:pre-wrap"> </span></span><span style="white-space:pre-wrap; font-family:'Courier New'!important; color:rgb(128,128,128); line-height:1.5!important">*</span><span style="font-family:Courier New"><span style="white-space:pre-wrap"> </span></span><span style="white-space:pre-wrap; font-family:'Courier New'!important; color:rgb(128,128,128); line-height:1.5!important">*</span><span style="font-family:Courier New"><span style="white-space:pre-wrap"> </span></span><span style="white-space:pre-wrap; font-family:'Courier New'!important; color:rgb(128,128,128); line-height:1.5!important">*</span><span style="font-family:Courier New"><span style="white-space:pre-wrap"> root mysqldump </span></span><span style="white-space:pre-wrap; font-family:'Courier New'!important; color:rgb(128,128,128); line-height:1.5!important">-</span><span style="font-family:Courier New"><span style="white-space:pre-wrap">u root </span></span><span style="white-space:pre-wrap; font-family:'Courier New'!important; color:rgb(128,128,128); line-height:1.5!important">-</span><span style="font-family:Courier New"><span style="white-space:pre-wrap">p </span></span></span>-S /data/mysql3308/mysql3308.sock <span style="font-size:10px"><span style="white-space:pre-wrap; font-family:'Courier New'!important; color:rgb(0,128,128); line-height:1.5!important">--</span><span style="white-space:pre-wrap; font-family:'Courier New'!important; color:rgb(0,128,128); line-height:1.5!important">all-databases --single-transaction </span></span><span style="font-family:'Courier New'!important; white-space:pre-wrap; color:rgb(0,128,128); line-height:1.5; font-size:10px">--flush-logs </span><span style="font-family:'Courier New'!important; white-space:pre-wrap; color:rgb(0,128,128); line-height:1.5; font-size:10px">--master-data=2 --events</span><span style="font-size:10px; font-family:'Courier New'!important; white-space:pre-wrap"><span style="color:rgb(0,128,128); line-height:1.5!important">| gzip &gt; /opt/database_`date '+%m-%d-%Y'`.sql.gz</span></span></pre> 
<p></p> 
<p>（3）某天早上上班，9点左右，接到反馈前端应用使用异常，程序报数据库不存在。</p> 
<p>（4）进行紧急恢复！（利用备份的数据文件以及增量的binlog文件进行数据恢复.)</p> 
<p><span style="color:rgb(255,0,0)"><strong>二、数据恢复思路<br> </strong></span></p> 
<p>（1）利用全备的sql文件中记录的CHANGE MASTER语句，binlog文件及其位置点信息，找出binlog文件中增量的那部分。<br> （2）用mysqlbinlog命令将上述的binlog文件导出为sql文件，并剔除其中的drop语句。<br> （3）通过全备文件和增量binlog文件的导出sql文件，就可以恢复到完整的数据。</p> 
<p><span style="color:rgb(255,0,0)"><strong>三、实例说明</strong></span><br> </p> 
<p>场景：以全备的data数据库为例，data库中有cost表，全量备份时表中有三条记录，后续有插入的三条记录，某一时刻被误操作删除了data库。</p> 
<p><span style="color:#ff99ff">1）</span>发现库被删除：前端报故障过来说data库访问不了，或者监控发现data不存在；</p> 
<p><br> </p> 
<p><span style="color:#ff99ff">2）</span>向领导反馈或对外发布通知，数据库故障紧急维护；</p> 
<p><br> </p> 
<p><span style="color:#ff99ff">3）</span>刷新binlog，防止后续新增的在恢复过程中，会继续写入语句到该binlog，最终导致增量恢复数据部分变得比较混乱；</p> 
<p># mysqladmin -uroot -p -S /data/mysql3308/mysql3308.sock  flush-logs<br> </p> 
<p><br> </p> 
<p><span style="color:#ff99ff">4）</span>对当天凌晨备份的数据进行恢复（恢复时间与数据量大小成正比）；</p> 
<p><span style="font-family:Arial; font-size:14px; line-height:26px"># gunzip  &lt; /opt/database_09-03-2017.sql.gz | mysql -uroot -p -S /data/mysql3308/mysql3308.sock</span><br> </p> 
<p><span style="font-family:Arial; font-size:14px; line-height:26px"><br> </span></p> 
<p><span style="color:#ff99ff">5）</span>查看全备之后新增的binlog文件点</p> 
<p># gunzip database_09-03-2017.sql.gz<br> </p> 
<p># head -n 50 database_09-03-2017.sql | grep -i "CHANGE MASTER TO"</p> 
<p>-- CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000008', MASTER_LOG_POS=154;<br> </p> 
<p><br> </p> 
<p><span style="color:#ff99ff">6）</span>拷贝备份点后续binlog文件，及上述flush-logs前的文件，导出为sql文件，剔除其中的drop语句</p> 
<p># cp mysql-bin.000008  mysql-bin.000009   /opt/</p> 
<p># cd /opt/</p> 
<p></p> 
<p># mysqlbinlog    --start-position=154<span style="text-align:justify"> </span> -vv  --skip-gtids  mysql-bin.000013&gt;013bin.sql</p> 
<p># vi    008bin.sql    找到DROP的位置，然后再生成sql</p> 
<p># mysqlbinlog    --start-position=154 <span style="text-align:justify">--stop-position=984 </span> -vv  --skip-gtids  mysql-bin.000008&gt;008bin.sql</p> 
<p># mysql -uroot -p  -S /data/mysql3308/mysql3308.sock data  &lt;008bin.sql</p> 
<span style="background-color:rgb(204,255,204)"><strong>以上就是mysql数据库增量数据恢复的实例过程！</strong></span> 
<br> 
<p><span style="background-color:rgb(204,255,204)"><strong><br> </strong></span></p> 
<p><span style="background-color:rgb(204,255,204)"><strong><strong><span style="color:#999900">2）误删数据库的表</span></strong><br> </strong></span></p> 
<p><span style="background-color:rgb(204,255,204)"><span style="font-weight:bold"><span style="font-weight:bold"></span></span></span></p> 
<p style="color:rgb(153,153,0)"><span style="color:rgb(255,0,0)"><strong>一、工作场景<br> </strong></span></p> 
<p style="color:rgb(153,153,0)">（1）两台数据库，主从状态，binlog日志开启。（主从配置http://blog.csdn.net/sj349781478/article/details/77519698）<br> </p> 
<p style="color:rgb(153,153,0)">（2）MySQL数据库每晚12:00自动完全备份。</p> 
<p style="color:rgb(153,153,0)"></p> 
<pre style="color:rgb(153,153,0); margin-top:0px; margin-bottom:0px; word-wrap:break-word"><span style="font-size:10px"><span style="color:#800000; white-space:pre-wrap; font-family:'Courier New'!important"><span style="line-height:13.8462px"><strong>0</strong></span></span><span style="font-family:Courier New"><span style="white-space:pre-wrap"> </span></span><span style="color:#800000; white-space:pre-wrap; font-family:'Courier New'!important"><span style="line-height:13.8462px"><strong>0</strong></span></span><span style="font-family:Courier New"><span style="white-space:pre-wrap"> </span></span><span style="white-space:pre-wrap; color:rgb(128,128,128); font-family:'Courier New'!important; line-height:1.5!important">*</span><span style="font-family:Courier New"><span style="white-space:pre-wrap"> </span></span><span style="white-space:pre-wrap; color:rgb(128,128,128); font-family:'Courier New'!important; line-height:1.5!important">*</span><span style="font-family:Courier New"><span style="white-space:pre-wrap"> </span></span><span style="white-space:pre-wrap; color:rgb(128,128,128); font-family:'Courier New'!important; line-height:1.5!important">*</span><span style="font-family:Courier New"><span style="white-space:pre-wrap"> root mysqldump </span></span><span style="white-space:pre-wrap; color:rgb(128,128,128); font-family:'Courier New'!important; line-height:1.5!important">-</span><span style="font-family:Courier New"><span style="white-space:pre-wrap">u root </span></span><span style="white-space:pre-wrap; color:rgb(128,128,128); font-family:'Courier New'!important; line-height:1.5!important">-</span><span style="font-family:Courier New"><span style="white-space:pre-wrap">p </span></span></span>-S /data/mysql3308/mysql3308.sock <span style="font-size:10px"><span style="white-space:pre-wrap; color:rgb(0,128,128); font-family:'Courier New'!important; line-height:1.5!important">--</span><span style="white-space:pre-wrap; color:rgb(0,128,128); font-family:'Courier New'!important; line-height:1.5!important">all-databases --single-transaction </span></span><span style="white-space:pre-wrap; color:rgb(0,128,128); line-height:1.5; font-size:10px; font-family:'Courier New'!important">--flush-logs </span><span style="white-space:pre-wrap; color:rgb(0,128,128); line-height:1.5; font-size:10px; font-family:'Courier New'!important">--master-data=2 --events</span><span style="font-size:10px; white-space:pre-wrap; font-family:'Courier New'!important"><span style="color:rgb(0,128,128); line-height:1.5!important">| gzip &gt; /opt/database_`date '+%m-%d-%Y'`.sql.gz</span></span></pre> 
<p style="color:rgb(153,153,0)"></p> 
<p style="color:rgb(153,153,0)">（3）某天早上上班，9点左右，接到反馈前端应用使用异常，程序报数据库表不存在。</p> 
<p style="color:rgb(153,153,0)">（4）进行紧急恢复！（利用备份的数据文件以及增量的binlog文件进行数据恢复.)</p> 
<p style="color:rgb(153,153,0)"><span style="color:rgb(255,0,0)"><strong>二、数据恢复思路<br> </strong></span></p> 
<p style="color:rgb(153,153,0)">（1）利用全备的sql文件中记录的CHANGE MASTER语句，binlog文件及其位置点信息，找出binlog文件中增量的那部分。<br> （2）用mysqlbinlog命令将上述的binlog文件导出为sql文件，并剔除其中的drop语句。<br> （3）通过全备文件和增量binlog文件的导出sql文件，就可以恢复到完整的数据。</p> 
<p style="color:rgb(153,153,0)"><span style="color:rgb(255,0,0)"><strong>三、实例说明</strong></span><br> </p> 
<p style="color:rgb(153,153,0)">场景：以全备的data数据库为例，data库中有cost表，全量备份时表中有三条记录，后续有插入的三条记录，某一时刻被误操作删除了data库的cost表。</p> 
<p style="color:rgb(153,153,0)"><span style="color:#ff99ff">1）</span>发现库中的表被删除：前端报故障过来说data库表访问不了，或者监控发现data库中的cost表不存在；</p> 
<p style="color:rgb(153,153,0)"><br> </p> 
<p style="color:rgb(153,153,0)"><span style="color:#ff99ff">2）</span>向领导反馈或对外发布通知，数据库故障紧急维护；</p> 
<p style="color:rgb(153,153,0)"><br> </p> 
<p style="color:rgb(153,153,0)"><span style="color:#ff99ff">3）</span>刷新binlog，防止后续新增的在恢复过程中，会继续写入语句到该binlog，最终导致增量恢复数据部分变得比较混乱；</p> 
<p style="color:rgb(153,153,0)"># mysqladmin -uroot -p -S /data/mysql3308/mysql3308.sock  flush-logs<br> </p> 
<p style="color:rgb(153,153,0)"><br> </p> 
<p><span style="color:rgb(255,153,255)">4）</span><span style="color:#999900">断开主从，将对当天凌晨备份的数据在</span><span style="color:#ff99ff">备库上</span><span style="color:#999900">进行恢复（恢复时间与数据量大小成正比）；</span></p> 
<p><span style="color:#999900">从库&gt;stop slave;   或者slave stop;    看版本了</span></p> 
<p style="color:rgb(153,153,0)"><span style="font-family:Arial; font-size:14px; line-height:26px"># gunzip  &lt; /opt/database_09-03-2017.sql.gz | mysql -uroot -p -S /data/mysql3309/mysql3309.sock</span><br> </p> 
<p><span style="font-family:Arial; font-size:14px; line-height:26px"><span style="color:#ff99ff">5）</span><span style="color:#999900">备库上导出数据表</span></span></p> 
<p><span style="font-family:Arial; font-size:14px; line-height:26px"><span style="color:#999900">mysqldump -uroot -p -S /data/mysql3309/mysql3309.sock -B data cost &gt; /tmp/data_cost.sql<br> </span></span></p> 
<p style="color:rgb(153,153,0)"><br> </p> 
<p><span style="color:#ff99ff">6）</span><span style="color:#999900">在主库上恢复备份的cost表</span></p> 
<p><span style="color:#999900">mysql -uroot -p  -S /data/mysql3308/mysql3308.sock  data  &lt; data_cost.sql <br> </span></p> 
<p><span style="color:#999900"><br> </span></p> 
<p><span style="color:#999900"></span></p> 
<p><span style="background-color:rgb(255,255,255)"><span style="color:rgb(255,153,255)">7）</span><span style="color:#999900">在备库上查看全备之后新增的binlog文件点</span></span></p> 
<p style="color:rgb(153,153,0)"><span style="background-color:rgb(255,255,255)"># gunzip database_09-03-2017.sql.gz<br> </span></p> 
<p style="color:rgb(153,153,0)"><span style="background-color:rgb(255,255,255)"># head -n 50 database_09-03-2017.sql | grep -i "CHANGE MASTER TO"</span></p> 
<p><span style="background-color:rgb(255,255,255)"><span style="color:#999900">-- CHANGE MASTER TO MASTER_LOG_FILE=</span><span style="color:#ff99ff">'mysql-bin.000013', MASTER_LOG_POS=154</span></span></p> 
<br> 
<p style="color:rgb(153,153,0)"><br> </p> 
<p style="color:rgb(153,153,0)"><span style="color:#ff99ff">8）</span>拷贝备份点后续binlog文件，及上述flush-logs前的文件，导出为sql文件，剔除其中的drop语句</p> 
<p style="color:rgb(153,153,0)"># cp mysql-bin.000013    /opt/</p> 
<p style="color:rgb(153,153,0)"># cd /opt/</p> 
<p style="color:rgb(153,153,0)"># mysqlbinlog    <span style="color:rgb(0,130,0); font-family:Consolas,'Courier New',Courier,mono,serif; font-size:14px; line-height:18px; text-align:justify">--start-position=154<span style="color:rgb(0,130,0); font-family:Consolas,'Courier New',Courier,mono,serif; font-size:14px; line-height:18px; text-align:justify"> </span></span><span style="font-family:Arial; font-size:18px; line-height:26px"> </span>-vv  --skip-gtids  mysql-bin.000013&gt;013bin.sql</p> 
<p style="color:rgb(153,153,0)"># vi    <span style="color:rgb(153,153,0)">013bin.sql    找到DROP的位置，然后再生成sql</span></p> 
<p style="color:rgb(153,153,0)"><span style="color:rgb(153,153,0)"><span style="color:rgb(153,153,0)"># mysqlbinlog    </span><span style="color:rgb(0,130,0); font-family:Consolas,'Courier New',Courier,mono,serif; font-size:14px; line-height:18px">--start-position=154 <span style="text-align:justify">--stop-position=984 </span></span><span style="color:rgb(153,153,0); font-family:Arial; font-size:18px; line-height:26px"> </span><span style="color:rgb(153,153,0)">-vv  --skip-gtids  mysql-bin.000013&gt;013bin.sql</span><br> </span></p> 
<p style="color:rgb(153,153,0)"># mysql -uroot -p  -S /data/mysql3308/mysql3308.sock data  &lt;013bin.sql</p> 
<p><span style="color:rgb(153,153,0); background-color:rgb(204,255,204)"><strong>以上就是mysql数据库表的增量数据恢复的实例过程！</strong></span></p> 
<p><strong>【完】</strong></p> 
<p><span style="background-color:rgb(204,255,204)"><strong><span style="color:rgb(51,51,51); font-family:arial; font-size:16px; text-align:justify">此文为头条号作者 技术男诺言 原创，特此申明</span><br> </strong></span></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b59b8171e4287a0ad929ddd616fd3e4f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python opencv入门 使用 GrabCut 交互式提取前景（30）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b46b011324d3315b83cb503e9db0ef3e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue学习笔记五</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>