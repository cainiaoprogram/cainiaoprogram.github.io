<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 9.0 Launcher Workspace 加载 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 9.0 Launcher Workspace 加载" />
<meta property="og:description" content="加载Workspace入口在/packages/apps/Launcher3/src/com/android/launcher3/model/LoaderTask.java，想了解Launcher app的启动流程，可以先看看这篇文章，https://www.jianshu.com/p/0b273112cd7e
1、Workspace加载调用过程，如图 代码入口：
/packages/apps/Launcher3/src/com/android/launcher3/model/LoaderTask.java，
public void run() { synchronized (this) { // Skip fast if we are already stopped. if (mStopped) { return; } } TraceHelper.beginSection(TAG); try (LauncherModel.LoaderTransaction transaction = mApp.getModel().beginLoader(this)) { TraceHelper.partitionSection(TAG, &#34;step 1.1: loading workspace&#34;); loadWorkspace(); ... transaction.commit(); } catch (CancellationException e) { // Loader stopped, ignore TraceHelper.partitionSection(TAG, &#34;Cancelled&#34;); } TraceHelper.endSection(TAG); } } ··· 接下来是总体调用过程：
private void loadWorkspace() { ...	LauncherSettings.Settings.call(contentResolver, LauncherSettings.Settings.METHOD_LOAD_DEFAULT_FAVORITES); ... } // If there are any empty screens remove them, and update." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0b446ab807a45a839ae07e86d2b57804/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-06T19:53:30+08:00" />
<meta property="article:modified_time" content="2020-04-06T19:53:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 9.0 Launcher Workspace 加载</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/90/03/HX9bRiR5_o.jpg" alt="在这里插入图片描述"><br>  加载Workspace入口在/packages/apps/Launcher3/src/com/android/launcher3/model/LoaderTask.java，想了解Launcher app的启动流程，可以先看看这篇文章，<a href="https://www.jianshu.com/p/0b273112cd7e" rel="nofollow">https://www.jianshu.com/p/0b273112cd7e</a></p> 
<h4><a id="1Workspace_2"></a>1、Workspace加载调用过程，如图</h4> 
<p><img src="https://images2.imgbox.com/f7/73/xD1RYaIU_o.png" alt="progrss.png"><br> 代码入口：<br> /packages/apps/Launcher3/src/com/android/launcher3/model/LoaderTask.java，</p> 
<pre><code> public void run() {
        synchronized (this) {
            // Skip fast if we are already stopped.
            if (mStopped) {
                return;
            }
        }

        TraceHelper.beginSection(TAG);
        try (LauncherModel.LoaderTransaction transaction = mApp.getModel().beginLoader(this)) {
            TraceHelper.partitionSection(TAG, "step 1.1: loading workspace");
            loadWorkspace();
			...
			
            transaction.commit();
        } catch (CancellationException e) {
            // Loader stopped, ignore
            TraceHelper.partitionSection(TAG, "Cancelled");
        }
        TraceHelper.endSection(TAG);
    }
	
}
···
</code></pre> 
<p>接下来是总体调用过程：</p> 
<pre><code> private void loadWorkspace() {
             ...	
 
        LauncherSettings.Settings.call(contentResolver,
                LauncherSettings.Settings.METHOD_LOAD_DEFAULT_FAVORITES);
  	       ...
                    
            }

            // If there are any empty screens remove them, and update.
            if (unusedScreens.size() != 0) {
                mBgDataModel.workspaceScreens.removeAll(unusedScreens);
                LauncherModel.updateWorkspaceScreenOrder(context, mBgDataModel.workspaceScreens);
            }
        
    }
</code></pre> 
<p>/packages/apps/Launcher3/src/com/android/launcher3/LauncherSettings.java</p> 
<pre><code>	public static final class Settings {
	  ...
	 
	  public static final String METHOD_LOAD_DEFAULT_FAVORITES = "load_default_favorites";
	   ...
	   
	 public static Bundle call(ContentResolver cr, String method) {
            return cr.call(CONTENT_URI, method, null, null);
        }	
		 ...	
}	 	 
</code></pre> 
<p>/packages/apps/Launcher3/src/com/android/launcher3/LauncherProvider.java</p> 
<pre><code>	 @Override
    public Bundle call(String method, final String arg, final Bundle extras) {
        Log.e(TAG,"method-- "+method);
        if (Binder.getCallingUid() != Process.myUid()) {
            return null;
        }
        createDbIfNotExists();
        switch (method) {
		
		...
		
          case LauncherSettings.Settings.METHOD_LOAD_DEFAULT_FAVORITES: {
                loadDefaultFavoritesIfNecessary();
                return null;
            }

          ...
		  
		   }
		  
	 }
		 
</code></pre> 
<h4><a id="2_loadDefaultFavoritesIfNecessary_93"></a>2、具体加载流程，是这个方法 loadDefaultFavoritesIfNecessary()，</h4> 
<p><img src="https://images2.imgbox.com/32/bf/d02Giivw_o.png" alt="在这里插入图片描述"><br> /**<br> * Loads the default workspace based on the following priority scheme:<br> * 1) From the app restrictions<br> * 2) From a package provided by play store<br> * 3) From a partner configuration APK, already in the system image<br> * 4) The default configuration for the particular device<br> */</p> 
<pre><code>
 synchronized private void loadDefaultFavoritesIfNecessary() {  
        SharedPreferences sp = Utilities.getPrefs(getContext());
        boolean aBoolean = sp.getBoolean(EMPTY_DATABASE_CREATED, false);
        if (sp.getBoolean(EMPTY_DATABASE_CREATED, false)) {
                AppWidgetHost widgetHost = mOpenHelper.newLauncherWidgetHost();
            AutoInstallsLayout loader = createWorkspaceLoaderFromAppRestriction(widgetHost);
            if (loader == null) {            
                loader = AutoInstallsLayout.get(getContext(),widgetHost, mOpenHelper);
            }
            if (loader == null) {
                final Partner partner = Partner.get(getContext().getPackageManager());
                if (partner != null &amp;&amp; partner.hasDefaultLayout()) {
                    final Resources partnerRes = partner.getResources();
                    int workspaceResId = 
                    partnerRes.getIdentifier(Partner.RES_DEFAULT_LAYOUT,
                            "xml", partner.getPackageName());
                    if (workspaceResId != 0) {
                        loader = new DefaultLayoutParser(getContext(), widgetHost,
                                mOpenHelper, partnerRes, workspaceResId);
                    }
                }
            }

            final boolean usingExternallyProvidedLayout = loader != null;
            if (loader == null) {
                loader = getDefaultLayoutParser(widgetHost);
            }
          
            mOpenHelper.createEmptyDB(mOpenHelper.getWritableDatabase());  
            if ((mOpenHelper.loadFavorites(mOpenHelper.getWritableDatabase(), loader) &lt;= 0)
                    &amp;&amp; usingExternallyProvidedLayout) {
                // Unable to load external layout. Cleanup and load the internal layout.
                mOpenHelper.createEmptyDB(mOpenHelper.getWritableDatabase());
                mOpenHelper.loadFavorites(mOpenHelper.getWritableDatabase(),
                        getDefaultLayoutParser(widgetHost));
       
            }
            clearFlagEmptyDbCreated();
        }
    }
</code></pre> 
<h6><a id="1_From_the_app_restrictions_146"></a>1) From the app restrictions</h6> 
<pre><code>private AutoInstallsLayout createWorkspaceLoaderFromAppRestriction(AppWidgetHost widgetHost) {
        Context ctx = getContext();
        UserManager um = (UserManager) ctx.getSystemService(Context.USER_SERVICE);
        Bundle bundle = um.getApplicationRestrictions(ctx.getPackageName());
        if (bundle == null) {
            return null;
        }

        String packageName = bundle.getString(RESTRICTION_PACKAGE_NAME);
        if (packageName != null) {
            try {
                Resources targetResources = ctx.getPackageManager()
                        .getResourcesForApplication(packageName);
                return AutoInstallsLayout.get(ctx, packageName, targetResources,
                        widgetHost, mOpenHelper);
            } catch (NameNotFoundException e) {
                Log.e(TAG, "Target package for restricted profile not found", e);
                return null;
            }
        }
        return null;
    }
</code></pre> 
<h6><a id="2_From_a_package_provided_by_play_store_172"></a>2) From a package provided by play store</h6> 
<pre><code> static AutoInstallsLayout get(Context context, AppWidgetHost appWidgetHost,
            LayoutParserCallback callback) {
        Pair&lt;String, Resources&gt; customizationApkInfo = Utilities.findSystemApk(
                ACTION_LAUNCHER_CUSTOMIZATION, context.getPackageManager());
        if (customizationApkInfo == null) {
            return null;
        }
        return get(context, customizationApkInfo.first, customizationApkInfo.second,
                appWidgetHost, callback);
    }
	
    /** Marker action used to discover a package which defines launcher customization */
    static final String ACTION_LAUNCHER_CUSTOMIZATION =
            "android.autoinstalls.config.action.PLAY_AUTO_INSTALL";
</code></pre> 
<p>#####3) From a partner configuration APK, already in the system image</p> 
<pre><code>	 ...
 if (loader == null) {        
                final Partner partner = Partner.get(getContext().getPackageManager());
                if (partner != null &amp;&amp; partner.hasDefaultLayout()) {
                    final Resources partnerRes = partner.getResources();
                    int workspaceResId = 
partnerRes.getIdentifier(Partner.RES_DEFAULT_LAYOUT,
                            "xml", partner.getPackageName());
                    if (workspaceResId != 0) {
                        loader = new DefaultLayoutParser(getContext(), widgetHost,
                                mOpenHelper, partnerRes, workspaceResId);
                    }
                }
            } 
	 
	 public static synchronized Partner get(PackageManager pm) {
        if (!sSearched) {
            Pair&lt;String, Resources&gt; apkInfo = Utilities.findSystemApk(ACTION_PARTNER_CUSTOMIZATION, pm);
            if (apkInfo != null) {
                sPartner = new Partner(apkInfo.first, apkInfo.second);
            }
            sSearched = true;
        }
        return sPartner;
    }

	...
	 
	  /** Marker action used to discover partner */
    private static final String
            ACTION_PARTNER_CUSTOMIZATION = "com.android.launcher3.action.PARTNER_CUSTOMIZATION";
</code></pre> 
<h6><a id="4_The_default_configuration_for_the_particular_device_223"></a>4) The default configuration for the particular device</h6> 
<pre><code>     ...
     
     if (loader == null) {
               loader = getDefaultLayoutParser(widgetHost);
           } 

     ... 

  private DefaultLayoutParser getDefaultLayoutParser(AppWidgetHost widgetHost){
       InvariantDeviceProfile idp = LauncherAppState.getIDP(getContext());
       int defaultLayout = idp.defaultLayoutId;

       UserManagerCompat um = UserManagerCompat.getInstance(getContext());
       if (um.isDemoUser() &amp;&amp; idp.demoModeLayoutId != 0) {
           defaultLayout = idp.demoModeLayoutId;
       }

       return new DefaultLayoutParser(getContext(), widgetHost,
               mOpenHelper, getContext().getResources(), defaultLayout);
   }
   		
public class DefaultLayoutParser extends AutoInstallsLayout {
   private static final String TAG = "DefaultLayoutParser";

     ...
     
    public DefaultLayoutParser(Context context, AppWidgetHost appWidgetHost,
           LayoutParserCallback callback, Resources sourceRes, int layoutId) {
       super(context, appWidgetHost, callback, sourceRes, layoutId, TAG_FAVORITES);
   }
   
   ...
}
</code></pre> 
<p>第一次加载，执行最后一个 loader = getDefaultLayoutParser(widgetHost)。 接下来，便是加载布局文件，解析数据，该文件在/packages/apps/Launcher3/res/xml目录下。具体是解析defaultLayout，对应default_workspace_3x3,default_workspace_4x4,default_workspace_5x6等的某一个文件，这个文件是从在InvariantDeviceProfile中获取的。</p> 
<h4><a id="3_260"></a>3、加载，解析代码</h4> 
<p>packages/apps/Launcher3/src/com/android/launcher3/LauncherProvider.java：</p> 
<pre><code>  ...
 mOpenHelper.loadFavorites(mOpenHelper.getWritableDatabase(), loader) 
 ...

 @Thunk int loadFavorites(SQLiteDatabase db, AutoInstallsLayout loader) {
            ArrayList&lt;Long&gt; screenIds = new ArrayList&lt;Long&gt;();
            // TODO: Use multiple loaders with fall-back and transaction.
            int count = loader.loadLayout(db, screenIds);
            Log.e(TAG, "loadFavorites count : "+count);
            // Add the screens specified by the items above
            Collections.sort(screenIds);
            int rank = 0;
            ContentValues values = new ContentValues();
            for (Long id : screenIds) {
                values.clear();
                values.put(LauncherSettings.WorkspaceScreens._ID, id);
                values.put(LauncherSettings.WorkspaceScreens.SCREEN_RANK, rank);
                if (dbInsertAndCheck(this, db, WorkspaceScreens.TABLE_NAME, null, values) &lt; 0) {
                    throw new RuntimeException("Failed initialize screen table"
                            + "from default layout");
                }
                Log.e(TAG,"loadFavorites id: "+id+",Screenrank: "+rank);
                rank++;

            }

            // Ensure that the max ids are initialized
            mMaxItemId = initializeMaxItemId(db);
            mMaxScreenId = initializeMaxScreenId(db);
            Log.e(TAG,"loadFavorites favorite  mMaxItemId: "+mMaxItemId+",workSpaceScreen mMaxScreenId: "+mMaxScreenId);
            return count;
        }
    }
</code></pre> 
<p>/packages/apps/Launcher3/src/com/android/launcher3/AutoInstallsLayout.java</p> 
<pre><code> public int loadLayout(SQLiteDatabase db, ArrayList&lt;Long&gt; screenIds) {
         mDb = db;
        try {
            return parseLayout(mLayoutId, screenIds);
        } catch (Exception e) {
            Log.e(TAG, "Error parsing layout: " + e);
            return -1;
        }
    }
 protected int parseLayout(int layoutId, ArrayList&lt;Long&gt; screenIds)
            throws XmlPullParserException, IOException {
        XmlResourceParser parser = mSourceRes.getXml(layoutId);
        beginDocument(parser, mRootTag);
        final int depth = parser.getDepth();
        int type;
        ArrayMap&lt;String, TagParser&gt; tagParserMap = getLayoutElementsMap();
        int count = 0;

        while (((type = parser.next()) != XmlPullParser.END_TAG ||
                parser.getDepth() &gt; depth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) {
            if (type != XmlPullParser.START_TAG) {
                continue;
            }
            Log.e(TAG,"parseLayout layoutId-- "+layoutId+",screenIds-- "+screenIds+",count-- "+count);
            count += parseAndAddNode(parser, tagParserMap, screenIds);
        }
        return count;
    }
 protected int parseAndAddNode(
        XmlResourceParser parser,
        ArrayMap&lt;String, TagParser&gt; tagParserMap,
        ArrayList&lt;Long&gt; screenIds)
        throws XmlPullParserException, IOException {
        if (TAG_INCLUDE.equals(parser.getName())) {
            final int resId = getAttributeResourceValue(parser, ATTR_WORKSPACE, 0);
            if (resId != 0) {
                // recursively load some more favorites, why not?
                return parseLayout(resId, screenIds);
            } else {
                return 0;
            }
        }

        mValues.clear();
        parseContainerAndScreen(parser, mTemp);
        final long container = mTemp[0];
        final long screenId = mTemp[1];

        mValues.put(Favorites.CONTAINER, container);
        mValues.put(Favorites.SCREEN, screenId);

        mValues.put(Favorites.CELLX,
                convertToDistanceFromEnd(getAttributeValue(parser, ATTR_X), mColumnCount));
        mValues.put(Favorites.CELLY,
                convertToDistanceFromEnd(getAttributeValue(parser, ATTR_Y), mRowCount));

        TagParser tagParser = tagParserMap.get(parser.getName());
        if (tagParser == null) {
            if (LOGD) Log.d(TAG, "Ignoring unknown element tag: " + parser.getName());
            return 0;
        }
        long newElementId = tagParser.parseAndAdd(parser);
          if (newElementId &gt;= 0) {
            // Keep track of the set of screens which need to be added to the db.
            if (!screenIds.contains(screenId) &amp;&amp;
                    container == Favorites.CONTAINER_DESKTOP) {
                screenIds.add(screenId);
            }
            return 1;
        }
        return 0;
    }
</code></pre> 
<p>如图：<br> <img src="https://images2.imgbox.com/bd/d0/lr5Jco0g_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_376"></a>总结：</h4> 
<p>1、 第一次启动Launcher，加载器是由getDefaultLayoutParser生成。如果看执行效果，可以删除launcher.db ，重启ActivityManager。<br>   rm /data/data/com.android.launcher3/databases/launcher.db<br>   adb shell am restart</p> 
<p>2、 非初次启动，EMPTY_DATABASE_CREATED=false, 不会初始化loader。</p> 
<p>3、定制化需求，可以考虑添加对应的default_workspace.xml文件。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/94d94f63a69d30cc50d57b05fe3ae9ea/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">TCMalloc：线程缓存Malloc</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1e5abb93baebe09f65ee1e07e536cc9e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【PTA】7-12 日期格式化 (5分)_中M2020春C入门练习第I段——变量、表达式、分支、循环</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>