<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mybatis插件拦截器实现异常条件拦截检测 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Mybatis插件拦截器实现异常条件拦截检测" />
<meta property="og:description" content="背景 实际开发过程中可能会因为各种原因导致对数据库操作的代码缺少where条件，对于查询操作可能会导致全表扫描，对于更新操作可能会导致整个表的字段错误更新。大多数场景都不是符合我们的预期的。
所以做了这样一个插件(可以根据配置application.yml动态开启/关闭插件。可以检测where条件是否合法来决定打印error日志or抛出异常)
插件原理 Mybatis 预留了org.apache.ibatis.plugin.Interceptor 接口，通过实现该接口，可以对Mybatis的执行流程进行拦截，接口的定义如下：
public interface Interceptor { // 插件的核心逻辑在这个方法中 Object intercept(Invocation invocation) throws Throwable; // 使用当前的Interceptor创建代理，通常的实现都是 Plugin.wrap(target, this)，wrap方法内使用 jdk 创建动态代理对象； Object plugin(Object target); // 可以获取Mybatis配置文件中中设置的参数 void setProperties(Properties properties); } Mybatis插件可拦截的类为以下四个：
Executor
StatementHandler
ParameterHandler
ResultSetHandler
这些类的代理流程
在执行query方法之前都可以获取到我们要执行的原始sql，然后进行条件检测判断。所以我们可以织入我们代码的拦截类可以为 Executor、StatementHandler、ParameterHandler。这里选择了Executor。
mybatis的详细执行流程和动态代理实现sql代理等流程戳这里：编码技巧——数据加密（二）Mybatis拦截器
插件实现 插件代码： common项目：
自定义条件检测配置类(把配置文件中的mybatis配置注入到该类中，实现配置和拦截器代码分离的作用。方便各个服务灵活接入)
/** * mybatis自定义条件检测配置类 * * @see MybatisConditionDetectionInterceptor * */ @Data @AllArgsConstructor @NoArgsConstructor @Component @ConfigurationProperties(prefix = &#34;mybatis.condition.detection&#34;) @ConditionalOnProperty(prefix = &#34;mybatis.condition.detection&#34;, name = &#34;enable&#34;, havingValue = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/25b798212d2ef7424f44d8b224875afe/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-27T16:41:21+08:00" />
<meta property="article:modified_time" content="2023-07-27T16:41:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Mybatis插件拦截器实现异常条件拦截检测</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>背景</h3> 
<p>实际开发过程中可能会因为各种原因导致对数据库操作的代码缺少where条件，对于查询操作可能会导致全表扫描，对于更新操作可能会导致整个表的字段错误更新。大多数场景都不是符合我们的预期的。</p> 
<p>所以做了这样一个插件(可以根据配置application.yml动态开启/关闭插件。可以检测where条件是否合法来决定打印error日志or抛出异常)</p> 
<h3>插件原理</h3> 
<p>Mybatis 预留了org.apache.ibatis.plugin.Interceptor 接口，通过实现该接口，可以对Mybatis的执行流程进行拦截，接口的定义如下：</p> 
<pre><code class="language-java">public interface Interceptor {
 
  // 插件的核心逻辑在这个方法中
  Object intercept(Invocation invocation) throws Throwable;
  // 使用当前的Interceptor创建代理，通常的实现都是 Plugin.wrap(target, this)，wrap方法内使用 jdk 创建动态代理对象；
  Object plugin(Object target);
  // 可以获取Mybatis配置文件中中设置的参数
  void setProperties(Properties properties);
}</code></pre> 
<p>Mybatis插件可拦截的类为以下四个：</p> 
<blockquote> 
 <ul><li> <p>Executor</p> </li><li> <p>StatementHandler</p> </li><li> <p>ParameterHandler</p> </li><li> <p>ResultSetHandler</p> </li></ul> 
</blockquote> 
<p>这些类的代理流程</p> 
<p><img alt="" height="810" src="https://images2.imgbox.com/bf/08/BPviEXnM_o.png" width="1200"></p> 
<p> 在执行query方法之前都可以获取到我们要执行的原始sql，然后进行条件检测判断。所以我们可以织入我们代码的拦截类可以为 Executor、StatementHandler、ParameterHandler。这里选择了Executor。</p> 
<p></p> 
<p>mybatis的详细执行流程和动态代理实现sql代理等流程戳这里：<a href="https://blog.csdn.net/minghao0508/article/details/124420442" title="编码技巧——数据加密（二）Mybatis拦截器">编码技巧——数据加密（二）Mybatis拦截器</a></p> 
<h3>插件实现</h3> 
<h4>插件代码：</h4> 
<p><strong>common项目：</strong></p> 
<p><strong>自定义条件检测配置类(把配置文件中的</strong><strong>mybatis</strong><strong>配置注入到该类中，实现配置和拦截器代码分离的作用。方便各个服务灵活接入)</strong></p> 
<pre><code class="language-java">
/**
 * mybatis自定义条件检测配置类
 *
 * @see MybatisConditionDetectionInterceptor
 *
 */
@Data
@AllArgsConstructor
@NoArgsConstructor
@Component
@ConfigurationProperties(prefix = "mybatis.condition.detection")
@ConditionalOnProperty(prefix = "mybatis.condition.detection", name = "enable", havingValue = "true")
public class MybatisConditionDetectionProperty {

    /**
     * 条件检测拦截器开关，默认不生效。
     * 仅在enable=true时条件检测拦截器才会生效
     */
    private Boolean enable = false;

    /**
     * 检测模式，出现非法条件时 1 打印error日志、2 抛出RunTimeException。默认为打印error日志
     * @see MybatisConditionDetectionEnum
     */
    private Integer detectionMode = 1;

    ;
}</code></pre> 
<p><strong>Mybatis</strong><strong>条件检测拦截器(根据配置类的属性实现</strong><strong>异常检测</strong><strong>、出现异常条件时反馈机制“打日志还是抛异常”)</strong></p> 
<pre><code class="language-java">
/**
 * Mybatis条件检测拦截器
 * 可支持example方式生成的sql和动态sql的条件检测。
 * 参考：
 * &lt;a href="https://blog.csdn.net/minghao0508/article/details/124420442"&gt;编码技巧——数据加密（二）Mybatis拦截器&lt;/a&gt;
 * &lt;/a&gt;
 *
 * @date 2023/06/12
 * @see Executor#query(MappedStatement, Object, RowBounds, ResultHandler, CacheKey, BoundSql)
 * @see Executor#query(MappedStatement, Object, RowBounds, ResultHandler)
 * @see Executor#update(MappedStatement, Object)
 */

@Slf4j
@Intercepts({
        @Signature(type = Executor.class, method = "update", args = {MappedStatement.class, Object.class}),
        @Signature(type = Executor.class, method = "query", args = {MappedStatement.class, Object.class, RowBounds.class,
                ResultHandler.class}),
        @Signature(type = Executor.class, method = "query", args = {MappedStatement.class, Object.class,
                RowBounds.class, ResultHandler.class, CacheKey.class, BoundSql.class}),
})
public class MybatisConditionDetectionInterceptor implements Interceptor {

    private static final String PSM_NAME_UNKNOWN = "unknown";

    private MybatisConditionDetectionProperty mybatisConditionDetectionProperty;

    private String psm;

    public MybatisConditionDetectionInterceptor(MybatisConditionDetectionProperty mybatisConditionDetectionProperty, String psm) {
        this.mybatisConditionDetectionProperty = mybatisConditionDetectionProperty;
        this.psm = StringTools.nonBlankOrElse(psm, PSM_NAME_UNKNOWN);
    }

    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // 如果没有配置或者条件检测配置未开启，直接执行sql。
        if (Objects.isNull(this.mybatisConditionDetectionProperty) || Boolean.FALSE.equals(this.mybatisConditionDetectionProperty.getEnable())) {
            return invocation.proceed();
        }
        //获取执行参数
        Object[] objects = invocation.getArgs();
        MappedStatement ms = (MappedStatement) objects[0];
        // 获取当前方法的全限定名 eg:com.bytedance.homed.decorate.construction.infrastructure.repository.mysql.mapper.CameraDataInfoMapper.insert
        String mapperMethodAllName = ms.getId();
        int lastIndex = mapperMethodAllName.lastIndexOf(".");
        // 获取当前类(接口)的全限定名 eg:com.bytedance.homed.decorate.construction.infrastructure.repository.mysql.mapper.CameraDataInfoMapper
        String mapperClassStr = mapperMethodAllName.substring(0, lastIndex);
        // 获取当前方法名 eg:insert
        String mapperClassMethodStr = mapperMethodAllName.substring((lastIndex + 1));
        // 获取类的所有方法
        Class&lt;?&gt; mapperClass = Class.forName(mapperClassStr);
        // 根据配置获取出现异常条件时的提示方式
        MybatisConditionDetectionEnum conditionDetection = this.mybatisConditionDetectionProperty == null ?
                MybatisConditionDetectionEnum.ERROR_LOG :
                MybatisConditionDetectionEnum.valueOf(this.mybatisConditionDetectionProperty.getDetectionMode());
        Method[] methods = mapperClass.getMethods();
        for (Method method : methods) {
            // 如果匹配到当前方法，进行sql条件检验
            if (method.getName().equals(mapperClassMethodStr)) {
                BoundSql boundSql = ms.getSqlSource().getBoundSql(objects[1]);
                String executeSql = boundSql.getSql().toLowerCase(Locale.CHINA).replace("[\\t\\n\\r]", " ");

                // 如果是插入语句，不进行检测。
                if (method.getName().contains("insert")) {
                    continue;
                }
                // 如果是查询/更新/删除语句，检测是否包含where关键字和是否包含条件
                else if (method.getName().contains("delete") || method.getName().contains("update") || method.getName().contains("select")) {
                    if (!executeSql.contains("where")) {
                        if (MybatisConditionDetectionEnum.THROW_ERROR == conditionDetection) {
                            throw new RuntimeException("警告，该sql没有where条件，请检查逻辑是否正确。psm=" + this.psm + "sql=" + executeSql);
                        } else {
                            log.error("注意，该sql没有where条件，请检查逻辑是否正确。psm=" + this.psm + "sql=" + executeSql);
                        }

                    }
                    if (executeSql.contains("where")) {
                        int wherePosition = executeSql.indexOf("where");
                        String substring = StringUtils.trim(executeSql.substring(wherePosition + 5));
                        if (StringUtils.isBlank(substring)) {
                            if (MybatisConditionDetectionEnum.THROW_ERROR == conditionDetection) {
                                throw new RuntimeException("警告，该sql语句where后缺少条件！请检查逻辑是否正确。psm=" + this.psm + "sql=" + executeSql);
                            } else {
                                log.error("警告，该sql语句where后缺少条件！请检查逻辑是否正确。psm=" + this.psm + "sql=" + executeSql);
                            }
                        }
                    }
                }
                // 自定义sql方法并且不包含增删改查关键字的不予处理
                else {
                    continue;
                }
            }
        }
        //继续执行逻辑
        return invocation.proceed();
    }


    @Override
    public Object plugin(Object o) {
        //获取代理权
        if (o instanceof Executor) {
            //如果是Executor（执行增删改查操作），否则拦截下来
            return Plugin.wrap(o, this);
        } else {
            return o;
        }
    }


    @Override
    public void setProperties(Properties properties) {
    }
}</code></pre> 
<p><strong>条件检测插件自动装配类(根据条件检测配置类是否存在，灵活注入条件检测拦截器)</strong></p> 
<pre><code class="language-java">
/**
 * Mybatis条件检测自动装配类
 *
 * @date 2022/06/12
 */
@Configuration
public class MybatisConditionDetectionConfiguration {

    @Value("${spring.application.name}")
    private String psm;

    @Bean
    @ConditionalOnBean(MybatisConditionDetectionProperties.class)
    public Interceptor mybatisConditionDetectionInterceptor(MybatisConditionDetectionProperties mybatisConditionDetectionProperties) {
        return new MybatisConditionDetectionInterceptor();
    }
}</code></pre> 
<h4>调试截图：</h4> 
<p>动态sql条件检测调试</p> 
<ul><li>测试插入数据，测试空条件更新数据             ​​​ <img alt="" height="305" src="https://images2.imgbox.com/c0/4c/qKzdRzrh_o.png" width="1200"><img alt="" height="406" src="https://images2.imgbox.com/bf/fd/SVoUDUgC_o.png" width="1200"></li><li>测试有条件更新数据<img alt="" height="107" src="https://images2.imgbox.com/2c/3c/sZjufzkq_o.png" width="1200"><img alt="" height="220" src="https://images2.imgbox.com/16/34/yNaCaq9j_o.png" width="1200"></li><li>测试有条件查询语句        <img alt="" height="65" src="https://images2.imgbox.com/e7/12/OpDLJYS4_o.png" width="1200"><img alt="" height="469" src="https://images2.imgbox.com/84/fc/urZWMlnJ_o.png" width="1200"></li><li> <p>测试有条件删除语句<img alt="" height="61" src="https://images2.imgbox.com/8f/37/aHs4D5Ia_o.png" width="1200"></p> <p><img alt="" height="466" src="https://images2.imgbox.com/99/fd/TjSiwGRb_o.png" width="1200"></p> </li></ul> 
<p>example方式生成的sql条件检测调试</p> 
<ul><li>测试插入数据<img alt="" height="776" src="https://images2.imgbox.com/e2/fb/hKZLowVR_o.png" width="1200"><img alt="" height="466" src="https://images2.imgbox.com/3a/11/Lju3NVuY_o.png" width="1200"></li></ul> 
<ul><li> <p>测试空条件更新数据<img alt="" height="178" src="https://images2.imgbox.com/7c/f4/QUOM6gE7_o.png" width="1200"></p> <p><img alt="" height="261" src="https://images2.imgbox.com/05/9f/Z8UZynI5_o.png" width="1200"></p> </li></ul> 
<ul><li> <p>测试有条件更新数据<img alt="" height="119" src="https://images2.imgbox.com/2f/82/Ecrw0BZ5_o.png" width="1200"></p> <p><img alt="" height="285" src="https://images2.imgbox.com/52/61/GG0aRDvv_o.png" width="1200"></p> </li><li> <p>测试有条件查询数据<img alt="" height="133" src="https://images2.imgbox.com/6a/45/aThk4oUZ_o.png" width="1200"></p> <p><img alt="" height="290" src="https://images2.imgbox.com/79/74/cRMSEAgQ_o.png" width="1200"></p> </li><li> <p>测试有条件删除数据<img alt="" height="179" src="https://images2.imgbox.com/48/5e/geDxLBdV_o.png" width="1200"></p> <p><img alt="" height="317" src="https://images2.imgbox.com/54/11/5mw0IZJG_o.png" width="1200"></p> <h3>参考资料</h3> <p><a href="https://blog.csdn.net/minghao0508/article/details/124420442" title="编码技巧——数据加密（二）Mybatis拦截器">编码技巧——数据加密（二）Mybatis拦截器</a></p> <p><a href="https://www.jianshu.com/p/2ca0ba6f3531" rel="nofollow" title="@Configuration注解深入详解">@Configuration注解深入详解</a></p> <p><a href="https://blog.csdn.net/weixin_38972910/article/details/123578914" title="@EnableConfigurationProperties注解">@EnableConfigurationProperties注解</a></p> <p><a href="https://www.jianshu.com/p/7f54da1cb2eb" rel="nofollow" title="关与 @EnableConfigurationProperties 注解">关与 @EnableConfigurationProperties 注解</a></p> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a74e5fcfd50194fa0835bb1833fb670b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Java编码】使用java代码通过URL将图片下载保存到本地</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2641cc329ecbcc53726e7bcc7c89a6d3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何在MySQL中使用触发器？MySQL触发器详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>