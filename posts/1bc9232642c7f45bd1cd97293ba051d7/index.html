<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>音视频学习之rtsp推流学习1（rtspserver开源库example运行及流程梳理） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="音视频学习之rtsp推流学习1（rtspserver开源库example运行及流程梳理）" />
<meta property="og:description" content="工作需要实现一个rtsp的推流拉流业务流程，对开源项目rtspserver进行学习及理解。
参考系列rtspserver的文章：我的开源项目-RtspServer_JT同学的博客-CSDN博客_rtsp server
建立在个人对rtsp推流流程有一定理解的基础上，本文目的是通过开源库rtspserver实现推流，了解一下这个库，运行该库下相关demo，对理论做实践。
1：搭建环境 # git clone git@github.com:ImSjt/RtspServer.git #这里我是直接在github上下载的源码包解压 hlp@ubuntu:~/rtsp$ cd RtspServer-master/ hlp@ubuntu:~/rtsp/RtspServer-master$ ls example Makefile objs pic README.md src test hlp@ubuntu:~/rtsp/RtspServer-master$ make	#执行make进行编译 2：运行example 使用make后，在example目录下会生成一些列的测试可执行程序，直接对可执行程序进行运行测试：
这里的测试方案：
1：使用测试代码，使用rtsp进行推流。
2：使用vlc进行拉流播放，音频/视频/alsa采集/摄像头采集依次测试
2.1：example之测试音频aac文件 2.1.1：rtspserver运行example推流aac文件 （作为服务端使用rtsp推流） hlp@ubuntu:~/rtsp/RtspServer-master/example$ ./aac_rtsp_server test.aac Play the media using the URL &#34;rtsp://192.168.0.110:8554/live&#34; 2.1.2：同时，使用vlc进行拉流测试，分别使用默认udp和tcp进行测试 在偏好设置中，分别测试udp和tcp的逻辑。
选择tcp进行测试，如上图，使用抓包工具分析，简单看看协议，先不关注协议流程（rtsp，sdp，rtp，rtcp）协议的含义.大体分析
2.1.3：使用tcp进行测试，如上图选择： 使用wireshark对tcp流程进行抓包：
简单分析和观察，查看报文细节：
1：观察流程：可以发现在tcp的基础上，是rtsp进行交互，其中有看到sdp协商报文，最后通过rtp进行实际流的传输
2：观察每种报文的端口，发现这里所有的流都用的服务器的8554端口
3：这里本应该还有rtcp流，
2.1.4：使用udp进行测试，取消上图得选项，默认就是udp。 简单分析wireshark报文,会发现
1：rtsp报文进行交互控制，sdp进行媒体协商，最后再通过rtsp确定了rtp和rtcp使用方式是udp并且端口是64164~64165
2：会发现实际数据传输用的udp协议(rtp基于udp进行），rtp用得端口64164
3：发现有rtcp报文，用的64165端口
2.1.5：结果： 使用vlc工具进行拉流测试得，点击媒体==》打开网络串流==》
使用这个开源库进行推流和拉流测试时，明显的发现音频播放是卡断的，简单看源码应该于文件得读取发送定时器方案有关。
2.2：example之测试图像h264文件，无音频 2.2.1：服务端启动推流，推送h264视频文件 hlp@ubuntu:~/rtsp/RtspServer-master/example$ ./h264_rtsp_server test.h264 Play the media using the URL &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1bc9232642c7f45bd1cd97293ba051d7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-13T00:40:42+08:00" />
<meta property="article:modified_time" content="2022-01-13T00:40:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">音视频学习之rtsp推流学习1（rtspserver开源库example运行及流程梳理）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>工作需要实现一个rtsp的推流拉流业务流程，对开源项目rtspserver进行学习及理解。</p> 
<p>参考系列rtspserver的文章：<a href="https://blog.csdn.net/weixin_42462202/article/details/98956346">我的开源项目-RtspServer_JT同学的博客-CSDN博客_rtsp server</a></p> 
<p>建立在个人对rtsp推流流程有一定理解的基础上，本文目的是通过开源库rtspserver实现推流，了解一下这个库，运行该库下相关demo，对理论做实践。</p> 
<h2><a id="1_8"></a>1：搭建环境</h2> 
<pre><code class="prism language-bash"><span class="token comment"># git clone git@github.com:ImSjt/RtspServer.git</span>
<span class="token comment">#这里我是直接在github上下载的源码包解压</span>
hlp@ubuntu:~/rtsp$ <span class="token function">cd</span> RtspServer-master/
hlp@ubuntu:~/rtsp/RtspServer-master$ <span class="token function">ls</span>
example  Makefile  objs  pic  README.md  src  <span class="token function">test</span>
hlp@ubuntu:~/rtsp/RtspServer-master$ <span class="token function">make</span>		<span class="token comment">#执行make进行编译</span>
</code></pre> 
<h2><a id="2example_19"></a>2：运行example</h2> 
<p>使用make后，在example目录下会生成一些列的测试可执行程序，直接对可执行程序进行运行测试：</p> 
<p>这里的测试方案：</p> 
<p>1：使用测试代码，使用rtsp进行推流。</p> 
<p>2：使用vlc进行拉流播放，音频/视频/alsa采集/摄像头采集依次测试</p> 
<h3><a id="21exampleaac_29"></a>2.1：example之测试音频aac文件</h3> 
<h4><a id="211rtspserverexampleaac_rtsp_31"></a>2.1.1：rtspserver运行example推流aac文件 （作为服务端使用rtsp推流）</h4> 
<pre><code class="prism language-bash">hlp@ubuntu:~/rtsp/RtspServer-master/example$ ./aac_rtsp_server test.aac 
Play the media using the URL <span class="token string">"rtsp://192.168.0.110:8554/live"</span>
</code></pre> 
<h4><a id="212vlcudptcp_38"></a>2.1.2：同时，使用vlc进行拉流测试，分别使用默认udp和tcp进行测试</h4> 
<p>在偏好设置中，分别测试udp和tcp的逻辑。<br> <img src="https://images2.imgbox.com/1b/db/dGyR6bOa_o.png" alt="在这里插入图片描述"></p> 
<p>选择tcp进行测试，如上图，使用抓包工具分析，简单看看协议，先不关注协议流程（rtsp，sdp，rtp，rtcp）协议的含义.大体分析</p> 
<h4><a id="213tcp_46"></a>2.1.3：使用tcp进行测试，如上图选择：</h4> 
<p><strong>使用wireshark对tcp流程进行抓包</strong>：<br> <img src="https://images2.imgbox.com/70/d5/ztJuxbnR_o.png" alt="在这里插入图片描述"></p> 
<p>简单分析和观察，查看报文细节：</p> 
<p>1：观察流程：可以发现在tcp的基础上，是rtsp进行交互，其中有看到sdp协商报文，最后通过rtp进行实际流的传输</p> 
<p>2：观察每种报文的端口，发现这里所有的流都用的服务器的8554端口</p> 
<p>3：这里本应该还有rtcp流，</p> 
<h4><a id="214udpudp_59"></a>2.1.4：使用udp进行测试，取消上图得选项，默认就是udp。</h4> 
<p><img src="https://images2.imgbox.com/62/e2/6CykgCpN_o.png" alt="在这里插入图片描述"></p> 
<p>简单分析wireshark报文,会发现</p> 
<p>1：rtsp报文进行交互控制，sdp进行媒体协商，最后再通过rtsp确定了rtp和rtcp使用方式是udp并且端口是64164~64165</p> 
<p>2：会发现实际数据传输用的udp协议(rtp基于udp进行），rtp用得端口64164</p> 
<p>3：发现有rtcp报文，用的64165端口</p> 
<h4><a id="215_70"></a>2.1.5：结果：</h4> 
<p>使用vlc工具进行拉流测试得，点击媒体==》打开网络串流==》<br> <img src="https://images2.imgbox.com/2b/df/aHFEa4WJ_o.png" alt="在这里插入图片描述"></p> 
<p>使用这个开源库进行推流和拉流测试时，明显的<strong>发现音频播放是卡断的</strong>，简单看源码应该于文件得读取发送定时器方案有关。</p> 
<h3><a id="22exampleh264_77"></a>2.2：example之测试图像h264文件，无音频</h3> 
<h4><a id="221h264_79"></a>2.2.1：服务端启动推流，推送h264视频文件</h4> 
<pre><code class="prism language-bash">hlp@ubuntu:~/rtsp/RtspServer-master/example$ ./h264_rtsp_server test.h264 
Play the media using the URL <span class="token string">"rtsp://192.168.0.110:8554/live"</span>
</code></pre> 
<h4><a id="222tcpvlc_86"></a>2.2.2：首先是偏好设置设为tcp，使用vlc进行拉流播放，同时抓流进行查看：</h4> 
<p><img src="https://images2.imgbox.com/92/b7/9Zu9TAdi_o.png" alt="在这里插入图片描述"></p> 
<p>简单分析查看：</p> 
<p>1：rtsp进行流程控制交互（基于tcp，端口8554），经过sdp媒体协商，流程后，使用rtp（基于tcp，同样8554）端口进行数据传输。</p> 
<p>2：vlc进行拉流播放，能正常现实视频图像，但是<strong>会发现等待时间明显过长</strong>，（图像资源得显示问题）</p> 
<h4><a id="223udpvlcudp_95"></a>2.2.3：偏好设置为udp，使用vlc进行拉流，抓包看看udp得逻辑：</h4> 
<p><img src="https://images2.imgbox.com/52/81/xzg1jQz1_o.png" alt="在这里插入图片描述"></p> 
<p>简单查看分析后：</p> 
<p>1：rtsp贯穿整个流程控制协议得交互，rtp报文是实际数据流得数据，rtcp报文是rtp控制报文，sdp是媒体协商报文</p> 
<p>2：这里大概分析逻辑，可以发现使用udp作为rtp底层协议时，有端口得协商，后面rtp/rtcp的传输基于这里的端口。</p> 
<p>3：视频播放延迟过高。</p> 
<h3><a id="23exampleaach264_106"></a>2.3：example之测试视频aac+h264</h3> 
<h4><a id="231rtspserverdemo_108"></a>2.3.1：rtspserver服务端运行测试demo</h4> 
<pre><code class="prism language-bash">hlp@ubuntu:~/rtsp/RtspServer-master/example$ ./h264_aac_rtsp_server test.h264 test.aac 
Play the media using the URL <span class="token string">"rtsp://192.168.0.110:8554/live"</span>
</code></pre> 
<h4><a id="232tcpvlc_115"></a>2.3.2：首先偏好设置为tcp，使用vlc进行拉流测试，抓包简单查看：</h4> 
<p><img src="https://images2.imgbox.com/d9/a1/rehVadqd_o.png" alt="在这里插入图片描述"></p> 
<p>简单分析：</p> 
<p>1：rtsp协议进行控制报文，进行传输数据前的相关控制交互逻辑，媒体协商sdp，协商rtp用的传输方式是tcp</p> 
<p>2：可以看到，有图像和音频的时候，实际传输的时候有两个类型96和97</p> 
<h4><a id="233udpvlc_125"></a>2.3.3：设置偏好设置为udp，使用vlc进行拉流测试，抓包进行查看：</h4> 
<p><img src="https://images2.imgbox.com/6e/15/VpYorMgx_o.png" alt="在这里插入图片描述"></p> 
<p>简单分析后：</p> 
<p>1：rtsp进行协议控制以及相关协商，除了sdp协商外，还有相关流的端口协商。</p> 
<p>2：这里使用的是基于udp的rtp传输方式，这里如图，可以看到有两次的流端口协商。</p> 
<p>第一次的流track协商：<br> <img src="https://images2.imgbox.com/ea/d4/2MKYK6EZ_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到，video流编号对应96的rtp包用了该端口，其对应的rtcp用了56401端口<br> <img src="https://images2.imgbox.com/22/5d/Qm4i2KGL_o.png" alt="在这里插入图片描述"></p> 
<p>从sdp媒体协商中可以看到：vedio 是96 audio是97<br> <img src="https://images2.imgbox.com/a1/74/l0YyLPx2_o.png" alt="在这里插入图片描述"></p> 
<p>另外一个audio对应的端口协商是另一个报文，同样的逻辑。</p> 
<h3><a id="24examplealsa_145"></a>2.4：example测试之使用alsa采集音频测试</h3> 
<p>以前使用linux虚拟机播放音频文件时，使用过alsa，可以用alsa基于linux实现音频的播放或者采集。</p> 
<p>以前使用alsa实现播放aac,mp3,wav文件的测试，做过一些基础整理：<a href="https://blog.csdn.net/yun6853992/article/details/118076930">音频播放的一些整理_yun6853992的博客-CSDN博客</a></p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libasound2-dev
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libfaac-dev
<span class="token comment">#修改rtsp库makefile： ALSA_SUPPORT=y</span>
<span class="token function">make</span>
<span class="token comment">#执行测试用例</span>
root@ubuntu:/home/hlp/rtsp/RtspServer-master/example<span class="token comment"># ./alsa_rtsp_server hw:0,0</span>
Play the media using the URL <span class="token string">"rtsp://192.168.0.110:8554/live"</span>
2022-01-13 00:22:20 <span class="token operator">&lt;</span>WARNING<span class="token operator">&gt;</span> /home/hlp/rtsp/RtspServer-master/src/extend/alsa/AlsaMediaSource.cpp:readFrame:57 overrun occurred
</code></pre> 
<p>使用vlc进行拉流：</p> 
<p><strong>发现可以听到采集到的音频数据</strong></p> 
<h3><a id="25exampleV4L2_166"></a>2.5：example测试之使用V4L2采集摄像头测试</h3> 
<p>没用过，试试：</p> 
<h4><a id="251x264_170"></a>2.5.1：安装x264:</h4> 
<p>以前整理过linux上ffmpeg以及相关音频库的安装方式，可以参考：<a href="https://blog.csdn.net/yun6853992/article/details/118027370">音视频linux环境安装ffmpeg_yun6853992的博客-CSDN博客</a></p> 
<pre><code class="prism language-bash"><span class="token function">wget</span> https://www.nasm.us/pub/nasm/releasebuilds/2.14.02/nasm-2.14.02.tar.bz2
<span class="token function">tar</span> xjvf nasm-2.14.02.tar.bz2 
<span class="token function">cd</span> nasm-2.14.02/
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> autoconf 
./autogen.sh 
./configure 
<span class="token function">make</span>
<span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span>

<span class="token function">wget</span> https://www.nasm.us/pub/nasm/releasebuilds/2.14.02/nasm-2.14.02.tar.bz2
<span class="token function">tar</span> xjvf nasm-2.14.02.tar.bz2
./configure 
./configure --enable-shared --enable-static   <span class="token comment">#这一步非常重要 </span>
<span class="token function">make</span>
<span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span>

<span class="token comment">#./v4l2_rtsp_server: error while loading shared libraries: libx264.so.164: cannot open shared object file: No such file or directory</span>
<span class="token function">sudo</span> <span class="token function">vi</span> /etc/ld.so.conf   <span class="token comment">#增加/usr/local/lib</span>
<span class="token function">sudo</span> /sbin/ldconfig
</code></pre> 
<h4><a id="252demo_196"></a>2.5.2：运行测试demo，</h4> 
<p>修改makefile，V4L2_SUPPORT=y</p> 
<p>执行make后，example目录下生成测试可执行文件v4l2_rtsp_server</p> 
<p>这里使用虚拟机server测试，流程及逻辑已经打通，可以用桌面版虚拟机测试。</p> 
<h2><a id="3_204"></a>3：总结</h2> 
<p>rtspserver实现了推送给本地aac，h264, 使用摄像头采集图像，使用alsa采集音频的功能。</p> 
<p>因为接触过一些音视频的基础，感觉基本测试demo能成功，但是更偏向于demo，需要一定的调优。</p> 
<p>做练习仅仅为了巩固自己的理论知识，以及梳理rtsp的逻辑，以及为后面做准备。</p> 
<h2><a id="_212"></a>理论沉淀及参考</h2> 
<p>音视频相关理论学习及实践参考：<a href="https://ke.qq.com/course/3202131?flowToken=1041281" rel="nofollow">推荐免费订阅</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ccf122a37e0085e98b3b7252bdc3658f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ES 实用查询、url search 整理、sql 查询对比</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4dacf084aa295641d4e1297c1a4e4f0d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">密码学一些概念名词</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>