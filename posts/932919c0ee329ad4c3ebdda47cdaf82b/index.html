<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用spm预处理fMRI数据 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用spm预处理fMRI数据" />
<meta property="og:description" content="新手学习，记录学习笔记，欢迎交流~
1.基本概念
Volume（容积/体积）/frame/time point（因为4d文件是包含时间的，可以称为时间点）/scan/一个TR即一帧(frame)采集到的图像称为一个volume，每一帧图像都是一个3D全脑
TR：重复时间，即得到一个完整大脑所需时间
TA：一次全脑扫描中，最后一层与第一层的时间间隔；
TA=TR-（TR/扫描层数）
slice timing：扫描层数。扫描大脑是一层一层扫描的，通常是隔层扫描，因为信号可能会受到相邻层的影响，所以需要隔层扫，比如先扫1 3 5 7再倒回去扫2 4 6 8层这样。然后再把这些层重建成一个完整的3D大脑。
Run/Session： 一次4D-fMRI数据采集，整个4D-fMRI的采集时间；推荐参数：至少6分钟，8分钟及以上最优。一般静息态是1个，如果是任务态，那么可能中途要休息一次分两次扫描，session就是2个。
Reference slice：时间层校正的参考层，也就是TR/2对应的层数
时间层校正后的文件带有a开头，表示校正后。
2.预处理流程--NARWSDCF
N：格式转换，把存储原始fMRI信息的数据转换为NIFTI格式
A：时间层校正，变为a开头文件
R：realign--estimate&amp;res头动校正：统计分析需要假设每个体素在各个时间点都对应大脑的同一个位置。头动校正是去除头动的干扰
W：分为一步配准和两步配准，这里是两步配准：
·normalize--estimate&amp;write空间标准化：将个体的BOLD图像转化到标准空间
·coregister配准：把高分辨率、高灰质/白质对比度的T1像配准到BOLD空间，结构像与功能像配准
·segement：分割灰质，白质和脑脊液
S：smooth：空间平滑
D：detrend去除线性趋势：去除大时间尺度上，非神经活动引起的BOLD信号的偏移
C：nuisance coviriates regression 回归协变量
F：filter 滤波：滤出BOLD信号所处的频率段的数据。目的是降噪。BOLD信号所处0.01~0.08hz
然后
（1）首先是格式转换：使用dcm2niigui，将原始数据文件夹整个拖进去
或者使用microGL（既可看图又可转换文件）
（2）第二步是A：时间层校正，
打开spm，点击slice timing--data--点击session
导入进nii文件，注意把右下角的1换为inf（无限的意思），然后右键--select all
（可以提前把matlab的路径设置成存放文件的路径，这样方便选择）
frame：1 --第一帧的图像 ，一般写成inf（无穷，可以包含所有的图像）
filter旁边的白色长空格可以输入文件名来筛选文件
选完点done
扫描层数：33层 填写TA
扫描顺序：1是首项，2是步长，33是尾项；两个等差数列之间用空格隔开（会自动判断是否结束）。翻译过来就是1 3 5 7层 ... 2 4 6 8层...这样的扫描顺序
参考层：中间层的层数（第33层）
填好了然后点绿色的符号开run！
（3）R：realign 头动校正
双击
只筛选以a为开头的文件（上一步生成的时间校正后的文件）
文件选中就可以运行了。Num passes 后面的register to mean：选中to fist 与第一张图象对齐，to mean，就是与平均的对齐" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/932919c0ee329ad4c3ebdda47cdaf82b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-03T19:46:34+08:00" />
<meta property="article:modified_time" content="2023-03-03T19:46:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用spm预处理fMRI数据</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>新手学习，记录学习笔记，欢迎交流~</p> 
<p>1.基本概念</p> 
<p>Volume（容积/体积）/frame/time point（因为4d文件是包含时间的，可以称为时间点）/scan/一个TR即一帧(frame)采集到的图像称为一个volume，每一帧图像都是一个3D全脑</p> 
<p>TR：重复时间，即得到一个完整大脑所需时间</p> 
<p style="margin-left:.0001pt;text-align:justify;">TA：一次全脑扫描中，最后一层与第一层的时间间隔；</p> 
<p style="margin-left:.0001pt;text-align:justify;">TA=TR-（TR/扫描层数）</p> 
<p style="margin-left:.0001pt;text-align:justify;">slice timing：扫描层数。扫描大脑是一层一层扫描的，通常是隔层扫描，因为信号可能会受到相邻层的影响，所以需要隔层扫，比如先扫1 3 5 7再倒回去扫2 4 6 8层这样。然后再把这些层重建成一个完整的3D大脑。</p> 
<p style="margin-left:.0001pt;text-align:justify;">Run/Session： 一次4D-fMRI数据采集，整个4D-fMRI的采集时间；推荐参数：至少6分钟，8分钟及以上最优。一般静息态是1个，如果是任务态，那么可能中途要休息一次分两次扫描，session就是2个。</p> 
<p style="margin-left:.0001pt;text-align:justify;">Reference slice：时间层校正的参考层，也就是TR/2对应的层数</p> 
<p style="margin-left:.0001pt;text-align:justify;">时间层校正后的文件带有a开头，表示校正后。</p> 
<p style="margin-left:.0001pt;text-align:justify;">2.预处理流程--NARWSDCF</p> 
<p style="margin-left:.0001pt;text-align:justify;">N：<span style="color:#0000ff;">格式转换</span>，把存储原始fMRI信息的数据转换为NIFTI格式</p> 
<p style="margin-left:.0001pt;text-align:justify;">A：<span style="color:#0000ff;">时间层校正</span>，变为a开头文件</p> 
<p style="margin-left:.0001pt;text-align:justify;">R：realign--estimate&amp;res<span style="color:#0000ff;">头动校正：</span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">统计分析需要假设每个体素在各个时间点都对应大脑的同一个位置。头动校正是去除头动的干扰</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">W：分为一步配准和两步配准，这里是两步配准：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><strong>·</strong>normalize--estimate&amp;write<span style="color:#0000ff;">空间标准化：</span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">将个体的BOLD图像转化到标准空间</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><strong>·</strong>coregister<span style="color:#0000ff;">配准：</span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">把高分辨率、高灰质/白质对比度的T1像配准到BOLD空间，结构像与功能像配准</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;"><strong>·</strong>segement：</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">分割灰质，白质和脑脊液</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">S：smooth：<span style="color:#0000ff;">空间平滑</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">D：detrend</span>去除线性趋势：去除大时间尺度上，非神经活动引起的BOLD信号的偏移</p> 
<p style="margin-left:.0001pt;text-align:justify;">C：nuisance coviriates regression 回归协变量</p> 
<p style="margin-left:.0001pt;text-align:justify;">F：filter <span style="color:#0000ff;">滤波</span>：滤出BOLD信号所处的频率段的数据。目的是降噪。BOLD信号所处<strong>0.01~0.08hz</strong><br> 然后</p> 
<p></p> 
<p></p> 
<p>（1）首先是格式转换：使用dcm2niigui，将原始数据文件夹整个拖进去</p> 
<p><img alt="" height="416" src="https://images2.imgbox.com/c1/dd/j2JmmQXa_o.png" width="720"></p> 
<p> </p> 
<p>或者使用microGL（既可看图又可转换文件）</p> 
<p><img alt="" height="605" src="https://images2.imgbox.com/a6/52/KJznBrCz_o.png" width="831"></p> 
<p> </p> 
<p>（2）第二步是A：<span style="color:#0000ff;">时间层校正</span>，</p> 
<p>打开spm，点击slice timing--data--点击session</p> 
<p><img alt="" height="725" src="https://images2.imgbox.com/3d/e5/rQCFDu74_o.png" width="720"></p> 
<p> 导入进nii文件，注意把右下角的1换为inf（无限的意思），然后右键--select all</p> 
<p>（可以提前把matlab的路径设置成存放文件的路径，这样方便选择）</p> 
<p><img alt="" height="497" src="https://images2.imgbox.com/4f/8f/FbzXSDA8_o.png" width="720"></p> 
<p></p> 
<p> </p> 
<p style="margin-left:0;text-align:left;">frame：1  --第一帧的图像 ，一般写成inf（无穷，可以包含所有的图像）</p> 
<p style="margin-left:0;text-align:left;">filter旁边的白色长空格可以输入文件名来筛选文件</p> 
<p style="margin-left:0;text-align:left;">选完点done</p> 
<p style="margin-left:0;text-align:left;"><img alt="" height="525" src="https://images2.imgbox.com/0a/3a/75FG6ATh_o.png" width="720"></p> 
<p>扫描层数：33层 </p> 
<p> <img alt="" height="525" src="https://images2.imgbox.com/79/5b/SnTEdDGL_o.png" width="720"></p> 
<p> 填写TA</p> 
<p><img alt="" height="758" src="https://images2.imgbox.com/36/75/FIFZOjvP_o.png" width="720"></p> 
<p>扫描顺序：1是首项，2是步长，33是尾项；两个等差数列之间用空格隔开（会自动判断是否结束）。翻译过来就是1 3 5 7层 ... 2 4 6 8层...这样的扫描顺序</p> 
<p><img alt="" height="902" src="https://images2.imgbox.com/45/68/LNRwW5VO_o.png" width="831"></p> 
<p></p> 
<p>参考层：中间层的层数（第33层）</p> 
<p> 填好了然后点绿色的符号开run！</p> 
<p>（3）R：realign 头动校正</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"><img alt="" height="443" src="https://images2.imgbox.com/c9/6d/lODzHx29_o.png" width="520"><img alt="" height="439" src="https://images2.imgbox.com/50/79/35BCnLW9_o.png" width="520"></p> 
<p> </p> 
<p style="margin-left:0;text-align:left;">双击</p> 
<p> </p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">只筛选以a为开头的文件（上一步生成的时间校正后的文件）</p> 
<p style="margin-left:0;text-align:left;"><img alt="" height="528" src="https://images2.imgbox.com/0e/29/Sbc89cwh_o.png" width="562"></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">文件选中就可以运行了。Num passes 后面的register to mean：选中to fist 与第一张图象对齐，to mean，就是与平均的对齐</p> 
<p style="margin-left:0;text-align:left;"><img alt="" height="72" src="https://images2.imgbox.com/66/14/1gv3JyAp_o.png" width="720"> 处理完一共多了这三个文件，txt的Rotation parameter：头动参数；看它有没有超过2的（控制）但spm不做处理，只有原始数据，一般不会人工手动筛选。（用<strong>restplus</strong>可以自动筛选）</p> 
<p style="margin-left:0;text-align:left;">（4）W:两步配准法</p> 
<p style="margin-left:0;text-align:left;">    一步配准法（EPI配准）：个体fMRI---线性+非线性---&gt;标准空间fMRI（Normalize(Est&amp;Wri)）<br>     两步配准法（T1配准）（EPI distortion）：<br>     1.个体T1---线性----&gt;配准到个体fMRI的个体T1（Coregister(Estimate))<br>     2.配准到个体fMRI的个体T1---&gt;线性+非线性----&gt;个体到标准空间的形变场（Segment）--形变场记录了卷纸是如何变成和抽纸一样形状的过程<br>     3.个体fMRI---应用第二步的形变场---&gt;标准空间fMRI（Normaliz&amp;Write）</p> 
<p style="margin-left:0;text-align:left;">根据情况选择不同的配准法，这里介绍两步配准法</p> 
<p style="margin-left:0;text-align:left;"><img alt="" height="671" src="https://images2.imgbox.com/e9/53/vIovZT3B_o.png" width="831"></p> 
<p>T1选为source image </p> 
<p></p> 
<p><img alt="" height="923" src="https://images2.imgbox.com/e4/ee/leW1xHPA_o.png" width="1089"> </p> 
<p>voxel改为3 3 3</p> 
<p><img alt="" height="509" src="https://images2.imgbox.com/ca/91/8ZqD1uv6_o.png" width="720"> </p> 
<p>设置bounding box边界框：固定值，代表生成文件图像整体的范围是多少</p> 
<p>然后点segment（也可以先选，之后来设置这些参数）</p> 
<p><img alt="" height="675" src="https://images2.imgbox.com/8e/81/Ezlmz5nL_o.png" width="831"></p> 
<p></p> 
<p>再选择normalise</p> 
<p><img alt="" height="609" src="https://images2.imgbox.com/ec/b9/kwsjK0yx_o.png" width="720"> </p> 
<p></p> 
<p>点dependency</p> 
<p><img alt="" height="601" src="https://images2.imgbox.com/d9/b6/ZBxpmDJQ_o.png" width="691"></p> 
<p><img alt="" height="752" src="https://images2.imgbox.com/0b/43/h9aAhcCV_o.png" width="720"> </p> 
<p><img alt="" height="675" src="https://images2.imgbox.com/8e/4c/bvB3GQVI_o.png" width="720"> </p> 
<p><img alt="" height="515" src="https://images2.imgbox.com/7b/fd/9LfbVfBy_o.png" width="831"> </p> 
<p></p> 
<p><img alt="" height="253" src="https://images2.imgbox.com/fd/81/0ReKJFEJ_o.png" width="830"></p> 
<p>修改boundingbox和体素3 3 3</p> 
<p><img alt="" height="334" src="https://images2.imgbox.com/58/4a/XkrTbQZN_o.png" width="831"> </p> 
<p>Run</p> 
<p>生成wra开头的文件 </p> 
<p style="margin-left:.0001pt;text-align:justify;">（5）平滑</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="224" src="https://images2.imgbox.com/f6/8e/HJeexBA8_o.png" width="830"></p> 
<p>把上一步的文件wra开头的导入，平滑核6 6 6（体素的2-3倍，一般就用2倍） </p> 
<p> run</p> 
<p>得到swra开头文件</p> 
<p><strong>剩下几步</strong>用restplus做（实际上上述步骤都可以用restplus批量处理）</p> 
<p style="margin-left:.0001pt;text-align:justify;">Restplus</p> 
<p style="margin-left:.0001pt;text-align:justify;">Set path--add with subfolders-添加restplus的文件夹</p> 
<p style="margin-left:.0001pt;text-align:justify;">打开pipeline</p> 
<p style="margin-left:.0001pt;text-align:justify;">Matlab切路径到restplus</p> 
<p> <img alt="" height="239" src="https://images2.imgbox.com/b2/89/4Mhi00HK_o.png" width="830"></p> 
<p>work directory选择所用文件的上一级文件夹</p> 
<p>EPI directory选择功能像，T1 directory选择T1的文件夹（原始数据） </p> 
<p><img alt="" height="501" src="https://images2.imgbox.com/36/c5/2SnPwa1X_o.png" width="831"></p> 
<p>其中，2和5可选可不选</p> 
<p>每一项的参数根据自己实际需要来调整即可（略） </p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p></p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/084c9b3b3a9882928226022462ff2ae0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C# 自定义常用的代码片段</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f9b77bb59c141f4b938595b1759c9650/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用蛋白ID如何进行KEGG和GO富集分析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>