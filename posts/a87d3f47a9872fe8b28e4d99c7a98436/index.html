<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>java 根据模板文件生成word文档 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="java 根据模板文件生成word文档" />
<meta property="og:description" content="原文链接：https://blog.csdn.net/zhangzhangjava/article/details/52937159
最近需要做一个导出word的功能, 在网上搜了下, 有用POI,JXL,iText等jar生成一个word文件然后将数据写到该文件中,API非常繁琐而且拼出来的样式也不美观,于是选择了另一种方式----feemarker基于word模板的导出方式, 这种方式非常简单而且导出的样式美观, 其原理就是先做一个word模板, 该模板中变量数据用${xxx}这种方式填写, 然后再导出时只需读取模板然后用相应的数据替换其中的${xxx}即可. 一,简单模板导出(不含图片, 不含表格循环) 1, 新建一个word文档, 输入如下类容: 2, 将该word文件另存为xml格式(注意是另存为,不是直接改扩展名) 3, 将xml文件的扩展名直接改为ftl 4, 用java代码完成导出(需要导入freemarker.jar) Java代码：
@Test public void test(){ Map&lt;String,Object&gt; dataMap = new HashMap&lt;String, Object&gt;(); try { //编号 dataMap.put(&#34;id&#34;, &#34;123456&#34;); //日期 dataMap.put(&#34;date&#34;, new SimpleDateFormat(&#34;yyyy年MM月dd日&#34;).format(new SimpleDateFormat(&#34;yyyy-MM-dd&#34;).parse(&#34;2018-09-19&#34;))); //附件张数 dataMap.put(&#34;number&#34;, 1); //受款人 dataMap.put(&#34;payee&#34;, &#34;张三&#34;); //付款用途 dataMap.put(&#34;use_of_payment&#34;, &#34;test&#34;); //大写金额 dataMap.put(&#34;capitalization_amount&#34;, MoneyUtils.change(100.20)); //小写金额 dataMap.put(&#34;lowercase_amount&#34;, &#34;100&#34;); //Configuration 用于读取ftl文件 Configuration configuration = new Configuration(new Version(&#34;2.3.0&#34;)); configuration.setDefaultEncoding(&#34;utf-8&#34;); /** * 以下是两种指定ftl文件所在目录路径的方式，注意这两种方式都是 * 指定ftl文件所在目录的路径，而不是ftl文件的路径 */ //指定路径的第一种方式（根据某个类的相对路径指定） // configuration." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a87d3f47a9872fe8b28e4d99c7a98436/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-09-19T16:18:05+08:00" />
<meta property="article:modified_time" content="2018-09-19T16:18:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">java 根据模板文件生成word文档</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>  原文链接：<a href="https://blog.csdn.net/zhangzhangjava/article/details/52937159">https://blog.csdn.net/zhangzhangjava/article/details/52937159</a></p> 
<p> </p> 
<p>最近需要做一个导出word的功能, 在网上搜了下, 有用POI,JXL,iText等jar生成一个word文件然后将数据写到该文件中,API非常繁琐而且拼出来的样式也不美观,于是选择了另一种方式----feemarker基于word模板的导出方式, 这种方式非常简单而且导出的样式美观, 其原理就是先做一个word模板, 该模板中变量数据用${xxx}这种方式填写, 然后再导出时只需读取模板然后用相应的数据替换其中的${xxx}即可. </p> 
<p>     <br>        一,简单模板导出(不含图片, 不含表格循环) <br>          1, 新建一个word文档, 输入如下类容: <br>            <img alt="" class="has" height="468" src="https://images2.imgbox.com/5f/59/j1Q1fW1G_o.png" width="852"> <br>          2, 将该word文件另存为xml格式(注意是另存为,不是直接改扩展名) <br>          3, 将xml文件的扩展名直接改为ftl <br>          4, 用java代码完成导出(需要导入freemarker.jar) </p> 
<p>Java代码：</p> 
<pre class="has"><code class="language-java">@Test
    public void test(){
        Map&lt;String,Object&gt; dataMap = new HashMap&lt;String, Object&gt;();
        try {
            //编号
            dataMap.put("id", "123456");
            //日期
            dataMap.put("date", new SimpleDateFormat("yyyy年MM月dd日").format(new SimpleDateFormat("yyyy-MM-dd").parse("2018-09-19")));
            //附件张数
            dataMap.put("number", 1);
            //受款人
            dataMap.put("payee", "张三");
            //付款用途
            dataMap.put("use_of_payment", "test");
            //大写金额
            dataMap.put("capitalization_amount", MoneyUtils.change(100.20));
            //小写金额
            dataMap.put("lowercase_amount", "100");
            //Configuration 用于读取ftl文件
            Configuration configuration = new Configuration(new Version("2.3.0"));
            configuration.setDefaultEncoding("utf-8");

            /**
             * 以下是两种指定ftl文件所在目录路径的方式，注意这两种方式都是
             * 指定ftl文件所在目录的路径，而不是ftl文件的路径
             */
            //指定路径的第一种方式（根据某个类的相对路径指定）
//                configuration.setClassForTemplateLoading(this.getClass(), "");

            //指定路径的第二种方式，我的路径是C：/a.ftl
            configuration.setDirectoryForTemplateLoading(new File("c:/"));

            //输出文档路径及名称
            File outFile = new File("D:/报销信息导出.doc");

            //以utf-8的编码读取ftl文件
            Template template = configuration.getTemplate("报销信息导出.ftl", "utf-8");
            Writer out = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(outFile), "utf-8"), 10240);
            template.process(dataMap, out);
            out.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }</code></pre> 
<p><span style="color:#f33b45;">注意：我使用的 freemarker 版本为2.3.28，Configuration对象不推荐直接new Configuration()，仔细看Configuration.class文件会发现，推荐的是 Configuration(Version incompatibleImprovements) 这个构造方法，具体这个构造方法里面传的就是Version版本类，而且版本号不能低于2.3.0</span></p> 
<p> </p> 
<p> </p> 
<p><br>       5, 这时在D盘下就生成了一个test.word, 打开可以看到${xxx}已被替换  </p> 
<p><img alt="" class="has" height="412" src="https://images2.imgbox.com/0d/4d/hpxCveUT_o.png" width="877"><br><br>          二, word文件中导入图片 <br>           1, 新建一个word文档, 在要插入图片的地方随便插入一张图片 <br><img alt="" class="has" src="https://images2.imgbox.com/e1/f4/tH0e9m2d_o.jpg"> <br>           2, 将word另存为xml <br>           3, 将xml扩展名改为ftl <br>           4, 打开ftl文件, 搜索w:binData 或者 png可以快速定位图片的位置,图片 已经编码成0-Z的字符串了, 如下: <br><br><img alt="" class="has" src="https://images2.imgbox.com/c5/93/9K2KFL8h_o.jpg"><br>           5, 将上述0-Z的字符串全部删掉,写上${imgStr}(变量名随便写)后保存 <br>           6, 导入图片的代码与上述代码是一样的, 也是创建一个Map, 将数据存到map中,只不过我们要把图片用代码进行编码,将其也编成0-Z的字符串: </p> 
<pre class="has"><code class="language-java">Map&lt;String,String&gt; dataMap = new HashMap&lt;String,String&gt;();  
 dataMap.put("imgStr", getImageStr());  
  
//....其余省略 </code></pre> 
<p>  </p> 
<p><br><br> 这是对图片进行编码的代码: </p> 
<pre class="has"><code class="language-java">     public String getImageStr() {  
                 String imgFile = "d:/aa.png";  
                 InputStream in = null;  
                 byte[] data = null;  
                 try {  
                     in = new FileInputStream(imgFile);  
                     data = new byte[in.available()];  
                     in.read(data);  
                     in.close();  
                 } catch (Exception e) {  
                     e.printStackTrace();  
                 }  
                 BASE64Encoder encoder = new BASE64Encoder();  
                 return encoder.encode(data);  
             }  </code></pre> 
<p>  </p> 
<p><br> 注意: 该代码需要用到 sun.misc.BASE64Encoder 类,这个类就是JDK中的类,但在eclipse中默认是不访问的,需要设置一下,设置方式: <br> 项目上右键--&gt;Build Path--&gt;Configure Build Path... <br><br><img alt="" class="has" src="https://images2.imgbox.com/60/3a/AG58o1zE_o.jpg"> <br> 双击Access rules,点击add, 选择Accessible,下方输入**, OK , 这样就可以访问sun.misc.BASE64Encoder 类了 <br><br><br>    三, 导出循环的表格 <br>       1, 新建一个word文档, 插入如下表格: <br>        <br><img alt="" class="has" src="https://images2.imgbox.com/24/5a/HKeGLM80_o.jpg"> <br>        2, 另存为xml, 将扩展名改为ftl <br>        3, 搜索  w:tr 可以找到行的起点与结束点(注意第一对w:tr 是表头,应找第二对 w:tr), 如图: <br>       <br><img alt="" class="has" src="https://images2.imgbox.com/27/dd/nj2nKxwp_o.jpg"> <br>              <br><br>        4, 用&lt;#list userList as user&gt; &lt;/#list&gt;标签将第二对 w:tr 标签包围起来(userList是集合的key, user是集合中的每个元素, 类似&lt;c:forEach items='userList' var='user'&gt;), 如图: <br>      <br><img alt="" class="has" src="https://images2.imgbox.com/ab/8b/zKdfsIIU_o.jpg"> <br>        5, 解析该ftl文件 <br><br> 这是User类 </p> 
<pre class="has"><code class="language-java">     public class User {  
        private String a;  
        private String b;  
        private String c;  
    //生成set和get方法,此处省略  
    }  </code></pre> 
<p><br><br> 这是解析ftl文件的代码,跟上面一样,只是Map的value是一个集合而已 </p> 
<pre class="has"><code class="language-java">     @Test  
       public void exportListWord() throws Exception{  
           //构造数据  
           Map&lt;String,List&gt; dataMap = new HashMap&lt;String,List&gt;();  
           List&lt;User&gt; list = new ArrayList&lt;User&gt;();  
             for(int i=0;i&lt;10;i++){  
                 User user = new User();  
                 user.setA("a"+(i+1));  
                 user.setB("b"+(i+1));  
                 user.setC("c"+(i+1));  
                 list.add(user);  
             }  
             dataMap.put("userList", list);  
               
             Configuration configuration = new Configuration();  
             configuration.setDefaultEncoding("utf-8");  
             configuration.setDirectoryForTemplateLoading(new File("C:/"));  
             File outFile = new File("D:/test.doc");  
             Template t =  configuration.getTemplate("c.ftl","utf-8");  
             Writer out = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(outFile), "utf-8"),10240);  
             t.process(dataMap, out);  
             out.close();  
       }  </code></pre> 
<p><br> 如果你需要输出集合的索引, 用${user_index}即可. <br><br> 四, 常见问题解决方案 <br> 4.1, 异常信息如下:</p> 
<pre class="has"><code>     freemarker.core.ParseException: Encountered "&lt;" at line 3, column 28888 in test.ftl.  
    Was expecting one of:  
        &lt;STRING_LITERAL&gt; ...  
        &lt;RAW_STRING&gt; ...  
        "false" ...  
        "true" ...  
        &lt;INTEGER&gt; ...  
        &lt;DECIMAL&gt; ...  
        "." ...  
        "+" ...  
        "-" ...  
        "!" ...  
        "[" ...  
        "(" ...  </code></pre> 
<p><br><br>   这是由于在写${xxx}表达式的时候, xxx与其前方的文字样式不一致, 在另存为xml后你可以搜索一下 "${" , 会发现如下图这种情况: <br><br><img alt="" class="has" src="https://images2.imgbox.com/79/67/47nuiuaE_o.png"> <br><br> 由于${xxx}中的xxx格式与其前方的文字不一致, 那么在生成xml时,就会有一些修饰xxx样式的标签,例如修饰xxx的字体,颜色等的标签, 所以在word中看似写的是${xxx}实际上转为xml后变成了${&lt;w:color ...&gt;xxx&lt;/w:color&gt;},这样这个el表达式中的标签就解析不了报错了, 可以去掉${}内部的标签只留下xxx或者删掉 "${" 和 "}"然后给xxx加上el表达式都可以解决此问题. <br><br>    五, javaWeb中利用response导出(注意编码问题,防止中文乱码) </p> 
<pre class="has"><code class="language-java">     Map&lt;String,String&gt; dataMap = new HashMap&lt;String,String&gt;();  
              dataMap.put("username", "张三");  
              dataMap.put("sex", "男");  
                
              Configuration configuration = new Configuration();  
              configuration.setDefaultEncoding("utf-8");  
              configuration.setDirectoryForTemplateLoading(new File(request.getRealPath("/")+"/templete"));//指定ftl所在目录,根据自己的改  
              response.setContentType("application/msword");     
              response.setHeader("Content-Disposition", "attachment;filename=\"" + new String("文件名.doc".getBytes("GBK"), "iso8859-1") + "\"");  
              response.setCharacterEncoding("utf-8");//此句非常关键,不然word文档全是乱码  
              PrintWriter out = response.getWriter();  
             Template t =  configuration.getTemplate("test.ftl","utf-8");//以utf-8的编码读取ftl文件  
             t.process(dataMap, out);  
             out.close();  </code></pre> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c0c6a8b2277da17bfce196d7027a89b9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">什么是scala?scala有什么用？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ece78a70b624b88f562799ec52ddb02d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ServiceConnection</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>