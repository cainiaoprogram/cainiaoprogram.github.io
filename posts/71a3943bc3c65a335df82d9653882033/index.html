<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 应用使用数据统计服务——UsageStatsManager - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 应用使用数据统计服务——UsageStatsManager" />
<meta property="og:description" content="Android 应用使用数据统计服务——UsageStatsManager 先了解下相关知识
UsageStats UsageStats是在指定时间区间内某个应用使用统计数据的封装类。包含的公开方法及对应的作用如下：
方法用途getFirstTimeStamp()获取指定时间区间内应用第一次使用时间戳getLastTimeStamp()获取指定时间区间内应用最后一次使用时间戳getLastTimeUsed()获取应用最后一次使用时间戳getPackageName()获取应用包名getTotalTimeInForeground()获取应用在前台的时间 EventStats EventStats是在指定时间区间内某个类型事件统计数据的封装类。包含的公开方法及对应的作用如下：
方法用途getCount()获取在指定时间区间内事件发生的次数getEventType()获取事件类型getFirstTimeStamp()获取指定时间区间内这个事件第一次发生的时间戳getLastEventTime()获取这个事件最后一次发生的时间戳getLastTimeStamp()获取指定时间区间内这个事件最后一次发生的时间戳getTotalTime获取这个事件总共发生的次数 UsageEvents UsageEvents是用来返回指定时间区间内组件状态变化事件数据的封装类，其返回的组件状态变化事件类型如下：
UsageEvents.Event: public static final int NONE = 0; public static final int MOVE_TO_FOREGROUND = 1; public static final int MOVE_TO_BACKGROUND = 2; public static final int END_OF_DAY = 3; public static final int CONTINUE_PREVIOUS_DAY = 4; public static final int CONFIGURATION_CHANGE = 5; public static final int SYSTEM_INTERACTION = 6; public static final int USER_INTERACTION = 7; public static final int SHORTCUT_INVOCATION = 8; public static final int CHOOSER_ACTION = 9; public static final int NOTIFICATION_SEEN = 10; public static final int STANDBY_BUCKET_CHANGED = 11; public static final int NOTIFICATION_INTERRUPTION = 12; public static final int SLICE_PINNED_PRIV = 13; public static final int SLICE_PINNED = 14; public static final int SCREEN_INTERACTIVE = 15; public static final int SCREEN_NON_INTERACTIVE = 16; public static final int KEYGUARD_SHOWN = 17; public static final int KEYGUARD_HIDDEN = 18; UsageStatsManager **UsageStatsManager 是Android提供统计应用使用情况的服务。通过这个服务可以获取指定时间区间内应用使用统计数据、组件状态变化事件统计数据以及硬件配置信息统计数据。**提供的主要查询方法如下表：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/71a3943bc3c65a335df82d9653882033/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-03T09:29:50+08:00" />
<meta property="article:modified_time" content="2024-01-03T09:29:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 应用使用数据统计服务——UsageStatsManager</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Android_UsageStatsManager_0"></a>Android 应用使用数据统计服务——UsageStatsManager</h2> 
<p>先了解下相关知识</p> 
<h3><a id="UsageStats_4"></a>UsageStats</h3> 
<p><a href="https://developer.android.google.cn/reference/android/app/usage/UsageStats" rel="nofollow">UsageStats</a>是在指定时间区间内某个应用使用统计数据的封装类。包含的公开方法及对应的作用如下：</p> 
<table><thead><tr><th>方法</th><th>用途</th></tr></thead><tbody><tr><td>getFirstTimeStamp()</td><td>获取指定时间区间内应用第一次使用时间戳</td></tr><tr><td>getLastTimeStamp()</td><td>获取指定时间区间内应用最后一次使用时间戳</td></tr><tr><td>getLastTimeUsed()</td><td>获取应用最后一次使用时间戳</td></tr><tr><td>getPackageName()</td><td>获取应用包名</td></tr><tr><td>getTotalTimeInForeground()</td><td>获取应用在前台的时间</td></tr></tbody></table> 
<h3><a id="EventStats_16"></a>EventStats</h3> 
<p><a href="https://developer.android.google.cn/reference/android/app/usage/EventStats" rel="nofollow">EventStats</a>是在指定时间区间内某个类型事件统计数据的封装类。包含的公开方法及对应的作用如下：</p> 
<table><thead><tr><th>方法</th><th>用途</th></tr></thead><tbody><tr><td>getCount()</td><td>获取在指定时间区间内事件发生的次数</td></tr><tr><td>getEventType()</td><td>获取事件类型</td></tr><tr><td>getFirstTimeStamp()</td><td>获取指定时间区间内这个事件第一次发生的时间戳</td></tr><tr><td>getLastEventTime()</td><td>获取这个事件最后一次发生的时间戳</td></tr><tr><td>getLastTimeStamp()</td><td>获取指定时间区间内这个事件最后一次发生的时间戳</td></tr><tr><td>getTotalTime</td><td>获取这个事件总共发生的次数</td></tr></tbody></table> 
<h3><a id="UsageEvents_29"></a>UsageEvents</h3> 
<p><a href="https://developer.android.google.cn/reference/android/app/usage/UsageEvents" rel="nofollow">UsageEvents</a>是用来返回指定时间区间内组件状态变化事件数据的封装类，其返回的组件状态变化事件类型如下：</p> 
<pre><code class="prism language-java"><span class="token class-name">UsageEvents<span class="token punctuation">.</span>Event</span><span class="token operator">:</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NONE</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MOVE_TO_FOREGROUND</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MOVE_TO_BACKGROUND</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">END_OF_DAY</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CONTINUE_PREVIOUS_DAY</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CONFIGURATION_CHANGE</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SYSTEM_INTERACTION</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">USER_INTERACTION</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SHORTCUT_INVOCATION</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CHOOSER_ACTION</span> <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NOTIFICATION_SEEN</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STANDBY_BUCKET_CHANGED</span> <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NOTIFICATION_INTERRUPTION</span> <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SLICE_PINNED_PRIV</span> <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SLICE_PINNED</span> <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SCREEN_INTERACTIVE</span> <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SCREEN_NON_INTERACTIVE</span> <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">KEYGUARD_SHOWN</span> <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">KEYGUARD_HIDDEN</span> <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="UsageStatsManager_56"></a>UsageStatsManager</h2> 
<p>**<a href="https://developer.android.google.cn/reference/android/app/usage/UsageStatsManager" rel="nofollow">UsageStatsManager</a> 是Android提供统计应用使用情况的服务。通过这个服务可以获取指定时间区间内应用使用统计数据、组件状态变化事件统计数据以及硬件配置信息统计数据。**提供的主要查询方法如下表：</p> 
<table><thead><tr><th>方法</th><th>用途</th></tr></thead><tbody><tr><td>queryAndAggregateUsageStats(long beginTime, long endTime)</td><td>获取指定时间区间内使用统计数据，以应用包名为键值进行数据合并。</td></tr><tr><td>queryConfigurations(int intervalType, long beginTime, long endTime)</td><td>获取指定时间区间内硬件配置信息统计数据。</td></tr><tr><td>queryEventStats(int intervalType, long beginTime, long endTime)</td><td>获取指定时间区间内发生组件状态变化事件统计数据。</td></tr><tr><td>queryEvents(long beginTime, long endTime)</td><td>获取指定时间区间内组件状态变化事件</td></tr><tr><td>queryEventsForSelf(long beginTime, long endTime)</td><td>与queryEvents相似，获取指定时间区间内本应用的组件状态变化事件</td></tr><tr><td>queryUsageStats(int intervalType, long beginTime, long endTime)</td><td>获取指定时间区间内应用使用统计数据。</td></tr></tbody></table> 
<p>查询时间间隔如下：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERVAL_DAILY</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERVAL_WEEKLY</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERVAL_MONTHLY</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERVAL_YEARLY</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERVAL_BEST</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
</code></pre> 
<p>除了上述查询方法，UsageStatsManager还提供了一些其他的重要方法。</p> 
<table><thead><tr><th>方法</th><th>用途</th></tr></thead><tbody><tr><td>isAppInactive(String packageName)</td><td>判断应用是否处于活跃状态</td></tr><tr><td>setAppInactive(String packageName, boolean inactive)</td><td>设置应用活跃状态，系统API</td></tr><tr><td>registerAppUsageObserver(int observerId, @NonNull String[] packages, long timeLimit,@NonNull TimeUnit timeUnit, @NonNull PendingIntent callbackIntent)</td><td>注册应用使用观察者，系统API</td></tr><tr><td>unregisterAppUsageObserver(int observerId)</td><td>注销应用使用观察者，系统API</td></tr></tbody></table> 
<h2><a id="_88"></a>获取顶部应用示例</h2> 
<p>使用步骤如下：</p> 
<p>1、在AndroidManifest.xml中声明权限。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.PACKAGE_USAGE_STATS<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> 
<p>2、启动授权设置界面</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkUsageStateAccessPermission</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">AppUsageUtil</span><span class="token punctuation">.</span><span class="token function">checkAppUsagePermission</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">AppUsageUtil</span><span class="token punctuation">.</span><span class="token function">requestAppUsagePermission</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">checkAppUsagePermission</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">UsageStatsManager</span> usageStatsManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UsageStatsManager</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">USAGE_STATS_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>usageStatsManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// try to get app usage state in last 1 min</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UsageStats</span><span class="token punctuation">&gt;</span></span> stats <span class="token operator">=</span> usageStatsManager<span class="token punctuation">.</span><span class="token function">queryUsageStats</span><span class="token punctuation">(</span><span class="token class-name">UsageStatsManager</span><span class="token punctuation">.</span><span class="token constant">INTERVAL_DAILY</span><span class="token punctuation">,</span> currentTime <span class="token operator">-</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">requestAppUsagePermission</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span>Settings</span><span class="token punctuation">.</span><span class="token constant">ACTION_USAGE_ACCESS_SETTINGS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_ACTIVITY_NEW_TASK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            context<span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ActivityNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token string">"Start usage access settings activity fail!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>3、查询10秒钟前应用使用统计数据并根据最后使用时间进行排序，得到的最后使用的应用。</p> 
<pre><code class="prism language-dart">    public <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getTopActivityPackageName</span><span class="token punctuation">(</span><span class="token metadata function">@NonNull</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">UsageStatsManager</span> usageStatsManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UsageStatsManager</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span>USAGE_STATS_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>usageStatsManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> PACKAGE_NAME_UNKNOWN<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> topActivityPackageName <span class="token operator">=</span> PACKAGE_NAME_UNKNOWN<span class="token punctuation">;</span>
        long time <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 查询最后十秒钟使用应用统计数据</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UsageStats</span><span class="token punctuation">&gt;</span></span> usageStatsList <span class="token operator">=</span> usageStatsManager<span class="token punctuation">.</span><span class="token function">queryUsageStats</span><span class="token punctuation">(</span><span class="token class-name">UsageStatsManager</span><span class="token punctuation">.</span>INTERVAL_DAILY<span class="token punctuation">,</span> time <span class="token operator">-</span> <span class="token number">1000</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 以最后使用时间为标准进行排序</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>usageStatsList <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">SortedMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">UsageStats</span><span class="token punctuation">&gt;</span></span> sortedMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">UsageStats</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">UsageStats</span> usageStats <span class="token punctuation">:</span> usageStatsList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                sortedMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>usageStats<span class="token punctuation">.</span><span class="token function">getLastTimeUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>usageStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>sortedMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                topActivityPackageName <span class="token operator">=</span>  sortedMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>sortedMap<span class="token punctuation">.</span><span class="token function">lastKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal"><span class="token string">"Top activity package name = "</span></span> <span class="token operator">+</span> topActivityPackageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> topActivityPackageName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="dump_162"></a>dump命令</h3> 
<pre><code class="prism language-undefined">adb shell dumpsys usagestats
</code></pre> 
<p><strong><a href="https://gitee.com/peter_RD_nj/DemoAllInOne/tree/master/UsageStatsManagerDemo" rel="nofollow">Demo</a></strong></p> 
<h2><a id="_172"></a>获取最近一段时间打开应用的示例</h2> 
<p><strong>判断某第三方应用这个时间是否打开</strong></p> 
<p>使用UsageStatsManager可以获取应用程序的使用情况，包括应用程序的包名、启动时间、使用时间等。判断第三方应用是否打开，可以通过以下步骤实现：</p> 
<ol><li>获取UsageStatsManager实例：</li></ol> 
<pre><code>UsageStatsManager usageStatsManager = (UsageStatsManager) getSystemService(Context.USAGE_STATS_SERVICE);
</code></pre> 
<ol><li>获取当前时间和一段时间前的时间：</li></ol> 
<pre><code>Calendar calendar = Calendar.getInstance();
long endTime = calendar.getTimeInMillis();
calendar.add(Calendar.DAY_OF_MONTH, -1);
long startTime = calendar.getTimeInMillis();
</code></pre> 
<ol><li>获取应用程序的使用情况列表：</li></ol> 
<pre><code>List&lt;UsageStats&gt; usageStatsList = usageStatsManager.queryUsageStats(UsageStatsManager.INTERVAL_DAILY, startTime, endTime);
</code></pre> 
<ol><li>遍历使用情况列表，判断第三方应用是否打开：</li></ol> 
<pre><code>for (UsageStats usageStats : usageStatsList) {
    if ((usageStats.getPackageName().equals(packageName)) &amp;&amp; (usageStats.getLastTimeUsed() &gt; 0)) {
        // 第三方应用已经打开
    }
}
</code></pre> 
<p>其中，packageName为第三方应用的包名。如果该应用的最后使用时间（getLastTimeUsed()）大于0，则表示该应用已经打开。</p> 
<h2><a id="_213"></a>小结</h2> 
<p>本文基于Android9.0 SDK列举了应用使用数据统计服务UsageStatsManager所能提供的服务，并给出获取顶部应用的代码示例。其他获取前台应用的方法可以参看《<a href="https://www.jianshu.com/p/a513accd40cd" rel="nofollow">4种获取前台应用的方法（肯定有你不知道的）</a>》，里面关于UsageStatsManager使用的相关优化可以学习一下。</p> 
<h2><a id="_219"></a>参考</h2> 
<p><a href="https://www.jianshu.com/p/3b6bcf9cec67" rel="nofollow">（Android 9.0）应用使用数据统计服务——UsageStatsManager</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/767249ddc9300ab4604218b185701a67/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">R语言——R函数、选项参数、数学统计函数（六）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9d5f52fed53e81ae1276893d6c851c60/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">解决Gitlab Prometheus导致的磁盘空间不足问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>