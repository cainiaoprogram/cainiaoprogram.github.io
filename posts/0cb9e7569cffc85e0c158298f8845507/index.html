<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>香橙派5使用NPU加速yolov5的实时视频推理（一） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="香橙派5使用NPU加速yolov5的实时视频推理（一）" />
<meta property="og:description" content="前言： 寒假里，博主完成了树莓派4B搭载yolofastest-V2的ncnn加速，效果挺不错的，但总感觉还是稍微差点意思，于是就购买了一块香橙派5，想要用RK3588芯片自带的NPU来加速深度学习的部署，在2023年3月4日也是完成了香橙派5的NPU加速深度学习部分，其效果也确实非常可观，在画质较低的情况下，运行速度达到了100fps以上，下面是我在B站发布的效果视频点我跳转。这篇博客也是为了总结一下玩香橙派5的时候遇到的坑。
准备材料： 1、香橙派5
2、一台windows10或windows11的电脑
3、一个内部带有Ubuntu20.04的移动硬盘（如果没有，也可以用VMware安装个虚拟机也行）。
3、USB摄像头（某宝上有卖的，啥都可以）用来做视频识别
4、64G内存卡（烧录了官方的Debian11系统）、HDMI线、显示屏、官方的电源线、键鼠套装
5、香橙派5官方提供的无线网卡（其他网卡应该也行，只不过当时我买了，即使安装了驱动也没上成网）
6、散热壳（也是某宝买的，不是官方的）
说明： 关于RKNN，官方给出了两种思路，一种是关于C的，另一种是关于Python的，这里我只介绍Python有关部分。
在接下来的操作中，一和二是在windows系统上进行操作的，三是在Ubuntu20.04系统上进行的，四是在香橙派5上操作的，大家注意区分！！！
一、使用官方指定的yolov5版本去训练： 不瞒大家，对于yolov5来说，博主本人在寒假之前也没用过，这个寒假才学会了yolov5的训练和应用，在此之前，我甚至都不知道yolov5还分为多个版本，RKNN官方教程
进入教程后，首先点击框内链接跳转至yolov5的GitHub仓库
博主这里跳转过后是403，没关系，我们直接点击yoloV5官方库跳转至如下界面。
点击左上角箭头所指区域，搜索c5360f6e7009eb4d05f14d1cc9dae0963e949213，跳转至如下界面，按顺序点击箭头所指区域
进入如下界面后，点击Browse file
这样，我们就找到了正确的版本了
把代码保存到本地，接下来，我们点击Releases · ultralytics/yolov5 · GitHub，进入如下界面
滚动滑轮大概在界面的中部位置，点击箭头所指区域
进入如下界面
滑动滚轮到页面底部，下载我们的预训练模型yolov5s.pt
然后就是开始我们的yolov5的简单训练了，这里我参考的是这篇博客，这位博主写的很好，对小白很友好小白YOLOv5全流程-训练&#43;实现数字识别_yolov5数字识别_牛大了2022的博客-CSDN博客
当然了，我们因为选择了不同的版本，会出现一点小的问题，这里我也记录了下来。
1、这里一定要采用单引号，否则就会报出这个错误ValueError: too many dimensions ‘str‘
2、当出现OSError: [WinError 1455] 页面文件太小,无法完成操作，一般是要去给Anaconda所在的盘符分配一定的虚拟内存，同时把train.py里的&#39;--batch-size&#39;选项调小，我是轻薄本，于是就改成了4，虚拟内存分配了50G，此外，如果多次输出这个错误的话，就尽量不要用python终端去执行命令了，直接修改train.py里面的参数，然后运行train.py
3、当出现如下错误的时候，不要慌张，可以把所有的np.int修改成np.int_即可
4、如果以上错误都解决了的话，已经开始训练了，结果出现下面的错误
这样的话，就要进入loss.py函数，修改两个地方，第一个地方：
for i in range(self.nl):
anchors = self.anchors[i]
改为如下所示：
for i in range(self.nl): anchors, shape = self.anchors[i], p[i].shape 第二个地方：
indices.append((b, a, gj.clamp_(0, gain[3] - 1), gi.clamp_(0, gain[2] - 1))) # image, anchor, grid 改为：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0cb9e7569cffc85e0c158298f8845507/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-05T16:13:37+08:00" />
<meta property="article:modified_time" content="2023-03-05T16:13:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">香橙派5使用NPU加速yolov5的实时视频推理（一）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2></h2> 
<h2>前言：</h2> 
<p></p> 
<p>        寒假里，博主完成了树莓派4B搭载yolofastest-V2的ncnn加速，效果挺不错的，但总感觉还是稍微差点意思，于是就购买了一块香橙派5，想要用RK3588芯片自带的NPU来加速深度学习的部署，在2023年3月4日也是完成了香橙派5的NPU加速深度学习部分，其效果也确实非常可观，在画质较低的情况下，运行速度达到了100fps以上，下面是我在B站发布的效果视频<a class="link-info" href="https://www.bilibili.com/video/BV1uj41137gh/?vd_source=3b1c4eb4d3ec2d429c12982ccfb9d120" rel="nofollow" title="点我跳转">点我跳转</a>。这篇博客也是为了总结一下玩香橙派5的时候遇到的坑。</p> 
<h2>准备材料：</h2> 
<p>        1、香橙派5</p> 
<p><img alt="" height="800" src="https://images2.imgbox.com/8d/61/TyjvnPwG_o.jpg" width="800"></p> 
<p>        2、一台windows10或windows11的电脑</p> 
<p>        3、一个内部带有Ubuntu20.04的移动硬盘（如果没有，也可以用VMware安装个虚拟机也行）。</p> 
<p>        3、USB摄像头（某宝上有卖的，啥都可以）用来做视频识别</p> 
<p>        4、64G内存卡（烧录了官方的Debian11系统）、HDMI线、显示屏、官方的电源线、键鼠套装</p> 
<p>        5、香橙派5官方提供的无线网卡（其他网卡应该也行，只不过当时我买了，即使安装了驱动也没上成网）</p> 
<p>        6、散热壳（也是某宝买的，不是官方的）</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/c6/14/FT84Yngk_o.jpg" width="1200"></p> 
<h2> 说明：</h2> 
<p>        <strong><span style="color:#fe2c24;">关于RKNN，官方给出了两种思路，一种是关于C的，另一种是关于Python的，这里我只介绍Python有关部分。</span></strong></p> 
<p><strong><span style="color:#fe2c24;">        在接下来的操作中，一和二是在windows系统上进行操作的，三是在Ubuntu20.04系统上进行的，四是在香橙派5上操作的，大家注意区分！！！</span></strong></p> 
<h2>一、使用官方指定的yolov5版本去训练：</h2> 
<p>        不瞒大家，对于yolov5来说，博主本人在寒假之前也没用过，这个寒假才学会了yolov5的训练和应用，在此之前，我甚至都不知道yolov5还分为多个版本，<a class="link-info" href="https://github.com/rockchip-linux/rknn-toolkit/tree/master/examples/pytorch/yolov5" title="RKNN官方教程">RKNN官方教程</a></p> 
<p>进入教程后，首先点击框内链接跳转至yolov5的GitHub仓库</p> 
<p><img alt="" height="756" src="https://images2.imgbox.com/c3/21/zjLVOpA3_o.png" width="1200"></p> 
<p> 博主这里跳转过后是403，没关系，我们直接点击<a class="link-info" href="https://github.com/ultralytics/yolov5" title="yoloV5官方库">yoloV5官方库</a>跳转至如下界面。</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/28/0f/QbR4e78b_o.png" width="1200"></p> 
<p> 点击左上角箭头所指区域，搜索c5360f6e7009eb4d05f14d1cc9dae0963e949213，跳转至如下界面，按顺序点击箭头所指区域</p> 
<p><img alt="" height="748" src="https://images2.imgbox.com/fe/d4/L1RK1tNo_o.png" width="1200"></p> 
<p> 进入如下界面后，点击Browse file<img alt="" height="1095" src="https://images2.imgbox.com/0e/8c/X76RQAw2_o.png" width="1200"></p> 
<p> 这样，我们就找到了正确的版本了</p> 
<p><img alt="" height="1089" src="https://images2.imgbox.com/16/4b/lVwwit9q_o.png" width="1200"></p> 
<p> 把代码保存到本地，接下来，我们点击<a href="https://github.com/ultralytics/yolov5/releases" title="Releases · ultralytics/yolov5 · GitHub">Releases · ultralytics/yolov5 · GitHub</a>，进入如下界面</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/d0/4d/f4bYgJ6O_o.png" width="1200"></p> 
<p> 滚动滑轮大概在界面的中部位置，点击箭头所指区域</p> 
<p><img alt="" height="956" src="https://images2.imgbox.com/76/a7/WJWswv0a_o.png" width="1200"></p> 
<p> 进入如下界面</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/ed/5a/6oR7Ao5Z_o.png" width="1200">滑动滚轮到页面底部，下载我们的预训练模型<strong>yolov5s.pt</strong></p> 
<p><img alt="" height="1028" src="https://images2.imgbox.com/de/9c/1wt4YyIG_o.png" width="1200"></p> 
<p> 然后就是开始我们的yolov5的简单训练了，这里我参考的是这篇博客，这位博主写的很好，对小白很友好<a href="https://blog.csdn.net/m0_62237233/article/details/127328106" title="小白YOLOv5全流程-训练+实现数字识别_yolov5数字识别_牛大了2022的博客-CSDN博客">小白YOLOv5全流程-训练+实现数字识别_yolov5数字识别_牛大了2022的博客-CSDN博客</a></p> 
<p>        当然了，我们因为选择了不同的版本，会出现一点小的问题，这里我也记录了下来。</p> 
<p>        1、这里一定要采用单引号，否则就会报出这个错误<span style="color:#fe2c24;"><strong>ValueError: too many dimensions ‘str‘</strong></span></p> 
<p><img alt="" height="849" src="https://images2.imgbox.com/13/7d/Nfn0vdC7_o.png" width="1200"></p> 
<p>        2、当出现OSError: [WinError 1455] 页面文件太小,无法完成操作，一般是要去给Anaconda所在的盘符分配一定的虚拟内存，同时把train.py里的'--batch-size'选项调小，我是轻薄本，于是就改成了4，虚拟内存分配了50G，此外，如果多次输出这个错误的话，就尽量不要用python终端去执行命令了，直接修改train.py里面的参数，然后运行train.py</p> 
<p>        3、当出现如下错误的时候，不要慌张，可以把所有的np.int修改成np.int_即可</p> 
<p><img alt="" height="487" src="https://images2.imgbox.com/4b/2a/TkGMUSO3_o.png" width="1200"></p> 
<p> 4、如果以上错误都解决了的话，已经开始训练了，结果出现下面的错误</p> 
<p><img alt="" height="473" src="https://images2.imgbox.com/36/01/R9HUTRPS_o.png" width="1200"></p> 
<p> 这样的话，就要进入loss.py函数，修改两个地方，第一个地方：</p> 
<blockquote> 
 <p>for i in range(self.nl):<br>         anchors = self.anchors[i]</p> 
</blockquote> 
<p> 改为如下所示：</p> 
<pre><code class="language-python"> for i in range(self.nl):
        anchors, shape = self.anchors[i], p[i].shape
</code></pre> 
<p>第二个地方：</p> 
<pre><code class="language-python">indices.append((b, a, gj.clamp_(0, gain[3] - 1), gi.clamp_(0, gain[2] - 1)))  # image, anchor, grid 
</code></pre> 
<p>改为：</p> 
<pre><code class="language-python">indices.append((b, a, gj.clamp_(0, shape[2] - 1), gi.clamp_(0, shape[3] - 1)))  # image, anchor, grid
</code></pre> 
<p> 以上的错误解决完了就可以训练了。博主我啊，为了写这篇博客，还把这整个操作给又弄了一遍，各位看在这么辛苦的份上，给我点个赞吧。</p> 
<h2>二、将训练好的best.pt转为best.onnx</h2> 
<p>        这里，我们再次进入<a class="link-info" href="https://github.com/rockchip-linux/rknn-toolkit/tree/master/examples/pytorch/yolov5" title="RKNN官方教程">RKNN官方教程</a>这里，按照官方提供的步骤来操作。</p> 
<p><img alt="" height="1126" src="https://images2.imgbox.com/54/90/fD9lTm9E_o.png" width="1200"></p> 
<p>         这一步一定要等训练完成后，再对export.py进行修改，然后我们要把得出的best.pt复制到export.py同一级文件夹下。</p> 
<pre><code class="language-python">python export.py --weights best.pt --img 640 --batch 1 --include onnx</code></pre> 
<p>         我确实报了一大堆警告，最开始我没有去管，后来到了转rknn的时候，出了个大问题</p> 
<p><img alt="" height="363" src="https://images2.imgbox.com/76/f7/LWSFn5G1_o.png" width="1200"></p> 
<blockquote> 
 <p>这是报的错误</p> 
 <p><span style="color:#fe2c24;">WARNING: The shape inference of prim::Constant type is missing, so it may result in wrong shape inference for the exported graph. Please consider adding it in symbolic function.</span></p> 
</blockquote> 
<p>         我们要到export.py文件里面，把'--opset'选项该成11，再次运行代码，弹出下面的界面，没有了上面说的警告，但还是会有一些警告，博主上网查了一些，说是深度神经网络的网络结构太灵活，网络结构中出现不少if else 语句，需要去掉，这个我没在意，后续也没出啥问题。</p> 
<p><img alt="" height="389" src="https://images2.imgbox.com/67/2e/Qs6BcVNZ_o.png" width="1200"></p> 
<p>         之后，在export.py的同级目录下，就会生成best.onnx这个文件，我们需要做的就是把这个文件copy到我们的Ubuntu20.04系统里面，进行处理。</p> 
<h2>写不开了，大家可以跟着看第二篇</h2> 
<h2></h2>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e9ac66d3c29e448cb165fc5c36b79346/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">2023《操作系统原理》实习一（实习中进行过的操作以及遇到的问题）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/741d406b5592ebe03749f6645cf45261/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">给定正整数n,打印输出边长为n的平行四边形</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>