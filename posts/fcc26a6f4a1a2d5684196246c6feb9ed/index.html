<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>go使用protobuf - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="go使用protobuf" />
<meta property="og:description" content="protocol buffers 简介 数据传输方式有：json和xml两种格式，其中json更多一些。现在又多了一种数据传输方式，就是google开发的Protocol Buffers
Protocol Buffers一个字“快”。一条消息数据，用protobuf序列化后的大小是json的10分之一，是xml格式的20分之一，但是性能却是它们的5~100倍
下载protocol buffers编译器 https://github.com/protocolbuffers/protobuf 点击右侧releases在下面找assets下面对应操作系统的压缩包
解压放到磁盘
C:\Program Files\protoc-3.20.0-win64 把对应位置bin配置到系统环境变量
可在任意位置输入protoc
编写第一个protobuf文件，编译成go文件 为vscode安装vscode-proto3插件 vscode-proto3 创建一个protobuf文件 创建1.proto文件
syntax = &#34;proto3&#34;; option go_package=&#34;./;hello&#34;; package hello; message Person{ string name = 1; int32 age = 2; string email = 3; } option go_package = “path;name”;
path 表示生成的go文件的存放地址，会自动生成目录的。 name 表示生成的go文件所属的包名
安装go protocol buffers 插件 go install google.golang.org/protobuf/cmd/protoc-gen-go@latest 编译生成go文件 所有proto文件放在proto文件夹，所有go文件放在go文件夹
protoc --go_out=./go ./proto/* protocol buffers 定义消息类型 syntax = &#34;proto3&#34;; message SearchRequest{ string query = 1; int32 page_number = 2; int32 result_per_page = 3; } 文件第一行指定使用的是proto3语法，这必须是文件的第一个非空、非注释行" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/fcc26a6f4a1a2d5684196246c6feb9ed/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-11T15:26:53+08:00" />
<meta property="article:modified_time" content="2022-04-11T15:26:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">go使用protobuf</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="protocol_buffers_0"></a>protocol buffers</h2> 
<h3><a id="_2"></a>简介</h3> 
<p>数据传输方式有：json和xml两种格式，其中json更多一些。现在又多了一种数据传输方式，就是google开发的Protocol Buffers</p> 
<p>Protocol Buffers一个字“快”。一条消息数据，用protobuf序列化后的大小是json的10分之一，是xml格式的20分之一，但是性能却是它们的5~100倍</p> 
<h3><a id="protocol_buffers_8"></a>下载protocol buffers编译器</h3> 
<pre><code>https://github.com/protocolbuffers/protobuf
</code></pre> 
<p>点击右侧releases在下面找assets下面对应操作系统的压缩包</p> 
<p>解压放到磁盘</p> 
<pre><code>C:\Program Files\protoc-3.20.0-win64
</code></pre> 
<p>把对应位置bin配置到系统环境变量</p> 
<p>可在任意位置输入protoc</p> 
<h3><a id="protobufgo_26"></a>编写第一个protobuf文件，编译成go文件</h3> 
<h4><a id="vscodevscodeproto3_28"></a>为vscode安装vscode-proto3插件</h4> 
<pre><code>vscode-proto3
</code></pre> 
<h4><a id="protobuf_34"></a>创建一个protobuf文件</h4> 
<p>创建1.proto文件</p> 
<pre><code>syntax = "proto3";
option go_package="./;hello";


package hello;

message Person{
    string name = 1;
    int32 age = 2;
    string email = 3;
}
</code></pre> 
<p>option go_package = “path;name”;</p> 
<p>path 表示生成的go文件的存放地址，会自动生成目录的。 name 表示生成的go文件所属的包名</p> 
<h4><a id="go_protocol_buffers__56"></a>安装go protocol buffers 插件</h4> 
<pre><code>go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
</code></pre> 
<h4><a id="go_62"></a>编译生成go文件</h4> 
<p>所有proto文件放在proto文件夹，所有go文件放在go文件夹</p> 
<pre><code>protoc --go_out=./go ./proto/*
</code></pre> 
<h3><a id="protocol_buffers_70"></a>protocol buffers</h3> 
<h4><a id="_72"></a>定义消息类型</h4> 
<pre><code>syntax = "proto3";

message SearchRequest{
    string query = 1;
    int32 page_number = 2;
    int32 result_per_page = 3;
}
</code></pre> 
<p>文件第一行指定使用的是proto3语法，这必须是文件的第一个非空、非注释行</p> 
<p>SearchRequest消息定义了三个字段</p> 
<h4><a id="_88"></a>保留字段</h4> 
<pre><code>message Foo {
  reserved 2, 15, 9 to 11;
  reserved "foo", "bar";
}
</code></pre> 
<h3><a id="_97"></a>枚举类型</h3> 
<pre><code>syntax = "proto3";

message SearchRequest{
    string query = 1;
    int32 page_number = 2;
    int32 result_per_page = 3;
    enum Corpus {
        PHP = 0;
        GO = 1;
        JAVA = 2;
        PYTHON = 3;
    }
    Corpus corpus = 4;
}
</code></pre> 
<p>Corpus枚举的第一个常量映射到0，每个枚举定义都必须包含一个映射到0的常量作为其第一个元素</p> 
<h3><a id="protobuf_118"></a>protobuf序列化和反序列化</h3> 
<h4><a id="userproto_120"></a>创建user的proto</h4> 
<pre><code>syntax = "proto3";

option go_package="./;user";

package user;

message Article{
    int32 aid = 1;
    string title = 2;
    int32 views = 3;
}
</code></pre> 
<h4><a id="userpbgo_136"></a>生成user.pb.go文件</h4> 
<pre><code>protoc --go_out=./user ./user/* 
</code></pre> 
<h4><a id="_142"></a>编写测试代码</h4> 
<pre><code>func main() {

	article := &amp;user.Article{
		Aid:   1,
		Title: "protobuf for go",
		Views: 10,
	}
	// 序列化成二进制
	b, _ := proto.Marshal(article)
	fmt.Printf("b: %v\n", b)

	otherArticle := &amp;user.Article{}
	proto.Unmarshal(b, otherArticle)
	fmt.Printf("otherArticle.GetAid(): %v\n", otherArticle.GetAid())
	fmt.Printf("otherArticle.GetTitle(): %v\n", otherArticle.GetTitle())
	fmt.Printf("otherArticle.GetViews(): %v\n", otherArticle.GetViews())

}
</code></pre> 
<h4><a id="_165"></a>运行结果</h4> 
<pre><code>PS D:\go\test\grpctest&gt; go run .\test.go
b: [8 1 18 15 112 114 111 116 111 98 117 102 32 102 111 114 32 103 111 24 10]
otherArticle.GetAid(): 1
otherArticle.GetTitle(): protobuf for go
otherArticle.GetViews(): 10
PS D:\go\test\grpctest&gt; 
</code></pre> 
<h3><a id="protobufjson_176"></a>protobuf和json相互转换</h3> 
<h4><a id="protojson_178"></a>下载安装protojson</h4> 
<pre><code>go get google.golang.org/protobuf/encoding/protojson
</code></pre> 
<h4><a id="go_184"></a>编写测试go代码</h4> 
<pre><code>func test1() {
	article := &amp;user.Article{
		Aid:   1,
		Title: "protobuf for go",
		Views: 10,
	}
	jsonString := protojson.Format(article.ProtoReflect().Interface())
	fmt.Printf("jsonString: %v\n", jsonString)

	m := article.ProtoReflect().Interface()
	protojson.Unmarshal([]byte(jsonString), m)
	fmt.Printf("m: %v\n", m)
}
</code></pre> 
<h4><a id="_202"></a>运行结果</h4> 
<pre><code>PS D:\go\test\grpctest&gt; go run .\test.go
jsonString: {
  "aid": 1,
  "title": "protobuf for go",
  "views": 10
}
m: aid:1 title:"protobuf for go" views:10
PS D:\go\test\grpctest&gt; 
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f7edcd68c7a3a1ec1c8d3140240cb4f2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JavaScript 和 Typescript 的区别</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/399a696849deff08a1e8064ffb14ae40/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">LVM方式挂载硬盘</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>