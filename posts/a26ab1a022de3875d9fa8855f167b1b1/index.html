<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Pytorch基础入门 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Pytorch基础入门" />
<meta property="og:description" content="Pytorch介绍 Torch是一个开源的机器学习的框架，早在2002年就发布了Torch的初版， Torch的编程语言为C和Lua。如今的Torch7依旧是热门的深度学习框架之一。
PyTorch是在2017年1月由Facebook推出的。它是经典机器学习库Torch框架的一个端口，主要编程语言为python.
Torch： 2002年发布，早期的机器学习框架。
Theano： 2008年开发，第一个影响力较大的python深度学习框架。
CNTK：2016年1月由微软公司开源，在语音领域效果比较突出。
TensorFlow：2015年11月Google开源，目前最热门深度学习框架之一。
Keras： 以Theano/Tensorflow/CNTK作为底层，最容易使用的深度学习框架。
Caffe/Caffe2:2013年开源的C&#43;&#43;深度学习框架，曾经计算机视觉领域的王者。
MXNet： 2015年发布，AWS云计算的官方深度学习平台。
Paddle： 2016年8月开源的百度深度学习框架。
PyTorch： 2017年开源，Torch的python版本，目前最有潜力，最热门的深度学 习框架之一。
Pytorch安装 https://pytorch.org/打开Pytorch官网进行下载，
根据自己电脑选择相应的选项，最后把下方的指令输入CMD中执行即可。
MNIST数据集介绍 数据集被分成两部分： 60000行的训练数据集（ mnist.train）和10000行的测试数据集（ mnist.test）
一张图片包含28* 28个像素，我们把这一个数组展开成一个向量，长度是28* 28=784。如果把数据用矩阵表示，可以把MNIST训练数据变成一个形状为 [60000, 784] 的矩阵，第一个维度数字用来索引图片，第二个维度数字用来索引每张图片中的像素点。图片里的某个像素的强度值介于0-1之间。
One-hot编码 MNIST数据集的标签是介于0-9的数字，我们要把标签转化为“one-hotvectors” 。一个one-hot向量除了某一位数字是1以外，其余维度数字都是0，比如标签0将表示为([1,0,0,0,0,0,0,0,0,0])，标签3将表示为
([0,0,0,1,0,0,0,0,0,0])
Softmax函数介绍 在多分类问题中，我们通常会使用softmax函数作为网络输出层的激活函数，softmax函数可以对输出值进行归一化操作，把所有输出值都转化为概率，所有概率值加起来等于1， softmax的公式为：
损失函数 均方误差（二次代价函数） 激活函数的梯度f’(z)越大， w的大小调整得越快，训练收敛得就越快。激活函数的梯度f’(z)越小， w的大小调整得越慢，训练收敛得就越慢。
按理来说，如果损失函数越大，应该进行的求导越快，而二次代价函数做不到，引出交叉熵函数。
交叉熵 过拟合 防止过拟合 增大数据集 增大数据集方法：
Early stopping 在训练模型的时候，我们往往会设置一个比较大的迭代次数。 Earlystopping便是一种提前结束训练的策略用来防止过拟合。
一般的做法是记录到目前为止最好的validation accuracy，当连续10个Epoch没有达到最佳accuracy时，则可以认为accuracy不再提高了。此时便可以停止迭代了（ Early Stopping）。
Dropout 在训练数据集的时候，随机的屏蔽掉一些神经元，以提高数据的鲁棒性
正则化项 优化器 Adadelta
Adagrad
Adam 一般使用Adam
Adamax" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a26ab1a022de3875d9fa8855f167b1b1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-08T09:47:47+08:00" />
<meta property="article:modified_time" content="2022-10-08T09:47:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Pytorch基础入门</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Pytorch_0"></a>Pytorch介绍</h2> 
<p>Torch是一个开源的机器学习的框架，早在2002年就发布了Torch的初版， Torch的编程语言为C和Lua。如今的Torch7依旧是热门的深度学习框架之一。<br> PyTorch是在2017年1月由Facebook推出的。它是经典机器学习库Torch框架的一个端口，主要编程语言为python.</p> 
<blockquote> 
 <p>Torch： 2002年发布，早期的机器学习框架。<br> Theano： 2008年开发，第一个影响力较大的python深度学习框架。<br> CNTK：2016年1月由微软公司开源，在语音领域效果比较突出。<br> TensorFlow：2015年11月Google开源，目前最热门深度学习框架之一。<br> Keras： 以Theano/Tensorflow/CNTK作为底层，最容易使用的深度学习框架。<br> Caffe/Caffe2:2013年开源的C++深度学习框架，曾经计算机视觉领域的王者。<br> MXNet： 2015年发布，AWS云计算的官方深度学习平台。<br> Paddle： 2016年8月开源的百度深度学习框架。<br> PyTorch： 2017年开源，Torch的python版本，目前最有潜力，最热门的深度学 习框架之一。</p> 
</blockquote> 
<h2><a id="Pytorch_13"></a>Pytorch安装</h2> 
<p><a href="https://pytorch.org/" rel="nofollow">https://pytorch.org/</a>打开Pytorch官网进行下载，<br> <img src="https://images2.imgbox.com/e4/17/5turClyY_o.png" alt="在这里插入图片描述"><br> 根据自己电脑选择相应的选项，最后把下方的指令输入CMD中执行即可。</p> 
<h2><a id="MNIST_17"></a>MNIST数据集介绍</h2> 
<p>数据集被分成两部分： 60000行的训练数据集（ mnist.train）和10000行的测试数据集（ mnist.test）<br> <img src="https://images2.imgbox.com/cf/58/hdf7quaX_o.png" alt="在这里插入图片描述"><br> 一张图片包含28* 28个像素，我们把这一个数组展开成一个向量，长度是28* 28=784。如果把数据用矩阵表示，可以把MNIST训练数据变成一个形状为 [60000, 784] 的矩阵，第一个维度数字用来索引图片，第二个维度数字用来索引每张图片中的像素点。图片里的某个像素的强度值介于0-1之间。<br> <img src="https://images2.imgbox.com/ea/d5/c6yiGH2F_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Onehot_22"></a>One-hot编码</h3> 
<p>MNIST数据集的标签是介于0-9的数字，我们要把标签转化为“one-hotvectors” 。一个one-hot向量除了某一位数字是1以外，其余维度数字都是0，比如标签0将表示为([1,0,0,0,0,0,0,0,0,0])，标签3将表示为<br> ([0,0,0,1,0,0,0,0,0,0])<br> <img src="https://images2.imgbox.com/83/01/eN8keKbN_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Softmax_26"></a>Softmax函数介绍</h2> 
<p>在多分类问题中，我们通常会使用softmax函数作为<strong>网络输出层</strong>的激活函数，softmax函数可以对输出值进行<strong>归一化</strong>操作，把所有输出值都转化为概率，<strong>所有概率值加起来等于1</strong>， softmax的公式为：<br> <img src="https://images2.imgbox.com/b4/c1/m0qBDQNj_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_29"></a>损失函数</h2> 
<h3><a id="_30"></a>均方误差（二次代价函数）</h3> 
<p><img src="https://images2.imgbox.com/20/d2/iGeT0aDH_o.png" alt="在这里插入图片描述"><br> 激活函数的梯度f’(z)越大， w的大小调整得越快，训练收敛得就越快。激活函数的梯度f’(z)越小， w的大小调整得越慢，训练收敛得就越慢。<br> 按理来说，如果损失函数越大，应该进行的求导越快，而二次代价函数做不到，引出交叉熵函数。</p> 
<h3><a id="_34"></a>交叉熵</h3> 
<p><img src="https://images2.imgbox.com/8f/fe/Bi6FwYTK_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_36"></a>过拟合</h2> 
<p><img src="https://images2.imgbox.com/ff/64/22D7ugOJ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_38"></a>防止过拟合</h3> 
<h4><a id="_39"></a>增大数据集</h4> 
<p>增大数据集方法：<br> <img src="https://images2.imgbox.com/53/4d/X1qvCpSK_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Early_stopping_42"></a>Early stopping</h4> 
<p>在训练模型的时候，我们往往会设置一个比较大的迭代次数。 Earlystopping便是一种提前结束训练的策略用来防止过拟合。<br> 一般的做法是记录到目前为止最好的validation accuracy，当连续10个Epoch没有达到最佳accuracy时，则可以认为accuracy不再提高了。此时便可以停止迭代了（ Early Stopping）。</p> 
<h4><a id="Dropout_45"></a>Dropout</h4> 
<p>在训练数据集的时候，随机的屏蔽掉一些神经元，以提高数据的鲁棒性</p> 
<h4><a id="_47"></a>正则化项</h4> 
<h2><a id="_48"></a>优化器</h2> 
<blockquote> 
 <p>Adadelta<br> Adagrad<br> Adam 一般使用Adam<br> Adamax<br> AdamW<br> ASGD<br> LBFGS<br> RMSprop<br> Rprop<br> SGD<br> SparseAdam</p> 
</blockquote> 
<h2><a id="CNN_60"></a>卷积神经网络CNN</h2> 
<p>卷积神经网络是近年发展起来，并广泛应用于图像处理， NLP等领域的一种多层神经网络。</p> 
<h3><a id="_62"></a>局部感受野</h3> 
<h3><a id="_63"></a>权值共享</h3> 
<h3><a id="_64"></a>卷积计算</h3> 
<p><img src="https://images2.imgbox.com/fc/92/BcOqUODx_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_67"></a>池化</h3> 
<p><img src="https://images2.imgbox.com/76/34/mo7gEJqN_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Padding_69"></a>Padding</h3> 
<p><strong>SAME PADDING:</strong><br> 给平面外部补0<br> 卷积窗口采样后得到一个跟原来大小相同的平面<br> <strong>VALID PADDING:</strong><br> 不会超出平面外部<br> 卷积窗口采样后得到一个比原来平面小的平面<br> <img src="https://images2.imgbox.com/af/37/HHYes07i_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_77"></a>猫狗分类案例</h2> 
<p>训练模型</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> datasets<span class="token punctuation">,</span> transforms<span class="token punctuation">,</span> models
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">import</span> VGG16_Weights

<span class="token comment"># 数据预处理</span>
transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    transforms<span class="token punctuation">.</span>RandomResizedCrop<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 对图形进行切割后，在形成固定大小</span>
    transforms<span class="token punctuation">.</span>RandomRotation<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 随机角度进行旋转</span>
    transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 随机水平移动</span>
    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 转成pytorch使用的tensor数据集形式</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 读取数据</span>
root <span class="token operator">=</span> <span class="token string">'image'</span>
train_dataset <span class="token operator">=</span> datasets<span class="token punctuation">.</span>ImageFolder<span class="token punctuation">(</span>root <span class="token operator">+</span> <span class="token string">'/train'</span><span class="token punctuation">,</span> transform<span class="token punctuation">)</span>
test_dataset <span class="token operator">=</span> datasets<span class="token punctuation">.</span>ImageFolder<span class="token punctuation">(</span>root <span class="token operator">+</span> <span class="token string">'/test'</span><span class="token punctuation">,</span> transform<span class="token punctuation">)</span>

<span class="token comment"># 导入数据</span>
train_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
test_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>test_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment">#</span>
classes <span class="token operator">=</span> train_dataset<span class="token punctuation">.</span>classes
classes_index <span class="token operator">=</span> train_dataset<span class="token punctuation">.</span>class_to_idx

batch_size <span class="token operator">=</span> <span class="token number">64</span>
LR <span class="token operator">=</span> <span class="token number">0.0001</span>
model <span class="token operator">=</span> models<span class="token punctuation">.</span>vgg16<span class="token punctuation">(</span>weights<span class="token operator">=</span>VGG16_Weights<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span>
<span class="token comment"># model = model.cuda()</span>

<span class="token comment"># 只训练全连接层</span>
<span class="token keyword">for</span> param <span class="token keyword">in</span> model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    param<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token comment"># 构建新的全连接层</span>
model<span class="token punctuation">.</span>classifier <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">25088</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                       torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                       torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                       torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 定义损失函数</span>
mse_loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 定义优化器</span>
optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> LR<span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 获得一个批次的数据和标签</span>
        inputs<span class="token punctuation">,</span> labels <span class="token operator">=</span> data

        <span class="token comment"># inputs = Variable(inputs.cuda())</span>
        <span class="token comment"># labels = Variable(labels.cuda())</span>

        <span class="token comment"># 获得模型预测结果（64,10）</span>
        out <span class="token operator">=</span> model<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
        <span class="token comment"># to onehot,把数据标签变成独热编码</span>
        <span class="token comment"># (64)-(64,1)</span>

        loss <span class="token operator">=</span> mse_loss<span class="token punctuation">(</span>out<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
        <span class="token comment"># 梯度清0</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 计算梯度</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 修改权值</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    correct <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>test_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 获得一个批次的数据和标签</span>
        inputs<span class="token punctuation">,</span> labels <span class="token operator">=</span> data
        <span class="token comment"># inputs = Variable(inputs.cuda())</span>
        <span class="token comment"># labels = Variable(labels.cuda())</span>

        <span class="token comment"># 获得模型预测结果（64,10）</span>
        out <span class="token operator">=</span> model<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
        <span class="token comment"># 获得最大值，以及最大值所在的位置</span>
        _<span class="token punctuation">,</span> predicted <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 预测正确的数量</span>
        correct <span class="token operator">+=</span> <span class="token punctuation">(</span>predicted <span class="token operator">==</span> labels<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Test acc:{0}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>correct<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>test_dataset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    correct <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 获得一个批次的数据和标签</span>
        inputs<span class="token punctuation">,</span> labels <span class="token operator">=</span> data
        <span class="token comment"># inputs = Variable(inputs.cuda())</span>
        <span class="token comment"># labels = Variable(labels.cuda())</span>
        <span class="token comment"># 获得模型预测结果（64,10）</span>
        out <span class="token operator">=</span> model<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
        <span class="token comment"># 获得最大值，以及最大值所在的位置</span>
        _<span class="token punctuation">,</span> predicted <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 预测正确的数量</span>
        correct <span class="token operator">+=</span> <span class="token punctuation">(</span>predicted <span class="token operator">==</span> labels<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Train acc:{0}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>correct<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_dataset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'epoch:'</span><span class="token punctuation">,</span> epoch<span class="token punctuation">)</span>
    train<span class="token punctuation">(</span><span class="token punctuation">)</span>
    test<span class="token punctuation">(</span><span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'cat_dog_cnn.pth'</span><span class="token punctuation">)</span>

</code></pre> 
<p>测试模型</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> datasets<span class="token punctuation">,</span> transforms<span class="token punctuation">,</span> models
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">import</span> VGG16_Weights

model <span class="token operator">=</span> models<span class="token punctuation">.</span>vgg16<span class="token punctuation">(</span>weights<span class="token operator">=</span>VGG16_Weights<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span>
<span class="token comment"># 构建新的全连接层</span>
model<span class="token punctuation">.</span>classifier <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">25088</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                       torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                       torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                       torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'cat_dog_cnn.pth'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

label <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 数据预处理</span>
transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 打开图片</span>
    img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span>
    <span class="token comment"># 数据处理，再增加一个维度</span>
    img <span class="token operator">=</span> transform<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># img = img.convert("RGB")</span>
    <span class="token comment"># 预测得到结果</span>
    outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token comment"># 获得最大值所在位置</span>
    _<span class="token punctuation">,</span> predicted <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># 转化为类别名称</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>label<span class="token punctuation">[</span>predicted<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


predict<span class="token punctuation">(</span><span class="token string">'image/test/cat/cat.1120.jpg'</span><span class="token punctuation">)</span>

</code></pre> 
<p><a href="https://www.bilibili.com/video/BV1iv41117Zg?p=1&amp;vd_source=b6d617a44efd38af053ed9f4b910e52a" rel="nofollow">转载自bilibili覃秉丰</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3a89ff17422d5db189e1c8fef2ff0f95/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">知识蒸馏小总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/22a20be766b95db9c1e8bfc12e14fded/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数据挖掘零基础入门</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>