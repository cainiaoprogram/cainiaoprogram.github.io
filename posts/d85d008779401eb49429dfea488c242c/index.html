<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL数据库笔记——进阶篇 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL数据库笔记——进阶篇" />
<meta property="og:description" content="文章目录 存储引擎MySQL体系结构存储引擎简介InnoDB介绍MyISAMMemory 存储引擎的选择小结 索引概述索引结构概述BtreeB&#43;TreeHash“严肃的思考题” 索引分类“严肃的思考题” 索引语法SQL性能分析查看执行频次慢查询日志show profilesexplian 索引使用规则验证索引效率最左前缀法则范围查询索引失效情况一索引失效情况二SQL提示覆盖索引前缀索引单列索引与联合索引的选择索引的设计原则总结 SQL优化插入数据主键优化order by优化group by优化limit优化count优化update优化小总结 视图介绍及基本语法检查选项更新和作用案例 存储过程介绍基本语法变量系统变量用户变量局部变量 if判断参数case炫酷的循环whilerepeatloop 游标条件处理程序 存储函数触发器介绍语法 about 视图、存储过程、触发器的小结锁介绍全局锁介绍特点 表级锁表锁元数据锁意向锁 行级锁介绍行锁间隙锁/临建锁 小结 InnoDB引擎逻辑存储结构架构内存架构磁盘架构后台线程 事务原理概述redo logundo log MVCC基本概念 实现原理undolog版本链 readview小总结 MySQL管理系统数据库常用工具mysqlmysqladminmysqlbinlogmysqlshowmysqldumpmysqlimport/source小总结 存储引擎 MySQL体系结构 连接层：
最上层是一些客户端和链接服务，主要完成一些类似于连接处理、授权认证、及相关的安全方案。服务器也会为安全接入的每个客户端验证它所具有的操作权限。
服务层：
第二层结构主要是完成大多数的核心服务功能，如SQL接口，并完成缓存的查询，SQL的分析和优化，部分内置函数的执行。所有跨存储引擎的功能也在这一层实现，如过程、函数等。
引擎层
存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API和存储引擎进行通信。不同的存储引擎具有不同的功能，这样我们可以根据自己的需要，来选取合适的存储引擎。
存储层：
主要是讲数据存储在文件系统之上，并完成与存储引擎的交互。
注意：索引是在存储引擎层实现的，也就意味着不同的存储引擎，索引的结构是不一样的
存储引擎控制的是数据库的数据该如何来存，如何来取，如何来组织，而具体的数据库数据最终是存储在磁盘当中的
存储引擎简介 what is 存储引擎？
do not know？
what is 引擎？
引擎就是发动机，发动机是一个机器的核心部分
而不同的引擎实际上是有不同的应用场景的（就像火箭的引擎不能放在汽车上）
引擎没有好坏，只要在合适的场景使用合适的引擎就可以了
存储引擎就是存储数据、建立索引、更新/查询数据等技术的实现方式。存储引擎是基于表的，而不是基于库的，所有存储引擎也可被称为表类型
没有指定的存储引擎，那就是默认的InnoDB
1、在创建表时，指定存储引擎
CREATE TABLE 表名( ... )ENGINE = INNODB [ COMMIT 表注释]; 2、查看当前数据库支持的存储引擎
SHOW ENGINES; memory：存储在内存当中的，通常用来做临时表及缓存" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d85d008779401eb49429dfea488c242c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-28T09:22:44+08:00" />
<meta property="article:modified_time" content="2023-07-28T09:22:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL数据库笔记——进阶篇</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">存储引擎</a></li><li><ul><li><a href="#MySQL_2" rel="nofollow">MySQL体系结构</a></li><li><a href="#_16" rel="nofollow">存储引擎简介</a></li><li><ul><li><a href="#InnoDB_56" rel="nofollow">InnoDB介绍</a></li><li><a href="#MyISAM_69" rel="nofollow">MyISAM</a></li><li><a href="#Memory_82" rel="nofollow">Memory</a></li></ul> 
   </li><li><a href="#_93" rel="nofollow">存储引擎的选择</a></li><li><a href="#_102" rel="nofollow">小结</a></li></ul> 
  </li><li><a href="#_116" rel="nofollow">索引</a></li><li><ul><li><a href="#_117" rel="nofollow">概述</a></li><li><a href="#_126" rel="nofollow">索引结构</a></li><li><ul><li><a href="#_127" rel="nofollow">概述</a></li><li><a href="#Btree_141" rel="nofollow">Btree</a></li><li><a href="#BTree_153" rel="nofollow">B+Tree</a></li><li><a href="#Hash_163" rel="nofollow">Hash</a></li><li><a href="#_176" rel="nofollow">“严肃的思考题”</a></li></ul> 
   </li><li><a href="#_183" rel="nofollow">索引分类</a></li><li><ul><li><a href="#_206" rel="nofollow">“严肃的思考题”</a></li></ul> 
   </li><li><a href="#_220" rel="nofollow">索引语法</a></li><li><a href="#SQL_262" rel="nofollow">SQL性能分析</a></li><li><ul><li><a href="#_263" rel="nofollow">查看执行频次</a></li><li><a href="#_275" rel="nofollow">慢查询日志</a></li><li><a href="#show_profiles_289" rel="nofollow">show profiles</a></li><li><a href="#explian_311" rel="nofollow">explian</a></li></ul> 
   </li><li><a href="#_345" rel="nofollow">索引使用规则</a></li><li><ul><li><a href="#_347" rel="nofollow">验证索引效率</a></li><li><a href="#_361" rel="nofollow">最左前缀法则</a></li><li><a href="#_365" rel="nofollow">范围查询</a></li><li><a href="#_369" rel="nofollow">索引失效情况一</a></li><li><a href="#_384" rel="nofollow">索引失效情况二</a></li><li><a href="#SQL_393" rel="nofollow">SQL提示</a></li><li><a href="#_408" rel="nofollow">覆盖索引</a></li><li><a href="#_421" rel="nofollow">前缀索引</a></li><li><a href="#_436" rel="nofollow">单列索引与联合索引的选择</a></li><li><a href="#_443" rel="nofollow">索引的设计原则</a></li><li><a href="#_452" rel="nofollow">总结</a></li></ul> 
  </li></ul> 
  </li><li><a href="#SQL_486" rel="nofollow">SQL优化</a></li><li><ul><li><a href="#_495" rel="nofollow">插入数据</a></li><li><a href="#_527" rel="nofollow">主键优化</a></li><li><a href="#order_by_546" rel="nofollow">order by优化</a></li><li><a href="#group_by_575" rel="nofollow">group by优化</a></li><li><a href="#limit_589" rel="nofollow">limit优化</a></li><li><a href="#count_597" rel="nofollow">count优化</a></li><li><a href="#update_627" rel="nofollow">update优化</a></li><li><a href="#_636" rel="nofollow">小总结</a></li></ul> 
  </li><li><a href="#_655" rel="nofollow">视图</a></li><li><ul><li><a href="#_656" rel="nofollow">介绍及基本语法</a></li><li><a href="#_720" rel="nofollow">检查选项</a></li><li><a href="#_737" rel="nofollow">更新和作用</a></li><li><a href="#_752" rel="nofollow">案例</a></li></ul> 
  </li><li><a href="#_768" rel="nofollow">存储过程</a></li><li><ul><li><a href="#_769" rel="nofollow">介绍</a></li><li><a href="#_781" rel="nofollow">基本语法</a></li><li><a href="#_823" rel="nofollow">变量</a></li><li><ul><li><a href="#_825" rel="nofollow">系统变量</a></li><li><a href="#_853" rel="nofollow">用户变量</a></li><li><a href="#_887" rel="nofollow">局部变量</a></li></ul> 
   </li><li><a href="#if_913" rel="nofollow">if判断</a></li><li><a href="#_946" rel="nofollow">参数</a></li><li><a href="#case_991" rel="nofollow">case</a></li><li><a href="#_1038" rel="nofollow">炫酷的循环</a></li><li><ul><li><a href="#while_1039" rel="nofollow">while</a></li><li><a href="#repeat_1064" rel="nofollow">repeat</a></li><li><a href="#loop_1091" rel="nofollow">loop</a></li></ul> 
   </li><li><a href="#_1143" rel="nofollow">游标</a></li><li><a href="#_1186" rel="nofollow">条件处理程序</a></li></ul> 
  </li><li><a href="#_1230" rel="nofollow">存储函数</a></li><li><a href="#_1263" rel="nofollow">触发器</a></li><li><ul><li><a href="#_1264" rel="nofollow">介绍</a></li><li><a href="#_1273" rel="nofollow">语法</a></li></ul> 
  </li><li><a href="#about__1348" rel="nofollow">about 视图、存储过程、触发器的小结</a></li><li><a href="#_1367" rel="nofollow">锁</a></li><li><ul><li><a href="#_1369" rel="nofollow">介绍</a></li><li><a href="#_1377" rel="nofollow">全局锁</a></li><li><ul><li><a href="#_1378" rel="nofollow">介绍</a></li><li><a href="#_1386" rel="nofollow">特点</a></li></ul> 
   </li><li><a href="#_1397" rel="nofollow">表级锁</a></li><li><ul><li><a href="#_1406" rel="nofollow">表锁</a></li><li><a href="#_1423" rel="nofollow">元数据锁</a></li><li><a href="#_1441" rel="nofollow">意向锁</a></li></ul> 
   </li><li><a href="#_1456" rel="nofollow">行级锁</a></li><li><ul><li><a href="#_1457" rel="nofollow">介绍</a></li><li><a href="#_1465" rel="nofollow">行锁</a></li><li><a href="#_1489" rel="nofollow">间隙锁/临建锁</a></li></ul> 
   </li><li><a href="#_1497" rel="nofollow">小结</a></li></ul> 
  </li><li><a href="#InnoDB_1514" rel="nofollow">InnoDB引擎</a></li><li><ul><li><a href="#_1515" rel="nofollow">逻辑存储结构</a></li><li><a href="#_1531" rel="nofollow">架构</a></li><li><ul><li><a href="#_1535" rel="nofollow">内存架构</a></li><li><a href="#_1564" rel="nofollow">磁盘架构</a></li><li><a href="#_1589" rel="nofollow">后台线程</a></li></ul> 
   </li><li><a href="#_1609" rel="nofollow">事务原理</a></li><li><ul><li><a href="#_1610" rel="nofollow">概述</a></li><li><a href="#redo_log_1619" rel="nofollow">redo log</a></li><li><a href="#undo_log_1627" rel="nofollow">undo log</a></li></ul> 
   </li><li><a href="#MVCC_1633" rel="nofollow">MVCC</a></li><li><ul><li><a href="#_1634" rel="nofollow">基本概念</a></li></ul> 
   </li><li><a href="#_1647" rel="nofollow">实现原理</a></li><li><ul><li><a href="#undolog_1653" rel="nofollow">undolog版本链</a></li></ul> 
   </li><li><a href="#readview_1663" rel="nofollow">readview</a></li><li><ul><li><a href="#_1678" rel="nofollow">小总结</a></li></ul> 
  </li></ul> 
  </li><li><a href="#MySQL_1695" rel="nofollow">MySQL管理</a></li><li><ul><li><a href="#_1696" rel="nofollow">系统数据库</a></li><li><a href="#_1703" rel="nofollow">常用工具</a></li><li><ul><li><a href="#mysql_1704" rel="nofollow">mysql</a></li><li><a href="#mysqladmin_1725" rel="nofollow">mysqladmin</a></li><li><a href="#mysqlbinlog_1732" rel="nofollow">mysqlbinlog</a></li><li><a href="#mysqlshow_1749" rel="nofollow">mysqlshow</a></li><li><a href="#mysqldump_1775" rel="nofollow">mysqldump</a></li><li><a href="#mysqlimportsource_1803" rel="nofollow">mysqlimport/source</a></li><li><a href="#_1817" rel="nofollow">小总结</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>存储引擎</h2> 
<h3><a id="MySQL_2"></a>MySQL体系结构</h3> 
<p>连接层：<br> 最上层是一些客户端和链接服务，主要完成一些类似于连接处理、授权认证、及相关的安全方案。服务器也会为安全接入的每个客户端验证它所具有的操作权限。<br> 服务层：<br> 第二层结构主要是完成大多数的核心服务功能，如SQL接口，并完成缓存的查询，SQL的分析和优化，部分内置函数的执行。所有跨存储引擎的功能也在这一层实现，如过程、函数等。<br> 引擎层<br> 存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API和存储引擎进行通信。不同的存储引擎具有不同的功能，这样我们可以根据自己的需要，来选取合适的存储引擎。<br> 存储层：<br> 主要是讲数据存储在文件系统之上，并完成与存储引擎的交互。<br> <img src="https://images2.imgbox.com/f3/a9/HobSqkgK_o.png" alt="在这里插入图片描述"></p> 
<p>注意：索引是在存储引擎层实现的，也就意味着不同的存储引擎，索引的结构是不一样的<br> 存储引擎控制的是数据库的数据该如何来存，如何来取，如何来组织，而具体的数据库数据最终是存储在磁盘当中的</p> 
<h3><a id="_16"></a>存储引擎简介</h3> 
<p>what is 存储引擎？<br> do not know？<br> what is 引擎？<br> 引擎就是发动机，发动机是一个机器的核心部分<br> 而不同的引擎实际上是有不同的应用场景的（就像火箭的引擎不能放在汽车上）<br> 引擎没有好坏，只要在合适的场景使用合适的引擎就可以了</p> 
<p>存储引擎就是存储数据、建立索引、更新/查询数据等技术的实现方式。存储引擎是基于表的，而不是基于库的，所有存储引擎也可被称为表类型</p> 
<p>没有指定的存储引擎，那就是默认的InnoDB</p> 
<p>1、在创建表时，指定存储引擎</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">(</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span> <span class="token punctuation">[</span> <span class="token keyword">COMMIT</span> 表注释<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>2、查看当前数据库支持的存储引擎</p> 
<pre><code class="prism language-sql"><span class="token keyword">SHOW</span> ENGINES<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/4b/ec/8XJ8BRBV_o.png" alt="在这里插入图片描述"><br> memory：存储在内存当中的，通常用来做临时表及缓存</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> my_myisam<span class="token punctuation">(</span>
	id <span class="token keyword">int</span><span class="token punctuation">,</span>
	name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span> <span class="token operator">=</span> MyISAM<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> my_memory<span class="token punctuation">(</span>
	id <span class="token keyword">int</span><span class="token punctuation">,</span>
	name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span> <span class="token operator">=</span> Memory<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/43/0b/oVcwVSYv_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="InnoDB_56"></a>InnoDB介绍</h4> 
<p>InnoDB是一种兼顾高可靠性和高性能的通用存储引擎，在MySQL5.5之后，InnoDB是默认的MySQL存储引擎</p> 
<p>特点<br> DML操作遵循ACID模型，支持事务<br> 行级锁，提高并发访问性能<br> 支持外键 FOREIGN KEY约束，保证数据的完整性和正确性；</p> 
<p>文件<br> xxx.ibd：xxx代表的是表名，innoDB引擎的每张表都会对应这样一个表空间文件，存储该表的表结构（frm、sdi）、数据和索引<br> 参数：innodb_file_per_table</p> 
<p><img src="https://images2.imgbox.com/0a/e6/OdWroDiJ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="MyISAM_69"></a>MyISAM</h4> 
<p>介绍;<br> MyISAM是MySQL早期的默认存储引擎<br> 特点：<br> 不支持事务，不支持外键<br> 支持表锁，不支持行锁<br> 访问速度快</p> 
<p>文件<br> xxx.sdi；存储表结构信息<br> xxx,MYD：存储数据<br> xxx.MYI：存储索引</p> 
<h4><a id="Memory_82"></a>Memory</h4> 
<p>介绍：Memory引擎的表数据时存储在内存中的，由于受到硬件问题、或断电问题的影响，只能将这些作为临时表或缓存使用。</p> 
<p>特点：<br> 内存存放<br> 能使用hash索引（默认）</p> 
<p>文件：<br> xxx.sdi：存储表结构信息<br> 为什么只有一个，因为其他的在内存里</p> 
<h3><a id="_93"></a>存储引擎的选择</h3> 
<p>在选择存储引擎时，应该根据应用系统的特点选择合适的存储引擎。对于复杂的应用系统，还可以根据实际情况选择多种存储引擎进行组合。</p> 
<p>InnoDB：是MySQL的默认存储引擎，支持事务、外键。如果应用对事物的完整性有比较高的要求，在并发条件下要求数据的一致性，数据操作除了插入和查询之外，还包含很多的更新、删除操作，那么InnoDB是比较适合的选择</p> 
<p>MyISAM：如果应用是以读操作和插入操作为主，只有很少的更新和删除操作，并且对事物的完整性、并发性要求不是很高，那么选择这个存储引擎是非常适合的。</p> 
<p>MEMORY：将所有的数据保存在内存中，访问速度快，通常用于临时表及缓存。MEMORY的缺陷就是对表的大小有限制，太大的表无法缓存在内存中，而且无法保障数据的安全性。</p> 
<h3><a id="_102"></a>小结</h3> 
<p>1、体系结构<br> 连接层、服务层、引擎层、存储层<br> 2、存储引擎简介</p> 
<pre><code class="prism language-sql"><span class="token keyword">SHOW</span> ENGINES<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> XXXX<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span><span class="token punctuation">;</span>
</code></pre> 
<p>3、存储引擎特点<br> INNODB与MyISAM：事务、外键、行级锁<br> 4、存储引擎应用<br> INNODB：存储业务系统中对于事务、数据完整性要求较高的核心数据<br> MyISAM：存储业务系统的非核心事务</p> 
<h2><a id="_116"></a>索引</h2> 
<h3><a id="_117"></a>概述</h3> 
<p>索引是帮助MySQL高效获取数据的数据结构（有序）。在数据之外，数据库系统还维护者满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据，这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。</p> 
<p>普通的查找就是顺序查找，并且找到以后不会停止，会一直往下找，直到把表全找全了</p> 
<p>索引的优缺点<br> 优势：1、提高数据检索的效率，降低数据库的IO成本。2、通过索引列对数据进行排序，降低数据排序的成本，降低CPU的消耗<br> 劣势：1、索引列也要占用空间的。2、索引大大提高了查询效率，同时却也降低更新表的速度，如对标进行INSERT、UPDATE、DELETE时，效率降低</p> 
<h3><a id="_126"></a>索引结构</h3> 
<h4><a id="_127"></a>概述</h4> 
<p>MySQL的索引是在存储引擎层实现的，不同的存储引擎有不同的结构，主要包含以下几种</p> 
<p>索引结构：描述<br> B+Tree索引：最常见的索引类型，大部分引擎都支持B+树索引<br> Hash索引：底层数据结构使用哈希表实现的，只有精确匹配索引列的查询才有效，不支持范围查询<br> R-tree（空间索引）：空间索引是MyISAM引擎的一个特殊索引类型，主要用于地理空间数据类型，通常使用较少<br> Full-text（全文索引）：是一种通过建立倒排索引，快速匹配文档的方式。类似于Lucene，Solr，ES</p> 
<p><img src="https://images2.imgbox.com/65/58/kp3p3cER_o.png" alt="在这里插入图片描述"><br> ”错综复杂的关系“</p> 
<p>我们平常所说的索引，如果没有特别指明，都是B+树结构组织的索引</p> 
<h4><a id="Btree_141"></a>Btree</h4> 
<p><img src="https://images2.imgbox.com/1f/d4/aeAlLy0W_o.png" alt="在这里插入图片描述"></p> 
<p>二叉树的缺点：顺序插入时，会形成一个链表，查询性能大大降低。大数据量情况下，层级越深，检索速度慢。<br> 可以通过红黑树解决单向链表的问题。但是大数据量情况下，层级较深，检索速度慢</p> 
<p>而B-tree（多路平衡查找树）<br> 以一颗最大度数（max-degree）为5（5阶）的B-tree为例（每个节点最多存储4个key，五个指针</p> 
<p>具体动态变化的过程可以参考网站：<br> https://www.cs.usfca.edu/~galles/visualization/BTree.html</p> 
<h4><a id="BTree_153"></a>B+Tree</h4> 
<p>以一颗最大度数（max-degree）为4（4阶）的B+tree为例：<br> <img src="https://images2.imgbox.com/24/4b/LPYdhLqD_o.png" alt="在这里插入图片描述"><br> 相对于B-Tree区别<br> 1、所有的数据都会出现在叶子节点<br> 2、叶子节点形成一个单向链表</p> 
<p>B+Tree<br> MySQL索引数据结构对经典的B+Tree进行了优化。在原先B+TRee的基础上，增加了一个指向相邻节点的链表指针，就形成了带有顺序指针的B+Tree，提高区间访问的性能。<br> <img src="https://images2.imgbox.com/cd/25/QYIIdbv5_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Hash_163"></a>Hash</h4> 
<p>哈希索引就是采用一定的hash算法，将键值换算成新的hash值，映射到对印的槽位上，然后存储在hash表中。<br> 如果两个（或多个）键值，映射到一个相同的槽位上，他们就产生了hash冲突（也叫做hash碰撞），可以通过链表来解决</p> 
<p>Hash索引特点<br> 1、Hash索引只能用于对等比较（=，in），不支持范围查询（between，&gt;,&lt;，…）<br> 2、无法利用索引完成排序操作<br> 3、查询效率搞，通常只需要一次检索就可以了，效率通常要高于B+tree索引</p> 
<p>存储引擎支持<br> 在MySQL中，支持hash索引的是Memory引擎，而InnoDB中具有自适应hash功能，hash索引是存储引擎根据B+Tree索引在指定条件下自动构建的。</p> 
<h4><a id="_176"></a>“严肃的思考题”</h4> 
<p>为什么InnoDB存储引擎选择使用B+tree索引结构？<br> 分开思考<br> 1、相对于二叉树，层级更少，搜索效率高。<br> 2、相对于B-tree，无论是叶子节点还是非叶子节点，都会保存数据，这样会导致一页中存储的键值减少，指针跟着减少，腰痛要保存大量数据，只能增加树的高度，导致性能降低。<br> 3、相对于Hash索引，B+tree支持范围匹配及排序操作；</p> 
<h3><a id="_183"></a>索引分类</h3> 
<p>主键索引：PRIMARY：针对于表中主键创建的索引。<br> 特点：默认自动创建，只能有一个</p> 
<p>唯一索引：UNIQUE：避免同一个表中某数据列中的值重复<br> 特点：可以有多个</p> 
<p>常规索引：（没有关键字）：快速定位特定数据<br> 特点：可以有多个</p> 
<p>全文索引：FULLTEXT：全文索引查找的是文本中的关键词，而不是比较索引中的值<br> 特点：可以有多个</p> 
<p>在InnoDB存储引擎中，根据索引的存储形式，又可以分为以下两种：<br> 聚集索引（Clustered index）：将数据存储与索引放到了一块，索引结构的叶子节点保存了行数据：必须有，而且只有一个<br> 二级索引（Secondary Index）：将数据与索引分开存储，索引结构的叶子节点关联的是对应的主键：可以存在多个。</p> 
<p>聚集索引选取规则：<br> 如果存在主键，主键索引就是聚集索引。<br> 若果不存在主键，将使用第一个唯一（UNIQUE）索引作为聚集索引<br> 如果表没有主键，或没有合适的唯一索引，则InnoDB会自动生成一个rowid作为隐藏的聚集索引</p> 
<h4><a id="_206"></a>“严肃的思考题”</h4> 
<p>1、以下SQL语句，那个执行效率高？为什么？</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'Arm'</span><span class="token punctuation">;</span>
<span class="token comment">-- 备注：id为主键，name字段创建的有索引</span>
</code></pre> 
<p>第一条高，第二条还要执行一次回表查询</p> 
<p>2、InnoDB主键索引的B+tree高度为多高呢？<br> 假设：<br> 一行数据大小为1k，一页中可以存储16行这样的数据。InnoDB的指针占用6个字节的空间，主键即使为bigint，占用字节数为8。<br> 高度为2时：n<em>8+（n+1）<em>6 = 16</em>1024，算出n约为1170，1171</em>16 = 18736<br> 高度为3时：1171<em>1171</em>16 = 21939856</p> 
<h3><a id="_220"></a>索引语法</h3> 
<p>创建索引</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token punctuation">[</span> <span class="token keyword">UNIQUE</span> <span class="token operator">|</span> FULLTEXT <span class="token punctuation">]</span> <span class="token keyword">INDEX</span> index_name <span class="token keyword">ON</span> table_name <span class="token punctuation">(</span>index_col_name<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>查看索引</p> 
<pre><code class="prism language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">INDEX</span> <span class="token keyword">FROM</span> table_name<span class="token punctuation">;</span>
</code></pre> 
<p>删除索引</p> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> index_name <span class="token keyword">ON</span> table_name<span class="token punctuation">;</span>
</code></pre> 
<p>小练习：<br> 已知两表如下所示：<br> <img src="https://images2.imgbox.com/91/e4/qxXlMGIp_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/21/2d/0IMHlYFF_o.png" alt="在这里插入图片描述"></p> 
<p>需求：<br> 1、name字段为姓名字段，该字段的值可能会重复，为该字段创建索引</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">index</span> idx_user_name <span class="token keyword">on</span> tb_user<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2、phone手机号字段的值，是非空，且唯一的，为该字段创建唯一索引。</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">unique</span> <span class="token keyword">index</span> idx_user_phone <span class="token keyword">on</span> tb_user<span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>3、为profession、age、status创建联合索引</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">index</span> idx_user_pre_age_sta <span class="token keyword">on</span> tb_user<span class="token punctuation">(</span>profession<span class="token punctuation">,</span>age<span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>4、为email建立合适的索引来提升查询效率</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">index</span> idx_user_email <span class="token keyword">on</span> tb_user<span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>5、删除索引</p> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">index</span> idx_user_email <span class="token keyword">on</span> tb_user<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="SQL_262"></a>SQL性能分析</h3> 
<h4><a id="_263"></a>查看执行频次</h4> 
<p>SQL执行频率<br> MySQL客户端连接成功后，通过show[session|global] status命令可以提供服务器状态信息。通过如下指令，可以查看当前数据库的INSERT、UPDATE、DELETE、SELECT的访问频次</p> 
<pre><code class="prism language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">GLOBAL</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'Com____'</span><span class="token punctuation">;</span>
</code></pre> 
<p>实操：</p> 
<pre><code class="prism language-sql"><span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'Com_______'</span><span class="token punctuation">;</span> <span class="token comment">-- 七个下划线代表七个字符</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/02/b6/klAUnEkF_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_275"></a>慢查询日志</h4> 
<p>慢查询日志记录了所有执行时间超过指定参数（long_query_time，单位：秒，默认十秒)的所有SQL语句的日志。<br> MySQL的慢性日志默认没有开启，需要在MySQL的配置文件（/etc/my.cnf）中配置如下信息：</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 查看慢查询日志是否开启</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'slow_query_log'</span><span class="token punctuation">;</span>
<span class="token comment">-- 开启MySQL慢日志查询开关</span>
slow_query_log <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">-- 设置慢日志的时间为2秒，SQL语句执行时间超过2秒，就会视为慢查询，记录慢查询日志</span>
long_query_time <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre> 
<p>配置完毕之后，通过以下指令重新启动MySQL服务器进行测试，查看慢日志文件中记录的信息/va/lib/mysql/localhost-slow.log。</p> 
<h4><a id="show_profiles_289"></a>show profiles</h4> 
<p>show profiles 能够在做SQL优化时帮助我们了解时间都耗费到哪里去了（有些运行时间为1.9几秒的慢查询日志查不到）。<br> 通过have_profiling参数，能够看到当前MySQL是否支持profile操作</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> @<span class="token variable">@have_profiling</span><span class="token punctuation">;</span>
</code></pre> 
<p>默认profiling是关闭的，可以通过set语句在session/global级别开启profiling：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SET</span> profiling <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> 
<p>执行一系列的业务SQL的操作，然后通过如下指令查看指令的执行耗时：</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 查看每一条SQL的耗时基本情况</span>
<span class="token keyword">show</span> profiles<span class="token punctuation">;</span>
<span class="token comment">-- 查看指定的query_id的SQL语句各个阶段的耗时情况</span>
shoe profile <span class="token keyword">for</span> query query_id<span class="token punctuation">;</span>
<span class="token comment">-- 查看指定query_id的SQL语句CPU的使用情况</span>
<span class="token keyword">show</span> profile cpu <span class="token keyword">for</span> query query_id<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e6/9e/DIR7KqSe_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7a/7b/9Zgkgrou_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="explian_311"></a>explian</h4> 
<p>explian或者desc命令获取MySQL如何执行SELECT语句的信息，包括在SELECT语句执行过程中表如何连接和连接的顺序。<br> 语法</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 直接在select语句之前加上关键字explian/desc</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> 字段列表 <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> 条件<span class="token punctuation">;</span>
</code></pre> 
<p>explain执行计划<br> explain执行计划个字段含义：</p> 
<p>id：<br> select查询的序列号，表示查询中执行select子句或者是操作表的顺序（id相同，执行顺序从上到下；id不同，值越大，越先执行）。</p> 
<p>select_type<br> 表示select的类型，常见的取值有simple（简单表，即不适用表连接或者子查询）、PRIMARY（主查询，即外层的查询）、UNION（UNION中的第二个或者后面的查询语句）、SUBQUERY(SELECT/WHERE之后包含了子查询）等</p> 
<p><strong>type<br> 表示连接类型，性能由好到差的来凝结类型为NULL、system、const、eq_ref、ref、range、index、all。（一般情况下是不可能优化到null的，这玩意只有不查询表的时候才会变成null；system相当于范围系统表；根据主键还有唯一索引进行访问，一般会出现const；使用非唯一性的索引进行查询时，会出现ref；all是全表扫描性能最低，尽量将type往前优化）</strong></p> 
<p><strong>possible_key<br> 显示可能应用在这张表上的索引，一个或多个。</strong></p> 
<p><strong>key<br> 实际使用的索引，如果为null，则没有使用索引</strong></p> 
<p><strong>key_len<br> 表示索引中使用的字节数，该值为索引字段最大可能长度，并非实际使用长度，在不损失精确性的前提下，长度越短越好。</strong></p> 
<p><strong>rows<br> MySQL认为必须要执行查询的行数，在innodb引擎的表中，是一个预估值，可能并不总是准确的</strong></p> 
<p>filtered<br> 表示返回结果的函数占需读取行数的百分比，filtered的值越大越好。</p> 
<h3><a id="_345"></a>索引使用规则</h3> 
<h4><a id="_347"></a>验证索引效率</h4> 
<p>在未建立索引之前，执行如下SQL语句，查看SQL的耗时</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_sku <span class="token keyword">WHERE</span> sn <span class="token operator">=</span> <span class="token string">'100000003145001'</span><span class="token punctuation">;</span>
</code></pre> 
<p>针对字段创建索引</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">index</span> idx_sku_sn <span class="token keyword">on</span> tb_sku<span class="token punctuation">(</span>sn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>然后再次执行相同的SQL语句，再次查看SQL的耗时</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_sku <span class="token keyword">WHERE</span> sn <span class="token operator">=</span> <span class="token string">'100000003145001'</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_361"></a>最左前缀法则</h4> 
<p>如果索引了多列（联合索引），要遵循最左前缀法则。最左前缀法则指的是查询从索引的最左列开始，并且不跳过索引中的列。<br> 如果跳跃某一列，索引将部分失效（后面的字段索引失效）</p> 
<h4><a id="_365"></a>范围查询</h4> 
<p>联合索引中，出现范围查询（&gt;,&lt;），范围查询右侧的列索引失效</p> 
<h4><a id="_369"></a>索引失效情况一</h4> 
<p>不要在索引列上进行运算操作，索引将失效</p> 
<p>例如：</p> 
<pre><code class="prism language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tb_user <span class="token keyword">where</span> substring<span class="token punctuation">(</span>phone<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'15'</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/02/71/Fq9hk4Kz_o.png" alt="在这里插入图片描述"></p> 
<p>字符串不加引号<br> 字符串类型字段使用时，不加引号，索引将失效<br> <img src="https://images2.imgbox.com/2c/34/ynVoCCSA_o.png" alt="在这里插入图片描述"><br> 模糊查询：<br> 如果仅仅是尾部模糊匹配，索引不会失效。如果是头部模糊匹配，索引失效<br> <img src="https://images2.imgbox.com/ae/5c/YlXkY28E_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_384"></a>索引失效情况二</h4> 
<p>or连接的条件<br> 用or分割开的条件，如果or前的条件中的列有索引，而后面的列中没有索引，那么涉及的索引都不会被用到<br> <img src="https://images2.imgbox.com/61/4a/OZiUMhn8_o.png" alt="在这里插入图片描述"><br> 由于age没有索引，所以即使id、phone有索引，索引也会失效。所以需要针对于age也要建立索引。</p> 
<p>数据分布影响：<br> 如果MySQL评估使用索引比全表更慢，则不会使用索引，而是用全表扫描</p> 
<h4><a id="SQL_393"></a>SQL提示</h4> 
<p>SQL提示，是优化数据库的一个重要手段，简单来说，就是在SQL语句中加入一些认为的提示来达到优化操作的目的。<br> use index：</p> 
<pre><code class="prism language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tb_user <span class="token keyword">use</span> <span class="token keyword">index</span><span class="token punctuation">(</span>idx_user_pro<span class="token punctuation">)</span> <span class="token keyword">where</span> profession <span class="token operator">=</span> <span class="token string">'软件工程'</span><span class="token punctuation">;</span>
</code></pre> 
<p>ignore index</p> 
<pre><code class="prism language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tb_user <span class="token keyword">ignore</span> <span class="token keyword">index</span><span class="token punctuation">(</span>idx_user_pro<span class="token punctuation">)</span> <span class="token keyword">where</span> profession <span class="token operator">=</span> <span class="token string">'软件工程'</span><span class="token punctuation">;</span>
</code></pre> 
<p>force index</p> 
<pre><code class="prism language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tb_user <span class="token keyword">force</span> <span class="token keyword">index</span><span class="token punctuation">(</span>tb_user_pro<span class="token punctuation">)</span> <span class="token keyword">where</span> profession <span class="token operator">=</span> <span class="token string">'软件工程'</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_408"></a>覆盖索引</h4> 
<p>尽量使用覆盖索引（查询使用了索引，并且需要返回的列，在该索引中已经全部都能够找回），减少select *。</p> 
<p>using index condition：查找使用了索引，但是需要回表查询数据<br> using where；using index：查找使用了索引，但是需要的数据都在索引列中都能找到，所以不需要回表查询数据</p> 
<p>小思考<br> 一张表，有四个字段（id，username，password，status），由于数据量大，需要对以下SQL语句进行优化，该如何进行才是最优方案</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> id<span class="token punctuation">,</span>username<span class="token punctuation">,</span>password <span class="token keyword">from</span> tb_user <span class="token keyword">where</span> username <span class="token operator">=</span> <span class="token string">'itcast'</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_421"></a>前缀索引</h4> 
<p>当字段类型为字符串（varchar，text等）时，有时候需要索引很长的字符串，这会让索引变得很大，查询时，浪费大量的磁盘IO，影响查询效率。此时可以只将字符串的一部分前缀，建立索引，这样可以大大节约索引空间，从而提高索引效率。</p> 
<p>语法</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">index</span> idx_xxx <span class="token keyword">on</span> table_name<span class="token punctuation">(</span><span class="token keyword">column</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>前缀长度<br> 可以根据索引的选择性来决定，而选择性是指不重复的索引值（基数）和数据表的记录总数的比值，索引选择性越高则查询效率越高，唯一索引的选择性是1，这是最好的索引选择性，性能也是最好的。</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 求取索引选择性</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> email<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> tb_user<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> sunstring<span class="token punctuation">(</span>email<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> tb_user <span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_436"></a>单列索引与联合索引的选择</h4> 
<p>单列索引：即一个索引只包含单个列<br> 联合索引：即一个索引包含了多个列<br> 在业务场景中，如果存在多个查询条件，考虑针对于查询字段建立索引时，建议建立联合索引而非单列索引。<br> <img src="https://images2.imgbox.com/ca/fc/pRb4fcqi_o.png" alt="在这里插入图片描述"><br> 多条件联合查询时，MySQL优化器会评估哪个字段的索引效率更高，会选择该索引完成本次插查询。</p> 
<h4><a id="_443"></a>索引的设计原则</h4> 
<p>1、针对于数据量大的，且查询比较频繁的表建立索引。<br> 2、针对于常作为查询条件（where）、排序（order by）、分组（group by）操作的字段建立索引<br> 3、尽量选择区分度高的列作为索引，尽量建立唯一索引，区分度越高，使用索引的效率越高。<br> 4、容易过时字符串类型的字段，字段的长度较长，可针对于字段的特点，建立前缀索引。<br> 5、尽量使用联合索引，减少单列索引，查询时，联合索引很多时候可以覆盖索引，节省存储空间，避免回表，提高查询效率。<br> 6、要控制索引的数量，索引并不是多多益善，索引越多，维护索引结构的代价也就越大，会影响增删改查的效率。<br> 7、如果索引列不能存储null值，请在创建表时使用not null约束它。当优化器直到每列是否包含null值时，他可以更好地确定哪个索引最有效的用于查询。</p> 
<h4><a id="_452"></a>总结</h4> 
<p>1、索引概述<br> 索引是高效获取数据的数据结构；</p> 
<p>2、索引结构<br> B+Tree<br> Hash</p> 
<p>3、索引分类<br> 主键索引、唯一索引、常规索引、全文索引、聚集索引、二级索引</p> 
<p>4、索引语法</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token punctuation">[</span><span class="token keyword">unique</span><span class="token punctuation">]</span> <span class="token keyword">index</span> xxx <span class="token keyword">on</span> xxx<span class="token punctuation">(</span>xxx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> xxx <span class="token punctuation">;</span>
<span class="token keyword">drop</span> <span class="token keyword">index</span> xxx <span class="token keyword">on</span> xxx<span class="token punctuation">;</span>
</code></pre> 
<p>5、SQL性能分析<br> 执行频次、慢查询日志、profile、explain</p> 
<p>6、索引使用<br> 联合索引<br> 索引失效<br> SQL提示<br> 覆盖索引<br> 前缀索引<br> 单列/联合索引</p> 
<p>7、索引设计原则<br> 表<br> 字段<br> 索引</p> 
<h2><a id="SQL_486"></a>SQL优化</h2> 
<p>其中包含：<br> 插入数据<br> 主键优化<br> order by优化<br> group by优化<br> limit优化<br> count优化<br> update优化</p> 
<h3><a id="_495"></a>插入数据</h3> 
<p>insert优化：<br> 批量优化</p> 
<pre><code class="prism language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> tb_test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'Cat'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'Jerry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>手动提交事务</p> 
<pre><code class="prism language-sql"><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tb_test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'Cat'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'Jerry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tb_test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'Cat'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">'Jerry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tb_test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'Cat'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token string">'Jerry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre> 
<p>主键顺序插入</p> 
<p>主键乱序插入：8 1 9 21 88 2 4 15 89 5 7 3<br> 主键顺序插入：1 2 3 4 5 6 7 8 9 15 21 88 89</p> 
<p>大批量插入数据<br> 如果一次性需要插入大批量数据，使用insert语句插入性能较低，此时可以使用MySQL数据库提供的load指令进行插入。操作如下：</p> 
<pre><code class="prism language-sql"><span class="token comment"># 客户端连接服务端时，加上参数 --local-infile</span>
mysql<span class="token comment">--local-infile -u root -p</span>
<span class="token comment"># 设置全局参数local_infile = 1；</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> local_infile <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment"># 执行load指令将准备好的数据，加载到表结构中</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> <span class="token keyword">infile</span> <span class="token string">'/root/sql1.log'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> <span class="token string">'tb_user'</span> <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span> <span class="token keyword">lines</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
</code></pre> 
<p>主键顺序插入性能高于乱序插入</p> 
<h3><a id="_527"></a>主键优化</h3> 
<p>数据组织方式<br> 在InnoDB存储引擎中，表数据都是根据主键顺序组织存放的，这种存储方式的表称为索引组织表</p> 
<p>页分裂（现象）<br> 页可以为空，也可以填充一半，也可以填充100%。每个页包含了2-N行数据（如果一行数据多大，会行溢出），根据主键排列</p> 
<p>页合并（现象）<br> 当删除一行记录时，实际上记录并没有被物理删除，只是记录被标示为删除并且它的空间变得允许被其他记录声明使用。<br> 当页中删除的记录达到MERGE_THRESHOLD（默认为页的50%），InnoDB会开始寻找最靠近的页（前或后）看看是否可以将两个页合并以优化空间使用。</p> 
<p>MERGE_THRESHOLD：合并页的阈值，可以自己设置，在创建表或者创建索引时指定。</p> 
<p>主键设计原则<br> 满足业务需求的情况下，尽量降低主键的长度<br> 插入数据时，尽量选择顺序插入，选择使用AUTO_INCREMENT自增主键<br> 尽量不要使用UUID做主键或者是其他自然主键，如身份证号。<br> 业务操作时，避免对主键的修改。</p> 
<h3><a id="order_by_546"></a>order by优化</h3> 
<p>1、Using filesort：通过表的索引或者全表扫描，读取满足条件的数据行，然后在排序 缓冲区sort buffer中完成排序操作，所有不是通过索引直接返回排序结果的排序都叫FIleSort排序<br> 2、Using index：通过有序索引顺序扫描直接返回有序数据，这种情况即为using index，不需要额外排序，操作效率极高。</p> 
<pre><code class="prism language-sql"><span class="token comment"># 没有创建索引时，根据age，phone进行排序</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>age<span class="token punctuation">,</span>phone <span class="token keyword">from</span> tb_user <span class="token keyword">order</span> <span class="token keyword">by</span> age<span class="token punctuation">,</span>phone<span class="token punctuation">;</span>
<span class="token comment"># 创建索引</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> idx_user_age_phone_aa <span class="token keyword">on</span> tb_user<span class="token punctuation">(</span>age<span class="token punctuation">,</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 创建索引后，根据age，phone进行升序排序</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>age<span class="token punctuation">,</span>phone <span class="token keyword">from</span> tb_user <span class="token keyword">order</span> <span class="token keyword">by</span> age<span class="token punctuation">,</span>phone<span class="token punctuation">;</span>
<span class="token comment"># 创建索引后，根据age，phone进行降序排序</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>age<span class="token punctuation">,</span>phone <span class="token keyword">from</span> tn_user <span class="token keyword">order</span> <span class="token keyword">by</span> age <span class="token keyword">desc</span> <span class="token punctuation">,</span> phone <span class="token keyword">desc</span><span class="token punctuation">;</span>
</code></pre> 
<p>一个升序一个降序</p> 
<pre><code class="prism language-sql"><span class="token comment"># 根据age，phone进行降序一个升序，一个降序</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>age<span class="token punctuation">,</span>phone <span class="token keyword">from</span> tb_user <span class="token keyword">order</span> <span class="token keyword">by</span> age <span class="token keyword">asc</span><span class="token punctuation">,</span>phone <span class="token keyword">desc</span><span class="token punctuation">;</span>
<span class="token comment"># 创建索引</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> idx_user_age_phone_ad <span class="token keyword">on</span> tb_user<span class="token punctuation">(</span>age <span class="token keyword">asc</span><span class="token punctuation">,</span> phone <span class="token keyword">desc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 根据age，phone进行降序一个升序，一个降序</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>age<span class="token punctuation">,</span>phone <span class="token keyword">from</span> tb_user <span class="token keyword">order</span> <span class="token keyword">by</span> age <span class="token keyword">asc</span> <span class="token punctuation">,</span> phone <span class="token keyword">desc</span><span class="token punctuation">;</span>
</code></pre> 
<p>根据排序字段建立合适的索引，多字段排序时，也遵循最左前缀法则。<br> 尽量使用覆盖索引。<br> 多字段排序，一个升序一个降序，此时需要注意联合索引在创建时的规则（ASC/DESC）。<br> 如果不可避免的出现filesort，大数据量排序时，可以适当增大排序缓冲区大小sort_buffer_size（默认256k）。</p> 
<h3><a id="group_by_575"></a>group by优化</h3> 
<pre><code class="prism language-sql"><span class="token comment"># 删除掉目前的联合索引idx_user_pro_age_sta</span>
<span class="token keyword">drop</span> <span class="token keyword">index</span> idx_user_pro_age_sta <span class="token keyword">on</span> tb_user<span class="token punctuation">;</span>
<span class="token comment"># 执行分组操作，根据profession字段分组</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> profession <span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> tb_user <span class="token keyword">group</span> <span class="token keyword">by</span> profession<span class="token punctuation">;</span>
<span class="token comment"># 创建索引</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> idx_user_pro_age_sta <span class="token keyword">on</span> tb_user<span class="token punctuation">(</span>profession<span class="token punctuation">,</span>age<span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 执行分组操作，根据profession字段分组</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> profession <span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> tb_user <span class="token keyword">group</span> <span class="token keyword">by</span> profession<span class="token punctuation">;</span>
<span class="token comment"># 执行分组操作，根据profession字段分组</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> profession <span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> tb_user <span class="token keyword">group</span> <span class="token keyword">by</span> profession <span class="token punctuation">,</span> age<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="limit_589"></a>limit优化</h3> 
<p>一个常见又非常头疼的问题就是limit 2000000，10，此时需要MySQL排序前2000010记录，仅仅返回2000000 - 2000010 的记录，其他记录丢弃，查询排序的代价非常大</p> 
<p>优化思路：一般分页查询时，通过创建覆盖索引能够比较好的提高性能，可以通过覆盖索引加子查询形式进行优化。</p> 
<pre><code class="prism language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tb_sku t <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">select</span> id <span class="token keyword">from</span> tb_sku <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">limit</span> <span class="token number">2000000</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span> a <span class="token keyword">where</span> t<span class="token punctuation">.</span>id <span class="token operator">=</span> a<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="count_597"></a>count优化</h3> 
<pre><code class="prism language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> tb_user<span class="token punctuation">;</span>
</code></pre> 
<p>MyISAM引擎把一个表的总行数存在了磁盘上，因此执行count（* ）的时候会直接返回这个数，效率很高；</p> 
<p>innodb引擎就麻烦了，它执行count（* ）的时候，需要把数据一行一行地从引擎里面读出来，然后累积计数<br> 优化思路：自己计数。</p> 
<p>count的几种用法<br> count（）是一个聚合函数，对于返回的结果集，一行行地判断，如果count函数地参数不是null，累计值就加一，否则就不加，最后返回累计值<br> 用法：count（*）、count（主键）、count（字段）、count（1）</p> 
<p>count（主键）<br> InnoDB引擎会遍历整张表，把每一行地主键id都取出来，返回给服务层。服务层拿到主键后，直接按行进行累加（主键不可能为null）。</p> 
<p>count（字段）<br> 没有not null约束：InnoDB引擎会遍历整张表把每一行的字段值都取出来，返回给服务层，服务层判断是否为null，不为null，计数累加。<br> 有not null约束：InnoDB引擎会便利整张表把每一行的字段值都取出来，返回给服务层，直接按行进行累加。</p> 
<p>count（1）<br> InnoDB引擎遍历整张表，但不取值。服务层对于返回的每一行，放一个数字“1”进去，直接按行进行累加。</p> 
<p>count（*）<br> InnoDB引擎并不会把全部字段取出来，而是专门做了优化，不取值，服务层直接按行进行累加。</p> 
<p>按照效率排序的话，count（字段)&lt;count（主键 id）&lt;count（1）≈count（*）</p> 
<p>所以尽量使用count（*）。</p> 
<h3><a id="update_627"></a>update优化</h3> 
<pre><code class="prism language-sql"><span class="token keyword">update</span> student <span class="token keyword">set</span> <span class="token keyword">no</span> <span class="token operator">=</span> <span class="token string">'2000100100'</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">update</span> student <span class="token keyword">set</span> <span class="token keyword">no</span> <span class="token operator">=</span> <span class="token string">'2000100105'</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'韦一笑'</span><span class="token punctuation">;</span>
</code></pre> 
<p>InnoDB的行锁是针对索引加的锁，不是针对记录加的锁，并且该索引不能失效，否则会从行锁升级为表锁。</p> 
<h3><a id="_636"></a>小总结</h3> 
<p>1、插入数据<br> insert：批量插入、手动控制事务、主键顺序插入<br> 大批量插入：load data local infile<br> 2、主键优化<br> 主键长度尽量短、顺序插入 AUTO_INCREMENT<br> 3、order by优化<br> using index：直接通过所以返回数据，性能高<br> using filesort：需要将返回的结果在排序缓冲区排序<br> 4、group by优化<br> 索引，多字段分组满足最左前缀法则<br> 5、limit优化<br> 覆盖索引+子查询<br> 6、count优化<br> 性能：count（字段）&lt;count（主键 id）&lt;count（1）≈count（*）<br> 7、update优化<br> 尽量根据主键/索引字段进行数据更新</p> 
<h2><a id="_655"></a>视图</h2> 
<h3><a id="_656"></a>介绍及基本语法</h3> 
<p>什么是视图？<br> 试图是一种虚拟存在的表。视图中的数据并不在数据库中实际存在，行和列数据来自定义视图的查询中使用的表，并且是在使用视图时动态生成的<br> 通俗的讲，视图只保存了查询SQL逻辑，不保存串查询结果。所以我们在创建视图的时候，主要的工作就落在了创建这条SQL查询语句上。</p> 
<p>创建</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token operator">OR</span> <span class="token keyword">REPLACE</span><span class="token punctuation">]</span> <span class="token keyword">VIEW</span> 视图名称<span class="token punctuation">[</span><span class="token punctuation">(</span>列名列表<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>语句 <span class="token punctuation">[</span><span class="token keyword">WITH</span><span class="token punctuation">[</span><span class="token keyword">CASCADED</span> <span class="token operator">|</span> <span class="token keyword">LOCAL</span> <span class="token punctuation">]</span> <span class="token keyword">CHECK</span> <span class="token keyword">OPTION</span> <span class="token punctuation">]</span>
</code></pre> 
<p>小实操<br> <img src="https://images2.imgbox.com/33/68/SV9eTJSe_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">-- 创建视图</span>
<span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">view</span> stu_v_1 <span class="token keyword">as</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>name <span class="token keyword">from</span> student <span class="token keyword">where</span> id <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6a/45/jSx65XMN_o.png" alt="在这里插入图片描述"><br> 查询</p> 
<pre><code class="prism language-sql"><span class="token comment"># 查看创建视图语句</span>
<span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">view</span> 视图名称<span class="token punctuation">;</span>
<span class="token comment"># 查看视图数据</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 视图名称 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
</code></pre> 
<p>小实操</p> 
<pre><code class="prism language-sql"><span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">view</span> stu_v_1<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/2d/87/rKvMeAjG_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_v_1<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/43/30/dwBM2oTc_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_v_1 <span class="token keyword">where</span> id <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d2/ae/wtmd8QPx_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment"># 修改视图</span>
<span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">view</span> stu_v_1 <span class="token keyword">as</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token keyword">no</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> id <span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1f/9c/ptAvRcyW_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token keyword">alter</span> <span class="token keyword">view</span> stu_v_1 <span class="token keyword">as</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>name <span class="token keyword">from</span> student <span class="token keyword">where</span> id <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/60/a1/7a3357OX_o.png" alt="在这里插入图片描述"></p> 
<p>删除</p> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">view</span> <span class="token punctuation">[</span><span class="token keyword">if</span> <span class="token keyword">exists</span><span class="token punctuation">]</span> 视图名称 <span class="token punctuation">[</span><span class="token punctuation">,</span>视图名称<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>小实操</p> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">view</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> stu_v_1<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/23/c1/mpQeUN6n_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_720"></a>检查选项</h3> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_v_1<span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> stu_v_1 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/26/67/vi6wvN44_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">view</span> stu_v_1 <span class="token keyword">as</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>name <span class="token keyword">from</span> student <span class="token keyword">where</span> id <span class="token operator">&lt;=</span> <span class="token number">20</span> <span class="token keyword">with</span> <span class="token keyword">cascaded</span> <span class="token keyword">check</span> <span class="token keyword">option</span><span class="token punctuation">;</span>
</code></pre> 
<p>这条语句可以组织id&gt;20的数据插入,若是操作了这样的数据,会报错<br> <img src="https://images2.imgbox.com/56/f8/RpnSzQcY_o.png" alt="在这里插入图片描述"></p> 
<p>视图的检查选项<br> 当使用with check option子句创建视图时,MySQL会通过试图检查正在更改的每个行,例如:插入,更新,删除,以使其符合试图的定义.MySQL允许基于另一个视图创建试图,他还会检查以来试图中的规则以保持一致性.为了确定检查的范围,mysql提供了两个选项,CASCADED和LOCAL,默认值为CASCADED.</p> 
<p>在编写的时候一定要在后面加上with cascade/local check option不然只会执行不会判断</p> 
<h3><a id="_737"></a>更新和作用</h3> 
<p>视图的更新<br> 要使视图可更新,视图中的行与基础表中的行之间必须存在一对一的关系.如果视图包含以下任何一项,则该视图不可更新:<br> 1、聚合函数或窗口函数(SUM()、MIN()、MAX()、COUNT()等)<br> 2、DISTINCT<br> 3、GROUP BY<br> 4、HAVING<br> 5、UNION或 UNION ALL</p> 
<p>作用<br> 简单:视图不仅可以简化用户对数据的理解,也可以简化他们的操作.那些被经常使用的查询可以被定义为视图,从而使得用户不必为以后的操作每次指定全部的条件<br> 安全:数据库可以授权,但不能授权到数据库特定行和特定的列上.通过视图用户只能查询和修改他们所能见到的数据<br> 数据独立:数据可帮助用户屏蔽真实表结构变化带来的影响.</p> 
<h3><a id="_752"></a>案例</h3> 
<p>需求:<br> 1、为了保证数据库的安全性,开发人员在操作tb_user表时,只能看到用户的基本字段,屏蔽手机号和邮箱两个字段</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">view</span> tb_user_view <span class="token keyword">as</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>profession<span class="token punctuation">,</span>age<span class="token punctuation">,</span>gender<span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">,</span>createtime <span class="token keyword">from</span> tb_user<span class="token punctuation">;</span>
</code></pre> 
<p>2、查询每个学生所选修的课程(三张表联查，这个功能在很多的业务中都有使用到，为了简化操作，定义一个视图</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> s<span class="token punctuation">.</span>name<span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token keyword">no</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>name <span class="token keyword">from</span> student s<span class="token punctuation">,</span> student_course sc<span class="token punctuation">,</span> course c <span class="token keyword">where</span> s<span class="token punctuation">.</span>id <span class="token operator">=</span> sc<span class="token punctuation">.</span>studentid <span class="token operator">and</span> sc<span class="token punctuation">.</span>courseid <span class="token operator">=</span> c<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/90/0f/i4QGAelN_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">view</span> tb_stu_course_view <span class="token keyword">as</span> <span class="token keyword">select</span> s<span class="token punctuation">.</span>name student_name<span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token keyword">no</span> student_no<span class="token punctuation">,</span> c<span class="token punctuation">.</span>name course_name <span class="token keyword">from</span> student s<span class="token punctuation">,</span> student_course sc<span class="token punctuation">,</span> course c <span class="token keyword">where</span> s<span class="token punctuation">.</span>id <span class="token operator">=</span> sc<span class="token punctuation">.</span>studentid <span class="token operator">and</span> sc<span class="token punctuation">.</span>courseid <span class="token operator">=</span> c<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3d/4e/NXqkUa5D_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_768"></a>存储过程</h2> 
<h3><a id="_769"></a>介绍</h3> 
<p>在实际应用场景中可能需要多次操作数据库，一个逻辑中可能需要操作多次数据库，那么就意味着会涉及到多次网络请求。</p> 
<p>存储过程是实现经过编译并存储在数据库中的一段SQL语句的集合，调用存储过程可以简化应用开发人员的很多工作，减少数据在数据库和应用服务器之间的传输，对于提高数据处理的效率是有好处的。<br> 存储过程思想上很简单，就是数据库SQL语言层面的代码封装与重用。</p> 
<p>存储过程的特点<br> 封装和复用<br> 可以接受参数，也可以返回数据<br> 减少网络交互，效率提升</p> 
<h3><a id="_781"></a>基本语法</h3> 
<p>创建</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> 存储过程名称<span class="token punctuation">(</span><span class="token punctuation">[</span>参数列表<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
	<span class="token comment">-- SQL语句</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre> 
<p>调用</p> 
<pre><code class="prism language-sql"><span class="token keyword">call</span> 名称<span class="token punctuation">(</span><span class="token punctuation">[</span>参数<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>小实操</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> p1<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
	<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> student<span class="token punctuation">;</span>
<span class="token keyword">end</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">call</span> p1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>查看</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>routines <span class="token keyword">where</span> routine_schema <span class="token operator">=</span> <span class="token string">'xxx'</span><span class="token punctuation">;</span><span class="token comment">--查询指定数据库的存储过程及状态信息</span>
<span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">procedure</span> 存储过程名称<span class="token punctuation">;</span><span class="token comment">-- 查询某个存储过程的定义</span>
</code></pre> 
<p>删除</p> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token punctuation">[</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> <span class="token punctuation">]</span> 存储过程名称<span class="token punctuation">;</span>
</code></pre> 
<p>小实操</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>routines <span class="token keyword">where</span> routine_schema <span class="token operator">=</span> <span class="token string">'itcast'</span><span class="token punctuation">;</span>
<span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> p1<span class="token punctuation">;</span>
</code></pre> 
<p>注意：在命令行中，执行创建存储过程的SQL时，需要通过关键字delimiter指定SQL语句的结束符。</p> 
<h3><a id="_823"></a>变量</h3> 
<h4><a id="_825"></a>系统变量</h4> 
<p>系统变量是MySQL服务器提供，不是用户定义的，属于服务器层面。分为全局变量（GLOBAL）、会话变量（SESSION）。</p> 
<p>查看系统变量</p> 
<pre><code class="prism language-sql"><span class="token keyword">show</span> <span class="token punctuation">[</span> <span class="token keyword">session</span> <span class="token operator">|</span> <span class="token keyword">global</span> <span class="token punctuation">]</span> variables<span class="token punctuation">;</span> <span class="token comment">-- 查看所有系统变量</span>
<span class="token keyword">show</span> <span class="token punctuation">[</span> <span class="token keyword">session</span> <span class="token operator">|</span> <span class="token keyword">global</span> <span class="token punctuation">]</span> variables <span class="token operator">like</span> <span class="token string">'...'</span><span class="token punctuation">;</span> <span class="token comment">-- 可以通过like模糊匹配查找变量</span>
<span class="token keyword">select</span> @@<span class="token punctuation">[</span><span class="token keyword">session</span><span class="token operator">|</span><span class="token keyword">global</span><span class="token punctuation">]</span> 系统变量名<span class="token punctuation">;</span> <span class="token comment">--查看指定变量的值</span>
</code></pre> 
<p>设置系统变量</p> 
<pre><code class="prism language-sql"><span class="token keyword">set</span> <span class="token punctuation">[</span> <span class="token keyword">session</span> <span class="token operator">|</span> <span class="token keyword">global</span> <span class="token punctuation">]</span> 系统变量名 <span class="token operator">=</span> 值<span class="token punctuation">;</span>
<span class="token keyword">set</span> @@<span class="token punctuation">[</span><span class="token keyword">session</span><span class="token operator">|</span><span class="token keyword">global</span><span class="token punctuation">]</span>系统变量名 <span class="token operator">=</span> 值<span class="token punctuation">;</span>
</code></pre> 
<p>小实操</p> 
<pre><code class="prism language-sql"><span class="token keyword">show</span> <span class="token keyword">session</span> variables<span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">session</span> variables <span class="token operator">like</span> <span class="token string">'auto%'</span>
<span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">'auto%'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> @<span class="token variable">@global.autocommit</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> @<span class="token variable">@session.autocommit</span><span class="token punctuation">;</span>
</code></pre> 
<p>注意：<br> 如果没有指定session/global，默认是session，会话变量。<br> mysql服务器重新启动之后，所设置的全局参数会失效，要想不失效，可以在/etc/my.cnf中配置。</p> 
<h4><a id="_853"></a>用户变量</h4> 
<p>用户定义变量是用户根据需要自己定义的变量，用户变量不用提前声明，在用的时候直接用‘@变量名’使用就可以。其作用域为当前连接（当前会话）。</p> 
<p>赋值</p> 
<pre><code class="prism language-sql"><span class="token keyword">set</span> <span class="token variable">@var_name</span> <span class="token operator">=</span> expr<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token variable">@var_name</span> <span class="token operator">=</span> expr<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token variable">@var_name</span> :<span class="token operator">=</span> expr <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token variable">@var_name</span> :<span class="token operator">=</span> expr<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token variable">@var_name</span> :<span class="token operator">=</span> expr <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token variable">@var_name</span> :<span class="token operator">=</span> expr<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> 字段名 <span class="token keyword">into</span> <span class="token variable">@vsr_name</span> <span class="token keyword">from</span> 表名<span class="token punctuation">;</span>
</code></pre> 
<p>使用</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token variable">@var_name</span><span class="token punctuation">;</span>
</code></pre> 
<p>小实操</p> 
<pre><code class="prism language-sql"><span class="token keyword">set</span> <span class="token variable">@myname</span> <span class="token operator">=</span> <span class="token string">'itcast'</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token variable">@myage</span> :<span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token variable">@mygender</span> :<span class="token operator">=</span> <span class="token string">'男'</span><span class="token punctuation">,</span><span class="token variable">@myhobby</span> :<span class="token operator">=</span> <span class="token string">'java'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token variable">@myname</span><span class="token punctuation">,</span><span class="token variable">@myage</span><span class="token punctuation">,</span><span class="token variable">@mygender</span><span class="token punctuation">,</span><span class="token variable">@myhobby</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e7/30/rjfRL0vS_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token variable">@mycolor</span> :<span class="token operator">=</span> <span class="token string">'red'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">into</span> <span class="token variable">@Mycount</span> <span class="token keyword">from</span> tb_user<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token variable">@mycolor</span><span class="token punctuation">,</span><span class="token variable">@mycount</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/eb/87/bv7JCplk_o.png" alt="在这里插入图片描述"><br> 注意：<br> 用户定义的变量无需对其进行声明或者初始化，只不过获取到的值为null。</p> 
<h4><a id="_887"></a>局部变量</h4> 
<p>局部变量是更具需要定义的在局部生效的变量，访问之前，需要DECLARE声明。可用作存储过程内的局部变量和输入参数，局部变量的范围是在其内声明的BEGIN…END块。</p> 
<p>声明</p> 
<pre><code class="prism language-sql"><span class="token keyword">declare</span> 变量名 变量类型 <span class="token punctuation">[</span><span class="token keyword">default</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>变量类型就是数据库字段类型：int、begint、char、varhcar、date、time等。</p> 
<p>赋值</p> 
<pre><code class="prism language-sql"><span class="token keyword">set</span> 变量名 <span class="token operator">=</span> 值<span class="token punctuation">;</span>
<span class="token keyword">set</span> 变量名 :<span class="token operator">=</span> 值<span class="token punctuation">;</span>
<span class="token keyword">select</span> 字段名 <span class="token keyword">into</span> 变量名 <span class="token keyword">from</span> 表名 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
</code></pre> 
<p>小实操</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> p2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
	<span class="token keyword">declare</span> stu_count <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">into</span> stu_count <span class="token keyword">from</span> student<span class="token punctuation">;</span>
	<span class="token keyword">select</span> stu_count<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e2/b7/RLU9mTmS_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="if_913"></a>if判断</h3> 
<p>语法</p> 
<pre><code class="prism language-sql"><span class="token keyword">if</span> 条件<span class="token number">1</span> <span class="token keyword">then</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">elseif</span> 条件<span class="token number">2</span> <span class="token keyword">then</span> 
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>	<span class="token comment">-- 可选</span>
<span class="token keyword">else</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>	<span class="token comment">-- 可选</span>
<span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
</code></pre> 
<p>小实操<br> 需求：<br> 根据<strong>定义</strong>的分数score变量，判断当前分数对应的分数等级。<br> 1、score &gt;= 85分，等级为优秀<br> 2、score &gt;= 60分 且 score &lt; 85 , 等级为及格。<br> 3、score &lt; 60分，等级为不及格。</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> p3<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
	<span class="token keyword">declare</span> score <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">58</span><span class="token punctuation">;</span>
	<span class="token keyword">declare</span> result <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> score <span class="token operator">&gt;=</span> <span class="token number">85</span> <span class="token keyword">then</span>
		<span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'优秀'</span><span class="token punctuation">;</span>
	<span class="token keyword">elseif</span> score <span class="token operator">&gt;=</span> <span class="token number">60</span> <span class="token keyword">then</span>
		<span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'及格'</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		 <span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'不及格'</span><span class="token punctuation">;</span>
	<span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
	<span class="token keyword">select</span> result<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_946"></a>参数</h3> 
<p>类型：含义：备注<br> in：该类参数作为输入，也就是需要调用时传入值：默认<br> out：该类参数作为参数，也就是该参数可以作为返回值<br> inout：既可以作为输入参数，也可以作为输出参数</p> 
<p>用法：</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> 存储过程名称<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">in</span><span class="token operator">/</span><span class="token keyword">out</span><span class="token operator">/</span><span class="token keyword">inout</span> 参数名 参数类型<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
	<span class="token comment">--SQL语句</span>
<span class="token keyword">end</span><span class="token punctuation">;</span> 
</code></pre> 
<p>小实操<br> 需求：<br> 1、根据<strong>传入</strong>的分数score变量，判断当前分数对应的分数等级，并<strong>返回</strong>。<br> 1、score &gt;= 85分，等级为优秀<br> 2、score &gt;= 60分 且 score &lt; 85 , 等级为及格。<br> 3、score &lt; 60分，等级为不及格。</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> p4<span class="token punctuation">(</span><span class="token operator">in</span> score <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">out</span> result <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
	<span class="token keyword">if</span> score <span class="token operator">&gt;=</span> <span class="token number">85</span> <span class="token keyword">then</span>
		<span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'优秀'</span><span class="token punctuation">;</span>
	<span class="token keyword">elseif</span> score <span class="token operator">&gt;=</span> <span class="token number">60</span> <span class="token keyword">then</span>
		<span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'及格'</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		 <span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'不及格'</span><span class="token punctuation">;</span>
	<span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token keyword">call</span> p4<span class="token punctuation">(</span><span class="token number">68</span><span class="token punctuation">,</span><span class="token variable">@result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2、将传入的200分值的分数，进行换算，换算成百分制，然后返回</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> p5<span class="token punctuation">(</span><span class="token keyword">inout</span> score <span class="token keyword">double</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
	<span class="token keyword">set</span> score :<span class="token operator">=</span> score<span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token variable">@score</span> <span class="token operator">=</span> <span class="token number">78</span><span class="token punctuation">;</span>
<span class="token keyword">call</span> p5<span class="token punctuation">(</span><span class="token variable">@score</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token variable">@score</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3b/62/RMGXgOIT_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="case_991"></a>case</h3> 
<p>语法</p> 
<pre><code class="prism language-sql"><span class="token keyword">case</span> case_value
	<span class="token keyword">when</span> when_value1 <span class="token keyword">then</span> statement_list1
	<span class="token punctuation">[</span> <span class="token keyword">when</span> when_value2 <span class="token keyword">then</span> statement_list2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">[</span> <span class="token keyword">else</span> statement_list <span class="token punctuation">]</span>
<span class="token keyword">end</span> <span class="token keyword">case</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">case</span> case_value
	<span class="token keyword">when</span> search_value1 <span class="token keyword">then</span> statement_list1
	<span class="token punctuation">[</span> <span class="token keyword">when</span> search_value2 <span class="token keyword">then</span> statement_list2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">[</span> <span class="token keyword">else</span> statement_list <span class="token punctuation">]</span>
<span class="token keyword">end</span> <span class="token keyword">case</span><span class="token punctuation">;</span>
</code></pre> 
<p>小实操<br> 需求:<br> 根据传入的月份,判定月份所属的季节(要求采用case结构)。<br> 1~3月份,为第一季度<br> 4~6月份,为第二季度。<br> 7~9月份,为第三季度。<br> 10~12月份,为第四季度</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> p6<span class="token punctuation">(</span><span class="token operator">in</span> <span class="token keyword">month</span> <span class="token keyword">int</span> <span class="token punctuation">)</span>
<span class="token keyword">begin</span>
	<span class="token keyword">declare</span> result <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

	<span class="token keyword">case</span> 
		<span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">and</span> <span class="token keyword">month</span> <span class="token operator">&lt;=</span> <span class="token number">3</span> <span class="token keyword">then</span>
			<span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'第一季度'</span><span class="token punctuation">;</span>
		<span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">&gt;=</span> <span class="token number">4</span> <span class="token operator">and</span> <span class="token keyword">month</span> <span class="token operator">&lt;=</span> <span class="token number">6</span> <span class="token keyword">then</span>
			<span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'第二季度'</span><span class="token punctuation">;</span>
		<span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">&gt;=</span> <span class="token number">7</span> <span class="token operator">and</span> <span class="token keyword">month</span> <span class="token operator">&lt;=</span> <span class="token number">9</span> <span class="token keyword">then</span>
			<span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'第三季度'</span><span class="token punctuation">;</span>
		<span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">&gt;=</span> <span class="token number">10</span> <span class="token operator">and</span> <span class="token keyword">month</span> <span class="token operator">&lt;=</span> <span class="token number">12</span> <span class="token keyword">then</span>
			<span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'第四季度'</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			<span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'非法参数'</span><span class="token punctuation">;</span>
	<span class="token keyword">end</span> <span class="token keyword">case</span><span class="token punctuation">;</span>
	<span class="token keyword">select</span> concat<span class="token punctuation">(</span><span class="token string">'您输入的月份为:'</span><span class="token punctuation">,</span><span class="token keyword">month</span><span class="token punctuation">,</span><span class="token string">',所属的季度为:'</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token keyword">call</span> p6<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_1038"></a>炫酷的循环</h3> 
<h4><a id="while_1039"></a>while</h4> 
<p>while循环是有条件的循环控制语句。满足条件后,再执行循环体中的SQL语句。具体语法为:</p> 
<pre><code class="prism language-sql"><span class="token comment"># 先判定条件,如果条件为true,则执行逻辑,否则,不执行逻辑</span>
<span class="token keyword">while</span> 条件 <span class="token keyword">do</span>
	<span class="token keyword">SQL</span>逻辑<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>
</code></pre> 
<p>小实操:<br> 需求:计算从1累加到n的值,n为传入的参数值</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> p7<span class="token punctuation">(</span><span class="token operator">in</span> n <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
	<span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> n<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">do</span>
		<span class="token keyword">set</span> total :<span class="token operator">=</span> total<span class="token operator">+</span>n<span class="token punctuation">;</span>
		<span class="token keyword">set</span> n :<span class="token operator">=</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>
	<span class="token keyword">select</span> total<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token keyword">call</span> p7<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/58/81/2K0r8yex_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="repeat_1064"></a>repeat</h4> 
<p>repeat是有条件的循环控制语句,当满足条件的时候退出循环。具体语法为:</p> 
<pre><code class="prism language-sql"><span class="token comment"># 先执行一次逻辑,然后判定逻辑是否满足,如果满足,则退出。如果不满足,则继续下一次循环</span>
<span class="token keyword">repeat</span>
	<span class="token keyword">SQL</span>逻辑
	until 条件
<span class="token keyword">end</span> <span class="token keyword">repeat</span><span class="token punctuation">;</span>
</code></pre> 
<p>小实操<br> 需求:计算从1累加到n的值,n为传入的参数值</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> p8<span class="token punctuation">(</span><span class="token operator">in</span> n <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
	<span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">repeat</span>
		<span class="token keyword">set</span> total :<span class="token operator">=</span> total<span class="token operator">+</span>n<span class="token punctuation">;</span>
		<span class="token keyword">set</span> n :<span class="token operator">=</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	until n <span class="token operator">&lt;=</span> <span class="token number">0</span>
	<span class="token keyword">end</span> <span class="token keyword">repeat</span><span class="token punctuation">;</span>
	<span class="token keyword">select</span> total<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

callp8<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9b/3b/mocb99fr_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="loop_1091"></a>loop</h4> 
<p>loop实现简单的循环,如果不在SQL逻辑中增加退出循环的条件,可以用其来实现简单的死循环。loop可以配合一下两个语句使用:<br> leave:配合循环使用,退出循环<br> iterate:必须用在循环中,作用是跳过当前循环剩下的语句,直接进入下一次循环。</p> 
<pre><code class="prism language-sql"><span class="token punctuation">[</span>begin_label:<span class="token punctuation">]</span> <span class="token keyword">loop</span>
	<span class="token keyword">SQL</span>逻辑<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">end</span> <span class="token keyword">loop</span> <span class="token punctuation">[</span>end_label<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">leave</span> label<span class="token punctuation">;</span> <span class="token comment">-- 退出指定标记的循环体</span>
<span class="token keyword">iterate</span> label<span class="token punctuation">;</span> <span class="token comment">-- 直接进入下一次循环</span>
</code></pre> 
<p>小实操<br> 1、计算从1累加到n的值,n为传入的参数值</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> p9<span class="token punctuation">(</span><span class="token operator">in</span> n <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
	<span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>
	sum:<span class="token keyword">loop</span>
		<span class="token keyword">if</span> n<span class="token operator">&lt;=</span><span class="token number">0</span> <span class="token keyword">then</span>
			<span class="token keyword">leave</span> sum<span class="token punctuation">;</span>
		<span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
		<span class="token keyword">set</span> total :<span class="token operator">=</span> total <span class="token operator">+</span> n<span class="token punctuation">;</span>
		<span class="token keyword">set</span> n :<span class="token operator">=</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">end</span> <span class="token keyword">loop</span> sum<span class="token punctuation">;</span>
	<span class="token keyword">select</span> total<span class="token punctuation">;</span>
<span class="token keyword">end</span>
<span class="token keyword">call</span> p9<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2、计算1从n之间的偶数累加的值,n为传入的参数值</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> p10<span class="token punctuation">(</span><span class="token operator">in</span> n <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
	<span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>
	sum:<span class="token keyword">loop</span>
		<span class="token keyword">if</span> n<span class="token operator">&lt;=</span><span class="token number">0</span> <span class="token keyword">then</span>
			<span class="token keyword">leave</span> sum<span class="token punctuation">;</span>
		<span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> n<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">then</span>
			<span class="token keyword">set</span> n :<span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token keyword">iterate</span> sum<span class="token punctuation">;</span>
		<span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
		<span class="token keyword">set</span> total :<span class="token operator">=</span> total <span class="token operator">+</span> n<span class="token punctuation">;</span>
		<span class="token keyword">set</span> n :<span class="token operator">=</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">end</span> <span class="token keyword">loop</span> sum<span class="token punctuation">;</span>
	<span class="token keyword">select</span> total<span class="token punctuation">;</span>
<span class="token keyword">end</span>
<span class="token keyword">call</span> p10<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/99/4c/p09laYjf_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_1143"></a>游标</h3> 
<p>游标是用来存储查询结果集的数据类型,在存储过程和函数中可以使用游标对结果集进行循环的处理。游标的使用包括游标的声明、open、fetch和close,其语法分别如下。</p> 
<pre><code class="prism language-sql"><span class="token comment"># 声明游标</span>
<span class="token keyword">DECLARE</span> 游标名称 <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> 查询语句<span class="token punctuation">;</span>
<span class="token comment"># 打开游标</span>
<span class="token keyword">OPEN</span> 游标名称<span class="token punctuation">;</span>
<span class="token comment"># 获取游标记录</span>
<span class="token keyword">FETCH</span> 游标名称 <span class="token keyword">INTO</span> 变量<span class="token punctuation">[</span><span class="token punctuation">,</span>变量 <span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>小实操<br> 需求:根据传入的参数uage,来查询用户表tb_user中,所有的用户年龄小于等于uage的用户姓名(name)和专业(profession),并将用户的姓名和专业插入到所创建的一张新表(id,name,profession)</p> 
<p>1、声明游标,存储查询结果集<br> 2、准备:创建表结构<br> 3、开启游标<br> 4、获取游标中的记录<br> 5、插入数据到信标中<br> 6、关闭游标</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> p11<span class="token punctuation">(</span><span class="token operator">in</span> uage <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
	<span class="token keyword">declare</span> uname <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">declare</span> upro <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">declare</span> u_cursor <span class="token keyword">cursor</span> <span class="token keyword">for</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>profession <span class="token keyword">from</span> tb_user <span class="token keyword">where</span> age <span class="token operator">&lt;=</span> uage<span class="token punctuation">;</span>
	<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> tb_user_pro<span class="token punctuation">(</span>
		id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
		name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		profession <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">open</span> u_cursor<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token boolean">true</span> <span class="token keyword">do</span>
		<span class="token keyword">fetch</span> u_cursor <span class="token keyword">into</span> uname<span class="token punctuation">,</span>upro<span class="token punctuation">;</span>
		<span class="token keyword">insert</span> <span class="token keyword">into</span> tb_user_pro <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span>uname<span class="token punctuation">,</span>upro<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>
	<span class="token keyword">close</span> u_cursor<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token keyword">call</span> p11<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_1186"></a>条件处理程序</h3> 
<p>条件处理程序可以用来定义在流程控制结构执行过程中遇到问题时相应的处理步骤。具体的语法为:</p> 
<pre><code class="prism language-sql"><span class="token keyword">declare</span> handler_action <span class="token keyword">handler</span> <span class="token keyword">for</span> cindition_value <span class="token punctuation">[</span><span class="token punctuation">,</span>condition_value<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> statement<span class="token punctuation">;</span>

handler_action
	<span class="token keyword">continue</span>:继续执行当前程序
	<span class="token keyword">exit</span>:终止执行当前程序
condition_value
	sqlstate sqlstate_value:状态码<span class="token punctuation">,</span>如<span class="token number">02000</span>
	sqlwarning:所有以<span class="token number">01</span>开头的sqlstate代码的简写
	<span class="token operator">not</span> found:所有以<span class="token number">02</span>开头的sqlstate代码的简写
	sqlexception:所有没有被sqlwarning或<span class="token operator">not</span> found捕获的sqlstate代码的简写
</code></pre> 
<p>改写</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> p11<span class="token punctuation">(</span><span class="token operator">in</span> uage <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
	<span class="token keyword">declare</span> uname <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">declare</span> upro <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">declare</span> u_cursor <span class="token keyword">cursor</span> <span class="token keyword">for</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>profession <span class="token keyword">from</span> tb_user <span class="token keyword">where</span> age <span class="token operator">&lt;=</span> uage<span class="token punctuation">;</span>
	<span class="token keyword">declare</span> <span class="token keyword">exit</span> <span class="token keyword">handler</span> <span class="token keyword">for</span> sqlstate <span class="token string">'02000'</span> <span class="token keyword">close</span> u_cursor<span class="token punctuation">;</span>
	<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> tb_user_pro<span class="token punctuation">(</span>
		id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
		name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		profession <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">open</span> u_cursor<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token boolean">true</span> <span class="token keyword">do</span>
		<span class="token keyword">fetch</span> u_cursor <span class="token keyword">into</span> uname<span class="token punctuation">,</span>upro<span class="token punctuation">;</span>
		<span class="token keyword">insert</span> <span class="token keyword">into</span> tb_user_pro <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span>uname<span class="token punctuation">,</span>upro<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>
	<span class="token keyword">close</span> u_cursor<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token keyword">call</span> p11<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c8/1f/NQ4lKpmT_o.png" alt="在这里插入图片描述"><br> mysql官方文档,可以查询状态码<br> https://dev.mysql.com/doc/mysql-errors/8.0/en/server-error-reference.html<br> <img src="https://images2.imgbox.com/b6/02/E8uQQ73V_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_1230"></a>存储函数</h2> 
<p>what is 存储函数<br> 存储函数是由返回值的存储过程,存储函数的参数只能是in类型的。具体语法如下</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">function</span> 存储函数名称<span class="token punctuation">(</span><span class="token punctuation">[</span>参数列表<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">returns</span> <span class="token keyword">type</span> <span class="token punctuation">[</span>characteristic <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token keyword">begin</span>
	<span class="token comment">-- SQL语句</span>
	<span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre> 
<p>characteristic说明<br> determinisitc:相同的输入参数总是产生相同的结果<br> no sql:不包含sql语句。<br> reads sql data:包含读取数据的语句,但不包含写入数据的语句。</p> 
<p>小实操<br> 需求:从1到n的累加</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">function</span> fun1<span class="token punctuation">(</span>n <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">returns</span> <span class="token keyword">int</span> <span class="token keyword">deterministic</span>
<span class="token keyword">begin</span>
	<span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> n<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">do</span>
		<span class="token keyword">set</span> total :<span class="token operator">=</span> total <span class="token operator">+</span> n<span class="token punctuation">;</span>
		<span class="token keyword">set</span> n :<span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> total<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> fun1<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/25/cf/SXfAREHt_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_1263"></a>触发器</h2> 
<h3><a id="_1264"></a>介绍</h3> 
<p>触发器是与表有关的数据库对象,指在inset/update/delete之前或之后,触发并执行触发器中定义的sql语句集合。触发器的这种特性可以协助应用在数据库端确保数据的完整性,日志记录,数据校验等操作。<br> 使用别名OLD和NEW来引用触发器中发生变化的记录内容,这与其他的数据库是相似的。现在触发器还只支持行级触发,不支持语句级触发。</p> 
<p>触发器类型:NEW和OLD<br> insert型触发器:new表示将要或者已经新增的数据<br> update型触发器:OLD表示修改之前的数据,NEW表示将要或已经修改后的数据<br> delete型触发器:OLD表示将要或者已经删除的数据</p> 
<h3><a id="_1273"></a>语法</h3> 
<p>创建</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">trigger</span> trigger_name
before<span class="token operator">/</span><span class="token keyword">after</span> <span class="token keyword">insert</span><span class="token operator">/</span><span class="token keyword">update</span><span class="token operator">/</span><span class="token keyword">delete</span>
<span class="token keyword">on</span> tbl_name <span class="token keyword">for each row</span> <span class="token comment">-- 行级触发器</span>
<span class="token keyword">begin</span>
	trigger_stmt<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre> 
<p>查看</p> 
<pre><code class="prism language-sql"><span class="token keyword">show</span> triggers<span class="token punctuation">;</span>
</code></pre> 
<p>删除</p> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">trigger</span> <span class="token punctuation">[</span>schema_name<span class="token punctuation">.</span><span class="token punctuation">]</span>trigger_name<span class="token punctuation">;</span><span class="token comment">-- 如果没有指定schema_name,默认为当前数据库。</span>
</code></pre> 
<p>小实操<br> 需求:通过触发器记录tb_user表的数据变更日志,将变更日志插入到日志表user_logs中,包含增加,修改,删除;</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> user_logs<span class="token punctuation">(</span>
	id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">.</span>
	operation <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'操作类型 , insert/update/delete'</span><span class="token punctuation">,</span>
	operate_time <span class="token keyword">datetime</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'操作时间'</span><span class="token punctuation">,</span>
	operate_id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'操作的ID'</span><span class="token punctuation">,</span>
	operate_params <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'操作参数'</span><span class="token punctuation">,</span>
	<span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span> <span class="token operator">=</span> <span class="token keyword">innodb</span> <span class="token keyword">default</span> <span class="token keyword">charset</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>

<span class="token comment">-- 插入数据触发器</span>
<span class="token keyword">create</span> <span class="token keyword">trigger</span> tb_user_insert_trigger
	<span class="token keyword">after</span> <span class="token keyword">insert</span> <span class="token keyword">on</span> tb_user <span class="token keyword">for each row</span>
<span class="token keyword">begin</span>
	<span class="token keyword">insert</span> <span class="token keyword">into</span> user_logs<span class="token punctuation">(</span>id<span class="token punctuation">,</span>operation<span class="token punctuation">,</span>operate_time<span class="token punctuation">,</span>operate_parans<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'insert'</span><span class="token punctuation">,</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token string">'插入的数据内容为:id='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">',name='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">',phone='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>phone<span class="token punctuation">,</span><span class="token string">',email='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>email<span class="token punctuation">,</span><span class="token string">',profession='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>profession<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token comment">-- 查看</span>
<span class="token keyword">show</span> triggers <span class="token punctuation">;</span>

<span class="token comment">-- 删除</span>
<span class="token keyword">drop</span> <span class="token keyword">trigger</span> tb_user_insert_trigger<span class="token punctuation">;</span>

<span class="token comment">-- 插入数据到tb_user</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tb_user<span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>phone<span class="token punctuation">,</span>profession<span class="token punctuation">,</span>age<span class="token punctuation">,</span>gender<span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">,</span>createtime<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token string">'二皇子'</span><span class="token punctuation">,</span><span class="token string">'18809091212'</span><span class="token punctuation">,</span><span class="token string">'erhuangzi@163.com'</span><span class="token punctuation">,</span><span class="token string">'软件工程'</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token comment">-- 更新数据触发器</span>
<span class="token keyword">create</span> <span class="token keyword">trigger</span> tb_user_update_trigger
	<span class="token keyword">after</span> <span class="token keyword">update</span> <span class="token keyword">on</span> tb_user <span class="token keyword">for each row</span>
<span class="token keyword">begin</span>
	<span class="token keyword">insert</span> <span class="token keyword">into</span> user_logs<span class="token punctuation">(</span>id<span class="token punctuation">,</span>operation<span class="token punctuation">,</span>operate_time<span class="token punctuation">,</span>operate_parans<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'update'</span><span class="token punctuation">,</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
	concat<span class="token punctuation">(</span><span class="token string">'更新之前的数据:id='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">',name='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">',phone='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>phone<span class="token punctuation">,</span><span class="token string">',email='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>email<span class="token punctuation">,</span><span class="token string">',profession='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>profession<span class="token punctuation">,</span>
			<span class="token string">'更新之后的数据:id='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">',name='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">',phone='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>phone<span class="token punctuation">,</span><span class="token string">',email='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>email<span class="token punctuation">,</span><span class="token string">',profession='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>profession<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token keyword">show</span> triggers<span class="token punctuation">;</span>
<span class="token keyword">update</span> tb_user <span class="token keyword">set</span> age <span class="token operator">=</span> <span class="token number">20</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/20/a6/sJ8LnHCQ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">-- 删除数据触发器</span>
<span class="token keyword">create</span> <span class="token keyword">trigger</span> tb_user_delete_trigger
	<span class="token keyword">after</span> <span class="token keyword">delete</span> <span class="token keyword">on</span> tb_user <span class="token keyword">for each row</span>
<span class="token keyword">begin</span>
	<span class="token keyword">insert</span> <span class="token keyword">into</span> user_logs<span class="token punctuation">(</span>id<span class="token punctuation">,</span>operation<span class="token punctuation">,</span>operate_time<span class="token punctuation">,</span>operate_parans<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'delete'</span><span class="token punctuation">,</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token string">'删除之前的数据为:id='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">',name='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">',phone='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>phone<span class="token punctuation">,</span><span class="token string">',email='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>email<span class="token punctuation">,</span><span class="token string">',profession='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>profession<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> triggers<span class="token punctuation">;</span>

<span class="token keyword">delete</span> <span class="token keyword">from</span> tb_user <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6e/58/A92I46Ah_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="about__1348"></a>about 视图、存储过程、触发器的小结</h2> 
<p>1、视图(VIEW)<br> 虚拟存在的表,不保存查询结果,只保存查询的SQL逻辑<br> 简单、安全、数据独立</p> 
<p>2、存储过程(PROCEDURE)<br> 事先定义并存储在数据库中的一段SQL语句的集合<br> 减少网络交互,提高性能、封装重用<br> 变量、if、case、参数(in/out/inout)、while、repeat、loop、cursor、handler</p> 
<p>3、存储函数(FUNCTION)<br> 存储函数是有返回值的存储过程,参数类型只能为IN类型<br> 存储函数可以被存储过程替代</p> 
<p>4、触发器(TRIGGER)<br> 可以在表数据进行insert、update、delete之前或之后触发<br> 保证数据完整性、日志记录、数据校验</p> 
<h2><a id="_1367"></a>锁</h2> 
<h3><a id="_1369"></a>介绍</h3> 
<p>锁是计算机协调多个进程或线程并发访问某一资源的机制。在数据库中,除了传统的计算资源(CPU、RAM、I/O)的争用以外,数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题,锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说,锁对数据库而言显得尤其重要,也更为复杂。</p> 
<p>在mysql中的锁,按照锁的粒度分,分为以下三类:<br> 1、全局锁:锁定数据库中的所有表。<br> 2、表级锁:每次操作锁住整张表。<br> 3、行级锁:每次操作锁住对应的行数据。</p> 
<h3><a id="_1377"></a>全局锁</h3> 
<h4><a id="_1378"></a>介绍</h4> 
<p>全局锁就是对整个数据库实例加锁,加锁后整个实例就处于只读状态,后续的DML的写语句,DDL语句,已经更新操作的事物提交语句都将被阻塞。<br> 其典型的使用场景是做全库的逻辑备份,对所有的表进行锁定,从而获取一致性视图,保证数据的完整性。<br> <img src="https://images2.imgbox.com/5e/f7/BCwYSNaS_o.png" alt="在这里插入图片描述"><br> 加了全局锁以后,在备份数据时,创建和修改操作处于阻塞状态,在完成备份之前只能进行读取操作<br> <img src="https://images2.imgbox.com/bd/45/9hnVdcrr_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ec/70/2ZIox1nk_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_1386"></a>特点</h4> 
<p>数据库中加全局锁,是一个比较重的操作,存在以下问题:<br> 1、如果在主库上备份,那么在备份期间都不能执行更新,业务基本上就得停摆。<br> 2、如果从库上备份,那么在备份期间从库不能执行主库同步过来的二进制日志,会导致主从延迟。</p> 
<p>在InnoDB引擎中,我们可以在备份时机上参数</p> 
<pre><code class="prism language-sql"><span class="token comment">--single-transaction -uroot -p123456 itcast &gt; itcast.sql</span>
</code></pre> 
<p>来完成不加锁的一致性数据备份</p> 
<h3><a id="_1397"></a>表级锁</h3> 
<p>表级锁,每次操作锁住整张表。锁定粒度大,发生锁冲突的概率最高,并发度最低。应用在MyISAM、InnoDB、BDB等存储引擎中。</p> 
<p>对于表级锁,主要分为以下三类<br> 1、表锁<br> 2、元数据锁(meta data lock , MDL)<br> 3、意向锁</p> 
<h4><a id="_1406"></a>表锁</h4> 
<p>对于表锁,分为两类<br> 1、表共享读锁(read lock)<br> 2、表独占写锁(write lock)</p> 
<p>语法:<br> 1、加索:lock tables 表名… read/write<br> 2、释放锁:unlock tables / 客户端断开连接</p> 
<p>加了读锁<br> 都能读到,但是不能写<br> <img src="https://images2.imgbox.com/9d/55/FhGlckVT_o.png" alt="在这里插入图片描述"></p> 
<p>加了写锁,自己加的只有自己能读写,在没有解锁之前别人读写不了<br> <img src="https://images2.imgbox.com/03/d0/PXogM0BN_o.png" alt="在这里插入图片描述"><br> 读锁不会阻塞其他客户端的读,但是会阻塞写。写锁机会阻塞其他客户端的读,又会阻塞其他客户端的写。</p> 
<h4><a id="_1423"></a>元数据锁</h4> 
<p>MDL加锁过程是系统自动控制,无需显示使用,在访问一张表的时候会自动加上。MDL锁主要作用是维护表元数据的数据一致性,在表上有活动事务的时候,不可以对元数据进行写入操作。<strong>为了避免DML和DDL冲突,保证读写的正确性</strong></p> 
<p>在MySQL5.5中引入了MDL，当对一张表进行增删改查的时候，加DML读锁（共享）；当对表结构进行变更操作的时候，加DML写锁（排他）。</p> 
<p>对应SQL：锁类型：说明<br> lock tables xxx read/write：shared_read_only / shared_no_read_write<br> select 、 select … lock in share mode ：shared_read :与shared_read、shared_write兼容、与exclusive互斥<br> insert 、 update 、 delete 、 select … for update ：shared_write：与shared_read、shared_write兼容、与exclusive互斥<br> alter table …:exclusive:与其他的MDL都互斥</p> 
<p><img src="https://images2.imgbox.com/ec/64/PitUMZ8K_o.png" alt="在这里插入图片描述"><br> 左侧select自动上锁，右边的alter排他锁就只能阻塞。当左侧commit提交以后，右边才能执行</p> 
<p>查看元数据锁</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> object_type<span class="token punctuation">,</span>object_schema<span class="token punctuation">,</span>object_name<span class="token punctuation">,</span>lock_type<span class="token punctuation">,</span>lock_duration <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>metadata_locks <span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_1441"></a>意向锁</h4> 
<p>为了避免DML在执行时，加的行锁与表锁的冲突，在InnoDB中引入了意向锁，使得表锁不用检查每行数据是否加锁，使用意向锁来减少表锁的检查</p> 
<p>意向锁的分类<br> 1、意向共享锁（IS）：由语句select…lock in share mode 添加<br> 2、意向排他锁（IX）：由insert、update、delete、select … for update添加</p> 
<p>可以通过以下SQL，查看意向锁及行锁的加锁情况：</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> object_schema<span class="token punctuation">,</span>object_name<span class="token punctuation">,</span>index_name<span class="token punctuation">,</span>lock_type<span class="token punctuation">,</span>lock_mode<span class="token punctuation">,</span>lock_data <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>data_locks<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8c/c1/aIAk3hq3_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/48/54/KncmUXN8_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_1456"></a>行级锁</h3> 
<h4><a id="_1457"></a>介绍</h4> 
<p>行级锁，每次操作锁住对应的行数据。锁定粒度最小，发生所冲突的概率最低，并发度最高。应用在InnoDB存储引擎中</p> 
<p>InnoDB的数据是基于索引组织的，行锁是通过对索引项加锁来实现的，而不是对记录加的锁。对于行级锁，主要分为以下三类：<br> 1、行锁（Record Lock）：锁定单个行记录的锁，防止其他事务对此进行update和delete。在RC、RR隔离级别下都支持。<br> 2、间隙锁（Gap Lock）：锁定索引记录间隙（不包含该记录），确保索引记录间隙不，防止其他事务在这个间隙进行insert，产生幻读。在RR隔离级别下都支持<br> 3、临建锁（Next-Key Lock）：行锁和间隙锁组合，同时锁住数据，并锁住数据前面的间隙Gap。在RR隔离级别下支持。</p> 
<h4><a id="_1465"></a>行锁</h4> 
<p>InnoDB实现了以下两种类型的行锁<br> 1、共享锁（S）：允许一个事务去读一行，组织其他事务获得相同数据集的排他锁。<br> 2、排他锁（X）：允许获取排他锁的事务更新数据，组织其他事务活得相同数据集的共享锁和排他锁。</p> 
<p><img src="https://images2.imgbox.com/54/cd/bfE2Vlzi_o.png" alt="在这里插入图片描述"></p> 
<p>insert：排他锁：自动加锁<br> update：排他锁：自动加锁<br> delete：排他锁：自动加锁<br> select：不加任何锁<br> select … lock in share mode ：共享锁：需要手动在select之后加lock in share mode<br> select … for update ：排他锁：需要手动在select之后加for update</p> 
<p>默认情况下，InnoDB在repeatable read事务隔离级别运行，InnoDB使用next-key 锁进行搜索和索引扫描，以防止幻读。<br> 1、针对唯一索引进行索引时，对已存在的记录进行等值匹配时，将会自动优化为行锁<br> 2、InnoDB的行锁是针对于索引加的锁，不通过索引条件检索数据，那么InnoDB将对表中的所有记录加锁，此时就会升级为表锁。</p> 
<p>可以通过以下SQL，查看意向锁及行锁的加锁情况：</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> object_schema<span class="token punctuation">,</span>object_name<span class="token punctuation">,</span>index_name<span class="token punctuation">,</span>lock_type<span class="token punctuation">,</span>lock_mode<span class="token punctuation">,</span>lock_data <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>data_locks<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_1489"></a>间隙锁/临建锁</h4> 
<p>默认情况下，InnoDB在repeatable read事务隔离级别运行，InnoDB使用next-key锁进行搜索和索引扫描，以防止幻读。<br> 1、索引上的等值查询（唯一索引），给不存在的记录加锁时，优化为间隙锁。<br> 2、索引上的等值查询（普通索引），向右遍历时最后一个值不满足查询需求时，next-key lock 退化为间隙锁。<br> 3、索引上的范围查询（唯一索引），会访问到不满足条件的第一个值为止。</p> 
<p>注意：间隙锁唯一目的是防止其他事务插入间隙。间隙锁可以共存，一个事务采用的间隙锁不会阻止另一个事务在同一个事务上采用间隙间隙锁。</p> 
<h3><a id="_1497"></a>小结</h3> 
<p>1、概述<br> 在并发访问时，解决数据访问的一致性、有效性问题<br> 全局锁、表级锁、行级锁</p> 
<p>2、全局锁<br> 对整个数据库实例加锁，加锁后整个实例就处于只读状态<br> 性能较差，数据逻辑备份时使用</p> 
<p>3、表级锁<br> 操作锁住整张表，锁定粒度大，发生锁重复的概率高<br> 表锁、元数据锁、意向锁</p> 
<p>4、行级锁<br> 操作锁住对应的行数据，锁定粒度最小，发生锁冲突的概率最低<br> 行锁、间隙锁、临建锁</p> 
<h2><a id="InnoDB_1514"></a>InnoDB引擎</h2> 
<h3><a id="_1515"></a>逻辑存储结构</h3> 
<p><img src="https://images2.imgbox.com/5a/de/IEK8ux5g_o.png" alt="在这里插入图片描述"><br> 表空间（idb文件），一个mysql实例可以对应多个表空间，用于存储记录、索引等数据。</p> 
<p>段，分为数据段（Leaf node segment）、索引段（Non-leaf node segment）、回滚段（Rollback segment），InnoDB时索引组织表，数据段就是B+数的叶子节点，索引段即为B+数的非叶子节点。段用来管理多个Extent（区）。</p> 
<p>区，表空间的单元结构，每个区的大小为1M。默认情况下，InnoDB存储引擎大小为16K，即一个区中一共有64个连续的页。</p> 
<p>页，是InnoDB存储引擎磁盘管理的最小单元，每个页的大小默认为16KB。为了保证页的连续性，InnoDB存储引擎每次从磁盘申请4~5个区。</p> 
<p>行，InnoDB存储引擎数据是按行进行存放的。</p> 
<p>Trx_id：每次对某条记录进行改动时，都会把对应的事务id赋为trx_id隐藏列。</p> 
<p>Roll_pointer：每次对某条引记录进行改动时，都会把旧的版本写入到undo日志中，然后这个隐藏列就相当于一个指针，可以通过它来找到记录修改前的信息。</p> 
<h3><a id="_1531"></a>架构</h3> 
<p>MySQL5.5版本开始，默认使用InnoDB存储引擎，它擅长事务处理，具有崩溃恢复特性，在日常开发中使用非常广泛。下面是InnoDB架构图，左侧为内存结构，右侧为磁盘结构。<br> <img src="https://images2.imgbox.com/19/26/QsIl5riK_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_1535"></a>内存架构</h4> 
<p>Buffer Pool：缓冲区是主内存中的一个区域，里面可以缓存磁盘上经常操作的真实数据，在执行增删改查操作时，先操作缓冲区中的数据（若缓冲池没有数据，则从磁盘加载并缓存），然后再以一定频率刷新到磁盘，从而减少磁盘IO，加快处理速度。</p> 
<p>缓冲区以Page页为单位，底层采用链表数据结构管理Page。根据状态，将Page分为三种类型：<br> free page：空闲page，未被使用。<br> clean page：被使用page，数据没有被修改过。<br> dirty page：脏页，被使用page，数据被修改过，也中数据与磁盘的数据产生了不一致。</p> 
<p>Change Buffer：更改缓冲区（针对于非唯一二级索引页），在执行DML语句时，如果这些数据Page没有在Buffer Pool中，不会直接操作磁盘，而将数据变更存在更改缓冲区Change Buffer中，在未来数据被读取时，再将数据合并恢复到Buffer Pool中，再将合并后的数据刷新到磁盘中。</p> 
<p>Change Buffer的意义是什么？<br> 与聚集索引不同，二级索引通常是非唯一的，并且以相对随机的顺序插入二级索引。同样，删除和更新可能会影响索引树种不相邻的二级索引页，如果每一次都操作磁盘，会造成大量的磁盘IO。有了ChangeBuffer之后，我们可以在缓冲池中进行合并处理，减少磁盘IO</p> 
<p>Adaptive Hash Index：自适应hash索引，用于优化对Buffer Pool数据的查询。InnoDB存储引擎会监控对表上各索引页的查询，如果观察到hash索引可以提升速度，则建立hash索引，称之为自适应hash索引。<br> 自适应哈希索引，无需人工干预，是系统根据情况自动完成。<br> 参数：adaptive_hash_index</p> 
<p>Log Buffer：日志缓冲区，用来保存要写入到磁盘中的log日志数据（redo log、undo log），默认大小为16MB，日志缓冲区的日志会定期刷新到磁盘中。如果需要更新、插入或删除许多行的事务，增加日志缓冲区的大小可以节省磁盘I/O。<br> 参数：<br> innodb_log_buffer_size:缓冲区大小<br> innodb_flush_log_at_trx_commit:日志刷新到磁盘时机</p> 
<p>about 磁盘时机<br> 1：日志在每次事务提交时写入并刷新到磁盘<br> 0：每秒将日志写入并刷新到磁盘一次<br> 2：日志在每次事务提交后写入，并每秒刷新到磁盘一次。</p> 
<h4><a id="_1564"></a>磁盘架构</h4> 
<p><img src="https://images2.imgbox.com/e2/c6/odZSXyJz_o.png" alt="在这里插入图片描述"></p> 
<p>System Tablespace:系统表空间是更改缓冲区的存储区域。如果表实在系统表空间而不是每个表文件或通用表空间中创建的,它也可能包含表和索引数据。(在MySQL5.x版本中还包含InnoDB数据字典、undolog等)<br> 参数:innodb_data_file_path</p> 
<p>File-Per-Table Tablespaces:每个表的文件表空间包含单个InnoDB表的数据和索引,并存储在文件系统上的单个数据文件中。<br> 参数:innodb_file_per_table</p> 
<p>General Tablespaces:通用表空间,需要通过create tablespace语法创建通用表空间,在创建表时,可以指定该表空间</p> 
<pre><code class="prism language-sql"><span class="token comment"># 创建General Tablespaces语法</span>
<span class="token keyword">create</span> <span class="token keyword">tablespace</span> xxx <span class="token keyword">add</span>
datafile <span class="token string">'file_name'</span>
<span class="token keyword">engine</span> <span class="token operator">=</span> engine_name<span class="token punctuation">;</span>
</code></pre> 
<p>Undo Tablespaces:撤销表空间,MySQL实例在初始化时会创建两个默认的undo空间(初始大小16M),用于存储undo log日志。</p> 
<p>Temporary Tablespaces:InnoDB使用会话临时表空间和全局临时表空间。存储用户创建的临时表等数据。</p> 
<p>Doublewrite Buffer Files:双写缓冲区,innodb引擎将数据页从Buffer Pool刷新到磁盘前,先将数据页写入双写缓冲区文件中,便于系统异常时恢复数据。</p> 
<p>Redo Log:重做日志,是用来实现事务的持久性。该日志文件由两部分组成:重做日志缓冲(redo log buffer)以及重做日志文件(redo log),前者是在内存中,后者在磁盘中。当事务提交之后会把所有修改信息都会存到该日志中,用于刷新脏页到磁盘中,发生错误时,进行数据恢复使用。</p> 
<h4><a id="_1589"></a>后台线程</h4> 
<p><img src="https://images2.imgbox.com/03/07/tCRghOLE_o.png" alt="在这里插入图片描述"><br> 1、Master Thread<br> 核心后台线程,负责调度其他线程,还负责将缓冲区中的数据异步刷新到磁盘中,保持数据的一致性,还包括脏页的刷新、合并插入缓存、undo页的回收。</p> 
<p>2、IO Thread<br> 在InnoDB存储引擎中大量使用了AIO来处理IO请求,这样可以极大地提高数据库地性能,而IO Thread主要负责这些IO请求的回调。</p> 
<p>线程类型:默认个数:职责<br> Read thread:4:负责读操作<br> Write Thread:4:负责写操作<br> Log thread:1:负责将日志缓冲区刷新到磁盘<br> Insert buffer thread:1:负责将写的缓冲区内容刷新到磁盘</p> 
<p><img src="https://images2.imgbox.com/ce/20/v0VqiaH6_o.png" alt="在这里插入图片描述"><br> 3、Purge Thread<br> 主要用于回收事物已经提交了的undo log,在提交事物之后,undo log可能不用了,就用它来回收。</p> 
<p>4、Page Cleaner Thread<br> 协助Master Thread 刷新脏页到磁盘地线程,它可与i减轻Master Thread的工作压力,减少阻塞</p> 
<h3><a id="_1609"></a>事务原理</h3> 
<h4><a id="_1610"></a>概述</h4> 
<p>事务是一组操作的集合,它是一个不可分割的工作单位,事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求,即这些操作要么同时成功,要么同时失败。</p> 
<p>特性:<br> 原子性:事务是不可分割的最小操作单元,要么全部成功,要么全部失败<br> 一致性:事务完成时,必须使所有的数据都保持一致状态。<br> 隔离性:数据库系统提供的隔离机制,保证事务在不受外部并发操作影响的独立环境下运行。<br> 持久性:事务一旦提交或回滚,他对数据库中的数据的改变就是永久的<br> <img src="https://images2.imgbox.com/5a/70/FH2fbUmu_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="redo_log_1619"></a>redo log</h4> 
<p>重做日志,记录的是事务提交时数据页的物理修改,是用来实现事务的持久性。<br> 该日志文件由两部分组成:重做日志缓冲(redo log buffer)以及重做日志文件(redo log file),前者是在内存中,后者在磁盘中。当事务提交之后会把所有修改信息都存到哦该日志文件中,用于刷新脏页到磁盘,发生错误时,进行数据恢复使用。</p> 
<p><img src="https://images2.imgbox.com/54/be/0uho2H7M_o.png" alt="在这里插入图片描述"><br> redolog buffer会将修改的数据备份记录到磁盘结构,如果提交时出现错误,就会自动修复。<br> 直接将缓冲区中的数据修改到磁盘结构会有很大的性能问题,会造成大量的随机磁盘IO</p> 
<h4><a id="undo_log_1627"></a>undo log</h4> 
<p>回滚日志,用于记录数据被修改前的信息,作用包含两个:提供回滚和MVCC(多版本并发控制)。<br> undo log和redo log记录物理日志不一样,它是逻辑日志。可以认为当delete一条记录时,undo log中会记录一条对应的insert记录,反之亦然,当update一条记录时,它记录一条对应相反的update记录。当执行rollback时,就可以从undo log中的逻辑记录读取到相应的内容并进行回滚。<br> Undo log销毁:undo log在事务提交执行时,事务提交时,并不会立即删除undo log,因为这些日志可能还用于MVCC。<br> Undo log存储:undo log采用段的方式进行管理和记录,存放在前面介绍的rollback segment回滚段中,内部包含1024个undo logsegment。</p> 
<h3><a id="MVCC_1633"></a>MVCC</h3> 
<h4><a id="_1634"></a>基本概念</h4> 
<p>当前读</p> 
<blockquote> 
 <p>读取的是记录的最新版本，读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。对于我们日常的操作，如：<code>select ... in share mode </code>(共享锁)，<code>select ... for update </code>、update、insert、delete（排他锁）都是一种当前读。</p> 
</blockquote> 
<p>快照读</p> 
<blockquote> 
 <p>简单的select（不加锁）就是快照读，读取的是记录数据的可见版本，有可能是历史数据，不加锁，是非阻塞读。<br> Read Committed :每次select，都生成一个快照读。<br> Reapeatable Read：开启事务后第一个select语句次啊是快照读的地方。<br> Serializable：快照读会退化为当前读。</p> 
</blockquote> 
<p>MVCC</p> 
<blockquote> 
 <p>全称Multi-Version Concurrency Control，多版本并发控制。指维护一个数据的多个版本，使得读写操作没有冲突，快照读为MySQL实现MVCC提供了一个非阻塞读功能。MVCC的具体实现，还需要依赖于数据库记录中的三个隐式字段、undo log日志、readView。</p> 
</blockquote> 
<h3><a id="_1647"></a>实现原理</h3> 
<p>记录中的隐藏字段<br> <img src="https://images2.imgbox.com/3b/bf/tDZf1Yb4_o.png" alt="在这里插入图片描述"><br> DB_TRX_ID：最近修改事务的ID，记录插入这条记录或最后一次修改该记录的事务ID。<br> DB_ROLL_PTR：回滚指针，指向这条记录的上一个版本，用于配合undo log，指向上一个版本。<br> DB_ROW_ID（不是都会有的，没有主键的时候才会有）：隐藏主键，如果表结构没有指定主键，将会生成该隐藏字段。</p> 
<h4><a id="undolog_1653"></a>undolog版本链</h4> 
<p>undo log：</p> 
<blockquote> 
 <p>回滚日志，在insert、update、delete的时候产生的便于数据回滚的日志。<br> 当insert的时候，产生的undo log日志只有回滚时需要，在事务提交后，可被立即删除。<br> 而update、delete的时候，产生的undo log日志不仅在回滚时需要，在快照读也需要，不会立即被删除。</p> 
</blockquote> 
<p>undo log版本链<br> <img src="https://images2.imgbox.com/94/fa/9JN22D46_o.png" alt="在这里插入图片描述"><br> 不同事物或相同事务对同一条记录进行修改，会导致该记录的undolog生成一条记录版本链表，链表的头部是最新的旧记录，链表尾部是最早的旧记录。</p> 
<h3><a id="readview_1663"></a>readview</h3> 
<p>ReadView（读视图）是快照读SQL执行时MVCC提取数据的依据，记录并维护系统当前活跃的事务（未提交的）id。<br> ReadView中包含了四个核心字段：<br> m_ids：当前活跃的事务ID集合<br> min_trx_id：最小活跃事务ID<br> max_trx_id：预分配事务ID，当前最大事务ID+1（因为事务ID是自增的）<br> creator_trx_id：ReadView创建者的事务ID<br> <img src="https://images2.imgbox.com/a3/9d/SRFLZEbG_o.png" alt="在这里插入图片描述"><br> 不同的隔离级别，生成ReadView的时机不同：<br> READ COMMITTED：在事务中每一次执行快照读时生成ReadView<br> REPEATABLE READ：仅在事务中第一次执行快照读时生成ReadView，后续复用该ReadView。</p> 
<p>RC隔离级别下，在事务中每一次执行快照读时生成ReadView<br> RR隔离级别下，仅在事务中第一次执行快照读时生成ReadView，后续复用该ReadView。</p> 
<h4><a id="_1678"></a>小总结</h4> 
<p>1、逻辑存储结构<br> 表空间、段、区、页、行</p> 
<p>2、架构<br> 内存结构<br> 磁盘结构</p> 
<p>3、事务原理<br> 原子性 - undo log<br> 持久性 - redo log<br> 一致性 - Indo log + redo log<br> 隔离锁 - 锁 +MVCC</p> 
<p>4、MVCC<br> 记录隐藏字段、undo log版本链、readView</p> 
<h2><a id="MySQL_1695"></a>MySQL管理</h2> 
<h3><a id="_1696"></a>系统数据库</h3> 
<p>MySQL数据库安装完成之后，自带了四个数据库<br> mysql：存储MySQL服务器正常运行所需要的各种信息（时区、主从、用户、权限等）<br> information_schema：提供了访问数据库元数据的各种表和视图，包含数据库、表、字段类型及访问权限等<br> performance_schema：为MySQL服务器运行时状态提供了一个底层监控功能，主要用于收集数据库服务器性能参数<br> sys：包含了一系列方便DBA和开发人员利用performance_schema性能数据库进行性能调优和诊断的视图</p> 
<h3><a id="_1703"></a>常用工具</h3> 
<h4><a id="mysql_1704"></a>mysql</h4> 
<p>该mysql不是指mysql服务，而是指mysql的客户端工具</p> 
<p>语法</p> 
<pre><code class="prism language-sql">mysql <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">database</span><span class="token punctuation">]</span>
</code></pre> 
<p>选项</p> 
<pre><code class="prism language-sql"><span class="token operator">-</span>u<span class="token punctuation">,</span><span class="token comment">--user=name                 #指定用户名</span>
<span class="token operator">-</span>p<span class="token punctuation">,</span><span class="token comment">--password[=name]           #指定密码</span>
<span class="token operator">-</span>h<span class="token punctuation">.</span><span class="token comment">--host=name                 #指定服务器ip或域名</span>
<span class="token operator">-</span>p<span class="token punctuation">,</span><span class="token comment">--port=port                 #指定连接端口</span>
<span class="token operator">-</span>e<span class="token punctuation">,</span><span class="token comment">--execute=name              #执行SQL语句并退出</span>
</code></pre> 
<p>-e选项可以在MySQL客户端执行SQL语句，而不用连接到MySQL数据库再执行，对于一些批处理脚本，这种方式尤其方便</p> 
<pre><code class="prism language-sql"><span class="token comment">#such as</span>
mysql <span class="token operator">-</span>uroot <span class="token operator">-</span>p123456 db01 <span class="token operator">-</span>e <span class="token string">"select * from stu"</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="mysqladmin_1725"></a>mysqladmin</h4> 
<p>mysqladmin是一个执行管理操作的客户端程序。可以用它来检测服务器的配置和当前状态、创建并删除数据库等。</p> 
<p>通过帮助文档查看选项</p> 
<pre><code class="prism language-sql">mysqladmin <span class="token comment">--help</span>
</code></pre> 
<h4><a id="mysqlbinlog_1732"></a>mysqlbinlog</h4> 
<p>由于服务器生成的二进制日志文件以二进制格式保存，所以如果想要检查这些文本的文本格式，就会使用到mysqlbinlog日志管理工具。</p> 
<p>语法</p> 
<pre><code class="prism language-sql">mysqlbinlog <span class="token punctuation">[</span>options<span class="token punctuation">]</span> log<span class="token operator">-</span>files1 log<span class="token operator">-</span>files2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>选项</p> 
<pre><code class="prism language-sql"><span class="token operator">-</span>d<span class="token punctuation">.</span><span class="token comment">--database=name                                   #指定数据库名称，只列出指定的数据库相关操作。</span>
<span class="token operator">-</span>o<span class="token punctuation">,</span><span class="token comment">--offset=#                                        #忽略掉日志中的前n行命令</span>
<span class="token operator">-</span>r<span class="token punctuation">,</span><span class="token comment">--result-file=name                                #将输出的文本格式日志输出到指定文件</span>
<span class="token operator">-</span>s<span class="token punctuation">,</span><span class="token comment">--short-from                                      #显示简单格式，忽略掉一些信息</span>
<span class="token comment">--start-datatime=date1 --stop-datetime=date2         #指定日期间隔内的所有日志</span>
<span class="token comment">--start-position=post1 --stop-position=post2         #指定位置间隔内的所有日志</span>
</code></pre> 
<h4><a id="mysqlshow_1749"></a>mysqlshow</h4> 
<p>mysqlshow客户端对象查找工具，用来很快的查找存在哪些数据库、数据库中的表、表中的列或者索引</p> 
<p>语法</p> 
<pre><code class="prism language-sql">mysqlshow <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>db_name <span class="token punctuation">[</span>table_name<span class="token punctuation">[</span>col_name<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<p>选项</p> 
<pre><code class="prism language-sql"><span class="token comment">--count        #显示数据库及表的统计信息（数据库，表均可以不指定）</span>
<span class="token operator">-</span>i             <span class="token comment">#显式指定数据库或者指定表的状态信息</span>
</code></pre> 
<p>示例</p> 
<pre><code class="prism language-sql"><span class="token comment">#查询每个数据库的表的数量及表中记录的数量</span>
mysqlshow <span class="token operator">-</span>uroot <span class="token operator">-</span>p2143 <span class="token comment">--count</span>

<span class="token comment">#查询set库中的每个表的字段书，及行数</span>
mysqlshow <span class="token operator">-</span>uroot <span class="token operator">-</span>p2143 test <span class="token comment">--count</span>

<span class="token comment">#查询est库中book表的详细情况</span>
mysqlshow <span class="token operator">-</span>uroot <span class="token operator">-</span>p2143 test book <span class="token comment">--count</span>
</code></pre> 
<h4><a id="mysqldump_1775"></a>mysqldump</h4> 
<p>mysqldump客户端工具用来本分数据库或在不同数据库之间进行数据迁移。备份内容包含创建表，及插入表的SQL语句。</p> 
<p>语法</p> 
<pre><code class="prism language-sql">mysqldump <span class="token punctuation">[</span>options<span class="token punctuation">]</span> db_name<span class="token punctuation">[</span><span class="token keyword">tables</span><span class="token punctuation">]</span>
mysqldump <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token comment">--database/-B db1 [db2 db3...]</span>
mysqldump <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token comment">--all-databases/-A</span>
</code></pre> 
<p>连接选项：</p> 
<pre><code class="prism language-sql"><span class="token operator">-</span>u<span class="token punctuation">,</span><span class="token comment">--user=name                       #指定用户名</span>
<span class="token operator">-</span>p<span class="token punctuation">,</span><span class="token comment">--password[=name]                 #指定密码</span>
<span class="token operator">-</span>h<span class="token punctuation">,</span><span class="token comment">--host=name                       #指定服务器ip或域名</span>
<span class="token operator">-</span>p<span class="token punctuation">,</span><span class="token comment">--port=#                          #指定连接端口</span>
</code></pre> 
<p>输出选项</p> 
<pre><code class="prism language-sql"><span class="token comment">--add-drop-database      #在每个数据库创建语句前加上drop database语句</span>
<span class="token comment">--add-drop-table         #在每个表创建语句前加上drop table语句，默认开启；不开启（--skip-add-drop-table）</span>
<span class="token operator">-</span>n<span class="token punctuation">,</span><span class="token comment">--no-create-db        #不包含数据库的创建语句</span>
<span class="token operator">-</span>t<span class="token punctuation">,</span><span class="token comment">--no-create-info      #不包含数据表的创建语句</span>
<span class="token operator">-</span>d <span class="token comment">--no-data             #不包含数据</span>
<span class="token operator">-</span>T<span class="token punctuation">,</span><span class="token comment">--tab=name            #自动生成两个文件，一个.sql文件，创建表结构的语句；一个.txt文件，数据文件</span>
</code></pre> 
<h4><a id="mysqlimportsource_1803"></a>mysqlimport/source</h4> 
<p>mysqlimport是客户端数据导入工具，用来导入MySQLdump加-T参数后导出的文本文件。</p> 
<p>语法</p> 
<pre><code class="prism language-sql">mysqlimport <span class="token punctuation">[</span>options<span class="token punctuation">]</span> db_name textfile1 <span class="token punctuation">[</span>textfile2<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</code></pre> 
<p>如果需要导入sql文件，可以使用mysql中的source指令：<br> 语法：</p> 
<pre><code class="prism language-sql">source<span class="token operator">/</span>root<span class="token punctuation">.</span>xxxxx<span class="token punctuation">.</span><span class="token keyword">sql</span>
</code></pre> 
<h4><a id="_1817"></a>小总结</h4> 
<p>1、mysql<br> Mysql客户端工具，-e执行SQL并推出</p> 
<p>2、mysqladmin<br> Mysql管理工具</p> 
<p>3、mysqlbinlog<br> 二进制日志查看工具</p> 
<p>4、mysqlshow<br> 查看数据库、表、字段的统计信息</p> 
<p>5、mysqldump<br> 数据备份工具</p> 
<p>6、mysqlimpotr/source<br> 数据导入工具</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/65693436c38a1a86e155a994823895e0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python 使用streamlit实现的京东爬虫分析系统</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e345ad0a6c723a7e6ab60bc322c2e59f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java 接口</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>