<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s云原生环境搭建笔记 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s云原生环境搭建笔记" />
<meta property="og:description" content="目录 一、使用kubeadmin方式安装k8s1、准备虚拟机2、安装前置环境（注意：所有虚拟机都执行）2.1、基础环境2.2、docker环境（在所有虚拟机上都执行下列指令即可）2.3、安装k8s核心组件（在所有虚拟机上都执行相同指令即可）2.4、导入k8s所需镜像2.5、导入calico镜像 3、初始化master节点（注意：只能在master节点虚拟机上执行）3.1、确定master节点ip3.2、找到合适的service地址区间、pod地址区间3.3、执行kubeadm init操作3.4、根据初始化结果来执行操作3.4.1、复制相关文件夹3.4.2、导出环境变量3.4.3、导入calico.yaml3.4.4、修改calico.yaml（注意：必须修改）3.4.5、执行calico.yaml 4、初始化worker节点（注意：只能在所有worker节点虚拟机上执行）5、设置ipvs模式（推荐执行，但是不执行也没影响；注意：只能在master节点虚拟机上执行）5.1、设置ipvs模式5.2、找到kube-proxy的pod5.3、删除kube-proxy的pod5.4、查看pod启动情况 6、部署k8s-dashboard（注意：只能在master节点虚拟机上执行）6.1、下载并执行recommended.yaml6.1.1、下载recommended.yaml6.1.2、执行recommended.yaml 6.2、下载并执行dashboard-admin.yaml6.2.1、下载dashboard-admin.yaml6.2.2、执行dashboard-admin.yaml 6.3、找到k8s-dashboard访问端口6.4、访问k8s-dashboard 二、k8s卸载1、只有master节点执行2、master和worker节点都要执行 三、安装其他组件1、安装nfs1.1、master节点安装nfs（说明：可以是其他节点也行）1.2、所有node节点安装nfs 2、安装nfs动态供应2.1、概念2.2、安装步骤（只用在nfs主节点执行）2.2.1、三合一操作（注意：本节操作之后，下面2.2.2、2.2.3、2.2.4就不用操作了）2.2.2、创建存储类（根据自己要求设置，可以设置多个）2.2.3、设置供应商信息2.2.4、设置rbac权限 2.3、验证 3、安装helm3.1、helm安装包3.2、解压3.3、移动3.4、验证3.5、添加repo仓库 4、安装prometheus和grafana4.1、charts下载4.2、修改values.yaml4.3、导入镜像4.4、创建命名空间4.5、安装4.6、保证pod运行完好4.7、改变prometheus、grafana的service暴露方式4.8、使用浏览器访问prometheus、grafana4.9、在grafana中导入查看k8s集群信息的dashboard页面 5、安装harbor5.1、charts下载5.2、修改values.yaml5.3、导入镜像5.4、创建命名空间5.5、安装5.6、保证pod运行完好5.7、使用浏览器访问harbor5.8、在linux上使用docker login XXX方式登录harbor注意事项操作步骤5.8.1、更改所有节点的daemon.json5.8.2、重启docker5.8.3、测试在linux上登录harbor 5.9、测试通过docker命令推送镜像到harbor5.10、测试通过docker命令从harbor仓库下载镜像 6、安装jenkins6.1、导入镜像6.2、创建jenkins.yaml6.3、应用jenkins.yaml6.4、访问jenkins6.5、解锁 Jenkins6.6、插件下载6.7、创建第一个管理员用户6.8、实例配置6.9、更改jenkins插件镜像源6.10、使用public over ssh插件完成jenkins构建全过程6.10.1、安装publish over ssh插件6.10.2、配置ssh连接信息6.10.3、把相关项目奉上6.10.4、先来观察JenkinsFile文件内容6.10.5、再来观察YamlStatefulSet.yaml文件内容6.10.6、再来观察Dockerfile文件内容6.10.7、再来观察application.properties文件内容6.10.8、剩余操作 7、使用docker安装Kuboard7.1、安装文档7.2、安装命令7.3、登录kuboard7.4、添加k8s集群到kuboard 8、使用k8s安装gitlab9、安装单机版mysql9.1、创建名称空间9.2、创建mysql5.79.2.1、创建ConfigMap9.2.2、创建mysql的Service 9.3、创建mysql8.0.2 10、安装minIO10.1、单机版10.2、集群版10.2.1、注意点10.2.2、yaml 11、安装rabbitmq11.1、单机版11.2、集群版 12、安装redis12.1、单机版 13、安装nacos13.1、集群版13.1.1、创建nacos数据库13.1.2、创建nacos13.1.3、访问nacos 14、安装sonar14.1、单机版14.1.1、安装sonar-db14.1.2、安装sonarqube 15、单机版mongodb安装16、单机版Elasticsearch安装16.1、ES7简单安装16.2、ES8简单安装16.3、ES8全面安装 17、安装nexus18、安装onlyoffice19、常用缩写20、常用命令 一、使用kubeadmin方式安装k8s 1、准备虚拟机 2台虚拟机即可，一台做master节点，另外一台做worker节点不会安装的可以看这个：在VMvare中安装CentOS，建议安装centos7
安装之后需要配置静态ip和语言，记得先切换root用户（CentOS如何切换超级用户/root用户），然后根据以下文章配置即可：
Centos的英文环境设置为中文，并修改时区为亚洲上海CentOS配置静态IP 2、安装前置环境（注意：所有虚拟机都执行） 2.1、基础环境 修改虚拟机名称（注意：每个虚拟机单独执行，不能是localhost，每个虚拟机的主机名称必须不同，比如可以是k8s-01、k8s-02……）：
# 例如：hostnamectl set-hostname k8s-01 hostnamectl set-hostname 主机名称 修改其他配置，直接复制执行即可（注意：在所有虚拟机上都执行相同指令即可）
######################################################################### #关闭防火墙： 如果是云服务器，需要设置安全组策略放行端口 # https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#check-required-ports systemctl stop firewalld systemctl disable firewalld # 查看修改结果 hostnamectl status # 设置 hostname 解析 echo &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2922e0608a31555dae71fd9d002eff19/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-10T23:34:09+08:00" />
<meta property="article:modified_time" content="2024-01-10T23:34:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s云原生环境搭建笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#kubeadmink8s_1" rel="nofollow">一、使用kubeadmin方式安装k8s</a></li><li><ul><li><a href="#1_2" rel="nofollow">1、准备虚拟机</a></li><li><a href="#2_10" rel="nofollow">2、安装前置环境（注意：所有虚拟机都执行）</a></li><li><ul><li><a href="#21_11" rel="nofollow">2.1、基础环境</a></li><li><a href="#22docker_72" rel="nofollow">2.2、docker环境（在所有虚拟机上都执行下列指令即可）</a></li><li><a href="#23k8s_97" rel="nofollow">2.3、安装k8s核心组件（在所有虚拟机上都执行相同指令即可）</a></li><li><a href="#24k8s_125" rel="nofollow">2.4、导入k8s所需镜像</a></li><li><a href="#25calico_137" rel="nofollow">2.5、导入calico镜像</a></li></ul> 
   </li><li><a href="#3mastermaster_149" rel="nofollow">3、初始化master节点（注意：只能在master节点虚拟机上执行）</a></li><li><ul><li><a href="#31masterip_151" rel="nofollow">3.1、确定master节点ip</a></li><li><a href="#32servicepod_155" rel="nofollow">3.2、找到合适的service地址区间、pod地址区间</a></li><li><a href="#33kubeadm_init_162" rel="nofollow">3.3、执行kubeadm init操作</a></li><li><a href="#34_187" rel="nofollow">3.4、根据初始化结果来执行操作</a></li><li><ul><li><a href="#341_212" rel="nofollow">3.4.1、复制相关文件夹</a></li><li><a href="#342_219" rel="nofollow">3.4.2、导出环境变量</a></li><li><a href="#343calicoyaml_224" rel="nofollow">3.4.3、导入calico.yaml</a></li><li><a href="#344calicoyaml_240" rel="nofollow">3.4.4、修改calico.yaml（注意：必须修改）</a></li><li><a href="#345calicoyaml_257" rel="nofollow">3.4.5、执行calico.yaml</a></li></ul> 
   </li></ul> 
   </li><li><a href="#4workerworker_264" rel="nofollow">4、初始化worker节点（注意：只能在所有worker节点虚拟机上执行）</a></li><li><a href="#5ipvsmaster_270" rel="nofollow">5、设置ipvs模式（推荐执行，但是不执行也没影响；注意：只能在master节点虚拟机上执行）</a></li><li><ul><li><a href="#51ipvs_271" rel="nofollow">5.1、设置ipvs模式</a></li><li><a href="#52kubeproxypod_279" rel="nofollow">5.2、找到kube-proxy的pod</a></li><li><a href="#53kubeproxypod_290" rel="nofollow">5.3、删除kube-proxy的pod</a></li><li><a href="#54pod_298" rel="nofollow">5.4、查看pod启动情况</a></li></ul> 
   </li><li><a href="#6k8sdashboardmaster_303" rel="nofollow">6、部署k8s-dashboard（注意：只能在master节点虚拟机上执行）</a></li><li><ul><li><a href="#61recommendedyaml_304" rel="nofollow">6.1、下载并执行recommended.yaml</a></li><li><ul><li><a href="#611recommendedyaml_305" rel="nofollow">6.1.1、下载recommended.yaml</a></li><li><a href="#612recommendedyaml_324" rel="nofollow">6.1.2、执行recommended.yaml</a></li></ul> 
    </li><li><a href="#62dashboardadminyaml_329" rel="nofollow">6.2、下载并执行dashboard-admin.yaml</a></li><li><ul><li><a href="#621dashboardadminyaml_330" rel="nofollow">6.2.1、下载dashboard-admin.yaml</a></li><li><a href="#622dashboardadminyaml_345" rel="nofollow">6.2.2、执行dashboard-admin.yaml</a></li></ul> 
    </li><li><a href="#63k8sdashboard_354" rel="nofollow">6.3、找到k8s-dashboard访问端口</a></li><li><a href="#64k8sdashboard_359" rel="nofollow">6.4、访问k8s-dashboard</a></li></ul> 
  </li></ul> 
  </li><li><a href="#k8s_375" rel="nofollow">二、k8s卸载</a></li><li><ul><li><a href="#1master_376" rel="nofollow">1、只有master节点执行</a></li><li><a href="#2masterworker_383" rel="nofollow">2、master和worker节点都要执行</a></li></ul> 
  </li><li><a href="#_399" rel="nofollow">三、安装其他组件</a></li><li><ul><li><a href="#1nfs_400" rel="nofollow">1、安装nfs</a></li><li><ul><li><a href="#11masternfs_401" rel="nofollow">1.1、master节点安装nfs（说明：可以是其他节点也行）</a></li><li><a href="#12nodenfs_422" rel="nofollow">1.2、所有node节点安装nfs</a></li></ul> 
   </li><li><a href="#2nfs_449" rel="nofollow">2、安装nfs动态供应</a></li><li><ul><li><a href="#21_451" rel="nofollow">2.1、概念</a></li><li><a href="#22nfs_460" rel="nofollow">2.2、安装步骤（只用在nfs主节点执行）</a></li><li><ul><li><a href="#221222223224_461" rel="nofollow">2.2.1、三合一操作（注意：本节操作之后，下面2.2.2、2.2.3、2.2.4就不用操作了）</a></li><li><a href="#222_474" rel="nofollow">2.2.2、创建存储类（根据自己要求设置，可以设置多个）</a></li><li><a href="#223_495" rel="nofollow">2.2.3、设置供应商信息</a></li><li><a href="#224rbac_554" rel="nofollow">2.2.4、设置rbac权限</a></li></ul> 
    </li><li><a href="#23_630" rel="nofollow">2.3、验证</a></li></ul> 
   </li><li><a href="#3helm_648" rel="nofollow">3、安装helm</a></li><li><ul><li><a href="#31helm_649" rel="nofollow">3.1、helm安装包</a></li><li><a href="#32_654" rel="nofollow">3.2、解压</a></li><li><a href="#33_659" rel="nofollow">3.3、移动</a></li><li><a href="#34_664" rel="nofollow">3.4、验证</a></li><li><a href="#35repo_669" rel="nofollow">3.5、添加repo仓库</a></li></ul> 
   </li><li><a href="#4prometheusgrafana_676" rel="nofollow">4、安装prometheus和grafana</a></li><li><ul><li><a href="#41charts_677" rel="nofollow">4.1、charts下载</a></li><li><a href="#42valuesyaml_692" rel="nofollow">4.2、修改values.yaml</a></li><li><a href="#43_698" rel="nofollow">4.3、导入镜像</a></li><li><a href="#44_708" rel="nofollow">4.4、创建命名空间</a></li><li><a href="#45_715" rel="nofollow">4.5、安装</a></li><li><a href="#46pod_721" rel="nofollow">4.6、保证pod运行完好</a></li><li><a href="#47prometheusgrafanaservice_727" rel="nofollow">4.7、改变prometheus、grafana的service暴露方式</a></li><li><a href="#48prometheusgrafana_746" rel="nofollow">4.8、使用浏览器访问prometheus、grafana</a></li><li><a href="#49grafanak8sdashboard_772" rel="nofollow">4.9、在grafana中导入查看k8s集群信息的dashboard页面</a></li></ul> 
   </li><li><a href="#5harbor_794" rel="nofollow">5、安装harbor</a></li><li><ul><li><a href="#51charts_795" rel="nofollow">5.1、charts下载</a></li><li><a href="#52valuesyaml_807" rel="nofollow">5.2、修改values.yaml</a></li><li><a href="#53_831" rel="nofollow">5.3、导入镜像</a></li><li><a href="#54_841" rel="nofollow">5.4、创建命名空间</a></li><li><a href="#55_849" rel="nofollow">5.5、安装</a></li><li><a href="#56pod_856" rel="nofollow">5.6、保证pod运行完好</a></li><li><a href="#57harbor_868" rel="nofollow">5.7、使用浏览器访问harbor</a></li><li><a href="#58linuxdocker_login_XXXharbor_873" rel="nofollow">5.8、在linux上使用docker login XXX方式登录harbor</a></li><li><ul><li><a href="#_874" rel="nofollow">注意事项</a></li><li><a href="#_877" rel="nofollow">操作步骤</a></li><li><ul><li><a href="#581daemonjson_878" rel="nofollow">5.8.1、更改所有节点的daemon.json</a></li><li><a href="#582docker_893" rel="nofollow">5.8.2、重启docker</a></li><li><a href="#583linuxharbor_898" rel="nofollow">5.8.3、测试在linux上登录harbor</a></li></ul> 
    </li></ul> 
    </li><li><a href="#59dockerharbor_903" rel="nofollow">5.9、测试通过docker命令推送镜像到harbor</a></li><li><a href="#510dockerharbor_936" rel="nofollow">5.10、测试通过docker命令从harbor仓库下载镜像</a></li></ul> 
   </li><li><a href="#6jenkins_953" rel="nofollow">6、安装jenkins</a></li><li><ul><li><a href="#61_954" rel="nofollow">6.1、导入镜像</a></li><li><a href="#62jenkinsyaml_964" rel="nofollow">6.2、创建jenkins.yaml</a></li><li><a href="#63jenkinsyaml_1114" rel="nofollow">6.3、应用jenkins.yaml</a></li><li><a href="#64jenkins_1133" rel="nofollow">6.4、访问jenkins</a></li><li><a href="#65_Jenkins_1140" rel="nofollow">6.5、解锁 Jenkins</a></li><li><a href="#66_1148" rel="nofollow">6.6、插件下载</a></li><li><a href="#67_1161" rel="nofollow">6.7、创建第一个管理员用户</a></li><li><a href="#68_1164" rel="nofollow">6.8、实例配置</a></li><li><a href="#69jenkins_1168" rel="nofollow">6.9、更改jenkins插件镜像源</a></li><li><a href="#610public_over_sshjenkins_1185" rel="nofollow">6.10、使用public over ssh插件完成jenkins构建全过程</a></li><li><ul><li><a href="#6101publish_over_ssh_1186" rel="nofollow">6.10.1、安装publish over ssh插件</a></li><li><a href="#6102ssh_1200" rel="nofollow">6.10.2、配置ssh连接信息</a></li><li><a href="#6103_1218" rel="nofollow">6.10.3、把相关项目奉上</a></li><li><a href="#6104JenkinsFile_1223" rel="nofollow">6.10.4、先来观察JenkinsFile文件内容</a></li><li><a href="#6105YamlStatefulSetyaml_1404" rel="nofollow">6.10.5、再来观察YamlStatefulSet.yaml文件内容</a></li><li><a href="#6106Dockerfile_1459" rel="nofollow">6.10.6、再来观察Dockerfile文件内容</a></li><li><a href="#6107applicationproperties_1481" rel="nofollow">6.10.7、再来观察application.properties文件内容</a></li><li><a href="#6108_1489" rel="nofollow">6.10.8、剩余操作</a></li></ul> 
   </li></ul> 
   </li><li><a href="#7dockerKuboard_1492" rel="nofollow">7、使用docker安装Kuboard</a></li><li><ul><li><a href="#71_1493" rel="nofollow">7.1、安装文档</a></li><li><a href="#72_1496" rel="nofollow">7.2、安装命令</a></li><li><a href="#73kuboard_1530" rel="nofollow">7.3、登录kuboard</a></li><li><a href="#74k8skuboard_1535" rel="nofollow">7.4、添加k8s集群到kuboard</a></li></ul> 
   </li><li><a href="#8k8sgitlab_1551" rel="nofollow">8、使用k8s安装gitlab</a></li><li><a href="#9mysql_1693" rel="nofollow">9、安装单机版mysql</a></li><li><ul><li><a href="#91_1694" rel="nofollow">9.1、创建名称空间</a></li><li><a href="#92mysql57_1699" rel="nofollow">9.2、创建mysql5.7</a></li><li><ul><li><a href="#921ConfigMap_1700" rel="nofollow">9.2.1、创建ConfigMap</a></li><li><a href="#922mysqlService_1755" rel="nofollow">9.2.2、创建mysql的Service</a></li></ul> 
    </li><li><a href="#93mysql802_1859" rel="nofollow">9.3、创建mysql8.0.2</a></li></ul> 
   </li><li><a href="#10minIO_2046" rel="nofollow">10、安装minIO</a></li><li><ul><li><a href="#101_2047" rel="nofollow">10.1、单机版</a></li><li><a href="#102_2127" rel="nofollow">10.2、集群版</a></li><li><ul><li><a href="#1021_2128" rel="nofollow">10.2.1、注意点</a></li><li><a href="#1022yaml_2145" rel="nofollow">10.2.2、yaml</a></li></ul> 
   </li></ul> 
   </li><li><a href="#11rabbitmq_2267" rel="nofollow">11、安装rabbitmq</a></li><li><ul><li><a href="#111_2268" rel="nofollow">11.1、单机版</a></li><li><a href="#112_2346" rel="nofollow">11.2、集群版</a></li></ul> 
   </li><li><a href="#12redis_2561" rel="nofollow">12、安装redis</a></li><li><ul><li><a href="#121_2562" rel="nofollow">12.1、单机版</a></li></ul> 
   </li><li><a href="#13nacos_2713" rel="nofollow">13、安装nacos</a></li><li><ul><li><a href="#131_2714" rel="nofollow">13.1、集群版</a></li><li><ul><li><a href="#1311nacos_2716" rel="nofollow">13.1.1、创建nacos数据库</a></li><li><a href="#1312nacos_2943" rel="nofollow">13.1.2、创建nacos</a></li><li><a href="#1313nacos_3193" rel="nofollow">13.1.3、访问nacos</a></li></ul> 
   </li></ul> 
   </li><li><a href="#14sonar_3199" rel="nofollow">14、安装sonar</a></li><li><ul><li><a href="#141_3200" rel="nofollow">14.1、单机版</a></li><li><ul><li><a href="#1411sonardb_3201" rel="nofollow">14.1.1、安装sonar-db</a></li><li><a href="#1412sonarqube_3282" rel="nofollow">14.1.2、安装sonarqube</a></li></ul> 
   </li></ul> 
   </li><li><a href="#15mongodb_3436" rel="nofollow">15、单机版mongodb安装</a></li><li><a href="#16Elasticsearch_3505" rel="nofollow">16、单机版Elasticsearch安装</a></li><li><ul><li><a href="#161ES7_3506" rel="nofollow">16.1、ES7简单安装</a></li><li><a href="#162ES8_3655" rel="nofollow">16.2、ES8简单安装</a></li><li><a href="#163ES8_3798" rel="nofollow">16.3、ES8全面安装</a></li></ul> 
   </li><li><a href="#17nexus_4455" rel="nofollow">17、安装nexus</a></li><li><a href="#18onlyoffice_4532" rel="nofollow">18、安装onlyoffice</a></li><li><a href="#19_4581" rel="nofollow">19、常用缩写</a></li><li><a href="#20_4591" rel="nofollow">20、常用命令</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="kubeadmink8s_1"></a>一、使用kubeadmin方式安装k8s</h2> 
<h3><a id="1_2"></a>1、准备虚拟机</h3> 
<p>2台虚拟机即可，一台做master节点，另外一台做worker节点不会安装的可以看这个：<a href="https://blog.csdn.net/qq_42449963/article/details/122645252">在VMvare中安装CentOS</a>，建议安装centos7</p> 
<p>安装之后需要配置静态ip和语言，记得先切换root用户（<a href="https://blog.csdn.net/qq_42449963/article/details/106990374">CentOS如何切换超级用户/root用户</a>），然后根据以下文章配置即可：</p> 
<ol><li><a href="https://blog.csdn.net/qq_42449963/article/details/122646447">Centos的英文环境设置为中文，并修改时区为亚洲上海</a></li><li><a href="https://blog.csdn.net/qq_42449963/article/details/106989034">CentOS配置静态IP</a></li></ol> 
<h3><a id="2_10"></a>2、安装前置环境（注意：所有虚拟机都执行）</h3> 
<h4><a id="21_11"></a>2.1、基础环境</h4> 
<p><strong>修改虚拟机名称（注意：每个虚拟机单独执行，不能是localhost，每个虚拟机的主机名称必须不同，比如可以是k8s-01、k8s-02……）：</strong></p> 
<pre><code class="prism language-bash"><span class="token comment"># 例如：hostnamectl set-hostname k8s-01</span>
hostnamectl set-hostname 主机名称
</code></pre> 
<p><strong>修改其他配置，直接复制执行即可（注意：在所有虚拟机上都执行相同指令即可）</strong></p> 
<pre><code class="prism language-bash"><span class="token comment">#########################################################################</span>
<span class="token comment">#关闭防火墙： 如果是云服务器，需要设置安全组策略放行端口</span>
<span class="token comment"># https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#check-required-ports</span>
systemctl stop firewalld
systemctl disable firewalld

<span class="token comment"># 查看修改结果</span>
hostnamectl status
<span class="token comment"># 设置 hostname 解析</span>
<span class="token builtin class-name">echo</span> <span class="token string">"127.0.0.1   <span class="token variable"><span class="token variable">$(</span><span class="token function">hostname</span><span class="token variable">)</span></span>"</span> <span class="token operator">&gt;&gt;</span> /etc/hosts

<span class="token comment">#关闭 selinux： </span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/enforcing/disabled/'</span> /etc/selinux/config
setenforce <span class="token number">0</span>

<span class="token comment">#关闭 swap：</span>
swapoff <span class="token parameter variable">-a</span>  
<span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'s/.*swap.*/#&amp;/'</span> /etc/fstab 

<span class="token comment">#允许 iptables 检查桥接流量</span>
<span class="token comment">#https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#%E5%85%81%E8%AE%B8-iptables-%E6%A3%80%E6%9F%A5%E6%A1%A5%E6%8E%A5%E6%B5%81%E9%87%8F</span>
<span class="token comment">## 开启br_netfilter</span>
<span class="token comment">## sudo modprobe br_netfilter</span>
<span class="token comment">## 确认下</span>
<span class="token comment">## lsmod | grep br_netfilter</span>

<span class="token comment">## 修改配置</span>


<span class="token comment">#####这里用这个，不要用课堂上的配置。。。。。。。。。</span>
<span class="token comment">#将桥接的 IPv4 流量传递到 iptables 的链：</span>
<span class="token comment"># 修改 /etc/sysctl.conf</span>
<span class="token comment"># 如果有配置，则修改</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#^net.ipv4.ip_forward.*#net.ipv4.ip_forward=1#g"</span>  /etc/sysctl.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#^net.bridge.bridge-nf-call-ip6tables.*#net.bridge.bridge-nf-call-ip6tables=1#g"</span>  /etc/sysctl.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#^net.bridge.bridge-nf-call-iptables.*#net.bridge.bridge-nf-call-iptables=1#g"</span>  /etc/sysctl.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#^net.ipv6.conf.all.disable_ipv6.*#net.ipv6.conf.all.disable_ipv6=1#g"</span>  /etc/sysctl.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#^net.ipv6.conf.default.disable_ipv6.*#net.ipv6.conf.default.disable_ipv6=1#g"</span>  /etc/sysctl.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#^net.ipv6.conf.lo.disable_ipv6.*#net.ipv6.conf.lo.disable_ipv6=1#g"</span>  /etc/sysctl.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#^net.ipv6.conf.all.forwarding.*#net.ipv6.conf.all.forwarding=1#g"</span>  /etc/sysctl.conf
<span class="token comment"># 可能没有，追加</span>
<span class="token builtin class-name">echo</span> <span class="token string">"net.ipv4.ip_forward = 1"</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token builtin class-name">echo</span> <span class="token string">"net.bridge.bridge-nf-call-ip6tables = 1"</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token builtin class-name">echo</span> <span class="token string">"net.bridge.bridge-nf-call-iptables = 1"</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token builtin class-name">echo</span> <span class="token string">"net.ipv6.conf.all.disable_ipv6 = 1"</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token builtin class-name">echo</span> <span class="token string">"net.ipv6.conf.default.disable_ipv6 = 1"</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token builtin class-name">echo</span> <span class="token string">"net.ipv6.conf.lo.disable_ipv6 = 1"</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token builtin class-name">echo</span> <span class="token string">"net.ipv6.conf.all.forwarding = 1"</span>  <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token comment"># 执行命令以应用</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-p</span>
</code></pre> 
<h4><a id="22docker_72"></a>2.2、docker环境（在所有虚拟机上都执行下列指令即可）</h4> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> yum remove docker*
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils
<span class="token comment">#配置docker yum 源</span>
<span class="token function">sudo</span> yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
<span class="token comment">#安装docker 19.03.9</span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> docker-ce-3:19.03.9-3.el7.x86_64  docker-ce-cli-3:19.03.9-3.el7.x86_64 containerd.io

<span class="token comment"># 首先启动docker，然后让docker随虚拟机一起启动</span>
systemctl start <span class="token function">docker</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span>

<span class="token comment">#配置加速，使用网易镜像加速器</span>
<span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/docker
<span class="token function">sudo</span> <span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
{
  "registry-mirrors": ["http://hub-mirror.c.163.com"]
}
EOF</span>
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart <span class="token function">docker</span>
</code></pre> 
<h4><a id="23k8s_97"></a>2.3、安装k8s核心组件（在所有虚拟机上都执行相同指令即可）</h4> 
<pre><code class="prism language-bash"><span class="token comment"># 配置K8S的yum源</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/yum.repos.d/kubernetes.repo</span>
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span>

<span class="token comment"># 卸载旧版本</span>
yum remove <span class="token parameter variable">-y</span> kubelet kubeadm kubectl

<span class="token comment"># 查看可以安装的版本</span>
yum list kubelet <span class="token parameter variable">--showduplicates</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-r</span>

<span class="token comment"># 安装kubelet、kubeadm、kubectl 指定版本</span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet-1.21.0 kubeadm-1.21.0 kubectl-1.21.0

<span class="token comment"># 开机启动kubelet</span>
systemctl <span class="token builtin class-name">enable</span> kubelet <span class="token operator">&amp;&amp;</span> systemctl start kubelet
</code></pre> 
<h4><a id="24k8s_125"></a>2.4、导入k8s所需镜像</h4> 
<p>直接使用<code>docker load -i 镜像tar包名称</code>即可导入，镜像在下面</p> 
<p>链接：<a href="https://pan.baidu.com/s/17LEprW3CeEAQYC4Dn_Klxg?pwd=s5bt" rel="nofollow">https://pan.baidu.com/s/17LEprW3CeEAQYC4Dn_Klxg?pwd=s5bt</a></p> 
<p>提取码：<code>s5bt</code></p> 
<p><strong>说明：</strong></p> 
<p>这些镜像是atguigu雷丰阳老师传到阿里云上的，我直接放到百度网盘中，大家可以直接导入即可</p> 
<h4><a id="25calico_137"></a>2.5、导入calico镜像</h4> 
<p>因为我们所用的k8s版本是1.21.0，根据<a href="https://projectcalico.docs.tigera.io/archive/v3.21/getting-started/kubernetes/requirements" rel="nofollow">https://projectcalico.docs.tigera.io/archive/v3.21/getting-started/kubernetes/requirements</a>可以看到对应的calico版本是v3.21，截图在下面</p> 
<p><img src="https://images2.imgbox.com/29/94/rMS3SX13_o.png" alt="在这里插入图片描述"></p> 
<p>直接使用<code>docker load -i 镜像tar包名称</code>即可导入，镜像在下面</p> 
<p>链接：<a href="https://pan.baidu.com/s/122EoickH6jsSMJ8ECJ3P5g?pwd=vv8n" rel="nofollow">https://pan.baidu.com/s/122EoickH6jsSMJ8ECJ3P5g?pwd=vv8n</a></p> 
<p>提取码：<code>vv8n</code></p> 
<h3><a id="3mastermaster_149"></a>3、初始化master节点（注意：只能在master节点虚拟机上执行）</h3> 
<h4><a id="31masterip_151"></a>3.1、确定master节点ip</h4> 
<p>执行<code>ip a</code>就可以找到了，如下：</p> 
<p><img src="https://images2.imgbox.com/3d/f5/SCL5NbvC_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="32servicepod_155"></a>3.2、找到合适的service地址区间、pod地址区间</h4> 
<p>service地址区间、pod地址区间和master节点的ip只要不重复就可以了，由于我的是<code>192.168.139.128</code>，所以我选择的两个地址区间如下：</p> 
<p>service地址区间：<code>10.98.0.0/16</code>（注意：16代表前面XX.XX是固定的）</p> 
<p>pod地址区间：<code>10.99.0.0/16</code>（注意：16代表前面XX.XX是固定的）</p> 
<h4><a id="33kubeadm_init_162"></a>3.3、执行kubeadm init操作</h4> 
<p>注意：将<code>master主节点id</code>、<code>service地址区间</code>、<code>pod地址区间</code>改成你自己主节点的，查找方法在上面</p> 
<pre><code class="prism language-bash">kubeadm init <span class="token punctuation">\</span>
--apiserver-advertise-address<span class="token operator">=</span>master主节点id <span class="token punctuation">\</span>
--image-repository registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images <span class="token punctuation">\</span>
--kubernetes-version v1.21.0 <span class="token punctuation">\</span>
--service-cidr<span class="token operator">=</span>service地址区间 <span class="token punctuation">\</span>
--pod-network-cidr<span class="token operator">=</span>pod地址区间
</code></pre> 
<p>比如我的就是</p> 
<pre><code class="prism language-bash">kubeadm init <span class="token punctuation">\</span>
--apiserver-advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.139.128 <span class="token punctuation">\</span>
--image-repository registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images <span class="token punctuation">\</span>
--kubernetes-version v1.21.0 <span class="token punctuation">\</span>
--service-cidr<span class="token operator">=</span><span class="token number">10.98</span>.0.0/16 <span class="token punctuation">\</span>
--pod-network-cidr<span class="token operator">=</span><span class="token number">10.99</span>.0.0/16
</code></pre> 
<p><strong>说明：</strong></p> 
<p>指令中的<code>registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images</code>对应k8s相关镜像的前缀，这些镜像来自于atguigu雷丰阳老师的阿里云镜像仓库，我直接把它放到百度网盘中了，大家可以直接下载导入即可</p> 
<h4><a id="34_187"></a>3.4、根据初始化结果来执行操作</h4> 
<p>下面是我的初始化结果：</p> 
<pre><code class="prism language-bash">Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

Alternatively, <span class="token keyword">if</span> you are the root user, you can run:

  <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:

kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.139.129:6443 <span class="token parameter variable">--token</span> gjkehd.e68y3u6csud6mz8y <span class="token punctuation">\</span>
	--discovery-token-ca-cert-hash sha256:0425228dfd80644425f3a1cbd5cb4a8a610f7e45b2d3d3b2f7f6ccddf60a98d7
</code></pre> 
<h5><a id="341_212"></a>3.4.1、复制相关文件夹</h5> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config
</code></pre> 
<h5><a id="342_219"></a>3.4.2、导出环境变量</h5> 
<pre><code class="prism language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/etc/kubernetes/admin.conf
</code></pre> 
<h5><a id="343calicoyaml_224"></a>3.4.3、导入calico.yaml</h5> 
<p>链接：<a href="https://pan.baidu.com/s/1EWJNtWQuekb0LYXernjWew?pwd=70ku" rel="nofollow">https://pan.baidu.com/s/1EWJNtWQuekb0LYXernjWew?pwd=70ku</a></p> 
<p>提取码：<code>70ku</code></p> 
<p><strong>说明：</strong></p> 
<p>虽然我已经给大家提供了<code>calico.yaml</code>文件，但是还想和大家说一下该文件的来源，首先在<strong>2.5、导入calico镜像</strong>中可以知道，我们本次使用的calico版本是<code>v3.21</code>，那么可以在linux上使用<code>wget https://docs.projectcalico.org/v3.21/manifests/calico.yaml --no-check-certificate</code>指令下载（注意链接中的版本号是v3.21），其中<code>--no-check-certificate</code>代表非安全方式下载，必须这样操作，不然无法下载</p> 
<p>另外对于<code>calico.yaml</code>来说，我们将所有image的值前面的docker.io/去掉了，毕竟我们已经将calico镜像导入了，就不用去docker.io下载镜像了</p> 
<p><img src="https://images2.imgbox.com/59/6d/pUaWq5ik_o.png" alt="在这里插入图片描述"></p> 
<p>下一个需要修改的位置就是<code>3.4.4、修改calico.yaml</code>里面的值了，这个直接跟着下面修改即可</p> 
<h5><a id="344calicoyaml_240"></a>3.4.4、修改calico.yaml（注意：必须修改）</h5> 
<p>根据<code>ifconfig</code>找到我们所用ip前面的内容，比如我的是<code>ens33</code>，如下：</p> 
<p><img src="https://images2.imgbox.com/06/fc/OX5utL2N_o.png" alt="在这里插入图片描述"></p> 
<p>根据你ip前面的结果来修改文件中<code>interface</code>的值，如下：</p> 
<p><img src="https://images2.imgbox.com/ab/64/FdO9ubNZ_o.png" alt="在这里插入图片描述"></p> 
<p>其实下面这些指令都是我自己添加的，原来的<code>calico.yaml</code>中是没有的，添加的原因是执行<code>calico.yaml</code>报错了，然后根据这篇<a href="https://blog.csdn.net/qq_27706119/article/details/122243629">calico/node is not ready</a>来添加的，添加之后在执行<code>yaml</code>文件，然后<code>calico</code>的所有容器都运行正常了</p> 
<pre><code class="prism language-bash">- name: IP_AUTODETECTION_METHOD
  value: <span class="token string">"interface=ens33"</span>
</code></pre> 
<h5><a id="345calicoyaml_257"></a>3.4.5、执行calico.yaml</h5> 
<pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> calico.yaml
</code></pre> 
<h3><a id="4workerworker_264"></a>4、初始化worker节点（注意：只能在所有worker节点虚拟机上执行）</h3> 
<p>找到<strong>3.4、根据初始化结果来执行操作</strong>的master主节点中的最后结果，记得用你自己的初始化结果哈，然后在所有worker节点执行即可</p> 
<p><img src="https://images2.imgbox.com/e2/b3/T1fQBRXF_o.png" alt="在这里插入图片描述"><br> 如果命令中的token失效，可以在主节点虚拟机中通过<code>kubeadm token create --print-join-command</code>得到最新的指令，然后在所有worker节点的虚拟机中执行即可</p> 
<h3><a id="5ipvsmaster_270"></a>5、设置ipvs模式（推荐执行，但是不执行也没影响；注意：只能在master节点虚拟机上执行）</h3> 
<h4><a id="51ipvs_271"></a>5.1、设置ipvs模式</h4> 
<p>默认是<code>iptables</code>模式，但是这种模式在大集群中会占用很多空间，所以建议使用<code>ipvs</code>模式</p> 
<p>首先执行<code>kubectl edit cm kube-proxy -n kube-system</code>，然后输入<code>/mode</code>，将mode的值设置成<code>ipvs</code>，保存退出即可，如下：</p> 
<p><img src="https://images2.imgbox.com/f4/e7/KxFtEUkf_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="52kubeproxypod_279"></a>5.2、找到kube-proxy的pod</h4> 
<pre><code class="prism language-bash">kubectl get pod -A<span class="token operator">|</span><span class="token function">grep</span> kube-proxy
</code></pre> 
<p>例如pod如下：</p> 
<p><img src="https://images2.imgbox.com/b0/9e/1BhtMS9e_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="53kubeproxypod_290"></a>5.3、删除kube-proxy的pod</h4> 
<pre><code class="prism language-bash">kubectl delete pod pod1名称 pod2名称…… <span class="token parameter variable">-n</span> kube-system
</code></pre> 
<p>根据上面的命令，可以找到kube-proxy的pod名称，比如我上面的就是<code>kube-proxy-cxh25</code>、<code>kube-proxy-ws4nn</code>，那么删除命令就是：<code>kubectl delete pod kube-proxy-cxh25 kube-proxy-ws4nn -n kube-system</code>，由于k8s拥有自愈能力，所以proxy删除之后就会重新拉起一个pod</p> 
<h4><a id="54pod_298"></a>5.4、查看pod启动情况</h4> 
<p>使用<code>kubectl get pod -A</code>命令即可，我们只看<code>NAMESPACE</code>下面的<code>kube-system</code>，只要看到所有<code>STATUS</code>都是<code>Running</code>，并且<code>READY</code>都是<code>1/1</code>就可以了，如果pod一直不满足要求，那就可以使用<code>kubectl describe pod pod名称 -n kube-system</code>查看一下pod执行进度，如果把握不准，可以使用<code>reboot</code>命令对所有虚拟机执行重启操作，最终结果是下面这样就可以了</p> 
<p><img src="https://images2.imgbox.com/22/b3/LDl58lIT_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="6k8sdashboardmaster_303"></a>6、部署k8s-dashboard（注意：只能在master节点虚拟机上执行）</h3> 
<h4><a id="61recommendedyaml_304"></a>6.1、下载并执行recommended.yaml</h4> 
<h5><a id="611recommendedyaml_305"></a>6.1.1、下载recommended.yaml</h5> 
<p>链接：<a href="https://pan.baidu.com/s/1rNnCUa7B7GaX2SFjiPgZTQ?pwd=z2zp" rel="nofollow">https://pan.baidu.com/s/1rNnCUa7B7GaX2SFjiPgZTQ?pwd=z2zp</a></p> 
<p>提取码：<code>z2zp</code></p> 
<p><strong>说明：</strong></p> 
<p>该yaml来自于<a href="https://github.com/kubernetes/dashboard">https://github.com/kubernetes/dashboard</a>中的该位置：</p> 
<p><img src="https://images2.imgbox.com/52/24/WGu3NsCo_o.png" alt="在这里插入图片描述"></p> 
<p>直接通过<code>wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.2.0/aio/deploy/recommended.yaml</code>下载该yaml即可</p> 
<p>由于我们通过浏览器直接访问<code>kubernetes dashboard</code>，所以还需要在<code>yaml</code>文件中添加<code>type：NodePort</code>，如下：</p> 
<p><img src="https://images2.imgbox.com/07/0d/0Wf880lI_o.png" alt="在这里插入图片描述"></p> 
<p>然后直接执行<code>kubectl apply -f recommended.yaml</code>即可</p> 
<h5><a id="612recommendedyaml_324"></a>6.1.2、执行recommended.yaml</h5> 
<pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> recommended.yaml
</code></pre> 
<h4><a id="62dashboardadminyaml_329"></a>6.2、下载并执行dashboard-admin.yaml</h4> 
<h5><a id="621dashboardadminyaml_330"></a>6.2.1、下载dashboard-admin.yaml</h5> 
<p>链接：<a href="https://pan.baidu.com/s/14upSiYdrZaw5EVFWRDNswg?pwd=co3g" rel="nofollow">https://pan.baidu.com/s/14upSiYdrZaw5EVFWRDNswg?pwd=co3g</a></p> 
<p>提取码：<code>co3g</code></p> 
<p><strong>说明：</strong></p> 
<p>该yaml来自于<a href="https://github.com/kubernetes/dashboard">https://github.com/kubernetes/dashboard</a>中的该位置：</p> 
<p><img src="https://images2.imgbox.com/36/27/tbYm6bqz_o.png" alt="在这里插入图片描述"><br> 进入<a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/README.md">Access Control</a>链接之后，找到下列位置即可，复制到<code>dashboard-admin.yaml</code>文件中即可</p> 
<p><img src="https://images2.imgbox.com/a3/64/TIRJrW2h_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="622dashboardadminyaml_345"></a>6.2.2、执行dashboard-admin.yaml</h5> 
<pre><code class="prism language-bash"><span class="token comment"># 删除原有用户，避免启动报错</span>
kubectl delete <span class="token parameter variable">-f</span> dashboard-admin.yaml

<span class="token comment"># 添加新用户</span>
kubectl apply <span class="token parameter variable">-f</span> dashboard-admin.yaml
</code></pre> 
<h4><a id="63k8sdashboard_354"></a>6.3、找到k8s-dashboard访问端口</h4> 
<p>使用<code>kubectl get all -A</code>命令即可，找到：</p> 
<p><img src="https://images2.imgbox.com/a8/cf/qKzQZzAR_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="64k8sdashboard_359"></a>6.4、访问k8s-dashboard</h4> 
<p>直接在浏览器上根据你的虚拟机ip和上述端口访问即可，如下：</p> 
<p><img src="https://images2.imgbox.com/03/fc/NMciNtm3_o.png" alt="在这里插入图片描述"></p> 
<p>我们需要获取token，指令如下：</p> 
<pre><code class="prism language-bash">kubectl <span class="token parameter variable">-n</span> kubernetes-dashboard describe secret <span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> kubernetes-dashboard get secret <span class="token operator">|</span> <span class="token function">grep</span> admin-user <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1}'</span><span class="token variable">)</span></span>
</code></pre> 
<p>复制红框框中的内容输入到文本框中，然后点击登录按钮即可，如下：<br> <img src="https://images2.imgbox.com/0c/c5/ovnSXVTO_o.png" alt="在这里插入图片描述"></p> 
<p>然后k8s-dashboard首页如下：</p> 
<p><img src="https://images2.imgbox.com/be/4e/tO1Ttb8j_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="k8s_375"></a>二、k8s卸载</h2> 
<h3><a id="1master_376"></a>1、只有master节点执行</h3> 
<pre><code class="prism language-java"># 必须删除，否则会出现https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>lfl17718347843<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">14122407.</span>html中的问题
rm <span class="token operator">-</span>rf $<span class="token constant">HOME</span><span class="token operator">/</span><span class="token punctuation">.</span>kube
</code></pre> 
<h3><a id="2masterworker_383"></a>2、master和worker节点都要执行</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 停掉kubelet</span>
systemctl stop kubelet.service

<span class="token comment"># 重新初始化节点配置，输入字母y回车</span>
kubeadm reset

<span class="token comment"># 卸载管理组件</span>
yum erase <span class="token parameter variable">-y</span> kubelet kubectl kubeadm kubernetes-cni

<span class="token comment"># 重启docker</span>
systemctl restart <span class="token function">docker</span>
</code></pre> 
<h2><a id="_399"></a>三、安装其他组件</h2> 
<h3><a id="1nfs_400"></a>1、安装nfs</h3> 
<h4><a id="11masternfs_401"></a>1.1、master节点安装nfs（说明：可以是其他节点也行）</h4> 
<pre><code class="prism language-shell">// 安装nfs-utils工具包
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> nfs-utils

// 创建nfs文件夹
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /nfs/data

// 确定访问ip，其中*代表所有ip，当然也可以设置cidr，比如我的master节点ip是192.168.139.128，那么下面的*就可以换成192.168.0.0/16，这样可以限制访问nfs目录的ip
<span class="token builtin class-name">echo</span> <span class="token string">"/nfs/data/ *(insecure,rw,sync,no_root_squash)"</span> <span class="token operator">&gt;</span> /etc/exports

// 开机启动nfs相关服务
systemctl <span class="token builtin class-name">enable</span> rpcbind
systemctl <span class="token builtin class-name">enable</span> nfs-server
systemctl start rpcbind
systemctl start nfs-server

// 检查配置是否生效
exportfs <span class="token parameter variable">-r</span>
exportfs
</code></pre> 
<h4><a id="12nodenfs_422"></a>1.2、所有node节点安装nfs</h4> 
<pre><code class="prism language-shell">// 安装nfs-utils工具包
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> nfs-utils

// 检查 nfs 服务器端是否有设置共享目录，如果输出结果如下就是正常的：Export list <span class="token keyword">for</span> <span class="token number">192.168</span>.139.128: /nfs/data *
showmount <span class="token parameter variable">-e</span> master节点所在服务器ip

// 创建nd共享master节点的/nfs/data目录
<span class="token function">mkdir</span> /nd

// 将node节点nfs目录和master节点nfs目录同步（说明：假设node节点的nfs目录是/nd，而master节点的nfs目录是/nfs/data）
<span class="token function">mount</span> <span class="token parameter variable">-t</span> nfs master节点所在服务器ip:/nfs/data /nd

// 测试nfs目录共享效果
比如在node节点的/nd中执行echo <span class="token string">"111"</span> <span class="token operator">&gt;</span> a.txt，然后就可以去master节点的/nfs/data目录中看下是否存在a.txt文件

// 开启自动挂载nfs目录（注意：先启动master节点虚拟机，然后在启动node节点虚拟机，如果node节点虚拟机先启动，除非重新启动，不然只能通过mount <span class="token parameter variable">-t</span> nfs master节点所在服务器ip:/nfs/data /nd指令进行手动挂载）
执行 <span class="token function">vim</span> /etc/fstab 命令打开fstab文件，然后将
master节点所在服务器ip:/nfs/data /nd nfs defaults <span class="token number">0</span> <span class="token number">0</span>
添加到文件中，最终结果如下图，其中ip、nfs共享目录、
当前节点的nfs目录都是我自己的，大家可以看着配置成自己的即可
</code></pre> 
<p><img src="https://images2.imgbox.com/74/f4/qp3kjR2a_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2nfs_449"></a>2、安装nfs动态供应</h3> 
<h4><a id="21_451"></a>2.1、概念</h4> 
<p>开发人员只用说明自己的需求，也就是pvc，在pvc里面指定对应的存储类，我们的需求到时候自然会被满足</p> 
<p>运维人员会把供应商（比如nfs）创建好，另外会设置好存储类的类型，开发人员只用根据要求去选择合适的存储类即可<br> <img src="https://images2.imgbox.com/6b/e7/Uqa7h7l3_o.png" alt="在这里插入图片描述"></p> 
<p>具体过程如下：</p> 
<p><img src="https://images2.imgbox.com/c9/6b/zoyTdGMC_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="22nfs_460"></a>2.2、安装步骤（只用在nfs主节点执行）</h4> 
<h5><a id="221222223224_461"></a>2.2.1、三合一操作（注意：本节操作之后，下面2.2.2、2.2.3、2.2.4就不用操作了）</h5> 
<p>下面两个链接看下就行，主要从<strong>说明</strong>看起</p> 
<p>操作文件所在路径：<a href="https://github.com/kubernetes-retired/external-storage/tree/master/nfs-client">https://github.com/kubernetes-retired/external-storage/tree/master/nfs-client</a></p> 
<p>目前使用<code>deploy</code>安装方式，具体路径是：<a href="https://github.com/kubernetes-retired/external-storage/tree/master/nfs-client/deploy">https://github.com/kubernetes-retired/external-storage/tree/master/nfs-client/deploy</a></p> 
<p><strong>说明：</strong> 下面三个<code>yaml</code>可以整合到一个<code>yaml</code>之中，然后用<code>---</code>进行分隔，然后一次性执行即可，我这里提供一下合并之后的yaml，大家按照下面的说明自己改下</p> 
<p>链接：<a href="https://pan.baidu.com/s/1mtMjSDNqipi-oBTPDNjbNg?pwd=tgcj" rel="nofollow">https://pan.baidu.com/s/1mtMjSDNqipi-oBTPDNjbNg?pwd=tgcj</a></p> 
<p>提取码：<code>tgcj</code></p> 
<h5><a id="222_474"></a>2.2.2、创建存储类（根据自己要求设置，可以设置多个）</h5> 
<p>地址：<a href="https://github.com/kubernetes-retired/external-storage/blob/master/nfs-client/deploy/class.yaml">https://github.com/kubernetes-retired/external-storage/blob/master/nfs-client/deploy/class.yaml</a></p> 
<p>我使用的内容可能和上面不一样，建议大家使用我下面的yaml，可以直接使用<code>kubectl apply -f 下面的yaml文件</code>执行即可</p> 
<pre><code class="prism language-shell"><span class="token comment">## 创建了一个存储类</span>
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: managed-nfs-storage <span class="token comment"># 存储类名称</span>
  annotations:
    storageclass.kubernetes.io/is-default-class: <span class="token string">"true"</span> <span class="token comment"># 是否是默认分类，也就是pvc不选择存储分类的时候就用这个，一般只用设置一个默认的即可</span>
provisioner: k8s-sigs.io/nfs-subdir-external-provisioner 
<span class="token comment">#provisioner指定一个供应商的名字。  </span>
<span class="token comment">#必须匹配 k8s-deployment 的 env PROVISIONER_NAME的值</span>
parameters:
  archiveOnDelete: <span class="token string">"true"</span>  <span class="token comment">## 删除pv的时候，pv的内容是否要备份，这个也是可选参数</span>
  <span class="token comment">#### 这里可以调整供应商能力。</span>
</code></pre> 
<h5><a id="223_495"></a>2.2.3、设置供应商信息</h5> 
<p>地址：<a href="https://github.com/kubernetes-retired/external-storage/blob/master/nfs-client/deploy/deployment-arm.yaml">https://github.com/kubernetes-retired/external-storage/blob/master/nfs-client/deploy/deployment-arm.yaml</a></p> 
<p>我使用的内容可能和上面不一样，建议大家使用我下面的yaml，<strong><code>不能直接复制粘贴使用</code></strong>，注意把yaml里面XXX代表的nfs主机ip和nfs共享目录修改成自己的，修改完成之后可以直接使用<code>kubectl apply -f 下面的yaml文件</code>执行即可</p> 
<p>另外里面使用的镜像是尚硅谷雷丰阳老师的阿里云仓库镜像，如果哪一天他的镜像不在了，大家可以使用<code>docker load -i 镜像tar包名称</code>导入下面的镜像即可</p> 
<p>链接：<a href="https://pan.baidu.com/s/1VT9pbmCIsh4tHdcLx5ryvA?pwd=o17g" rel="nofollow">https://pan.baidu.com/s/1VT9pbmCIsh4tHdcLx5ryvA?pwd=o17g</a></p> 
<p>提取码：<code>o17g</code></p> 
<pre><code class="prism language-powershell">apiVersion: apps/v1
kind: Deployment
metadata:
  name: nfs-client-provisioner
  labels:
    app: nfs-client-provisioner
  <span class="token comment"># replace with namespace where provisioner is deployed</span>
  namespace: default
spec:
  replicas: 1
  strategy:
    <span class="token function">type</span>: Recreate
  selector:
    matchLabels:
      app: nfs-client-provisioner
  template:
    metadata:
      labels:
        app: nfs-client-provisioner
    spec:
      serviceAccountName: nfs-client-provisioner
      containers:
        <span class="token operator">-</span> name: nfs-client-provisioner
          image: registry<span class="token punctuation">.</span>cn-hangzhou<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com/lfy_k8s_images/nfs-subdir-external-provisioner:v4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>2 <span class="token comment"># 使用尚硅谷雷丰阳的镜像</span>
          <span class="token comment"># resources:</span>
          <span class="token comment">#    limits:</span>
          <span class="token comment">#      cpu: 10m</span>
          <span class="token comment">#    requests:</span>
          <span class="token comment">#      cpu: 10m</span>
          volumeMounts:
            <span class="token operator">-</span> name: nfs-client-root
              mountPath: <span class="token operator">/</span>persistentvolumes
          env:
            <span class="token operator">-</span> name: PROVISIONER_NAME
              value: k8s-sigs<span class="token punctuation">.</span>io/nfs-subdir-external-provisioner
            <span class="token operator">-</span> name: NFS_SERVER
              value: XXX <span class="token comment">## 指定自己nfs服务器地址，也就是装nfs服务器的主机ip，比如我的就是192.168.139.128</span>
            <span class="token operator">-</span> name: NFS_PATH  
              value: XXX  <span class="token comment">## 指定自己nfs服务器共享的目录，比如我的就是/nfs/data</span>
      volumes:
        <span class="token operator">-</span> name: nfs-client-root
          nfs:
            server: XXX <span class="token comment">## 指定自己nfs服务器地址，也就是装nfs服务器的主机ip，比如我的就是192.168.139.128</span>
            path: XXX  <span class="token comment">## 指定自己nfs服务器共享的目录，比如我的就是/nfs/data</span>
</code></pre> 
<h5><a id="224rbac_554"></a>2.2.4、设置rbac权限</h5> 
<p>地址：<a href="https://github.com/kubernetes-retired/external-storage/blob/master/nfs-client/deploy/rbac.yaml">https://github.com/kubernetes-retired/external-storage/blob/master/nfs-client/deploy/rbac.yaml</a></p> 
<p>我使用的内容可能和上面不一样，建议大家使用我下面的yaml，直接使用<code>kubectl apply -f 下面的yaml文件</code>执行即可</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: ServiceAccount
metadata:
  name: nfs-client-provisioner
  <span class="token comment"># replace with namespace where provisioner is deployed</span>
  namespace: default
<span class="token operator">--</span><span class="token operator">-</span>
kind: ClusterRole
apiVersion: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
metadata:
  name: nfs-client-provisioner-runner
rules:
  <span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"nodes"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>
  <span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>
  <span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>
<span class="token operator">--</span><span class="token operator">-</span>
kind: ClusterRoleBinding
apiVersion: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
metadata:
  name: run-nfs-client-provisioner
subjects:
  <span class="token operator">-</span> kind: ServiceAccount
    name: nfs-client-provisioner
    <span class="token comment"># replace with namespace where provisioner is deployed</span>
    namespace: default
roleRef:
  kind: ClusterRole
  name: nfs-client-provisioner-runner
  apiGroup: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io
<span class="token operator">--</span><span class="token operator">-</span>
kind: Role
apiVersion: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
  <span class="token comment"># replace with namespace where provisioner is deployed</span>
  namespace: default
rules:
  <span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>
<span class="token operator">--</span><span class="token operator">-</span>
kind: RoleBinding
apiVersion: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
  <span class="token comment"># replace with namespace where provisioner is deployed</span>
  namespace: default
subjects:
  <span class="token operator">-</span> kind: ServiceAccount
    name: nfs-client-provisioner
    <span class="token comment"># replace with namespace where provisioner is deployed</span>
    namespace: default
roleRef:
  kind: Role
  name: leader-locking-nfs-client-provisioner
  apiGroup: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io
</code></pre> 
<h4><a id="23_630"></a>2.3、验证</h4> 
<p>将下面yaml文件通过<code>kubectl apply -f yaml文件</code>命令执行，然后通过<code>kubectl get pvc</code>、<code>kubectl get pv</code>看到对应的pvc和pv信息，并且能在nfs共享目录下面看到对应的文件夹，那就说明没有问题</p> 
<pre><code class="prism language-shell">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nginx-pvc-2
  namespace: default
  labels:
    app: nginx-pvc-2
spec:
  storageClassName: managed-nfs-storage  <span class="token comment">## 存储类的名字，按照你自己的填写，如果设置了默认存储类，可以把不设置该值</span>
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 100m
</code></pre> 
<h3><a id="3helm_648"></a>3、安装helm</h3> 
<h4><a id="31helm_649"></a>3.1、helm安装包</h4> 
<p>链接：<a href="https://pan.baidu.com/s/1qF4zrQm8FYUqMZxMYU0aAg?pwd=ju13" rel="nofollow">https://pan.baidu.com/s/1qF4zrQm8FYUqMZxMYU0aAg?pwd=ju13</a></p> 
<p>提取码：<code>ju13</code></p> 
<h4><a id="32_654"></a>3.2、解压</h4> 
<pre><code class="prism language-shell"><span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> helm-v3.5.4-linux-amd64.tar.gz
</code></pre> 
<h4><a id="33_659"></a>3.3、移动</h4> 
<pre><code class="prism language-shell"><span class="token function">mv</span> linux-amd64/helm /usr/local/bin/helm
</code></pre> 
<h4><a id="34_664"></a>3.4、验证</h4> 
<pre><code class="prism language-powershell">helm
</code></pre> 
<h4><a id="35repo_669"></a>3.5、添加repo仓库</h4> 
<pre><code class="prism language-powershell">helm repo add bitnami https:<span class="token operator">/</span><span class="token operator">/</span>charts<span class="token punctuation">.</span>bitnami<span class="token punctuation">.</span>com/bitnami
</code></pre> 
<p>仓库说明：默认仓库是hub，常用的第三方仓库是<code>bitnami</code>，这些仓库都隶属于<a href="https://artifacthub.io/" rel="nofollow">https://artifacthub.io/</a>平台<br> <img src="https://images2.imgbox.com/4f/8d/AQFPNmgw_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4prometheusgrafana_676"></a>4、安装prometheus和grafana</h3> 
<h4><a id="41charts_677"></a>4.1、charts下载</h4> 
<p>在linux上找个合适的位置新建目录，然后进入目录之后依次执行下面脚本</p> 
<pre><code class="prism language-bash"><span class="token comment"># 1、添加仓库</span>
helm repo <span class="token function">add</span> prometheus-community https://prometheus-community.github.io/helm-charts

<span class="token comment"># 2、拉取压缩包</span>
helm pull prometheus-community/kube-prometheus-stack <span class="token parameter variable">--version</span> <span class="token number">16.0</span>.0

<span class="token comment"># 3、解压压缩包</span>
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> kube-prometheus-stack-16.0.0.tgz
</code></pre> 
<p>来源：<br> <a href="https://artifacthub.io/packages/helm/prometheus-community/kube-prometheus-stack?modal=install" rel="nofollow">https://artifacthub.io/packages/helm/prometheus-community/kube-prometheus-stack?modal=install</a></p> 
<h4><a id="42valuesyaml_692"></a>4.2、修改values.yaml</h4> 
<p>进入解压之后的<code>kube-prometheus-stack</code>目录，然后将<code>values.yaml</code>通过<code>xftp</code>拉到windows桌面上，之后打开<code>values.yaml</code>，搜索<code>adminPassword</code>，然后将<code>prom-operator</code>修改成<strong>grafana</strong>的密码，用于登录grafana，比如<code>admin123456</code>，修改完成效果如下：</p> 
<p><img src="https://images2.imgbox.com/23/80/10HMSQia_o.png" alt="在这里插入图片描述"><br> 然后将<code>values.yaml</code>通过xftp传到linux上，并且覆盖<code>values.yaml</code></p> 
<h4><a id="43_698"></a>4.3、导入镜像</h4> 
<p>有部分镜像是外国网站的，我们直接拉取会失败，所以我给大家已经准备好了，大家直接下载导入即可，其中<code>quay.io_prometheus_node-exporter_v1.1.2.tar</code>要导入所有节点中（包括主节点）；而<code>quay.io_prometheus_alertmanager_v0.21.0.tar</code>、<code>quay.io_prometheus_prometheus_v2.26.0.tar</code>、<code>k8s.gcr.io_kube-state-metrics_kube-state-metrics_v2.0.0.tar</code>只需要导入工作节点就可以了，其中导入命令如下：<code>docker load -i 镜像tar包名称</code></p> 
<p>其中百度网盘链接如下：</p> 
<p>链接：<a href="https://pan.baidu.com/s/17q8QX-LRfxyaSTl9arsvcw?pwd=wxyb" rel="nofollow">https://pan.baidu.com/s/17q8QX-LRfxyaSTl9arsvcw?pwd=wxyb</a></p> 
<p>提取码：<code>wxyb</code></p> 
<h4><a id="44_708"></a>4.4、创建命名空间</h4> 
<p>未来我们的<code>prometheus</code>和<code>grafana</code>的相关内容都会安装到这个命名空间下面</p> 
<pre><code class="prism language-bash">kubectl create ns monitor
</code></pre> 
<h4><a id="45_715"></a>4.5、安装</h4> 
<p>在我们解压之后的<code>kube-prometheus-stack</code>目录中执行下述命令即可，执行过程中会出现很多warn信息，这个不需要关注</p> 
<pre><code class="prism language-bash">helm <span class="token function">install</span> <span class="token parameter variable">-f</span> values.yaml prometheus-stack ./ <span class="token parameter variable">-n</span> monitor
</code></pre> 
<h4><a id="46pod_721"></a>4.6、保证pod运行完好</h4> 
<p>通过<code>kubectl get pod -n monitor</code>查看pod运行情况，如果所有的pod状态都是<code>Running</code>，并且<code>READY</code>比例都是1，那就正常了，例如：</p> 
<p><img src="https://images2.imgbox.com/39/d4/NU0rswXb_o.png" alt="在这里插入图片描述"><br> 如果不正常的话，可以通过<code>kubectl describe pod pod名称 -n 命名空间</code>查看原因并解决</p> 
<h4><a id="47prometheusgrafanaservice_727"></a>4.7、改变prometheus、grafana的service暴露方式</h4> 
<p><strong>更改原因：</strong></p> 
<p>默认<code>prometheus</code>、<code>grafana</code>的<code>service</code>暴露方式都是<code>ClusterIP</code>，这种方式无法在浏览器上直接访问，所以我们需要把<code>service</code>暴露方式改成<code>NodePort</code></p> 
<p><strong>更改方式：</strong></p> 
<p>使用<code>一、使用kubeadmin方式安装k8s</code> 》 <code>6.4、访问k8s-dashboard</code>访问<code>k8s dashboard</code>，然后将更改命名空间为<code>monitor</code>，之后点击<code>服务</code>下面的<code>Services</code>，如下：</p> 
<p><img src="https://images2.imgbox.com/98/c9/FRedCtCg_o.png" alt="在这里插入图片描述"><br> 之后分别点击<code>prometheus-stack-grafana</code>和<code> prometheus-stack-kube-prom-prometheus</code>进行更改操作，我们以<code>prometheus-stack-grafana</code>举例，点击<code>prometheus-stack-grafana</code>之后，需要点击右上角的修改按钮，如下：</p> 
<p><img src="https://images2.imgbox.com/43/9a/7UmuOouG_o.png" alt="在这里插入图片描述"></p> 
<p>然后将<code>ClusterIp</code>切换成<code>NodePort</code>，点击<code>更新</code>按钮</p> 
<p><img src="https://images2.imgbox.com/1e/88/2p3PjVTc_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="48prometheusgrafana_746"></a>4.8、使用浏览器访问prometheus、grafana</h4> 
<p><strong>grafana：</strong></p> 
<p>使用<code>kubectl get service -A -owide | grep prometheus-stack-grafana</code>查看<strong>grafana</strong>的访问端口，比如我的是<code>30088</code>，如下：</p> 
<p><img src="https://images2.imgbox.com/d3/ca/MWfQScgg_o.png" alt="在这里插入图片描述"></p> 
<p>然后通过<code>http://虚拟机ip:30088</code>就可以访问grafana了，比如我的就是<code>http://192.168.139.128:30088</code>（注意：协议是http）</p> 
<p>登录页面的用户名是<code>admin</code>，登录密码是<code>4.2、修改values.yaml</code>中设置的，比如我的就是<code>admin123456</code></p> 
<p><img src="https://images2.imgbox.com/50/57/cua9tOB5_o.png" alt="在这里插入图片描述"></p> 
<p><strong>prometheus：</strong></p> 
<p>使用<code>kubectl get service -A -owide | grep prometheus-stack-kube-prom-prometheus</code>查看<strong>prometheus</strong>的访问端口，比如我的是<code>30099</code>，如下：</p> 
<p><img src="https://images2.imgbox.com/e3/34/gPIYLnn3_o.png" alt="在这里插入图片描述"></p> 
<p>然后通过<code>http://虚拟机ip:30099</code>就可以访问prometheus了，比如我的就是<code>http://192.168.139.128:30099</code>（注意：协议是http）</p> 
<p><img src="https://images2.imgbox.com/27/55/guDSN9qo_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="49grafanak8sdashboard_772"></a>4.9、在grafana中导入查看k8s集群信息的dashboard页面</h4> 
<p><strong>1、查找对应脚本</strong></p> 
<p>访问<a href="https://grafana.com/grafana/dashboards/" rel="nofollow">GrafanaLabs</a>，大家可以寻找任何自己想要的内容，本次我选择的是<a href="https://grafana.com/grafana/dashboards/13105-1-k8s-for-prometheus-dashboard-20211010/" rel="nofollow">K8S for Prometheus Dashboard 20211010中文版</a></p> 
<p><strong>2、查找ID</strong></p> 
<p><img src="https://images2.imgbox.com/f7/0a/jZhysWGn_o.png" alt="在这里插入图片描述"><br> <strong>3、在grafana中导入ID的准备工作</strong></p> 
<p>如果点击<code>Import</code>之后有弹窗，那么点击第二个按钮就可以了</p> 
<p><img src="https://images2.imgbox.com/ee/d4/WCfvRA54_o.png" alt="在这里插入图片描述"><br> <strong>4、执行ID导入操作</strong></p> 
<p>粘贴<code>ID</code>，点击<code>Load</code>按钮，如下：</p> 
<p><img src="https://images2.imgbox.com/c0/90/Qz7IwMFs_o.png" alt="在这里插入图片描述"></p> 
<p>然后修改信息后进行导入操作，如下：</p> 
<p><img src="https://images2.imgbox.com/49/3e/9fIn8C9a_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5harbor_794"></a>5、安装harbor</h3> 
<h4><a id="51charts_795"></a>5.1、charts下载</h4> 
<pre><code class="prism language-bash"><span class="token comment"># 添加仓库</span>
helm repo <span class="token function">add</span> --insecure-skip-tls-verify harbor https://helm.goharbor.io

<span class="token comment"># 拉取镜像</span>
helm pull --insecure-skip-tls-verify harbor/harbor <span class="token parameter variable">--version</span> <span class="token number">1.10</span>.2

<span class="token comment"># 解压tgz压缩包</span>
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> harbor-1.10.2.tgz
</code></pre> 
<h4><a id="52valuesyaml_807"></a>5.2、修改values.yaml</h4> 
<p>进入解压的<code>harbor</code>目录中，将<code>values.yaml</code>传输到windows上，需要修改如下位置：</p> 
<p>更改<code>expose</code>》<code>type</code>的值为<code>nodePort</code>、<code>expose</code>》<code>tls</code>》<code>enabled</code>的值为<code>false</code></p> 
<p>更改<code>expose</code>》<code>externalURL</code>的值为<code>http://主节点ip:30002</code>（注意：30002是harbor的service对外暴露的端口，这个是定死的端口）</p> 
<p>替换所有<code>storageClass: ""</code>为<code>storageClass: "存储类名称"</code>（说明：比如我用的nfs动态存储，那就是managed-nfs-storage-bakckup，其中<code>nfs动态供应配置方式</code>在<code>二、安装其他组件</code>》<code>2、安装nfs动态供应</code>中；如果你用的ceph存储，那就换成ceph的存储类名称即可）</p> 
<p>修改<code>harborAdminPassword</code>的值为你想设置的<code>harbor</code>密码</p> 
<p>上述操作截图如下：</p> 
<p><img src="https://images2.imgbox.com/e3/13/ib4YwBnq_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/21/c5/Pp43lCAU_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/10/6a/2tAPryjT_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/51/f2/9vk7rWSG_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="53_831"></a>5.3、导入镜像</h4> 
<p>有部分镜像是外国网站的，我们直接拉取会失败，所以我给大家已经准备好了，大家直接下载导入即可，这些tar包都只需要导入工作节点就可以了，其中导入命令如下：<code>docker load -i 镜像tar包名称</code></p> 
<p>其中百度网盘链接如下：</p> 
<p>链接：<a href="https://pan.baidu.com/s/1qPUvsnYz0guWg3khALRKTA?pwd=i1sc" rel="nofollow">https://pan.baidu.com/s/1qPUvsnYz0guWg3khALRKTA?pwd=i1sc</a></p> 
<p>提取码：<code>i1sc</code></p> 
<h4><a id="54_841"></a>5.4、创建命名空间</h4> 
<p>未来我们的<code>harbor</code>会安装到这个命名空间下面</p> 
<pre><code class="prism language-bash">kubectl create ns devops
</code></pre> 
<h4><a id="55_849"></a>5.5、安装</h4> 
<p>在我们解压之后的<code>harbor</code>目录中执行下述命令即可</p> 
<pre><code class="prism language-bash">helm <span class="token function">install</span> <span class="token parameter variable">-f</span> values.yaml harbor ./ <span class="token parameter variable">-n</span> devops
</code></pre> 
<h4><a id="56pod_856"></a>5.6、保证pod运行完好</h4> 
<p>通过<code>kubectl get pod -n devops</code>查看pod运行情况，如果所有的pod状态都是<code>Running</code>，并且<code>READY</code>比例都是1，那就正常了，例如：</p> 
<p><img src="https://images2.imgbox.com/69/4f/YVkCsKtR_o.png" alt="在这里插入图片描述"></p> 
<p>如果不正常的话，可以通过<code>kubectl describe pod pod名称 -n 命名空间</code>查看原因并解决</p> 
<p>如果pod长期不正常，可以通过<code>kubectl delete pod pod名称 -n 命名空间</code>删除pod之后在重新生成pod</p> 
<p>如果多个pod都不正常，我们也可以在harbor解压目录中通过<code>helm uninstall harbor -n devops</code>来删除老的部署，然后在重新通过<code>helm install -f values.yaml harbor ./ -n devops</code>来进行部署</p> 
<h4><a id="57harbor_868"></a>5.7、使用浏览器访问harbor</h4> 
<p>直接在浏览器上访问<code>http://主节点ip:30002</code>访问就可以了，其中用户名是<code>admin</code>，密码是你在<code>values.yaml</code>中的修改的<code>harborAdminPassword</code>值，比如我的就是<code>admin123456</code>，其中默认值是<code>Harbor12345</code></p> 
<p><img src="https://images2.imgbox.com/f4/6f/nkgKKOrE_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="58linuxdocker_login_XXXharbor_873"></a>5.8、在linux上使用docker login XXX方式登录harbor</h4> 
<h5><a id="_874"></a>注意事项</h5> 
<p>在所有机器（包含主节点+工作节点）上的<code>/etc/docker/daemon.json</code>都需要配置<code>insecure-registries</code>，其中<code>insecure-registries</code>是一个数组，而数组中唯一值就是<code>主节点ip:30002</code>（说明：主节点ip:30002是在浏览器上访问harbor的连接地址）</p> 
<h5><a id="_877"></a>操作步骤</h5> 
<h6><a id="581daemonjson_878"></a>5.8.1、更改所有节点的daemon.json</h6> 
<p><strong><code>注意：</code>以下操作需要在所有节点都执行</strong></p> 
<p>使用<code>vim /etc/docker/daemon.json</code>打开<code>daemon.json</code></p> 
<p>将<code>"insecure-registries": ["主节点ip:30002"]</code>添加到文件后面；比如我在浏览器上访问harbor的连接地址是<code>192.168.139.128:30002</code>，那我的<code>daemon.json</code>配置内容如下，其中阿里云镜像加速器的配置不用管它就行</p> 
<pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"https://a3e6u0iu.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>,
  <span class="token string">"insecure-registries"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.139.128:30002"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="582docker_893"></a>5.8.2、重启docker</h6> 
<pre><code class="prism language-bash">systemctl restart <span class="token function">docker</span>
</code></pre> 
<h6><a id="583linuxharbor_898"></a>5.8.3、测试在linux上登录harbor</h6> 
<p>在linux上输入<code>docker login 主节点ip:30002</code>回车即可，比如我的就是<code>docker login 192.168.139.128:30002</code>，然后依次输入用户名回车、输入密码回车就可以登录harbor了，如下：</p> 
<p><img src="https://images2.imgbox.com/90/93/SF7yFvxs_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="59dockerharbor_903"></a>5.9、测试通过docker命令推送镜像到harbor</h4> 
<p>本次测试推送<code>busybox</code>到harbor仓库</p> 
<p>首先通过<code>docker pull busybox</code>下载busybox镜像</p> 
<p>然后将镜像打成符合推送要求的样子，命令是：<code>docker tag 本地镜像名称:本地镜像版本号 仓库访问地址/项目名称/推送到harbor仓库的镜像名称:推送到harbor仓库的镜像版本号</code>，比如我的就是：</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> tag busybox:latest <span class="token number">192.168</span>.139.128:30002/test/busybox:v1.0.0
</code></pre> 
<p>解释如下：</p> 
<ul><li> <p>busybox:latest：本地镜像名称:本地镜像版本号</p> </li><li> <p>192.168.139.128:30002：harbor访问地址<br> <img src="https://images2.imgbox.com/f2/b8/655ZUjSg_o.png" alt="在这里插入图片描述"></p> </li><li> <p>test：harbor仓库中的项目名称<br> <img src="https://images2.imgbox.com/0e/0f/pRYvtM7v_o.png" alt="在这里插入图片描述"></p> </li><li> <p>busybox：harbor仓库中的镜像名称<br> <img src="https://images2.imgbox.com/50/b4/C49ZkEFk_o.png" alt="在这里插入图片描述"></p> </li><li> <p>v1.0.0：harbor仓库中的镜像版本号<br> <img src="https://images2.imgbox.com/6c/ba/nrYwoNB8_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<p>然后把镜像推送到harbor仓库中就可以了（注意：推送之前记得在harbor控制台页面中创建test项目），命令是：<code>docker push 仓库访问地址/项目名称/推送到harbor仓库的镜像名称:推送到harbor仓库的镜像版本号</code>，比如我的就是：</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> push <span class="token number">192.168</span>.139.128:30002/test/busybox:v1.0.0
</code></pre> 
<p>命令执行完成效果如下：</p> 
<p><img src="https://images2.imgbox.com/30/e9/IKhbcuWT_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="510dockerharbor_936"></a>5.10、测试通过docker命令从harbor仓库下载镜像</h4> 
<p>首先删除同名镜像，命令是：<code>docker rmi 仓库访问地址/项目名称/镜像名称:镜像版本号</code>，例如：</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> rmi <span class="token number">192.168</span>.139.128:30002/test/busybox:v1.0.0
</code></pre> 
<p>然后下载镜像，命令是：<code>docker pull 仓库访问地址/项目名称/镜像名称:镜像版本号</code>，例如：</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> pull <span class="token number">192.168</span>.139.128:30002/test/busybox:v1.0.0
</code></pre> 
<p>命令执行完成效果如下：</p> 
<p><img src="https://images2.imgbox.com/b3/67/lEffpqPz_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="6jenkins_953"></a>6、安装jenkins</h3> 
<h4><a id="61_954"></a>6.1、导入镜像</h4> 
<p>由于jenkins镜像下载比较慢，我在这里给大家提供<code>jenkins/jenkins:2.396</code>镜像tar包，大家可以通过命令<code>docker load -i 镜像tar包名称</code>进行导入，镜像在下面</p> 
<p>其中百度网盘链接如下：</p> 
<p>链接：<a href="https://pan.baidu.com/s/1LBwsipzJuhCECdnL3fqLqg?pwd=yt1m" rel="nofollow">https://pan.baidu.com/s/1LBwsipzJuhCECdnL3fqLqg?pwd=yt1m</a></p> 
<p>提取码：<code>yt1m</code></p> 
<h4><a id="62jenkinsyaml_964"></a>6.2、创建jenkins.yaml</h4> 
<pre><code class="prism language-bash">apiVersion: v1
kind: Namespace
metadata:
  name: jenkins

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: settings.xml
  namespace: jenkins
data:
  settings.xml: <span class="token string">"&lt;?xml version=<span class="token entity" title='\"'>\"</span>1.0<span class="token entity" title='\"'>\"</span> encoding=<span class="token entity" title='\"'>\"</span>UTF-8<span class="token entity" title='\"'>\"</span>?&gt;<span class="token entity" title="\n">\n</span>&lt;settings xmlns=<span class="token entity" title='\"'>\"</span>http://maven.apache.org/SETTINGS/1.0.0<span class="token entity" title='\"'>\"</span><span class="token entity" title="\n">\n</span>          xmlns:xsi=<span class="token entity" title='\"'>\"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token entity" title='\"'>\"</span><span class="token entity" title="\n">\n</span>          xsi:schemaLocation=<span class="token entity" title='\"'>\"</span>http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd<span class="token entity" title='\"'>\"</span>&gt;<span class="token entity" title="\n">\n</span>  <span class="token entity" title="\n">\n</span>    &lt;!-- 首先/var/jenkins_home是jenkins容器用的地址，本次我们用的是nfs来存储该地址，所以我们要在nfs目录中提前创建好maven_repository目录 --&gt;<span class="token entity" title="\n">\n</span>    &lt;localRepository&gt;/var/jenkins_home/maven_repository&lt;/localRepository&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>  &lt;pluginGroups&gt;<span class="token entity" title="\n">\n</span>  &lt;/pluginGroups&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>  &lt;proxies&gt;<span class="token entity" title="\n">\n</span>  &lt;/proxies&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>  &lt;servers&gt;<span class="token entity" title="\n">\n</span>  &lt;/servers&gt;<span class="token entity" title="\n">\n</span>  &lt;mirrors&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span><span class="token entity" title="\n">\n</span>    &lt;mirror&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>  &lt;id&gt;central&lt;/id&gt;    <span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>  &lt;name&gt;central&lt;/name&gt;      <span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>  &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;   <span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>  &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;    <span class="token entity" title="\n">\n</span>    &lt;/mirror&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span><span class="token entity" title="\n">\n</span>  &lt;/mirrors&gt;<span class="token entity" title="\n">\n</span>  &lt;profiles&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>&lt;!-- 自己配置，目的是避免使用错误的jre版本 --&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>&lt;profile&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>  &lt;id&gt;jdk-1.8&lt;/id&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>  <span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>  &lt;activation&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span><span class="token entity" title="\t">\t</span>&lt;activeByDefault&gt;true&lt;/activeByDefault&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span><span class="token entity" title="\t">\t</span>&lt;jdk&gt;1.8&lt;/jdk&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>  &lt;/activation&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>  &lt;properties&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span><span class="token entity" title="\t">\t</span>&lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span><span class="token entity" title="\t">\t</span>&lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span><span class="token entity" title="\t">\t</span>&lt;maven.compiler.compilerVersion&gt;1.8&lt;/maven.compiler.compilerVersion&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>  &lt;/properties&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>&lt;/profile&gt;<span class="token entity" title="\n">\n</span>  &lt;/profiles&gt;<span class="token entity" title="\n">\n</span>&lt;/settings&gt;<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>"</span>

---

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: jenkins
  namespace: jenkins
spec:
  selector:
    matchLabels:
      app: jenkins <span class="token comment"># has to match .spec.template.metadata.labels</span>
  serviceName: <span class="token string">"jenkins"</span>
  replicas: <span class="token number">1</span>
  template:
    metadata:
      labels:
        app: jenkins <span class="token comment"># has to match .spec.selector.matchLabels</span>
    spec:
      serviceAccountName: <span class="token string">"jenkins"</span>
      terminationGracePeriodSeconds: <span class="token number">10</span>
      containers:
      - name: jenkins
        image: jenkins/jenkins:2.396
        imagePullPolicy: IfNotPresent
        securityContext:                     
          runAsUser: <span class="token number">0</span>                      <span class="token comment">#设置以ROOT用户运行容器，对docker文件的权限赋予以及运行起到了很大的帮助作用</span>
          privileged: <span class="token boolean">true</span>                  <span class="token comment">#拥有特权</span>
        ports:
        - containerPort: <span class="token number">8080</span>
          name: web
        - name: jnlp                        <span class="token comment">#jenkins slave与集群的通信口</span>
          containerPort: <span class="token number">50000</span>
        volumeMounts:
        - mountPath: /var/jenkins_home
          name: jenkins-home
        - mountPath: /var/run/docker.sock
          name: <span class="token function">docker</span>
        - mountPath: /usr/bin/docker
          name: docker-home
        - mountPath: /etc/localtime
          name: localtime
        - mountPath: /var/jenkins_home/maven_config/settings.xml
          name: mvn-setting
          subPath: settings.xml
      volumes:
      - nfs:
          server: <span class="token number">192.168</span>.139.133 <span class="token comment"># nfs的主机ip，要用master节点的ip，这位后来k8s执行YamlStatefulSet.yaml文件做准备工作</span>
          path: /nfs/data/jenkins_home <span class="token comment"># 我的主机nfs路径是/nfs/data，然后/nfs/data/jenkins_home目录是我在执行此yaml之前提前就要创建好的</span>
        name: jenkins-home
      - hostPath:
          path: /var/run/docker.sock
        name: <span class="token function">docker</span>
      - hostPath:
          path: /usr/bin/docker <span class="token comment"># 注意docker在主机的安装位置，部分docker版本在/usr/local/bin/docker中</span>
        name: docker-home
      - hostPath: <span class="token comment"># 将主机的时间文件挂载到容器内部</span>
          path: /usr/share/zoneinfo/Asia/Shanghai
        name: localtime
      - configMap:
          items:
            - key: settings.xml
              path: settings.xml
          name: settings.xml
        name: mvn-setting

---

apiVersion: v1
kind: Service
metadata:
  name: jenkins
  namespace: jenkins
spec:
  selector:
    app: jenkins
  type: NodePort
  ports:
  - name: web
    port: <span class="token number">8080</span>
    targetPort: <span class="token number">8080</span>
    protocol: TCP
  - name: jnlp
    port: <span class="token number">50000</span>
    targetPort: <span class="token number">50000</span>
    protocol: TCP

---

apiVersion: v1
kind: ServiceAccount
metadata:
  name: jenkins
  namespace: jenkins

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: jenkins
rules:
  - apiGroups: <span class="token punctuation">[</span><span class="token string">"extensions"</span>, <span class="token string">"apps"</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"deployments"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"create"</span>, <span class="token string">"delete"</span>, <span class="token string">"get"</span>, <span class="token string">"list"</span>, <span class="token string">"watch"</span>, <span class="token string">"patch"</span>, <span class="token string">"update"</span><span class="token punctuation">]</span>
  - apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"services"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"create"</span>, <span class="token string">"delete"</span>, <span class="token string">"get"</span>, <span class="token string">"list"</span>, <span class="token string">"watch"</span>, <span class="token string">"patch"</span>, <span class="token string">"update"</span><span class="token punctuation">]</span>
  - apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"create"</span>,<span class="token string">"delete"</span>,<span class="token string">"get"</span>,<span class="token string">"list"</span>,<span class="token string">"patch"</span>,<span class="token string">"update"</span>,<span class="token string">"watch"</span><span class="token punctuation">]</span>
  - apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"pods/exec"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"create"</span>,<span class="token string">"delete"</span>,<span class="token string">"get"</span>,<span class="token string">"list"</span>,<span class="token string">"patch"</span>,<span class="token string">"update"</span>,<span class="token string">"watch"</span><span class="token punctuation">]</span>
  - apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"pods/log"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span>,<span class="token string">"list"</span>,<span class="token string">"watch"</span><span class="token punctuation">]</span>
  - apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"secrets"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">]</span>
---

kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: jenkins
subjects:
  - kind: ServiceAccount
    name: jenkins
    namespace: jenkins
roleRef:
  kind: ClusterRole
  name: jenkins
  apiGroup: rbac.authorization.k8s.io
</code></pre> 
<h4><a id="63jenkinsyaml_1114"></a>6.3、应用jenkins.yaml</h4> 
<p><strong>提前创建目录：</strong></p> 
<ul><li> <p>在master节点的主机上创建<code>/nfs/data/jenkins_home</code>目录：<br> 其中<code>/nfs/data</code>是nfs目录，<code>jenkins_home</code>需要我们新建<br> 针对yaml文件中对<code>jenkins</code>工作目录<code>/var/jenkins_home</code>的要求，首先我们要在nfs主机目录（我的主机nfs目录是<code>/nfs/data</code>）中创建<code>jenkins_home</code>目录（如下所示），我们这样做的目的是为master节点的k8s执行<code>YamlStatefulSet.yaml</code>文件准备的，jenkins会把gitee中的项目拉到工作目录（即<code>/var/jenkins_home</code>）下，并且jenkins工作目录目前在主机的<code>nfs</code>目录下，然后主机的<code>k8s</code>也能用到<code>nfs</code>目录，这样我们在jenkins中通过SSH插件来调用master节点的k8s就能够执行<code>YamlStatefulSet.yaml</code>文件了<br> <img src="https://images2.imgbox.com/3d/4e/SfsKAzII_o.png" alt="在这里插入图片描述"></p> </li><li> <p>在master节点的主机上创建<code>/nfs/data/jenkins_home/maven_repository</code>目录：<br> 其中<code>/nfs/data</code>是nfs目录，<code>jenkins_home</code>需要我们新建，<code>maven_repository</code>需要我们新建<br> 按照<code>ConfigMap</code>中的<code>settings.xml</code>文件配置，我们需要为maven仓库创建对应的目录，未来我们的maven容器是运行在jenkins之中的，所以jenkins的工作空间maven容器也能用，因此我们写的Maven仓库路径是<code>/var/jenkins_home/maven_repository</code>，这个路径就是jenkins的工作目录，但是现在jenkins的工作目录在master节点的nfs目录下，即<code>/nfs/data/jenkins_home</code>，所以我们需要在<code>/nfs/data/jenkins_home</code>下面在创建<code>maven_repository</code>目录，如下：<br> <img src="https://images2.imgbox.com/c7/3d/AN4u2BhC_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<p><strong>执行yaml文件：</strong></p> 
<pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> jenkins.yaml
</code></pre> 
<h4><a id="64jenkins_1133"></a>6.4、访问jenkins</h4> 
<p>直接在浏览器上输入<code>主机ip:8080对应的nodePort</code>回车即可访问，比如：<code>http://192.168.139.128:31586</code></p> 
<p><img src="https://images2.imgbox.com/c9/8a/vV4PFwfr_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="65_Jenkins_1140"></a>6.5、解锁 Jenkins</h4> 
<p>首次访问需要解锁，通过<code>docker logs jenkins容器id</code>可以查询到初始管理员密码，如果是通过k8s，可以通过k8s日志去查看密码，如下：</p> 
<p><img src="https://images2.imgbox.com/8b/85/4HbVTMwG_o.png" alt="在这里插入图片描述"></p> 
<p>将上图红框框标出来的粘贴到登录页面登录即可，如下：</p> 
<p><img src="https://images2.imgbox.com/c5/5a/ZzVKqdqg_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="66_1148"></a>6.6、插件下载</h4> 
<p>直接点击第一个按钮，下载推荐的插件即可</p> 
<p>如果多次尝试下载插件都没有成功，大家也可以点击继续，我这边会把相关插件提供给大家，大家只需要把jenkins的nfs存储中<code>/var/jenkins_home/</code>中plugins目录下的内容换成下面目录中的就可以了</p> 
<p>其中百度网盘链接如下：</p> 
<p>链接：<a href="https://pan.baidu.com/s/12Gaa8UwcW6NM6y9TFM0kkQ?pwd=hwdl" rel="nofollow">https://pan.baidu.com/s/12Gaa8UwcW6NM6y9TFM0kkQ?pwd=hwdl</a></p> 
<p>提取码：<code>hwdl</code></p> 
<p><img src="https://images2.imgbox.com/c0/81/SwzJAYkW_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="67_1161"></a>6.7、创建第一个管理员用户</h4> 
<p>建议取一个好记忆的，比如用户名/密码：<code>admin / admin123456</code></p> 
<h4><a id="68_1164"></a>6.8、实例配置</h4> 
<p>点击<strong>保存并完成</strong>按钮即可，如下：</p> 
<p><img src="https://images2.imgbox.com/c3/d9/LpvMUp0U_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="69jenkins_1168"></a>6.9、更改jenkins插件镜像源</h4> 
<p>点击<strong>系统管理</strong>按钮，如下：</p> 
<p><img src="https://images2.imgbox.com/28/37/ulgHFSLk_o.png" alt="在这里插入图片描述"></p> 
<p>点击<strong>插件管理</strong>按钮，如下：</p> 
<p><img src="https://images2.imgbox.com/cb/cc/XRoYCAj7_o.png" alt="在这里插入图片描述"></p> 
<p>点击<strong>高级</strong>按钮，如下：</p> 
<p><img src="https://images2.imgbox.com/51/98/5dmcT6f0_o.png" alt="在这里插入图片描述"></p> 
<p>然后把页面滑到最下方，使用<code>http://mirror.xmission.com/jenkins/updates/current/update-center.json</code>替换掉<strong>升级站点</strong>》<strong>URL</strong>下文本框中的内容，点击<strong>保存</strong>按钮，如下：</p> 
<p><img src="https://images2.imgbox.com/41/b4/7sZR1Qbv_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="610public_over_sshjenkins_1185"></a>6.10、使用public over ssh插件完成jenkins构建全过程</h4> 
<h5><a id="6101publish_over_ssh_1186"></a>6.10.1、安装publish over ssh插件</h5> 
<p>首先在jenkins系统首页左侧找到系统管理，如下：</p> 
<p><img src="https://images2.imgbox.com/e8/6e/AUsr6pwk_o.png" alt="在这里插入图片描述"></p> 
<p>然后往下滑动页面，找到插件管理，如下：</p> 
<p><img src="https://images2.imgbox.com/19/17/rpfZnaYu_o.png" alt="在这里插入图片描述"></p> 
<p>然后在左侧选中<code>Available plugins</code>，然后在右侧搜索框中输入<code>publish over ssh</code>安装即可，我这里是已经安装过了，所以无法搜索出来</p> 
<p><img src="https://images2.imgbox.com/4b/25/Oy5O4e3T_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="6102ssh_1200"></a>6.10.2、配置ssh连接信息</h5> 
<p>找到<strong>系统配置</strong>，如下：</p> 
<p><img src="https://images2.imgbox.com/26/a5/rfWQr14d_o.png" alt="在这里插入图片描述"></p> 
<p>找到<code>Publish over SSH</code>，如下：</p> 
<p><img src="https://images2.imgbox.com/d7/7b/snZ8FMnA_o.png" alt="在这里插入图片描述"></p> 
<p>点击<strong>新增</strong>按钮，在下面需要k8s主节点的连接信息，并且该主节点的<code>nfs</code>目录就是jenkins的<code>/var/jenkins_home</code>所在的nfs目录，如下：</p> 
<p><img src="https://images2.imgbox.com/49/9d/o1xYwotn_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/93/57/XVtWPMSO_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/53/8a/Lpgk3Ydy_o.png" alt="在这里插入图片描述"></p> 
<p>连接信息添加完成之后，点击<code>Test Configuration</code>可以进行连接测试</p> 
<h5><a id="6103_1218"></a>6.10.3、把相关项目奉上</h5> 
<p>链接：<a href="https://pan.baidu.com/s/1YhDn1dAuq10LAKK2w_Z39A?pwd=k7m5" rel="nofollow">https://pan.baidu.com/s/1YhDn1dAuq10LAKK2w_Z39A?pwd=k7m5</a></p> 
<p>提取码：<code>k7m5</code></p> 
<h5><a id="6104JenkinsFile_1223"></a>6.10.4、先来观察JenkinsFile文件内容</h5> 
<p>先介绍一下提前需要做的事情：</p> 
<ul><li>在harbor仓库中的新建相关库</li></ul> 
<p>然后简单介绍JenkinsFile中的相关步骤：</p> 
<ul><li>使用jenkins从gitee上拉取代码到工作空间</li><li>使用maven镜像打jar包</li><li>使用docker build进行镜像构建</li><li>登录harbor仓库</li><li>将镜像推送到harbor仓库</li><li>通过publish over ssh调用主节点的k8s来执行YamlStatefulSet.yaml</li><li>k8s主节点将会</li></ul> 
<pre><code class="prism language-java">pipeline <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 在任何可用的代理上，执行流水线或它的任何阶段。</span>
    agent any
    <span class="token comment">// 环境定义</span>
    environment<span class="token punctuation">{<!-- --></span>
        <span class="token comment">// gitee代码拉取下面的位置，以后进入maven容器执行操作的时候还能根据该变量回到该位置</span>
        <span class="token constant">WS</span> <span class="token operator">=</span> <span class="token string">"${WORKSPACE}"</span>
        <span class="token comment">// 服务名称，其实就是pom依赖gav是的a</span>
         <span class="token constant">SVN_FOLD</span> <span class="token operator">=</span> <span class="token function">readMavenPom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getArtifactId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// Jenkins》系统配置》Publish over SSH》Name名称，我在Jenkins中配置的是master</span>
        <span class="token constant">SSH_PATH</span> <span class="token operator">=</span> <span class="token string">"master"</span>
        <span class="token comment">// gitee分支</span>
        <span class="token constant">SVN_TYPE</span> <span class="token operator">=</span> <span class="token string">"master"</span>
        <span class="token comment">// 镜像版本号</span>
        image_tag <span class="token operator">=</span> <span class="token function">readMavenPom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// harbor仓库ip和端口</span>
        ip <span class="token operator">=</span> <span class="token string">"192.168.139.133:30002"</span>
        <span class="token comment">// 微服务端口号，从application.yaml中得知</span>
        port <span class="token operator">=</span> <span class="token string">"8090"</span>
    <span class="token punctuation">}</span>
    options <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 设置保留的最大历史构建数为6</span>
        <span class="token function">buildDiscarder</span><span class="token punctuation">(</span><span class="token function">logRotator</span><span class="token punctuation">(</span>numToKeepStr<span class="token operator">:</span> <span class="token char">'6'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 选择参数构建 是否回滚版本</span>
    parameters <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//choice choices: ['deploy', 'rollback'], name: 'status'</span>
        <span class="token function">choice</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token char">'mode'</span><span class="token punctuation">,</span> choices<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token char">'deploy'</span><span class="token punctuation">,</span>'rollback'<span class="token punctuation">]</span><span class="token punctuation">,</span> description<span class="token operator">:</span> '''deploy   发布新版本 rollback  版本回退'''<span class="token punctuation">)</span>
        <span class="token function">string</span><span class="token punctuation">(</span>name<span class="token operator">:</span> 'version_id'<span class="token punctuation">,</span> defaultValue<span class="token operator">:</span> <span class="token char">'0'</span><span class="token punctuation">,</span> description<span class="token operator">:</span> '回滚时用，如需要回滚到更早构建，请输入对应构建<span class="token constant">ID</span>，只支持最近五次构建的回滚<span class="token punctuation">,</span>发布新版本请忽略此参数'<span class="token punctuation">)</span>
        <span class="token comment">//string defaultValue: '0', name: 'version'</span>
    <span class="token punctuation">}</span>

    stages <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 构建</span>
        <span class="token function">stage</span><span class="token punctuation">(</span>'<span class="token class-name">Maven</span> <span class="token class-name">Build</span>'<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// maven代理（直接从官网拉取maven镜像）</span>
            agent <span class="token punctuation">{<!-- --></span>
                docker <span class="token punctuation">{<!-- --></span>
                    image 'maven<span class="token operator">:</span><span class="token number">3</span><span class="token operator">-</span>alpine'
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            steps <span class="token punctuation">{<!-- --></span>
                echo <span class="token char">'编译……'</span>
                sh 'pwd <span class="token operator">&amp;</span> ls <span class="token operator">-</span>alh'
                sh 'mvn <span class="token operator">--</span>version'
                echo <span class="token string">"当前工作目录：${WORKSPACE}"</span>
                echo <span class="token string">"常态工作目录：${WS}"</span>
                <span class="token comment">// sh './gradlew build'</span>
                <span class="token comment">// 执行shell命令，settings.xml配置文件来自于创建jenkins的yaml文件中的配置，也就是ConfigMap</span>
                sh 'cd $<span class="token punctuation">{<!-- --></span><span class="token constant">WS</span><span class="token punctuation">}</span> <span class="token operator">&amp;&amp;</span> mvn clean <span class="token keyword">package</span> <span class="token operator">-</span>s <span class="token string">"/var/jenkins_home/maven_config/settings.xml"</span> <span class="token operator">-</span><span class="token class-name">Dmaven</span><span class="token punctuation">.</span>test<span class="token punctuation">.</span>skip<span class="token operator">=</span><span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> pwd <span class="token operator">&amp;&amp;</span> ls <span class="token operator">-</span>alh'
                sh 'cd $<span class="token punctuation">{<!-- --></span><span class="token constant">WS</span><span class="token punctuation">}</span><span class="token operator">/</span>target <span class="token operator">&amp;&amp;</span> ls <span class="token operator">-</span>l'
                sh 'echo $<span class="token punctuation">{<!-- --></span><span class="token constant">SVN_FOLD</span><span class="token punctuation">}</span>'
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 增加回滚步骤</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token char">'回滚'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            when <span class="token punctuation">{<!-- --></span>
                environment name<span class="token operator">:</span> <span class="token char">'mode'</span><span class="token punctuation">,</span>value<span class="token operator">:</span> 'rollback'
            <span class="token punctuation">}</span>
            steps <span class="token punctuation">{<!-- --></span>
                script <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token constant">BRANCH_NAME</span><span class="token operator">==</span><span class="token char">'master'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            sh '''
								<span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{<!-- --></span>version_id<span class="token punctuation">}</span> <span class="token operator">==</span> <span class="token string">"0"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>then
									<span class="token punctuation">[</span> $<span class="token operator">?</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> echo <span class="token string">"请注意，在执行回滚时出错，故而退出构建，可立即联系运维同学处理！"</span> <span class="token operator">&amp;&amp;</span> exit <span class="token number">1</span>
									echo <span class="token string">"=============="</span>
									echo <span class="token string">"项目已回滚失败，version_id不能为0！"</span>
									echo <span class="token string">"=============="</span>
									exit <span class="token number">1</span>
								<span class="token keyword">else</span>
									echo <span class="token string">"选择回滚的版本是：${version_id}，将回滚到 ${version_id} 的制品，回滚即将进行..."</span>
									cp $<span class="token punctuation">{<!-- --></span><span class="token constant">JENKINS_HOME</span><span class="token punctuation">}</span><span class="token operator">/</span>jobs<span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">SVN_FOLD</span><span class="token punctuation">}</span><span class="token operator">/</span>branches<span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">SVN_TYPE</span><span class="token punctuation">}</span><span class="token operator">/</span>builds<span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span>version_id<span class="token punctuation">}</span><span class="token operator">/</span>archive<span class="token operator">/</span>target<span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">SVN_FOLD</span><span class="token punctuation">}</span><span class="token punctuation">.</span>jar  $<span class="token punctuation">{<!-- --></span><span class="token constant">WORKSPACE</span><span class="token punctuation">}</span><span class="token operator">/</span>target<span class="token operator">/</span>
									<span class="token punctuation">[</span> $<span class="token operator">?</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> echo <span class="token string">"请注意，在执行回滚时出错，故而退出构建，可立即联系运维同学处理！"</span> <span class="token operator">&amp;&amp;</span> exit <span class="token number">1</span>
									echo <span class="token string">"项目回滚到 ${version_id} 完成！"</span>
								fi
							'''
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            echo <span class="token string">"${err}"</span>
                            <span class="token comment">// 阶段终止</span>
                            currentBuild<span class="token punctuation">.</span>result <span class="token operator">=</span> '<span class="token constant">FAILURE</span>'
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">stage</span><span class="token punctuation">(</span>'<span class="token class-name">Docker</span> <span class="token class-name">Build</span>'<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            steps <span class="token punctuation">{<!-- --></span>
                echo '<span class="token class-name">Building</span>'
                sh <span class="token string">"echo 当前分支 : ${env.BRANCH_NAME}"</span>
                <span class="token comment">// 分支构建</span>
                script<span class="token punctuation">{<!-- --></span>
<span class="token comment">//                    if(env.BRANCH_NAME=='master'){<!-- --></span>
                        <span class="token comment">// k8s分支</span>
                        <span class="token comment">// 以下操作是登录harbor仓库、构建docker镜像、推送镜像到harbor仓库</span>
                        echo <span class="token string">"start to build '${SVN_FOLD}-${SVN_TYPE}' on test ..."</span>
                        sh '''
                            #docker rmi <span class="token operator">-</span>f $<span class="token punctuation">(</span>docker images <span class="token operator">|</span> grep <span class="token string">"none"</span> <span class="token operator">|</span> awk '<span class="token punctuation">{<!-- --></span>print $<span class="token number">3</span><span class="token punctuation">}</span>'<span class="token punctuation">)</span>
                            <span class="token constant">CID</span><span class="token operator">=</span>$<span class="token punctuation">(</span>docker ps <span class="token operator">-</span>a <span class="token operator">|</span> grep <span class="token string">"${SVN_FOLD}"</span>"<span class="token operator">-</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">SVN_TYPE</span><span class="token punctuation">}</span>" <span class="token operator">|</span> awk '<span class="token punctuation">{<!-- --></span>print $<span class="token number">1</span><span class="token punctuation">}</span>'<span class="token punctuation">)</span>
                            #<span class="token constant">IID</span><span class="token operator">=</span>$<span class="token punctuation">(</span>docker images <span class="token operator">|</span> grep <span class="token string">"${SVN_FOLD}"</span>"<span class="token operator">-</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">SVN_TYPE</span><span class="token punctuation">}</span>" <span class="token operator">|</span> awk '<span class="token punctuation">{<!-- --></span>print $<span class="token number">3</span><span class="token punctuation">}</span>'<span class="token punctuation">)</span>
                            <span class="token constant">IID</span><span class="token operator">=</span>$<span class="token punctuation">(</span>docker images <span class="token operator">|</span> grep <span class="token string">"none"</span> <span class="token operator">|</span> awk '<span class="token punctuation">{<!-- --></span>print $<span class="token number">3</span><span class="token punctuation">}</span>'<span class="token punctuation">)</span>
                            cp <span class="token string">"$WORKSPACE"</span><span class="token operator">/</span>target<span class="token comment">/*.jar "$WORKSPACE"
                            if [ -n "$IID" ]; then
                                echo "存在'${SVN_FOLD}-${SVN_TYPE}'镜像,IID='$IID'"
                                cd "$WORKSPACE"
                                ##构建镜像到远程仓库
                                docker login "${ip}" -u admin -p admin123456
                                #docker tag "${SVN_FOLD}":"${image_tag}" "${ip}"/test/"${SVN_FOLD}":"${image_tag}"
                                docker build -t "${ip}"/test/"${SVN_FOLD}""-${SVN_TYPE}":"${image_tag}" .
                                docker push "${ip}"/test/"${SVN_FOLD}""-${SVN_TYPE}":"${image_tag}"
                                rm -rf "$WORKSPACE"/*.jar
                            else
                                echo "不存在'${SVN_FOLD}-${SVN_TYPE}'镜像,开始构建镜像"
                                cd "$WORKSPACE"
                                ##构建镜像到远程仓库
                                docker login "${ip}" -u admin -p admin123456
                                #docker tag "${SVN_FOLD}":"${image_tag}" "${ip}"/test/"${SVN_FOLD}":"${image_tag}"
                                docker build -t "${ip}"/test/"${SVN_FOLD}""-${SVN_TYPE}":"${image_tag}" .
                                docker push "${ip}"/test/"${SVN_FOLD}""-${SVN_TYPE}":"${image_tag}"
                                rm -rf "$WORKSPACE"/"${SVN_FOLD}".jar
                            fi
                            '''
                        echo "Build '${SVN_FOLD}-${SVN_TYPE}' success on k8s ..."
//                    }
                }
            }
        }

        // 部署
        stage('Deploy') {
            steps {
                echo 'Deploying'
                // 分支部署
                script{
//                    if(env.BRANCH_NAME=='master'){
                        //k8s部署测试
                        echo "k8s部署测试"
                        echo "start to k8s '${SVN_FOLD}-${SVN_TYPE}' on test ..."

                    //调用Publish Over SSH插件，执行YamlStatefulSet.yaml脚本
                    sshPublisher(publishers: [sshPublisherDesc(configName: "${SSH_PATH}", transfers: [sshTransfer(cleanRemote: false, excludes: '', execCommand: """#!/bin/bash
                        # 使用k8s构建，这里需要远程执行 k8s 主节点服务器上的命令，需要先配置 ssh 免密码登录
                        kubectl delete -f /nfs/data/jenkins_home/workspace/${SVN_FOLD}/YamlStatefulSet.yaml
                        kubectl apply -f /nfs/data/jenkins_home/workspace/${SVN_FOLD}/YamlStatefulSet.yaml
                        exit 0""", execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: '[, ]+', remoteDirectory: '', remoteDirectorySDF: false, removePrefix: '', sourceFiles: '')], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: true)]
                    )
//                    }

                }
            }
        }
    }

    // 归档
    post {
        always {
            echo 'Archive artifacts'
            archiveArtifacts artifacts: "**/</span>target<span class="token comment">/*.jar", excludes: "**/</span>target"
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="6105YamlStatefulSetyaml_1404"></a>6.10.5、再来观察YamlStatefulSet.yaml文件内容</h5> 
<p>可以看到，我们去harbor仓库中拉取了镜像进行部署，用户名和密码使用的方式是全局密钥方式，k8s主节点执行该yaml文件之后，将会完成服务StatefulSet模式的部署，以及通过Service方式将浏览器访问端口8090暴露出来了</p> 
<pre><code class="prism language-java"># statefulSet yaml template
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">Service</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> java<span class="token operator">-</span>k8s<span class="token operator">-</span>demo
  namespace<span class="token operator">:</span> test
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> java<span class="token operator">-</span>k8s<span class="token operator">-</span>demo
spec<span class="token operator">:</span>
  type<span class="token operator">:</span> <span class="token class-name">NodePort</span>
  ports<span class="token operator">:</span>
    <span class="token operator">-</span> port<span class="token operator">:</span> <span class="token number">8090</span>
      targetPort<span class="token operator">:</span> <span class="token number">8090</span>
      nodePort<span class="token operator">:</span> <span class="token number">27106</span>
      name<span class="token operator">:</span> rest<span class="token operator">-</span>http
  selector<span class="token operator">:</span>
    app<span class="token operator">:</span> java<span class="token operator">-</span>k8s<span class="token operator">-</span>demo
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
kind<span class="token operator">:</span> <span class="token class-name">StatefulSet</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> java<span class="token operator">-</span>k8s<span class="token operator">-</span>demo
  namespace<span class="token operator">:</span> test
spec<span class="token operator">:</span>
  serviceName<span class="token operator">:</span> java<span class="token operator">-</span>k8s<span class="token operator">-</span>demo
  replicas<span class="token operator">:</span> <span class="token number">1</span>
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> java<span class="token operator">-</span>k8s<span class="token operator">-</span>demo
  template<span class="token operator">:</span>
    metadata<span class="token operator">:</span>
      labels<span class="token operator">:</span>
        app<span class="token operator">:</span> java<span class="token operator">-</span>k8s<span class="token operator">-</span>demo
    spec<span class="token operator">:</span>
      imagePullSecrets<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> docker<span class="token operator">-</span>login
      containers<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> java<span class="token operator">-</span>k8s<span class="token operator">-</span>demo
          image<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.139</span><span class="token number">.133</span><span class="token operator">:</span><span class="token number">30002</span><span class="token operator">/</span>test<span class="token operator">/</span>java<span class="token operator">-</span>k8s<span class="token operator">-</span>demo<span class="token operator">-</span>master<span class="token operator">:</span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span>
          imagePullPolicy<span class="token operator">:</span> <span class="token class-name">Always</span>
          ports<span class="token operator">:</span>
            <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">8090</span>
          resources<span class="token operator">:</span>
            requests<span class="token operator">:</span>
              cpu<span class="token operator">:</span> <span class="token number">100</span>m
              memory<span class="token operator">:</span> <span class="token number">100</span>Mi
  podManagementPolicy<span class="token operator">:</span> <span class="token class-name">Parallel</span>
</code></pre> 
<h5><a id="6106Dockerfile_1459"></a>6.10.6、再来观察Dockerfile文件内容</h5> 
<p>可以看到里面将8090端口暴露了出来，其他就是对时区的修改操作</p> 
<pre><code class="prism language-java"><span class="token constant">FROM</span>  openjdk<span class="token operator">:</span><span class="token number">8</span><span class="token operator">-</span>jre<span class="token operator">-</span>alpine
# 修改时区
<span class="token constant">RUN</span> ln <span class="token operator">-</span>sf <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>zoneinfo<span class="token operator">/</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Shanghai</span> <span class="token operator">/</span>etc<span class="token operator">/</span>localtime <span class="token operator">&amp;&amp;</span> echo '<span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Shanghai</span>' <span class="token operator">&gt;</span><span class="token operator">/</span>etc<span class="token operator">/</span>timezone
# 从第一阶段复制app<span class="token punctuation">.</span>jar
<span class="token constant">COPY</span> <span class="token comment">/*.jar app.jar

# 定义参数
ENV JAVA_OPTS=""
ENV PARAMS=""

# 暴露端口
EXPOSE 8090

# 启动命令
ENTRYPOINT [ "sh", "-c", "java -Djava.security.egd=file:/dev/./urandom $JAVA_OPTS -jar /app.jar $PARAMS" ]

</span></code></pre> 
<h5><a id="6107applicationproperties_1481"></a>6.10.7、再来观察application.properties文件内容</h5> 
<p>可以看到，上面Dockerfile、JenkinsFile、YamlStatefulSet.yaml中提到的8090端口就来自于该properties文件</p> 
<pre><code class="prism language-java">server<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">8090</span>
</code></pre> 
<h5><a id="6108_1489"></a>6.10.8、剩余操作</h5> 
<p>我们在Jenkins中新建一个流水线任务，其中Git仓库的信息填写Gitee中项目的路径，详细操作请看：<a href="https://blog.csdn.net/qq_42449963/article/details/128319065">尚硅谷云原生学习笔记（1-75集）》62、jenkins文件的结构</a>，然后整个流水线项目就会自动运转起来，最终完成项目的部署</p> 
<h3><a id="7dockerKuboard_1492"></a>7、使用docker安装Kuboard</h3> 
<h4><a id="71_1493"></a>7.1、安装文档</h4> 
<p><a href="https://www.kuboard.cn/install/v3/install-built-in.html#%E5%AE%89%E8%A3%85" rel="nofollow">安装 Kuboard v3</a></p> 
<h4><a id="72_1496"></a>7.2、安装命令</h4> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--restart</span><span class="token operator">=</span>unless-stopped <span class="token punctuation">\</span>
  <span class="token parameter variable">--name</span><span class="token operator">=</span>kuboard <span class="token punctuation">\</span>
  <span class="token parameter variable">-p</span> <span class="token number">30080</span>:80/tcp <span class="token punctuation">\</span>
  <span class="token parameter variable">-p</span> <span class="token number">10081</span>:10081/udp <span class="token punctuation">\</span>
  <span class="token parameter variable">-p</span> <span class="token number">10081</span>:10081/tcp <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">KUBOARD_ENDPOINT</span><span class="token operator">=</span><span class="token string">"http://虚拟机ip:30080"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">KUBOARD_AGENT_SERVER_UDP_PORT</span><span class="token operator">=</span><span class="token string">"10081"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">KUBOARD_AGENT_SERVER_TCP_PORT</span><span class="token operator">=</span><span class="token string">"10081"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">KUBOARD_ADMIN_DERAULT_PASSWORD</span><span class="token operator">=</span><span class="token string">"密码（用户名是admin，不一定生效）"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> /root/kuboard-data:/data <span class="token punctuation">\</span>
  eipwork/kuboard:v3
</code></pre> 
<p>例如：</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--restart</span><span class="token operator">=</span>unless-stopped <span class="token punctuation">\</span>
  <span class="token parameter variable">--name</span><span class="token operator">=</span>kuboard <span class="token punctuation">\</span>
  <span class="token parameter variable">-p</span> <span class="token number">30080</span>:80/tcp <span class="token punctuation">\</span>
  <span class="token parameter variable">-p</span> <span class="token number">10081</span>:10081/udp <span class="token punctuation">\</span>
  <span class="token parameter variable">-p</span> <span class="token number">10081</span>:10081/tcp <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">KUBOARD_ENDPOINT</span><span class="token operator">=</span><span class="token string">"http://192.168.139.133:30080"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">KUBOARD_AGENT_SERVER_UDP_PORT</span><span class="token operator">=</span><span class="token string">"10081"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">KUBOARD_AGENT_SERVER_TCP_PORT</span><span class="token operator">=</span><span class="token string">"10081"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">KUBOARD_ADMIN_DERAULT_PASSWORD</span><span class="token operator">=</span><span class="token string">"admin123456"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> /root/kuboard-data:/data <span class="token punctuation">\</span>
  eipwork/kuboard:v3
</code></pre> 
<h4><a id="73kuboard_1530"></a>7.3、登录kuboard</h4> 
<ul><li>默认用户名：<code>admin</code></li><li>默认密码：<code>Kuboard123</code></li></ul> 
<h4><a id="74k8skuboard_1535"></a>7.4、添加k8s集群到kuboard</h4> 
<p>点击添加集群按钮：</p> 
<p><img src="https://images2.imgbox.com/f4/9b/ncrAsQR2_o.png" alt="在这里插入图片描述"></p> 
<p>使用左侧kubeconfig的添加方式：</p> 
<p><img src="https://images2.imgbox.com/70/b0/eXhHTv2J_o.png" alt=""></p> 
<p>在k8s集群主节点中执行<code>cat .kube/config</code>指令，并且复制文件内容，然后执行以下操作：</p> 
<p><img src="https://images2.imgbox.com/f5/1b/4c4J3Skw_o.png" alt="在这里插入图片描述"></p> 
<p>最终执行结果就是：</p> 
<p><img src="https://images2.imgbox.com/b7/64/jzjvyJbX_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="8k8sgitlab_1551"></a>8、使用k8s安装gitlab</h3> 
<p><strong>说明：</strong></p> 
<p>使用<code>kubectl apply -f XXX.yaml</code>安装即可，不过安装完成之后要得很久才能访问，所以只要日志不报错就请耐心等待，如果需要删除gitlab容器，可能需要等很久，尽量不要强制删除，避免影响垃圾回收</p> 
<p><strong>参数资料：</strong></p> 
<p><a href="https://huaweicloud.csdn.net/638db4e2dacf622b8df8cc57.html" rel="nofollow">k8s部署gitlab最新版并初始化和登录</a></p> 
<pre><code class="prism language-bash">apiVersion: v1
kind: Namespace
metadata:
  name: gitlab
spec: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

---

apiVersion: v1
kind: Service
metadata:
  name: gitlab
  namespace: gitlab
spec:
  type: NodePort
  ports:
  <span class="token comment"># Port上的映射端口</span>
  - port: <span class="token number">443</span>
    targetPort: <span class="token number">443</span>
    name: gitlab443
  - port: <span class="token number">80</span>
    targetPort: <span class="token number">80</span>
    nodePort: <span class="token number">31320</span>
    name: gitlab80
  - port: <span class="token number">22</span>
    targetPort: <span class="token number">22</span>
    name: gitlab22
  selector:
    app: gitlab

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitlab
  namespace: gitlab
spec:
  selector:
    matchLabels:
      app: gitlab
  template:
    metadata:
      namespace: gitlab
      labels:
        app: gitlab
    spec:
      containers:
      <span class="token comment"># 应用的镜像</span>
      - image: gitlab/gitlab-ce 
        name: gitlab
        <span class="token comment"># 应用的内部端口</span>
        ports:
        - containerPort: <span class="token number">443</span>
          name: gitlab443
        - containerPort: <span class="token number">80</span>
          name: gitlab80
        - containerPort: <span class="token number">22</span>
          name: gitlab22
        volumeMounts:
        <span class="token comment"># gitlab持久化</span>
        - name: gitlab-config
          mountPath: /etc/gitlab
        - name: gitlab-logs
          mountPath: /var/log/gitlab
        - name: gitlab-data
          mountPath: /var/opt/gitlab
      volumes:
      <span class="token comment"># 使用nfs互联网存储</span>
      - name: gitlab-config
        persistentVolumeClaim: <span class="token comment"># 使用存储卷声明方式</span>
          claimName: gitlab-config <span class="token comment"># pvc名称</span>
      - name: gitlab-logs
        persistentVolumeClaim: <span class="token comment"># 使用存储卷声明方式</span>
          claimName: gitlab-logs <span class="token comment"># pvc名称</span>
      - name: gitlab-data
        persistentVolumeClaim: <span class="token comment"># 使用存储卷声明方式</span>
          claimName: gitlab-data <span class="token comment"># pvc名称</span>

---

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-config
  namespace: gitlab
  labels:
    app: gitlab-config
spec:
  storageClassName: managed-nfs-storage  <span class="token comment">## NFS动态供应的存储类名字，按照你自己的填写，如果设置了默认存储类，就可以不设置该值，默认也会使用默认存储类</span>
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 100m

---

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-logs
  namespace: gitlab
  labels:
    app: gitlab-logs
spec:
  storageClassName: managed-nfs-storage  <span class="token comment">## NFS动态供应的存储类名字，按照你自己的填写，如果设置了默认存储类，就可以不设置该值，默认也会使用默认存储类</span>
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi

---

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-data
  namespace: gitlab
  labels:
    app: gitlab-data
spec:
  storageClassName: managed-nfs-storage  <span class="token comment">## NFS动态供应的存储类名字，按照你自己的填写，如果设置了默认存储类，就可以不设置该值，默认也会使用默认存储类</span>
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
</code></pre> 
<h3><a id="9mysql_1693"></a>9、安装单机版mysql</h3> 
<h4><a id="91_1694"></a>9.1、创建名称空间</h4> 
<pre><code class="prism language-bash">kubectl create ns mysql
</code></pre> 
<h4><a id="92mysql57_1699"></a>9.2、创建mysql5.7</h4> 
<h5><a id="921ConfigMap_1700"></a>9.2.1、创建ConfigMap</h5> 
<p>通过<code>kubectl apply -f XXX.yaml</code>执行以下yaml文件即可</p> 
<pre><code class="prism language-bash">apiVersion: v1
data:
  my.cnf: <span class="token operator">&gt;</span>
    <span class="token punctuation">[</span>client<span class="token punctuation">]</span>

    default-character-set<span class="token operator">=</span>utf8


    <span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>

    default-character-set<span class="token operator">=</span>utf8


    <span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>

    <span class="token comment"># 设置client连接mysql时的字符集,防止乱码</span>

    <span class="token assign-left variable">init_connect</span><span class="token operator">=</span><span class="token string">'SET NAMES utf8'</span>

    <span class="token assign-left variable">init_connect</span><span class="token operator">=</span><span class="token string">'SET collation_connection = utf8_general_ci'</span>


    <span class="token comment"># 数据库默认字符集</span>

    character-set-server<span class="token operator">=</span>utf8


    <span class="token comment">#数据库字符集对应一些排序等规则，注意要和character-set-server对应</span>

    collation-server<span class="token operator">=</span>utf8_general_ci


    <span class="token comment"># 跳过mysql程序起动时的字符参数设置 ，使用服务器端字符集设置</span>

    skip-character-set-client-handshake


    <span class="token comment">#</span>
    禁止MySQL对外部连接进行DNS解析，使用这一选项可以消除MySQL进行DNS解析的时间。但需要注意，如果开启该选项，则所有远程主机连接授权都要使用IP地址方式，否则MySQL将无法正常处理连接请求！

    skip-name-resolve
kind: ConfigMap
metadata:
  name: mysql-config
  namespace: mysql
</code></pre> 
<p><strong>说明：</strong> 我们创建了一个<code>ConfigMap</code>配置的目的是把<code>my.cnf</code>配置文件提出来，生成效果如下：</p> 
<p><img src="https://images2.imgbox.com/18/96/rdFRtMX3_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="922mysqlService_1755"></a>9.2.2、创建mysql的Service</h5> 
<p>通过<code>kubectl apply -f XXX.yaml</code>执行以下yaml文件即可</p> 
<pre><code class="prism language-bash">apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
  namespace: mysql
spec:
  replicas: <span class="token number">1</span>
  selector:
    matchLabels:
      app: mysql <span class="token comment"># 匹配下面spec.template中的labels中的键值对</span>
  serviceName: mysql <span class="token comment"># 一般和service的名称一致，用来和service联合，可以用来做域名访问</span>
  template:
    metadata:
      labels:
        app: mysql <span class="token comment"># 让上面spec.selector.matchLabels用来匹配Pod</span>
    spec:
      containers:
        - env:
            - name: MYSQL_ROOT_PASSWORD <span class="token comment"># 密码</span>
              value: <span class="token string">"123456"</span>
          image: <span class="token string">'mysql:5.7'</span>
          livenessProbe: <span class="token comment"># 存活探针</span>
            exec:
              command:
                - mysqladmin
                - <span class="token string">'-uroot'</span>
                - <span class="token string">'-p${MYSQL_ROOT_PASSWORD}'</span>
                - <span class="token function">ping</span>
            failureThreshold: <span class="token number">3</span>
            initialDelaySeconds: <span class="token number">30</span>
            periodSeconds: <span class="token number">10</span>
            successThreshold: <span class="token number">1</span>
            timeoutSeconds: <span class="token number">5</span>
          name: mysql
          ports:
            - containerPort: <span class="token number">3306</span> <span class="token comment"># 容器端口</span>
              name: client
              protocol: TCP
          readinessProbe: <span class="token comment"># 就绪探针</span>
            exec:
              command:
                - mysqladmin
                - <span class="token string">'-uroot'</span>
                - <span class="token string">'-p${MYSQL_ROOT_PASSWORD}'</span>
                - <span class="token function">ping</span>
            failureThreshold: <span class="token number">3</span>
            initialDelaySeconds: <span class="token number">10</span>
            periodSeconds: <span class="token number">10</span>
            successThreshold: <span class="token number">1</span>
            timeoutSeconds: <span class="token number">5</span>
          volumeMounts: <span class="token comment"># 挂载声明</span>
            - mountPath: /etc/mysql/conf.d/my.cnf <span class="token comment"># 配置文件</span>
              name: conf
              subPath: my.cnf
            - mountPath: /var/lib/mysql <span class="token comment"># 数据目录</span>
              name: data
            - mountPath: /etc/localtime <span class="token comment"># 本地时间</span>
              name: localtime
              readOnly: <span class="token boolean">true</span>
      volumes:
        - configMap: <span class="token comment"># 配置文件使用configMap挂载</span>
            name: mysql-config
          name: conf
        - hostPath: <span class="token comment"># 本地时间使用本地文件</span>
            path: /etc/localtime
            type: File
          name: localtime
  volumeClaimTemplates: <span class="token comment"># 数据目录使用nfs动态挂载，下面的作用就是指定PVC</span>
    - apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: data <span class="token comment"># 和上面volumeMounts下面的name=data那个对应</span>
      spec:
        accessModes:
          - ReadWriteMany <span class="token comment"># 多节点读写</span>
        resources:
          requests:
            storage: 1Gi
        storageClassName: managed-nfs-storage <span class="token comment"># nfs存储类名称</span>

---

apiVersion: v1
kind: Service
metadata:
  labels:
    app: mysql
  name: mysql <span class="token comment"># 存储类名称</span>
  namespace: mysql
spec:
  ports:
    - name: tcp
      port: <span class="token number">3306</span>
      targetPort: <span class="token number">3306</span>
      nodePort: <span class="token number">32306</span>
      protocol: TCP
  selector:
    app: mysql <span class="token comment"># Pod选择器</span>
  type: NodePort
</code></pre> 
<h4><a id="93mysql802_1859"></a>9.3、创建mysql8.0.2</h4> 
<pre><code class="prism language-java">apiVersion<span class="token operator">:</span> v1
data<span class="token operator">:</span>
  my<span class="token punctuation">.</span>cnf<span class="token operator">:</span> <span class="token operator">&gt;</span><span class="token operator">-</span>
    <span class="token punctuation">[</span>client<span class="token punctuation">]</span>

    <span class="token keyword">default</span><span class="token operator">-</span>character<span class="token operator">-</span>set<span class="token operator">=</span>utf8mb4

    <span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>

    <span class="token keyword">default</span><span class="token operator">-</span>character<span class="token operator">-</span>set<span class="token operator">=</span>utf8mb4

    <span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>

    max_connections <span class="token operator">=</span> <span class="token number">2000</span>

    secure_file_priv<span class="token operator">=</span><span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>mysql

    sql_mode<span class="token operator">=</span><span class="token constant">STRICT_TRANS_TABLES</span><span class="token punctuation">,</span><span class="token constant">NO_ZERO_IN_DATE</span><span class="token punctuation">,</span><span class="token constant">NO_ZERO_DATE</span><span class="token punctuation">,</span><span class="token constant">ERROR_FOR_DIVISION_BY_ZERO</span><span class="token punctuation">,</span><span class="token constant">NO_ENGINE_SUBSTITUTION</span> # 避免严格语法，比如影响groupby使用

    skip<span class="token operator">-</span>name<span class="token operator">-</span>resolve

    open_files_limit <span class="token operator">=</span> <span class="token number">65535</span>

    table_open_cache <span class="token operator">=</span> <span class="token number">128</span>

    log_error <span class="token operator">=</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql<span class="token operator">-</span>error<span class="token punctuation">.</span>log #错误日志路径

    slow_query_log <span class="token operator">=</span> <span class="token number">1</span>

    long_query_time <span class="token operator">=</span> <span class="token number">1</span> #慢查询时间 超过<span class="token number">1</span>秒则为慢查询

    slow_query_log_file <span class="token operator">=</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql<span class="token operator">-</span>slow<span class="token punctuation">.</span>log

    <span class="token keyword">default</span><span class="token operator">-</span>storage<span class="token operator">-</span>engine <span class="token operator">=</span> <span class="token class-name">InnoDB</span> #默认存储引擎

    innodb_file_per_table <span class="token operator">=</span> <span class="token number">1</span>

    innodb_open_files <span class="token operator">=</span> <span class="token number">500</span>

    innodb_buffer_pool_size <span class="token operator">=</span> <span class="token number">64</span>M

    innodb_write_io_threads <span class="token operator">=</span> <span class="token number">4</span>

    innodb_read_io_threads <span class="token operator">=</span> <span class="token number">4</span>

    innodb_thread_concurrency <span class="token operator">=</span> <span class="token number">0</span>

    innodb_purge_threads <span class="token operator">=</span> <span class="token number">1</span>

    innodb_flush_log_at_trx_commit <span class="token operator">=</span> <span class="token number">2</span>

    innodb_log_buffer_size <span class="token operator">=</span> <span class="token number">2</span>M

    innodb_log_file_size <span class="token operator">=</span> <span class="token number">32</span>M

    innodb_log_files_in_group <span class="token operator">=</span> <span class="token number">3</span>

    innodb_max_dirty_pages_pct <span class="token operator">=</span> <span class="token number">90</span>

    innodb_lock_wait_timeout <span class="token operator">=</span> <span class="token number">120</span>

    bulk_insert_buffer_size <span class="token operator">=</span> <span class="token number">8</span>M

    myisam_sort_buffer_size <span class="token operator">=</span> <span class="token number">8</span>M

    myisam_max_sort_file_size <span class="token operator">=</span> <span class="token number">10</span>G

    myisam_repair_threads <span class="token operator">=</span> <span class="token number">1</span>

    interactive_timeout <span class="token operator">=</span> <span class="token number">28800</span>

    wait_timeout <span class="token operator">=</span> <span class="token number">28800</span>

    lower_case_table_names <span class="token operator">=</span> <span class="token number">1</span> # 使用小写table名称

    <span class="token punctuation">[</span>mysqldump<span class="token punctuation">]</span>

    quick

    max_allowed_packet <span class="token operator">=</span> <span class="token number">16</span>M #服务器发送和接受的最大包长度

    <span class="token punctuation">[</span>myisamchk<span class="token punctuation">]</span>

    key_buffer_size <span class="token operator">=</span> <span class="token number">8</span>M

    sort_buffer_size <span class="token operator">=</span> <span class="token number">8</span>M

    read_buffer <span class="token operator">=</span> <span class="token number">4</span>M

    write_buffer <span class="token operator">=</span> <span class="token number">4</span>M
kind<span class="token operator">:</span> <span class="token class-name">ConfigMap</span>
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> mysql
  name<span class="token operator">:</span> mysql8<span class="token operator">-</span>config
  namespace<span class="token operator">:</span> mysql

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
kind<span class="token operator">:</span> <span class="token class-name">StatefulSet</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> mysql8
  namespace<span class="token operator">:</span> mysql
spec<span class="token operator">:</span>
  replicas<span class="token operator">:</span> <span class="token number">1</span>
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> mysql8
  serviceName<span class="token operator">:</span> mysql8
  template<span class="token operator">:</span>
    metadata<span class="token operator">:</span>
      labels<span class="token operator">:</span>
        app<span class="token operator">:</span> mysql8
    spec<span class="token operator">:</span>
      containers<span class="token operator">:</span>
        <span class="token operator">-</span> env<span class="token operator">:</span>
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">MYSQL_ROOT_PASSWORD</span> # 设置密码
              value<span class="token operator">:</span> <span class="token string">"123456"</span>
          image<span class="token operator">:</span> 'mysql<span class="token operator">:</span><span class="token number">8.0</span><span class="token number">.29</span>'
          imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
          name<span class="token operator">:</span> mysql8
          ports<span class="token operator">:</span>
            <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">3306</span>
              name<span class="token operator">:</span> client
              protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
          resources<span class="token operator">:</span>
            limits<span class="token operator">:</span>
              cpu<span class="token operator">:</span> <span class="token char">'2'</span>
              memory<span class="token operator">:</span> <span class="token number">4</span>Gi
            requests<span class="token operator">:</span>
              cpu<span class="token operator">:</span> <span class="token char">'2'</span>
              memory<span class="token operator">:</span> <span class="token number">2</span>Gi
          volumeMounts<span class="token operator">:</span>
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>etc<span class="token operator">/</span>mysql<span class="token operator">/</span>conf<span class="token punctuation">.</span>d<span class="token operator">/</span>my<span class="token punctuation">.</span>cnf
              name<span class="token operator">:</span> conf
              subPath<span class="token operator">:</span> my<span class="token punctuation">.</span>cnf
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>etc<span class="token operator">/</span>localtime
              name<span class="token operator">:</span> localtime
              readOnly<span class="token operator">:</span> <span class="token boolean">true</span>
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>mysql
              name<span class="token operator">:</span> data
      volumes<span class="token operator">:</span>
        <span class="token operator">-</span> configMap<span class="token operator">:</span>
            name<span class="token operator">:</span> mysql8<span class="token operator">-</span>config
          name<span class="token operator">:</span> conf
        <span class="token operator">-</span> hostPath<span class="token operator">:</span>
            path<span class="token operator">:</span> <span class="token operator">/</span>etc<span class="token operator">/</span>localtime
            type<span class="token operator">:</span> <span class="token class-name">File</span>
          name<span class="token operator">:</span> localtime
  volumeClaimTemplates<span class="token operator">:</span> # 数据目录使用nfs动态挂载，下面的作用就是指定<span class="token constant">PVC</span>
    <span class="token operator">-</span> apiVersion<span class="token operator">:</span> v1
      kind<span class="token operator">:</span> <span class="token class-name">PersistentVolumeClaim</span>
      metadata<span class="token operator">:</span>
        name<span class="token operator">:</span> data # 和上面volumeMounts下面的name<span class="token operator">=</span>data那个对应
      spec<span class="token operator">:</span>
        accessModes<span class="token operator">:</span>
          <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span> # 多节点读写
        resources<span class="token operator">:</span>
          requests<span class="token operator">:</span>
            storage<span class="token operator">:</span> <span class="token number">1</span>Gi
        storageClassName<span class="token operator">:</span> managed<span class="token operator">-</span>nfs<span class="token operator">-</span>storage # nfs存储类名称

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">Service</span>
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> mysql8
  name<span class="token operator">:</span> mysql8 # 存储类名称
  namespace<span class="token operator">:</span> mysql
spec<span class="token operator">:</span>
  ports<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> tcp
      port<span class="token operator">:</span> <span class="token number">3306</span>
      targetPort<span class="token operator">:</span> <span class="token number">3306</span>
      nodePort<span class="token operator">:</span> <span class="token number">32406</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
  selector<span class="token operator">:</span>
    app<span class="token operator">:</span> mysql8 # <span class="token class-name">Pod</span>选择器
  type<span class="token operator">:</span> <span class="token class-name">NodePort</span>
</code></pre> 
<h3><a id="10minIO_2046"></a>10、安装minIO</h3> 
<h4><a id="101_2047"></a>10.1、单机版</h4> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> minio
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> minio
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> minio
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> minio
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> /bin/sh
            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
            <span class="token punctuation">-</span> minio server /data <span class="token punctuation">-</span><span class="token punctuation">-</span>console<span class="token punctuation">-</span>address "<span class="token punctuation">:</span>5000"
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MINIO_ROOT_USER
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"admin"</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MINIO_ROOT_PASSWORD
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"admin123456"</span>
          <span class="token key atrule">image</span><span class="token punctuation">:</span> minio/minio<span class="token punctuation">:</span>latest
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">name</span><span class="token punctuation">:</span> minio
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9000</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> data
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5000</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> console
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data
              <span class="token key atrule">name</span><span class="token punctuation">:</span> data
  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
      <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> data
      <span class="token key atrule">spec</span><span class="token punctuation">:</span>
        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> ReadWriteMany
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi
        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token string">"managed-nfs-storage"</span>

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> minio
  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> minio
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9000</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30024</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> console
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5000</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">5000</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30427</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> minio
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre> 
<h4><a id="102_2127"></a>10.2、集群版</h4> 
<h5><a id="1021_2128"></a>10.2.1、注意点</h5> 
<ul><li>集群中最少必须有<code>4</code>个节点，不然启动直接报错</li></ul> 
<pre><code class="prism language-java"><span class="token constant">ERROR</span> <span class="token class-name">Invalid</span> command line arguments<span class="token operator">:</span> <span class="token class-name">Incorrect</span> number of endpoints provided <span class="token punctuation">[</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>minio<span class="token operator">-</span><span class="token punctuation">{<!-- --></span><span class="token number">0.</span><span class="token punctuation">.</span><span class="token number">.1</span><span class="token punctuation">}</span><span class="token punctuation">.</span>minio<span class="token punctuation">.</span>minio<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local<span class="token operator">/</span>data<span class="token punctuation">]</span>
      <span class="token operator">&gt;</span> <span class="token class-name">Please</span> provide correct combination of local<span class="token operator">/</span>remote paths
      <span class="token constant">HINT</span><span class="token operator">:</span>
        <span class="token class-name">For</span> more information<span class="token punctuation">,</span> please refer <span class="token keyword">to</span> <span class="token namespace">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>min<span class="token punctuation">.</span>io<span class="token operator">/</span>docs<span class="token operator">/</span>minio<span class="token operator">-</span>erasure<span class="token operator">-</span>code<span class="token operator">-</span>quickstart<span class="token operator">-</span>guide
</code></pre> 
<ul><li>minio的Pod所用的data目录必须是干净的，如果存在内容，可能会出现以下错误，如果出现这种错误，需要把data目录对应的pvc、pv手动删除掉，根据<code>kubectl delete -f XXX.yaml</code>删除minio服务，然后重新执行yaml文件创建即可</li></ul> 
<pre><code class="prism language-java"><span class="token constant">ERROR</span> <span class="token class-name">Unable</span> <span class="token keyword">to</span> <span class="token namespace">initialize</span> backend<span class="token operator">:</span> <span class="token class-name">Unsupported</span> backend format <span class="token punctuation">[</span>fs<span class="token punctuation">]</span> found on <span class="token operator">/</span>data
</code></pre> 
<h5><a id="1022yaml_2145"></a>10.2.2、yaml</h5> 
<pre><code class="prism language-java">apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">ConfigMap</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> minio<span class="token operator">-</span>cm
  namespace<span class="token operator">:</span> minio
data<span class="token operator">:</span>
  user<span class="token operator">:</span> admin
  password<span class="token operator">:</span> admin123456

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">Service</span>
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> minio
  name<span class="token operator">:</span> minio
  namespace<span class="token operator">:</span> minio
spec<span class="token operator">:</span>
  clusterIP<span class="token operator">:</span> <span class="token class-name">None</span>
  ports<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> data
      port<span class="token operator">:</span> <span class="token number">9000</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">9000</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> console
      port<span class="token operator">:</span> <span class="token number">5000</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">5000</span>
  selector<span class="token operator">:</span>
    app<span class="token operator">:</span> minio
  type<span class="token operator">:</span> <span class="token class-name">ClusterIP</span>

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
kind<span class="token operator">:</span> <span class="token class-name">StatefulSet</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> minio
  namespace<span class="token operator">:</span> minio
spec<span class="token operator">:</span>
  replicas<span class="token operator">:</span> <span class="token number">4</span>
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> minio
  serviceName<span class="token operator">:</span> minio
  template<span class="token operator">:</span>
    metadata<span class="token operator">:</span>
      labels<span class="token operator">:</span>
        app<span class="token operator">:</span> minio
    spec<span class="token operator">:</span>
      containers<span class="token operator">:</span>
        <span class="token operator">-</span> command<span class="token operator">:</span>
            <span class="token operator">-</span> <span class="token operator">/</span>bin<span class="token operator">/</span>sh
            <span class="token operator">-</span> <span class="token char">'-c'</span>
            <span class="token operator">-</span> <span class="token operator">&gt;</span><span class="token operator">-</span>
              minio server <span class="token operator">--</span>console<span class="token operator">-</span>address <span class="token string">":5000"</span>
              http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>minio<span class="token operator">-</span><span class="token punctuation">{<!-- --></span><span class="token number">0.</span><span class="token punctuation">.</span><span class="token number">.3</span><span class="token punctuation">}</span><span class="token punctuation">.</span>minio<span class="token punctuation">.</span>minio<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local<span class="token operator">/</span>data
          env<span class="token operator">:</span>
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">MINIO_ACCESS_KEY</span>
              valueFrom<span class="token operator">:</span>
                configMapKeyRef<span class="token operator">:</span>
                  key<span class="token operator">:</span> user
                  name<span class="token operator">:</span> minio<span class="token operator">-</span>cm
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">MINIO_SECRET_KEY</span>
              valueFrom<span class="token operator">:</span>
                configMapKeyRef<span class="token operator">:</span>
                  key<span class="token operator">:</span> password
                  name<span class="token operator">:</span> minio<span class="token operator">-</span>cm
          image<span class="token operator">:</span> minio<span class="token operator">/</span>minio<span class="token operator">:</span>latest
          imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
          name<span class="token operator">:</span> minio
          ports<span class="token operator">:</span>
            <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">9000</span>
              name<span class="token operator">:</span> data
              protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
            <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">5000</span>
              name<span class="token operator">:</span> console
              protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
          volumeMounts<span class="token operator">:</span>
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>data
              name<span class="token operator">:</span> data
  volumeClaimTemplates<span class="token operator">:</span>
    <span class="token operator">-</span> apiVersion<span class="token operator">:</span> v1
      kind<span class="token operator">:</span> <span class="token class-name">PersistentVolumeClaim</span>
      metadata<span class="token operator">:</span>
        name<span class="token operator">:</span> data
      spec<span class="token operator">:</span>
        accessModes<span class="token operator">:</span>
          <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
        resources<span class="token operator">:</span>
          requests<span class="token operator">:</span>
            storage<span class="token operator">:</span> <span class="token number">1</span>Gi
        storageClassName<span class="token operator">:</span> managed<span class="token operator">-</span>nfs<span class="token operator">-</span>storage

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">Service</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> minio<span class="token operator">-</span>service
  namespace<span class="token operator">:</span> minio
spec<span class="token operator">:</span>
  ports<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> data
      nodePort<span class="token operator">:</span> <span class="token number">30900</span>
      port<span class="token operator">:</span> <span class="token number">9000</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">9000</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> console
      nodePort<span class="token operator">:</span> <span class="token number">30500</span>
      port<span class="token operator">:</span> <span class="token number">5000</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">5000</span>
  selector<span class="token operator">:</span>
    app<span class="token operator">:</span> minio
  type<span class="token operator">:</span> <span class="token class-name">NodePort</span>
</code></pre> 
<h3><a id="11rabbitmq_2267"></a>11、安装rabbitmq</h3> 
<h4><a id="111_2268"></a>11.1、单机版</h4> 
<pre><code class="prism language-java">apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
kind<span class="token operator">:</span> <span class="token class-name">StatefulSet</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> rabbitmq
  namespace<span class="token operator">:</span> rabbitmq
spec<span class="token operator">:</span>
  replicas<span class="token operator">:</span> <span class="token number">1</span>
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> rabbitmq
  serviceName<span class="token operator">:</span> rabbitmq
  template<span class="token operator">:</span>
    metadata<span class="token operator">:</span>
      labels<span class="token operator">:</span>
        app<span class="token operator">:</span> rabbitmq
    spec<span class="token operator">:</span>
      containers<span class="token operator">:</span>
        <span class="token operator">-</span> env<span class="token operator">:</span>
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">RABBITMQ_DEFAULT_VHOST</span>
              value<span class="token operator">:</span> <span class="token operator">/</span>
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">RABBITMQ_DEFAULT_USER</span>
              value<span class="token operator">:</span> admin
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">RABBITMQ_DEFAULT_PASS</span>
              value<span class="token operator">:</span> admin123456
          image<span class="token operator">:</span> rabbitmq<span class="token operator">:</span><span class="token number">3.8</span><span class="token number">.3</span><span class="token operator">-</span>management
          imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
          name<span class="token operator">:</span> rabbitmq
          ports<span class="token operator">:</span>
            <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">15672</span>
              name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>web
              protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
            <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">5672</span>
              name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>app
              protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
          volumeMounts<span class="token operator">:</span>
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>rabbitmq
              name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>data
              subPath<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>data
  volumeClaimTemplates<span class="token operator">:</span>
    <span class="token operator">-</span> apiVersion<span class="token operator">:</span> v1
      kind<span class="token operator">:</span> <span class="token class-name">PersistentVolumeClaim</span>
      metadata<span class="token operator">:</span>
        name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>data
      spec<span class="token operator">:</span>
        accessModes<span class="token operator">:</span>
          <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
        resources<span class="token operator">:</span>
          requests<span class="token operator">:</span>
            storage<span class="token operator">:</span> <span class="token number">500</span>Mi
        storageClassName<span class="token operator">:</span> managed<span class="token operator">-</span>nfs<span class="token operator">-</span>storage

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">Service</span>
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> rabbitmq
  name<span class="token operator">:</span> rabbitmq
  namespace<span class="token operator">:</span> rabbitmq
spec<span class="token operator">:</span>
  ports<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> mq
      port<span class="token operator">:</span> <span class="token number">15672</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">15672</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> mq<span class="token operator">-</span>app
      port<span class="token operator">:</span> <span class="token number">5672</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">5672</span>
  selector<span class="token operator">:</span>
    app<span class="token operator">:</span> rabbitmq
  type<span class="token operator">:</span> <span class="token class-name">NodePort</span>
</code></pre> 
<h4><a id="112_2346"></a>11.2、集群版</h4> 
<pre><code class="prism language-java">kind<span class="token operator">:</span> <span class="token class-name">ConfigMap</span>
apiVersion<span class="token operator">:</span> v1
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster<span class="token operator">-</span>config
  namespace<span class="token operator">:</span> rabbitmq
  labels<span class="token operator">:</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io<span class="token operator">/</span>mode<span class="token operator">:</span> <span class="token class-name">Reconcile</span>
data<span class="token operator">:</span>
    enabled_plugins<span class="token operator">:</span> <span class="token operator">|</span>
      <span class="token punctuation">[</span>rabbitmq_management<span class="token punctuation">,</span>rabbitmq_peer_discovery_k8s<span class="token punctuation">]</span><span class="token punctuation">.</span>
    rabbitmq<span class="token punctuation">.</span>conf<span class="token operator">:</span> <span class="token operator">|</span>
      default_user <span class="token operator">=</span> admin
      default_pass <span class="token operator">=</span> admin123456
      ## <span class="token class-name">Cluster</span> <span class="token class-name"><span class="token namespace">formation<span class="token punctuation">.</span></span> See</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>com<span class="token operator">/</span>cluster<span class="token operator">-</span>formation<span class="token punctuation">.</span>html <span class="token keyword">to</span> <span class="token namespace">learn</span> more<span class="token punctuation">.</span>
      cluster_formation<span class="token punctuation">.</span>peer_discovery_backend <span class="token operator">=</span> rabbit_peer_discovery_k8s
      cluster_formation<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>host <span class="token operator">=</span> kubernetes<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local
      ## <span class="token class-name">Should</span> <span class="token class-name">RabbitMQ</span> node name be computed from the pod's hostname or <span class="token constant">IP</span> address<span class="token operator">?</span>
      ## <span class="token constant">IP</span> addresses are not stable<span class="token punctuation">,</span> so using <span class="token punctuation">[</span>stable<span class="token punctuation">]</span> hostnames is recommended when possible<span class="token punctuation">.</span>
      ## <span class="token class-name">Set</span> <span class="token keyword">to</span> <span class="token string">"hostname"</span> <span class="token keyword">to</span> <span class="token namespace">use</span> pod hostnames<span class="token punctuation">.</span>
      ## <span class="token class-name">When</span> <span class="token keyword">this</span> value is changed<span class="token punctuation">,</span> so should the variable used <span class="token keyword">to</span> <span class="token namespace">set</span> the <span class="token constant">RABBITMQ_NODENAME</span>
      ## environment variable<span class="token punctuation">.</span>
      cluster_formation<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>address_type <span class="token operator">=</span> hostname
      ## <span class="token class-name">How</span> often should node cleanup checks run<span class="token operator">?</span>
      cluster_formation<span class="token punctuation">.</span>node_cleanup<span class="token punctuation">.</span>interval <span class="token operator">=</span> <span class="token number">30</span>
      ## <span class="token class-name">Set</span> <span class="token keyword">to</span> <span class="token namespace">false</span> <span class="token keyword">if</span> automatic removal of unknown<span class="token operator">/</span>absent nodes
      ## is <span class="token class-name"><span class="token namespace">desired<span class="token punctuation">.</span></span> This</span> can be dangerous<span class="token punctuation">,</span> see
      ##  <span class="token operator">*</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>com<span class="token operator">/</span>cluster<span class="token operator">-</span>formation<span class="token punctuation">.</span>html#node<span class="token operator">-</span>health<span class="token operator">-</span>checks<span class="token operator">-</span>and<span class="token operator">-</span>cleanup
      ##  <span class="token operator">*</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>groups<span class="token punctuation">.</span>google<span class="token punctuation">.</span>com<span class="token operator">/</span>forum<span class="token operator">/</span>#<span class="token operator">!</span>msg<span class="token operator">/</span>rabbitmq<span class="token operator">-</span>users<span class="token operator">/</span>wuOfzEywHXo<span class="token operator">/</span>k8z_HWIkBgAJ
      cluster_formation<span class="token punctuation">.</span>node_cleanup<span class="token punctuation">.</span>only_log_warning <span class="token operator">=</span> <span class="token boolean">true</span>
      cluster_partition_handling <span class="token operator">=</span> autoheal
      ## <span class="token class-name">See</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>com<span class="token operator">/</span>ha<span class="token punctuation">.</span>html#master<span class="token operator">-</span>migration<span class="token operator">-</span>data<span class="token operator">-</span>locality
      queue_master_locator<span class="token operator">=</span>min<span class="token operator">-</span>masters
      ## <span class="token class-name">See</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>com<span class="token operator">/</span>access<span class="token operator">-</span>control<span class="token punctuation">.</span>html#loopback<span class="token operator">-</span>users
      loopback_users<span class="token punctuation">.</span>guest <span class="token operator">=</span> <span class="token boolean">false</span>
      cluster_formation<span class="token punctuation">.</span>randomized_startup_delay_range<span class="token punctuation">.</span>min <span class="token operator">=</span> <span class="token number">0</span>
      cluster_formation<span class="token punctuation">.</span>randomized_startup_delay_range<span class="token punctuation">.</span>max <span class="token operator">=</span> <span class="token number">2</span>
      # <span class="token keyword">default</span> is rabbitmq<span class="token operator">-</span>cluster's namespace
      # hostname_suffix
      cluster_formation<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>hostname_suffix <span class="token operator">=</span> <span class="token punctuation">.</span>rabbitmq<span class="token operator">-</span>cluster<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local
      # memory
      vm_memory_high_watermark<span class="token punctuation">.</span>absolute <span class="token operator">=</span> <span class="token number">100</span>Mi
      # disk
      disk_free_limit<span class="token punctuation">.</span>absolute <span class="token operator">=</span> <span class="token number">100</span>Mi

<span class="token operator">--</span><span class="token operator">-</span>

kind<span class="token operator">:</span> <span class="token class-name">Service</span>
apiVersion<span class="token operator">:</span> v1
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
  name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
  namespace<span class="token operator">:</span> rabbitmq
spec<span class="token operator">:</span>
  clusterIP<span class="token operator">:</span> <span class="token class-name">None</span>
  ports<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> rmqport
    port<span class="token operator">:</span> <span class="token number">5672</span>
    targetPort<span class="token operator">:</span> <span class="token number">5672</span>
  selector<span class="token operator">:</span>
    app<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster

<span class="token operator">--</span><span class="token operator">-</span>
kind<span class="token operator">:</span> <span class="token class-name">Service</span>
apiVersion<span class="token operator">:</span> v1
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
  name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster<span class="token operator">-</span>manage
  namespace<span class="token operator">:</span> rabbitmq
spec<span class="token operator">:</span>
  ports<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> http
    port<span class="token operator">:</span> <span class="token number">15672</span>
    protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
    targetPort<span class="token operator">:</span> <span class="token number">15672</span>
  selector<span class="token operator">:</span>
    app<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
  type<span class="token operator">:</span> <span class="token class-name">NodePort</span>

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">ServiceAccount</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
  namespace<span class="token operator">:</span> rabbitmq
<span class="token operator">--</span><span class="token operator">-</span>
kind<span class="token operator">:</span> <span class="token class-name">Role</span>
apiVersion<span class="token operator">:</span> rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io<span class="token operator">/</span>v1beta1
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
  namespace<span class="token operator">:</span> rabbitmq
rules<span class="token operator">:</span>
<span class="token operator">-</span> apiGroups<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
  resources<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>
  verbs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">]</span>
<span class="token operator">--</span><span class="token operator">-</span>
kind<span class="token operator">:</span> <span class="token class-name">RoleBinding</span>
apiVersion<span class="token operator">:</span> rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io<span class="token operator">/</span>v1beta1
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
  namespace<span class="token operator">:</span> rabbitmq
roleRef<span class="token operator">:</span>
  apiGroup<span class="token operator">:</span> rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io
  kind<span class="token operator">:</span> <span class="token class-name">Role</span>
  name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
subjects<span class="token operator">:</span>
<span class="token operator">-</span> kind<span class="token operator">:</span> <span class="token class-name">ServiceAccount</span>
  name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
  namespace<span class="token operator">:</span> rabbitmq

<span class="token operator">--</span><span class="token operator">-</span>

kind<span class="token operator">:</span> <span class="token class-name">StatefulSet</span>
apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
  name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
  namespace<span class="token operator">:</span> rabbitmq
spec<span class="token operator">:</span>
  replicas<span class="token operator">:</span> <span class="token number">3</span>
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
  serviceName<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
  template<span class="token operator">:</span>
    metadata<span class="token operator">:</span>
      labels<span class="token operator">:</span>
        app<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
    spec<span class="token operator">:</span>
      containers<span class="token operator">:</span>
      <span class="token operator">-</span> args<span class="token operator">:</span>
        <span class="token operator">-</span> <span class="token operator">-</span>c
        <span class="token operator">-</span> cp <span class="token operator">-</span>v <span class="token operator">/</span>etc<span class="token operator">/</span>rabbitmq<span class="token operator">/</span>rabbitmq<span class="token punctuation">.</span>conf $<span class="token punctuation">{<!-- --></span><span class="token constant">RABBITMQ_CONFIG_FILE</span><span class="token punctuation">}</span><span class="token punctuation">;</span> exec docker<span class="token operator">-</span>entrypoint<span class="token punctuation">.</span>sh
          rabbitmq<span class="token operator">-</span>server
        command<span class="token operator">:</span>
        <span class="token operator">-</span> sh
        env<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">TZ</span>
          value<span class="token operator">:</span> '<span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Shanghai</span>'
        <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">RABBITMQ_ERLANG_COOKIE</span>
          value<span class="token operator">:</span> '<span class="token class-name">SWvCP0Hrqv43NG7GybHC95ntCJKoW8UyNFWnBEWG8TY</span><span class="token operator">=</span>'
        <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">K8S_SERVICE_NAME</span>
          value<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
        <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">POD_IP</span>
          valueFrom<span class="token operator">:</span>
            fieldRef<span class="token operator">:</span>
              fieldPath<span class="token operator">:</span> status<span class="token punctuation">.</span>podIP
        <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">POD_NAME</span>
          valueFrom<span class="token operator">:</span>
            fieldRef<span class="token operator">:</span>
              fieldPath<span class="token operator">:</span> metadata<span class="token punctuation">.</span>name
        <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">POD_NAMESPACE</span>
          valueFrom<span class="token operator">:</span>
            fieldRef<span class="token operator">:</span>
              fieldPath<span class="token operator">:</span> metadata<span class="token punctuation">.</span>namespace
        <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">RABBITMQ_USE_LONGNAME</span>
          value<span class="token operator">:</span> <span class="token string">"true"</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">RABBITMQ_NODENAME</span>
          value<span class="token operator">:</span> rabbit@$<span class="token punctuation">(</span><span class="token constant">POD_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span>$<span class="token punctuation">(</span><span class="token constant">K8S_SERVICE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span>$<span class="token punctuation">(</span><span class="token constant">POD_NAMESPACE</span><span class="token punctuation">)</span><span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local
        <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">RABBITMQ_CONFIG_FILE</span>
          value<span class="token operator">:</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>rabbitmq<span class="token operator">/</span>rabbitmq<span class="token punctuation">.</span>conf
        image<span class="token operator">:</span> rabbitmq<span class="token operator">:</span><span class="token number">3.8</span><span class="token number">.3</span><span class="token operator">-</span>management
        imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
        name<span class="token operator">:</span> rabbitmq
        ports<span class="token operator">:</span>
        <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">15672</span>
          name<span class="token operator">:</span> http
          protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
        <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">5672</span>
          name<span class="token operator">:</span> amqp
          protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
        volumeMounts<span class="token operator">:</span>
        <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>etc<span class="token operator">/</span>rabbitmq
          name<span class="token operator">:</span> config<span class="token operator">-</span>volume
          readOnly<span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>rabbitmq
          name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>storage
          readOnly<span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> timezone
          mountPath<span class="token operator">:</span> <span class="token operator">/</span>etc<span class="token operator">/</span>localtime
          readOnly<span class="token operator">:</span> <span class="token boolean">true</span>
      serviceAccountName<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster
      terminationGracePeriodSeconds<span class="token operator">:</span> <span class="token number">30</span>
      volumes<span class="token operator">:</span>
      <span class="token operator">-</span> name<span class="token operator">:</span> config<span class="token operator">-</span>volume
        configMap<span class="token operator">:</span>
          items<span class="token operator">:</span>
          <span class="token operator">-</span> key<span class="token operator">:</span> rabbitmq<span class="token punctuation">.</span>conf
            path<span class="token operator">:</span> rabbitmq<span class="token punctuation">.</span>conf
          <span class="token operator">-</span> key<span class="token operator">:</span> enabled_plugins
            path<span class="token operator">:</span> enabled_plugins
          name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>cluster<span class="token operator">-</span>config
      <span class="token operator">-</span> name<span class="token operator">:</span> timezone
        hostPath<span class="token operator">:</span>
          path<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>zoneinfo<span class="token operator">/</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Shanghai</span>
  volumeClaimTemplates<span class="token operator">:</span>
  <span class="token operator">-</span> metadata<span class="token operator">:</span>
      name<span class="token operator">:</span> rabbitmq<span class="token operator">-</span>storage
    spec<span class="token operator">:</span>
      accessModes<span class="token operator">:</span>
      <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
      storageClassName<span class="token operator">:</span> <span class="token string">"managed-nfs-storage"</span>
      resources<span class="token operator">:</span>
        requests<span class="token operator">:</span>
          storage<span class="token operator">:</span> <span class="token number">100</span>Mi


</code></pre> 
<h3><a id="12redis_2561"></a>12、安装redis</h3> 
<h4><a id="121_2562"></a>12.1、单机版</h4> 
<pre><code class="prism language-java">apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">ConfigMap</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> redis<span class="token punctuation">.</span>conf
  namespace<span class="token operator">:</span> redis
data<span class="token operator">:</span>
  redis<span class="token punctuation">.</span>conf<span class="token operator">:</span> <span class="token operator">|</span><span class="token operator">-</span>
    <span class="token keyword">protected</span><span class="token operator">-</span>mode no
    port <span class="token number">6379</span>
    tcp<span class="token operator">-</span>backlog <span class="token number">511</span>
    timeout <span class="token number">0</span>
    tcp<span class="token operator">-</span>keepalive <span class="token number">300</span>
    daemonize no
    supervised no
    pidfile <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run<span class="token operator">/</span>redis_6379<span class="token punctuation">.</span>pid
    loglevel notice
    logfile <span class="token string">""</span>
    databases <span class="token number">16</span>
    always<span class="token operator">-</span>show<span class="token operator">-</span>logo yes
    save <span class="token number">900</span> <span class="token number">1</span>
    save <span class="token number">300</span> <span class="token number">10</span>
    save <span class="token number">60</span> <span class="token number">10000</span>
    stop<span class="token operator">-</span>writes<span class="token operator">-</span>on<span class="token operator">-</span>bgsave<span class="token operator">-</span>error yes
    rdbcompression yes
    rdbchecksum yes
    dbfilename dump<span class="token punctuation">.</span>rdb
    dir <span class="token punctuation">.</span>/
    replica<span class="token operator">-</span>serve<span class="token operator">-</span>stale<span class="token operator">-</span>data yes
    replica<span class="token operator">-</span>read<span class="token operator">-</span>only yes
    repl<span class="token operator">-</span>diskless<span class="token operator">-</span>sync no
    repl<span class="token operator">-</span>diskless<span class="token operator">-</span>sync<span class="token operator">-</span>delay <span class="token number">5</span>
    repl<span class="token operator">-</span>disable<span class="token operator">-</span>tcp<span class="token operator">-</span>nodelay no
    replica<span class="token operator">-</span>priority <span class="token number">100</span>
    requirepass admin123456
    lazyfree<span class="token operator">-</span>lazy<span class="token operator">-</span>eviction no
    lazyfree<span class="token operator">-</span>lazy<span class="token operator">-</span>expire no
    lazyfree<span class="token operator">-</span>lazy<span class="token operator">-</span>server<span class="token operator">-</span>del no
    replica<span class="token operator">-</span>lazy<span class="token operator">-</span>flush no
    appendonly yes
    appendfilename <span class="token string">"appendonly.aof"</span>
    appendfsync everysec
    no<span class="token operator">-</span>appendfsync<span class="token operator">-</span>on<span class="token operator">-</span>rewrite no
    auto<span class="token operator">-</span>aof<span class="token operator">-</span>rewrite<span class="token operator">-</span>percentage <span class="token number">100</span>
    auto<span class="token operator">-</span>aof<span class="token operator">-</span>rewrite<span class="token operator">-</span>min<span class="token operator">-</span>size <span class="token number">64</span>mb
    aof<span class="token operator">-</span>load<span class="token operator">-</span>truncated yes
    aof<span class="token operator">-</span>use<span class="token operator">-</span>rdb<span class="token operator">-</span>preamble yes
    lua<span class="token operator">-</span>time<span class="token operator">-</span>limit <span class="token number">5000</span>
    slowlog<span class="token operator">-</span>log<span class="token operator">-</span>slower<span class="token operator">-</span>than <span class="token number">10000</span>
    slowlog<span class="token operator">-</span>max<span class="token operator">-</span>len <span class="token number">128</span>
    latency<span class="token operator">-</span>monitor<span class="token operator">-</span>threshold <span class="token number">0</span>
      notify<span class="token operator">-</span>keyspace<span class="token operator">-</span>events <span class="token class-name">Ex</span>
    hash<span class="token operator">-</span>max<span class="token operator">-</span>ziplist<span class="token operator">-</span>entries <span class="token number">512</span>
    hash<span class="token operator">-</span>max<span class="token operator">-</span>ziplist<span class="token operator">-</span>value <span class="token number">64</span>
    list<span class="token operator">-</span>max<span class="token operator">-</span>ziplist<span class="token operator">-</span>size <span class="token operator">-</span><span class="token number">2</span>
    list<span class="token operator">-</span>compress<span class="token operator">-</span>depth <span class="token number">0</span>
    set<span class="token operator">-</span>max<span class="token operator">-</span>intset<span class="token operator">-</span>entries <span class="token number">512</span>
    zset<span class="token operator">-</span>max<span class="token operator">-</span>ziplist<span class="token operator">-</span>entries <span class="token number">128</span>
    zset<span class="token operator">-</span>max<span class="token operator">-</span>ziplist<span class="token operator">-</span>value <span class="token number">64</span>
    hll<span class="token operator">-</span>sparse<span class="token operator">-</span>max<span class="token operator">-</span>bytes <span class="token number">3000</span>
    stream<span class="token operator">-</span>node<span class="token operator">-</span>max<span class="token operator">-</span>bytes <span class="token number">4096</span>
    stream<span class="token operator">-</span>node<span class="token operator">-</span>max<span class="token operator">-</span>entries <span class="token number">100</span>
    activerehashing yes
    client<span class="token operator">-</span>output<span class="token operator">-</span>buffer<span class="token operator">-</span>limit normal <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span>
    client<span class="token operator">-</span>output<span class="token operator">-</span>buffer<span class="token operator">-</span>limit replica <span class="token number">256</span>mb <span class="token number">64</span>mb <span class="token number">60</span>
    client<span class="token operator">-</span>output<span class="token operator">-</span>buffer<span class="token operator">-</span>limit pubsub <span class="token number">32</span>mb <span class="token number">8</span>mb <span class="token number">60</span>
    hz <span class="token number">10</span>
    dynamic<span class="token operator">-</span>hz yes
    aof<span class="token operator">-</span>rewrite<span class="token operator">-</span>incremental<span class="token operator">-</span>fsync yes
    rdb<span class="token operator">-</span>save<span class="token operator">-</span>incremental<span class="token operator">-</span>fsync yes

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
kind<span class="token operator">:</span> <span class="token class-name">StatefulSet</span>
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> redis
  name<span class="token operator">:</span> redis
  namespace<span class="token operator">:</span> redis
spec<span class="token operator">:</span>
  replicas<span class="token operator">:</span> <span class="token number">1</span>
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> redis
  serviceName<span class="token operator">:</span> redis
  template<span class="token operator">:</span>
    metadata<span class="token operator">:</span>
      labels<span class="token operator">:</span>
        app<span class="token operator">:</span> redis
    spec<span class="token operator">:</span>
      containers<span class="token operator">:</span>
        <span class="token operator">-</span> command<span class="token operator">:</span>
            <span class="token operator">-</span> redis<span class="token operator">-</span>server
            <span class="token operator">-</span> <span class="token operator">/</span>etc<span class="token operator">/</span>redis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
          image<span class="token operator">:</span> 'redis<span class="token operator">:</span><span class="token number">6.2</span><span class="token number">.6</span>'
          imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
          name<span class="token operator">:</span> redis
          ports<span class="token operator">:</span>
            <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">6379</span>
              name<span class="token operator">:</span> client
              protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
            <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">16379</span>
              name<span class="token operator">:</span> gossip
              protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
          volumeMounts<span class="token operator">:</span>
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>data
              name<span class="token operator">:</span> redis<span class="token operator">-</span>data
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>etc<span class="token operator">/</span>redis<span class="token operator">/</span>
              name<span class="token operator">:</span> redis<span class="token operator">-</span>conf
      volumes<span class="token operator">:</span>
        <span class="token operator">-</span> configMap<span class="token operator">:</span>
            name<span class="token operator">:</span> redis<span class="token punctuation">.</span>conf
          name<span class="token operator">:</span> redis<span class="token operator">-</span>conf
  volumeClaimTemplates<span class="token operator">:</span>
  <span class="token operator">-</span> metadata<span class="token operator">:</span>
      name<span class="token operator">:</span> redis<span class="token operator">-</span>data
    spec<span class="token operator">:</span>
      accessModes<span class="token operator">:</span>
      <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
      storageClassName<span class="token operator">:</span> <span class="token string">"managed-nfs-storage"</span>
      resources<span class="token operator">:</span>
        requests<span class="token operator">:</span>
          storage<span class="token operator">:</span> <span class="token number">100</span>Mi

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">Service</span>
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> redis
  name<span class="token operator">:</span> redis
  namespace<span class="token operator">:</span> redis
spec<span class="token operator">:</span>
  ports<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> client
      port<span class="token operator">:</span> <span class="token number">6379</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">6379</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> gossip
      port<span class="token operator">:</span> <span class="token number">16379</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">16379</span>
  selector<span class="token operator">:</span>
    app<span class="token operator">:</span> redis
  type<span class="token operator">:</span> <span class="token class-name">NodePort</span>
</code></pre> 
<h3><a id="13nacos_2713"></a>13、安装nacos</h3> 
<h4><a id="131_2714"></a>13.1、集群版</h4> 
<h5><a id="1311nacos_2716"></a>13.1.1、创建nacos数据库</h5> 
<p>在Mysql中创建数据库，名称叫做<code>nacos</code>，不想叫这个名字的需要去修改下面yaml配置文件中的数据库名称，创建好数据库后，就需要执行以下sql语句，如下：</p> 
<pre><code class="prism language-java"><span class="token comment">/*
 * Copyright 1999-2018 Alibaba Group Holding Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   数据库全名 = nacos_config   */</span>
<span class="token comment">/*   表名称 = config_info   */</span>
<span class="token comment">/******************************************/</span>
<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `config_info` <span class="token punctuation">(</span>
  `id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span> <span class="token constant">COMMENT</span> <span class="token char">'id'</span><span class="token punctuation">,</span>
  `data_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'data_id'<span class="token punctuation">,</span>
  `group_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token class-name">DEFAULT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  `content` longtext <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'content'<span class="token punctuation">,</span>
  `md5` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'md5'</span><span class="token punctuation">,</span>
  `gmt_create` datetime <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token constant">CURRENT_TIMESTAMP</span> <span class="token constant">COMMENT</span> <span class="token char">'创建时间'</span><span class="token punctuation">,</span>
  `gmt_modified` datetime <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token constant">CURRENT_TIMESTAMP</span> <span class="token constant">COMMENT</span> <span class="token char">'修改时间'</span><span class="token punctuation">,</span>
  `src_user` text <span class="token constant">COMMENT</span> 'source user'<span class="token punctuation">,</span>
  `src_ip` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'source ip'<span class="token punctuation">,</span>
  `app_name` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token class-name">DEFAULT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  `tenant_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> '' <span class="token constant">COMMENT</span> <span class="token char">'租户字段'</span><span class="token punctuation">,</span>
  `c_desc` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token class-name">DEFAULT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  `c_use` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token class-name">DEFAULT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  `effect` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token class-name">DEFAULT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  `type` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token class-name">DEFAULT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  `c_schema` text<span class="token punctuation">,</span>
  `encrypted_data_key` text <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'秘钥'</span><span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">UNIQUE</span> <span class="token constant">KEY</span> `uk_configinfo_datagrouptenant` <span class="token punctuation">(</span>`data_id`<span class="token punctuation">,</span>`group_id`<span class="token punctuation">,</span>`tenant_id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8 <span class="token constant">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token constant">COMMENT</span><span class="token operator">=</span>'config_info'<span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   数据库全名 = nacos_config   */</span>
<span class="token comment">/*   表名称 = config_info_aggr   */</span>
<span class="token comment">/******************************************/</span>
<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `config_info_aggr` <span class="token punctuation">(</span>
  `id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span> <span class="token constant">COMMENT</span> <span class="token char">'id'</span><span class="token punctuation">,</span>
  `data_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'data_id'<span class="token punctuation">,</span>
  `group_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'group_id'<span class="token punctuation">,</span>
  `datum_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'datum_id'<span class="token punctuation">,</span>
  `content` longtext <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'内容'</span><span class="token punctuation">,</span>
  `gmt_modified` datetime <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'修改时间'</span><span class="token punctuation">,</span>
  `app_name` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token class-name">DEFAULT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  `tenant_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> '' <span class="token constant">COMMENT</span> <span class="token char">'租户字段'</span><span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">UNIQUE</span> <span class="token constant">KEY</span> `uk_configinfoaggr_datagrouptenantdatum` <span class="token punctuation">(</span>`data_id`<span class="token punctuation">,</span>`group_id`<span class="token punctuation">,</span>`tenant_id`<span class="token punctuation">,</span>`datum_id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8 <span class="token constant">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token constant">COMMENT</span><span class="token operator">=</span><span class="token char">'增加租户字段'</span><span class="token punctuation">;</span>


<span class="token comment">/******************************************/</span>
<span class="token comment">/*   数据库全名 = nacos_config   */</span>
<span class="token comment">/*   表名称 = config_info_beta   */</span>
<span class="token comment">/******************************************/</span>
<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `config_info_beta` <span class="token punctuation">(</span>
  `id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span> <span class="token constant">COMMENT</span> <span class="token char">'id'</span><span class="token punctuation">,</span>
  `data_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'data_id'<span class="token punctuation">,</span>
  `group_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'group_id'<span class="token punctuation">,</span>
  `app_name` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'app_name'<span class="token punctuation">,</span>
  `content` longtext <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'content'<span class="token punctuation">,</span>
  `beta_ips` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'betaIps'<span class="token punctuation">,</span>
  `md5` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'md5'</span><span class="token punctuation">,</span>
  `gmt_create` datetime <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token constant">CURRENT_TIMESTAMP</span> <span class="token constant">COMMENT</span> <span class="token char">'创建时间'</span><span class="token punctuation">,</span>
  `gmt_modified` datetime <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token constant">CURRENT_TIMESTAMP</span> <span class="token constant">COMMENT</span> <span class="token char">'修改时间'</span><span class="token punctuation">,</span>
  `src_user` text <span class="token constant">COMMENT</span> 'source user'<span class="token punctuation">,</span>
  `src_ip` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'source ip'<span class="token punctuation">,</span>
  `tenant_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> '' <span class="token constant">COMMENT</span> <span class="token char">'租户字段'</span><span class="token punctuation">,</span>
  `encrypted_data_key` text <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'秘钥'</span><span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">UNIQUE</span> <span class="token constant">KEY</span> `uk_configinfobeta_datagrouptenant` <span class="token punctuation">(</span>`data_id`<span class="token punctuation">,</span>`group_id`<span class="token punctuation">,</span>`tenant_id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8 <span class="token constant">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token constant">COMMENT</span><span class="token operator">=</span>'config_info_beta'<span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   数据库全名 = nacos_config   */</span>
<span class="token comment">/*   表名称 = config_info_tag   */</span>
<span class="token comment">/******************************************/</span>
<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `config_info_tag` <span class="token punctuation">(</span>
  `id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span> <span class="token constant">COMMENT</span> <span class="token char">'id'</span><span class="token punctuation">,</span>
  `data_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'data_id'<span class="token punctuation">,</span>
  `group_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'group_id'<span class="token punctuation">,</span>
  `tenant_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> '' <span class="token constant">COMMENT</span> 'tenant_id'<span class="token punctuation">,</span>
  `tag_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'tag_id'</span><span class="token punctuation">,</span>
  `app_name` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'app_name'<span class="token punctuation">,</span>
  `content` longtext <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'content'<span class="token punctuation">,</span>
  `md5` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'md5'</span><span class="token punctuation">,</span>
  `gmt_create` datetime <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token constant">CURRENT_TIMESTAMP</span> <span class="token constant">COMMENT</span> <span class="token char">'创建时间'</span><span class="token punctuation">,</span>
  `gmt_modified` datetime <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token constant">CURRENT_TIMESTAMP</span> <span class="token constant">COMMENT</span> <span class="token char">'修改时间'</span><span class="token punctuation">,</span>
  `src_user` text <span class="token constant">COMMENT</span> 'source user'<span class="token punctuation">,</span>
  `src_ip` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'source ip'<span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">UNIQUE</span> <span class="token constant">KEY</span> `uk_configinfotag_datagrouptenanttag` <span class="token punctuation">(</span>`data_id`<span class="token punctuation">,</span>`group_id`<span class="token punctuation">,</span>`tenant_id`<span class="token punctuation">,</span>`tag_id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8 <span class="token constant">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token constant">COMMENT</span><span class="token operator">=</span>'config_info_tag'<span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   数据库全名 = nacos_config   */</span>
<span class="token comment">/*   表名称 = config_tags_relation   */</span>
<span class="token comment">/******************************************/</span>
<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `config_tags_relation` <span class="token punctuation">(</span>
  `id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'id'</span><span class="token punctuation">,</span>
  `tag_name` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'tag_name'<span class="token punctuation">,</span>
  `tag_type` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'tag_type'<span class="token punctuation">,</span>
  `data_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'data_id'<span class="token punctuation">,</span>
  `group_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'group_id'<span class="token punctuation">,</span>
  `tenant_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> '' <span class="token constant">COMMENT</span> 'tenant_id'<span class="token punctuation">,</span>
  `nid` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token class-name">NULL</span> <span class="token constant">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`nid`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">UNIQUE</span> <span class="token constant">KEY</span> `uk_configtagrelation_configidtag` <span class="token punctuation">(</span>`id`<span class="token punctuation">,</span>`tag_name`<span class="token punctuation">,</span>`tag_type`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">KEY</span> `idx_tenant_id` <span class="token punctuation">(</span>`tenant_id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8 <span class="token constant">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token constant">COMMENT</span><span class="token operator">=</span>'config_tag_relation'<span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   数据库全名 = nacos_config   */</span>
<span class="token comment">/*   表名称 = group_capacity   */</span>
<span class="token comment">/******************************************/</span>
<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `group_capacity` <span class="token punctuation">(</span>
  `id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span> <span class="token constant">COMMENT</span> <span class="token char">'主键ID'</span><span class="token punctuation">,</span>
  `group_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> '' <span class="token constant">COMMENT</span> '<span class="token class-name">Group</span> <span class="token constant">ID</span>，空字符表示整个集群'<span class="token punctuation">,</span>
  `quota` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '配额，<span class="token number">0</span>表示使用默认值'<span class="token punctuation">,</span>
  `usage` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> <span class="token char">'使用量'</span><span class="token punctuation">,</span>
  `max_size` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '单个配置大小上限，单位为字节，<span class="token number">0</span>表示使用默认值'<span class="token punctuation">,</span>
  `max_aggr_count` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '聚合子配置最大个数，，<span class="token number">0</span>表示使用默认值'<span class="token punctuation">,</span>
  `max_aggr_size` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '单个聚合数据的子配置大小上限，单位为字节，<span class="token number">0</span>表示使用默认值'<span class="token punctuation">,</span>
  `max_history_count` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '最大变更历史数量'<span class="token punctuation">,</span>
  `gmt_create` datetime <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token constant">CURRENT_TIMESTAMP</span> <span class="token constant">COMMENT</span> <span class="token char">'创建时间'</span><span class="token punctuation">,</span>
  `gmt_modified` datetime <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token constant">CURRENT_TIMESTAMP</span> <span class="token constant">COMMENT</span> <span class="token char">'修改时间'</span><span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">UNIQUE</span> <span class="token constant">KEY</span> `uk_group_id` <span class="token punctuation">(</span>`group_id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8 <span class="token constant">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token constant">COMMENT</span><span class="token operator">=</span>'集群、各<span class="token class-name">Group</span>容量信息表'<span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   数据库全名 = nacos_config   */</span>
<span class="token comment">/*   表名称 = his_config_info   */</span>
<span class="token comment">/******************************************/</span>
<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `his_config_info` <span class="token punctuation">(</span>
  `id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token class-name">NOT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  `nid` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token class-name">NULL</span> <span class="token constant">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  `data_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  `group_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  `app_name` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'app_name'<span class="token punctuation">,</span>
  `content` longtext <span class="token class-name">NOT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  `md5` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token class-name">DEFAULT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  `gmt_create` datetime <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
  `gmt_modified` datetime <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
  `src_user` text<span class="token punctuation">,</span>
  `src_ip` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token class-name">DEFAULT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  `op_type` <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token class-name">DEFAULT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
  `tenant_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> '' <span class="token constant">COMMENT</span> <span class="token char">'租户字段'</span><span class="token punctuation">,</span>
  `encrypted_data_key` text <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'秘钥'</span><span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`nid`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">KEY</span> `idx_gmt_create` <span class="token punctuation">(</span>`gmt_create`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">KEY</span> `idx_gmt_modified` <span class="token punctuation">(</span>`gmt_modified`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">KEY</span> `idx_did` <span class="token punctuation">(</span>`data_id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8 <span class="token constant">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token constant">COMMENT</span><span class="token operator">=</span><span class="token char">'多租户改造'</span><span class="token punctuation">;</span>


<span class="token comment">/******************************************/</span>
<span class="token comment">/*   数据库全名 = nacos_config   */</span>
<span class="token comment">/*   表名称 = tenant_capacity   */</span>
<span class="token comment">/******************************************/</span>
<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `tenant_capacity` <span class="token punctuation">(</span>
  `id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span> <span class="token constant">COMMENT</span> <span class="token char">'主键ID'</span><span class="token punctuation">,</span>
  `tenant_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> '' <span class="token constant">COMMENT</span> '<span class="token class-name">Tenant</span> <span class="token constant">ID</span>'<span class="token punctuation">,</span>
  `quota` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '配额，<span class="token number">0</span>表示使用默认值'<span class="token punctuation">,</span>
  `usage` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> <span class="token char">'使用量'</span><span class="token punctuation">,</span>
  `max_size` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '单个配置大小上限，单位为字节，<span class="token number">0</span>表示使用默认值'<span class="token punctuation">,</span>
  `max_aggr_count` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '聚合子配置最大个数'<span class="token punctuation">,</span>
  `max_aggr_size` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '单个聚合数据的子配置大小上限，单位为字节，<span class="token number">0</span>表示使用默认值'<span class="token punctuation">,</span>
  `max_history_count` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '最大变更历史数量'<span class="token punctuation">,</span>
  `gmt_create` datetime <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token constant">CURRENT_TIMESTAMP</span> <span class="token constant">COMMENT</span> <span class="token char">'创建时间'</span><span class="token punctuation">,</span>
  `gmt_modified` datetime <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token constant">CURRENT_TIMESTAMP</span> <span class="token constant">COMMENT</span> <span class="token char">'修改时间'</span><span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">UNIQUE</span> <span class="token constant">KEY</span> `uk_tenant_id` <span class="token punctuation">(</span>`tenant_id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8 <span class="token constant">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token constant">COMMENT</span><span class="token operator">=</span>'租户容量信息表'<span class="token punctuation">;</span>


<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `tenant_info` <span class="token punctuation">(</span>
  `id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span> <span class="token constant">COMMENT</span> <span class="token char">'id'</span><span class="token punctuation">,</span>
  `kp` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'kp'</span><span class="token punctuation">,</span>
  `tenant_id` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> '' <span class="token constant">COMMENT</span> 'tenant_id'<span class="token punctuation">,</span>
  `tenant_name` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> '' <span class="token constant">COMMENT</span> 'tenant_name'<span class="token punctuation">,</span>
  `tenant_desc` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'tenant_desc'<span class="token punctuation">,</span>
  `create_source` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> 'create_source'<span class="token punctuation">,</span>
  `gmt_create` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'创建时间'</span><span class="token punctuation">,</span>
  `gmt_modified` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'修改时间'</span><span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">UNIQUE</span> <span class="token constant">KEY</span> `uk_tenant_info_kptenantid` <span class="token punctuation">(</span>`kp`<span class="token punctuation">,</span>`tenant_id`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">KEY</span> `idx_tenant_id` <span class="token punctuation">(</span>`tenant_id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8 <span class="token constant">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token constant">COMMENT</span><span class="token operator">=</span>'tenant_info'<span class="token punctuation">;</span>

<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `users` <span class="token punctuation">(</span>
	`username` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span><span class="token punctuation">,</span>
	`password` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
	`enabled` <span class="token keyword">boolean</span> <span class="token class-name">NOT</span> <span class="token constant">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `roles` <span class="token punctuation">(</span>
	`username` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
	`role` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
	<span class="token constant">UNIQUE</span> <span class="token constant">INDEX</span> `idx_user_role` <span class="token punctuation">(</span>`username` <span class="token constant">ASC</span><span class="token punctuation">,</span> `role` <span class="token constant">ASC</span><span class="token punctuation">)</span> <span class="token class-name">USING</span> <span class="token constant">BTREE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `permissions` <span class="token punctuation">(</span>
    `role` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
    `resource` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
    `action` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
    <span class="token constant">UNIQUE</span> <span class="token constant">INDEX</span> `uk_role_permission` <span class="token punctuation">(</span>`role`<span class="token punctuation">,</span>`resource`<span class="token punctuation">,</span>`action`<span class="token punctuation">)</span> <span class="token class-name">USING</span> <span class="token constant">BTREE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">INSERT</span> <span class="token class-name">INTO</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span> <span class="token constant">VALUES</span> <span class="token punctuation">(</span><span class="token char">'nacos'</span><span class="token punctuation">,</span> '$<span class="token number">2</span>a$<span class="token number">10</span>$<span class="token class-name">EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu</span>'<span class="token punctuation">,</span> <span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">INSERT</span> <span class="token class-name">INTO</span> roles <span class="token punctuation">(</span>username<span class="token punctuation">,</span> role<span class="token punctuation">)</span> <span class="token constant">VALUES</span> <span class="token punctuation">(</span><span class="token char">'nacos'</span><span class="token punctuation">,</span> '<span class="token constant">ROLE_ADMIN</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="1312nacos_2943"></a>13.1.2、创建nacos</h5> 
<pre><code class="prism language-java">apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">ConfigMap</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> nacos<span class="token operator">-</span>config
  namespace<span class="token operator">:</span> nacos
data<span class="token operator">:</span>
  application<span class="token punctuation">.</span>properties<span class="token operator">:</span> <span class="token operator">&gt;</span><span class="token operator">-</span>
    # spring

    server<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>contextPath<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">SERVER_SERVLET_CONTEXTPATH</span><span class="token operator">:</span><span class="token operator">/</span>nacos<span class="token punctuation">}</span>

    server<span class="token punctuation">.</span>contextPath<span class="token operator">=</span><span class="token operator">/</span>nacos

    server<span class="token punctuation">.</span>port<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">NACOS_APPLICATION_PORT</span><span class="token operator">:</span><span class="token number">8848</span><span class="token punctuation">}</span>

    server<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>accesslog<span class="token punctuation">.</span>max<span class="token operator">-</span>days<span class="token operator">=</span><span class="token number">30</span>

    server<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>accesslog<span class="token punctuation">.</span>pattern<span class="token operator">=</span><span class="token operator">%</span>h <span class="token operator">%</span>l <span class="token operator">%</span>u <span class="token operator">%</span>t <span class="token string">"%r"</span> <span class="token operator">%</span>s <span class="token operator">%</span>b <span class="token operator">%</span><span class="token class-name">D</span> <span class="token operator">%</span><span class="token punctuation">{<!-- --></span><span class="token class-name">User</span><span class="token operator">-</span><span class="token class-name">Agent</span><span class="token punctuation">}</span>i
    <span class="token operator">%</span><span class="token punctuation">{<!-- --></span><span class="token class-name">Request</span><span class="token operator">-</span><span class="token class-name">Source</span><span class="token punctuation">}</span>i

    spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>platform<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">SPRING_DATASOURCE_PLATFORM</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">}</span>

    nacos<span class="token punctuation">.</span>cmdb<span class="token punctuation">.</span>dumpTaskInterval<span class="token operator">=</span><span class="token number">3600</span>

    nacos<span class="token punctuation">.</span>cmdb<span class="token punctuation">.</span>eventTaskInterval<span class="token operator">=</span><span class="token number">10</span>

    nacos<span class="token punctuation">.</span>cmdb<span class="token punctuation">.</span>labelTaskInterval<span class="token operator">=</span><span class="token number">300</span>

    nacos<span class="token punctuation">.</span>cmdb<span class="token punctuation">.</span>loadDataAtStart<span class="token operator">=</span><span class="token boolean">false</span>

    db<span class="token punctuation">.</span>num<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">MYSQL_DATABASE_NUM</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span>

    db<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">=</span>jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">MYSQL_SERVICE_HOST</span><span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">MYSQL_SERVICE_PORT</span><span class="token operator">:</span><span class="token number">3306</span><span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">MYSQL_SERVICE_DB_NAME</span><span class="token punctuation">}</span><span class="token operator">?</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">MYSQL_SERVICE_DB_PARAM</span><span class="token operator">:</span>characterEncoding<span class="token operator">=</span>utf8<span class="token operator">&amp;</span>connectTimeout<span class="token operator">=</span><span class="token number">1000</span><span class="token operator">&amp;</span>socketTimeout<span class="token operator">=</span><span class="token number">3000</span><span class="token operator">&amp;</span>autoReconnect<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>useSSL<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">}</span>

    db<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token number">1</span><span class="token operator">=</span>jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">MYSQL_SERVICE_HOST</span><span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">MYSQL_SERVICE_PORT</span><span class="token operator">:</span><span class="token number">3306</span><span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">MYSQL_SERVICE_DB_NAME</span><span class="token punctuation">}</span><span class="token operator">?</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">MYSQL_SERVICE_DB_PARAM</span><span class="token operator">:</span>characterEncoding<span class="token operator">=</span>utf8<span class="token operator">&amp;</span>connectTimeout<span class="token operator">=</span><span class="token number">1000</span><span class="token operator">&amp;</span>socketTimeout<span class="token operator">=</span><span class="token number">3000</span><span class="token operator">&amp;</span>autoReconnect<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>useSSL<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">}</span>

    db<span class="token punctuation">.</span>user<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">MYSQL_SERVICE_USER</span><span class="token punctuation">}</span>

    db<span class="token punctuation">.</span>password<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">MYSQL_SERVICE_PASSWORD</span><span class="token punctuation">}</span>

    ### <span class="token class-name">The</span> auth system <span class="token keyword">to</span> <span class="token namespace">use</span><span class="token punctuation">,</span> currently only <span class="token char">'nacos'</span> and <span class="token char">'ldap'</span> is supported<span class="token operator">:</span>

    nacos<span class="token punctuation">.</span>core<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>system<span class="token punctuation">.</span>type<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">NACOS_AUTH_SYSTEM_TYPE</span><span class="token operator">:</span>nacos<span class="token punctuation">}</span>

    ### worked when nacos<span class="token punctuation">.</span>core<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>system<span class="token punctuation">.</span>type<span class="token operator">=</span>nacos

    ### <span class="token class-name">The</span> token expiration in seconds<span class="token operator">:</span>

    nacos<span class="token punctuation">.</span>core<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>plugin<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>token<span class="token punctuation">.</span>expire<span class="token punctuation">.</span>seconds<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">NACOS_AUTH_TOKEN_EXPIRE_SECONDS</span><span class="token operator">:</span><span class="token number">18000</span><span class="token punctuation">}</span>

    ### <span class="token class-name">The</span> <span class="token keyword">default</span> token<span class="token operator">:</span>

    nacos<span class="token punctuation">.</span>core<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>plugin<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>token<span class="token punctuation">.</span>secret<span class="token punctuation">.</span>key<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">NACOS_AUTH_TOKEN</span><span class="token operator">:</span><span class="token class-name">SecretKey012345678901234567890123456789012345678901234567890123456789</span><span class="token punctuation">}</span>

    ### <span class="token class-name">Turn</span> on<span class="token operator">/</span>off caching of auth <span class="token class-name"><span class="token namespace">information<span class="token punctuation">.</span></span> By</span> turning on <span class="token keyword">this</span> <span class="token keyword">switch</span><span class="token punctuation">,</span> the
    update of auth information would have a <span class="token number">15</span> seconds delay<span class="token punctuation">.</span>

    nacos<span class="token punctuation">.</span>core<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>caching<span class="token punctuation">.</span>enabled<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">NACOS_AUTH_CACHE_ENABLE</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span>

    nacos<span class="token punctuation">.</span>core<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>enable<span class="token punctuation">.</span>userAgentAuthWhite<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">NACOS_AUTH_USER_AGENT_AUTH_WHITE_ENABLE</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span>

    nacos<span class="token punctuation">.</span>core<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>server<span class="token punctuation">.</span>identity<span class="token punctuation">.</span>key<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">NACOS_AUTH_IDENTITY_KEY</span><span class="token operator">:</span>serverIdentity<span class="token punctuation">}</span>

    nacos<span class="token punctuation">.</span>core<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>server<span class="token punctuation">.</span>identity<span class="token punctuation">.</span>value<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">NACOS_AUTH_IDENTITY_VALUE</span><span class="token operator">:</span>security<span class="token punctuation">}</span>

    server<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>accesslog<span class="token punctuation">.</span>enabled<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">TOMCAT_ACCESSLOG_ENABLED</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span>

    # <span class="token keyword">default</span> current work dir

    server<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>basedir<span class="token operator">=</span>file<span class="token operator">:</span><span class="token punctuation">.</span>

    ## spring security config

    ### turn off security

    nacos<span class="token punctuation">.</span>security<span class="token punctuation">.</span>ignore<span class="token punctuation">.</span>urls<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">NACOS_SECURITY_IGNORE_URLS</span><span class="token operator">:</span><span class="token operator">/</span><span class="token punctuation">,</span><span class="token operator">/</span>error<span class="token punctuation">,</span><span class="token comment">/**/</span><span class="token operator">*</span><span class="token punctuation">.</span>css<span class="token punctuation">,</span><span class="token comment">/**/</span><span class="token operator">*</span><span class="token punctuation">.</span>js<span class="token punctuation">,</span><span class="token comment">/**/</span><span class="token operator">*</span><span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token comment">/**/</span><span class="token operator">*</span><span class="token punctuation">.</span>map<span class="token punctuation">,</span><span class="token comment">/**/</span><span class="token operator">*</span><span class="token punctuation">.</span>svg<span class="token punctuation">,</span><span class="token comment">/**/</span><span class="token operator">*</span><span class="token punctuation">.</span>png<span class="token punctuation">,</span><span class="token comment">/**/</span><span class="token operator">*</span><span class="token punctuation">.</span>ico<span class="token punctuation">,</span><span class="token operator">/</span>console<span class="token operator">-</span>fe<span class="token operator">/</span><span class="token keyword">public</span><span class="token comment">/**,/v1/auth/**,/v1/console/health/**,/actuator/**,/v1/console/server/**}

    # metrics for elastic search

    management.metrics.export.elastic.enabled=false

    management.metrics.export.influx.enabled=false

    nacos.naming.distro.taskDispatchThreadCount=10

    nacos.naming.distro.taskDispatchPeriod=200

    nacos.naming.distro.batchSyncKeyCount=1000

    nacos.naming.distro.initDataRatio=0.9

    nacos.naming.distro.syncRetryDelay=5000

    nacos.naming.data.warmup=true

    nacos.istio.mcp.server.enabled=true

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nacos-cm
  namespace: nacos
data:
  mysql.db.name: nacos # 配置成你自己的Mysql的数据库名称，记得提前创建
  mysql.host: 192.168.139.133 #配置成你自己的Mysql的IP
  mysql.port: '32306' #配置成你自己的Mysql的Port
  mysql.user: root #配置成你自己的Mysql的用户名
  mysql.password: '123456' #配置成你自己的Mysql的密码

---

apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: nacos
  name: nacos
  namespace: nacos
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nacos
  serviceName: nacos-service
  template:
    metadata:
      labels:
        app: nacos
    spec:
      containers:
        - env:
            - name: NACOS_REPLICAS
              value: '3'
            - name: NACOS_SERVERS
              value: &gt;-
                nacos-0.nacos-service.nacos.svc.cluster.local:8848
                nacos-1.nacos-service.nacos.svc.cluster.local:8848
                nacos-2.nacos-service.nacos.svc.cluster.local:8848
            - name: MYSQL_SERVICE_HOST
              valueFrom:
                configMapKeyRef:
                  key: mysql.host
                  name: nacos-cm
            - name: MYSQL_SERVICE_DB_NAME
              valueFrom:
                configMapKeyRef:
                  key: mysql.db.name
                  name: nacos-cm
            - name: MYSQL_SERVICE_PORT
              valueFrom:
                configMapKeyRef:
                  key: mysql.port
                  name: nacos-cm
            - name: MYSQL_SERVICE_USER
              valueFrom:
                configMapKeyRef:
                  key: mysql.user
                  name: nacos-cm
            - name: MYSQL_SERVICE_PASSWORD
              valueFrom:
                configMapKeyRef:
                  key: mysql.password
                  name: nacos-cm
            - name: NACOS_SERVER_PORT
              value: '8848'
            - name: NACOS_APPLICATION_PORT
              value: '8848'
            - name: PREFER_HOST_MODE
              value: hostname
          image: 'nacos/nacos-server:v2.1.1'
          imagePullPolicy: IfNotPresent
          name: nacos
          ports:
            - containerPort: 8848
              name: client-port
              protocol: TCP
            - containerPort: 9848
              name: client-rpc
              protocol: TCP
            - containerPort: 9849
              name: raft-rpc
              protocol: TCP
            - containerPort: 7848
              name: old-raft-rpc
              protocol: TCP
          volumeMounts:
            - mountPath: /opt/nacos/data
              name: data
              subPath: data
            - mountPath: /opt/nacos/logs
              name: data
              subPath: logs
            - mountPath: /home/nacos/conf/application.properties
              name: nacos-config
              subPath: application.properties
      volumes:
        - configMap:
            items:
              - key: application.properties
                path: application.properties
            name: nacos-config
          name: nacos-config
  volumeClaimTemplates:
    - apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: data
      spec:
        accessModes:
          - ReadWriteMany
        resources:
          requests:
            storage: 100Mi

---

apiVersion: v1
kind: Service
metadata:
  labels:
    app: nacos-service
  name: nacos-service
  namespace: nacos
spec:
  ports:
    - name: server
      port: 8848
      protocol: TCP
      targetPort: 8848
    - name: client-rpc
      port: 9848
      protocol: TCP
      targetPort: 9848
    - name: raft-rpc
      port: 9849
      protocol: TCP
      targetPort: 9849
    - name: old-raft-rpc
      port: 7848
      protocol: TCP
      targetPort: 7848
  selector:
    app: nacos
  type: NodePort
</span></code></pre> 
<h5><a id="1313nacos_3193"></a>13.1.3、访问nacos</h5> 
<ul><li>访问链接：<code>http://ip:port/nacos/</code></li><li>用户名：nacos</li><li>密码：nacos</li></ul> 
<h3><a id="14sonar_3199"></a>14、安装sonar</h3> 
<h4><a id="141_3200"></a>14.1、单机版</h4> 
<h5><a id="1411sonardb_3201"></a>14.1.1、安装sonar-db</h5> 
<pre><code class="prism language-java">apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">PersistentVolumeClaim</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> sonar<span class="token operator">-</span>postgres
  namespace<span class="token operator">:</span> sonar
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> sonar<span class="token operator">-</span>postgres
spec<span class="token operator">:</span>
  storageClassName<span class="token operator">:</span> managed<span class="token operator">-</span>nfs<span class="token operator">-</span>storage
  accessModes<span class="token operator">:</span>
  <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
  resources<span class="token operator">:</span>
    requests<span class="token operator">:</span>
      storage<span class="token operator">:</span> <span class="token number">1</span>Gi

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
kind<span class="token operator">:</span> <span class="token class-name">Deployment</span>
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> sonar<span class="token operator">-</span>db
    name<span class="token operator">:</span> sonar<span class="token operator">-</span>db
  name<span class="token operator">:</span> sonar<span class="token operator">-</span>db
  namespace<span class="token operator">:</span> sonar
spec<span class="token operator">:</span>
  replicas<span class="token operator">:</span> <span class="token number">1</span>
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> sonar<span class="token operator">-</span>db
      name<span class="token operator">:</span> sonar<span class="token operator">-</span>db
  template<span class="token operator">:</span>
    metadata<span class="token operator">:</span>
      labels<span class="token operator">:</span>
        app<span class="token operator">:</span> sonar<span class="token operator">-</span>db
        name<span class="token operator">:</span> sonar<span class="token operator">-</span>db
    spec<span class="token operator">:</span>
      containers<span class="token operator">:</span>
        <span class="token operator">-</span> env<span class="token operator">:</span>
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">POSTGRES_DB</span>
              value<span class="token operator">:</span> sonardb
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">POSTGRES_USER</span>
              value<span class="token operator">:</span> sonar
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">POSTGRES_PASSWORD</span>
              value<span class="token operator">:</span> <span class="token char">'123456'</span>
          image<span class="token operator">:</span> 'postgres<span class="token operator">:</span><span class="token number">12.9</span>'
          imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
          name<span class="token operator">:</span> postgres
          ports<span class="token operator">:</span>
            <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">5432</span>
              protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
          volumeMounts<span class="token operator">:</span>
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>postgresql<span class="token operator">/</span>data
              name<span class="token operator">:</span> sonar<span class="token operator">-</span>postgres
      volumes<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> sonar<span class="token operator">-</span>postgres
          persistentVolumeClaim<span class="token operator">:</span>
            claimName<span class="token operator">:</span> sonar<span class="token operator">-</span>postgres

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">Service</span>
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    name<span class="token operator">:</span> sonar<span class="token operator">-</span>db
  name<span class="token operator">:</span> sonar<span class="token operator">-</span>db
  namespace<span class="token operator">:</span> sonar
spec<span class="token operator">:</span>
  ports<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> tcp<span class="token operator">-</span>port<span class="token operator">-</span><span class="token number">0</span>
      port<span class="token operator">:</span> <span class="token number">5432</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">5432</span>
  selector<span class="token operator">:</span>
    name<span class="token operator">:</span> sonar<span class="token operator">-</span>db
  type<span class="token operator">:</span> <span class="token class-name">ClusterIP</span>
</code></pre> 
<h5><a id="1412sonarqube_3282"></a>14.1.2、安装sonarqube</h5> 
<p><strong>说明：</strong> 该容器running的速度有点慢，所以可能要稍等一会才行</p> 
<pre><code class="prism language-java">apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">PersistentVolumeClaim</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> sonar<span class="token operator">-</span>extensions
  namespace<span class="token operator">:</span> sonar
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> sonar<span class="token operator">-</span>extensions
spec<span class="token operator">:</span>
  storageClassName<span class="token operator">:</span> managed<span class="token operator">-</span>nfs<span class="token operator">-</span>storage
  accessModes<span class="token operator">:</span>
  <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
  resources<span class="token operator">:</span>
    requests<span class="token operator">:</span>
      storage<span class="token operator">:</span> <span class="token number">500</span>Mi

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">PersistentVolumeClaim</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> sonar<span class="token operator">-</span>data
  namespace<span class="token operator">:</span> sonar
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> sonar<span class="token operator">-</span>data
spec<span class="token operator">:</span>
  storageClassName<span class="token operator">:</span> managed<span class="token operator">-</span>nfs<span class="token operator">-</span>storage
  accessModes<span class="token operator">:</span>
  <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
  resources<span class="token operator">:</span>
    requests<span class="token operator">:</span>
      storage<span class="token operator">:</span> <span class="token number">1</span>Gi

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">PersistentVolumeClaim</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span>  sonar<span class="token operator">-</span>pdf<span class="token operator">-</span>file
  namespace<span class="token operator">:</span> sonar
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span>  sonar<span class="token operator">-</span>pdf<span class="token operator">-</span>file
spec<span class="token operator">:</span>
  storageClassName<span class="token operator">:</span> managed<span class="token operator">-</span>nfs<span class="token operator">-</span>storage
  accessModes<span class="token operator">:</span>
  <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
  resources<span class="token operator">:</span>
    requests<span class="token operator">:</span>
      storage<span class="token operator">:</span> <span class="token number">500</span>Mi

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
kind<span class="token operator">:</span> <span class="token class-name">Deployment</span>
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> sonarqube
    name<span class="token operator">:</span> sonarqube
  name<span class="token operator">:</span> sonarqube
  namespace<span class="token operator">:</span> sonar
spec<span class="token operator">:</span>
  replicas<span class="token operator">:</span> <span class="token number">1</span>
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> sonarqube
      name<span class="token operator">:</span> sonarqube
  template<span class="token operator">:</span>
    metadata<span class="token operator">:</span>
      labels<span class="token operator">:</span>
        app<span class="token operator">:</span> sonarqube
        name<span class="token operator">:</span> sonarqube
    spec<span class="token operator">:</span>
      initContainers<span class="token operator">:</span>
        <span class="token operator">-</span> command<span class="token operator">:</span>
            <span class="token operator">-</span> sysctl
            <span class="token operator">-</span> <span class="token char">'-w'</span>
            <span class="token operator">-</span> vm<span class="token punctuation">.</span>max_map_count<span class="token operator">=</span><span class="token number">262144</span> # 不设置会在启动的时候出现：max virtual memory areas vm<span class="token punctuation">.</span>max_map_count <span class="token punctuation">[</span><span class="token number">65530</span><span class="token punctuation">]</span> is too low
          image<span class="token operator">:</span> 'busybox'
          imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
          securityContext<span class="token operator">:</span>                     
            runAsUser<span class="token operator">:</span> <span class="token number">0</span>                      #设置以<span class="token constant">ROOT</span>用户运行容器，不然无法设置vm<span class="token punctuation">.</span>max_map_count属性值
            privileged<span class="token operator">:</span> <span class="token boolean">true</span>                  #拥有特权
          name<span class="token operator">:</span> init<span class="token operator">-</span>sysctl
          ports<span class="token operator">:</span>
            <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">80</span>
              protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      containers<span class="token operator">:</span>
        <span class="token operator">-</span> env<span class="token operator">:</span>
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">SONAR_JDBC_USERNAME</span>
              value<span class="token operator">:</span> sonar
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">SONAR_JDBC_PASSWORD</span>
              value<span class="token operator">:</span> <span class="token char">'123456'</span>
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">SONAR_JDBC_URL</span>
              value<span class="token operator">:</span> 'jdbc<span class="token operator">:</span>postgresql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>sonar<span class="token operator">-</span>db<span class="token punctuation">.</span>sonar<span class="token operator">:</span><span class="token number">5432</span><span class="token operator">/</span>sonardb'
          image<span class="token operator">:</span> 'sonarqube<span class="token operator">:</span>latest'
          imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
          name<span class="token operator">:</span> sonarqube
          ports<span class="token operator">:</span>
            <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">9000</span>
              protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
          readinessProbe<span class="token operator">:</span>
            failureThreshold<span class="token operator">:</span> <span class="token number">3</span>
            httpGet<span class="token operator">:</span>
              path<span class="token operator">:</span> <span class="token operator">/</span>
              port<span class="token operator">:</span> <span class="token number">9000</span>
              scheme<span class="token operator">:</span> <span class="token constant">HTTP</span>
            initialDelaySeconds<span class="token operator">:</span> <span class="token number">240</span>
            periodSeconds<span class="token operator">:</span> <span class="token number">5</span>
            successThreshold<span class="token operator">:</span> <span class="token number">1</span>
            timeoutSeconds<span class="token operator">:</span> <span class="token number">5</span>
          volumeMounts<span class="token operator">:</span>
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>opt<span class="token operator">/</span>sonarqube<span class="token operator">/</span>extensions
              name<span class="token operator">:</span> sonar<span class="token operator">-</span>extensions
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>opt<span class="token operator">/</span>sonarqube<span class="token operator">/</span>data
              name<span class="token operator">:</span> sonar<span class="token operator">-</span>data
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>opt<span class="token operator">/</span>sonarqube<span class="token operator">/</span>pdf<span class="token operator">-</span>files
              name<span class="token operator">:</span> sonar<span class="token operator">-</span>pdf<span class="token operator">-</span>file
      volumes<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> sonar<span class="token operator">-</span>extensions
          persistentVolumeClaim<span class="token operator">:</span>
            claimName<span class="token operator">:</span> sonar<span class="token operator">-</span>extensions
        <span class="token operator">-</span> name<span class="token operator">:</span> sonar<span class="token operator">-</span>data
          persistentVolumeClaim<span class="token operator">:</span>
            claimName<span class="token operator">:</span> sonar<span class="token operator">-</span>data
        <span class="token operator">-</span> name<span class="token operator">:</span> sonar<span class="token operator">-</span>pdf<span class="token operator">-</span>file
          persistentVolumeClaim<span class="token operator">:</span>
            claimName<span class="token operator">:</span> sonar<span class="token operator">-</span>pdf<span class="token operator">-</span>file

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">Service</span>
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    name<span class="token operator">:</span> sonarqube
  name<span class="token operator">:</span> sonarqube
  namespace<span class="token operator">:</span> sonar
spec<span class="token operator">:</span>
  ports<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> tcp<span class="token operator">-</span>port<span class="token operator">-</span><span class="token number">0</span>
      nodePort<span class="token operator">:</span> <span class="token number">31010</span>
      port<span class="token operator">:</span> <span class="token number">9000</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">9000</span>
  selector<span class="token operator">:</span>
    name<span class="token operator">:</span> sonarqube
  type<span class="token operator">:</span> <span class="token class-name">NodePort</span>
</code></pre> 
<h3><a id="15mongodb_3436"></a>15、单机版mongodb安装</h3> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s.kuboard.cn/name</span><span class="token punctuation">:</span> mongodb
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mongodb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s.kuboard.cn/name</span><span class="token punctuation">:</span> mongodb
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> mongodb
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s.kuboard.cn/name</span><span class="token punctuation">:</span> mongodb
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MONGO_INITDB_ROOT_USERNAME
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"root"</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MONGO_INITDB_ROOT_PASSWORD
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"123456"</span>
          <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">27017</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/db
              <span class="token key atrule">name</span><span class="token punctuation">:</span> data
  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
      <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> data
      <span class="token key atrule">spec</span><span class="token punctuation">:</span>
        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> ReadWriteMany
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token string">"managed-nfs-storage"</span>

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s.kuboard.cn/name</span><span class="token punctuation">:</span> mongodb
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mongodb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> outport
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">27017</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30017</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s.kuboard.cn/name</span><span class="token punctuation">:</span> mongodb
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre> 
<h3><a id="16Elasticsearch_3505"></a>16、单机版Elasticsearch安装</h3> 
<h4><a id="161ES7_3506"></a>16.1、ES7简单安装</h4> 
<p><strong>插件：</strong></p> 
<p>链接：<a href="https://pan.baidu.com/s/10Z4Gp-ilK0zB-XQ7uZIxww?pwd=ves1" rel="nofollow">https://pan.baidu.com/s/10Z4Gp-ilK0zB-XQ7uZIxww?pwd=ves1</a></p> 
<p>提取码：<code>ves1</code></p> 
<p><strong>可执行yaml文件：</strong></p> 
<pre><code class="prism language-java"><span class="token operator">--</span><span class="token operator">-</span>
apiVersion<span class="token operator">:</span> v1
data<span class="token operator">:</span>
  elasticsearch<span class="token punctuation">.</span>yml<span class="token operator">:</span> <span class="token operator">&gt;</span><span class="token operator">-</span>
    cluster<span class="token punctuation">.</span>name<span class="token operator">:</span> my<span class="token operator">-</span>es

    node<span class="token punctuation">.</span>name<span class="token operator">:</span> <span class="token string">"node-1"</span>

    path<span class="token punctuation">.</span>data<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>data

    #path<span class="token punctuation">.</span>logs<span class="token operator">:</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>elasticsearch

    path<span class="token punctuation">.</span>logs<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>logs

    bootstrap<span class="token punctuation">.</span>memory_lock<span class="token operator">:</span> <span class="token boolean">false</span>

    network<span class="token punctuation">.</span>host<span class="token operator">:</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>

    http<span class="token punctuation">.</span>port<span class="token operator">:</span> <span class="token number">9200</span>

    discovery<span class="token punctuation">.</span>seed_hosts<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token string">"[::1]"</span><span class="token punctuation">]</span>

    cluster<span class="token punctuation">.</span>initial_master_nodes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"node-1"</span><span class="token punctuation">]</span>

    #增加参数，使head插件可以访问es

    http<span class="token punctuation">.</span>cors<span class="token punctuation">.</span>enabled<span class="token operator">:</span> <span class="token boolean">true</span>

    http<span class="token punctuation">.</span>cors<span class="token punctuation">.</span>allow<span class="token operator">-</span>origin<span class="token operator">:</span> <span class="token string">"*"</span>

    http<span class="token punctuation">.</span>cors<span class="token punctuation">.</span>allow<span class="token operator">-</span>headers<span class="token operator">:</span>
    <span class="token class-name">Authorization</span><span class="token punctuation">,</span><span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Requested</span><span class="token operator">-</span><span class="token class-name">With</span><span class="token punctuation">,</span><span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Length</span><span class="token punctuation">,</span><span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span>

    xpack<span class="token punctuation">.</span>security<span class="token punctuation">.</span>enabled<span class="token operator">:</span> <span class="token boolean">false</span>
kind<span class="token operator">:</span> <span class="token class-name">ConfigMap</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> es<span class="token operator">-</span>config
  namespace<span class="token operator">:</span> elasticsearch

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
kind<span class="token operator">:</span> <span class="token class-name">StatefulSet</span>
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> elasticsearch
  name<span class="token operator">:</span> elasticsearch
  namespace<span class="token operator">:</span> elasticsearch
spec<span class="token operator">:</span>
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> elasticsearch
  serviceName<span class="token operator">:</span> elasticsearch
  template<span class="token operator">:</span>
    metadata<span class="token operator">:</span>
      labels<span class="token operator">:</span>
        app<span class="token operator">:</span> elasticsearch
    spec<span class="token operator">:</span>
      initContainers<span class="token operator">:</span>
      <span class="token operator">-</span> name<span class="token operator">:</span> init<span class="token operator">-</span>sysctl
        image<span class="token operator">:</span> busybox
        imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
        command<span class="token operator">:</span>
        <span class="token operator">-</span> sysctl
        <span class="token operator">-</span> <span class="token operator">-</span>w
        <span class="token operator">-</span> vm<span class="token punctuation">.</span>max_map_count<span class="token operator">=</span><span class="token number">262144</span>
        securityContext<span class="token operator">:</span>
          privileged<span class="token operator">:</span> <span class="token boolean">true</span>
      containers<span class="token operator">:</span>
        <span class="token operator">-</span> env<span class="token operator">:</span>
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">TZ</span>
              value<span class="token operator">:</span> <span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Shanghai</span>
          image<span class="token operator">:</span> 'elasticsearch<span class="token operator">:</span><span class="token number">7.6</span><span class="token number">.0</span>'
          imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
          name<span class="token operator">:</span> elasticsearch
          ports<span class="token operator">:</span>
          <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">9200</span>
          <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">9300</span>
          volumeMounts<span class="token operator">:</span>
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>config<span class="token operator">/</span>elasticsearch<span class="token punctuation">.</span>yml
              name<span class="token operator">:</span> es<span class="token operator">-</span>config
              subPath<span class="token operator">:</span> elasticsearch<span class="token punctuation">.</span>yml
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>data
              name<span class="token operator">:</span> es<span class="token operator">-</span>persistent<span class="token operator">-</span>storage
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>plugins
              name<span class="token operator">:</span> es<span class="token operator">-</span>plugins
      volumes<span class="token operator">:</span>
        <span class="token operator">-</span> configMap<span class="token operator">:</span>
            name<span class="token operator">:</span> es<span class="token operator">-</span>config
          name<span class="token operator">:</span> es<span class="token operator">-</span>config
  volumeClaimTemplates<span class="token operator">:</span>
    <span class="token operator">-</span> apiVersion<span class="token operator">:</span> v1
      kind<span class="token operator">:</span> <span class="token class-name">PersistentVolumeClaim</span>
      metadata<span class="token operator">:</span>
        name<span class="token operator">:</span> es<span class="token operator">-</span>persistent<span class="token operator">-</span>storage
      spec<span class="token operator">:</span>
        accessModes<span class="token operator">:</span>
          <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
        resources<span class="token operator">:</span>
          requests<span class="token operator">:</span>
            storage<span class="token operator">:</span> <span class="token number">500</span>Mi
        storageClassName<span class="token operator">:</span> <span class="token string">"managed-nfs-storage"</span> # nfs默认存储类名称
    <span class="token operator">-</span> apiVersion<span class="token operator">:</span> v1
      kind<span class="token operator">:</span> <span class="token class-name">PersistentVolumeClaim</span>
      metadata<span class="token operator">:</span>
        name<span class="token operator">:</span> es<span class="token operator">-</span>plugins
      spec<span class="token operator">:</span>
        accessModes<span class="token operator">:</span>
          <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
        resources<span class="token operator">:</span>
          requests<span class="token operator">:</span>
            storage<span class="token operator">:</span> <span class="token number">100</span>Mi
        storageClassName<span class="token operator">:</span> <span class="token string">"managed-nfs-storage"</span> # nfs默认存储类名称
        
<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">Service</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> elasticsearch
  namespace<span class="token operator">:</span> elasticsearch
spec<span class="token operator">:</span>
  ports<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> es9200
      nodePort<span class="token operator">:</span> <span class="token number">19201</span>
      port<span class="token operator">:</span> <span class="token number">9200</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">9200</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> es9300
      nodePort<span class="token operator">:</span> <span class="token number">19301</span>
      port<span class="token operator">:</span> <span class="token number">9300</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">9300</span>
  selector<span class="token operator">:</span>
    app<span class="token operator">:</span> elasticsearch
  type<span class="token operator">:</span> <span class="token class-name">NodePort</span>
</code></pre> 
<h4><a id="162ES8_3655"></a>16.2、ES8简单安装</h4> 
<p><strong>插件：</strong></p> 
<p>链接：<a href="https://pan.baidu.com/s/1M1QpDKSJd92PybPdR2W4Jg?pwd=n24z" rel="nofollow">https://pan.baidu.com/s/1M1QpDKSJd92PybPdR2W4Jg?pwd=n24z</a></p> 
<p>提取码：<code>n24z</code></p> 
<p><strong>可执行yaml文件：</strong></p> 
<pre><code class="prism language-java"><span class="token operator">--</span><span class="token operator">-</span>
apiVersion<span class="token operator">:</span> v1
data<span class="token operator">:</span>
  elasticsearch<span class="token punctuation">.</span>yml<span class="token operator">:</span> <span class="token operator">&gt;</span>
    cluster<span class="token punctuation">.</span>name<span class="token operator">:</span> my<span class="token operator">-</span>es

    node<span class="token punctuation">.</span>name<span class="token operator">:</span> <span class="token string">"node-1"</span>

    path<span class="token punctuation">.</span>data<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>data

    #path<span class="token punctuation">.</span>logs<span class="token operator">:</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>elasticsearch

    bootstrap<span class="token punctuation">.</span>memory_lock<span class="token operator">:</span> <span class="token boolean">false</span>

    network<span class="token punctuation">.</span>host<span class="token operator">:</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>

    http<span class="token punctuation">.</span>port<span class="token operator">:</span> <span class="token number">9200</span>

    discovery<span class="token punctuation">.</span>seed_hosts<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token string">"[::1]"</span><span class="token punctuation">]</span>

    cluster<span class="token punctuation">.</span>initial_master_nodes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"node-1"</span><span class="token punctuation">]</span>

    #增加参数，使head插件可以访问es

    http<span class="token punctuation">.</span>cors<span class="token punctuation">.</span>enabled<span class="token operator">:</span> <span class="token boolean">true</span>

    http<span class="token punctuation">.</span>cors<span class="token punctuation">.</span>allow<span class="token operator">-</span>origin<span class="token operator">:</span> <span class="token string">"*"</span>

    http<span class="token punctuation">.</span>cors<span class="token punctuation">.</span>allow<span class="token operator">-</span>headers<span class="token operator">:</span>
    <span class="token class-name">Authorization</span><span class="token punctuation">,</span><span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Requested</span><span class="token operator">-</span><span class="token class-name">With</span><span class="token punctuation">,</span><span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Length</span><span class="token punctuation">,</span><span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span>

    xpack<span class="token punctuation">.</span>security<span class="token punctuation">.</span>enabled<span class="token operator">:</span> <span class="token boolean">false</span>
kind<span class="token operator">:</span> <span class="token class-name">ConfigMap</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> es<span class="token operator">-</span>config
  namespace<span class="token operator">:</span> es8<span class="token operator">-</span>simple

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
kind<span class="token operator">:</span> <span class="token class-name">StatefulSet</span>
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> elasticsearch
  name<span class="token operator">:</span> elasticsearch
  namespace<span class="token operator">:</span> es8<span class="token operator">-</span>simple
spec<span class="token operator">:</span>
  replicas<span class="token operator">:</span> <span class="token number">1</span>
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> elasticsearch
  serviceName<span class="token operator">:</span> elasticsearch
  template<span class="token operator">:</span>
    metadata<span class="token operator">:</span>
      labels<span class="token operator">:</span>
        app<span class="token operator">:</span> elasticsearch
    spec<span class="token operator">:</span>
      containers<span class="token operator">:</span>
        <span class="token operator">-</span> env<span class="token operator">:</span>
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">TZ</span>
              value<span class="token operator">:</span> <span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Shanghai</span>
          image<span class="token operator">:</span> 'elasticsearch<span class="token operator">:</span><span class="token number">8.2</span><span class="token number">.3</span>'
          imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
          name<span class="token operator">:</span> elasticsearch
          resources<span class="token operator">:</span>
            limits<span class="token operator">:</span>
              cpu<span class="token operator">:</span> <span class="token char">'1'</span>
              memory<span class="token operator">:</span> <span class="token number">2</span>Gi
            requests<span class="token operator">:</span>
              cpu<span class="token operator">:</span> <span class="token char">'1'</span>
              memory<span class="token operator">:</span> <span class="token number">1</span>Gi
          volumeMounts<span class="token operator">:</span>
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>config<span class="token operator">/</span>elasticsearch<span class="token punctuation">.</span>yml
              name<span class="token operator">:</span> es<span class="token operator">-</span>config
              subPath<span class="token operator">:</span> elasticsearch<span class="token punctuation">.</span>yml
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>data
              name<span class="token operator">:</span> es<span class="token operator">-</span>persistent<span class="token operator">-</span>storage
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>plugins
              name<span class="token operator">:</span> es<span class="token operator">-</span>plugins
      imagePullSecrets<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> docker<span class="token operator">-</span>login
      volumes<span class="token operator">:</span>
        <span class="token operator">-</span> configMap<span class="token operator">:</span>
            name<span class="token operator">:</span> es<span class="token operator">-</span>config
          name<span class="token operator">:</span> es<span class="token operator">-</span>config
  volumeClaimTemplates<span class="token operator">:</span>
    <span class="token operator">-</span> apiVersion<span class="token operator">:</span> v1
      kind<span class="token operator">:</span> <span class="token class-name">PersistentVolumeClaim</span>
      metadata<span class="token operator">:</span>
        name<span class="token operator">:</span> es<span class="token operator">-</span>persistent<span class="token operator">-</span>storage
      spec<span class="token operator">:</span>
        accessModes<span class="token operator">:</span>
          <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
        resources<span class="token operator">:</span>
          requests<span class="token operator">:</span>
            storage<span class="token operator">:</span> <span class="token number">500</span>Mi
        storageClassName<span class="token operator">:</span> <span class="token string">"managed-nfs-storage"</span> # nfs默认存储类名称
    <span class="token operator">-</span> apiVersion<span class="token operator">:</span> v1
      kind<span class="token operator">:</span> <span class="token class-name">PersistentVolumeClaim</span>
      metadata<span class="token operator">:</span>
        name<span class="token operator">:</span> es<span class="token operator">-</span>plugins
      spec<span class="token operator">:</span>
        accessModes<span class="token operator">:</span>
          <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
        resources<span class="token operator">:</span>
          requests<span class="token operator">:</span>
            storage<span class="token operator">:</span> <span class="token number">100</span>Mi
        storageClassName<span class="token operator">:</span> <span class="token string">"managed-nfs-storage"</span> # nfs默认存储类名称

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">Service</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> elasticsearch
  namespace<span class="token operator">:</span> es8<span class="token operator">-</span>simple
spec<span class="token operator">:</span>
  ports<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> es9200
      port<span class="token operator">:</span> <span class="token number">9200</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">9200</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> es9300
      port<span class="token operator">:</span> <span class="token number">9300</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">9300</span>
  selector<span class="token operator">:</span>
    app<span class="token operator">:</span> elasticsearch
  type<span class="token operator">:</span> <span class="token class-name">NodePort</span>
</code></pre> 
<h4><a id="163ES8_3798"></a>16.3、ES8全面安装</h4> 
<p><strong>插件：</strong></p> 
<p>链接：<a href="https://pan.baidu.com/s/1M1QpDKSJd92PybPdR2W4Jg?pwd=n24z" rel="nofollow">https://pan.baidu.com/s/1M1QpDKSJd92PybPdR2W4Jg?pwd=n24z</a></p> 
<p>提取码：<code>n24z</code></p> 
<p><strong>可执行yaml文件：</strong></p> 
<pre><code class="prism language-java"><span class="token operator">--</span><span class="token operator">-</span>
apiVersion<span class="token operator">:</span> v1
data<span class="token operator">:</span>
  <span class="token keyword">default</span><span class="token punctuation">.</span>policy<span class="token operator">:</span> <span class="token string">"//\n\n// Permissions required by modules stored in a run-time image and loaded\n\n// by the platform class loader.\n\n//\n\n// NOTE that this file is not intended to be modified. If additional\n\n// permissions need to be granted to the modules in this file, it is\n\n// recommended that they be configured in a separate policy file or\n\n// ${java.home}/conf/security/java.policy.\n\n//\n\n\n\n\n\ngrant codeBase \"jrt:/java.compiler\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\n\n\ngrant codeBase \"jrt:/java.net.http\" {\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.sun.net\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.sun.net.util\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.sun.net.www\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.jdk.internal.misc\";\n\n    permission java.lang.RuntimePermission \"modifyThread\";\n\n    permission java.net.SocketPermission \"*\",\"connect,resolve\";\n\n    permission java.net.URLPermission \"http:*\",\"*:*\";\n\n    permission java.net.URLPermission \"https:*\",\"*:*\";\n\n    permission java.net.URLPermission \"ws:*\",\"*:*\";\n\n    permission java.net.URLPermission \"wss:*\",\"*:*\";\n\n    permission java.net.URLPermission \"socket:*\",\"CONNECT\";  // proxy\n\n    // For request/response body processors, fromFile, asFile\n\n    permission java.io.FilePermission \"&lt;&lt;ALL FILES&gt;&gt;\",\"read,write,delete\";\n\n    permission java.util.PropertyPermission \"*\",\"read\";\n\n    permission java.net.NetPermission \"getProxySelector\";\n\n};\n\n\n\ngrant codeBase \"jrt:/java.scripting\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\ngrant codeBase \"jrt:/java.security.jgss\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\ngrant codeBase \"jrt:/java.smartcardio\" {\n\n    permission javax.smartcardio.CardPermission \"*\", \"*\";\n\n    permission java.lang.RuntimePermission \"loadLibrary.j2pcsc\";\n\n    permission java.lang.RuntimePermission\n\n                   \"accessClassInPackage.sun.security.jca\";\n\n    permission java.lang.RuntimePermission\n\n                   \"accessClassInPackage.sun.security.util\";\n\n    permission java.util.PropertyPermission\n\n                   \"javax.smartcardio.TerminalFactory.DefaultType\", \"read\";\n\n    permission java.util.PropertyPermission \"os.name\", \"read\";\n\n    permission java.util.PropertyPermission \"os.arch\", \"read\";\n\n    permission java.util.PropertyPermission \"sun.arch.data.model\", \"read\";\n\n    permission java.util.PropertyPermission\n\n                   \"sun.security.smartcardio.library\", \"read\";\n\n    permission java.util.PropertyPermission\n\n                   \"sun.security.smartcardio.t0GetResponse\", \"read\";\n\n    permission java.util.PropertyPermission\n\n                   \"sun.security.smartcardio.t1GetResponse\", \"read\";\n\n    permission java.util.PropertyPermission\n\n                   \"sun.security.smartcardio.t1StripLe\", \"read\";\n\n    // needed for looking up native PC/SC library\n\n    permission java.io.FilePermission \"&lt;&lt;ALL FILES&gt;&gt;\",\"read\";\n\n    permission java.security.SecurityPermission \"putProviderProperty.SunPCSC\";\n\n    permission java.security.SecurityPermission\n\n                   \"clearProviderProperties.SunPCSC\";\n\n    permission java.security.SecurityPermission\n\n                   \"removeProviderProperty.SunPCSC\";\n\n};\n\n\n\ngrant codeBase \"jrt:/java.sql\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\ngrant codeBase \"jrt:/java.sql.rowset\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\n\n\ngrant codeBase \"jrt:/java.xml.crypto\" {\n\n    permission java.lang.RuntimePermission\n\n                   \"getStackWalkerWithClassReference\";\n\n    permission java.lang.RuntimePermission\n\n                   \"accessClassInPackage.sun.security.util\";\n\n    permission java.util.PropertyPermission \"*\", \"read\";\n\n    permission java.security.SecurityPermission \"putProviderProperty.XMLDSig\";\n\n    permission java.security.SecurityPermission\n\n                   \"clearProviderProperties.XMLDSig\";\n\n    permission java.security.SecurityPermission\n\n                   \"removeProviderProperty.XMLDSig\";\n\n    permission java.security.SecurityPermission\n\n                   \"com.sun.org.apache.xml.internal.security.register\";\n\n    permission java.security.SecurityPermission\n\n                   \"getProperty.jdk.xml.dsig.secureValidationPolicy\";\n\n    permission java.lang.RuntimePermission\n\n                   \"accessClassInPackage.com.sun.org.apache.xml.internal.*\";\n\n    permission java.lang.RuntimePermission\n\n                   \"accessClassInPackage.com.sun.org.apache.xpath.internal\";\n\n    permission java.lang.RuntimePermission\n\n                   \"accessClassInPackage.com.sun.org.apache.xpath.internal.*\";\n\n    permission java.io.FilePermission \"&lt;&lt;ALL FILES&gt;&gt;\",\"read\";\n\n    permission java.net.SocketPermission \"*\", \"connect,resolve\";\n\n};\n\n\n\n\n\ngrant codeBase \"jrt:/jdk.accessibility\" {\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.sun.awt\";\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.charsets\" {\n\n    permission java.util.PropertyPermission \"os.name\", \"read\";\n\n    permission java.lang.RuntimePermission \"charsetProvider\";\n\n    permission java.lang.RuntimePermission\n\n                   \"accessClassInPackage.jdk.internal.access\";\n\n    permission java.lang.RuntimePermission\n\n                   \"accessClassInPackage.jdk.internal.misc\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.sun.nio.cs\";\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.crypto.ec\" {\n\n    permission java.lang.RuntimePermission\n\n                   \"accessClassInPackage.sun.security.*\";\n\n    permission java.lang.RuntimePermission \"loadLibrary.sunec\";\n\n    permission java.security.SecurityPermission \"putProviderProperty.SunEC\";\n\n    permission java.security.SecurityPermission \"clearProviderProperties.SunEC\";\n\n    permission java.security.SecurityPermission \"removeProviderProperty.SunEC\";\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.crypto.cryptoki\" {\n\n    permission java.lang.RuntimePermission\n\n                   \"accessClassInPackage.com.sun.crypto.provider\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.jdk.internal.misc\";\n\n    permission java.lang.RuntimePermission\n\n                   \"accessClassInPackage.sun.security.*\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.sun.nio.ch\";\n\n    permission java.lang.RuntimePermission \"loadLibrary.j2pkcs11\";\n\n    permission java.util.PropertyPermission \"sun.security.pkcs11.allowSingleThreadedModules\", \"read\";\n\n    permission java.util.PropertyPermission \"sun.security.pkcs11.disableKeyExtraction\", \"read\";\n\n    permission java.util.PropertyPermission \"os.name\", \"read\";\n\n    permission java.util.PropertyPermission \"os.arch\", \"read\";\n\n    permission java.util.PropertyPermission \"jdk.crypto.KeyAgreement.legacyKDF\", \"read\";\n\n    permission java.security.SecurityPermission \"putProviderProperty.*\";\n\n    permission java.security.SecurityPermission \"clearProviderProperties.*\";\n\n    permission java.security.SecurityPermission \"removeProviderProperty.*\";\n\n    permission java.security.SecurityPermission\n\n                   \"getProperty.auth.login.defaultCallbackHandler\";\n\n    permission java.security.SecurityPermission \"authProvider.*\";\n\n    // Needed for reading PKCS11 config file and NSS library check\n\n    permission java.io.FilePermission \"&lt;&lt;ALL FILES&gt;&gt;\", \"read\";\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.dynalink\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.httpserver\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.internal.le\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.internal.vm.compiler\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.internal.vm.compiler.management\" {\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.jdk.internal.vm.compiler.collections\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.jdk.vm.ci.runtime\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.jdk.vm.ci.services\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.org.graalvm.compiler.core.common\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.org.graalvm.compiler.debug\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.org.graalvm.compiler.hotspot\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.org.graalvm.compiler.options\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.org.graalvm.compiler.phases.common.jmx\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.org.graalvm.compiler.serviceprovider\";\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.jsobject\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.localedata\" {\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.sun.text.*\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.sun.util.*\";\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.naming.dns\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.scripting.nashorn\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.scripting.nashorn.shell\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.security.auth\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.security.jgss\" {\n\n    permission java.security.AllPermission;\n\n};\n\n\n\ngrant codeBase \"jrt:/jdk.zipfs\" {\n\n    permission java.io.FilePermission \"&lt;&lt;ALL FILES&gt;&gt;\", \"read,write,delete\";\n\n    permission java.lang.RuntimePermission \"fileSystemProvider\";\n\n    permission java.lang.RuntimePermission \"accessUserInformation\";\n\n    permission java.util.PropertyPermission \"os.name\", \"read\";\n\n    permission java.util.PropertyPermission \"user.dir\", \"read\";\n\n    permission java.util.PropertyPermission \"user.name\", \"read\";\n\n};\n\n\n\n// permissions needed by applications using java.desktop module\n\ngrant {\n\tpermission java.net.SocketPermission \"*\", \"accept,connect,listen,resolve\";\n    permission java.lang.RuntimePermission \"accessClassInPackage.com.sun.beans\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.com.sun.beans.*\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.com.sun.java.swing.plaf.*\";\n\n    permission java.lang.RuntimePermission \"accessClassInPackage.com.apple.*\";\n\n};\n\n"</span>
  elasticsearch<span class="token punctuation">.</span>yml<span class="token operator">:</span> <span class="token operator">&gt;</span><span class="token operator">-</span>
    cluster<span class="token punctuation">.</span>name<span class="token operator">:</span> my<span class="token operator">-</span>es

    node<span class="token punctuation">.</span>name<span class="token operator">:</span> <span class="token string">"node-1"</span>

    path<span class="token punctuation">.</span>data<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>data

    #path<span class="token punctuation">.</span>logs<span class="token operator">:</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>elasticsearch

    path<span class="token punctuation">.</span>logs<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>logs

    bootstrap<span class="token punctuation">.</span>memory_lock<span class="token operator">:</span> <span class="token boolean">false</span>

    network<span class="token punctuation">.</span>host<span class="token operator">:</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>

    http<span class="token punctuation">.</span>port<span class="token operator">:</span> <span class="token number">9200</span>

    discovery<span class="token punctuation">.</span>seed_hosts<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token string">"[::1]"</span><span class="token punctuation">]</span>

    cluster<span class="token punctuation">.</span>initial_master_nodes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"node-1"</span><span class="token punctuation">]</span>

    #增加参数，使head插件可以访问es

    http<span class="token punctuation">.</span>cors<span class="token punctuation">.</span>enabled<span class="token operator">:</span> <span class="token boolean">true</span>

    http<span class="token punctuation">.</span>cors<span class="token punctuation">.</span>allow<span class="token operator">-</span>origin<span class="token operator">:</span> <span class="token string">"*"</span>

    http<span class="token punctuation">.</span>cors<span class="token punctuation">.</span>allow<span class="token operator">-</span>headers<span class="token operator">:</span>
    <span class="token class-name">Authorization</span><span class="token punctuation">,</span><span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Requested</span><span class="token operator">-</span><span class="token class-name">With</span><span class="token punctuation">,</span><span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Length</span><span class="token punctuation">,</span><span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span>

    xpack<span class="token punctuation">.</span>security<span class="token punctuation">.</span>enabled<span class="token operator">:</span> <span class="token boolean">false</span>
  log4j2<span class="token punctuation">.</span>properties<span class="token operator">:</span> <span class="token operator">&gt;</span>
    status <span class="token operator">=</span> error


    appender<span class="token punctuation">.</span>console<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">Console</span>

    appender<span class="token punctuation">.</span>console<span class="token punctuation">.</span>name <span class="token operator">=</span> console

    appender<span class="token punctuation">.</span>console<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">PatternLayout</span>

    appender<span class="token punctuation">.</span>console<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>pattern <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">%</span>d<span class="token punctuation">{<!-- --></span><span class="token constant">ISO8601</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">%</span><span class="token operator">-</span><span class="token number">5</span>p<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">%</span><span class="token operator">-</span><span class="token number">25</span>c<span class="token punctuation">{<!-- --></span><span class="token number">1.</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token operator">%</span>node_name<span class="token punctuation">]</span><span class="token operator">%</span>marker <span class="token operator">%</span>m<span class="token operator">%</span>n


    ######## <span class="token class-name">Server</span> <span class="token constant">JSON</span> ############################

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">RollingFile</span>

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>name <span class="token operator">=</span> rolling

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>fileName <span class="token operator">=</span>
    $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>base_path<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>file<span class="token punctuation">.</span>separator<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>cluster_name<span class="token punctuation">}</span>_server<span class="token punctuation">.</span>json

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">ECSJsonLayout</span>

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>dataset <span class="token operator">=</span> elasticsearch<span class="token punctuation">.</span>server


    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>filePattern <span class="token operator">=</span>
    $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>base_path<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>file<span class="token punctuation">.</span>separator<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>cluster_name<span class="token punctuation">}</span><span class="token operator">-</span><span class="token operator">%</span>d<span class="token punctuation">{<!-- --></span>yyyy<span class="token operator">-</span><span class="token constant">MM</span><span class="token operator">-</span>dd<span class="token punctuation">}</span><span class="token operator">-</span><span class="token operator">%</span>i<span class="token punctuation">.</span>json<span class="token punctuation">.</span>gz

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">Policies</span>

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>time<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">TimeBasedTriggeringPolicy</span>

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>time<span class="token punctuation">.</span>interval <span class="token operator">=</span> <span class="token number">1</span>

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>time<span class="token punctuation">.</span>modulate <span class="token operator">=</span> <span class="token boolean">true</span>

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>size<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">SizeBasedTriggeringPolicy</span>

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>size<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">128</span><span class="token constant">MB</span>

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">DefaultRolloverStrategy</span>

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>fileIndex <span class="token operator">=</span> nomax

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>action<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">Delete</span>

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>action<span class="token punctuation">.</span>basepath <span class="token operator">=</span> $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>base_path<span class="token punctuation">}</span>

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>action<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">IfFileName</span>

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>action<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>glob <span class="token operator">=</span>
    $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>cluster_name<span class="token punctuation">}</span><span class="token operator">-</span><span class="token operator">*</span>

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>action<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>nested_condition<span class="token punctuation">.</span>type <span class="token operator">=</span>
    <span class="token class-name">IfAccumulatedFileSize</span>

    appender<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>action<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>nested_condition<span class="token punctuation">.</span>exceeds <span class="token operator">=</span> <span class="token number">2</span><span class="token constant">GB</span>

    ################################################

    ######## <span class="token class-name">Server</span> <span class="token operator">-</span>  old style pattern ###########

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">RollingFile</span>

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>name <span class="token operator">=</span> rolling_old

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>fileName <span class="token operator">=</span>
    $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>base_path<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>file<span class="token punctuation">.</span>separator<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>cluster_name<span class="token punctuation">}</span><span class="token punctuation">.</span>log

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">PatternLayout</span>

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>pattern <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">%</span>d<span class="token punctuation">{<!-- --></span><span class="token constant">ISO8601</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">%</span><span class="token operator">-</span><span class="token number">5</span>p<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">%</span><span class="token operator">-</span><span class="token number">25</span>c<span class="token punctuation">{<!-- --></span><span class="token number">1.</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token operator">%</span>node_name<span class="token punctuation">]</span><span class="token operator">%</span>marker <span class="token operator">%</span>m<span class="token operator">%</span>n


    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>filePattern <span class="token operator">=</span>
    $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>base_path<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>file<span class="token punctuation">.</span>separator<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>cluster_name<span class="token punctuation">}</span><span class="token operator">-</span><span class="token operator">%</span>d<span class="token punctuation">{<!-- --></span>yyyy<span class="token operator">-</span><span class="token constant">MM</span><span class="token operator">-</span>dd<span class="token punctuation">}</span><span class="token operator">-</span><span class="token operator">%</span>i<span class="token punctuation">.</span>log<span class="token punctuation">.</span>gz

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">Policies</span>

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>time<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">TimeBasedTriggeringPolicy</span>

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>time<span class="token punctuation">.</span>interval <span class="token operator">=</span> <span class="token number">1</span>

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>time<span class="token punctuation">.</span>modulate <span class="token operator">=</span> <span class="token boolean">true</span>

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>size<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">SizeBasedTriggeringPolicy</span>

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>size<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">128</span><span class="token constant">MB</span>

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">DefaultRolloverStrategy</span>

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>fileIndex <span class="token operator">=</span> nomax

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>action<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">Delete</span>

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>action<span class="token punctuation">.</span>basepath <span class="token operator">=</span> $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>base_path<span class="token punctuation">}</span>

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>action<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">IfFileName</span>

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>action<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>glob <span class="token operator">=</span>
    $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>cluster_name<span class="token punctuation">}</span><span class="token operator">-</span><span class="token operator">*</span>

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>action<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>nested_condition<span class="token punctuation">.</span>type <span class="token operator">=</span>
    <span class="token class-name">IfAccumulatedFileSize</span>

    appender<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>action<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>nested_condition<span class="token punctuation">.</span>exceeds <span class="token operator">=</span>
    <span class="token number">2</span><span class="token constant">GB</span>

    ################################################


    rootLogger<span class="token punctuation">.</span>level <span class="token operator">=</span> info

    rootLogger<span class="token punctuation">.</span>appenderRef<span class="token punctuation">.</span>console<span class="token punctuation">.</span>ref <span class="token operator">=</span> console

    rootLogger<span class="token punctuation">.</span>appenderRef<span class="token punctuation">.</span>rolling<span class="token punctuation">.</span>ref <span class="token operator">=</span> rolling

    rootLogger<span class="token punctuation">.</span>appenderRef<span class="token punctuation">.</span>rolling_old<span class="token punctuation">.</span>ref <span class="token operator">=</span> rolling_old


    ######## <span class="token class-name">Deprecation</span> <span class="token constant">JSON</span> #######################

    appender<span class="token punctuation">.</span>deprecation_rolling<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">RollingFile</span>

    appender<span class="token punctuation">.</span>deprecation_rolling<span class="token punctuation">.</span>name <span class="token operator">=</span> deprecation_rolling

    appender<span class="token punctuation">.</span>deprecation_rolling<span class="token punctuation">.</span>fileName <span class="token operator">=</span>
    $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>base_path<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>file<span class="token punctuation">.</span>separator<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>cluster_name<span class="token punctuation">}</span>_deprecation<span class="token punctuation">.</span>json

    appender<span class="token punctuation">.</span>deprecation_rolling<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">ECSJsonLayout</span>

    # <span class="token class-name">Intentionally</span> follows a different pattern <span class="token keyword">to</span> <span class="token namespace">above</span>

    appender<span class="token punctuation">.</span>deprecation_rolling<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>dataset <span class="token operator">=</span> deprecation<span class="token punctuation">.</span>elasticsearch

    appender<span class="token punctuation">.</span>deprecation_rolling<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>rate_limit<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">RateLimitingFilter</span>


    appender<span class="token punctuation">.</span>deprecation_rolling<span class="token punctuation">.</span>filePattern <span class="token operator">=</span>
    $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>base_path<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>file<span class="token punctuation">.</span>separator<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>cluster_name<span class="token punctuation">}</span>_deprecation<span class="token operator">-</span><span class="token operator">%</span>i<span class="token punctuation">.</span>json<span class="token punctuation">.</span>gz

    appender<span class="token punctuation">.</span>deprecation_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">Policies</span>

    appender<span class="token punctuation">.</span>deprecation_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>size<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">SizeBasedTriggeringPolicy</span>

    appender<span class="token punctuation">.</span>deprecation_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>size<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">1</span><span class="token constant">GB</span>

    appender<span class="token punctuation">.</span>deprecation_rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">DefaultRolloverStrategy</span>

    appender<span class="token punctuation">.</span>deprecation_rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>max <span class="token operator">=</span> <span class="token number">4</span>


    appender<span class="token punctuation">.</span>header_warning<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">HeaderWarningAppender</span>

    appender<span class="token punctuation">.</span>header_warning<span class="token punctuation">.</span>name <span class="token operator">=</span> header_warning

    #################################################


    logger<span class="token punctuation">.</span>deprecation<span class="token punctuation">.</span>name <span class="token operator">=</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>deprecation

    logger<span class="token punctuation">.</span>deprecation<span class="token punctuation">.</span>level <span class="token operator">=</span> <span class="token constant">WARN</span>

    logger<span class="token punctuation">.</span>deprecation<span class="token punctuation">.</span>appenderRef<span class="token punctuation">.</span>deprecation_rolling<span class="token punctuation">.</span>ref <span class="token operator">=</span> deprecation_rolling

    logger<span class="token punctuation">.</span>deprecation<span class="token punctuation">.</span>appenderRef<span class="token punctuation">.</span>header_warning<span class="token punctuation">.</span>ref <span class="token operator">=</span> header_warning

    logger<span class="token punctuation">.</span>deprecation<span class="token punctuation">.</span>additivity <span class="token operator">=</span> <span class="token boolean">false</span>


    ######## <span class="token class-name">Search</span> slowlog <span class="token constant">JSON</span> ####################

    appender<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">RollingFile</span>

    appender<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>name <span class="token operator">=</span> index_search_slowlog_rolling

    appender<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>fileName <span class="token operator">=</span>
    $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>base_path<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>file<span class="token punctuation">.</span>separator<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs\
      <span class="token punctuation">.</span>cluster_name<span class="token punctuation">}</span>_index_search_slowlog<span class="token punctuation">.</span>json
    appender<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">ECSJsonLayout</span>

    appender<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>dataset <span class="token operator">=</span>
    elasticsearch<span class="token punctuation">.</span>index_search_slowlog


    appender<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>filePattern <span class="token operator">=</span>
    $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>base_path<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>file<span class="token punctuation">.</span>separator<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs\
      <span class="token punctuation">.</span>cluster_name<span class="token punctuation">}</span>_index_search_slowlog<span class="token operator">-</span><span class="token operator">%</span>i<span class="token punctuation">.</span>json<span class="token punctuation">.</span>gz
    appender<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">Policies</span>

    appender<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>size<span class="token punctuation">.</span>type <span class="token operator">=</span>
    <span class="token class-name">SizeBasedTriggeringPolicy</span>

    appender<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>size<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">1</span><span class="token constant">GB</span>

    appender<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>type <span class="token operator">=</span>
    <span class="token class-name">DefaultRolloverStrategy</span>

    appender<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>max <span class="token operator">=</span> <span class="token number">4</span>

    #################################################


    #################################################

    logger<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>name <span class="token operator">=</span> index<span class="token punctuation">.</span>search<span class="token punctuation">.</span>slowlog

    logger<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>level <span class="token operator">=</span> trace

    logger<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>appenderRef<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>ref
    <span class="token operator">=</span> index_search_slowlog_rolling

    logger<span class="token punctuation">.</span>index_search_slowlog_rolling<span class="token punctuation">.</span>additivity <span class="token operator">=</span> <span class="token boolean">false</span>


    ######## <span class="token class-name">Indexing</span> slowlog <span class="token constant">JSON</span> ##################

    appender<span class="token punctuation">.</span>index_indexing_slowlog_rolling<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">RollingFile</span>

    appender<span class="token punctuation">.</span>index_indexing_slowlog_rolling<span class="token punctuation">.</span>name <span class="token operator">=</span>
    index_indexing_slowlog_rolling

    appender<span class="token punctuation">.</span>index_indexing_slowlog_rolling<span class="token punctuation">.</span>fileName <span class="token operator">=</span>
    $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>base_path<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>file<span class="token punctuation">.</span>separator<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>cluster_name<span class="token punctuation">}</span>\
      _index_indexing_slowlog<span class="token punctuation">.</span>json
    appender<span class="token punctuation">.</span>index_indexing_slowlog_rolling<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">ECSJsonLayout</span>

    appender<span class="token punctuation">.</span>index_indexing_slowlog_rolling<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>dataset <span class="token operator">=</span>
    elasticsearch<span class="token punctuation">.</span>index_indexing_slowlog



    appender<span class="token punctuation">.</span>index_indexing_slowlog_rolling<span class="token punctuation">.</span>filePattern <span class="token operator">=</span>
    $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>base_path<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>file<span class="token punctuation">.</span>separator<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>cluster_name<span class="token punctuation">}</span>\
      _index_indexing_slowlog<span class="token operator">-</span><span class="token operator">%</span>i<span class="token punctuation">.</span>json<span class="token punctuation">.</span>gz
    appender<span class="token punctuation">.</span>index_indexing_slowlog_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">Policies</span>

    appender<span class="token punctuation">.</span>index_indexing_slowlog_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>size<span class="token punctuation">.</span>type <span class="token operator">=</span>
    <span class="token class-name">SizeBasedTriggeringPolicy</span>

    appender<span class="token punctuation">.</span>index_indexing_slowlog_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>size<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">1</span><span class="token constant">GB</span>

    appender<span class="token punctuation">.</span>index_indexing_slowlog_rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>type <span class="token operator">=</span>
    <span class="token class-name">DefaultRolloverStrategy</span>

    appender<span class="token punctuation">.</span>index_indexing_slowlog_rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>max <span class="token operator">=</span> <span class="token number">4</span>

    #################################################



    logger<span class="token punctuation">.</span>index_indexing_slowlog<span class="token punctuation">.</span>name <span class="token operator">=</span> index<span class="token punctuation">.</span>indexing<span class="token punctuation">.</span>slowlog<span class="token punctuation">.</span>index

    logger<span class="token punctuation">.</span>index_indexing_slowlog<span class="token punctuation">.</span>level <span class="token operator">=</span> trace

    logger<span class="token punctuation">.</span>index_indexing_slowlog<span class="token punctuation">.</span>appenderRef<span class="token punctuation">.</span>index_indexing_slowlog_rolling<span class="token punctuation">.</span>ref
    <span class="token operator">=</span> index_indexing_slowlog_rolling

    logger<span class="token punctuation">.</span>index_indexing_slowlog<span class="token punctuation">.</span>additivity <span class="token operator">=</span> <span class="token boolean">false</span>



    logger<span class="token punctuation">.</span>com_amazonaws<span class="token punctuation">.</span>name <span class="token operator">=</span> com<span class="token punctuation">.</span>amazonaws

    logger<span class="token punctuation">.</span>com_amazonaws<span class="token punctuation">.</span>level <span class="token operator">=</span> warn


    logger<span class="token punctuation">.</span>com_amazonaws_jmx_SdkMBeanRegistrySupport<span class="token punctuation">.</span>name <span class="token operator">=</span>
    <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>amazonaws<span class="token punctuation">.</span>jmx<span class="token punctuation">.</span></span>SdkMBeanRegistrySupport</span>

    logger<span class="token punctuation">.</span>com_amazonaws_jmx_SdkMBeanRegistrySupport<span class="token punctuation">.</span>level <span class="token operator">=</span> error


    logger<span class="token punctuation">.</span>com_amazonaws_metrics_AwsSdkMetrics<span class="token punctuation">.</span>name <span class="token operator">=</span>
    <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>amazonaws<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span></span>AwsSdkMetrics</span>

    logger<span class="token punctuation">.</span>com_amazonaws_metrics_AwsSdkMetrics<span class="token punctuation">.</span>level <span class="token operator">=</span> error


    logger<span class="token punctuation">.</span>com_amazonaws_auth_profile_internal_BasicProfileConfigFileLoader<span class="token punctuation">.</span>name
    <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>amazonaws<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>profile<span class="token punctuation">.</span>internal<span class="token punctuation">.</span></span>BasicProfileConfigFileLoader</span>

    logger<span class="token punctuation">.</span>com_amazonaws_auth_profile_internal_BasicProfileConfigFileLoader<span class="token punctuation">.</span>level
    <span class="token operator">=</span> error


    logger<span class="token punctuation">.</span>com_amazonaws_services_s3_internal_UseArnRegionResolver<span class="token punctuation">.</span>name <span class="token operator">=</span>
    <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>amazonaws<span class="token punctuation">.</span>services<span class="token punctuation">.</span>s3<span class="token punctuation">.</span>internal<span class="token punctuation">.</span></span>UseArnRegionResolver</span>

    logger<span class="token punctuation">.</span>com_amazonaws_services_s3_internal_UseArnRegionResolver<span class="token punctuation">.</span>level <span class="token operator">=</span> error



    appender<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">RollingFile</span>

    appender<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>name <span class="token operator">=</span> audit_rolling

    appender<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>fileName <span class="token operator">=</span>
    $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>base_path<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>file<span class="token punctuation">.</span>separator<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>cluster_name<span class="token punctuation">}</span>_audit<span class="token punctuation">.</span>json

    appender<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">PatternLayout</span>

    appender<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>pattern <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>\
                    <span class="token string">"type"</span><span class="token operator">:</span><span class="token string">"audit"</span><span class="token punctuation">,</span> \
                    <span class="token string">"timestamp"</span><span class="token operator">:</span><span class="token string">"%d{yyyy-MM-dd'T'HH:mm:ss,SSSZ}"</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"cluster.name"</span><span class="token operator">:</span><span class="token string">"%enc{%map{cluster.name}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"cluster.uuid"</span><span class="token operator">:</span><span class="token string">"%enc{%map{cluster.uuid}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"node.name"</span><span class="token operator">:</span><span class="token string">"%enc{%map{node.name}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"node.id"</span><span class="token operator">:</span><span class="token string">"%enc{%map{node.id}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"host.name"</span><span class="token operator">:</span><span class="token string">"%enc{%map{host.name}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"host.ip"</span><span class="token operator">:</span><span class="token string">"%enc{%map{host.ip}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"event.type"</span><span class="token operator">:</span><span class="token string">"%enc{%map{event.type}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"event.action"</span><span class="token operator">:</span><span class="token string">"%enc{%map{event.action}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"authentication.type"</span><span class="token operator">:</span><span class="token string">"%enc{%map{authentication.type}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"user.name"</span><span class="token operator">:</span><span class="token string">"%enc{%map{user.name}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"user.run_by.name"</span><span class="token operator">:</span><span class="token string">"%enc{%map{user.run_by.name}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"user.run_as.name"</span><span class="token operator">:</span><span class="token string">"%enc{%map{user.run_as.name}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"user.realm"</span><span class="token operator">:</span><span class="token string">"%enc{%map{user.realm}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"user.run_by.realm"</span><span class="token operator">:</span><span class="token string">"%enc{%map{user.run_by.realm}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"user.run_as.realm"</span><span class="token operator">:</span><span class="token string">"%enc{%map{user.run_as.realm}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"user.roles"</span><span class="token operator">:</span><span class="token operator">%</span>map<span class="token punctuation">{<!-- --></span>user<span class="token punctuation">.</span>roles<span class="token punctuation">}</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"apikey.id"</span><span class="token operator">:</span><span class="token string">"%enc{%map{apikey.id}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"apikey.name"</span><span class="token operator">:</span><span class="token string">"%enc{%map{apikey.name}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"authentication.token.name"</span><span class="token operator">:</span><span class="token string">"%enc{%map{authentication.token.name}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"authentication.token.type"</span><span class="token operator">:</span><span class="token string">"%enc{%map{authentication.token.type}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"origin.type"</span><span class="token operator">:</span><span class="token string">"%enc{%map{origin.type}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"origin.address"</span><span class="token operator">:</span><span class="token string">"%enc{%map{origin.address}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"realm"</span><span class="token operator">:</span><span class="token string">"%enc{%map{realm}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"url.path"</span><span class="token operator">:</span><span class="token string">"%enc{%map{url.path}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"url.query"</span><span class="token operator">:</span><span class="token string">"%enc{%map{url.query}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"request.method"</span><span class="token operator">:</span><span class="token string">"%enc{%map{request.method}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"request.body"</span><span class="token operator">:</span><span class="token string">"%enc{%map{request.body}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"request.id"</span><span class="token operator">:</span><span class="token string">"%enc{%map{request.id}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"action"</span><span class="token operator">:</span><span class="token string">"%enc{%map{action}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"request.name"</span><span class="token operator">:</span><span class="token string">"%enc{%map{request.name}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"indices"</span><span class="token operator">:</span><span class="token operator">%</span>map<span class="token punctuation">{<!-- --></span>indices<span class="token punctuation">}</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"opaque_id"</span><span class="token operator">:</span><span class="token string">"%enc{%map{opaque_id}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"trace.id"</span><span class="token operator">:</span><span class="token string">"%enc{%map{trace.id}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"x_forwarded_for"</span><span class="token operator">:</span><span class="token string">"%enc{%map{x_forwarded_for}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"transport.profile"</span><span class="token operator">:</span><span class="token string">"%enc{%map{transport.profile}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"rule"</span><span class="token operator">:</span><span class="token string">"%enc{%map{rule}}{JSON}"</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"put"</span><span class="token operator">:</span><span class="token operator">%</span>map<span class="token punctuation">{<!-- --></span>put<span class="token punctuation">}</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token operator">:</span><span class="token operator">%</span>map<span class="token punctuation">{<!-- --></span>delete<span class="token punctuation">}</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"change"</span><span class="token operator">:</span><span class="token operator">%</span>map<span class="token punctuation">{<!-- --></span>change<span class="token punctuation">}</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token operator">:</span><span class="token operator">%</span>map<span class="token punctuation">{<!-- --></span>create<span class="token punctuation">}</span><span class="token punctuation">}</span>\
                    <span class="token operator">%</span>varsNotEmpty<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span> <span class="token string">"invalidate"</span><span class="token operator">:</span><span class="token operator">%</span>map<span class="token punctuation">{<!-- --></span>invalidate<span class="token punctuation">}</span><span class="token punctuation">}</span>\
                    <span class="token punctuation">}</span><span class="token operator">%</span>n
    # <span class="token string">"node.name"</span> node name from the `elasticsearch<span class="token punctuation">.</span>yml` settings

    # <span class="token string">"node.id"</span> node id which should not change between cluster restarts

    # <span class="token string">"host.name"</span> unresolved hostname of the local node

    # <span class="token string">"host.ip"</span> the local bound ip <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span> the ip listening <span class="token keyword">for</span> connections<span class="token punctuation">)</span>

    # <span class="token string">"origin.type"</span> a received <span class="token constant">REST</span> request is translated into one or more
    transport <span class="token class-name"><span class="token namespace">requests<span class="token punctuation">.</span></span> This</span> indicates which processing layer generated the
    event <span class="token string">"rest"</span> or <span class="token string">"transport"</span> <span class="token punctuation">(</span>internal<span class="token punctuation">)</span>

    # <span class="token string">"event.action"</span> the name of the audited event<span class="token punctuation">,</span> eg<span class="token punctuation">.</span> <span class="token string">"authentication_failed"</span><span class="token punctuation">,</span>
    <span class="token string">"access_granted"</span><span class="token punctuation">,</span> <span class="token string">"run_as_granted"</span><span class="token punctuation">,</span> etc<span class="token punctuation">.</span>

    # <span class="token string">"authentication.type"</span> one of <span class="token string">"realm"</span><span class="token punctuation">,</span> <span class="token string">"api_key"</span><span class="token punctuation">,</span> <span class="token string">"token"</span><span class="token punctuation">,</span> <span class="token string">"anonymous"</span> or
    <span class="token string">"internal"</span>

    # <span class="token string">"user.name"</span> the subject name as authenticated by a realm

    # <span class="token string">"user.run_by.name"</span> the original authenticated subject name that is
    impersonating another one<span class="token punctuation">.</span>

    # <span class="token string">"user.run_as.name"</span> <span class="token keyword">if</span> <span class="token keyword">this</span> <span class="token string">"event.action"</span> is of a run_as type<span class="token punctuation">,</span> <span class="token keyword">this</span> is the
    subject name <span class="token keyword">to</span> <span class="token namespace">be</span> impersonated as<span class="token punctuation">.</span>

    # <span class="token string">"user.realm"</span> the name of the realm that authenticated <span class="token string">"user.name"</span>

    # <span class="token string">"user.run_by.realm"</span> the realm name of the impersonating subject
    <span class="token punctuation">(</span><span class="token string">"user.run_by.name"</span><span class="token punctuation">)</span>

    # <span class="token string">"user.run_as.realm"</span> <span class="token keyword">if</span> <span class="token keyword">this</span> <span class="token string">"event.action"</span> is of a run_as type<span class="token punctuation">,</span> <span class="token keyword">this</span> is
    the realm name the impersonated user is looked up from

    # <span class="token string">"user.roles"</span> the roles array of the user<span class="token punctuation">;</span> these are the roles that are
    granting privileges

    # <span class="token string">"apikey.id"</span> <span class="token keyword">this</span> field is present <span class="token keyword">if</span> and only <span class="token keyword">if</span> the <span class="token string">"authentication.type"</span>
    is <span class="token string">"api_key"</span>

    # <span class="token string">"apikey.name"</span> <span class="token keyword">this</span> field is present <span class="token keyword">if</span> and only <span class="token keyword">if</span> the
    <span class="token string">"authentication.type"</span> is <span class="token string">"api_key"</span>

    # <span class="token string">"authentication.token.name"</span> <span class="token keyword">this</span> field is present <span class="token keyword">if</span> and only <span class="token keyword">if</span> the
    authenticating credential is a service account token

    # <span class="token string">"authentication.token.type"</span> <span class="token keyword">this</span> field is present <span class="token keyword">if</span> and only <span class="token keyword">if</span> the
    authenticating credential is a service account token

    # <span class="token string">"event.type"</span> informs about what internal system generated the event<span class="token punctuation">;</span>
    possible values are <span class="token string">"rest"</span><span class="token punctuation">,</span> <span class="token string">"transport"</span><span class="token punctuation">,</span> <span class="token string">"ip_filter"</span> and
    <span class="token string">"security_config_change"</span>

    # <span class="token string">"origin.address"</span> the remote address and port of the first network hop<span class="token punctuation">,</span>
    i<span class="token punctuation">.</span>e<span class="token punctuation">.</span> a <span class="token constant">REST</span> proxy or another cluster node

    # <span class="token string">"realm"</span> name of a realm that has generated an <span class="token string">"authentication_failed"</span> or
    an <span class="token string">"authentication_successful"</span><span class="token punctuation">;</span> the subject is not yet authenticated

    # <span class="token string">"url.path"</span> the <span class="token constant">URI</span> component between the port and the query string<span class="token punctuation">;</span> it is
    percent <span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">)</span> encoded

    # <span class="token string">"url.query"</span> the <span class="token constant">URI</span> component after the path and before the fragment<span class="token punctuation">;</span> it
    is percent <span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">)</span> encoded

    # <span class="token string">"request.method"</span> the method of the <span class="token class-name">HTTP</span> request<span class="token punctuation">,</span> i<span class="token punctuation">.</span>e<span class="token punctuation">.</span> one of <span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token constant">POST</span><span class="token punctuation">,</span>
    <span class="token constant">PUT</span><span class="token punctuation">,</span> <span class="token constant">DELETE</span><span class="token punctuation">,</span> <span class="token constant">OPTIONS</span><span class="token punctuation">,</span> <span class="token constant">HEAD</span><span class="token punctuation">,</span> <span class="token constant">PATCH</span><span class="token punctuation">,</span> <span class="token constant">TRACE</span><span class="token punctuation">,</span> <span class="token constant">CONNECT</span>

    # <span class="token string">"request.body"</span> the content of the request body entity<span class="token punctuation">,</span> <span class="token constant">JSON</span> escaped

    # <span class="token string">"request.id"</span> a synthetic identifier <span class="token keyword">for</span> the incoming request<span class="token punctuation">,</span> <span class="token keyword">this</span> is
    unique per incoming request<span class="token punctuation">,</span> and consistent across all audit events
    generated by that request

    # <span class="token string">"action"</span> an action is the most granular operation that is authorized and
    <span class="token keyword">this</span> identifies it in a namespaced way <span class="token punctuation">(</span>internal<span class="token punctuation">)</span>

    # <span class="token string">"request.name"</span> <span class="token keyword">if</span> the event is in connection <span class="token keyword">to</span> <span class="token namespace">a</span> transport message <span class="token keyword">this</span>
    is the name of the request <span class="token keyword">class</span><span class="token punctuation">,</span> similar <span class="token keyword">to</span> <span class="token namespace">how</span> rest requests are
    identified by the url path <span class="token punctuation">(</span>internal<span class="token punctuation">)</span>

    # <span class="token string">"indices"</span> the array of indices that the <span class="token string">"action"</span> is acting upon

    # <span class="token string">"opaque_id"</span> opaque value conveyed by the <span class="token string">"X-Opaque-Id"</span> request header

    # <span class="token string">"trace_id"</span> an identifier conveyed by the part of <span class="token string">"traceparent"</span> request
    header

    # <span class="token string">"x_forwarded_for"</span> the addresses from the <span class="token string">"X-Forwarded-For"</span> request header<span class="token punctuation">,</span>
    as a verbatim string value <span class="token punctuation">(</span>not an array<span class="token punctuation">)</span>

    # <span class="token string">"transport.profile"</span> name of the transport profile in <span class="token keyword">case</span> <span class="token keyword">this</span> is a
    <span class="token string">"connection_granted"</span> or <span class="token string">"connection_denied"</span> event

    # <span class="token string">"rule"</span> name of the applied rule <span class="token keyword">if</span> the <span class="token string">"origin.type"</span> is <span class="token string">"ip_filter"</span>

    # the <span class="token string">"put"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">,</span> <span class="token string">"change"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"invalidate"</span> fields are only
    present

    # when the <span class="token string">"event.type"</span> is <span class="token string">"security_config_change"</span> and contain the security
    config change <span class="token punctuation">(</span>as an object<span class="token punctuation">)</span> taking effect


    appender<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>filePattern <span class="token operator">=</span>
    $<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>base_path<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>file<span class="token punctuation">.</span>separator<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>sys<span class="token operator">:</span>es<span class="token punctuation">.</span>logs<span class="token punctuation">.</span>cluster_name<span class="token punctuation">}</span>_audit<span class="token operator">-</span><span class="token operator">%</span>d<span class="token punctuation">{<!-- --></span>yyyy<span class="token operator">-</span><span class="token constant">MM</span><span class="token operator">-</span>dd<span class="token punctuation">}</span><span class="token operator">-</span><span class="token operator">%</span>i<span class="token punctuation">.</span>json<span class="token punctuation">.</span>gz

    appender<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">Policies</span>

    appender<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>time<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">TimeBasedTriggeringPolicy</span>

    appender<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>time<span class="token punctuation">.</span>interval <span class="token operator">=</span> <span class="token number">1</span>

    appender<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>time<span class="token punctuation">.</span>modulate <span class="token operator">=</span> <span class="token boolean">true</span>

    appender<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>size<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">SizeBasedTriggeringPolicy</span>

    appender<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>policies<span class="token punctuation">.</span>size<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">1</span><span class="token constant">GB</span>

    appender<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">DefaultRolloverStrategy</span>

    appender<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>fileIndex <span class="token operator">=</span> nomax


    logger<span class="token punctuation">.</span>xpack_security_audit_logfile<span class="token punctuation">.</span>name <span class="token operator">=</span>
    <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>xpack<span class="token punctuation">.</span>security<span class="token punctuation">.</span>audit<span class="token punctuation">.</span>logfile<span class="token punctuation">.</span></span>LoggingAuditTrail</span>

    logger<span class="token punctuation">.</span>xpack_security_audit_logfile<span class="token punctuation">.</span>level <span class="token operator">=</span> info

    logger<span class="token punctuation">.</span>xpack_security_audit_logfile<span class="token punctuation">.</span>appenderRef<span class="token punctuation">.</span>audit_rolling<span class="token punctuation">.</span>ref <span class="token operator">=</span>
    audit_rolling

    logger<span class="token punctuation">.</span>xpack_security_audit_logfile<span class="token punctuation">.</span>additivity <span class="token operator">=</span> <span class="token boolean">false</span>


    logger<span class="token punctuation">.</span>xmlsig<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>security<span class="token punctuation">.</span>signature<span class="token punctuation">.</span></span>XMLSignature</span>

    logger<span class="token punctuation">.</span>xmlsig<span class="token punctuation">.</span>level <span class="token operator">=</span> error

    logger<span class="token punctuation">.</span>samlxml_decrypt<span class="token punctuation">.</span>name <span class="token operator">=</span>
    <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>opensaml<span class="token punctuation">.</span>xmlsec<span class="token punctuation">.</span>encryption<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>Decrypter</span>

    logger<span class="token punctuation">.</span>samlxml_decrypt<span class="token punctuation">.</span>level <span class="token operator">=</span> fatal

    logger<span class="token punctuation">.</span>saml2_decrypt<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>opensaml<span class="token punctuation">.</span>saml<span class="token punctuation">.</span>saml2<span class="token punctuation">.</span>encryption<span class="token punctuation">.</span></span>Decrypter</span>

    logger<span class="token punctuation">.</span>saml2_decrypt<span class="token punctuation">.</span>level <span class="token operator">=</span> fatal
kind<span class="token operator">:</span> <span class="token class-name">ConfigMap</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> es<span class="token operator">-</span>config
  namespace<span class="token operator">:</span> es8<span class="token operator">-</span>all

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
kind<span class="token operator">:</span> <span class="token class-name">StatefulSet</span>
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> elasticsearch
  name<span class="token operator">:</span> elasticsearch
  namespace<span class="token operator">:</span> es8<span class="token operator">-</span>all
spec<span class="token operator">:</span>
  replicas<span class="token operator">:</span> <span class="token number">1</span>
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> elasticsearch
  serviceName<span class="token operator">:</span> elasticsearch
  template<span class="token operator">:</span>
    metadata<span class="token operator">:</span>
      labels<span class="token operator">:</span>
        app<span class="token operator">:</span> elasticsearch
    spec<span class="token operator">:</span>
      containers<span class="token operator">:</span>
        <span class="token operator">-</span> env<span class="token operator">:</span>
            <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">TZ</span>
              value<span class="token operator">:</span> <span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Shanghai</span>
          image<span class="token operator">:</span> 'elasticsearch<span class="token operator">:</span><span class="token number">8.2</span><span class="token number">.3</span>'
          imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
          name<span class="token operator">:</span> elasticsearch
          resources<span class="token operator">:</span>
            limits<span class="token operator">:</span>
              cpu<span class="token operator">:</span> <span class="token char">'1'</span>
              memory<span class="token operator">:</span> <span class="token number">2</span>Gi
            requests<span class="token operator">:</span>
              cpu<span class="token operator">:</span> <span class="token char">'1'</span>
              memory<span class="token operator">:</span> <span class="token number">1</span>Gi
          volumeMounts<span class="token operator">:</span>
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>config<span class="token operator">/</span>elasticsearch<span class="token punctuation">.</span>yml
              name<span class="token operator">:</span> es<span class="token operator">-</span>config
              subPath<span class="token operator">:</span> elasticsearch<span class="token punctuation">.</span>yml
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>data
              name<span class="token operator">:</span> es<span class="token operator">-</span>persistent<span class="token operator">-</span>storage
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>plugins
              name<span class="token operator">:</span> es<span class="token operator">-</span>plugins
              subPath<span class="token operator">:</span> testp
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>config<span class="token operator">/</span>log4j2<span class="token punctuation">.</span>properties
              name<span class="token operator">:</span> es<span class="token operator">-</span>config
              subPath<span class="token operator">:</span> log4j2<span class="token punctuation">.</span>properties
            <span class="token operator">-</span> mountPath<span class="token operator">:</span> usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>jdk<span class="token operator">/</span>lib<span class="token operator">/</span>security<span class="token operator">/</span><span class="token keyword">default</span><span class="token punctuation">.</span>policy
              name<span class="token operator">:</span> es<span class="token operator">-</span>config
              subPath<span class="token operator">:</span> <span class="token keyword">default</span><span class="token punctuation">.</span>policy
      imagePullSecrets<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> docker<span class="token operator">-</span>login
      volumes<span class="token operator">:</span>
        <span class="token operator">-</span> configMap<span class="token operator">:</span>
            name<span class="token operator">:</span> es<span class="token operator">-</span>config
          name<span class="token operator">:</span> es<span class="token operator">-</span>config
  volumeClaimTemplates<span class="token operator">:</span>
    <span class="token operator">-</span> apiVersion<span class="token operator">:</span> v1
      kind<span class="token operator">:</span> <span class="token class-name">PersistentVolumeClaim</span>
      metadata<span class="token operator">:</span>
        name<span class="token operator">:</span> es<span class="token operator">-</span>persistent<span class="token operator">-</span>storage
      spec<span class="token operator">:</span>
        accessModes<span class="token operator">:</span>
          <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
        resources<span class="token operator">:</span>
          requests<span class="token operator">:</span>
            storage<span class="token operator">:</span> <span class="token number">500</span>Mi
        storageClassName<span class="token operator">:</span> <span class="token string">"managed-nfs-storage"</span> # nfs默认存储类名称
    <span class="token operator">-</span> apiVersion<span class="token operator">:</span> v1
      kind<span class="token operator">:</span> <span class="token class-name">PersistentVolumeClaim</span>
      metadata<span class="token operator">:</span>
        name<span class="token operator">:</span> es<span class="token operator">-</span>plugins
      spec<span class="token operator">:</span>
        accessModes<span class="token operator">:</span>
          <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
        resources<span class="token operator">:</span>
          requests<span class="token operator">:</span>
            storage<span class="token operator">:</span> <span class="token number">100</span>Mi
        storageClassName<span class="token operator">:</span> <span class="token string">"managed-nfs-storage"</span> # nfs默认存储类名称

<span class="token operator">--</span><span class="token operator">-</span>

apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">Service</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> elasticsearch
  namespace<span class="token operator">:</span> es8<span class="token operator">-</span>all
spec<span class="token operator">:</span>
  ports<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> es9200
      port<span class="token operator">:</span> <span class="token number">9200</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">9200</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> es9300
      port<span class="token operator">:</span> <span class="token number">9300</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">9300</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> es9400
      port<span class="token operator">:</span> <span class="token number">9400</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">9400</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> es9500
      port<span class="token operator">:</span> <span class="token number">9500</span>
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      targetPort<span class="token operator">:</span> <span class="token number">9500</span>
  selector<span class="token operator">:</span>
    app<span class="token operator">:</span> elasticsearch
  type<span class="token operator">:</span> <span class="token class-name">NodePort</span>
</code></pre> 
<h3><a id="17nexus_4455"></a>17、安装nexus</h3> 
<p>记得先创建nexus名称空间</p> 
<p>用户初始密码查找：默认用户名是admin，默认初始密码在<code>/nexus-data/admin.password</code>文件中，如果大家是通过控制台访问的容器，可以直接点进去查看，当然可以通过<code>kubectl exec 容器名称 -- cat /nexus-data/admin.password -n 命名空间</code>去查看，登录成功之后需要设置密码，然后还需要设置是否开启匿名访问，我们为了安全不开启，选择第二个<code>Disable anonymous access</code>即可。<br> 详细操作请访问<a href="https://www.jianshu.com/p/3008705d8339" rel="nofollow">在 k8s 中安装并使用 nexus</a></p> 
<p>nexus使用层面：可以看<a href="https://www.bilibili.com/video/BV1854y1F7Lt/" rel="nofollow">完整教学：nexus搭建maven私服</a></p> 
<pre><code class="prism language-java">apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">PersistentVolumeClaim</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> nexus<span class="token operator">-</span>data
  namespace<span class="token operator">:</span> nexus3
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> nexus<span class="token operator">-</span>data
spec<span class="token operator">:</span>
  storageClassName<span class="token operator">:</span> managed<span class="token operator">-</span>nfs<span class="token operator">-</span>storage
  accessModes<span class="token operator">:</span>
  <span class="token operator">-</span> <span class="token class-name">ReadWriteMany</span>
  resources<span class="token operator">:</span>
    requests<span class="token operator">:</span>
      storage<span class="token operator">:</span> <span class="token number">15</span>Gi

<span class="token operator">--</span><span class="token operator">-</span>

kind<span class="token operator">:</span> <span class="token class-name">Deployment</span>
apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> nexus3
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> nexus3
  namespace<span class="token operator">:</span> nexus # 命名空间
spec<span class="token operator">:</span>
  replicas<span class="token operator">:</span> <span class="token number">1</span> # 副本的数量
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> nexus3
  template<span class="token operator">:</span>
    metadata<span class="token operator">:</span>
      labels<span class="token operator">:</span>
        app<span class="token operator">:</span> nexus3
    spec<span class="token operator">:</span>
      containers<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> nexus3
          image<span class="token operator">:</span> sonatype<span class="token operator">/</span>nexus3
          imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
          ports<span class="token operator">:</span>
            <span class="token operator">-</span> name<span class="token operator">:</span> nexus3<span class="token operator">-</span>port
              containerPort<span class="token operator">:</span> <span class="token number">8081</span> # 容器端口
              protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
          volumeMounts<span class="token operator">:</span>
          <span class="token operator">-</span> name<span class="token operator">:</span> nexus<span class="token operator">-</span>data
            mountPath<span class="token operator">:</span> <span class="token operator">/</span>nexus<span class="token operator">-</span>data # 数据路径挂载出来
      restartPolicy<span class="token operator">:</span> <span class="token class-name">Always</span>
      volumes<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> nexus<span class="token operator">-</span>data
          persistentVolumeClaim<span class="token operator">:</span>
            claimName<span class="token operator">:</span> nexus<span class="token operator">-</span>data
<span class="token operator">--</span><span class="token operator">-</span>

kind<span class="token operator">:</span> <span class="token class-name">Service</span>
apiVersion<span class="token operator">:</span> v1
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> nexus3
  namespace<span class="token operator">:</span> nexus
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> nexus3
spec<span class="token operator">:</span>
  type<span class="token operator">:</span> <span class="token class-name">NodePort</span>
  ports<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> web
      protocol<span class="token operator">:</span> <span class="token constant">TCP</span>
      port<span class="token operator">:</span> <span class="token number">8081</span>
      targetPort<span class="token operator">:</span> <span class="token number">8081</span>
  selector<span class="token operator">:</span>
    app<span class="token operator">:</span> nexus3
</code></pre> 
<h3><a id="18onlyoffice_4532"></a>18、安装onlyoffice</h3> 
<p>记得先创建onlyoffice名称空间</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> onlyoffice
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> onlyoffice
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> onlyoffice
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> onlyoffice
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> onlyoffice
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> onlyoffice
          <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'onlyoffice/documentserver:6.4.2'</span>
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> onlyoffice
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> onlyoffice
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> onlyoffice
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre> 
<h3><a id="19_4581"></a>19、常用缩写</h3> 
<ul><li>namespaces：ns</li><li>deployments：deploy</li><li>daemonsets：ds</li><li>ingresses：ing</li><li>statefulsets：sts</li><li>cronjobs：cj</li><li>services：svc</li><li>configmap：cm</li></ul> 
<h3><a id="20_4591"></a>20、常用命令</h3> 
<pre><code class="prism language-bash"><span class="token comment"># 》》》解释yaml中所用命令，pod是pod容器，而spec是yaml中规格信息（期望状态） ，按照层级往下写，然后就能得到正确的解释</span>
kubectl explain pod.spec

<span class="token comment"># 》》》查看对象标签，主要是--show-labels起的作用</span>
kubectl get pod <span class="token parameter variable">-n</span> kube-system --show-labels

<span class="token comment"># 》》》查询pod，默认名称空间是default，常见名称空间是kube-system</span>
kubectl get pod <span class="token punctuation">[</span>-n 名称空间<span class="token punctuation">]</span>

<span class="token comment"># 》》》查看所有名称空间</span>
kubectl get namespace

<span class="token comment"># 》》》查询所有对象</span>
kubectl get all <span class="token parameter variable">-A</span>

<span class="token comment"># 》》》查询k8s可用资源，其中对象文件中的apiVersion和kind都是从该命令中得知</span>
kubectl api-resources

<span class="token comment"># 查看pod日志</span>
kubectl logs pod名称 <span class="token parameter variable">-n</span> 名称空间

<span class="token comment"># 》》》根据k8s命令生成对象yaml文件，其中my-tomcat：pod名称、tomcat：镜像名称、--dry-run：假运行、-oyaml：打印yaml信息</span>
kubectl run pod my-tomcat <span class="token parameter variable">--image</span><span class="token operator">=</span>tomcat --dry-run<span class="token operator">=</span>client <span class="token parameter variable">-oyaml</span>

<span class="token comment"># 》》》通过yaml创建/修改k8s资源</span>
kubectl apply <span class="token parameter variable">-f</span> first_yaml.yaml

<span class="token comment"># 》》》查看yaml文件和当前正在运行的k8s对象的不同点</span>
<span class="token comment"># 比如我们修改了first_yaml.yaml，想要对比yaml文件和当前正在运行的对象的区别</span>
<span class="token comment"># 可以通过下面命令达成期望</span>
kubectl <span class="token function">diff</span> <span class="token parameter variable">-f</span> first_yaml.yaml

<span class="token comment"># 》》》删除yaml创建的k8s资源</span>
kubectl delete <span class="token parameter variable">-f</span> first_yaml.yaml

<span class="token comment"># 》》》第一个k8s对象描述文件</span>
<span class="token comment"># type信息 start</span>
apiVersion: v1 <span class="token comment"># 资源版本，来自kubectl api-resources</span>
kind: Pod <span class="token comment"># 资源类型，来自kubectl api-resources</span>
<span class="token comment"># type信息 end</span>
<span class="token comment"># 元数据信息 start</span>
metadata:
  name: my-tomcat-test <span class="token comment"># 资源名称</span>
<span class="token comment"># 元数据信息 end</span>
<span class="token comment"># 规格信息（期望状态） start</span>
spec:
  containers:
    - image: tomcat <span class="token comment"># 容器名称</span>
      name: my-tomcat <span class="token comment"># 容器名称</span>
<span class="token comment"># 规格信息 end</span>
<span class="token comment"># status: {} # status部分不需要我们写，这是对象当前状态，k8s会实时更新对象，然后去达到spec对应的期望状态</span>

<span class="token comment"># 强制删除状态为Terminating的Pod</span>
kubectl  delete pod <span class="token variable"><span class="token variable">$(</span>kubectl get pods <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Terminating"</span><span class="token operator">|</span> <span class="token function">awk</span>  <span class="token string">'{print $1}'</span><span class="token variable">)</span></span>  <span class="token parameter variable">--force</span> --grace-period<span class="token operator">=</span><span class="token number">0</span>  <span class="token parameter variable">-n</span> default
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c6d24655099289d01489458ef2f7d5fb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">git 上传小知识</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1019cf97d52cadbc525d6c40f5ab4469/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【深入理解计算机系统 第三版 导读】第六章 存储器的层次结构</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>