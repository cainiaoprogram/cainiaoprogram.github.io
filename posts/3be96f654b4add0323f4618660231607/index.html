<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Java并发学习笔记（六）：不可变、final、保护性拷贝、享元模式、final原理、无状态 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Java并发学习笔记（六）：不可变、final、保护性拷贝、享元模式、final原理、无状态" />
<meta property="og:description" content="不可变 一、 日期转换的问题 1、引入 下面的代码在运行时，由于 SimpleDateFormat 不是线程安全的
SimpleDateFormat sdf = new SimpleDateFormat(&#34;yyyy-MM-dd&#34;); for (int i = 0; i &lt; 10; i&#43;&#43;) { new Thread(() -&gt; { try { System.out.println(sdf.parse(&#34;1951-04-21&#34;)); } catch (Exception e) { e.printStackTrace(); } }).start(); } 运行之后会出现下面的结果：
Mon Apr 21 00:00:00 CST 4 Sat Apr 21 00:00:00 CST 1951 Sat Apr 21 00:00:00 CST 1951 Sat Apr 21 00:00:00 CST 1951 Thu Apr 21 00:00:00 CST 214 Fri Apr 21 00:00:00 CST 4000 java." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3be96f654b4add0323f4618660231607/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-06-01T15:42:44+08:00" />
<meta property="article:modified_time" content="2020-06-01T15:42:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Java并发学习笔记（六）：不可变、final、保护性拷贝、享元模式、final原理、无状态</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>不可变</h3> 
<h4><a id="__2"></a>一、 日期转换的问题</h4> 
<h5><a id="1_4"></a>1、引入</h5> 
<p>下面的代码在运行时，由于 SimpleDateFormat 不是线程安全的</p> 
<pre><code class="prism language-java">SimpleDateFormat sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sdf<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"1951-04-21"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p>运行之后会出现下面的结果：</p> 
<pre><code class="prism language-java">Mon Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">4</span>
Sat Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1951</span>
Sat Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1951</span>
Sat Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1951</span>
Thu Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">214</span>
Fri Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">4000</span>
java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>NumberFormatException<span class="token operator">:</span> empty String
	at sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>FloatingDecimal<span class="token punctuation">.</span><span class="token function">readJavaFormatString</span><span class="token punctuation">(</span>FloatingDecimal<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1842</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>FloatingDecimal<span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>FloatingDecimal<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">110</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Double<span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>Double<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">538</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>text<span class="token punctuation">.</span>DigitList<span class="token punctuation">.</span><span class="token function">getDouble</span><span class="token punctuation">(</span>DigitList<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">169</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>text<span class="token punctuation">.</span>DecimalFormat<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>DecimalFormat<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2056</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>text<span class="token punctuation">.</span>SimpleDateFormat<span class="token punctuation">.</span><span class="token function">subParse</span><span class="token punctuation">(</span>SimpleDateFormat<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2162</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>text<span class="token punctuation">.</span>SimpleDateFormat<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>SimpleDateFormat<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1514</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>text<span class="token punctuation">.</span>DateFormat<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>DateFormat<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">364</span><span class="token punctuation">)</span>
	at concurrent<span class="token punctuation">.</span>ch7_immutable<span class="token punctuation">.</span>DataFormatTest<span class="token punctuation">.</span>lambda$main$<span class="token function">0</span><span class="token punctuation">(</span>DataFormatTest<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">745</span><span class="token punctuation">)</span>
Sat Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1951</span>
Wed Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1</span>
Fri Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">4000</span></code></pre> 
<p>不仅结果不对，而且还会出现NumberFormatException异常。</p> 
<h5><a id="2_48"></a>2、解决方法：锁</h5> 
<p>要解决SimpleDateFormat的线程安全问题，一种方法时使用synchronized锁，代码如下：</p> 
<pre><code class="prism language-java">        SimpleDateFormat sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//对sdf对象上锁</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sdf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sdf<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"1951-04-21"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre> 
<p>结果：</p> 
<pre><code class="prism language-java">Sat Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1951</span>
Sat Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1951</span>
Sat Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1951</span>
Sat Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1951</span>
Sat Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1951</span>
Sat Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1951</span>
Sat Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1951</span>
Sat Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1951</span>
Sat Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1951</span>
Sat Apr <span class="token number">21</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> CST <span class="token number">1951</span></code></pre> 
<p>可以看到结果没有问题，但是我们之前也介绍过使用synchronized加锁会带来性能上的问题，所以又引入另外一种解决方法：不可变类</p> 
<h5><a id="2_85"></a>2、解决方法：不可变</h5> 
<p>如果一个对象在不能够修改其内部状态（属性），那么它就是线程安全的，因为不存在并发修改。这样的对象在 Java 中有很多，例如在 Java 8 后，提供了一个新的日期格式化类：</p> 
<pre><code class="prism language-java">        DateTimeFormatter dtf <span class="token operator">=</span> DateTimeFormatter<span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dtf<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"1951-04-21"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre> 
<p>结果：</p> 
<pre><code class="prism language-java"><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>ISO resolved to <span class="token number">1951</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">21</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>ISO resolved to <span class="token number">1951</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">21</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>ISO resolved to <span class="token number">1951</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">21</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>ISO resolved to <span class="token number">1951</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">21</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>ISO resolved to <span class="token number">1951</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">21</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>ISO resolved to <span class="token number">1951</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">21</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>ISO resolved to <span class="token number">1951</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">21</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>ISO resolved to <span class="token number">1951</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">21</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>ISO resolved to <span class="token number">1951</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">21</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>ISO resolved to <span class="token number">1951</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">21</span></code></pre> 
<p>虽然和上面的输出格式不同，但是结果是没问题的。DateTimeFormatter的注释中也声明它是一个不可变的线程安全类，不可变对象，实际是另一种避免竞争的方式。</p> 
<pre><code class="prism language-java"><span class="token operator">/</span> <span class="token operator">*</span>
 <span class="token operator">*</span> <span class="token annotation punctuation">@implSpec</span>
 <span class="token operator">*</span> This <span class="token keyword">class</span> <span class="token class-name">is</span> immutable and thread<span class="token operator">-</span>safe<span class="token punctuation">.</span>
 <span class="token operator">*</span>
 <span class="token operator">*</span> <span class="token annotation punctuation">@since</span> <span class="token number">1.8</span>
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DateTimeFormatter</span> <span class="token punctuation">{<!-- --></span></code></pre> 
<h4><a id="_125"></a>二、不可变设计</h4> 
<p>另一个大家更为熟悉的 String 类也是不可变的，以它为例，说明一下不可变设计的要素</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">String</span>
    <span class="token keyword">implements</span> <span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable</span><span class="token punctuation">,</span> Comparable<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> CharSequence <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/** The value is used for character storage. */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">char</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">/** Cache the hash code for the string */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> hash<span class="token punctuation">;</span> <span class="token comment">// Default to 0</span>
    
    <span class="token comment">//...</span>
<span class="token punctuation">}</span></code></pre> 
<h5><a id="1final_142"></a>1、final的使用</h5> 
<p>我们发现String类和类中所有属性都是 ﬁnal 的</p> 
<ul><li>属性用 ﬁnal 修饰保证了该属性是只读的，不能修改</li><li>类用 ﬁnal 修饰保证了该类中的方法不能被覆盖，防止子类无意间破坏不可变性</li></ul> 
<h5><a id="2_149"></a>2、保护性拷贝</h5> 
<p>当需要修改属性的值，如<code>char value[]</code>时，并没有改变其中的值，而是直接新建（拷贝）一个对象赋值给该属性。</p> 
<p>例如：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token keyword">char</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> value<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre> 
<p>这里没有直接使用<code>this.value = value</code>，而是使用<code>Arrays.copyOf</code>进行拷贝，就是为了防止外部引用对参数value的改变会影响到this.value，而<code>Arrays.copyOf</code>创建了一个值参数一样但不是同一个对象，就避免了这种问题。</p> 
<p>再以以 substring 为例：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> String <span class="token function">substring</span><span class="token punctuation">(</span><span class="token keyword">int</span> beginIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> endIndex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beginIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StringIndexOutOfBoundsException</span><span class="token punctuation">(</span>beginIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>endIndex <span class="token operator">&gt;</span> value<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StringIndexOutOfBoundsException</span><span class="token punctuation">(</span>endIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> subLen <span class="token operator">=</span> endIndex <span class="token operator">-</span> beginIndex<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subLen <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StringIndexOutOfBoundsException</span><span class="token punctuation">(</span>subLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//上面都是参数合法性检查，最后调用new String创建了新的对象</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>beginIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>endIndex <span class="token operator">==</span> value<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span>
                <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> beginIndex<span class="token punctuation">,</span> subLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre> 
<p>可以看到substring并没有直接修改成员变量<code>char value[]</code>的值，而是创建了一个新的对象。而该构造函数中也使用了<code>Arrays.copyOfRange</code>进行拷贝。构造新字符串对象时，会生成新的 char[] value，对内容进行复制 。这种通过创建副本对象来避 免共享的手段称之为<strong>保护性拷贝（defensive copy）</strong>。</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token keyword">char</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//...(参数合法性检查)</span>
        
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">copyOfRange</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> offset<span class="token operator">+</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre> 
<h4><a id="_193"></a>三、设计模式：享元模式</h4> 
<h5><a id="1__195"></a>1、 简介</h5> 
<p><strong>定义</strong> 英文名称：Flyweight pattern. 当需要重用数量有限的同一类对象时，可以使用享元模式</p> 
<blockquote> 
 <p>wikipedia： A ﬂyweight is an object that minimizes memory usage by sharing as much data as possible with other similar objects</p> 
</blockquote> 
<h5><a id="2_201"></a>2、体现</h5> 
<p>在JDK中 Boolean，Byte，Short，Integer，Long，Character 等包装类提供了 valueOf 方法，例如 Long 的 valueOf 会缓存 -128~127 之间的 Long 对象，在这个范围之间会重用对象，大于这个范围，才会新建 Long 对 象：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> Long <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token keyword">long</span> l<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&gt;=</span> <span class="token operator">-</span><span class="token number">128</span> <span class="token operator">&amp;&amp;</span> l <span class="token operator">&lt;=</span> <span class="token number">127</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> LongCache<span class="token punctuation">.</span>cache<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> l <span class="token operator">+</span> offset<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre> 
<p><strong>注意</strong>：</p> 
<ul><li> <p>Byte, Short, Long 缓存的范围都是 -128~127</p> </li><li> <p>Character 缓存的范围是 0~127</p> </li><li> <p>Integer的默认范围是 -128~127</p> 
  <ul><li>最小值不能变</li><li>但最大值可以通过调整虚拟机参数 <code>-Djava.lang.Integer.IntegerCache.high</code> 来改变</li></ul> </li><li> <p>Boolean 缓存了 TRUE 和 FALSE</p> </li></ul> 
<p>除此之外还有String 串池 （JVM笔记）、 BigDecimal、BigInteger 等。</p> 
<h5><a id="3DIY_227"></a>3、实践DIY</h5> 
<p>例如：一个线上商城应用，QPS 达到数千，如果每次都重新创建和关闭数据库连接，性能会受到极大影响。 这时 预先创建好一批连接，放入连接池。一次请求到达后，从连接池获取连接，使用完毕后再还回连接池，这样既节约 了连接的创建和关闭时间，也实现了连接的重用，不至于让庞大的连接数压垮数据库</p> 
<pre><code class="prism language-java"><span class="token comment">//连接池实现类</span>
<span class="token keyword">class</span> <span class="token class-name">Pool</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//定义连接池大小</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> poolSize<span class="token punctuation">;</span>

    <span class="token comment">//连接对象数组</span>
    <span class="token keyword">private</span> Connection<span class="token punctuation">[</span><span class="token punctuation">]</span> connections<span class="token punctuation">;</span>

    <span class="token comment">//定义连接状态数组 0：表示空闲，1：表示繁忙</span>
    <span class="token keyword">private</span> AtomicIntegerArray states<span class="token punctuation">;</span>

    <span class="token comment">//构造方法初始化</span>
    <span class="token keyword">public</span> <span class="token function">Pool</span><span class="token punctuation">(</span><span class="token keyword">int</span> poolSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>poolSize <span class="token operator">=</span> poolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>connections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Connection</span><span class="token punctuation">[</span>poolSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>states <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicIntegerArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>poolSize<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> poolSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            connections<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MockConnection</span><span class="token punctuation">(</span><span class="token string">"conn "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//借连接</span>
    <span class="token keyword">public</span> Connection <span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//遍历连接状态数组，找出空闲的连接并返回</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> poolSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>states<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//为了先线程安全，需要使用CAS对连接状态进行设置</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>states<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" borrow "</span> <span class="token operator">+</span> connections<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> connections<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//当前没有连接池时，进入等待状态</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" wait..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//归还连接</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">free</span><span class="token punctuation">(</span>Connection conn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> poolSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>connections<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> conn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//由于此时只有一个线程持有connections[i]，所以不会有线程安全问题</span>
                states<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//归还之后，通知等待的线程</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" free "</span> <span class="token operator">+</span> conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//连接实现类，无具体内容，省略</span>
<span class="token keyword">class</span> <span class="token class-name">MockConnection</span> <span class="token keyword">implements</span> <span class="token class-name">Connection</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span></code></pre> 
<p>测试代码：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//创建2两个连接</span>
        Pool pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pool</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建5个线程使用链接</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//创建连接</span>
                Connection conn <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//释放连接</span>
                    pool<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"线程 "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre> 
<p>结果：</p> 
<pre><code class="prism language-java">线程 <span class="token number">1</span> borrow MockConnection<span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span><span class="token string">'conn 0'</span><span class="token punctuation">}</span>
线程 <span class="token number">0</span> borrow MockConnection<span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span><span class="token string">'conn 1'</span><span class="token punctuation">}</span>
线程 <span class="token number">2</span> wait<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
线程 <span class="token number">3</span> wait<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
线程 <span class="token number">4</span> wait<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
线程 <span class="token number">1</span> free MockConnection<span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span><span class="token string">'conn 0'</span><span class="token punctuation">}</span>
线程 <span class="token number">4</span> borrow MockConnection<span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span><span class="token string">'conn 0'</span><span class="token punctuation">}</span>
线程 <span class="token number">3</span> wait<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
线程 <span class="token number">2</span> wait<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
线程 <span class="token number">0</span> free MockConnection<span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span><span class="token string">'conn 1'</span><span class="token punctuation">}</span>
线程 <span class="token number">2</span> borrow MockConnection<span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span><span class="token string">'conn 1'</span><span class="token punctuation">}</span>
线程 <span class="token number">3</span> wait<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
线程 <span class="token number">4</span> free MockConnection<span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span><span class="token string">'conn 0'</span><span class="token punctuation">}</span>
线程 <span class="token number">3</span> borrow MockConnection<span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span><span class="token string">'conn 0'</span><span class="token punctuation">}</span>
线程 <span class="token number">2</span> free MockConnection<span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span><span class="token string">'conn 1'</span><span class="token punctuation">}</span>
线程 <span class="token number">3</span> free MockConnection<span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span><span class="token string">'conn 0'</span><span class="token punctuation">}</span></code></pre> 
<p>以上实现没有考虑：</p> 
<ul><li>连接的动态增长与收缩</li><li>连接保活（可用性检测）</li><li>等待超时处理</li><li>分布式 hash</li></ul> 
<p>对于关系型数据库，有比较成熟的连接池实现，例如c3p0, druid等</p> 
<p>对于更通用的对象池，可以考虑使用apache commons pool，例如redis连接池可以参考jedis中关于连接池的实现</p> 
<h4><a id="nal__358"></a>四、ﬁnal 原理</h4> 
<h5><a id="1_nal__360"></a>1、设置 ﬁnal 变量的原理</h5> 
<p>理解了 volatile 原理，再对比 ﬁnal 的实现就比较简单了</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestFinal</span> <span class="token punctuation">{<!-- --></span>    
	<span class="token keyword">final</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span></code></pre> 
<p>字节码：</p> 
<pre><code class="prism language-java"><span class="token number">0</span><span class="token operator">:</span> aload_0 
<span class="token number">1</span><span class="token operator">:</span> invokespecial #<span class="token number">1</span>                  <span class="token comment">// Method java/lang/Object."&lt;init&gt;":()V </span>
<span class="token number">4</span><span class="token operator">:</span> aload_0 
<span class="token number">5</span><span class="token operator">:</span> bipush        <span class="token number">20</span> 
<span class="token number">7</span><span class="token operator">:</span> putfield      #<span class="token number">2</span>                  <span class="token comment">// Field a:I    </span>
<span class="token operator">&lt;</span><span class="token operator">--</span> 写屏障 
<span class="token number">10</span><span class="token operator">:</span> <span class="token keyword">return</span></code></pre> 
<p>发现 ﬁnal 变量的赋值也会通过 putﬁeld 指令来完成，同样在这条指令之后也会加入写屏障，保证在其它线程读到 它的值时不会出现为 0 的情况</p> 
<h5><a id="2_nal__384"></a>2、获取 ﬁnal 变量的原理</h5> 
<p>读取final变量时，如果值较小可以直接放入使用类的操作数栈中，如果值较大会放入使用类的常量池中。</p> 
<h4><a id="_388"></a>五、无状态</h4> 
<p>在 web 阶段学习时，设计 Servlet 时为了保证其线程安全，都会有这样的建议，不要为 Servlet 设置成员变量，这 种没有任何成员变量的类是线程安全的</p> 
<p>因为成员变量保存的数据也可以称为状态信息，因此没有成员变量就称之为**【无状态】**</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6c618be5b2df6e7de4ba3c8f98dc3937/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">含重根的三阶实对称矩阵的快速对角化方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1a6c85bbf8d14916e087469717d58990/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mycat 实现读写分离</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>