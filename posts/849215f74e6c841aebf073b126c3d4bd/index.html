<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【K8s】基本存储、高级存储（PV和PVC）、配置存储 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【K8s】基本存储、高级存储（PV和PVC）、配置存储" />
<meta property="og:description" content="文章目录 背景一、基本存储1、EmptyDir2、HostPath3、NFS 二、高级存储1、认识PV和PVC2、PV3、PVC4、生命周期 三、配置存储1、ConfigMap2、 Secret 背景 程序运行在容器中，而容器的生命周期可能极其短暂，容器销毁，数据丢失，因此，为了持久化容器中的数据，Volumn出现。
Volume是Pod中 能够被多个容器访问的共享目录，它被定义在Pod上，然后被一个Pod里的多个容器挂载到具体的文件目录下。
kubernetes通过Volume实现：
同一个Pod中不同容器之间的数据共享数据的持久化存储 Volume的生命周期不与Pod中单个容器的生命周期相关，当容器终止或者重启时，Volume中的数据也不会丢失。
kubernetes的Volume支持多种类型：
简单存储：EmptyDir、HostPath、NFS高级存储：PV、PVC配置存储：ConfigMap、Secret 挂载，就是A挂载到B目录，就像A是个U盘，插到了B这个电脑上。那以后访问B目录就是在访问A目录。
一、基本存储 1、EmptyDir EmptyDir存储就是主机上的一个空目录。
EmptyDir是在Pod被分配到Node时创建的，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为kubernetes会自动分配一个目录，当Pod销毁时， EmptyDir中的数据也会被永久删除。其适用场景有：
临时空间，例如用于某些应用程序运行时所需的临时目录，且无须永久保留同一个pod中，一个容器需要从另一个容器中获取数据的目录（多容器共享目录） 案例：容器数据共享--EmptyDir 在一个Pod中准备两个容器nginx和busybox，然后声明一个Volume分别挂在到两个容器的目录中，然后nginx容器负责向Volume中写日志，busybox中通过命令将日志内容读到控制台。
创建一个volume-emptydir.yaml：
apiVersion: v1 kind: Pod metadata: name: volume-emptydir namespace: dev spec: containers: - name: nginx image: nginx:1.17.1 ports: - containerPort: 80 volumeMounts: # 将logs-volume挂在到nginx容器中，对应的目录为 /var/log/nginx - name: logs-volume mountPath: /var/log/nginx - name: busybox image: busybox:1.30 command: [&#34;/bin/sh&#34;,&#34;-c&#34;,&#34;tail -f /logs/access.log&#34;] # 初始命令，动态读取指定文件中内容 volumeMounts: # 将logs-volume 挂在到busybox容器中，对应的目录为 /logs - name: logs-volume mountPath: /logs volumes: # 声明volume， name为logs-volume，类型为emptyDir - name: logs-volume emptyDir: {} 配置好两个容器目录和空目录挂载的关系，创建pod：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/849215f74e6c841aebf073b126c3d4bd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-16T07:30:00+08:00" />
<meta property="article:modified_time" content="2023-05-16T07:30:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【K8s】基本存储、高级存储（PV和PVC）、配置存储</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_2" rel="nofollow">背景</a></li><li><a href="#_25" rel="nofollow">一、基本存储</a></li><li><ul><li><a href="#1EmptyDir_26" rel="nofollow">1、EmptyDir</a></li><li><a href="#2HostPath_93" rel="nofollow">2、HostPath</a></li><li><a href="#3NFS_168" rel="nofollow">3、NFS</a></li></ul> 
  </li><li><a href="#_252" rel="nofollow">二、高级存储</a></li><li><ul><li><a href="#1PVPVC_253" rel="nofollow">1、认识PV和PVC</a></li><li><a href="#2PV_264" rel="nofollow">2、PV</a></li><li><a href="#3PVC_384" rel="nofollow">3、PVC</a></li><li><a href="#4_554" rel="nofollow">4、生命周期</a></li></ul> 
  </li><li><a href="#_584" rel="nofollow">三、配置存储</a></li><li><ul><li><a href="#1ConfigMap_586" rel="nofollow">1、ConfigMap</a></li><li><a href="#2_Secret_683" rel="nofollow">2、 Secret</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>背景</h2> 
<p>程序运行在容器中，而容器的生命周期可能极其短暂，容器销毁，数据丢失，因此，为了持久化容器中的数据，Volumn出现。</p> 
<blockquote> 
 <p>Volume是Pod中 <mark><strong>能够被多个容器访问的共享目录</strong></mark>，它被定义在Pod上，然后被一个Pod里的多个容器挂载到具体的文件目录下。</p> 
</blockquote> 
<p>kubernetes通过Volume实现：</p> 
<ul><li>同一个Pod中不同容器之间的数据共享</li><li>数据的持久化存储</li></ul> 
<blockquote> 
 <p>Volume的生命周期不与Pod中单个容器的生命周期相关，当容器终止或者重启时，Volume中的数据也不会丢失。</p> 
</blockquote> 
<p>kubernetes的Volume支持多种类型：</p> 
<ul><li>简单存储：EmptyDir、HostPath、NFS</li><li>高级存储：PV、PVC</li><li>配置存储：ConfigMap、Secret</li></ul> 
<blockquote> 
 <p><img src="https://images2.imgbox.com/e1/f4/4HPKwC6o_o.png" alt="在这里插入图片描述"><br> 挂载，就是A挂载到B目录，就像A是个U盘，插到了B这个电脑上。那以后访问B目录就是在访问A目录。</p> 
</blockquote> 
<h2><a id="_25"></a>一、基本存储</h2> 
<h3><a id="1EmptyDir_26"></a>1、EmptyDir</h3> 
<p>EmptyDir存储就是<code>主机上的</code>一个空目录。</p> 
<p>EmptyDir是在Pod被分配到Node时创建的，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为kubernetes会<code>自动分配</code>一个目录，<code>当Pod销毁时， EmptyDir中的数据也会被永久删除</code>。其适用场景有：</p> 
<ul><li>临时空间，例如用于某些应用程序运行时所需的临时目录，且无须永久保留</li><li>同一个pod中，一个容器需要从另一个容器中获取数据的目录（多容器共享目录）</li></ul> 
<pre><code class="prism language-bash">案例：容器数据共享--EmptyDir
</code></pre> 
<p>在一个Pod中准备两个容器nginx和busybox，然后声明一个Volume分别挂在到两个容器的目录中，然后nginx容器负责向Volume中写日志，busybox中通过命令将日志内容读到控制台。</p> 
<p><img src="https://images2.imgbox.com/80/90/LScKZiyd_o.png" alt="在这里插入图片描述"></p> 
<p>创建一个volume-emptydir.yaml：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>emptydir
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>  <span class="token comment"># 将logs-volume挂在到nginx容器中，对应的目录为 /var/log/nginx</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"tail -f /logs/access.log"</span><span class="token punctuation">]</span> <span class="token comment"># 初始命令，动态读取指定文件中内容</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>  <span class="token comment"># 将logs-volume 挂在到busybox容器中，对应的目录为 /logs</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span> <span class="token comment"># 声明volume， name为logs-volume，类型为emptyDir</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<p>配置好两个容器目录和空目录挂载的关系，创建pod：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl create -f volume-emptydir.yaml
pod/volume-emptydir created

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl get pods volume-emptydir -n dev -o wide
NAME                  READY   STATUS    RESTARTS   AGE      IP       NODE   <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span> 
volume-emptydir       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          97s   <span class="token number">10.42</span>.2.9   node1  <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

</code></pre> 
<p>访问</p> 
<pre><code class="prism language-bash"><span class="token comment"># 通过podIp：容器Pod访问nginx</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> <span class="token function">curl</span> <span class="token number">10.42</span>.2.9：80
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

<span class="token comment"># 通过kubectl logs命令查看指定容器的标准输出</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl logs -f volume-emptydir -n dev -c busybox
<span class="token number">10.42</span>.1.0 - - <span class="token punctuation">[</span><span class="token number">27</span>/Jun/2021:15:08:54 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"curl/7.29.0"</span> <span class="token string">"-"</span>
</code></pre> 
<p>注意上面-c查看指定容器的日志</p> 
<h3><a id="2HostPath_93"></a>2、HostPath</h3> 
<p>EmptyDir中数据会随着pod的销毁而丢失，想将数据持久化到主机中，可以选择HostPath。</p> 
<blockquote> 
 <p>HostPath就是将Node主机中<code>一个实际目录挂在到Pod中</code>，以供容器使用，这样的设计就可以保证Pod销毁了，但是数据依据可以存在于Node主机上。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/44/5d/TfLDwMpV_o.png" alt="在这里插入图片描述"><br> 创建一个volume-hostpath.yaml：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>hostpath
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"tail -f /logs/access.log"</span><span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span> 
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/logs  <span class="token comment"># 指定node主机上的一个实际目录</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate  <span class="token comment"># 目录存在就使用，不存在就先创建后使用</span>
</code></pre> 
<pre><code class="prism language-bash">关于type的值的一点说明：
    DirectoryOrCreate 目录存在就使用，不存在就先创建后使用
    Directory   目录必须存在
    FileOrCreate  文件存在就使用，不存在就先创建后使用
    File 文件必须存在 
    Socket  unix套接字必须存在
    CharDevice  字符设备必须存在
    BlockDevice 块设备必须存在
</code></pre> 
<p>创建pod，访问nginx产生日志;</p> 
<pre><code class="prism language-bash"><span class="token comment"># 创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl create -f volume-hostpath.yaml
pod/volume-hostpath created

<span class="token comment"># 查看Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl get pods volume-hostpath -n dev -o wide
NAME                  READY   STATUS    RESTARTS   AGE   IP             NODE   <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
pod-volume-hostpath   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          16s   <span class="token number">10.42</span>.2.10     node1  <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

<span class="token comment">#访问nginx</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> <span class="token function">curl</span> <span class="token number">10.42</span>.2.10:80

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl logs -f volume-emptydir -n dev -c busybox
</code></pre> 
<p>接下来去host的/root/logs目录下查看存储的文件。注意是<code>去Pod被调度到的那个节点</code>（案例中是node1），其余节点没有这个文件：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span> <span class="token function">ls</span> /root/logs/
access.log  error.log

<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span> <span class="token function">tail</span> -f /root/logs/access.log
<span class="token punctuation">..</span>.
<span class="token comment"># 此时删除pod，/root/logs/目录下的文件依旧存在</span>
</code></pre> 
<p><mark>同样的道理，如果在此目录下创建一个文件，到容器中也是可以看到的</mark></p> 
<h3><a id="3NFS_168"></a>3、NFS</h3> 
<p>HostPath完成了数据的持久化，但当整个节点宕机，pod重启被调度到其他节点，而其他节点并没有它的数据。（HostPath持久化的目录仅在pod所在的那个节点）</p> 
<blockquote> 
 <p>NFS是一个<code>网络文件存储系统</code>，可以搭建一台NFS服务器，然后将Pod中的存储直接连接到NFS系统上，这样的话，无论Pod在节点上怎么转移，只要集群Node跟NFS的对接没问题，数据就可以成功访问。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/60/70/YSZ7rmJT_o.png" alt="在这里插入图片描述"></p> 
<p>1）首先准备nfs的服务器，这里为了简单，直接用master节点做nfs服务器，注意实际环境NFS为单独服务器且有备份机</p> 
<pre><code class="prism language-bash"><span class="token comment"># 在nfs上安装nfs服务</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span> yum <span class="token function">install</span> nfs-utils -y

<span class="token comment"># 准备一个共享目录</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span> <span class="token function">mkdir</span> /root/data/nfs -pv

<span class="token comment"># 将共享目录以读写权限暴露给192.168.5.0/24网段中的所有主机，且不用root权限</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span> <span class="token function">vim</span> /etc/exports
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span> <span class="token function">more</span> /etc/exports
/root/data/nfs     <span class="token number">192.168</span>.5.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span>

<span class="token comment"># 启动nfs服务</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span> systemctl restart nfs
</code></pre> 
<p>2）接下来，要在的每个node节点上都安装下nfs，这样的目的是为了node节点可以驱动nfs设备，因此不需要启动</p> 
<pre><code class="prism language-bash"><span class="token comment"># 在node上安装nfs服务，注意不需要启动</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> yum <span class="token function">install</span> nfs-utils -y
</code></pre> 
<p>3）编写pod的配置文件volume-nfs.yaml</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>nfs
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"tail -f /logs/access.log"</span><span class="token punctuation">]</span> 
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
    <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.5.6  <span class="token comment">#nfs服务器地址</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/nfs <span class="token comment">#共享文件路径</span>
<span class="token comment"># 如此，产生的数据就会发送到nfs服务器的这个共享目录</span>
</code></pre> 
<p>4）运行pod，查看效果</p> 
<pre><code class="prism language-bash"><span class="token comment"># 创建pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl create -f volume-nfs.yaml
pod/volume-nfs created

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl get pods volume-nfs -n dev
NAME                  READY   STATUS    RESTARTS   AGE
volume-nfs        <span class="token number">2</span>/2     Running   <span class="token number">0</span>          2m9s

<span class="token comment"># 查看nfs服务器上的共享目录，发现已经有文件了</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> <span class="token function">ls</span> /root/data/
access.log  error.log

<span class="token comment"># 此时，pod销毁还是节点宕机，都不会丢失数据</span>
</code></pre> 
<p>总结：</p> 
<p>基本存储的三种方式中：EmptyDir的数据和Pod挂钩，HostPath的数据和某个node节点挂钩，NFS则相对较完善可行。</p> 
<h2><a id="_252"></a>二、高级存储</h2> 
<h3><a id="1PVPVC_253"></a>1、认识PV和PVC</h3> 
<p>上面使用NFS基本实现了pod数据持久化和容器数据共享，但得搭建NFS或者其他k8s所支持的文件存储系统。为了屏蔽底层存储的实现细节，方便掌握，pv和pvc出现。</p> 
<blockquote> 
 <ul><li> <p>PV（Persistent Volume）是持久化卷的意思，是对底层的共享存储的一种抽象。一般情况下PV由kubernetes管理员进行创建和配置，它与底层具体的共享存储技术有关，并通过插件完成与共享存储的对接。<br> <br></p> </li><li> <p>PVC（Persistent Volume Claim）是持久卷声明的意思，是用户对于存储需求的一种声明。换句话说，PVC其实就是用户向kubernetes系统发出的一种资源需求申请。</p> </li></ul> 
</blockquote> 
<p><img src="https://images2.imgbox.com/08/e1/km20juap_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2PV_264"></a>2、PV</h3> 
<p>PV是存储资源的抽象，资源清单文件：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1  
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span> <span class="token comment"># 存储类型，与底层真正存储对应</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>  <span class="token comment"># 存储能力，目前只支持存储空间的设置</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>  <span class="token comment"># 访问模式</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token comment"># 存储类别</span>
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> <span class="token comment"># 回收策略</span>
</code></pre> 
<p>注意，<code>PV的元数据中没有namespace</code>，因为PV是集群级别的资源，跨namespa使用的。PV的关键配置参数：</p> 
<table><thead><tr><th>参数</th><th align="left">说明</th></tr></thead><tbody><tr><td>存储类型</td><td align="left">底层实际存储的类型，kubernetes支持多种存储类型，如NFS</td></tr><tr><td>存储能力（capacity）</td><td align="left">目前只支持存储空间的设置( 如storage=1Gi )不过未来可能会加入IOPS、吞吐量等指标的配置</td></tr><tr><td>访问模式（accessModes）</td><td align="left">用于描述用户应用对存储资源的访问权限，包括：<br><br> - ReadWriteOnce（RWO）：读写权限，但是只能被单个节点挂载 <br> - ReadOnlyMany（ROX）： 只读权限，可以被多个节点挂载<br> - ReadWriteMany（RWX）：读写权限，可以被多个节点挂载</td></tr><tr><td>回收策略（persistentVolumeReclaimPolicy）</td><td align="left">当PV不再被使用了之后，即pvc和pv的线断了，对其数据的处理：<br><br> - Retain （保留） 保留数据，需要管理员手工清理数据 <br> - Recycle（回收） 清除 PV 中的数据，效果相当于执行 rm -rf /thevolume/*<br> - Delete （删除） 与 PV 相连的后端存储完成 volume 的删除操作，常见于云服务商的存储服务</td></tr><tr><td>存储类别</td><td align="left">PV可以通过storageClassName参数指定一个存储类别<br><br> - 具有特定类别的PV只能与请求了该类别的PVC进行绑定<br> - 未设定类别的PV则只能与不请求任何类别的PVC进行绑定</td></tr></tbody></table> 
<p>一个PV的生命周期中，可能处于以下4个阶段：</p> 
<ul><li>Available（可用）： 表示可用状态，还未被任何 PVC 绑定</li><li>Bound（已绑定）： 表示 PV 已经被 PVC 绑定</li><li>Released（已释放）： 表示 PVC 被删除，但是资源还未被集群重新声明</li><li>Failed（失败）： 表示该 PV 的自动回收失败</li></ul> 
<pre><code class="prism language-yaml">实验：
</code></pre> 
<p>使用NFS作为存储，来演示PV的使用，创建3个PV，对应NFS中的3个暴露的路径：</p> 
<ul><li>准备NFS环境</li></ul> 
<pre><code class="prism language-bash"><span class="token comment"># 创建目录</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span> <span class="token function">mkdir</span> /root/data/<span class="token punctuation">{<!-- --></span>pv1,pv2,pv3<span class="token punctuation">}</span> -pv

<span class="token comment"># 暴露服务</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span> <span class="token function">more</span> /etc/exports
/root/data/pv1     <span class="token number">192.168</span>.5.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span>
/root/data/pv2     <span class="token number">192.168</span>.5.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span>
/root/data/pv3     <span class="token number">192.168</span>.5.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span>

<span class="token comment"># 重启服务</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span> systemctl restart nfs
</code></pre> 
<ul><li>使用- - - 直接一个文件写三个PV的配置</li></ul> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> 
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token comment"># 存储能力大小</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain  <span class="token comment"># 保留数据</span>
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv1   <span class="token comment"># 指定NFS路径</span>
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.5.6  <span class="token comment"># 指定NFS服务器IP</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> 
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv2
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.5.6
    
<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv3
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> 
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 3Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv3
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.5.6
</code></pre> 
<ul><li>创建PV</li></ul> 
<pre><code class="prism language-bash"><span class="token comment"># 创建 pv</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl create -f pv.yaml
persistentvolume/pv1 created
persistentvolume/pv2 created
persistentvolume/pv3 created

<span class="token comment"># 查看pv</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl get <span class="token function">pv</span> -o wide
NAME   CAPACITY   ACCESS MODES  RECLAIM POLICY  STATUS      AGE   VOLUMEMODE
pv1    1Gi        RWX            Retain        Available    10s   Filesystem
pv2    2Gi        RWX            Retain        Available    10s   Filesystem
pv3    3Gi        RWX            Retain        Available    9s    Filesystem
<span class="token comment"># Available即可用，未被pvc绑定</span>
</code></pre> 
<h3><a id="3PVC_384"></a>3、PVC</h3> 
<p>PVC是资源的申请，用来声明对存储空间、访问模式、存储类别需求信息。资源清单文件如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev  <span class="token comment"># ！！pvc是有namespace的，和pv不是一个级别</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token comment"># 访问模式</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 采用标签对PV选择</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token comment"># 存储类别</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># 请求空间</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi
<span class="token comment"># 具体参数对应pv查看</span>
</code></pre> 
<blockquote> 
 <p><code>PV声明访问模式、存储类别、空间等信息，是说明自己有哪些能力。PVC声明这些字段则是说自己想要一个有什么样能力的PV来绑定</code>。<br> <br>整体思路就是<mark>pvc绑定pv，pod引用pvc</mark></p> 
</blockquote> 
<p>创建pvc.yaml，申请pv：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc1
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc2
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc3
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi <span class="token comment"># 前面的pv只有1Gi、2Gi、3Gi的，这里要5Gi理论上要绑定失败</span>
</code></pre> 
<p>前面的pv只有1Gi、2Gi、3Gi的，这里最后一个pvc要5Gi，理论上要绑定失败</p> 
<pre><code class="prism language-bash"><span class="token comment"># 创建pvc</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl create -f pvc.yaml
persistentvolumeclaim/pvc1 created
persistentvolumeclaim/pvc2 created
persistentvolumeclaim/pvc3 created
</code></pre> 
<p>查看pvc，两个状态时Bound，5Gi那个则是Pending</p> 
<pre><code class="prism language-bash"><span class="token comment"># 查看pvc</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl get pvc  -n dev -o wide
NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE   VOLUMEMODE
pvc1   Bound    pv1      1Gi        RWX                           15s   Filesystem
pvc2   Bound    pv2      2Gi        RWX                           15s   Filesystem
pvc3   Pending                                                    15s   Filesystem
</code></pre> 
<p>查看pv，可以看到pv3仍然是Available状态</p> 
<pre><code class="prism language-bash"><span class="token comment"># 查看pv</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl get <span class="token function">pv</span> -o wide
NAME  CAPACITY ACCESS MODES  RECLAIM POLICY  STATUS    CLAIM       AGE     VOLUMEMODE
pv1    1Gi        RWx        Retain          Bound    dev/pvc1    3h37m    Filesystem
pv2    2Gi        RWX        Retain          Bound    dev/pvc2    3h37m    Filesystem
pv3    3Gi        RWX        Retain          Available            3h37m    Filesystem   
</code></pre> 
<p>接下来创建pod，让pod去使用PVC：</p> 
<pre><code class="prism language-yaml"><span class="token comment"># pods.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod1
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"while true;do echo pod1 &gt;&gt; /root/out.txt; sleep 10; done;"</span><span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/ <span class="token comment"># 即pod中busybox容器的的/root目录和pvc建立挂载关系</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume
      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pvc1
        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod2
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"while true;do echo pod2 &gt;&gt; /root/out.txt; sleep 10; done;"</span><span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume
      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pvc2
        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre> 
<p>以上即pod中busybox容器的的/root目录和pvc建立挂载关系，数据最终持久化到pvc的pv的NFS服务器的目录，即前面初始化NFS时的/root/data/pv1</p> 
<pre><code class="prism language-bash"><span class="token comment"># 创建pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl create -f pods.yaml
pod/pod1 created
pod/pod2 created

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl get pods -n dev -o wide
NAME   READY   STATUS    RESTARTS   AGE   IP            NODE   
pod1   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14s   <span class="token number">10.244</span>.1.69   node1   
pod2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14s   <span class="token number">10.244</span>.1.70   node1  
</code></pre> 
<p>此时查看NFS的文件目录：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 查看nfs中的文件存储</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span> <span class="token function">tail</span> -f  /root/data/pv1/out.txt
node1
node1
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span> <span class="token function">tail</span> -f  /root/data/pv2/out.txt
node2
node2
</code></pre> 
<p>此时删除pod，再删除pvc，查看pv状态，发现pv是Release状态，该状态即pvc被删除，但资源还未被集群重新声明</p> 
<pre><code class="prism language-bash"><span class="token comment"># 使用yaml文件删除最简单，ns和资源类型都不用加</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl delete -f pods.yaml

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl delete -f pvc.yaml
</code></pre> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl get <span class="token function">pv</span> -o wide
NAME  CAPACITY ACCESS MODES  RECLAIM POLICY  STATUS    CLAIM       AGE     VOLUMEMODE
pv1    1Gi        RWx        Retain          Released    dev/pvc1    3h37m    Filesystem
pv2    2Gi        RWX        Retain          Released    dev/pvc2    3h37m    Filesystem
pv3    3Gi        RWX        Retain          Available               3h37m    Filesystem   
</code></pre> 
<h3><a id="4_554"></a>4、生命周期</h3> 
<p>PVC和PV是一 一对应的，二者相互联系，生命周期各个阶段有：</p> 
<p><strong>STEP1.资源供应</strong>：管理员手动创建底层存储和PV</p> 
<p><strong>STEP2.资源绑定</strong>：用户创建PVC，kubernetes负责根据PVC的声明去寻找PV，并绑定</p> 
<p>在用户定义好PVC之后，系统将根据PVC对存储资源的请求在已存在的PV中选择一个满足条件的</p> 
<ul><li> <p>一旦找到，就将该PV与用户定义的PVC进行绑定，用户的应用就可以使用这个PVC了</p> </li><li> <p>如果找不到，PVC则会<code>无限期处于Pending</code>状态，直到等到系统管理员创建了一个符合其要求的PV</p> </li><li> <p><code>PV一旦绑定到某个PVC上，就会被这个PVC独占</code>，不能再与其他PVC进行绑定了</p> </li></ul> 
<p><strong>STEP3.资源使用</strong>：用户可在pod中像volume一样使用pvc</p> 
<ul><li>Pod使用Volume的定义，<code>将PVC挂载到容器内的某个路径</code>进行使用。</li></ul> 
<p><strong>STEP4.资源释放</strong>：用户删除pvc来释放pv</p> 
<ul><li>当存储资源使用完毕后，用户可以删除PVC，与该PVC绑定的PV将会被标记为“已释放”，但还不能立刻与其他PVC进行绑定。通过<code>之前PVC写入的数据可能还被留在存储设备上，只有在清除之后该PV才能再次使用</code>。</li></ul> 
<p><strong>STEP5.资源回收</strong>：kubernetes根据pv设置的回收策略进行资源的回收</p> 
<ul><li>对于PV，管理员可以设定回收策略，用于设置与之绑定的PVC释放资源之后如何<code>处理遗留数据</code>的问题。只有PV的存储空间完成回收，才能供新的PVC绑定和使用</li></ul> 
<p><img src="https://images2.imgbox.com/08/10/AYCPzunl_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_584"></a>三、配置存储</h2> 
<h3><a id="1ConfigMap_586"></a>1、ConfigMap</h3> 
<p>ConfigMap是一种比较特殊的存储卷，它的主要作用是 <mark><strong>用来存储配置信息的</strong></mark> 。</p> 
<pre><code class="prism language-bash">效果演示：
</code></pre> 
<p>创建configmap.yaml：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> configmap
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">info</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    username:admin
    password:123456</span>

<span class="token comment"># 注意，这里和其他资源不同的是，它没有spec，而是data</span>
</code></pre> 
<p>创建ConfigMap：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 创建configmap</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl create -f configmap.yaml
configmap/configmap created

<span class="token comment"># 查看configmap详情</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl describe cm configmap -n dev
Name:         configmap
Namespace:    dev
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

Data
<span class="token operator">==</span><span class="token operator">==</span>
info:
----
username:admin
password:123456

Events:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> 
<p>接下来创建一个pod-configmap.yaml，将上面创建的configmap挂载进去：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>configmap
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span> <span class="token comment"># 将configmap挂载到目录</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config  <span class="token comment"># 这个名字和下面的volumes.name一致</span>
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /configmap/config  <span class="token comment"># 将configMap挂载到容器的这个目录</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span> <span class="token comment"># 引用configmap</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> configmap
</code></pre> 
<p>创建pod：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 创建pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl create -f pod-configmap.yaml
pod/pod-configmap created

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl get pod pod-configmap -n dev
NAME            READY   STATUS    RESTARTS   AGE
pod-configmap   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6s
</code></pre> 
<p>进入pod查看和ConfigMap挂载的目录：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl <span class="token builtin class-name">exec</span> -it pod-configmap -n dev /bin/sh
： <span class="token builtin class-name">cd</span> /configmap/config/
： <span class="token function">ls</span>
info
： <span class="token function">more</span> info
username:admin
password:123456
</code></pre> 
<p>可以看到映射已经成功：</p> 
<ul><li>每个configmap都映射成了一个目录</li><li>key—&gt;文件</li><li>value----&gt;文件中的内容</li></ul> 
<p>此时如果<mark>更新configmap的内容, 容器中的值也会动态更新</mark></p> 
<h3><a id="2_Secret_683"></a>2、 Secret</h3> 
<p>Secret和ConfigMap相似，不同的是，它存储信息不是明文存储。主要用于存储敏感信息，例如密码、秘钥、证书等等。</p> 
<ul><li>首先使用base64对数据进行编码</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> <span class="token builtin class-name">echo</span> -n <span class="token string">'admin'</span> <span class="token operator">|</span> base64 <span class="token comment">#准备username</span>
<span class="token assign-left variable">YWRtaW4</span><span class="token operator">=</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> <span class="token builtin class-name">echo</span> -n <span class="token string">'123456'</span> <span class="token operator">|</span> base64 <span class="token comment">#准备password</span>
MTIzNDU2
</code></pre> 
<ul><li>编写secret.yaml，并创建Secret</li></ul> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">username</span><span class="token punctuation">:</span> YWRtaW4=
  <span class="token key atrule">password</span><span class="token punctuation">:</span> MTIzNDU2
</code></pre> 
<pre><code class="prism language-bash"><span class="token comment"># 创建secret</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl create -f secret.yaml
secret/secret created

<span class="token comment"># 查看secret详情</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl describe secret secret -n dev
Name:         secret
Namespace:    dev
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Type:  Opaque
Data
<span class="token operator">==</span><span class="token operator">==</span>
password:  <span class="token number">6</span> bytes
username:  <span class="token number">5</span> bytes
</code></pre> 
<ul><li>创建pod-secret.yaml，将上面创建的secret挂载进去</li></ul> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>secret
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span> <span class="token comment"># 将secret挂载到目录</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config  <span class="token comment"># 1</span>
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /secret/config  <span class="token comment"># 容器中的挂载点目录</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config  <span class="token comment"># 和1处一致</span>
    <span class="token key atrule">secret</span><span class="token punctuation">:</span>
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> secret
</code></pre> 
<pre><code class="prism language-bash"><span class="token comment"># 创建pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl create -f pod-secret.yaml
pod/pod-secret created

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl get pod pod-secret -n dev
NAME            READY   STATUS    RESTARTS   AGE
pod-secret      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m28s

</code></pre> 
<p>进入pod，查看secret信息，发现已经自动解码了</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span> kubectl <span class="token builtin class-name">exec</span> -it pod-secret /bin/sh -n dev
/  <span class="token function">ls</span> /secret/config/
password  username
/  <span class="token function">more</span> /secret/config/username
admin
/  <span class="token function">more</span> /secret/config/password
<span class="token number">123456</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7d9fb976f414d65e43b21a8d701f29c9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">rtl仿真器-iverilog icarus安装和测试</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/552bc612f6cb6aa9919b5b09bc8246fa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">缓存穿透、缓存雪崩和缓存击穿</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>