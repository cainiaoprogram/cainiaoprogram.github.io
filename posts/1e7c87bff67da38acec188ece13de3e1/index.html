<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>7.数仓项目经验—基准测试 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="7.数仓项目经验—基准测试" />
<meta property="og:description" content="项目经验之基准测试 1. 测试HDFS写性能 测试内容：
向HDFS集群写10个128M的文件。 hadoop jar /opt/module/hadoop-3.1.3/share/hadoop/mapreduce/hadoop-mapreduce-client-jobclient-3.1.3-tests.jar TestDFSIO -write -nrFiles 10 -fileSize 128MB 注意：
nrFiles n为生成mapTask的数量，生产环境一般可通过8088端口查看cpu核数，设置为cpu核数-1 测试结果：
2020-04-16 13:41:24,724 INFO fs.TestDFSIO: ----- TestDFSIO ----- : write 2020-04-16 13:41:24,724 INFO fs.TestDFSIO: Date &amp; time: Thu Apr 16 13:41:24 CST 2020 2020-04-16 13:41:24,724 INFO fs.TestDFSIO: Number of files: 10 2020-04-16 13:41:24,725 INFO fs.TestDFSIO: Total MBytes processed: 1280 2020-04-16 13:41:24,725 INFO fs.TestDFSIO: Throughput mb/sec: 8.88 2020-04-16 13:41:24,725 INFO fs.TestDFSIO: Average IO rate mb/sec: 8." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1e7c87bff67da38acec188ece13de3e1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-18T09:45:56+08:00" />
<meta property="article:modified_time" content="2021-09-18T09:45:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">7.数仓项目经验—基准测试</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>项目经验之基准测试</h3> 
<h4><a id="1_HDFS_2"></a>1. 测试HDFS写性能</h4> 
<blockquote> 
 <p>测试内容：</p> 
 <ul><li>向HDFS集群写10个128M的文件。</li></ul> 
 <ol><li> <pre><code class="prism language-shell">hadoop jar /opt/module/hadoop-3.1.3/share/hadoop/mapreduce/hadoop-mapreduce-client-jobclient-3.1.3-tests.jar TestDFSIO -write -nrFiles <span class="token number">10</span> -fileSize 128MB
</code></pre> </li></ol> 
 <p>注意：</p> 
 <ul><li><code>nrFiles n为生成mapTask的数量，生产环境一般可通过8088端口查看cpu核数，设置为cpu核数-1</code></li></ul> 
 <p>测试结果：</p> 
 <pre><code class="prism language-shell"><span class="token number">2020</span>-04-16 <span class="token number">13</span>:41:24,724 INFO fs.TestDFSIO: ----- TestDFSIO ----- <span class="token builtin class-name">:</span> <span class="token function">write</span>
<span class="token number">2020</span>-04-16 <span class="token number">13</span>:41:24,724 INFO fs.TestDFSIO:             Date <span class="token operator">&amp;</span> time: Thu Apr <span class="token number">16</span> <span class="token number">13</span>:41:24 CST <span class="token number">2020</span>
<span class="token number">2020</span>-04-16 <span class="token number">13</span>:41:24,724 INFO fs.TestDFSIO:         Number of files: <span class="token number">10</span>
<span class="token number">2020</span>-04-16 <span class="token number">13</span>:41:24,725 INFO fs.TestDFSIO:  Total MBytes processed: <span class="token number">1280</span>
<span class="token number">2020</span>-04-16 <span class="token number">13</span>:41:24,725 INFO fs.TestDFSIO:       Throughput mb/sec: <span class="token number">8.88</span>
<span class="token number">2020</span>-04-16 <span class="token number">13</span>:41:24,725 INFO fs.TestDFSIO:  Average IO rate mb/sec: <span class="token number">8.96</span>
<span class="token number">2020</span>-04-16 <span class="token number">13</span>:41:24,725 INFO fs.TestDFSIO:   IO rate std deviation: <span class="token number">0.87</span>
<span class="token number">2020</span>-04-16 <span class="token number">13</span>:41:24,725 INFO fs.TestDFSIO:      Test <span class="token builtin class-name">exec</span> <span class="token function">time</span> sec: <span class="token number">67.61</span>
</code></pre> 
 <p>结果分析：</p> 
 <ul><li> <p><code>Number of files：</code>生成mapTask数量，一般是集群中CPU核数-1，我们测试虚拟机就<code>按照实际的物理内存-1分配即可</code>。</p> </li><li> <p><code>Total MBytes processed：</code>单个map处理的文件大小。</p> </li><li> <p><code>Throughput mb/sec:</code>单个mapTask的吞吐量。</p> 
   <ul><li>计算方式：处理的总文件大小/每一个mapTask写数据的时间累加。</li></ul> </li><li> <p><code>集群整体吞吐量：</code>生成mapTask数量*单个mapTask的吞吐量。</p> </li><li> <p><code>Average IO rate mb/sec：</code>单个mapTask的吞吐量 。</p> 
   <ul><li>计算方式：每个mapTask处理文件大小/每一个mapTask写数据的时间 累加/生成mapTask数量。</li></ul> </li><li> <p><code>IO rate std deviation:</code>方差、反映各个mapTask处理的差值，越小越均衡。</p> </li><li> <p>注意：如果测试过程中，出现异常可以在<code>yarn-site.xml</code>中设置虚拟内存检测为false分发配置并重启集群。</p> </li><li> <pre><code class="prism language-xml"><span class="token comment">&lt;!--是否启动一个线程检查每个任务正使用的虚拟内存量，如果任务超出分配值，则直接将其杀掉，默认是true --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.nodemanager.vmem-check-enabled<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li></ul> 
</blockquote> 
<h4><a id="2_HDFS_57"></a>2. 测试HDFS读性能</h4> 
<blockquote> 
 <p>测试内容：</p> 
 <ul><li> <p>读取HDFS集群10个128M的文件。</p> </li><li> <pre><code class="prism language-shell">hadoop jar /opt/module/hadoop-3.1.3/share/hadoop/mapreduce/hadoop-mapreduce-client-jobclient-3.1.3-tests.jar TestDFSIO -read -nrFiles <span class="token number">10</span> -fileSize 128MB
</code></pre> </li></ul> 
 <p>测试结果：</p> 
 <ul><li> <pre><code class="prism language-shell"><span class="token number">2020</span>-04-16 <span class="token number">13</span>:43:38,857 INFO fs.TestDFSIO: ----- TestDFSIO ----- <span class="token builtin class-name">:</span> <span class="token builtin class-name">read</span>
<span class="token number">2020</span>-04-16 <span class="token number">13</span>:43:38,858 INFO fs.TestDFSIO:   Date <span class="token operator">&amp;</span> time: Thu Apr <span class="token number">16</span> <span class="token number">13</span>:43:38 CST <span class="token number">2020</span>
<span class="token number">2020</span>-04-16 <span class="token number">13</span>:43:38,859 INFO fs.TestDFSIO:         Number of files: <span class="token number">10</span>
<span class="token number">2020</span>-04-16 <span class="token number">13</span>:43:38,859 INFO fs.TestDFSIO:  Total MBytes processed: <span class="token number">1280</span>
<span class="token number">2020</span>-04-16 <span class="token number">13</span>:43:38,859 INFO fs.TestDFSIO:       Throughput mb/sec: <span class="token number">85.54</span>
<span class="token number">2020</span>-04-16 <span class="token number">13</span>:43:38,860 INFO fs.TestDFSIO:  Average IO rate mb/sec: <span class="token number">100.21</span>
<span class="token number">2020</span>-04-16 <span class="token number">13</span>:43:38,860 INFO fs.TestDFSIO:   IO rate std deviation: <span class="token number">44.37</span>
<span class="token number">2020</span>-04-16 <span class="token number">13</span>:43:38,860 INFO fs.TestDFSIO:      Test <span class="token builtin class-name">exec</span> <span class="token function">time</span> sec: <span class="token number">53.61</span>
</code></pre> </li></ul> 
 <p>删除测试生成数据</p> 
 <ul><li> <pre><code class="prism language-shell">hadoop jar /opt/module/hadoop-3.1.3/share/hadoop/mapreduce/hadoop-mapreduce-client-jobclient-3.1.3-tests.jar TestDFSIO -clean
</code></pre> </li></ul> 
 <p>使用Sort程序评测MapReduce</p> 
 <ol><li> <p>使用RandomWriter来产生随机数，每个节点运行10个Map任务，每个Map产生大约1G大小的二进制随机数。</p> <pre><code class="prism language-shell">hadoop jar /opt/module/hadoop-3.1.3/share/hadoop/mapreduce/hadoop-mapreduce-examples-3.1.3.jar randomwriter random-data
</code></pre> </li><li> <p>执行Sort程序</p> <pre><code class="prism language-shell">hadoop jar /opt/module/hadoop-3.1.3/share/hadoop/mapreduce/hadoop-mapreduce-examples-3.1.3.jar <span class="token function">sort</span> random-data sorted-data
</code></pre> </li><li> <p>验证数据是否真正排好序了</p> <pre><code class="prism language-shell">hadoop jar /opt/module/hadoop-3.1.3/share/hadoop/mapreduce/hadoop-mapreduce-client-jobclient-3.1.3-tests.jar testmapredsort -sortInput random-data -sortOutput sorted-data
</code></pre> </li></ol> 
</blockquote> 
<h4><a id="3_Hadoop_106"></a>3. 项目经验之Hadoop参数调优</h4> 
<blockquote> 
 <ol><li> <p>HDFS参数调优<code>hdfs-site.xml</code></p> </li><li> <pre><code class="prism language-xml">The number of Namenode RPC server threads that listen to requests from clients. If dfs.namenode.servicerpc-address is not configured then Namenode RPC server threads listen to requests from all nodes.
NameNode有一个工作线程池，用来处理不同DataNode的并发心跳以及客户端并发的元数据操作。
对于大集群或者有大量客户端的集群来说，通常需要增大参数dfs.namenode.handler.count的默认值10。
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.namenode.handler.count<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li><li> <p><code>dfs.namenode.handler.count</code>=<img src="https://images2.imgbox.com/b0/93/2lI4nIuE_o.jpg" alt="在这里插入图片描述"><br> ，比如集群规模为8台时，此参数设置为41。</p> </li><li> <p>YARN参数调优<code>yarn-site.xml</code></p> </li><li> <p>情景描述：</p> 
   <ul><li><code>总共7台机器，每天几亿条数据，数据源-&gt;Flume-&gt;Kafka-&gt;HDFS-&gt;Hive。</code></li></ul> </li><li> <p>面临问题：</p> 
   <ul><li>数据统计主要用HiveSQL，没有数据倾斜，小文件已经做了合并处理，开启的JVM重用，而且IO没有阻塞，内存用了不到50%。但是还是跑的非常慢，而且数据量洪峰过来时，整个集群都会宕掉。基于这种情况有没有优化方案？</li></ul> </li><li> <p>解决办法：</p> 
   <ul><li> <p>解决办法：</p> <p>内存利用率不够。这个一般是Yarn的2个配置造成的，单个任务可以申请的最大内存大小，和Hadoop单个节点可用内存大小。调节这两个参数能提高系统内存的利用率。</p> 
     <ul><li><code>yarn.nodemanager.resource.memory-mb</code> 
       <ul><li>表示该节点上YARN可使用的物理内存总量，默认是8192（MB），注意，如果你的节点内存资源不够8GB，则需要调减小这个值，而YARN不会智能的探测节点的物理内存总量。</li></ul> </li><li><code>yarn.scheduler.maximum-allocation-mb</code> 
       <ul><li>单个任务可申请的最多物理内存量，默认是8192（MB）。</li></ul> </li></ul> </li></ul> </li></ol> 
</blockquote> 
<h3><a id="_144"></a>☆</h3>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/327ef04a44140fa500bd663840560311/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">arduino学习——WS2812灯带</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3f53e3ff45fae54c1b667ba33e1fc4f1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">2021最新对比学习（Contrastive Learning）在各大顶会上的经典必读论文解读</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>