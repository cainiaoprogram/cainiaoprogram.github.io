<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>centos docker容器化部署nginx php项目（详细版） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="centos docker容器化部署nginx php项目（详细版）" />
<meta property="og:description" content="一、nginx和php的一些原理 1、nginx 是一个 web 服务器，它只能处理静态文件，无法处理 PHP Python 等具体程序语言的请求。所以，原理是这样，用户统一先请求到 nginx，nginx 会再把请求转发给 php-fpm。
2、php-fpm是处理 PHP 请求的一个东西，实现了 FastCGI 协议的一个东西，它叫PHP FastCGI 管理器。
3、 FastCGI 是什么？是一种与 Web 服务器通信的协议，规定了要传什么数据，具体什么格式。
二、前提条件 centos，安装了docker环境，当然你也可以安装宝塔，他俩不冲突，宝塔里可以方便的看到docker的一些东西。
php 镜像有fpm和cli两个版本。php-cli是命令行版本,而php-fpm是作为apache或者nginx等服务器软件处理PHP文件的扩展。这里选择fpm。
三、下载php和nginx镜像 docker pull nginx docker pull php:8.0-fpm 四、创建并运行PHP容器 mkdir -p /docker/www docker run --name php8.0 -p 9000:9000 -v /docker/www:/www -d php:8.0-fpm --name php8.0 给容器取个名字
-p 9000:9000 php容器的端口默认是9000,映射到宿主机的9000端口
-v /docker/www:/www 把宿主机的PHP源代码目录 /docker/www 挂载到容器内的 /www。未来在容器内访问 /www 就相当于访问宿主机的 /docker/www，容器的删除不会影响到源代码。
-d 后台静默运行
php:8.0-fpm 镜像名
如：报错Error response from daemon: driver failed programming external connectivity on endpoint XXX（端口映射或启动容器时报错）" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b3d482c2ee1c9424c010ee7723554d8a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-06T13:41:14+08:00" />
<meta property="article:modified_time" content="2023-11-06T13:41:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">centos docker容器化部署nginx php项目（详细版）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="nginxphp_0"></a>一、nginx和php的一些原理</h4> 
<p>1、nginx 是一个 web 服务器，它只能处理静态文件，无法处理 PHP Python 等具体程序语言的请求。所以，原理是这样，用户统一先请求到 nginx，nginx 会再把请求转发给 php-fpm。</p> 
<p>2、php-fpm是处理 PHP 请求的一个东西，实现了 FastCGI 协议的一个东西，它叫PHP FastCGI 管理器。</p> 
<p>3、 FastCGI 是什么？是一种与 Web 服务器通信的协议，规定了要传什么数据，具体什么格式。</p> 
<h4><a id="_8"></a>二、前提条件</h4> 
<p>centos，安装了docker环境，当然你也可以安装宝塔，他俩不冲突，宝塔里可以方便的看到docker的一些东西。</p> 
<p>php 镜像有fpm和cli两个版本。php-cli是命令行版本,而php-fpm是作为apache或者nginx等服务器软件处理PHP文件的扩展。这里选择fpm。</p> 
<h4><a id="phpnginx_14"></a>三、下载php和nginx镜像</h4> 
<pre><code>docker pull nginx
docker pull php:8.0-fpm
</code></pre> 
<h4><a id="PHP_21"></a>四、创建并运行PHP容器</h4> 
<pre><code>mkdir -p /docker/www

docker run --name php8.0 -p 9000:9000 -v /docker/www:/www -d php:8.0-fpm
</code></pre> 
<p><code>--name php8.0</code> 给容器取个名字<br> <code>-p 9000:9000</code> php容器的端口默认是9000,映射到宿主机的9000端口<br> <code>-v /docker/www:/www</code> 把宿主机的PHP源代码目录 <code>/docker/www</code> 挂载到容器内的 <code>/www</code>。未来在容器内访问 <code>/www</code> 就相当于访问宿主机的 <code>/docker/www</code>，容器的删除不会影响到源代码。<br> <code>-d</code> 后台静默运行<br> <code>php:8.0-fpm</code> 镜像名</p> 
<p>如：报错<strong>Error response from daemon: driver failed programming external connectivity on endpoint XXX（端口映射或启动容器时报错）</strong></p> 
<p><strong>解决方法</strong>：输入指令 systemctl restart docker 重启docker服务及可重新生成自定义链DOCKER</p> 
<p><strong>查php容器在docker的内网地址</strong></p> 
<p>docker inspect 获取<em>Docker</em>容器或者Docker镜像的元数据</p> 
<pre><code>docker inspect --format='{<!-- -->{.NetworkSettings.IPAddress}}' php8.0
</code></pre> 
<p>我的是<code>172.17.0.2</code>，这个如果你安装了宝塔的话也可以再宝塔里看到，这个ip下边要用。</p> 
<p>也可以直接通过查看元数据里的<code>IPAddress</code>字段来获取ip</p> 
<pre><code>docker inspect php8.0 
</code></pre> 
<h4><a id="nginx_57"></a>五、创建并运行nginx容器</h4> 
<p>1、 创建一个存放配置文件的目录。这个目录等下要挂载到容器里。</p> 
<pre><code>mkdir -p /docker/nginx/conf.d
</code></pre> 
<p>2、 进入目录并创建一个配置文件，并在里面填入如下内容。比如 <code>vim siyucms.com.conf</code>，一个站点一个配置文件。</p> 
<pre><code># 服务端配置节点
server {
    # 监听端口。此端口不能被占用了
    listen       80;
    # 此站点的域名,多个用空格隔开(注意localhost是本机的意思，你可以删掉)
    server_name  www.siyucms.com siyucms.com localhost;
    # 此站点的入口目录。这里要注意，这是当前容器内的路径。访问 /www就相当于访问宿主机的项目路径/docker/www。
    root  /www/01_siyucms_com/public;
    # 入口目录里可识别的入口文件
    index index.php index.html index.htm default.php default.htm default.html;
    
	# Thinkphp的伪静态设置
    location / {
        #访问路径的文件不存在则重写URL转交给ThinkPHP处理
        if (!-e $request_filename) {
            rewrite  ^(.*)$  /index.php?s=$1  last;   break;
        }
    }
    
    # 配置url，图片等资源文件
    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$ {
    	# 缓存100天
        expires 100d;
        # 不写日志
        error_log /dev/null;
        access_log off; 
    }
    # 配置url，前端的js css资源文件
    location ~ .*\.(js|css)?$ {
        expires 12h;
        error_log /dev/null;
        access_log off; 
    }
    
     # 配置url，处理及转发PHP请求
    location ~ \.php(/|$) {
        # 入口文件
        fastcgi_index index.php;
        # PHP项目的IP和端口。这是php-fpm的地址。由于nginx处理不了PHP代码，所以需要把请求转发给php-fpm进行处理。
        fastcgi_pass  172.17.0.2:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include       fastcgi_params;
    }
	# 用户的访问日志。注意，这目录必须存在，否则nginx将启动不了。由于我把宿主机的项目路径www挂载到了容器内的/www目录，所以宿主机的项目路径www里需要有wwwlogs目录。
    access_log  /www/wwwlogs/siyucms.com.log;
    # 错误日志
    error_log  /www/wwwlogs/siyucms.com.error.log;
}
</code></pre> 
<p>创建并启动 nginx 容器</p> 
<pre><code>docker run --name nginx -p 80:80 -d -v /docker/www:/www -v /docker/nginx/conf.d:/etc/nginx/conf.d nginx
</code></pre> 
<p>-v /docker/www:/www 把宿主机的源码目录 /docker/www 挂载到容器内的 /www 目录。容器内访问 /www 就相当于访问 /docker/www<br> -v /docker/nginx/conf.d:/etc/nginx/conf.d 把宿主机的配置目录，挂载到容器内nginx的配置目录。nginx 会自动去加载这目录内所有的配置文件。/opt/docker/nginx/conf.d 里建议每个站点对应一个配置文件。</p> 
<h4><a id="_127"></a>六、验证</h4> 
<p>1、<code>docker ps -a</code> 看是否运行了刚才的两个容器</p> 
<p>2、<code>/docker/www/01_siyucms_com</code> 目录里上传ThinkPHP的最新代码</p> 
<p>3、访问你的域名或IP看是否可以访问。注意我绑定了三个域名，localhost可以让我通过ip直接访问到</p> 
<h4><a id="mysql_135"></a>七、链接宿主机mysql</h4> 
<p>只需要注意ip不是127.0.0.1就可以了，ip为172.17.0.1</p> 
<p>感兴趣的可以了解另一篇文章</p> 
<p>《Docker容器的程序连接宿主机的MySQL》</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/04c8356bd7d988ee85c4bd88999726d6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">AI绘画 | stable-diffusion的模型简介和下载使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d6c580e74640710de077f0e318baa74d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">建表时如何合理选择字段类型</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>