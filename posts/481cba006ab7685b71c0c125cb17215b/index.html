<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>lotus中编辑器代码 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="lotus中编辑器代码" />
<meta property="og:description" content="lotus中编辑器：
（1）。在前台表单中代码：
&lt;script type=&#34;text/javascript&#34;&gt;
var editor;
KindEditor.ready(function(K)
{
editor = K.create(&#39;#ZW&#39;);
});
&lt;/script&gt;
[&lt;div&gt; / 此处为富文本域/ &lt;/div&gt;]
（2）。在表单OnSubmit中添加 “editor.sync();” 命令。
（3）。在表单Head首页内容中 导入js：&lt;script type=\&#34;text/javascript\&#34; charset=\&#34;utf-8\&#34; src=\&#34;/kindeditor-4.1.1/kindeditor.js\&#34;&gt;&lt;/script&gt;
&lt;script type=\&#34;text/javascript\&#34; charset=\&#34;utf-8\&#34; src=\&#34;/kindeditor-4.1.1/lang/zh_CN.js\&#34;&gt;&lt;/script&gt;
（4）。编辑器中kindeditor.js代码
/******************************************************************************* * KindEditor - WYSIWYG HTML Editor for Internet * Copyright (C) 2006-2012 kindsoft.net * * @author Roddy &lt;luolonghao@gmail.com&gt; * @website http://www.kindsoft.net/ * @licence http://www.kindsoft.net/license.php * @version 4.1.1 (2012-06-10) *******************************************************************************/ (function (window, undefined) { if (window.KindEditor) { return; } if (!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/481cba006ab7685b71c0c125cb17215b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2012-08-06T16:02:03+08:00" />
<meta property="article:modified_time" content="2012-08-06T16:02:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">lotus中编辑器代码</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>lotus中编辑器：</p> 
<p><span style="color:#ff0000">（1）。在前台表单中代码：</span></p> 
<p>           &lt;script type="text/javascript"&gt;<br>                    var editor;<br>                    KindEditor.ready(function(K)<br>                       {<!-- --><br>                            editor = K.create('#ZW');<br>                        });<br>           &lt;/script&gt;<br>                 <br>            [&lt;div&gt;  / 此处为富文本域/ &lt;/div&gt;]</p> 
<p><br> </p> 
<p><span style="color:#ff0000">（2）。在表单OnSubmit中添加 “editor.sync();” 命令。</span></p> 
<p><span style="color:#ff0000">（3）。在表单Head首页内容中 导入js</span>：&lt;script type=\"text/javascript\" charset=\"utf-8\" src=\"/kindeditor-4.1.1/kindeditor.js\"&gt;&lt;/script&gt;</p> 
<p>                                                                         &lt;script type=\"text/javascript\" charset=\"utf-8\" src=\"/kindeditor-4.1.1/lang/zh_CN.js\"&gt;&lt;/script&gt;<br> </p> 
<p><br> </p> 
<p><span style="color:#ff0000">（4）。编辑器中kindeditor.js代码</span><br> </p>  /******************************************************************************* 
<br> * KindEditor - WYSIWYG HTML Editor for Internet 
<br> * Copyright (C) 2006-2012 kindsoft.net 
<br> * 
<br> * @author Roddy &lt;luolonghao@gmail.com&gt; 
<br> * @website http://www.kindsoft.net/ 
<br> * @licence http://www.kindsoft.net/license.php 
<br> * @version 4.1.1 (2012-06-10) 
<br> *******************************************************************************/ 
<br> (function (window, undefined) { 
<br>     if (window.KindEditor) { 
<br>         return; 
<br>     } 
<br> if (!window.console) { 
<br>     window.console = {}; 
<br> } 
<br> if (!console.log) { 
<br>     console.log = function () {}; 
<br> } 
<br> var _VERSION = '4.1.1 (2012-06-10)', 
<br>     _ua = navigator.userAgent.toLowerCase(), 
<br>     _IE = _ua.indexOf('msie') &gt; -1 &amp;&amp; _ua.indexOf('opera') == -1, 
<br>     _GECKO = _ua.indexOf('gecko') &gt; -1 &amp;&amp; _ua.indexOf('khtml') == -1, 
<br>     _WEBKIT = _ua.indexOf('applewebkit') &gt; -1, 
<br>     _OPERA = _ua.indexOf('opera') &gt; -1, 
<br>     _MOBILE = _ua.indexOf('mobile') &gt; -1, 
<br>     _IOS = /ipad|iphone|ipod/.test(_ua), 
<br>     _QUIRKS = document.compatMode != 'CSS1Compat', 
<br>     _matches = /(?:msie|firefox|webkit|opera)[\/:\s](\d+)/.exec(_ua), 
<br>     _V = _matches ? _matches[1] : '0', 
<br>     _TIME = new Date().getTime(); 
<br> function _isArray(val) { 
<br>     if (!val) { 
<br>         return false; 
<br>     } 
<br>     return Object.prototype.toString.call(val) === '[object Array]'; 
<br> } 
<br> function _isFunction(val) { 
<br>     if (!val) { 
<br>         return false; 
<br>     } 
<br>     return Object.prototype.toString.call(val) === '[object Function]'; 
<br> } 
<br> function _inArray(val, arr) { 
<br>     for (var i = 0, len = arr.length; i &lt; len; i++) { 
<br>         if (val === arr[i]) { 
<br>             return i; 
<br>         } 
<br>     } 
<br>     return -1; 
<br> } 
<br> function _each(obj, fn) { 
<br>     if (_isArray(obj)) { 
<br>         for (var i = 0, len = obj.length; i &lt; len; i++) { 
<br>             if (fn.call(obj[i], i, obj[i]) === false) { 
<br>                 break; 
<br>             } 
<br>         } 
<br>     } else { 
<br>         for (var key in obj) { 
<br>             if (obj.hasOwnProperty(key)) { 
<br>                 if (fn.call(obj[key], key, obj[key]) === false) { 
<br>                     break; 
<br>                 } 
<br>             } 
<br>         } 
<br>     } 
<br> } 
<br> function _trim(str) { 
<br>     return str.replace(/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g, ''); 
<br> } 
<br> function _inString(val, str, delimiter) { 
<br>     delimiter = delimiter === undefined ? ',' : delimiter; 
<br>     return (delimiter + str + delimiter).indexOf(delimiter + val + delimiter) &gt;= 0; 
<br> } 
<br> function _addUnit(val, unit) { 
<br>     unit = unit || 'px'; 
<br>     return val &amp;&amp; /^\d+$/.test(val) ? val + 'px' : val; 
<br> } 
<br> function _removeUnit(val) { 
<br>     var match; 
<br>     return val &amp;&amp; (match = /(\d+)/.exec(val)) ? parseInt(match[1], 10) : 0; 
<br> } 
<br> function _escape(val) { 
<br>     return val.replace(/&amp;/g, '&amp;amp;').replace(/&lt;/g, '&amp;lt;').replace(/&gt;/g, '&amp;gt;').replace(/"/g, '&amp;quot;'); 
<br> } 
<br> function _unescape(val) { 
<br>     return val.replace(/&amp;lt;/g, '&lt;').replace(/&amp;gt;/g, '&gt;').replace(/&amp;quot;/g, '"').replace(/&amp;amp;/g, '&amp;'); 
<br> } 
<br> function _toCamel(str) { 
<br>     var arr = str.split('-'); 
<br>     str = ''; 
<br>     _each(arr, function(key, val) { 
<br>         str += (key &gt; 0) ? val.charAt(0).toUpperCase() + val.substr(1) : val; 
<br>     }); 
<br>     return str; 
<br> } 
<br> function _toHex(val) { 
<br>     function hex(d) { 
<br>         var s = parseInt(d, 10).toString(16).toUpperCase(); 
<br>         return s.length &gt; 1 ? s : '0' + s; 
<br>     } 
<br>     return val.replace(/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/ig, 
<br>         function($0, $1, $2, $3) { 
<br>             return '#' + hex($1) + hex($2) + hex($3); 
<br>         } 
<br>     ); 
<br> } 
<br> function _toMap(val, delimiter) { 
<br>     delimiter = delimiter === undefined ? ',' : delimiter; 
<br>     var map = {}, arr = _isArray(val) ? val : val.split(delimiter), match; 
<br>     _each(arr, function(key, val) { 
<br>         if ((match = /^(\d+)\.\.(\d+)$/.exec(val))) { 
<br>             for (var i = parseInt(match[1], 10); i &lt;= parseInt(match[2], 10); i++) { 
<br>                 map[i.toString()] = true; 
<br>             } 
<br>         } else { 
<br>             map[val] = true; 
<br>         } 
<br>     }); 
<br>     return map; 
<br> } 
<br> function _toArray(obj, offset) { 
<br>     return Array.prototype.slice.call(obj, offset || 0); 
<br> } 
<br> function _undef(val, defaultVal) { 
<br>     return val === undefined ? defaultVal : val; 
<br> } 
<br> function _invalidUrl(url) { 
<br>     return !url || /[&lt;&gt;"]/.test(url); 
<br> } 
<br> function _addParam(url, param) { 
<br>     return url.indexOf('?') &gt;= 0 ? url + '&amp;' + param : url + '?' + param; 
<br> } 
<br> function _extend(child, parent, proto) { 
<br>     if (!proto) { 
<br>         proto = parent; 
<br>         parent = null; 
<br>     } 
<br>     var childProto; 
<br>     if (parent) { 
<br>         var fn = function () {}; 
<br>         fn.prototype = parent.prototype; 
<br>         childProto = new fn(); 
<br>         _each(proto, function(key, val) { 
<br>             childProto[key] = val; 
<br>         }); 
<br>     } else { 
<br>         childProto = proto; 
<br>     } 
<br>     childProto.constructor = child; 
<br>     child.prototype = childProto; 
<br>     child.parent = parent ? parent.prototype : null; 
<br> } 
<br> function _json(text) { 
<br>     var match; 
<br>     if ((match = /\{[\s\S]*\}|\[[\s\S]*\]/.exec(text))) { 
<br>         text = match[0]; 
<br>     } 
<br>     var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g; 
<br>     cx.lastIndex = 0; 
<br>     if (cx.test(text)) { 
<br>         text = text.replace(cx, function (a) { 
<br>             return '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4); 
<br>         }); 
<br>     } 
<br>     if (/^[\],:{}\s]*$/. 
<br>     test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@'). 
<br>     replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']'). 
<br>     replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) { 
<br>         return eval('(' + text + ')'); 
<br>     } 
<br>     throw 'JSON parse error'; 
<br> } 
<br> var _round = Math.round; 
<br> var K = { 
<br>     DEBUG : false, 
<br>     VERSION : _VERSION, 
<br>     IE : _IE, 
<br>     GECKO : _GECKO, 
<br>     WEBKIT : _WEBKIT, 
<br>     OPERA : _OPERA, 
<br>     V : _V, 
<br>     TIME : _TIME, 
<br>     each : _each, 
<br>     isArray : _isArray, 
<br>     isFunction : _isFunction, 
<br>     inArray : _inArray, 
<br>     inString : _inString, 
<br>     trim : _trim, 
<br>     addUnit : _addUnit, 
<br>     removeUnit : _removeUnit, 
<br>     escape : _escape, 
<br>     unescape : _unescape, 
<br>     toCamel : _toCamel, 
<br>     toHex : _toHex, 
<br>     toMap : _toMap, 
<br>     toArray : _toArray, 
<br>     undef : _undef, 
<br>     invalidUrl : _invalidUrl, 
<br>     addParam : _addParam, 
<br>     extend : _extend, 
<br>     json : _json 
<br> }; 
<br> var _INLINE_TAG_MAP = _toMap('a,abbr,acronym,b,basefont,bdo,big,br,button,cite,code,del,dfn,em,font,i,img,input,ins,kbd,label,map,q,s,samp,select,small,span,strike,strong,sub,sup,textarea,tt,u,var'), 
<br>     _BLOCK_TAG_MAP = _toMap('address,applet,blockquote,body,center,dd,dir,div,dl,dt,fieldset,form,frameset,h1,h2,h3,h4,h5,h6,head,hr,html,iframe,ins,isindex,li,map,menu,meta,noframes,noscript,object,ol,p,pre,script,style,table,tbody,td,tfoot,th,thead,title,tr,ul'), 
<br>     _SINGLE_TAG_MAP = _toMap('area,base,basefont,br,col,frame,hr,img,input,isindex,link,meta,param,embed'), 
<br>     _STYLE_TAG_MAP = _toMap('b,basefont,big,del,em,font,i,s,small,span,strike,strong,sub,sup,u'), 
<br>     _CONTROL_TAG_MAP = _toMap('img,table,input,textarea,button'), 
<br>     _PRE_TAG_MAP = _toMap('pre,style,script'), 
<br>     _NOSPLIT_TAG_MAP = _toMap('html,head,body,td,tr,table,ol,ul,li'), 
<br>     _AUTOCLOSE_TAG_MAP = _toMap('colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr'), 
<br>     _FILL_ATTR_MAP = _toMap('checked,compact,declare,defer,disabled,ismap,multiple,nohref,noresize,noshade,nowrap,readonly,selected'), 
<br>     _VALUE_TAG_MAP = _toMap('input,button,textarea,select'); 
<br> function _getBasePath() { 
<br>     var els = document.getElementsByTagName('script'), src; 
<br>     for (var i = 0, len = els.length; i &lt; len; i++) { 
<br>         src = els[i].src || ''; 
<br>         if (/kindeditor[\w\-\.]*\.js/.test(src)) { 
<br>             return src.substring(0, src.lastIndexOf('/') + 1); 
<br>         } 
<br>     } 
<br>     return ''; 
<br> } 
<br> K.basePath = _getBasePath(); 
<br> K.options = { 
<br>     designMode : true, 
<br>     fullscreenMode : false, 
<br>     filterMode : true, 
<br>     wellFormatMode : true, 
<br>     shadowMode : true, 
<br>     loadStyleMode : true, 
<br>     basePath : K.basePath, 
<br>     themesPath : K.basePath + 'themes/', 
<br>     langPath : K.basePath + 'lang/', 
<br>     pluginsPath : K.basePath + 'plugins/', 
<br>     themeType : 'default', 
<br>     langType : 'zh_CN', 
<br>     urlType : '', 
<br>     newlineTag : 'p', 
<br>     resizeType : 2, 
<br>     syncType : 'form', 
<br>     pasteType : 2, 
<br>     dialogAlignType : 'page', 
<br>     useContextmenu : true, 
<br>     fullscreenShortcut : true, 
<br>     bodyClass : 'ke-content', 
<br>     indentChar : '\t', 
<br>     cssPath : '', 
<br>     cssData : '', 
<br>     minWidth : 650, 
<br>     minHeight : 100, 
<br>     minChangeSize : 5, 
<br>     items : [ 
<br>         'source', '|', 'undo', 'redo', '|', 'preview', 'print', 'template', 'code', 'cut', 'copy', 'paste', 
<br>         'plainpaste', 'wordpaste', '|', 'justifyleft', 'justifycenter', 'justifyright', 
<br>         'justifyfull', 'insertorderedlist', 'insertunorderedlist', 'indent', 'outdent', 'subscript', 
<br>         'superscript', 'clearhtml', 'quickformat', 'selectall', '|', 'fullscreen', '/', 
<br>         'formatblock', 'fontname', 'fontsize', '|', 'forecolor', 'hilitecolor', 'bold', 
<br>         'italic', 'underline', 'strikethrough', 'lineheight', 'removeformat', '|', 'image', 'multiimage', 
<br>         'flash', 'media', 'insertfile', 'table', 'hr', 'emoticons', 'baidumap', 'pagebreak', 
<br>         'anchor', 'link', 'unlink', '|', 'about' 
<br>     ], 
<br>     noDisableItems : ['source', 'fullscreen'], 
<br>     colorTable : [ 
<br>         ['#E53333', '#E56600', '#FF9900', '#64451D', '#DFC5A4', '#FFE500'], 
<br>         ['#009900', '#006600', '#99BB00', '#B8D100', '#60D978', '#00D5FF'], 
<br>         ['#337FE5', '#003399', '#4C33E5', '#9933E5', '#CC33E5', '#EE33EE'], 
<br>         ['#FFFFFF', '#CCCCCC', '#999999', '#666666', '#333333', '#000000'] 
<br>     ], 
<br>     fontSizeTable : ['9px', '10px', '12px', '14px', '16px', '18px', '24px', '32px'], 
<br>     htmlTags : { 
<br>         font : ['color', 'size', 'face', '.background-color'], 
<br>         span : [ 
<br>             '.color', '.background-color', '.font-size', '.font-family', '.background', 
<br>             '.font-weight', '.font-style', '.text-decoration', '.vertical-align', '.line-height' 
<br>         ], 
<br>         div : [ 
<br>             'align', '.border', '.margin', '.padding', '.text-align', '.color', 
<br>             '.background-color', '.font-size', '.font-family', '.font-weight', '.background', 
<br>             '.font-style', '.text-decoration', '.vertical-align', '.margin-left' 
<br>         ], 
<br>         table: [ 
<br>             'border', 'cellspacing', 'cellpadding', 'width', 'height', 'align', 'bordercolor', 
<br>             '.padding', '.margin', '.border', 'bgcolor', '.text-align', '.color', '.background-color', 
<br>             '.font-size', '.font-family', '.font-weight', '.font-style', '.text-decoration', '.background', 
<br>             '.width', '.height', '.border-collapse' 
<br>         ], 
<br>         'td,th': [ 
<br>             'align', 'valign', 'width', 'height', 'colspan', 'rowspan', 'bgcolor', 
<br>             '.text-align', '.color', '.background-color', '.font-size', '.font-family', '.font-weight', 
<br>             '.font-style', '.text-decoration', '.vertical-align', '.background', '.border' 
<br>         ], 
<br>         a : ['href', 'target', 'name'], 
<br>         embed : ['src', 'width', 'height', 'type', 'loop', 'autostart', 'quality', '.width', '.height', 'align', 'allowscriptaccess'], 
<br>         img : ['src', 'width', 'height', 'border', 'alt', 'title', 'align', '.width', '.height', '.border'], 
<br>         'p,ol,ul,li,blockquote,h1,h2,h3,h4,h5,h6' : [ 
<br>             'align', '.text-align', '.color', '.background-color', '.font-size', '.font-family', '.background', 
<br>             '.font-weight', '.font-style', '.text-decoration', '.vertical-align', '.text-indent', '.margin-left' 
<br>         ], 
<br>         pre : ['class'], 
<br>         hr : ['class', '.page-break-after'], 
<br>         'br,tbody,tr,strong,b,sub,sup,em,i,u,strike,s,del' : [] 
<br>     }, 
<br>     layout : '&lt;div class="container"&gt;&lt;div class="toolbar"&gt;&lt;/div&gt;&lt;div class="edit"&gt;&lt;/div&gt;&lt;div class="statusbar"&gt;&lt;/div&gt;&lt;/div&gt;' 
<br> }; 
<br> var _useCapture = false; 
<br> var _INPUT_KEY_MAP = _toMap('8,9,13,32,46,48..57,59,61,65..90,106,109..111,188,190..192,219..222'); 
<br> var _CURSORMOVE_KEY_MAP = _toMap('33..40'); 
<br> var _CHANGE_KEY_MAP = {}; 
<br> _each(_INPUT_KEY_MAP, function(key, val) { 
<br>     _CHANGE_KEY_MAP[key] = val; 
<br> }); 
<br> _each(_CURSORMOVE_KEY_MAP, function(key, val) { 
<br>     _CHANGE_KEY_MAP[key] = val; 
<br> }); 
<br> function _bindEvent(el, type, fn) { 
<br>     if (el.addEventListener){ 
<br>         el.addEventListener(type, fn, _useCapture); 
<br>     } else if (el.attachEvent){ 
<br>         el.attachEvent('on' + type, fn); 
<br>     } 
<br> } 
<br> function _unbindEvent(el, type, fn) { 
<br>     if (el.removeEventListener){ 
<br>         el.removeEventListener(type, fn, _useCapture); 
<br>     } else if (el.detachEvent){ 
<br>         el.detachEvent('on' + type, fn); 
<br>     } 
<br> } 
<br> var _EVENT_PROPS = ('altKey,attrChange,attrName,bubbles,button,cancelable,charCode,clientX,clientY,ctrlKey,currentTarget,' + 
<br>     'data,detail,eventPhase,fromElement,handler,keyCode,metaKey,newValue,offsetX,offsetY,originalTarget,pageX,' + 
<br>     'pageY,prevValue,relatedNode,relatedTarget,screenX,screenY,shiftKey,srcElement,target,toElement,view,wheelDelta,which').split(','); 
<br> function KEvent(el, event) { 
<br>     this.init(el, event); 
<br> } 
<br> _extend(KEvent, { 
<br>     init : function(el, event) { 
<br>         var self = this, doc = el.ownerDocument || el.document || el; 
<br>         self.event = event; 
<br>         _each(_EVENT_PROPS, function(key, val) { 
<br>             self[val] = event[val]; 
<br>         }); 
<br>         if (!self.target) { 
<br>             self.target = self.srcElement || doc; 
<br>         } 
<br>         if (self.target.nodeType === 3) { 
<br>             self.target = self.target.parentNode; 
<br>         } 
<br>         if (!self.relatedTarget &amp;&amp; self.fromElement) { 
<br>             self.relatedTarget = self.fromElement === self.target ? self.toElement : self.fromElement; 
<br>         } 
<br>         if (self.pageX == null &amp;&amp; self.clientX != null) { 
<br>             var d = doc.documentElement, body = doc.body; 
<br>             self.pageX = self.clientX + (d &amp;&amp; d.scrollLeft || body &amp;&amp; body.scrollLeft || 0) - (d &amp;&amp; d.clientLeft || body &amp;&amp; body.clientLeft || 0); 
<br>             self.pageY = self.clientY + (d &amp;&amp; d.scrollTop  || body &amp;&amp; body.scrollTop  || 0) - (d &amp;&amp; d.clientTop  || body &amp;&amp; body.clientTop  || 0); 
<br>         } 
<br>         if (!self.which &amp;&amp; ((self.charCode || self.charCode === 0) ? self.charCode : self.keyCode)) { 
<br>             self.which = self.charCode || self.keyCode; 
<br>         } 
<br>         if (!self.metaKey &amp;&amp; self.ctrlKey) { 
<br>             self.metaKey = self.ctrlKey; 
<br>         } 
<br>         if (!self.which &amp;&amp; self.button !== undefined) { 
<br>             self.which = (self.button &amp; 1 ? 1 : (self.button &amp; 2 ? 3 : (self.button &amp; 4 ? 2 : 0))); 
<br>         } 
<br>         switch (self.which) { 
<br>         case 186 : 
<br>             self.which = 59; 
<br>             break; 
<br>         case 187 : 
<br>         case 107 : 
<br>         case 43 : 
<br>             self.which = 61; 
<br>             break; 
<br>         case 189 : 
<br>         case 45 : 
<br>             self.which = 109; 
<br>             break; 
<br>         case 42 : 
<br>             self.which = 106; 
<br>             break; 
<br>         case 47 : 
<br>             self.which = 111; 
<br>             break; 
<br>         case 78 : 
<br>             self.which = 110; 
<br>             break; 
<br>         } 
<br>         if (self.which &gt;= 96 &amp;&amp; self.which &lt;= 105) { 
<br>             self.which -= 48; 
<br>         } 
<br>     }, 
<br>     preventDefault : function() { 
<br>         var ev = this.event; 
<br>         if (ev.preventDefault) { 
<br>             ev.preventDefault(); 
<br>         } 
<br>         ev.returnValue = false; 
<br>     }, 
<br>     stopPropagation : function() { 
<br>         var ev = this.event; 
<br>         if (ev.stopPropagation) { 
<br>             ev.stopPropagation(); 
<br>         } 
<br>         ev.cancelBubble = true; 
<br>     }, 
<br>     stop : function() { 
<br>         this.preventDefault(); 
<br>         this.stopPropagation(); 
<br>     } 
<br> }); 
<br> var _eventExpendo = 'kindeditor_' + _TIME, _eventId = 0, _eventData = {}; 
<br> function _getId(el) { 
<br>     return el[_eventExpendo] || null; 
<br> } 
<br> function _setId(el) { 
<br>     el[_eventExpendo] = ++_eventId; 
<br>     return _eventId; 
<br> } 
<br> function _removeId(el) { 
<br>     try { 
<br>         delete el[_eventExpendo]; 
<br>     } catch(e) { 
<br>         if (el.removeAttribute) { 
<br>             el.removeAttribute(_eventExpendo); 
<br>         } 
<br>     } 
<br> } 
<br> function _bind(el, type, fn) { 
<br>     if (type.indexOf(',') &gt;= 0) { 
<br>         _each(type.split(','), function() { 
<br>             _bind(el, this, fn); 
<br>         }); 
<br>         return; 
<br>     } 
<br>     var id = _getId(el); 
<br>     if (!id) { 
<br>         id = _setId(el); 
<br>     } 
<br>     if (_eventData[id] === undefined) { 
<br>         _eventData[id] = {}; 
<br>     } 
<br>     var events = _eventData[id][type]; 
<br>     if (events &amp;&amp; events.length &gt; 0) { 
<br>         _unbindEvent(el, type, events[0]); 
<br>     } else { 
<br>         _eventData[id][type] = []; 
<br>         _eventData[id].el = el; 
<br>     } 
<br>     events = _eventData[id][type]; 
<br>     if (events.length === 0) { 
<br>         events[0] = function(e) { 
<br>             var kevent = e ? new KEvent(el, e) : undefined; 
<br>             _each(events, function(i, event) { 
<br>                 if (i &gt; 0 &amp;&amp; event) { 
<br>                     event.call(el, kevent); 
<br>                 } 
<br>             }); 
<br>         }; 
<br>     } 
<br>     if (_inArray(fn, events) &lt; 0) { 
<br>         events.push(fn); 
<br>     } 
<br>     _bindEvent(el, type, events[0]); 
<br> } 
<br> function _unbind(el, type, fn) { 
<br>     if (type &amp;&amp; type.indexOf(',') &gt;= 0) { 
<br>         _each(type.split(','), function() { 
<br>             _unbind(el, this, fn); 
<br>         }); 
<br>         return; 
<br>     } 
<br>     var id = _getId(el); 
<br>     if (!id) { 
<br>         return; 
<br>     } 
<br>     if (type === undefined) { 
<br>         if (id in _eventData) { 
<br>             _each(_eventData[id], function(key, events) { 
<br>                 if (key != 'el' &amp;&amp; events.length &gt; 0) { 
<br>                     _unbindEvent(el, key, events[0]); 
<br>                 } 
<br>             }); 
<br>             delete _eventData[id]; 
<br>             _removeId(el); 
<br>         } 
<br>         return; 
<br>     } 
<br>     if (!_eventData[id]) { 
<br>         return; 
<br>     } 
<br>     var events = _eventData[id][type]; 
<br>     if (events &amp;&amp; events.length &gt; 0) { 
<br>         if (fn === undefined) { 
<br>             _unbindEvent(el, type, events[0]); 
<br>             delete _eventData[id][type]; 
<br>         } else { 
<br>             _each(events, function(i, event) { 
<br>                 if (i &gt; 0 &amp;&amp; event === fn) { 
<br>                     events.splice(i, 1); 
<br>                 } 
<br>             }); 
<br>             if (events.length == 1) { 
<br>                 _unbindEvent(el, type, events[0]); 
<br>                 delete _eventData[id][type]; 
<br>             } 
<br>         } 
<br>         var count = 0; 
<br>         _each(_eventData[id], function() { 
<br>             count++; 
<br>         }); 
<br>         if (count &lt; 2) { 
<br>             delete _eventData[id]; 
<br>             _removeId(el); 
<br>         } 
<br>     } 
<br> } 
<br> function _fire(el, type) { 
<br>     if (type.indexOf(',') &gt;= 0) { 
<br>         _each(type.split(','), function() { 
<br>             _fire(el, this); 
<br>         }); 
<br>         return; 
<br>     } 
<br>     var id = _getId(el); 
<br>     if (!id) { 
<br>         return; 
<br>     } 
<br>     var events = _eventData[id][type]; 
<br>     if (_eventData[id] &amp;&amp; events &amp;&amp; events.length &gt; 0) { 
<br>         events[0](); 
<br>     } 
<br> } 
<br> function _ctrl(el, key, fn) { 
<br>     var self = this; 
<br>     key = /^\d{2,}$/.test(key) ? key : key.toUpperCase().charCodeAt(0); 
<br>     _bind(el, 'keydown', function(e) { 
<br>         if (e.ctrlKey &amp;&amp; e.which == key &amp;&amp; !e.shiftKey &amp;&amp; !e.altKey) { 
<br>             fn.call(el); 
<br>             e.stop(); 
<br>         } 
<br>     }); 
<br> } 
<br> function _ready(fn) { 
<br>     var loaded = false; 
<br>     function readyFunc() { 
<br>         if (!loaded) { 
<br>             loaded = true; 
<br>             fn(KindEditor); 
<br>         } 
<br>     } 
<br>     function ieReadyFunc() { 
<br>         if (!loaded) { 
<br>             try { 
<br>                 document.documentElement.doScroll('left'); 
<br>             } catch(e) { 
<br>                 setTimeout(ieReadyFunc, 100); 
<br>                 return; 
<br>             } 
<br>             readyFunc(); 
<br>         } 
<br>     } 
<br>     function ieReadyStateFunc() { 
<br>         if (document.readyState === 'complete') { 
<br>             readyFunc(); 
<br>         } 
<br>     } 
<br>     if (document.addEventListener) { 
<br>         _bind(document, 'DOMContentLoaded', readyFunc); 
<br>     } else if (document.attachEvent) { 
<br>         _bind(document, 'readystatechange', ieReadyStateFunc); 
<br>         var toplevel = false; 
<br>         try { 
<br>             toplevel = window.frameElement == null; 
<br>         } catch(e) {} 
<br>         if (document.documentElement.doScroll &amp;&amp; toplevel) { 
<br>             ieReadyFunc(); 
<br>         } 
<br>     } 
<br>     _bind(window, 'load', readyFunc); 
<br> } 
<br> if (_IE) { 
<br>     window.attachEvent('onunload', function() { 
<br>         _each(_eventData, function(key, events) { 
<br>             if (events.el) { 
<br>                 _unbind(events.el); 
<br>             } 
<br>         }); 
<br>     }); 
<br> } 
<br> K.ctrl = _ctrl; 
<br> K.ready = _ready; 
<br> function _getCssList(css) { 
<br>     var list = {}, 
<br>         reg = /\s*([\w\-]+)\s*:([^;]*)(;|$)/g, 
<br>         match; 
<br>     while ((match = reg.exec(css))) { 
<br>         var key = _trim(match[1].toLowerCase()), 
<br>             val = _trim(_toHex(match[2])); 
<br>         list[key] = val; 
<br>     } 
<br>     return list; 
<br> } 
<br> function _getAttrList(tag) { 
<br>     var list = {}, 
<br>         reg = /\s+(?:([\w\-:]+)|(?:([\w\-:]+)=([^\s"'&lt;&gt;]+))|(?:([\w\-:"]+)="([^"]*)")|(?:([\w\-:"]+)='([^']*)'))(?=(?:\s|\/|&gt;)+)/g, 
<br>         match; 
<br>     while ((match = reg.exec(tag))) { 
<br>         var key = (match[1] || match[2] || match[4] || match[6]).toLowerCase(), 
<br>             val = (match[2] ? match[3] : (match[4] ? match[5] : match[7])) || ''; 
<br>         list[key] = val; 
<br>     } 
<br>     return list; 
<br> } 
<br> function _addClassToTag(tag, className) { 
<br>     if (/\s+class\s*=/.test(tag)) { 
<br>         tag = tag.replace(/(\s+class=["']?)([^"']*)(["']?[\s&gt;])/, function($0, $1, $2, $3) { 
<br>             if ((' ' + $2 + ' ').indexOf(' ' + className + ' ') &lt; 0) { 
<br>                 return $2 === '' ? $1 + className + $3 : $1 + $2 + ' ' + className + $3; 
<br>             } else { 
<br>                 return $0; 
<br>             } 
<br>         }); 
<br>     } else { 
<br>         tag = tag.substr(0, tag.length - 1) + ' class="' + className + '"&gt;'; 
<br>     } 
<br>     return tag; 
<br> } 
<br> function _formatCss(css) { 
<br>     var str = ''; 
<br>     _each(_getCssList(css), function(key, val) { 
<br>         str += key + ':' + val + ';'; 
<br>     }); 
<br>     return str; 
<br> } 
<br> function _formatUrl(url, mode, host, pathname) { 
<br>     mode = _undef(mode, '').toLowerCase(); 
<br>     url = url.replace(/([^:])\/\//g, '$1/'); 
<br>     if (_inArray(mode, ['absolute', 'relative', 'domain']) &lt; 0) { 
<br>         return url; 
<br>     } 
<br>     host = host || location.protocol + '//' + location.host; 
<br>     if (pathname === undefined) { 
<br>         var m = location.pathname.match(/^(\/.*)\//); 
<br>         pathname = m ? m[1] : ''; 
<br>     } 
<br>     var match; 
<br>     if ((match = /^(\w+:\/\/[^\/]*)/.exec(url))) { 
<br>         if (match[1] !== host) { 
<br>             return url; 
<br>         } 
<br>     } else if (/^\w+:/.test(url)) { 
<br>         return url; 
<br>     } 
<br>     function getRealPath(path) { 
<br>         var parts = path.split('/'), paths = []; 
<br>         for (var i = 0, len = parts.length; i &lt; len; i++) { 
<br>             var part = parts[i]; 
<br>             if (part == '..') { 
<br>                 if (paths.length &gt; 0) { 
<br>                     paths.pop(); 
<br>                 } 
<br>             } else if (part !== '' &amp;&amp; part != '.') { 
<br>                 paths.push(part); 
<br>             } 
<br>         } 
<br>         return '/' + paths.join('/'); 
<br>     } 
<br>     if (/^\//.test(url)) { 
<br>         url = host + getRealPath(url.substr(1)); 
<br>     } else if (!/^\w+:\/\//.test(url)) { 
<br>         url = host + getRealPath(pathname + '/' + url); 
<br>     } 
<br>     function getRelativePath(path, depth) { 
<br>         if (url.substr(0, path.length) === path) { 
<br>             var arr = []; 
<br>             for (var i = 0; i &lt; depth; i++) { 
<br>                 arr.push('..'); 
<br>             } 
<br>             var prefix = '.'; 
<br>             if (arr.length &gt; 0) { 
<br>                 prefix += '/' + arr.join('/'); 
<br>             } 
<br>             if (pathname == '/') { 
<br>                 prefix += '/'; 
<br>             } 
<br>             return prefix + url.substr(path.length); 
<br>         } else { 
<br>             if ((match = /^(.*)\//.exec(path))) { 
<br>                 return getRelativePath(match[1], ++depth); 
<br>             } 
<br>         } 
<br>     } 
<br>     if (mode === 'relative') { 
<br>         url = getRelativePath(host + pathname, 0).substr(2); 
<br>     } else if (mode === 'absolute') { 
<br>         if (url.substr(0, host.length) === host) { 
<br>             url = url.substr(host.length); 
<br>         } 
<br>     } 
<br>     return url; 
<br> } 
<br> function _formatHtml(html, htmlTags, urlType, wellFormatted, indentChar) { 
<br>     urlType = urlType || ''; 
<br>     wellFormatted = _undef(wellFormatted, false); 
<br>     indentChar = _undef(indentChar, '\t'); 
<br>     var fontSizeList = 'xx-small,x-small,small,medium,large,x-large,xx-large'.split(','); 
<br>     html = html.replace(/(&lt;(?:pre|pre\s[^&gt;]*)&gt;)([\s\S]*?)(&lt;\/pre&gt;)/ig, function($0, $1, $2, $3) { 
<br>         return $1 + $2.replace(/&lt;(?:br|br\s[^&gt;]*)&gt;/ig, '\n') + $3; 
<br>     }); 
<br>     html = html.replace(/&lt;(?:br|br\s[^&gt;]*)\s*\/?&gt;\s*&lt;\/p&gt;/ig, '&lt;/p&gt;'); 
<br>     html = html.replace(/(&lt;(?:p|p\s[^&gt;]*)&gt;)\s*(&lt;\/p&gt;)/ig, '$1&lt;br /&gt;$2'); 
<br>     html = html.replace(/\u200B/g, ''); 
<br>     var htmlTagMap = {}; 
<br>     if (htmlTags) { 
<br>         _each(htmlTags, function(key, val) { 
<br>             var arr = key.split(','); 
<br>             for (var i = 0, len = arr.length; i &lt; len; i++) { 
<br>                 htmlTagMap[arr[i]] = _toMap(val); 
<br>             } 
<br>         }); 
<br>         if (!htmlTagMap.script) { 
<br>             html = html.replace(/(&lt;(?:script|script\s[^&gt;]*)&gt;)([\s\S]*?)(&lt;\/script&gt;)/ig, ''); 
<br>         } 
<br>         if (!htmlTagMap.style) { 
<br>             html = html.replace(/(&lt;(?:style|style\s[^&gt;]*)&gt;)([\s\S]*?)(&lt;\/style&gt;)/ig, ''); 
<br>         } 
<br>     } 
<br>     var re = /([ \t\n\r]*)&lt;(\/)?([\w\-:]+)((?:\s+|(?:\s+[\w\-:]+)|(?:\s+[\w\-:]+=[^\s"'&lt;&gt;]+)|(?:\s+[\w\-:"]+="[^"]*")|(?:\s+[\w\-:"]+='[^']*'))*)(\/)?&gt;([ \t\n\r]*)/g; 
<br>     var tagStack = []; 
<br>     html = html.replace(re, function($0, $1, $2, $3, $4, $5, $6) { 
<br>         var full = $0, 
<br>             startNewline = $1 || '', 
<br>             startSlash = $2 || '', 
<br>             tagName = $3.toLowerCase(), 
<br>             attr = $4 || '', 
<br>             endSlash = $5 ? ' ' + $5 : '', 
<br>             endNewline = $6 || ''; 
<br>         if (htmlTags &amp;&amp; !htmlTagMap[tagName]) { 
<br>             return ''; 
<br>         } 
<br>         if (endSlash === '' &amp;&amp; _SINGLE_TAG_MAP[tagName]) { 
<br>             endSlash = ' /'; 
<br>         } 
<br>         if (_INLINE_TAG_MAP[tagName]) { 
<br>             if (startNewline) { 
<br>                 startNewline = ' '; 
<br>             } 
<br>             if (endNewline) { 
<br>                 endNewline = ' '; 
<br>             } 
<br>         } 
<br>         if (_PRE_TAG_MAP[tagName]) { 
<br>             if (startSlash) { 
<br>                 endNewline = '\n'; 
<br>             } else { 
<br>                 startNewline = '\n'; 
<br>             } 
<br>         } 
<br>         if (wellFormatted &amp;&amp; tagName == 'br') { 
<br>             endNewline = '\n'; 
<br>         } 
<br>         if (_BLOCK_TAG_MAP[tagName] &amp;&amp; !_PRE_TAG_MAP[tagName]) { 
<br>             if (wellFormatted) { 
<br>                 if (startSlash &amp;&amp; tagStack.length &gt; 0 &amp;&amp; tagStack[tagStack.length - 1] === tagName) { 
<br>                     tagStack.pop(); 
<br>                 } else { 
<br>                     tagStack.push(tagName); 
<br>                 } 
<br>                 startNewline = '\n'; 
<br>                 endNewline = '\n'; 
<br>                 for (var i = 0, len = startSlash ? tagStack.length : tagStack.length - 1; i &lt; len; i++) { 
<br>                     startNewline += indentChar; 
<br>                     if (!startSlash) { 
<br>                         endNewline += indentChar; 
<br>                     } 
<br>                 } 
<br>                 if (endSlash) { 
<br>                     tagStack.pop(); 
<br>                 } else if (!startSlash) { 
<br>                     endNewline += indentChar; 
<br>                 } 
<br>             } else { 
<br>                 startNewline = endNewline = ''; 
<br>             } 
<br>         } 
<br>         if (attr !== '') { 
<br>             var attrMap = _getAttrList(full); 
<br>             if (tagName === 'font') { 
<br>                 var fontStyleMap = {}, fontStyle = ''; 
<br>                 _each(attrMap, function(key, val) { 
<br>                     if (key === 'color') { 
<br>                         fontStyleMap.color = val; 
<br>                         delete attrMap[key]; 
<br>                     } 
<br>                     if (key === 'size') { 
<br>                         fontStyleMap['font-size'] = fontSizeList[parseInt(val, 10) - 1] || ''; 
<br>                         delete attrMap[key]; 
<br>                     } 
<br>                     if (key === 'face') { 
<br>                         fontStyleMap['font-family'] = val; 
<br>                         delete attrMap[key]; 
<br>                     } 
<br>                     if (key === 'style') { 
<br>                         fontStyle = val; 
<br>                     } 
<br>                 }); 
<br>                 if (fontStyle &amp;&amp; !/;$/.test(fontStyle)) { 
<br>                     fontStyle += ';'; 
<br>                 } 
<br>                 _each(fontStyleMap, function(key, val) { 
<br>                     if (val === '') { 
<br>                         return; 
<br>                     } 
<br>                     if (/\s/.test(val)) { 
<br>                         val = "'" + val + "'"; 
<br>                     } 
<br>                     fontStyle += key + ':' + val + ';'; 
<br>                 }); 
<br>                 attrMap.style = fontStyle; 
<br>             } 
<br>             _each(attrMap, function(key, val) { 
<br>                 if (_FILL_ATTR_MAP[key]) { 
<br>                     attrMap[key] = key; 
<br>                 } 
<br>                 if (_inArray(key, ['src', 'href']) &gt;= 0) { 
<br>                     attrMap[key] = _formatUrl(val, urlType); 
<br>                 } 
<br>                 if (htmlTags &amp;&amp; key !== 'style' &amp;&amp; !htmlTagMap[tagName]['*'] &amp;&amp; !htmlTagMap[tagName][key] || 
<br>                     tagName === 'body' &amp;&amp; key === 'contenteditable' || 
<br>                     /^kindeditor_\d+$/.test(key)) { 
<br>                     delete attrMap[key]; 
<br>                 } 
<br>                 if (key === 'style' &amp;&amp; val !== '') { 
<br>                     var styleMap = _getCssList(val); 
<br>                     _each(styleMap, function(k, v) { 
<br>                         if (htmlTags &amp;&amp; !htmlTagMap[tagName].style &amp;&amp; !htmlTagMap[tagName]['.' + k]) { 
<br>                             delete styleMap[k]; 
<br>                         } 
<br>                     }); 
<br>                     var style = ''; 
<br>                     _each(styleMap, function(k, v) { 
<br>                         style += k + ':' + v + ';'; 
<br>                     }); 
<br>                     attrMap.style = style; 
<br>                 } 
<br>             }); 
<br>             attr = ''; 
<br>             _each(attrMap, function(key, val) { 
<br>                 if (key === 'style' &amp;&amp; val === '') { 
<br>                     return; 
<br>                 } 
<br>                 val = val.replace(/"/g, '&amp;quot;'); 
<br>                 attr += ' ' + key + '="' + val + '"'; 
<br>             }); 
<br>         } 
<br>         if (tagName === 'font') { 
<br>             tagName = 'span'; 
<br>         } 
<br>         return startNewline + '&lt;' + startSlash + tagName + attr + endSlash + '&gt;' + endNewline; 
<br>     }); 
<br>     html = html.replace(/(&lt;(?:pre|pre\s[^&gt;]*)&gt;)([\s\S]*?)(&lt;\/pre&gt;)/ig, function($0, $1, $2, $3) { 
<br>         return $1 + $2.replace(/\n/g, '&lt;span id="__kindeditor_pre_newline__"&gt;\n') + $3; 
<br>     }); 
<br>     html = html.replace(/\n\s*\n/g, '\n'); 
<br>     html = html.replace(/&lt;span id="__kindeditor_pre_newline__"&gt;\n/g, '\n'); 
<br>     return _trim(html); 
<br> } 
<br> function _clearMsWord(html, htmlTags) { 
<br>     html = html.replace(/&lt;meta[\s\S]*?&gt;/ig, '') 
<br>         .replace(/&lt;![\s\S]*?&gt;/ig, '') 
<br>         .replace(/&lt;style[^&gt;]*&gt;[\s\S]*?&lt;\/style&gt;/ig, '') 
<br>         .replace(/&lt;script[^&gt;]*&gt;[\s\S]*?&lt;\/script&gt;/ig, '') 
<br>         .replace(/&lt;w:[^&gt;]+&gt;[\s\S]*?&lt;\/w:[^&gt;]+&gt;/ig, '') 
<br>         .replace(/&lt;o:[^&gt;]+&gt;[\s\S]*?&lt;\/o:[^&gt;]+&gt;/ig, '') 
<br>         .replace(/&lt;xml&gt;[\s\S]*?&lt;\/xml&gt;/ig, '') 
<br>         .replace(/&lt;(?:table|td)[^&gt;]*&gt;/ig, function(full) { 
<br>             return full.replace(/border-bottom:([#\w\s]+)/ig, 'border:$1'); 
<br>         }); 
<br>     return _formatHtml(html, htmlTags); 
<br> } 
<br> function _mediaType(src) { 
<br>     if (/\.(rm|rmvb)(\?|$)/i.test(src)) { 
<br>         return 'audio/x-pn-realaudio-plugin'; 
<br>     } 
<br>     if (/\.(swf|flv)(\?|$)/i.test(src)) { 
<br>         return 'application/x-shockwave-flash'; 
<br>     } 
<br>     return 'video/x-ms-asf-plugin'; 
<br> } 
<br> function _mediaClass(type) { 
<br>     if (/realaudio/i.test(type)) { 
<br>         return 'ke-rm'; 
<br>     } 
<br>     if (/flash/i.test(type)) { 
<br>         return 'ke-flash'; 
<br>     } 
<br>     return 'ke-media'; 
<br> } 
<br> function _mediaAttrs(srcTag) { 
<br>     return _getAttrList(unescape(srcTag)); 
<br> } 
<br> function _mediaEmbed(attrs) { 
<br>     var html = '&lt;embed '; 
<br>     _each(attrs, function(key, val) { 
<br>         html += key + '="' + val + '" '; 
<br>     }); 
<br>     html += '/&gt;'; 
<br>     return html; 
<br> } 
<br> function _mediaImg(blankPath, attrs) { 
<br>     var width = attrs.width, 
<br>         height = attrs.height, 
<br>         type = attrs.type || _mediaType(attrs.src), 
<br>         srcTag = _mediaEmbed(attrs), 
<br>         style = ''; 
<br>     if (width &gt; 0) { 
<br>         style += 'width:' + width + 'px;'; 
<br>     } 
<br>     if (height &gt; 0) { 
<br>         style += 'height:' + height + 'px;'; 
<br>     } 
<br>     var html = '&lt;img class="' + _mediaClass(type) + '" src="' + blankPath + '" '; 
<br>     if (style !== '') { 
<br>         html += 'style="' + style + '" '; 
<br>     } 
<br>     html += 'data-ke-tag="' + escape(srcTag) + '" alt="" /&gt;'; 
<br>     return html; 
<br> } 
<br> function _tmpl(str, data) { 
<br>     var fn = new Function("obj", 
<br>         "var p=[],print=function(){p.push.apply(p,arguments);};" + 
<br>         "with(obj){p.push('" + 
<br>         str.replace(/[\r\t\n]/g, " ") 
<br>             .split("&lt;%").join("\t") 
<br>             .replace(/((^|%&gt;)[^\t]*)'/g, "$1\r") 
<br>             .replace(/\t=(.*?)%&gt;/g, "',$1,'") 
<br>             .split("\t").join("');") 
<br>             .split("%&gt;").join("p.push('") 
<br>             .split("\r").join("\\'") + "');}return p.join('');"); 
<br>     return data ? fn(data) : fn; 
<br> } 
<br> K.formatUrl = _formatUrl; 
<br> K.formatHtml = _formatHtml; 
<br> K.getCssList = _getCssList; 
<br> K.getAttrList = _getAttrList; 
<br> K.mediaType = _mediaType; 
<br> K.mediaAttrs = _mediaAttrs; 
<br> K.mediaEmbed = _mediaEmbed; 
<br> K.mediaImg = _mediaImg; 
<br> K.clearMsWord = _clearMsWord; 
<br> K.tmpl = _tmpl; 
<br> function _contains(nodeA, nodeB) { 
<br>     if (nodeA.nodeType == 9 &amp;&amp; nodeB.nodeType != 9) { 
<br>         return true; 
<br>     } 
<br>     while ((nodeB = nodeB.parentNode)) { 
<br>         if (nodeB == nodeA) { 
<br>             return true; 
<br>         } 
<br>     } 
<br>     return false; 
<br> } 
<br> var _getSetAttrDiv = document.createElement('div'); 
<br> _getSetAttrDiv.setAttribute('className', 't'); 
<br> var _GET_SET_ATTRIBUTE = _getSetAttrDiv.className !== 't'; 
<br> function _getAttr(el, key) { 
<br>     key = key.toLowerCase(); 
<br>     var val = null; 
<br>     if (!_GET_SET_ATTRIBUTE &amp;&amp; el.nodeName.toLowerCase() != 'script') { 
<br>         var div = el.ownerDocument.createElement('div'); 
<br>         div.appendChild(el.cloneNode(false)); 
<br>         var list = _getAttrList(_unescape(div.innerHTML)); 
<br>         if (key in list) { 
<br>             val = list[key]; 
<br>         } 
<br>     } else { 
<br>         try { 
<br>             val = el.getAttribute(key, 2); 
<br>         } catch(e) { 
<br>             val = el.getAttribute(key, 1); 
<br>         } 
<br>     } 
<br>     if (key === 'style' &amp;&amp; val !== null) { 
<br>         val = _formatCss(val); 
<br>     } 
<br>     return val; 
<br> } 
<br> function _queryAll(expr, root) { 
<br>     var exprList = expr.split(','); 
<br>     if (exprList.length &gt; 1) { 
<br>         var mergedResults = []; 
<br>         _each(exprList, function() { 
<br>             _each(_queryAll(this, root), function() { 
<br>                 if (_inArray(this, mergedResults) &lt; 0) { 
<br>                     mergedResults.push(this); 
<br>                 } 
<br>             }); 
<br>         }); 
<br>         return mergedResults; 
<br>     } 
<br>     root = root || document; 
<br>     function escape(str) { 
<br>         if (typeof str != 'string') { 
<br>             return str; 
<br>         } 
<br>         return str.replace(/([^\w\-])/g, '\\$1'); 
<br>     } 
<br>     function stripslashes(str) { 
<br>         return str.replace(/\\/g, ''); 
<br>     } 
<br>     function cmpTag(tagA, tagB) { 
<br>         return tagA === '*' || tagA.toLowerCase() === escape(tagB.toLowerCase()); 
<br>     } 
<br>     function byId(id, tag, root) { 
<br>         var arr = [], 
<br>             doc = root.ownerDocument || root, 
<br>             el = doc.getElementById(stripslashes(id)); 
<br>         if (el) { 
<br>             if (cmpTag(tag, el.nodeName) &amp;&amp; _contains(root, el)) { 
<br>                 arr.push(el); 
<br>             } 
<br>         } 
<br>         return arr; 
<br>     } 
<br>     function byClass(className, tag, root) { 
<br>         var doc = root.ownerDocument || root, arr = [], els, i, len, el; 
<br>         if (root.getElementsByClassName) { 
<br>             els = root.getElementsByClassName(stripslashes(className)); 
<br>             for (i = 0, len = els.length; i &lt; len; i++) { 
<br>                 el = els[i]; 
<br>                 if (cmpTag(tag, el.nodeName)) { 
<br>                     arr.push(el); 
<br>                 } 
<br>             } 
<br>         } else if (doc.querySelectorAll) { 
<br>             els = doc.querySelectorAll((root.nodeName !== '#document' ? root.nodeName + ' ' : '') + tag + '.' + className); 
<br>             for (i = 0, len = els.length; i &lt; len; i++) { 
<br>                 el = els[i]; 
<br>                 if (_contains(root, el)) { 
<br>                     arr.push(el); 
<br>                 } 
<br>             } 
<br>         } else { 
<br>             els = root.getElementsByTagName(tag); 
<br>             className = ' ' + className + ' '; 
<br>             for (i = 0, len = els.length; i &lt; len; i++) { 
<br>                 el = els[i]; 
<br>                 if (el.nodeType == 1) { 
<br>                     var cls = el.className; 
<br>                     if (cls &amp;&amp; (' ' + cls + ' ').indexOf(className) &gt; -1) { 
<br>                         arr.push(el); 
<br>                     } 
<br>                 } 
<br>             } 
<br>         } 
<br>         return arr; 
<br>     } 
<br>     function byName(name, tag, root) { 
<br>         var arr = [], doc = root.ownerDocument || root, 
<br>             els = doc.getElementsByName(stripslashes(name)), el; 
<br>         for (var i = 0, len = els.length; i &lt; len; i++) { 
<br>             el = els[i]; 
<br>             if (cmpTag(tag, el.nodeName) &amp;&amp; _contains(root, el)) { 
<br>                 if (el.getAttributeNode('name')) { 
<br>                     arr.push(el); 
<br>                 } 
<br>             } 
<br>         } 
<br>         return arr; 
<br>     } 
<br>     function byAttr(key, val, tag, root) { 
<br>         var arr = [], els = root.getElementsByTagName(tag), el; 
<br>         for (var i = 0, len = els.length; i &lt; len; i++) { 
<br>             el = els[i]; 
<br>             if (el.nodeType == 1) { 
<br>                 if (val === null) { 
<br>                     if (_getAttr(el, key) !== null) { 
<br>                         arr.push(el); 
<br>                     } 
<br>                 } else { 
<br>                     if (val === escape(_getAttr(el, key))) { 
<br>                         arr.push(el); 
<br>                     } 
<br>                 } 
<br>             } 
<br>         } 
<br>         return arr; 
<br>     } 
<br>     function select(expr, root) { 
<br>         var arr = [], matches; 
<br>         matches = /^((?:\\.|[^.#\s\[&lt;&gt;])+)/.exec(expr); 
<br>         var tag = matches ? matches[1] : '*'; 
<br>         if ((matches = /#((?:[\w\-]|\\.)+)$/.exec(expr))) { 
<br>             arr = byId(matches[1], tag, root); 
<br>         } else if ((matches = /\.((?:[\w\-]|\\.)+)$/.exec(expr))) { 
<br>             arr = byClass(matches[1], tag, root); 
<br>         } else if ((matches = /\[((?:[\w\-]|\\.)+)\]/.exec(expr))) { 
<br>             arr = byAttr(matches[1].toLowerCase(), null, tag, root); 
<br>         } else if ((matches = /\[((?:[\w\-]|\\.)+)\s*=\s*['"]?((?:\\.|[^'"]+)+)['"]?\]/.exec(expr))) { 
<br>             var key = matches[1].toLowerCase(), val = matches[2]; 
<br>             if (key === 'id') { 
<br>                 arr = byId(val, tag, root); 
<br>             } else if (key === 'class') { 
<br>                 arr = byClass(val, tag, root); 
<br>             } else if (key === 'name') { 
<br>                 arr = byName(val, tag, root); 
<br>             } else { 
<br>                 arr = byAttr(key, val, tag, root); 
<br>             } 
<br>         } else { 
<br>             var els = root.getElementsByTagName(tag), el; 
<br>             for (var i = 0, len = els.length; i &lt; len; i++) { 
<br>                 el = els[i]; 
<br>                 if (el.nodeType == 1) { 
<br>                     arr.push(el); 
<br>                 } 
<br>             } 
<br>         } 
<br>         return arr; 
<br>     } 
<br>     var parts = [], arr, re = /((?:\\.|[^\s&gt;])+|[\s&gt;])/g; 
<br>     while ((arr = re.exec(expr))) { 
<br>         if (arr[1] !== ' ') { 
<br>             parts.push(arr[1]); 
<br>         } 
<br>     } 
<br>     var results = []; 
<br>     if (parts.length == 1) { 
<br>         return select(parts[0], root); 
<br>     } 
<br>     var isChild = false, part, els, subResults, val, v, i, j, k, length, len, l; 
<br>     for (i = 0, lenth = parts.length; i &lt; lenth; i++) { 
<br>         part = parts[i]; 
<br>         if (part === '&gt;') { 
<br>             isChild = true; 
<br>             continue; 
<br>         } 
<br>         if (i &gt; 0) { 
<br>             els = []; 
<br>             for (j = 0, len = results.length; j &lt; len; j++) { 
<br>                 val = results[j]; 
<br>                 subResults = select(part, val); 
<br>                 for (k = 0, l = subResults.length; k &lt; l; k++) { 
<br>                     v = subResults[k]; 
<br>                     if (isChild) { 
<br>                         if (val === v.parentNode) { 
<br>                             els.push(v); 
<br>                         } 
<br>                     } else { 
<br>                         els.push(v); 
<br>                     } 
<br>                 } 
<br>             } 
<br>             results = els; 
<br>         } else { 
<br>             results = select(part, root); 
<br>         } 
<br>         if (results.length === 0) { 
<br>             return []; 
<br>         } 
<br>     } 
<br>     return results; 
<br> } 
<br> function _query(expr, root) { 
<br>     var arr = _queryAll(expr, root); 
<br>     return arr.length &gt; 0 ? arr[0] : null; 
<br> } 
<br> K.query = _query; 
<br> K.queryAll = _queryAll; 
<br> function _get(val) { 
<br>     return K(val)[0]; 
<br> } 
<br> function _getDoc(node) { 
<br>     if (!node) { 
<br>         return document; 
<br>     } 
<br>     return node.ownerDocument || node.document || node; 
<br> } 
<br> function _getWin(node) { 
<br>     if (!node) { 
<br>         return window; 
<br>     } 
<br>     var doc = _getDoc(node); 
<br>     return doc.parentWindow || doc.defaultView; 
<br> } 
<br> function _setHtml(el, html) { 
<br>     if (el.nodeType != 1) { 
<br>         return; 
<br>     } 
<br>     var doc = _getDoc(el); 
<br>     try { 
<br>         el.innerHTML = '&lt;img id="__kindeditor_temp_tag__" width="0" height="0" style="display:none;" /&gt;' + html; 
<br>         var temp = doc.getElementById('__kindeditor_temp_tag__'); 
<br>         temp.parentNode.removeChild(temp); 
<br>     } catch(e) { 
<br>         K(el).empty(); 
<br>         K('@' + html, doc).each(function() { 
<br>             el.appendChild(this); 
<br>         }); 
<br>     } 
<br> } 
<br> function _hasClass(el, cls) { 
<br>     return _inString(cls, el.className, ' '); 
<br> } 
<br> function _setAttr(el, key, val) { 
<br>     if (_IE &amp;&amp; _V &lt; 8 &amp;&amp; key.toLowerCase() == 'class') { 
<br>         key = 'className'; 
<br>     } 
<br>     el.setAttribute(key, '' + val); 
<br> } 
<br> function _removeAttr(el, key) { 
<br>     if (_IE &amp;&amp; _V &lt; 8 &amp;&amp; key.toLowerCase() == 'class') { 
<br>         key = 'className'; 
<br>     } 
<br>     _setAttr(el, key, ''); 
<br>     el.removeAttribute(key); 
<br> } 
<br> function _getNodeName(node) { 
<br>     if (!node || !node.nodeName) { 
<br>         return ''; 
<br>     } 
<br>     return node.nodeName.toLowerCase(); 
<br> } 
<br> function _computedCss(el, key) { 
<br>     var self = this, win = _getWin(el), camelKey = _toCamel(key), val = ''; 
<br>     if (win.getComputedStyle) { 
<br>         var style = win.getComputedStyle(el, null); 
<br>         val = style[camelKey] || style.getPropertyValue(key) || el.style[camelKey]; 
<br>     } else if (el.currentStyle) { 
<br>         val = el.currentStyle[camelKey] || el.style[camelKey]; 
<br>     } 
<br>     return val; 
<br> } 
<br> function _hasVal(node) { 
<br>     return !!_VALUE_TAG_MAP[_getNodeName(node)]; 
<br> } 
<br> function _docElement(doc) { 
<br>     doc = doc || document; 
<br>     return _QUIRKS ? doc.body : doc.documentElement; 
<br> } 
<br> function _docHeight(doc) { 
<br>     var el = _docElement(doc); 
<br>     return Math.max(el.scrollHeight, el.clientHeight); 
<br> } 
<br> function _docWidth(doc) { 
<br>     var el = _docElement(doc); 
<br>     return Math.max(el.scrollWidth, el.clientWidth); 
<br> } 
<br> function _getScrollPos(doc) { 
<br>     doc = doc || document; 
<br>     var x, y; 
<br>     if (_IE || _OPERA) { 
<br>         x = _docElement(doc).scrollLeft; 
<br>         y = _docElement(doc).scrollTop; 
<br>     } else { 
<br>         x = _getWin(doc).scrollX; 
<br>         y = _getWin(doc).scrollY; 
<br>     } 
<br>     return {x : x, y : y}; 
<br> } 
<br> function KNode(node) { 
<br>     this.init(node); 
<br> } 
<br> _extend(KNode, { 
<br>     init : function(node) { 
<br>         var self = this; 
<br>         node = _isArray(node) ? node : [node]; 
<br>         var length = 0; 
<br>         for (var i = 0, len = node.length; i &lt; len; i++) { 
<br>             if (node[i]) { 
<br>                 self[i] = node[i].constructor === KNode ? node[i][0] : node[i]; 
<br>                 length++; 
<br>             } 
<br>         } 
<br>         self.length = length; 
<br>         self.doc = _getDoc(self[0]); 
<br>         self.name = _getNodeName(self[0]); 
<br>         self.type = self.length &gt; 0 ? self[0].nodeType : null; 
<br>         self.win = _getWin(self[0]); 
<br>         self._data = {}; 
<br>     }, 
<br>     each : function(fn) { 
<br>         var self = this; 
<br>         for (var i = 0; i &lt; self.length; i++) { 
<br>             if (fn.call(self[i], i, self[i]) === false) { 
<br>                 return self; 
<br>             } 
<br>         } 
<br>         return self; 
<br>     }, 
<br>     bind : function(type, fn) { 
<br>         this.each(function() { 
<br>             _bind(this, type, fn); 
<br>         }); 
<br>         return this; 
<br>     }, 
<br>     unbind : function(type, fn) { 
<br>         this.each(function() { 
<br>             _unbind(this, type, fn); 
<br>         }); 
<br>         return this; 
<br>     }, 
<br>     fire : function(type) { 
<br>         if (this.length &lt; 1) { 
<br>             return this; 
<br>         } 
<br>         _fire(this[0], type); 
<br>         return this; 
<br>     }, 
<br>     hasAttr : function(key) { 
<br>         if (this.length &lt; 1) { 
<br>             return false; 
<br>         } 
<br>         return !!_getAttr(this[0], key); 
<br>     }, 
<br>     attr : function(key, val) { 
<br>         var self = this; 
<br>         if (key === undefined) { 
<br>             return _getAttrList(self.outer()); 
<br>         } 
<br>         if (typeof key === 'object') { 
<br>             _each(key, function(k, v) { 
<br>                 self.attr(k, v); 
<br>             }); 
<br>             return self; 
<br>         } 
<br>         if (val === undefined) { 
<br>             val = self.length &lt; 1 ? null : _getAttr(self[0], key); 
<br>             return val === null ? '' : val; 
<br>         } 
<br>         self.each(function() { 
<br>             _setAttr(this, key, val); 
<br>         }); 
<br>         return self; 
<br>     }, 
<br>     removeAttr : function(key) { 
<br>         this.each(function() { 
<br>             _removeAttr(this, key); 
<br>         }); 
<br>         return this; 
<br>     }, 
<br>     get : function(i) { 
<br>         if (this.length &lt; 1) { 
<br>             return null; 
<br>         } 
<br>         return this[i || 0]; 
<br>     }, 
<br>     eq : function(i) { 
<br>         if (this.length &lt; 1) { 
<br>             return null; 
<br>         } 
<br>         return this[i] ? new KNode(this[i]) : null; 
<br>     }, 
<br>     hasClass : function(cls) { 
<br>         if (this.length &lt; 1) { 
<br>             return false; 
<br>         } 
<br>         return _hasClass(this[0], cls); 
<br>     }, 
<br>     addClass : function(cls) { 
<br>         this.each(function() { 
<br>             if (!_hasClass(this, cls)) { 
<br>                 this.className = _trim(this.className + ' ' + cls); 
<br>             } 
<br>         }); 
<br>         return this; 
<br>     }, 
<br>     removeClass : function(cls) { 
<br>         this.each(function() { 
<br>             if (_hasClass(this, cls)) { 
<br>                 this.className = _trim(this.className.replace(new RegExp('(^|\\s)' + cls + '(\\s|$)'), ' ')); 
<br>             } 
<br>         }); 
<br>         return this; 
<br>     }, 
<br>     html : function(val) { 
<br>         var self = this; 
<br>         if (val === undefined) { 
<br>             if (self.length &lt; 1 || self.type != 1) { 
<br>                 return ''; 
<br>             } 
<br>             return _formatHtml(self[0].innerHTML); 
<br>         } 
<br>         self.each(function() { 
<br>             _setHtml(this, val); 
<br>         }); 
<br>         return self; 
<br>     }, 
<br>     text : function() { 
<br>         var self = this; 
<br>         if (self.length &lt; 1) { 
<br>             return ''; 
<br>         } 
<br>         return _IE ? self[0].innerText : self[0].textContent; 
<br>     }, 
<br>     hasVal : function() { 
<br>         if (this.length &lt; 1) { 
<br>             return false; 
<br>         } 
<br>         return _hasVal(this[0]); 
<br>     }, 
<br>     val : function(val) { 
<br>         var self = this; 
<br>         if (val === undefined) { 
<br>             if (self.length &lt; 1) { 
<br>                 return ''; 
<br>             } 
<br>             return self.hasVal() ? self[0].value : self.attr('value'); 
<br>         } else { 
<br>             self.each(function() { 
<br>                 if (_hasVal(this)) { 
<br>                     this.value = val; 
<br>                 } else { 
<br>                     _setAttr(this, 'value' , val); 
<br>                 } 
<br>             }); 
<br>             return self; 
<br>         } 
<br>     }, 
<br>     css : function(key, val) { 
<br>         var self = this; 
<br>         if (key === undefined) { 
<br>             return _getCssList(self.attr('style')); 
<br>         } 
<br>         if (typeof key === 'object') { 
<br>             _each(key, function(k, v) { 
<br>                 self.css(k, v); 
<br>             }); 
<br>             return self; 
<br>         } 
<br>         if (val === undefined) { 
<br>             if (self.length &lt; 1) { 
<br>                 return ''; 
<br>             } 
<br>             return self[0].style[_toCamel(key)] || _computedCss(self[0], key) || ''; 
<br>         } 
<br>         self.each(function() { 
<br>             this.style[_toCamel(key)] = val; 
<br>         }); 
<br>         return self; 
<br>     }, 
<br>     width : function(val) { 
<br>         var self = this; 
<br>         if (val === undefined) { 
<br>             if (self.length &lt; 1) { 
<br>                 return 0; 
<br>             } 
<br>             return self[0].offsetWidth; 
<br>         } 
<br>         return self.css('width', _addUnit(val)); 
<br>     }, 
<br>     height : function(val) { 
<br>         var self = this; 
<br>         if (val === undefined) { 
<br>             if (self.length &lt; 1) { 
<br>                 return 0; 
<br>             } 
<br>             return self[0].offsetHeight; 
<br>         } 
<br>         return self.css('height', _addUnit(val)); 
<br>     }, 
<br>     opacity : function(val) { 
<br>         this.each(function() { 
<br>             if (this.style.opacity === undefined) { 
<br>                 this.style.filter = val == 1 ? '' : 'alpha(opacity=' + (val * 100) + ')'; 
<br>             } else { 
<br>                 this.style.opacity = val == 1 ? '' : val; 
<br>             } 
<br>         }); 
<br>         return this; 
<br>     }, 
<br>     data : function(key, val) { 
<br>         var self = this; 
<br>         if (val === undefined) { 
<br>             return self._data[key]; 
<br>         } 
<br>         self._data[key] = val; 
<br>         return self; 
<br>     }, 
<br>     pos : function() { 
<br>         var self = this, node = self[0], x = 0, y = 0; 
<br>         if (node) { 
<br>             if (node.getBoundingClientRect) { 
<br>                 var box = node.getBoundingClientRect(), 
<br>                     pos = _getScrollPos(self.doc); 
<br>                 x = box.left + pos.x; 
<br>                 y = box.top + pos.y; 
<br>             } else { 
<br>                 while (node) { 
<br>                     x += node.offsetLeft; 
<br>                     y += node.offsetTop; 
<br>                     node = node.offsetParent; 
<br>                 } 
<br>             } 
<br>         } 
<br>         return {x : _round(x), y : _round(y)}; 
<br>     }, 
<br>     clone : function(bool) { 
<br>         if (this.length &lt; 1) { 
<br>             return new KNode([]); 
<br>         } 
<br>         return new KNode(this[0].cloneNode(bool)); 
<br>     }, 
<br>     append : function(expr) { 
<br>         this.each(function() { 
<br>             if (this.appendChild) { 
<br>                 this.appendChild(_get(expr)); 
<br>             } 
<br>         }); 
<br>         return this; 
<br>     }, 
<br>     appendTo : function(expr) { 
<br>         this.each(function() { 
<br>             _get(expr).appendChild(this); 
<br>         }); 
<br>         return this; 
<br>     }, 
<br>     before : function(expr) { 
<br>         this.each(function() { 
<br>             this.parentNode.insertBefore(_get(expr), this); 
<br>         }); 
<br>         return this; 
<br>     }, 
<br>     after : function(expr) { 
<br>         this.each(function() { 
<br>             if (this.nextSibling) { 
<br>                 this.parentNode.insertBefore(_get(expr), this.nextSibling); 
<br>             } else { 
<br>                 this.parentNode.appendChild(_get(expr)); 
<br>             } 
<br>         }); 
<br>         return this; 
<br>     }, 
<br>     replaceWith : function(expr) { 
<br>         var nodes = []; 
<br>         this.each(function(i, node) { 
<br>             _unbind(node); 
<br>             var newNode = _get(expr); 
<br>             node.parentNode.replaceChild(newNode, node); 
<br>             nodes.push(newNode); 
<br>         }); 
<br>         return K(nodes); 
<br>     }, 
<br>     empty : function() { 
<br>         var self = this; 
<br>         self.each(function(i, node) { 
<br>             var child = node.firstChild; 
<br>             while (child) { 
<br>                 if (!node.parentNode) { 
<br>                     return; 
<br>                 } 
<br>                 var next = child.nextSibling; 
<br>                 child.parentNode.removeChild(child); 
<br>                 child = next; 
<br>             } 
<br>         }); 
<br>         return self; 
<br>     }, 
<br>     remove : function(keepChilds) { 
<br>         var self = this; 
<br>         self.each(function(i, node) { 
<br>             if (!node.parentNode) { 
<br>                 return; 
<br>             } 
<br>             _unbind(node); 
<br>             if (keepChilds) { 
<br>                 var child = node.firstChild; 
<br>                 while (child) { 
<br>                     var next = child.nextSibling; 
<br>                     node.parentNode.insertBefore(child, node); 
<br>                     child = next; 
<br>                 } 
<br>             } 
<br>             node.parentNode.removeChild(node); 
<br>             delete self[i]; 
<br>         }); 
<br>         self.length = 0; 
<br>         self._data = {}; 
<br>         return self; 
<br>     }, 
<br>     show : function(val) { 
<br>         return this.css('display', val === undefined ? 'block' : val); 
<br>     }, 
<br>     hide : function() { 
<br>         return this.css('display', 'none'); 
<br>     }, 
<br>     outer : function() { 
<br>         var self = this; 
<br>         if (self.length &lt; 1) { 
<br>             return ''; 
<br>         } 
<br>         var div = self.doc.createElement('div'), html; 
<br>         div.appendChild(self[0].cloneNode(true)); 
<br>         html = _formatHtml(div.innerHTML); 
<br>         div = null; 
<br>         return html; 
<br>     }, 
<br>     isSingle : function() { 
<br>         return !!_SINGLE_TAG_MAP[this.name]; 
<br>     }, 
<br>     isInline : function() { 
<br>         return !!_INLINE_TAG_MAP[this.name]; 
<br>     }, 
<br>     isBlock : function() { 
<br>         return !!_BLOCK_TAG_MAP[this.name]; 
<br>     }, 
<br>     isStyle : function() { 
<br>         return !!_STYLE_TAG_MAP[this.name]; 
<br>     }, 
<br>     isControl : function() { 
<br>         return !!_CONTROL_TAG_MAP[this.name]; 
<br>     }, 
<br>     contains : function(otherNode) { 
<br>         if (this.length &lt; 1) { 
<br>             return false; 
<br>         } 
<br>         return _contains(this[0], _get(otherNode)); 
<br>     }, 
<br>     parent : function() { 
<br>         if (this.length &lt; 1) { 
<br>             return null; 
<br>         } 
<br>         var node = this[0].parentNode; 
<br>         return node ? new KNode(node) : null; 
<br>     }, 
<br>     children : function() { 
<br>         if (this.length &lt; 1) { 
<br>             return new KNode([]); 
<br>         } 
<br>         var list = [], child = this[0].firstChild; 
<br>         while (child) { 
<br>             if (child.nodeType != 3 || _trim(child.nodeValue) !== '') { 
<br>                 list.push(child); 
<br>             } 
<br>             child = child.nextSibling; 
<br>         } 
<br>         return new KNode(list); 
<br>     }, 
<br>     first : function() { 
<br>         var list = this.children(); 
<br>         return list.length &gt; 0 ? list.eq(0) : null; 
<br>     }, 
<br>     last : function() { 
<br>         var list = this.children(); 
<br>         return list.length &gt; 0 ? list.eq(list.length - 1) : null; 
<br>     }, 
<br>     index : function() { 
<br>         if (this.length &lt; 1) { 
<br>             return -1; 
<br>         } 
<br>         var i = -1, sibling = this[0]; 
<br>         while (sibling) { 
<br>             i++; 
<br>             sibling = sibling.previousSibling; 
<br>         } 
<br>         return i; 
<br>     }, 
<br>     prev : function() { 
<br>         if (this.length &lt; 1) { 
<br>             return null; 
<br>         } 
<br>         var node = this[0].previousSibling; 
<br>         return node ? new KNode(node) : null; 
<br>     }, 
<br>     next : function() { 
<br>         if (this.length &lt; 1) { 
<br>             return null; 
<br>         } 
<br>         var node = this[0].nextSibling; 
<br>         return node ? new KNode(node) : null; 
<br>     }, 
<br>     scan : function(fn, order) { 
<br>         if (this.length &lt; 1) { 
<br>             return; 
<br>         } 
<br>         order = (order === undefined) ? true : order; 
<br>         function walk(node) { 
<br>             var n = order ? node.firstChild : node.lastChild; 
<br>             while (n) { 
<br>                 var next = order ? n.nextSibling : n.previousSibling; 
<br>                 if (fn(n) === false) { 
<br>                     return false; 
<br>                 } 
<br>                 if (walk(n) === false) { 
<br>                     return false; 
<br>                 } 
<br>                 n = next; 
<br>             } 
<br>         } 
<br>         walk(this[0]); 
<br>         return this; 
<br>     } 
<br> }); 
<br> _each(('blur,focus,focusin,focusout,load,resize,scroll,unload,click,dblclick,' + 
<br>     'mousedown,mouseup,mousemove,mouseover,mouseout,mouseenter,mouseleave,' + 
<br>     'change,select,submit,keydown,keypress,keyup,error,contextmenu').split(','), function(i, type) { 
<br>     KNode.prototype[type] = function(fn) { 
<br>         return fn ? this.bind(type, fn) : this.fire(type); 
<br>     }; 
<br> }); 
<br> var _K = K; 
<br> K = function(expr, root) { 
<br>     if (expr === undefined || expr === null) { 
<br>         return; 
<br>     } 
<br>     function newNode(node) { 
<br>         if (!node[0]) { 
<br>             node = []; 
<br>         } 
<br>         return new KNode(node); 
<br>     } 
<br>     if (typeof expr === 'string') { 
<br>         if (root) { 
<br>             root = _get(root); 
<br>         } 
<br>         var length = expr.length; 
<br>         if (expr.charAt(0) === '@') { 
<br>             expr = expr.substr(1); 
<br>         } 
<br>         if (expr.length !== length || /&lt;.+&gt;/.test(expr)) { 
<br>             var doc = root ? root.ownerDocument || root : document, 
<br>                 div = doc.createElement('div'), list = []; 
<br>             div.innerHTML = '&lt;img id="__kindeditor_temp_tag__" width="0" height="0" style="display:none;" /&gt;' + expr; 
<br>             for (var i = 0, len = div.childNodes.length; i &lt; len; i++) { 
<br>                 var child = div.childNodes[i]; 
<br>                 if (child.id == '__kindeditor_temp_tag__') { 
<br>                     continue; 
<br>                 } 
<br>                 list.push(child); 
<br>             } 
<br>             return newNode(list); 
<br>         } 
<br>         return newNode(_queryAll(expr, root)); 
<br>     } 
<br>     if (expr &amp;&amp; expr.constructor === KNode) { 
<br>         return expr; 
<br>     } 
<br>     if (_isArray(expr)) { 
<br>         return newNode(expr); 
<br>     } 
<br>     return newNode(_toArray(arguments)); 
<br> }; 
<br> _each(_K, function(key, val) { 
<br>     K[key] = val; 
<br> }); 
<br> window.KindEditor = K; 
<br> var _START_TO_START = 0, 
<br>     _START_TO_END = 1, 
<br>     _END_TO_END = 2, 
<br>     _END_TO_START = 3, 
<br>     _BOOKMARK_ID = 0; 
<br> function _updateCollapsed(range) { 
<br>     range.collapsed = (range.startContainer === range.endContainer &amp;&amp; range.startOffset === range.endOffset); 
<br>     return range; 
<br> } 
<br> function _copyAndDelete(range, isCopy, isDelete) { 
<br>     var doc = range.doc, nodeList = []; 
<br>     function splitTextNode(node, startOffset, endOffset) { 
<br>         var length = node.nodeValue.length, centerNode; 
<br>         if (isCopy) { 
<br>             var cloneNode = node.cloneNode(true); 
<br>             if (startOffset &gt; 0) { 
<br>                 centerNode = cloneNode.splitText(startOffset); 
<br>             } else { 
<br>                 centerNode = cloneNode; 
<br>             } 
<br>             if (endOffset &lt; length) { 
<br>                 centerNode.splitText(endOffset - startOffset); 
<br>             } 
<br>         } 
<br>         if (isDelete) { 
<br>             var center = node; 
<br>             if (startOffset &gt; 0) { 
<br>                 center = node.splitText(startOffset); 
<br>                 range.setStart(node, startOffset); 
<br>             } 
<br>             if (endOffset &lt; length) { 
<br>                 var right = center.splitText(endOffset - startOffset); 
<br>                 range.setEnd(right, 0); 
<br>             } 
<br>             nodeList.push(center); 
<br>         } 
<br>         return centerNode; 
<br>     } 
<br>     function removeNodes() { 
<br>         if (isDelete) { 
<br>             range.up().collapse(true); 
<br>         } 
<br>         for (var i = 0, len = nodeList.length; i &lt; len; i++) { 
<br>             var node = nodeList[i]; 
<br>             if (node.parentNode) { 
<br>                 node.parentNode.removeChild(node); 
<br>             } 
<br>         } 
<br>     } 
<br>     var copyRange = range.cloneRange().down(); 
<br>     var start = -1, incStart = -1, incEnd = -1, end = -1, 
<br>         ancestor = range.commonAncestor(), frag = doc.createDocumentFragment(); 
<br>     if (ancestor.nodeType == 3) { 
<br>         var textNode = splitTextNode(ancestor, range.startOffset, range.endOffset); 
<br>         if (isCopy) { 
<br>             frag.appendChild(textNode); 
<br>         } 
<br>         removeNodes(); 
<br>         return isCopy ? frag : range; 
<br>     } 
<br>     function extractNodes(parent, frag) { 
<br>         var node = parent.firstChild, nextNode; 
<br>         while (node) { 
<br>             var testRange = new KRange(doc).selectNode(node); 
<br>             start = testRange.compareBoundaryPoints(_START_TO_END, range); 
<br>             if (start &gt;= 0 &amp;&amp; incStart &lt;= 0) { 
<br>                 incStart = testRange.compareBoundaryPoints(_START_TO_START, range); 
<br>             } 
<br>             if (incStart &gt;= 0 &amp;&amp; incEnd &lt;= 0) { 
<br>                 incEnd = testRange.compareBoundaryPoints(_END_TO_END, range); 
<br>             } 
<br>             if (incEnd &gt;= 0 &amp;&amp; end &lt;= 0) { 
<br>                 end = testRange.compareBoundaryPoints(_END_TO_START, range); 
<br>             } 
<br>             if (end &gt;= 0) { 
<br>                 return false; 
<br>             } 
<br>             nextNode = node.nextSibling; 
<br>             if (start &gt; 0) { 
<br>                 if (node.nodeType == 1) { 
<br>                     if (incStart &gt;= 0 &amp;&amp; incEnd &lt;= 0) { 
<br>                         if (isCopy) { 
<br>                             frag.appendChild(node.cloneNode(true)); 
<br>                         } 
<br>                         if (isDelete) { 
<br>                             nodeList.push(node); 
<br>                         } 
<br>                     } else { 
<br>                         var childFlag; 
<br>                         if (isCopy) { 
<br>                             childFlag = node.cloneNode(false); 
<br>                             frag.appendChild(childFlag); 
<br>                         } 
<br>                         if (extractNodes(node, childFlag) === false) { 
<br>                             return false; 
<br>                         } 
<br>                     } 
<br>                 } else if (node.nodeType == 3) { 
<br>                     var textNode; 
<br>                     if (node == copyRange.startContainer) { 
<br>                         textNode = splitTextNode(node, copyRange.startOffset, node.nodeValue.length); 
<br>                     } else if (node == copyRange.endContainer) { 
<br>                         textNode = splitTextNode(node, 0, copyRange.endOffset); 
<br>                     } else { 
<br>                         textNode = splitTextNode(node, 0, node.nodeValue.length); 
<br>                     } 
<br>                     if (isCopy) { 
<br>                         try { 
<br>                             frag.appendChild(textNode); 
<br>                         } catch(e) {} 
<br>                     } 
<br>                 } 
<br>             } 
<br>             node = nextNode; 
<br>         } 
<br>     } 
<br>     extractNodes(ancestor, frag); 
<br>     if (isDelete) { 
<br>         range.up().collapse(true); 
<br>     } 
<br>     for (var i = 0, len = nodeList.length; i &lt; len; i++) { 
<br>         var node = nodeList[i]; 
<br>         if (node.parentNode) { 
<br>             node.parentNode.removeChild(node); 
<br>         } 
<br>     } 
<br>     return isCopy ? frag : range; 
<br> } 
<br> function _moveToElementText(range, el) { 
<br>     var node = el; 
<br>     while (node) { 
<br>         var knode = K(node); 
<br>         if (knode.name == 'marquee' || knode.name == 'select') { 
<br>             return; 
<br>         } 
<br>         node = node.parentNode; 
<br>     } 
<br>     try { 
<br>         range.moveToElementText(el); 
<br>     } catch(e) {} 
<br> } 
<br> function _getStartEnd(rng, isStart) { 
<br>     var doc = rng.parentElement().ownerDocument, 
<br>         pointRange = rng.duplicate(); 
<br>     pointRange.collapse(isStart); 
<br>     var parent = pointRange.parentElement(), 
<br>         nodes = parent.childNodes; 
<br>     if (nodes.length === 0) { 
<br>         return {node: parent.parentNode, offset: K(parent).index()}; 
<br>     } 
<br>     var startNode = doc, startPos = 0, cmp = -1; 
<br>     var testRange = rng.duplicate(); 
<br>     _moveToElementText(testRange, parent); 
<br>     for (var i = 0, len = nodes.length; i &lt; len; i++) { 
<br>         var node = nodes[i]; 
<br>         cmp = testRange.compareEndPoints('StartToStart', pointRange); 
<br>         if (cmp === 0) { 
<br>             return {node: node.parentNode, offset: i}; 
<br>         } 
<br>         if (node.nodeType == 1) { 
<br>             var nodeRange = rng.duplicate(), dummy, knode = K(node), newNode = node; 
<br>             if (knode.isControl()) { 
<br>                 dummy = doc.createElement('span'); 
<br>                 knode.after(dummy); 
<br>                 newNode = dummy; 
<br>                 startPos += knode.text().replace(/\r\n|\n|\r/g, '').length; 
<br>             } 
<br>             _moveToElementText(nodeRange, newNode); 
<br>             testRange.setEndPoint('StartToEnd', nodeRange); 
<br>             if (cmp &gt; 0) { 
<br>                 startPos += nodeRange.text.replace(/\r\n|\n|\r/g, '').length; 
<br>             } else { 
<br>                 startPos = 0; 
<br>             } 
<br>             if (dummy) { 
<br>                 K(dummy).remove(); 
<br>             } 
<br>         } else if (node.nodeType == 3) { 
<br>             testRange.moveStart('character', node.nodeValue.length); 
<br>             startPos += node.nodeValue.length; 
<br>         } 
<br>         if (cmp &lt; 0) { 
<br>             startNode = node; 
<br>         } 
<br>     } 
<br>     if (cmp &lt; 0 &amp;&amp; startNode.nodeType == 1) { 
<br>         return {node: parent, offset: K(parent.lastChild).index() + 1}; 
<br>     } 
<br>     if (cmp &gt; 0) { 
<br>         while (startNode.nextSibling &amp;&amp; startNode.nodeType == 1) { 
<br>             startNode = startNode.nextSibling; 
<br>         } 
<br>     } 
<br>     testRange = rng.duplicate(); 
<br>     _moveToElementText(testRange, parent); 
<br>     testRange.setEndPoint('StartToEnd', pointRange); 
<br>     startPos -= testRange.text.replace(/\r\n|\n|\r/g, '').length; 
<br>     if (cmp &gt; 0 &amp;&amp; startNode.nodeType == 3) { 
<br>         var prevNode = startNode.previousSibling; 
<br>         while (prevNode &amp;&amp; prevNode.nodeType == 3) { 
<br>             startPos -= prevNode.nodeValue.length; 
<br>             prevNode = prevNode.previousSibling; 
<br>         } 
<br>     } 
<br>     return {node: startNode, offset: startPos}; 
<br> } 
<br> function _getEndRange(node, offset) { 
<br>     var doc = node.ownerDocument || node, 
<br>         range = doc.body.createTextRange(); 
<br>     if (doc == node) { 
<br>         range.collapse(true); 
<br>         return range; 
<br>     } 
<br>     if (node.nodeType == 1 &amp;&amp; node.childNodes.length &gt; 0) { 
<br>         var children = node.childNodes, isStart, child; 
<br>         if (offset === 0) { 
<br>             child = children[0]; 
<br>             isStart = true; 
<br>         } else { 
<br>             child = children[offset - 1]; 
<br>             isStart = false; 
<br>         } 
<br>         if (!child) { 
<br>             return range; 
<br>         } 
<br>         if (K(child).name === 'head') { 
<br>             if (offset === 1) { 
<br>                 isStart = true; 
<br>             } 
<br>             if (offset === 2) { 
<br>                 isStart = false; 
<br>             } 
<br>             range.collapse(isStart); 
<br>             return range; 
<br>         } 
<br>         if (child.nodeType == 1) { 
<br>             var kchild = K(child), span; 
<br>             if (kchild.isControl()) { 
<br>                 span = doc.createElement('span'); 
<br>                 if (isStart) { 
<br>                     kchild.before(span); 
<br>                 } else { 
<br>                     kchild.after(span); 
<br>                 } 
<br>                 child = span; 
<br>             } 
<br>             _moveToElementText(range, child); 
<br>             range.collapse(isStart); 
<br>             if (span) { 
<br>                 K(span).remove(); 
<br>             } 
<br>             return range; 
<br>         } 
<br>         node = child; 
<br>         offset = isStart ? 0 : child.nodeValue.length; 
<br>     } 
<br>     var dummy = doc.createElement('span'); 
<br>     K(node).before(dummy); 
<br>     _moveToElementText(range, dummy); 
<br>     range.moveStart('character', offset); 
<br>     K(dummy).remove(); 
<br>     return range; 
<br> } 
<br> function _toRange(rng) { 
<br>     var doc, range; 
<br>     function tr2td(start) { 
<br>         if (K(start.node).name == 'tr') { 
<br>             start.node = start.node.cells[start.offset]; 
<br>             start.offset = 0; 
<br>         } 
<br>     } 
<br>     if (_IE) { 
<br>         if (rng.item) { 
<br>             doc = _getDoc(rng.item(0)); 
<br>             range = new KRange(doc); 
<br>             range.selectNode(rng.item(0)); 
<br>             return range; 
<br>         } 
<br>         doc = rng.parentElement().ownerDocument; 
<br>         var start = _getStartEnd(rng, true), 
<br>             end = _getStartEnd(rng, false); 
<br>         tr2td(start); 
<br>         tr2td(end); 
<br>         range = new KRange(doc); 
<br>         range.setStart(start.node, start.offset); 
<br>         range.setEnd(end.node, end.offset); 
<br>         return range; 
<br>     } 
<br>     var startContainer = rng.startContainer; 
<br>     doc = startContainer.ownerDocument || startContainer; 
<br>     range = new KRange(doc); 
<br>     range.setStart(startContainer, rng.startOffset); 
<br>     range.setEnd(rng.endContainer, rng.endOffset); 
<br>     return range; 
<br> } 
<br> function KRange(doc) { 
<br>     this.init(doc); 
<br> } 
<br> _extend(KRange, { 
<br>     init : function(doc) { 
<br>         var self = this; 
<br>         self.startContainer = doc; 
<br>         self.startOffset = 0; 
<br>         self.endContainer = doc; 
<br>         self.endOffset = 0; 
<br>         self.collapsed = true; 
<br>         self.doc = doc; 
<br>     }, 
<br>     commonAncestor : function() { 
<br>         function getParents(node) { 
<br>             var parents = []; 
<br>             while (node) { 
<br>                 parents.push(node); 
<br>                 node = node.parentNode; 
<br>             } 
<br>             return parents; 
<br>         } 
<br>         var parentsA = getParents(this.startContainer), 
<br>             parentsB = getParents(this.endContainer), 
<br>             i = 0, lenA = parentsA.length, lenB = parentsB.length, parentA, parentB; 
<br>         while (++i) { 
<br>             parentA = parentsA[lenA - i]; 
<br>             parentB = parentsB[lenB - i]; 
<br>             if (!parentA || !parentB || parentA !== parentB) { 
<br>                 break; 
<br>             } 
<br>         } 
<br>         return parentsA[lenA - i + 1]; 
<br>     }, 
<br>     setStart : function(node, offset) { 
<br>         var self = this, doc = self.doc; 
<br>         self.startContainer = node; 
<br>         self.startOffset = offset; 
<br>         if (self.endContainer === doc) { 
<br>             self.endContainer = node; 
<br>             self.endOffset = offset; 
<br>         } 
<br>         return _updateCollapsed(this); 
<br>     }, 
<br>     setEnd : function(node, offset) { 
<br>         var self = this, doc = self.doc; 
<br>         self.endContainer = node; 
<br>         self.endOffset = offset; 
<br>         if (self.startContainer === doc) { 
<br>             self.startContainer = node; 
<br>             self.startOffset = offset; 
<br>         } 
<br>         return _updateCollapsed(this); 
<br>     }, 
<br>     setStartBefore : function(node) { 
<br>         return this.setStart(node.parentNode || this.doc, K(node).index()); 
<br>     }, 
<br>     setStartAfter : function(node) { 
<br>         return this.setStart(node.parentNode || this.doc, K(node).index() + 1); 
<br>     }, 
<br>     setEndBefore : function(node) { 
<br>         return this.setEnd(node.parentNode || this.doc, K(node).index()); 
<br>     }, 
<br>     setEndAfter : function(node) { 
<br>         return this.setEnd(node.parentNode || this.doc, K(node).index() + 1); 
<br>     }, 
<br>     selectNode : function(node) { 
<br>         return this.setStartBefore(node).setEndAfter(node); 
<br>     }, 
<br>     selectNodeContents : function(node) { 
<br>         var knode = K(node); 
<br>         if (knode.type == 3 || knode.isSingle()) { 
<br>             return this.selectNode(node); 
<br>         } 
<br>         var children = knode.children(); 
<br>         if (children.length &gt; 0) { 
<br>             return this.setStartBefore(children[0]).setEndAfter(children[children.length - 1]); 
<br>         } 
<br>         return this.setStart(node, 0).setEnd(node, 0); 
<br>     }, 
<br>     collapse : function(toStart) { 
<br>         if (toStart) { 
<br>             return this.setEnd(this.startContainer, this.startOffset); 
<br>         } 
<br>         return this.setStart(this.endContainer, this.endOffset); 
<br>     }, 
<br>     compareBoundaryPoints : function(how, range) { 
<br>         var rangeA = this.get(), rangeB = range.get(); 
<br>         if (_IE) { 
<br>             var arr = {}; 
<br>             arr[_START_TO_START] = 'StartToStart'; 
<br>             arr[_START_TO_END] = 'EndToStart'; 
<br>             arr[_END_TO_END] = 'EndToEnd'; 
<br>             arr[_END_TO_START] = 'StartToEnd'; 
<br>             var cmp = rangeA.compareEndPoints(arr[how], rangeB); 
<br>             if (cmp !== 0) { 
<br>                 return cmp; 
<br>             } 
<br>             var nodeA, nodeB, nodeC, posA, posB; 
<br>             if (how === _START_TO_START || how === _END_TO_START) { 
<br>                 nodeA = this.startContainer; 
<br>                 posA = this.startOffset; 
<br>             } 
<br>             if (how === _START_TO_END || how === _END_TO_END) { 
<br>                 nodeA = this.endContainer; 
<br>                 posA = this.endOffset; 
<br>             } 
<br>             if (how === _START_TO_START || how === _START_TO_END) { 
<br>                 nodeB = range.startContainer; 
<br>                 posB = range.startOffset; 
<br>             } 
<br>             if (how === _END_TO_END || how === _END_TO_START) { 
<br>                 nodeB = range.endContainer; 
<br>                 posB = range.endOffset; 
<br>             } 
<br>             if (nodeA === nodeB) { 
<br>                 var diff = posA - posB; 
<br>                 return diff &gt; 0 ? 1 : (diff &lt; 0 ? -1 : 0); 
<br>             } 
<br>             nodeC = nodeB; 
<br>             while (nodeC &amp;&amp; nodeC.parentNode !== nodeA) { 
<br>                 nodeC = nodeC.parentNode; 
<br>             } 
<br>             if (nodeC) { 
<br>                 return K(nodeC).index() &gt;= posA ? -1 : 1; 
<br>             } 
<br>             nodeC = nodeA; 
<br>             while (nodeC &amp;&amp; nodeC.parentNode !== nodeB) { 
<br>                 nodeC = nodeC.parentNode; 
<br>             } 
<br>             if (nodeC) { 
<br>                 return K(nodeC).index() &gt;= posB ? 1 : -1; 
<br>             } 
<br>             nodeC = K(nodeB).next(); 
<br>             if (nodeC &amp;&amp; nodeC.contains(nodeA)) { 
<br>                 return 1; 
<br>             } 
<br>             nodeC = K(nodeA).next(); 
<br>             if (nodeC &amp;&amp; nodeC.contains(nodeB)) { 
<br>                 return -1; 
<br>             } 
<br>         } else { 
<br>             return rangeA.compareBoundaryPoints(how, rangeB); 
<br>         } 
<br>     }, 
<br>     cloneRange : function() { 
<br>         return new KRange(this.doc).setStart(this.startContainer, this.startOffset).setEnd(this.endContainer, this.endOffset); 
<br>     }, 
<br>     toString : function() { 
<br>         var rng = this.get(), str = _IE ? rng.text : rng.toString(); 
<br>         return str.replace(/\r\n|\n|\r/g, ''); 
<br>     }, 
<br>     cloneContents : function() { 
<br>         return _copyAndDelete(this, true, false); 
<br>     }, 
<br>     deleteContents : function() { 
<br>         return _copyAndDelete(this, false, true); 
<br>     }, 
<br>     extractContents : function() { 
<br>         return _copyAndDelete(this, true, true); 
<br>     }, 
<br>     insertNode : function(node) { 
<br>         var self = this, 
<br>             sc = self.startContainer, so = self.startOffset, 
<br>             ec = self.endContainer, eo = self.endOffset, 
<br>             firstChild, lastChild, c, nodeCount = 1; 
<br>         if (node.nodeName.toLowerCase() === '#document-fragment') { 
<br>             firstChild = node.firstChild; 
<br>             lastChild = node.lastChild; 
<br>             nodeCount = node.childNodes.length; 
<br>         } 
<br>         if (sc.nodeType == 1) { 
<br>             c = sc.childNodes[so]; 
<br>             if (c) { 
<br>                 sc.insertBefore(node, c); 
<br>                 if (sc === ec) { 
<br>                     eo += nodeCount; 
<br>                 } 
<br>             } else { 
<br>                 sc.appendChild(node); 
<br>             } 
<br>         } else if (sc.nodeType == 3) { 
<br>             if (so === 0) { 
<br>                 sc.parentNode.insertBefore(node, sc); 
<br>                 if (sc.parentNode === ec) { 
<br>                     eo += nodeCount; 
<br>                 } 
<br>             } else if (so &gt;= sc.nodeValue.length) { 
<br>                 if (sc.nextSibling) { 
<br>                     sc.parentNode.insertBefore(node, sc.nextSibling); 
<br>                 } else { 
<br>                     sc.parentNode.appendChild(node); 
<br>                 } 
<br>             } else { 
<br>                 if (so &gt; 0) { 
<br>                     c = sc.splitText(so); 
<br>                 } else { 
<br>                     c = sc; 
<br>                 } 
<br>                 sc.parentNode.insertBefore(node, c); 
<br>                 if (sc === ec) { 
<br>                     ec = c; 
<br>                     eo -= so; 
<br>                 } 
<br>             } 
<br>         } 
<br>         if (firstChild) { 
<br>             self.setStartBefore(firstChild).setEndAfter(lastChild); 
<br>         } else { 
<br>             self.selectNode(node); 
<br>         } 
<br>         if (self.compareBoundaryPoints(_END_TO_END, self.cloneRange().setEnd(ec, eo)) &gt;= 1) { 
<br>             return self; 
<br>         } 
<br>         return self.setEnd(ec, eo); 
<br>     }, 
<br>     surroundContents : function(node) { 
<br>         node.appendChild(this.extractContents()); 
<br>         return this.insertNode(node).selectNode(node); 
<br>     }, 
<br>     isControl : function() { 
<br>         var self = this, 
<br>             sc = self.startContainer, so = self.startOffset, 
<br>             ec = self.endContainer, eo = self.endOffset, rng; 
<br>         return sc.nodeType == 1 &amp;&amp; sc === ec &amp;&amp; so + 1 === eo &amp;&amp; K(sc.childNodes[so]).isControl(); 
<br>     }, 
<br>     get : function(hasControlRange) { 
<br>         var self = this, doc = self.doc, node, rng; 
<br>         if (!_IE) { 
<br>             rng = doc.createRange(); 
<br>             try { 
<br>                 rng.setStart(self.startContainer, self.startOffset); 
<br>                 rng.setEnd(self.endContainer, self.endOffset); 
<br>             } catch (e) {} 
<br>             return rng; 
<br>         } 
<br>         if (hasControlRange &amp;&amp; self.isControl()) { 
<br>             rng = doc.body.createControlRange(); 
<br>             rng.addElement(self.startContainer.childNodes[self.startOffset]); 
<br>             return rng; 
<br>         } 
<br>         var range = self.cloneRange().down(); 
<br>         rng = doc.body.createTextRange(); 
<br>         rng.setEndPoint('StartToStart', _getEndRange(range.startContainer, range.startOffset)); 
<br>         rng.setEndPoint('EndToStart', _getEndRange(range.endContainer, range.endOffset)); 
<br>         return rng; 
<br>     }, 
<br>     html : function() { 
<br>         return K(this.cloneContents()).outer(); 
<br>     }, 
<br>     down : function() { 
<br>         var self = this; 
<br>         function downPos(node, pos, isStart) { 
<br>             if (node.nodeType != 1) { 
<br>                 return; 
<br>             } 
<br>             var children = K(node).children(); 
<br>             if (children.length === 0) { 
<br>                 return; 
<br>             } 
<br>             var left, right, child, offset; 
<br>             if (pos &gt; 0) { 
<br>                 left = children.eq(pos - 1); 
<br>             } 
<br>             if (pos &lt; children.length) { 
<br>                 right = children.eq(pos); 
<br>             } 
<br>             if (left &amp;&amp; left.type == 3) { 
<br>                 child = left[0]; 
<br>                 offset = child.nodeValue.length; 
<br>             } 
<br>             if (right &amp;&amp; right.type == 3) { 
<br>                 child = right[0]; 
<br>                 offset = 0; 
<br>             } 
<br>             if (!child) { 
<br>                 return; 
<br>             } 
<br>             if (isStart) { 
<br>                 self.setStart(child, offset); 
<br>             } else { 
<br>                 self.setEnd(child, offset); 
<br>             } 
<br>         } 
<br>         downPos(self.startContainer, self.startOffset, true); 
<br>         downPos(self.endContainer, self.endOffset, false); 
<br>         return self; 
<br>     }, 
<br>     up : function() { 
<br>         var self = this; 
<br>         function upPos(node, pos, isStart) { 
<br>             if (node.nodeType != 3) { 
<br>                 return; 
<br>             } 
<br>             if (pos === 0) { 
<br>                 if (isStart) { 
<br>                     self.setStartBefore(node); 
<br>                 } else { 
<br>                     self.setEndBefore(node); 
<br>                 } 
<br>             } else if (pos == node.nodeValue.length) { 
<br>                 if (isStart) { 
<br>                     self.setStartAfter(node); 
<br>                 } else { 
<br>                     self.setEndAfter(node); 
<br>                 } 
<br>             } 
<br>         } 
<br>         upPos(self.startContainer, self.startOffset, true); 
<br>         upPos(self.endContainer, self.endOffset, false); 
<br>         return self; 
<br>     }, 
<br>     enlarge : function(toBlock) { 
<br>         var self = this; 
<br>         self.up(); 
<br>         function enlargePos(node, pos, isStart) { 
<br>             var knode = K(node), parent; 
<br>             if (knode.type == 3 || _NOSPLIT_TAG_MAP[knode.name] || !toBlock &amp;&amp; knode.isBlock()) { 
<br>                 return; 
<br>             } 
<br>             if (pos === 0) { 
<br>                 while (!knode.prev()) { 
<br>                     parent = knode.parent(); 
<br>                     if (!parent || _NOSPLIT_TAG_MAP[parent.name] || !toBlock &amp;&amp; parent.isBlock()) { 
<br>                         break; 
<br>                     } 
<br>                     knode = parent; 
<br>                 } 
<br>                 if (isStart) { 
<br>                     self.setStartBefore(knode[0]); 
<br>                 } else { 
<br>                     self.setEndBefore(knode[0]); 
<br>                 } 
<br>             } else if (pos == knode.children().length) { 
<br>                 while (!knode.next()) { 
<br>                     parent = knode.parent(); 
<br>                     if (!parent || _NOSPLIT_TAG_MAP[parent.name] || !toBlock &amp;&amp; parent.isBlock()) { 
<br>                         break; 
<br>                     } 
<br>                     knode = parent; 
<br>                 } 
<br>                 if (isStart) { 
<br>                     self.setStartAfter(knode[0]); 
<br>                 } else { 
<br>                     self.setEndAfter(knode[0]); 
<br>                 } 
<br>             } 
<br>         } 
<br>         enlargePos(self.startContainer, self.startOffset, true); 
<br>         enlargePos(self.endContainer, self.endOffset, false); 
<br>         return self; 
<br>     }, 
<br>     shrink : function() { 
<br>         var self = this, child, collapsed = self.collapsed; 
<br>         while (self.startContainer.nodeType == 1 &amp;&amp; (child = self.startContainer.childNodes[self.startOffset]) &amp;&amp; child.nodeType == 1 &amp;&amp; !K(child).isSingle()) { 
<br>             self.setStart(child, 0); 
<br>         } 
<br>         if (collapsed) { 
<br>             return self.collapse(collapsed); 
<br>         } 
<br>         while (self.endContainer.nodeType == 1 &amp;&amp; self.endOffset &gt; 0 &amp;&amp; (child = self.endContainer.childNodes[self.endOffset - 1]) &amp;&amp; child.nodeType == 1 &amp;&amp; !K(child).isSingle()) { 
<br>             self.setEnd(child, child.childNodes.length); 
<br>         } 
<br>         return self; 
<br>     }, 
<br>     createBookmark : function(serialize) { 
<br>         var self = this, doc = self.doc, endNode, 
<br>             startNode = K('&lt;span style="display:none;"&gt;&lt;/span&gt;', doc)[0]; 
<br>         startNode.id = '__kindeditor_bookmark_start_' + (_BOOKMARK_ID++) + '__'; 
<br>         if (!self.collapsed) { 
<br>             endNode = startNode.cloneNode(true); 
<br>             endNode.id = '__kindeditor_bookmark_end_' + (_BOOKMARK_ID++) + '__'; 
<br>         } 
<br>         if (endNode) { 
<br>             self.cloneRange().collapse(false).insertNode(endNode).setEndBefore(endNode); 
<br>         } 
<br>         self.insertNode(startNode).setStartAfter(startNode); 
<br>         return { 
<br>             start : serialize ? '#' + startNode.id : startNode, 
<br>             end : endNode ? (serialize ? '#' + endNode.id : endNode) : null 
<br>         }; 
<br>     }, 
<br>     moveToBookmark : function(bookmark) { 
<br>         var self = this, doc = self.doc, 
<br>             start = K(bookmark.start, doc), end = bookmark.end ? K(bookmark.end, doc) : null; 
<br>         if (!start || start.length &lt; 1) { 
<br>             return self; 
<br>         } 
<br>         self.setStartBefore(start[0]); 
<br>         start.remove(); 
<br>         if (end &amp;&amp; end.length &gt; 0) { 
<br>             self.setEndBefore(end[0]); 
<br>             end.remove(); 
<br>         } else { 
<br>             self.collapse(true); 
<br>         } 
<br>         return self; 
<br>     }, 
<br>     dump : function() { 
<br>         console.log('--------------------'); 
<br>         console.log(this.startContainer.nodeType == 3 ? this.startContainer.nodeValue : this.startContainer, this.startOffset); 
<br>         console.log(this.endContainer.nodeType == 3 ? this.endContainer.nodeValue : this.endContainer, this.endOffset); 
<br>     } 
<br> }); 
<br> function _range(mixed) { 
<br>     if (!mixed.nodeName) { 
<br>         return mixed.constructor === KRange ? mixed : _toRange(mixed); 
<br>     } 
<br>     return new KRange(mixed); 
<br> } 
<br> K.range = _range; 
<br> K.START_TO_START = _START_TO_START; 
<br> K.START_TO_END = _START_TO_END; 
<br> K.END_TO_END = _END_TO_END; 
<br> K.END_TO_START = _END_TO_START; 
<br> function _nativeCommand(doc, key, val) { 
<br>     try { 
<br>         doc.execCommand(key, false, val); 
<br>     } catch(e) {} 
<br> } 
<br> function _nativeCommandValue(doc, key) { 
<br>     var val = ''; 
<br>     try { 
<br>         val = doc.queryCommandValue(key); 
<br>     } catch (e) {} 
<br>     if (typeof val !== 'string') { 
<br>         val = ''; 
<br>     } 
<br>     return val; 
<br> } 
<br> function _getSel(doc) { 
<br>     var win = _getWin(doc); 
<br>     return doc.selection || win.getSelection(); 
<br> } 
<br> function _getRng(doc) { 
<br>     var sel = _getSel(doc), rng; 
<br>     try { 
<br>         if (sel.rangeCount &gt; 0) { 
<br>             rng = sel.getRangeAt(0); 
<br>         } else { 
<br>             rng = sel.createRange(); 
<br>         } 
<br>     } catch(e) {} 
<br>     if (_IE &amp;&amp; (!rng || (!rng.item &amp;&amp; rng.parentElement().ownerDocument !== doc))) { 
<br>         return null; 
<br>     } 
<br>     return rng; 
<br> } 
<br> function _singleKeyMap(map) { 
<br>     var newMap = {}, arr, v; 
<br>     _each(map, function(key, val) { 
<br>         arr = key.split(','); 
<br>         for (var i = 0, len = arr.length; i &lt; len; i++) { 
<br>             v = arr[i]; 
<br>             newMap[v] = val; 
<br>         } 
<br>     }); 
<br>     return newMap; 
<br> } 
<br> function _hasAttrOrCss(knode, map) { 
<br>     return _hasAttrOrCssByKey(knode, map, '*') || _hasAttrOrCssByKey(knode, map); 
<br> } 
<br> function _hasAttrOrCssByKey(knode, map, mapKey) { 
<br>     mapKey = mapKey || knode.name; 
<br>     if (knode.type !== 1) { 
<br>         return false; 
<br>     } 
<br>     var newMap = _singleKeyMap(map); 
<br>     if (!newMap[mapKey]) { 
<br>         return false; 
<br>     } 
<br>     var arr = newMap[mapKey].split(','); 
<br>     for (var i = 0, len = arr.length; i &lt; len; i++) { 
<br>         var key = arr[i]; 
<br>         if (key === '*') { 
<br>             return true; 
<br>         } 
<br>         var match = /^(\.?)([^=]+)(?:=([^=]*))?$/.exec(key); 
<br>         var method = match[1] ? 'css' : 'attr'; 
<br>         key = match[2]; 
<br>         var val = match[3] || ''; 
<br>         if (val === '' &amp;&amp; knode[method](key) !== '') { 
<br>             return true; 
<br>         } 
<br>         if (val !== '' &amp;&amp; knode[method](key) === val) { 
<br>             return true; 
<br>         } 
<br>     } 
<br>     return false; 
<br> } 
<br> function _removeAttrOrCss(knode, map) { 
<br>     if (knode.type != 1) { 
<br>         return; 
<br>     } 
<br>     _removeAttrOrCssByKey(knode, map, '*'); 
<br>     _removeAttrOrCssByKey(knode, map); 
<br> } 
<br> function _removeAttrOrCssByKey(knode, map, mapKey) { 
<br>     mapKey = mapKey || knode.name; 
<br>     if (knode.type !== 1) { 
<br>         return; 
<br>     } 
<br>     var newMap = _singleKeyMap(map); 
<br>     if (!newMap[mapKey]) { 
<br>         return; 
<br>     } 
<br>     var arr = newMap[mapKey].split(','), allFlag = false; 
<br>     for (var i = 0, len = arr.length; i &lt; len; i++) { 
<br>         var key = arr[i]; 
<br>         if (key === '*') { 
<br>             allFlag = true; 
<br>             break; 
<br>         } 
<br>         var match = /^(\.?)([^=]+)(?:=([^=]*))?$/.exec(key); 
<br>         key = match[2]; 
<br>         if (match[1]) { 
<br>             key = _toCamel(key); 
<br>             if (knode[0].style[key]) { 
<br>                 knode[0].style[key] = ''; 
<br>             } 
<br>         } else { 
<br>             knode.removeAttr(key); 
<br>         } 
<br>     } 
<br>     if (allFlag) { 
<br>         knode.remove(true); 
<br>     } 
<br> } 
<br> function _getInnerNode(knode) { 
<br>     var inner = knode; 
<br>     while (inner.first()) { 
<br>         inner = inner.first(); 
<br>     } 
<br>     return inner; 
<br> } 
<br> function _isEmptyNode(knode) { 
<br>     return knode.type == 1 &amp;&amp; knode.html().replace(/&lt;[^&gt;]+&gt;/g, '') === ''; 
<br> } 
<br> function _mergeWrapper(a, b) { 
<br>     a = a.clone(true); 
<br>     var lastA = _getInnerNode(a), childA = a, merged = false; 
<br>     while (b) { 
<br>         while (childA) { 
<br>             if (childA.name === b.name) { 
<br>                 _mergeAttrs(childA, b.attr(), b.css()); 
<br>                 merged = true; 
<br>             } 
<br>             childA = childA.first(); 
<br>         } 
<br>         if (!merged) { 
<br>             lastA.append(b.clone(false)); 
<br>         } 
<br>         merged = false; 
<br>         b = b.first(); 
<br>     } 
<br>     return a; 
<br> } 
<br> function _wrapNode(knode, wrapper) { 
<br>     wrapper = wrapper.clone(true); 
<br>     if (knode.type == 3) { 
<br>         _getInnerNode(wrapper).append(knode.clone(false)); 
<br>         knode.replaceWith(wrapper); 
<br>         return wrapper; 
<br>     } 
<br>     var nodeWrapper = knode, child; 
<br>     while ((child = knode.first()) &amp;&amp; child.children().length == 1) { 
<br>         knode = child; 
<br>     } 
<br>     child = knode.first(); 
<br>     var frag = knode.doc.createDocumentFragment(); 
<br>     while (child) { 
<br>         frag.appendChild(child[0]); 
<br>         child = child.next(); 
<br>     } 
<br>     wrapper = _mergeWrapper(nodeWrapper, wrapper); 
<br>     if (frag.firstChild) { 
<br>         _getInnerNode(wrapper).append(frag); 
<br>     } 
<br>     nodeWrapper.replaceWith(wrapper); 
<br>     return wrapper; 
<br> } 
<br> function _mergeAttrs(knode, attrs, styles) { 
<br>     _each(attrs, function(key, val) { 
<br>         if (key !== 'style') { 
<br>             knode.attr(key, val); 
<br>         } 
<br>     }); 
<br>     _each(styles, function(key, val) { 
<br>         knode.css(key, val); 
<br>     }); 
<br> } 
<br> function _inPreElement(knode) { 
<br>     while (knode &amp;&amp; knode.name != 'body') { 
<br>         if (_PRE_TAG_MAP[knode.name] || knode.name == 'div' &amp;&amp; knode.hasClass('ke-script')) { 
<br>             return true; 
<br>         } 
<br>         knode = knode.parent(); 
<br>     } 
<br>     return false; 
<br> } 
<br> function KCmd(range) { 
<br>     this.init(range); 
<br> } 
<br> _extend(KCmd, { 
<br>     init : function(range) { 
<br>         var self = this, doc = range.doc; 
<br>         self.doc = doc; 
<br>         self.win = _getWin(doc); 
<br>         self.sel = _getSel(doc); 
<br>         self.range = range; 
<br>     }, 
<br>     selection : function(forceReset) { 
<br>         var self = this, doc = self.doc, rng = _getRng(doc); 
<br>         self.sel = _getSel(doc); 
<br>         if (rng) { 
<br>             self.range = _range(rng); 
<br>             if (K(self.range.startContainer).name == 'html') { 
<br>                 self.range.selectNodeContents(doc.body).collapse(false); 
<br>             } 
<br>             return self; 
<br>         } 
<br>         if (forceReset) { 
<br>             self.range.selectNodeContents(doc.body).collapse(false); 
<br>         } 
<br>         return self; 
<br>     }, 
<br>     select : function(hasDummy) { 
<br>         hasDummy = _undef(hasDummy, true); 
<br>         var self = this, sel = self.sel, range = self.range.cloneRange().shrink(), 
<br>             sc = range.startContainer, so = range.startOffset, 
<br>             ec = range.endContainer, eo = range.endOffset, 
<br>             doc = _getDoc(sc), win = self.win, rng, hasU200b = false; 
<br>         if (hasDummy &amp;&amp; sc.nodeType == 1 &amp;&amp; range.collapsed) { 
<br>             if (_IE) { 
<br>                 var dummy = K('&lt;span&gt;&amp;nbsp;&lt;/span&gt;', doc); 
<br>                 range.insertNode(dummy[0]); 
<br>                 rng = doc.body.createTextRange(); 
<br>                 try { 
<br>                     rng.moveToElementText(dummy[0]); 
<br>                 } catch(ex) {} 
<br>                 rng.collapse(false); 
<br>                 rng.select(); 
<br>                 dummy.remove(); 
<br>                 win.focus(); 
<br>                 return self; 
<br>             } 
<br>             if (_WEBKIT) { 
<br>                 var children = sc.childNodes; 
<br>                 if (K(sc).isInline() || so &gt; 0 &amp;&amp; K(children[so - 1]).isInline() || children[so] &amp;&amp; K(children[so]).isInline()) { 
<br>                     range.insertNode(doc.createTextNode('\u200B')); 
<br>                     hasU200b = true; 
<br>                 } 
<br>             } 
<br>         } 
<br>         if (_IE) { 
<br>             try { 
<br>                 rng = range.get(true); 
<br>                 rng.select(); 
<br>             } catch(e) {} 
<br>         } else { 
<br>             if (hasU200b) { 
<br>                 range.collapse(false); 
<br>             } 
<br>             rng = range.get(true); 
<br>             sel.removeAllRanges(); 
<br>             sel.addRange(rng); 
<br>         } 
<br>         win.focus(); 
<br>         return self; 
<br>     }, 
<br>     wrap : function(val) { 
<br>         var self = this, doc = self.doc, range = self.range, wrapper; 
<br>         wrapper = K(val, doc); 
<br>         if (range.collapsed) { 
<br>             range.shrink(); 
<br>             range.insertNode(wrapper[0]).selectNodeContents(wrapper[0]); 
<br>             return self; 
<br>         } 
<br>         if (wrapper.isBlock()) { 
<br>             var copyWrapper = wrapper.clone(true), child = copyWrapper; 
<br>             while (child.first()) { 
<br>                 child = child.first(); 
<br>             } 
<br>             child.append(range.extractContents()); 
<br>             range.insertNode(copyWrapper[0]).selectNode(copyWrapper[0]); 
<br>             return self; 
<br>         } 
<br>         range.enlarge(); 
<br>         var bookmark = range.createBookmark(), ancestor = range.commonAncestor(), isStart = false; 
<br>         K(ancestor).scan(function(node) { 
<br>             if (!isStart &amp;&amp; node == bookmark.start) { 
<br>                 isStart = true; 
<br>                 return; 
<br>             } 
<br>             if (isStart) { 
<br>                 if (node == bookmark.end) { 
<br>                     return false; 
<br>                 } 
<br>                 var knode = K(node); 
<br>                 if (_inPreElement(knode)) { 
<br>                     return; 
<br>                 } 
<br>                 if (knode.type == 3 &amp;&amp; _trim(node.nodeValue).length &gt; 0) { 
<br>                     var parent; 
<br>                     while ((parent = knode.parent()) &amp;&amp; parent.isStyle() &amp;&amp; parent.children().length == 1) { 
<br>                         knode = parent; 
<br>                     } 
<br>                     _wrapNode(knode, wrapper); 
<br>                 } 
<br>             } 
<br>         }); 
<br>         range.moveToBookmark(bookmark); 
<br>         return self; 
<br>     }, 
<br>     split : function(isStart, map) { 
<br>         var range = this.range, doc = range.doc; 
<br>         var tempRange = range.cloneRange().collapse(isStart); 
<br>         var node = tempRange.startContainer, pos = tempRange.startOffset, 
<br>             parent = node.nodeType == 3 ? node.parentNode : node, 
<br>             needSplit = false, knode; 
<br>         while (parent &amp;&amp; parent.parentNode) { 
<br>             knode = K(parent); 
<br>             if (map) { 
<br>                 if (!knode.isStyle()) { 
<br>                     break; 
<br>                 } 
<br>                 if (!_hasAttrOrCss(knode, map)) { 
<br>                     break; 
<br>                 } 
<br>             } else { 
<br>                 if (_NOSPLIT_TAG_MAP[knode.name]) { 
<br>                     break; 
<br>                 } 
<br>             } 
<br>             needSplit = true; 
<br>             parent = parent.parentNode; 
<br>         } 
<br>         if (needSplit) { 
<br>             var dummy = doc.createElement('span'); 
<br>             range.cloneRange().collapse(!isStart).insertNode(dummy); 
<br>             if (isStart) { 
<br>                 tempRange.setStartBefore(parent.firstChild).setEnd(node, pos); 
<br>             } else { 
<br>                 tempRange.setStart(node, pos).setEndAfter(parent.lastChild); 
<br>             } 
<br>             var frag = tempRange.extractContents(), 
<br>                 first = frag.firstChild, last = frag.lastChild; 
<br>             if (isStart) { 
<br>                 tempRange.insertNode(frag); 
<br>                 range.setStartAfter(last).setEndBefore(dummy); 
<br>             } else { 
<br>                 parent.appendChild(frag); 
<br>                 range.setStartBefore(dummy).setEndBefore(first); 
<br>             } 
<br>             var dummyParent = dummy.parentNode; 
<br>             if (dummyParent == range.endContainer) { 
<br>                 var prev = K(dummy).prev(), next = K(dummy).next(); 
<br>                 if (prev &amp;&amp; next &amp;&amp; prev.type == 3 &amp;&amp; next.type == 3) { 
<br>                     range.setEnd(prev[0], prev[0].nodeValue.length); 
<br>                 } else if (!isStart) { 
<br>                     range.setEnd(range.endContainer, range.endOffset - 1); 
<br>                 } 
<br>             } 
<br>             dummyParent.removeChild(dummy); 
<br>         } 
<br>         return this; 
<br>     }, 
<br>     remove : function(map) { 
<br>         var self = this, doc = self.doc, range = self.range; 
<br>         range.enlarge(); 
<br>         if (range.startOffset === 0) { 
<br>             var ksc = K(range.startContainer), parent; 
<br>             while ((parent = ksc.parent()) &amp;&amp; parent.isStyle() &amp;&amp; parent.children().length == 1) { 
<br>                 ksc = parent; 
<br>             } 
<br>             range.setStart(ksc[0], 0); 
<br>             ksc = K(range.startContainer); 
<br>             if (ksc.isBlock()) { 
<br>                 _removeAttrOrCss(ksc, map); 
<br>             } 
<br>             var kscp = ksc.parent(); 
<br>             if (kscp &amp;&amp; kscp.isBlock()) { 
<br>                 _removeAttrOrCss(kscp, map); 
<br>             } 
<br>         } 
<br>         var sc, so; 
<br>         if (range.collapsed) { 
<br>             self.split(true, map); 
<br>             sc = range.startContainer; 
<br>             so = range.startOffset; 
<br>             if (so &gt; 0) { 
<br>                 var sb = K(sc.childNodes[so - 1]); 
<br>                 if (sb &amp;&amp; _isEmptyNode(sb)) { 
<br>                     sb.remove(); 
<br>                     range.setStart(sc, so - 1); 
<br>                 } 
<br>             } 
<br>             var sa = K(sc.childNodes[so]); 
<br>             if (sa &amp;&amp; _isEmptyNode(sa)) { 
<br>                 sa.remove(); 
<br>             } 
<br>             if (_isEmptyNode(sc)) { 
<br>                 range.startBefore(sc); 
<br>                 sc.remove(); 
<br>             } 
<br>             range.collapse(true); 
<br>             return self; 
<br>         } 
<br>         self.split(true, map); 
<br>         self.split(false, map); 
<br>         var startDummy = doc.createElement('span'), endDummy = doc.createElement('span'); 
<br>         range.cloneRange().collapse(false).insertNode(endDummy); 
<br>         range.cloneRange().collapse(true).insertNode(startDummy); 
<br>         var nodeList = [], cmpStart = false; 
<br>         K(range.commonAncestor()).scan(function(node) { 
<br>             if (!cmpStart &amp;&amp; node == startDummy) { 
<br>                 cmpStart = true; 
<br>                 return; 
<br>             } 
<br>             if (node == endDummy) { 
<br>                 return false; 
<br>             } 
<br>             if (cmpStart) { 
<br>                 nodeList.push(node); 
<br>             } 
<br>         }); 
<br>         K(startDummy).remove(); 
<br>         K(endDummy).remove(); 
<br>         sc = range.startContainer; 
<br>         so = range.startOffset; 
<br>         var ec = range.endContainer, eo = range.endOffset; 
<br>         if (so &gt; 0) { 
<br>             var startBefore = K(sc.childNodes[so - 1]); 
<br>             if (startBefore &amp;&amp; _isEmptyNode(startBefore)) { 
<br>                 startBefore.remove(); 
<br>                 range.setStart(sc, so - 1); 
<br>                 if (sc == ec) { 
<br>                     range.setEnd(ec, eo - 1); 
<br>                 } 
<br>             } 
<br>             var startAfter = K(sc.childNodes[so]); 
<br>             if (startAfter &amp;&amp; _isEmptyNode(startAfter)) { 
<br>                 startAfter.remove(); 
<br>                 if (sc == ec) { 
<br>                     range.setEnd(ec, eo - 1); 
<br>                 } 
<br>             } 
<br>         } 
<br>         var endAfter = K(ec.childNodes[range.endOffset]); 
<br>         if (endAfter &amp;&amp; _isEmptyNode(endAfter)) { 
<br>             endAfter.remove(); 
<br>         } 
<br>         var bookmark = range.createBookmark(true); 
<br>         _each(nodeList, function(i, node) { 
<br>             _removeAttrOrCss(K(node), map); 
<br>         }); 
<br>         range.moveToBookmark(bookmark); 
<br>         return self; 
<br>     }, 
<br>     commonNode : function(map) { 
<br>         var range = this.range; 
<br>         var ec = range.endContainer, eo = range.endOffset, 
<br>             node = (ec.nodeType == 3 || eo === 0) ? ec : ec.childNodes[eo - 1]; 
<br>         function find(node) { 
<br>             var child = node, parent = node; 
<br>             while (parent) { 
<br>                 if (_hasAttrOrCss(K(parent), map)) { 
<br>                     return K(parent); 
<br>                 } 
<br>                 parent = parent.parentNode; 
<br>             } 
<br>             while (child &amp;&amp; (child = child.lastChild)) { 
<br>                 if (_hasAttrOrCss(K(child), map)) { 
<br>                     return K(child); 
<br>                 } 
<br>             } 
<br>             return null; 
<br>         } 
<br>         var cNode = find(node); 
<br>         if (cNode) { 
<br>             return cNode; 
<br>         } 
<br>         if (node.nodeType == 1 || (ec.nodeType == 3 &amp;&amp; eo === 0)) { 
<br>             var prev = K(node).prev(); 
<br>             if (prev) { 
<br>                 return find(prev); 
<br>             } 
<br>         } 
<br>         return null; 
<br>     }, 
<br>     commonAncestor : function(tagName) { 
<br>         var range = this.range, 
<br>             sc = range.startContainer, so = range.startOffset, 
<br>             ec = range.endContainer, eo = range.endOffset, 
<br>             startNode = (sc.nodeType == 3 || so === 0) ? sc : sc.childNodes[so - 1], 
<br>             endNode = (ec.nodeType == 3 || eo === 0) ? ec : ec.childNodes[eo - 1]; 
<br>         function find(node) { 
<br>             while (node) { 
<br>                 if (node.nodeType == 1) { 
<br>                     if (node.tagName.toLowerCase() === tagName) { 
<br>                         return node; 
<br>                     } 
<br>                 } 
<br>                 node = node.parentNode; 
<br>             } 
<br>             return null; 
<br>         } 
<br>         var start = find(startNode), end = find(endNode); 
<br>         if (start &amp;&amp; end &amp;&amp; start === end) { 
<br>             return K(start); 
<br>         } 
<br>         return null; 
<br>     }, 
<br>     state : function(key) { 
<br>         var self = this, doc = self.doc, bool = false; 
<br>         try { 
<br>             bool = doc.queryCommandState(key); 
<br>         } catch (e) {} 
<br>         return bool; 
<br>     }, 
<br>     val : function(key) { 
<br>         var self = this, doc = self.doc, range = self.range; 
<br>         function lc(val) { 
<br>             return val.toLowerCase(); 
<br>         } 
<br>         key = lc(key); 
<br>         var val = '', knode; 
<br>         if (key === 'fontfamily' || key === 'fontname') { 
<br>             val = _nativeCommandValue(doc, 'fontname'); 
<br>             val = val.replace(/['"]/g, ''); 
<br>             return lc(val); 
<br>         } 
<br>         if (key === 'formatblock') { 
<br>             val = _nativeCommandValue(doc, key); 
<br>             if (val === '') { 
<br>                 knode = self.commonNode({'h1,h2,h3,h4,h5,h6,p,div,pre,address' : '*'}); 
<br>                 if (knode) { 
<br>                     val = knode.name; 
<br>                 } 
<br>             } 
<br>             if (val === 'Normal') { 
<br>                 val = 'p'; 
<br>             } 
<br>             return lc(val); 
<br>         } 
<br>         if (key === 'fontsize') { 
<br>             knode = self.commonNode({'*' : '.font-size'}); 
<br>             if (knode) { 
<br>                 val = knode.css('font-size'); 
<br>             } 
<br>             return lc(val); 
<br>         } 
<br>         if (key === 'forecolor') { 
<br>             knode = self.commonNode({'*' : '.color'}); 
<br>             if (knode) { 
<br>                 val = knode.css('color'); 
<br>             } 
<br>             val = _toHex(val); 
<br>             if (val === '') { 
<br>                 val = 'default'; 
<br>             } 
<br>             return lc(val); 
<br>         } 
<br>         if (key === 'hilitecolor') { 
<br>             knode = self.commonNode({'*' : '.background-color'}); 
<br>             if (knode) { 
<br>                 val = knode.css('background-color'); 
<br>             } 
<br>             val = _toHex(val); 
<br>             if (val === '') { 
<br>                 val = 'default'; 
<br>             } 
<br>             return lc(val); 
<br>         } 
<br>         return val; 
<br>     }, 
<br>     toggle : function(wrapper, map) { 
<br>         var self = this; 
<br>         if (self.commonNode(map)) { 
<br>             self.remove(map); 
<br>         } else { 
<br>             self.wrap(wrapper); 
<br>         } 
<br>         return self.select(); 
<br>     }, 
<br>     bold : function() { 
<br>         return this.toggle('&lt;strong&gt;&lt;/strong&gt;', { 
<br>             span : '.font-weight=bold', 
<br>             strong : '*', 
<br>             b : '*' 
<br>         }); 
<br>     }, 
<br>     italic : function() { 
<br>         return this.toggle('&lt;em&gt;&lt;/em&gt;', { 
<br>             span : '.font-style=italic', 
<br>             em : '*', 
<br>             i : '*' 
<br>         }); 
<br>     }, 
<br>     underline : function() { 
<br>         return this.toggle('&lt;u&gt;&lt;/u&gt;', { 
<br>             span : '.text-decoration=underline', 
<br>             u : '*' 
<br>         }); 
<br>     }, 
<br>     strikethrough : function() { 
<br>         return this.toggle('&lt;s&gt;&lt;/s&gt;', { 
<br>             span : '.text-decoration=line-through', 
<br>             s : '*' 
<br>         }); 
<br>     }, 
<br>     forecolor : function(val) { 
<br>         return this.toggle('&lt;span style="color:' + val + ';"&gt;&lt;/span&gt;', { 
<br>             span : '.color=' + val, 
<br>             font : 'color' 
<br>         }); 
<br>     }, 
<br>     hilitecolor : function(val) { 
<br>         return this.toggle('&lt;span style="background-color:' + val + ';"&gt;&lt;/span&gt;', { 
<br>             span : '.background-color=' + val 
<br>         }); 
<br>     }, 
<br>     fontsize : function(val) { 
<br>         return this.toggle('&lt;span style="font-size:' + val + ';"&gt;&lt;/span&gt;', { 
<br>             span : '.font-size=' + val, 
<br>             font : 'size' 
<br>         }); 
<br>     }, 
<br>     fontname : function(val) { 
<br>         return this.fontfamily(val); 
<br>     }, 
<br>     fontfamily : function(val) { 
<br>         return this.toggle('&lt;span style="font-family:' + val + ';"&gt;&lt;/span&gt;', { 
<br>             span : '.font-family=' + val, 
<br>             font : 'face' 
<br>         }); 
<br>     }, 
<br>     removeformat : function() { 
<br>         var map = { 
<br>             '*' : '.font-weight,.font-style,.text-decoration,.color,.background-color,.font-size,.font-family,.text-indent' 
<br>         }, 
<br>         tags = _STYLE_TAG_MAP; 
<br>         _each(tags, function(key, val) { 
<br>             map[key] = '*'; 
<br>         }); 
<br>         this.remove(map); 
<br>         return this.select(); 
<br>     }, 
<br>     inserthtml : function(val, quickMode) { 
<br>         var self = this, range = self.range; 
<br>         if (val === '') { 
<br>             return self; 
<br>         } 
<br>         if (_inPreElement(K(range.startContainer))) { 
<br>             return self; 
<br>         } 
<br>         function pasteHtml(range, val) { 
<br>             val = '&lt;img id="__kindeditor_temp_tag__" width="0" height="0" style="display:none;" /&gt;' + val; 
<br>             var rng = range.get(); 
<br>             if (rng.item) { 
<br>                 rng.item(0).outerHTML = val; 
<br>             } else { 
<br>                 rng.pasteHTML(val); 
<br>             } 
<br>             var temp = range.doc.getElementById('__kindeditor_temp_tag__'); 
<br>             temp.parentNode.removeChild(temp); 
<br>             var newRange = _toRange(rng); 
<br>             range.setEnd(newRange.endContainer, newRange.endOffset); 
<br>             range.collapse(false); 
<br>             self.select(false); 
<br>         } 
<br>         function insertHtml(range, val) { 
<br>             var doc = range.doc, 
<br>                 frag = doc.createDocumentFragment(); 
<br>             K('@' + val, doc).each(function() { 
<br>                 frag.appendChild(this); 
<br>             }); 
<br>             range.deleteContents(); 
<br>             range.insertNode(frag); 
<br>             range.collapse(false); 
<br>             self.select(false); 
<br>         } 
<br>         if (_IE &amp;&amp; quickMode) { 
<br>             try { 
<br>                 pasteHtml(range, val); 
<br>             } catch(e) { 
<br>                 insertHtml(range, val); 
<br>             } 
<br>             return self; 
<br>         } 
<br>         insertHtml(range, val); 
<br>         return self; 
<br>     }, 
<br>     hr : function() { 
<br>         return this.inserthtml('&lt;hr /&gt;'); 
<br>     }, 
<br>     print : function() { 
<br>         this.win.print(); 
<br>         return this; 
<br>     }, 
<br>     insertimage : function(url, title, width, height, border, align) { 
<br>         title = _undef(title, ''); 
<br>         border = _undef(border, 0); 
<br>         var html = '&lt;img src="' + _escape(url) + '" data-ke-src="' + _escape(url) + '" '; 
<br>         if (width) { 
<br>             html += 'width="' + _escape(width) + '" '; 
<br>         } 
<br>         if (height) { 
<br>             html += 'height="' + _escape(height) + '" '; 
<br>         } 
<br>         if (title) { 
<br>             html += 'title="' + _escape(title) + '" '; 
<br>         } 
<br>         if (align) { 
<br>             html += 'align="' + _escape(align) + '" '; 
<br>         } 
<br>         html += 'alt="' + _escape(title) + '" '; 
<br>         html += '/&gt;'; 
<br>         return this.inserthtml(html); 
<br>     }, 
<br>     createlink : function(url, type) { 
<br>         var self = this, doc = self.doc, range = self.range; 
<br>         self.select(); 
<br>         var a = self.commonNode({ a : '*' }); 
<br>         if (a &amp;&amp; !range.isControl()) { 
<br>             range.selectNode(a.get()); 
<br>             self.select(); 
<br>         } 
<br>         var html = '&lt;a href="' + _escape(url) + '" data-ke-src="' + _escape(url) + '" '; 
<br>         if (type) { 
<br>             html += ' target="' + _escape(type) + '"'; 
<br>         } 
<br>         if (range.collapsed) { 
<br>             html += '&gt;' + _escape(url) + '&lt;/a&gt;'; 
<br>             return self.inserthtml(html); 
<br>         } 
<br>         if (range.isControl()) { 
<br>             var node = K(range.startContainer.childNodes[range.startOffset]); 
<br>             html += '&gt;&lt;/a&gt;'; 
<br>             node.after(K(html, doc)); 
<br>             node.next().append(node); 
<br>             range.selectNode(node[0]); 
<br>             return self.select(); 
<br>         } 
<br>         _nativeCommand(doc, 'createlink', '__kindeditor_temp_url__'); 
<br>         K('a[href="__kindeditor_temp_url__"]', doc).each(function() { 
<br>             K(this).attr('href', url).attr('data-ke-src', url); 
<br>             if (type) { 
<br>                 K(this).attr('target', type); 
<br>             } else { 
<br>                 K(this).removeAttr('target'); 
<br>             } 
<br>         }); 
<br>         return self; 
<br>     }, 
<br>     unlink : function() { 
<br>         var self = this, doc = self.doc, range = self.range; 
<br>         self.select(); 
<br>         if (range.collapsed) { 
<br>             var a = self.commonNode({ a : '*' }); 
<br>             if (a) { 
<br>                 range.selectNode(a.get()); 
<br>                 self.select(); 
<br>             } 
<br>             _nativeCommand(doc, 'unlink', null); 
<br>             if (_WEBKIT &amp;&amp; K(range.startContainer).name === 'img') { 
<br>                 var parent = K(range.startContainer).parent(); 
<br>                 if (parent.name === 'a') { 
<br>                     parent.remove(true); 
<br>                 } 
<br>             } 
<br>         } else { 
<br>             _nativeCommand(doc, 'unlink', null); 
<br>         } 
<br>         return self; 
<br>     } 
<br> }); 
<br> _each(('formatblock,selectall,justifyleft,justifycenter,justifyright,justifyfull,insertorderedlist,' + 
<br>     'insertunorderedlist,indent,outdent,subscript,superscript').split(','), function(i, name) { 
<br>     KCmd.prototype[name] = function(val) { 
<br>         var self = this; 
<br>         self.select(); 
<br>         _nativeCommand(self.doc, name, val); 
<br>         if (!_IE || _inArray(name, 'formatblock,selectall,insertorderedlist,insertunorderedlist'.split(',')) &gt;= 0) { 
<br>             self.selection(); 
<br>         } 
<br>         return self; 
<br>     }; 
<br> }); 
<br> _each('cut,copy,paste'.split(','), function(i, name) { 
<br>     KCmd.prototype[name] = function() { 
<br>         var self = this; 
<br>         if (!self.doc.queryCommandSupported(name)) { 
<br>             throw 'not supported'; 
<br>         } 
<br>         self.select(); 
<br>         _nativeCommand(self.doc, name, null); 
<br>         return self; 
<br>     }; 
<br> }); 
<br> function _cmd(mixed) { 
<br>     if (mixed.nodeName) { 
<br>         var doc = _getDoc(mixed); 
<br>         mixed = _range(doc).selectNodeContents(doc.body).collapse(false); 
<br>     } 
<br>     return new KCmd(mixed); 
<br> } 
<br> K.cmd = _cmd; 
<br> function _drag(options) { 
<br>     var moveEl = options.moveEl, 
<br>         moveFn = options.moveFn, 
<br>         clickEl = options.clickEl || moveEl, 
<br>         beforeDrag = options.beforeDrag, 
<br>         iframeFix = options.iframeFix === undefined ? true : options.iframeFix; 
<br>     var docs = [document], 
<br>         poss = [{ x : 0, y : 0}], 
<br>         listeners = []; 
<br>     if (iframeFix) { 
<br>         K('iframe').each(function() { 
<br>             var doc; 
<br>             try { 
<br>                 doc = _iframeDoc(this); 
<br>                 K(doc); 
<br>             } catch(e) { 
<br>                 doc = null; 
<br>             } 
<br>             if (doc) { 
<br>                 docs.push(doc); 
<br>                 poss.push(K(this).pos()); 
<br>             } 
<br>         }); 
<br>     } 
<br>     clickEl.mousedown(function(e) { 
<br>         var self = clickEl.get(), 
<br>             x = _removeUnit(moveEl.css('left')), 
<br>             y = _removeUnit(moveEl.css('top')), 
<br>             width = moveEl.width(), 
<br>             height = moveEl.height(), 
<br>             pageX = e.pageX, 
<br>             pageY = e.pageY, 
<br>             dragging = true; 
<br>         if (beforeDrag) { 
<br>             beforeDrag(); 
<br>         } 
<br>         _each(docs, function(i, doc) { 
<br>             function moveListener(e) { 
<br>                 if (dragging) { 
<br>                     var diffX = _round(poss[i].x + e.pageX - pageX), 
<br>                         diffY = _round(poss[i].y + e.pageY - pageY); 
<br>                     moveFn.call(clickEl, x, y, width, height, diffX, diffY); 
<br>                 } 
<br>                 e.stop(); 
<br>             } 
<br>             function selectListener(e) { 
<br>                 e.stop(); 
<br>             } 
<br>             function upListener(e) { 
<br>                 dragging = false; 
<br>                 if (self.releaseCapture) { 
<br>                     self.releaseCapture(); 
<br>                 } 
<br>                 _each(listeners, function() { 
<br>                     K(this.doc).unbind('mousemove', this.move) 
<br>                         .unbind('mouseup', this.up) 
<br>                         .unbind('selectstart', this.select); 
<br>                 }); 
<br>                 e.stop(); 
<br>             } 
<br>             K(doc).mousemove(moveListener) 
<br>                 .mouseup(upListener) 
<br>                 .bind('selectstart', selectListener); 
<br>             listeners.push({ 
<br>                 doc : doc, 
<br>                 move : moveListener, 
<br>                 up : upListener, 
<br>                 select : selectListener 
<br>             }); 
<br>         }); 
<br>         if (self.setCapture) { 
<br>             self.setCapture(); 
<br>         } 
<br>     }); 
<br> } 
<br> function KWidget(options) { 
<br>     this.init(options); 
<br> } 
<br> _extend(KWidget, { 
<br>     init : function(options) { 
<br>         var self = this; 
<br>         self.name = options.name || ''; 
<br>         self.doc = options.doc || document; 
<br>         self.win = _getWin(self.doc); 
<br>         self.x = _addUnit(options.x); 
<br>         self.y = _addUnit(options.y); 
<br>         self.z = options.z; 
<br>         self.width = _addUnit(options.width); 
<br>         self.height = _addUnit(options.height); 
<br>         self.div = K('&lt;div style="display:block;"&gt;&lt;/div&gt;'); 
<br>         self.options = options; 
<br>         self._alignEl = options.alignEl; 
<br>         if (self.width) { 
<br>             self.div.css('width', self.width); 
<br>         } 
<br>         if (self.height) { 
<br>             self.div.css('height', self.height); 
<br>         } 
<br>         if (self.z) { 
<br>             self.div.css({ 
<br>                 position : 'absolute', 
<br>                 left : self.x, 
<br>                 top : self.y, 
<br>                 'z-index' : self.z 
<br>             }); 
<br>         } 
<br>         if (self.z &amp;&amp; (self.x === undefined || self.y === undefined)) { 
<br>             self.autoPos(self.width, self.height); 
<br>         } 
<br>         if (options.cls) { 
<br>             self.div.addClass(options.cls); 
<br>         } 
<br>         if (options.shadowMode) { 
<br>             self.div.addClass('ke-shadow'); 
<br>         } 
<br>         if (options.css) { 
<br>             self.div.css(options.css); 
<br>         } 
<br>         if (options.src) { 
<br>             K(options.src).replaceWith(self.div); 
<br>         } else { 
<br>             K(self.doc.body).append(self.div); 
<br>         } 
<br>         if (options.html) { 
<br>             self.div.html(options.html); 
<br>         } 
<br>         if (options.autoScroll) { 
<br>             if (_IE &amp;&amp; _V &lt; 7 || _QUIRKS) { 
<br>                 var scrollPos = _getScrollPos(); 
<br>                 K(self.win).bind('scroll', function(e) { 
<br>                     var pos = _getScrollPos(), 
<br>                         diffX = pos.x - scrollPos.x, 
<br>                         diffY = pos.y - scrollPos.y; 
<br>                     self.pos(_removeUnit(self.x) + diffX, _removeUnit(self.y) + diffY, false); 
<br>                 }); 
<br>             } else { 
<br>                 self.div.css('position', 'fixed'); 
<br>             } 
<br>         } 
<br>     }, 
<br>     pos : function(x, y, updateProp) { 
<br>         var self = this; 
<br>         updateProp = _undef(updateProp, true); 
<br>         if (x !== null) { 
<br>             x = x &lt; 0 ? 0 : _addUnit(x); 
<br>             self.div.css('left', x); 
<br>             if (updateProp) { 
<br>                 self.x = x; 
<br>             } 
<br>         } 
<br>         if (y !== null) { 
<br>             y = y &lt; 0 ? 0 : _addUnit(y); 
<br>             self.div.css('top', y); 
<br>             if (updateProp) { 
<br>                 self.y = y; 
<br>             } 
<br>         } 
<br>         return self; 
<br>     }, 
<br>     autoPos : function(width, height) { 
<br>         var self = this, 
<br>             w = _removeUnit(width) || 0, 
<br>             h = _removeUnit(height) || 0, 
<br>             scrollPos = _getScrollPos(); 
<br>         if (self._alignEl) { 
<br>             var knode = K(self._alignEl), 
<br>                 pos = knode.pos(), 
<br>                 diffX = _round(knode[0].clientWidth / 2 - w / 2), 
<br>                 diffY = _round(knode[0].clientHeight / 2 - h / 2); 
<br>             x = diffX &lt; 0 ? pos.x : pos.x + diffX; 
<br>             y = diffY &lt; 0 ? pos.y : pos.y + diffY; 
<br>         } else { 
<br>             var docEl = _docElement(self.doc); 
<br>             x = _round(scrollPos.x + (docEl.clientWidth - w) / 2); 
<br>             y = _round(scrollPos.y + (docEl.clientHeight - h) / 2); 
<br>         } 
<br>         if (!(_IE &amp;&amp; _V &lt; 7 || _QUIRKS)) { 
<br>             x -= scrollPos.x; 
<br>             y -= scrollPos.y; 
<br>         } 
<br>         return self.pos(x, y); 
<br>     }, 
<br>     remove : function() { 
<br>         var self = this; 
<br>         if (_IE &amp;&amp; _V &lt; 7) { 
<br>             K(self.win).unbind('scroll'); 
<br>         } 
<br>         self.div.remove(); 
<br>         _each(self, function(i) { 
<br>             self[i] = null; 
<br>         }); 
<br>         return this; 
<br>     }, 
<br>     show : function() { 
<br>         this.div.show(); 
<br>         return this; 
<br>     }, 
<br>     hide : function() { 
<br>         this.div.hide(); 
<br>         return this; 
<br>     }, 
<br>     draggable : function(options) { 
<br>         var self = this; 
<br>         options = options || {}; 
<br>         options.moveEl = self.div; 
<br>         options.moveFn = function(x, y, width, height, diffX, diffY) { 
<br>             if ((x = x + diffX) &lt; 0) { 
<br>                 x = 0; 
<br>             } 
<br>             if ((y = y + diffY) &lt; 0) { 
<br>                 y = 0; 
<br>             } 
<br>             self.pos(x, y); 
<br>         }; 
<br>         _drag(options); 
<br>         return self; 
<br>     } 
<br> }); 
<br> function _widget(options) { 
<br>     return new KWidget(options); 
<br> } 
<br> K.WidgetClass = KWidget; 
<br> K.widget = _widget; 
<br> function _iframeDoc(iframe) { 
<br>     iframe = _get(iframe); 
<br>     return iframe.contentDocument || iframe.contentWindow.document; 
<br> } 
<br> var html, _direction = ''; 
<br> if ((html = document.getElementsByTagName('html'))) { 
<br>     _direction = html[0].dir; 
<br> } 
<br> function _getInitHtml(themesPath, bodyClass, cssPath, cssData) { 
<br>     var arr = [ 
<br>         (_direction === '' ? '&lt;html&gt;' : '&lt;html dir="' + _direction + '"&gt;'), 
<br>         '&lt;head&gt;&lt;meta charset="utf-8" /&gt;&lt;title&gt;&lt;/title&gt;', 
<br>         '&lt;style&gt;', 
<br>         'html {margin:0;padding:0;}', 
<br>         'body {margin:0;padding:5px;}', 
<br>         'body, td {font:12px/1.5 "sans serif",tahoma,verdana,helvetica;}', 
<br>         'body, p, div {word-wrap: break-word;}', 
<br>         'p {margin:5px 0;}', 
<br>         'table {border-collapse:collapse;}', 
<br>         'img {border:0;}', 
<br>         'noscript {display:none;}', 
<br>         'table.ke-zeroborder td {border:1px dotted #AAA;}', 
<br>         'img.ke-flash {', 
<br>         '    border:1px solid #AAA;', 
<br>         '    background-image:url(' + themesPath + 'common/flash.gif);', 
<br>         '    background-position:center center;', 
<br>         '    background-repeat:no-repeat;', 
<br>         '    width:100px;', 
<br>         '    height:100px;', 
<br>         '}', 
<br>         'img.ke-rm {', 
<br>         '    border:1px solid #AAA;', 
<br>         '    background-image:url(' + themesPath + 'common/rm.gif);', 
<br>         '    background-position:center center;', 
<br>         '    background-repeat:no-repeat;', 
<br>         '    width:100px;', 
<br>         '    height:100px;', 
<br>         '}', 
<br>         'img.ke-media {', 
<br>         '    border:1px solid #AAA;', 
<br>         '    background-image:url(' + themesPath + 'common/media.gif);', 
<br>         '    background-position:center center;', 
<br>         '    background-repeat:no-repeat;', 
<br>         '    width:100px;', 
<br>         '    height:100px;', 
<br>         '}', 
<br>         'img.ke-anchor {', 
<br>         '    border:1px dashed #666;', 
<br>         '    width:16px;', 
<br>         '    height:16px;', 
<br>         '}', 
<br>         '.ke-script, .ke-noscript {', 
<br>         '    display:none;', 
<br>         '    font-size:0;', 
<br>         '    width:0;', 
<br>         '    height:0;', 
<br>         '}', 
<br>         '.ke-pagebreak {', 
<br>         '    border:1px dotted #AAA;', 
<br>         '    font-size:0;', 
<br>         '    height:2px;', 
<br>         '}', 
<br>         '&lt;/style&gt;' 
<br>     ]; 
<br>     if (!_isArray(cssPath)) { 
<br>         cssPath = [cssPath]; 
<br>     } 
<br>     _each(cssPath, function(i, path) { 
<br>         if (path) { 
<br>             arr.push('&lt;link href="' + path + '" rel="stylesheet" /&gt;'); 
<br>         } 
<br>     }); 
<br>     if (cssData) { 
<br>         arr.push('&lt;style&gt;' + cssData + '&lt;/style&gt;'); 
<br>     } 
<br>     arr.push('&lt;/head&gt;&lt;body ' + (bodyClass ? 'class="' + bodyClass + '"' : '') + '&gt;&lt;/body&gt;&lt;/html&gt;'); 
<br>     return arr.join('\n'); 
<br> } 
<br> function _elementVal(knode, val) { 
<br>     return knode.hasVal() ? knode.val(val) : knode.html(val); 
<br> } 
<br> function KEdit(options) { 
<br>     this.init(options); 
<br> } 
<br> _extend(KEdit, KWidget, { 
<br>     init : function(options) { 
<br>         var self = this; 
<br>         KEdit.parent.init.call(self, options); 
<br>         self.srcElement = K(options.srcElement); 
<br>         self.div.addClass('ke-edit'); 
<br>         self.designMode = _undef(options.designMode, true); 
<br>         self.beforeGetHtml = options.beforeGetHtml; 
<br>         self.beforeSetHtml = options.beforeSetHtml; 
<br>         self.afterSetHtml = options.afterSetHtml; 
<br>         var themesPath = _undef(options.themesPath, ''), 
<br>             bodyClass = options.bodyClass, 
<br>             cssPath = options.cssPath, 
<br>             cssData = options.cssData, 
<br>             isDocumentDomain = location.host.replace(/:\d+/, '') !== document.domain, 
<br>             srcScript = ('document.open();' + 
<br>                 (isDocumentDomain ? 'document.domain="' + document.domain + '";' : '') + 
<br>                 'document.close();'), 
<br>             iframeSrc = _IE ? ' src="javascript:void(function(){' + encodeURIComponent(srcScript) + '}())"' : ''; 
<br>         self.iframe = K('&lt;iframe class="ke-edit-iframe" hidefocus="true" frameborder="0"' + iframeSrc + '&gt;&lt;/iframe&gt;').css('width', '100%'); 
<br>         self.textarea = K('&lt;textarea class="ke-edit-textarea" hidefocus="true"&gt;&lt;/textarea&gt;').css('width', '100%'); 
<br>         if (self.width) { 
<br>             self.setWidth(self.width); 
<br>         } 
<br>         if (self.height) { 
<br>             self.setHeight(self.height); 
<br>         } 
<br>         if (self.designMode) { 
<br>             self.textarea.hide(); 
<br>         } else { 
<br>             self.iframe.hide(); 
<br>         } 
<br>         function ready() { 
<br>             var doc = _iframeDoc(self.iframe); 
<br>             doc.open(); 
<br>             if (isDocumentDomain) { 
<br>                 doc.domain = document.domain; 
<br>             } 
<br>             doc.write(_getInitHtml(themesPath, bodyClass, cssPath, cssData)); 
<br>             doc.close(); 
<br>             self.win = self.iframe[0].contentWindow; 
<br>             self.doc = doc; 
<br>             var cmd = _cmd(doc); 
<br>             self.afterChange(function(e) { 
<br>                 cmd.selection(); 
<br>             }); 
<br>             if (_WEBKIT) { 
<br>                 K(doc).click(function(e) { 
<br>                     if (K(e.target).name === 'img') { 
<br>                         cmd.selection(true); 
<br>                         cmd.range.selectNode(e.target); 
<br>                         cmd.select(); 
<br>                     } 
<br>                 }); 
<br>             } 
<br>             if (_IE) { 
<br>                 K(doc).keydown(function(e) { 
<br>                     if (e.which == 8) { 
<br>                         cmd.selection(); 
<br>                         var rng = cmd.range; 
<br>                         if (rng.isControl()) { 
<br>                             rng.collapse(true); 
<br>                             K(rng.startContainer.childNodes[rng.startOffset]).remove(); 
<br>                             e.preventDefault(); 
<br>                         } 
<br>                     } 
<br>                 }); 
<br>             } 
<br>             self.cmd = cmd; 
<br>             self.html(_elementVal(self.srcElement)); 
<br>             if (_IE) { 
<br>                 doc.body.disabled = true; 
<br>                 doc.body.contentEditable = true; 
<br>                 doc.body.removeAttribute('disabled'); 
<br>             } else { 
<br>                 doc.designMode = 'on'; 
<br>             } 
<br>             if (options.afterCreate) { 
<br>                 options.afterCreate.call(self); 
<br>             } 
<br>         } 
<br>         if (isDocumentDomain) { 
<br>             self.iframe.bind('load', function(e) { 
<br>                 self.iframe.unbind('load'); 
<br>                 if (_IE) { 
<br>                     ready(); 
<br>                 } else { 
<br>                     setTimeout(ready, 0); 
<br>                 } 
<br>             }); 
<br>         } 
<br>         self.div.append(self.iframe); 
<br>         self.div.append(self.textarea); 
<br>         self.srcElement.hide(); 
<br>         !isDocumentDomain &amp;&amp; ready(); 
<br>     }, 
<br>     setWidth : function(val) { 
<br>         this.div.css('width', _addUnit(val)); 
<br>         return this; 
<br>     }, 
<br>     setHeight : function(val) { 
<br>         var self = this; 
<br>         val = _addUnit(val); 
<br>         self.div.css('height', val); 
<br>         self.iframe.css('height', val); 
<br>         if ((_IE &amp;&amp; _V &lt; 8) || _QUIRKS) { 
<br>             val = _addUnit(_removeUnit(val) - 2); 
<br>         } 
<br>         self.textarea.css('height', val); 
<br>         return self; 
<br>     }, 
<br>     remove : function() { 
<br>         var self = this, doc = self.doc; 
<br>         K(doc.body).unbind(); 
<br>         K(doc).unbind(); 
<br>         K(self.win).unbind(); 
<br>         _elementVal(self.srcElement, self.html()); 
<br>         self.srcElement.show(); 
<br>         doc.write(''); 
<br>         self.iframe.unbind(); 
<br>         self.textarea.unbind(); 
<br>         KEdit.parent.remove.call(self); 
<br>     }, 
<br>     html : function(val, isFull) { 
<br>         var self = this, doc = self.doc; 
<br>         if (self.designMode) { 
<br>             var body = doc.body; 
<br>             if (val === undefined) { 
<br>                 if (isFull) { 
<br>                     val = '&lt;!doctype html&gt;&lt;html&gt;' + body.parentNode.innerHTML + '&lt;/html&gt;'; 
<br>                 } else { 
<br>                     val = body.innerHTML; 
<br>                 } 
<br>                 if (self.beforeGetHtml) { 
<br>                     val = self.beforeGetHtml(val); 
<br>                 } 
<br>                 if (_GECKO &amp;&amp; val == '&lt;br /&gt;') { 
<br>                     val = ''; 
<br>                 } 
<br>                 return val; 
<br>             } 
<br>             if (self.beforeSetHtml) { 
<br>                 val = self.beforeSetHtml(val); 
<br>             } 
<br>             K(body).html(val); 
<br>             if (self.afterSetHtml) { 
<br>                 self.afterSetHtml(); 
<br>             } 
<br>             return self; 
<br>         } 
<br>         if (val === undefined) { 
<br>             return self.textarea.val(); 
<br>         } 
<br>         self.textarea.val(val); 
<br>         return self; 
<br>     }, 
<br>     design : function(bool) { 
<br>         var self = this, val; 
<br>         if (bool === undefined ? !self.designMode : bool) { 
<br>             if (!self.designMode) { 
<br>                 val = self.html(); 
<br>                 self.designMode = true; 
<br>                 self.html(val); 
<br>                 self.textarea.hide(); 
<br>                 self.iframe.show(); 
<br>             } 
<br>         } else { 
<br>             if (self.designMode) { 
<br>                 val = self.html(); 
<br>                 self.designMode = false; 
<br>                 self.html(val); 
<br>                 self.iframe.hide(); 
<br>                 self.textarea.show(); 
<br>             } 
<br>         } 
<br>         return self.focus(); 
<br>     }, 
<br>     focus : function() { 
<br>         var self = this; 
<br>         self.designMode ? self.win.focus() : self.textarea[0].focus(); 
<br>         return self; 
<br>     }, 
<br>     blur : function() { 
<br>         var self = this; 
<br>         if (_IE) { 
<br>             var input = K('&lt;input type="text" style="float:left;width:0;height:0;padding:0;margin:0;border:0;" value="" /&gt;', self.div); 
<br>             self.div.append(input); 
<br>             input[0].focus(); 
<br>             input.remove(); 
<br>         } else { 
<br>             self.designMode ? self.win.blur() : self.textarea[0].blur(); 
<br>         } 
<br>         return self; 
<br>     }, 
<br>     afterChange : function(fn) { 
<br>         var self = this, doc = self.doc, body = doc.body; 
<br>         K(doc).keyup(function(e) { 
<br>             if (!e.ctrlKey &amp;&amp; !e.altKey &amp;&amp; _CHANGE_KEY_MAP[e.which]) { 
<br>                 fn(e); 
<br>             } 
<br>         }); 
<br>         K(doc).mouseup(fn).contextmenu(fn); 
<br>         K(self.win).blur(fn); 
<br>         function timeoutHandler(e) { 
<br>             setTimeout(function() { 
<br>                 fn(e); 
<br>             }, 1); 
<br>         } 
<br>         K(body).bind('paste', timeoutHandler); 
<br>         K(body).bind('cut', timeoutHandler); 
<br>         return self; 
<br>     } 
<br> }); 
<br> function _edit(options) { 
<br>     return new KEdit(options); 
<br> } 
<br> K.edit = _edit; 
<br> K.iframeDoc = _iframeDoc; 
<br> function _selectToolbar(name, fn) { 
<br>     var self = this, 
<br>         knode = self.get(name); 
<br>     if (knode) { 
<br>         if (knode.hasClass('ke-disabled')) { 
<br>             return; 
<br>         } 
<br>         fn(knode); 
<br>     } 
<br> } 
<br> function KToolbar(options) { 
<br>     this.init(options); 
<br> } 
<br> _extend(KToolbar, KWidget, { 
<br>     init : function(options) { 
<br>         var self = this; 
<br>         KToolbar.parent.init.call(self, options); 
<br>         self.disableMode = _undef(options.disableMode, false); 
<br>         self.noDisableItemMap = _toMap(_undef(options.noDisableItems, [])); 
<br>         self._itemMap = {}; 
<br>         self.div.addClass('ke-toolbar').bind('contextmenu,mousedown,mousemove', function(e) { 
<br>             e.preventDefault(); 
<br>         }).attr('unselectable', 'on'); 
<br>         function find(target) { 
<br>             var knode = K(target); 
<br>             if (knode.hasClass('ke-outline')) { 
<br>                 return knode; 
<br>             } 
<br>             if (knode.hasClass('ke-toolbar-icon')) { 
<br>                 return knode.parent(); 
<br>             } 
<br>         } 
<br>         function hover(e, method) { 
<br>             var knode = find(e.target); 
<br>             if (knode) { 
<br>                 if (knode.hasClass('ke-disabled')) { 
<br>                     return; 
<br>                 } 
<br>                 if (knode.hasClass('ke-selected')) { 
<br>                     return; 
<br>                 } 
<br>                 knode[method]('ke-on'); 
<br>             } 
<br>         } 
<br>         self.div.mouseover(function(e) { 
<br>             hover(e, 'addClass'); 
<br>         }) 
<br>         .mouseout(function(e) { 
<br>             hover(e, 'removeClass'); 
<br>         }) 
<br>         .click(function(e) { 
<br>             var knode = find(e.target); 
<br>             if (knode) { 
<br>                 if (knode.hasClass('ke-disabled')) { 
<br>                     return; 
<br>                 } 
<br>                 self.options.click.call(this, e, knode.attr('data-name')); 
<br>             } 
<br>         }); 
<br>     }, 
<br>     get : function(name) { 
<br>         if (this._itemMap[name]) { 
<br>             return this._itemMap[name]; 
<br>         } 
<br>         return (this._itemMap[name] = K('span.ke-icon-' + name, this.div).parent()); 
<br>     }, 
<br>     select : function(name) { 
<br>         _selectToolbar.call(this, name, function(knode) { 
<br>             knode.addClass('ke-selected'); 
<br>         }); 
<br>         return self; 
<br>     }, 
<br>     unselect : function(name) { 
<br>         _selectToolbar.call(this, name, function(knode) { 
<br>             knode.removeClass('ke-selected').removeClass('ke-on'); 
<br>         }); 
<br>         return self; 
<br>     }, 
<br>     enable : function(name) { 
<br>         var self = this, 
<br>             knode = name.get ? name : self.get(name); 
<br>         if (knode) { 
<br>             knode.removeClass('ke-disabled'); 
<br>             knode.opacity(1); 
<br>         } 
<br>         return self; 
<br>     }, 
<br>     disable : function(name) { 
<br>         var self = this, 
<br>             knode = name.get ? name : self.get(name); 
<br>         if (knode) { 
<br>             knode.removeClass('ke-selected').addClass('ke-disabled'); 
<br>             knode.opacity(0.5); 
<br>         } 
<br>         return self; 
<br>     }, 
<br>     disableAll : function(bool, noDisableItems) { 
<br>         var self = this, map = self.noDisableItemMap, item; 
<br>         if (noDisableItems) { 
<br>             map = _toMap(noDisableItems); 
<br>         } 
<br>         if (bool === undefined ? !self.disableMode : bool) { 
<br>             K('span.ke-outline', self.div).each(function() { 
<br>                 var knode = K(this), 
<br>                     name = knode[0].getAttribute('data-name', 2); 
<br>                 if (!map[name]) { 
<br>                     self.disable(knode); 
<br>                 } 
<br>             }); 
<br>             self.disableMode = true; 
<br>         } else { 
<br>             K('span.ke-outline', self.div).each(function() { 
<br>                 var knode = K(this), 
<br>                     name = knode[0].getAttribute('data-name', 2); 
<br>                 if (!map[name]) { 
<br>                     self.enable(knode); 
<br>                 } 
<br>             }); 
<br>             self.disableMode = false; 
<br>         } 
<br>         return self; 
<br>     } 
<br> }); 
<br> function _toolbar(options) { 
<br>     return new KToolbar(options); 
<br> } 
<br> K.toolbar = _toolbar; 
<br> function KMenu(options) { 
<br>     this.init(options); 
<br> } 
<br> _extend(KMenu, KWidget, { 
<br>     init : function(options) { 
<br>         var self = this; 
<br>         options.z = options.z || 811213; 
<br>         KMenu.parent.init.call(self, options); 
<br>         self.centerLineMode = _undef(options.centerLineMode, true); 
<br>         self.div.addClass('ke-menu').bind('click,mousedown', function(e){ 
<br>             e.stopPropagation(); 
<br>         }).attr('unselectable', 'on'); 
<br>     }, 
<br>     addItem : function(item) { 
<br>         var self = this; 
<br>         if (item.title === '-') { 
<br>             self.div.append(K('&lt;div class="ke-menu-separator"&gt;&lt;/div&gt;')); 
<br>             return; 
<br>         } 
<br>         var itemDiv = K('&lt;div class="ke-menu-item" unselectable="on"&gt;&lt;/div&gt;'), 
<br>             leftDiv = K('&lt;div class="ke-inline-block ke-menu-item-left"&gt;&lt;/div&gt;'), 
<br>             rightDiv = K('&lt;div class="ke-inline-block ke-menu-item-right"&gt;&lt;/div&gt;'), 
<br>             height = _addUnit(item.height), 
<br>             iconClass = _undef(item.iconClass, ''); 
<br>         self.div.append(itemDiv); 
<br>         if (height) { 
<br>             itemDiv.css('height', height); 
<br>             rightDiv.css('line-height', height); 
<br>         } 
<br>         var centerDiv; 
<br>         if (self.centerLineMode) { 
<br>             centerDiv = K('&lt;div class="ke-inline-block ke-menu-item-center"&gt;&lt;/div&gt;'); 
<br>             if (height) { 
<br>                 centerDiv.css('height', height); 
<br>             } 
<br>         } 
<br>         itemDiv.mouseover(function(e) { 
<br>             K(this).addClass('ke-menu-item-on'); 
<br>             if (centerDiv) { 
<br>                 centerDiv.addClass('ke-menu-item-center-on'); 
<br>             } 
<br>         }) 
<br>         .mouseout(function(e) { 
<br>             K(this).removeClass('ke-menu-item-on'); 
<br>             if (centerDiv) { 
<br>                 centerDiv.removeClass('ke-menu-item-center-on'); 
<br>             } 
<br>         }) 
<br>         .click(function(e) { 
<br>             item.click.call(K(this)); 
<br>             e.stopPropagation(); 
<br>         }) 
<br>         .append(leftDiv); 
<br>         if (centerDiv) { 
<br>             itemDiv.append(centerDiv); 
<br>         } 
<br>         itemDiv.append(rightDiv); 
<br>         if (item.checked) { 
<br>             iconClass = 'ke-icon-checked'; 
<br>         } 
<br>         if (iconClass !== '') { 
<br>             leftDiv.html('&lt;span class="ke-inline-block ke-toolbar-icon ke-toolbar-icon-url ' + iconClass + '"&gt;&lt;/span&gt;'); 
<br>         } 
<br>         rightDiv.html(item.title); 
<br>         return self; 
<br>     }, 
<br>     remove : function() { 
<br>         var self = this; 
<br>         if (self.options.beforeRemove) { 
<br>             self.options.beforeRemove.call(self); 
<br>         } 
<br>         K('.ke-menu-item', self.div[0]).unbind(); 
<br>         KMenu.parent.remove.call(self); 
<br>         return self; 
<br>     } 
<br> }); 
<br> function _menu(options) { 
<br>     return new KMenu(options); 
<br> } 
<br> K.menu = _menu; 
<br> function KColorPicker(options) { 
<br>     this.init(options); 
<br> } 
<br> _extend(KColorPicker, KWidget, { 
<br>     init : function(options) { 
<br>         var self = this; 
<br>         options.z = options.z || 811213; 
<br>         KColorPicker.parent.init.call(self, options); 
<br>         var colors = options.colors || [ 
<br>             ['#E53333', '#E56600', '#FF9900', '#64451D', '#DFC5A4', '#FFE500'], 
<br>             ['#009900', '#006600', '#99BB00', '#B8D100', '#60D978', '#00D5FF'], 
<br>             ['#337FE5', '#003399', '#4C33E5', '#9933E5', '#CC33E5', '#EE33EE'], 
<br>             ['#FFFFFF', '#CCCCCC', '#999999', '#666666', '#333333', '#000000'] 
<br>         ]; 
<br>         self.selectedColor = (options.selectedColor || '').toLowerCase(); 
<br>         self._cells = []; 
<br>         self.div.addClass('ke-colorpicker').bind('click,mousedown', function(e){ 
<br>             e.stopPropagation(); 
<br>         }).attr('unselectable', 'on'); 
<br>         var table = self.doc.createElement('table'); 
<br>         self.div.append(table); 
<br>         table.className = 'ke-colorpicker-table'; 
<br>         table.cellPadding = 0; 
<br>         table.cellSpacing = 0; 
<br>         table.border = 0; 
<br>         var row = table.insertRow(0), cell = row.insertCell(0); 
<br>         cell.colSpan = colors[0].length; 
<br>         self._addAttr(cell, '', 'ke-colorpicker-cell-top'); 
<br>         for (var i = 0; i &lt; colors.length; i++) { 
<br>             row = table.insertRow(i + 1); 
<br>             for (var j = 0; j &lt; colors[i].length; j++) { 
<br>                 cell = row.insertCell(j); 
<br>                 self._addAttr(cell, colors[i][j], 'ke-colorpicker-cell'); 
<br>             } 
<br>         } 
<br>     }, 
<br>     _addAttr : function(cell, color, cls) { 
<br>         var self = this; 
<br>         cell = K(cell).addClass(cls); 
<br>         if (self.selectedColor === color.toLowerCase()) { 
<br>             cell.addClass('ke-colorpicker-cell-selected'); 
<br>         } 
<br>         cell.attr('title', color || self.options.noColor); 
<br>         cell.mouseover(function(e) { 
<br>             K(this).addClass('ke-colorpicker-cell-on'); 
<br>         }); 
<br>         cell.mouseout(function(e) { 
<br>             K(this).removeClass('ke-colorpicker-cell-on'); 
<br>         }); 
<br>         cell.click(function(e) { 
<br>             e.stop(); 
<br>             self.options.click.call(K(this), color); 
<br>         }); 
<br>         if (color) { 
<br>             cell.append(K('&lt;div class="ke-colorpicker-cell-color" unselectable="on"&gt;&lt;/div&gt;').css('background-color', color)); 
<br>         } else { 
<br>             cell.html(self.options.noColor); 
<br>         } 
<br>         K(cell).attr('unselectable', 'on'); 
<br>         self._cells.push(cell); 
<br>     }, 
<br>     remove : function() { 
<br>         var self = this; 
<br>         _each(self._cells, function() { 
<br>             this.unbind(); 
<br>         }); 
<br>         KColorPicker.parent.remove.call(self); 
<br>         return self; 
<br>     } 
<br> }); 
<br> function _colorpicker(options) { 
<br>     return new KColorPicker(options); 
<br> } 
<br> K.colorpicker = _colorpicker; 
<br> function KUploadButton(options) { 
<br>     this.init(options); 
<br> } 
<br> _extend(KUploadButton, { 
<br>     init : function(options) { 
<br>         var self = this, 
<br>             button = K(options.button), 
<br>             fieldName = options.fieldName || 'file', 
<br>             url = options.url || '', 
<br>             title = button.val(), 
<br>             extraParams = options.extraParams || {}, 
<br>             cls = button[0].className || '', 
<br>             target = options.target || 'kindeditor_upload_iframe_' + new Date().getTime(); 
<br>         options.afterError = options.afterError || function(str) { 
<br>             alert(str); 
<br>         }; 
<br>         var hiddenElements = []; 
<br>         for(var k in extraParams){ 
<br>             hiddenElements.push('&lt;input type="hidden" name="' + k + '" value="' + extraParams[k] + '" /&gt;'); 
<br>         } 
<br>         var html = [ 
<br>             '&lt;div class="ke-inline-block ' + cls + '"&gt;', 
<br>             (options.target ? '' : '&lt;iframe name="' + target + '" style="display:none;"&gt;&lt;/iframe&gt;'), 
<br>             (options.form ? '&lt;div class="ke-upload-area"&gt;' : '&lt;form class="ke-upload-area ke-form" method="post" enctype="multipart/form-data" target="' + target + '" action="' + url + '"&gt;'), 
<br>             '&lt;span class="ke-button-common"&gt;', 
<br>             hiddenElements.join(''), 
<br>             '&lt;input type="button" class="ke-button-common ke-button" value="' + title + '" /&gt;', 
<br>             '&lt;/span&gt;', 
<br>             '&lt;input type="file" class="ke-upload-file" name="' + fieldName + '" tabindex="-1" /&gt;', 
<br>             (options.form ? '&lt;/div&gt;' : '&lt;/form&gt;'), 
<br>             '&lt;/div&gt;'].join(''); 
<br>         var div = K(html, button.doc); 
<br>         button.hide(); 
<br>         button.before(div); 
<br>         self.div = div; 
<br>         self.button = button; 
<br>         self.iframe = options.target ? K('iframe[name="' + target + '"]') : K('iframe', div); 
<br>         self.form = options.form ? K(options.form) : K('form', div); 
<br>         var width = options.width || K('.ke-button-common', div).width(); 
<br>         self.fileBox = K('.ke-upload-file', div).width(width); 
<br>         self.options = options; 
<br>     }, 
<br>     submit : function() { 
<br>         var self = this, 
<br>             iframe = self.iframe; 
<br>         iframe.bind('load', function() { 
<br>             iframe.unbind(); 
<br>             var tempForm = document.createElement('form'); 
<br>             self.fileBox.before(tempForm); 
<br>             K(tempForm).append(self.fileBox); 
<br>             tempForm.reset(); 
<br>             K(tempForm).remove(true); 
<br>             var doc = K.iframeDoc(iframe), 
<br>                 pre = doc.getElementsByTagName('pre')[0], 
<br>                 str = '', data; 
<br>             if (pre) { 
<br>                 str = pre.innerHTML; 
<br>             } else { 
<br>                 str = doc.body.innerHTML; 
<br>             } 
<br>             iframe[0].src = 'javascript:false'; 
<br>             try { 
<br>                 data = K.json(str); 
<br>             } catch (e) { 
<br>                 self.options.afterError.call(self, '&lt;!doctype html&gt;&lt;html&gt;' + doc.body.parentNode.innerHTML + '&lt;/html&gt;'); 
<br>             } 
<br>             if (data) { 
<br>                 self.options.afterUpload.call(self, data); 
<br>             } 
<br>         }); 
<br>         self.form[0].submit(); 
<br>         return self; 
<br>     }, 
<br>     remove : function() { 
<br>         var self = this; 
<br>         if (self.fileBox) { 
<br>             self.fileBox.unbind(); 
<br>         } 
<br>         self.iframe.remove(); 
<br>         self.div.remove(); 
<br>         self.button.show(); 
<br>         return self; 
<br>     } 
<br> }); 
<br> function _uploadbutton(options) { 
<br>     return new KUploadButton(options); 
<br> } 
<br> K.uploadbutton = _uploadbutton; 
<br> function _createButton(arg) { 
<br>     arg = arg || {}; 
<br>     var name = arg.name || '', 
<br>         span = K('&lt;span class="ke-button-common ke-button-outer" title="' + name + '"&gt;&lt;/span&gt;'), 
<br>         btn = K('&lt;input class="ke-button-common ke-button" type="button" value="' + name + '" /&gt;'); 
<br>     if (arg.click) { 
<br>         btn.click(arg.click); 
<br>     } 
<br>     span.append(btn); 
<br>     return span; 
<br> } 
<br> function KDialog(options) { 
<br>     this.init(options); 
<br> } 
<br> _extend(KDialog, KWidget, { 
<br>     init : function(options) { 
<br>         var self = this; 
<br>         var shadowMode = _undef(options.shadowMode, true); 
<br>         options.z = options.z || 811213; 
<br>         options.shadowMode = false; 
<br>         KDialog.parent.init.call(self, options); 
<br>         var title = options.title, 
<br>             body = K(options.body, self.doc), 
<br>             previewBtn = options.previewBtn, 
<br>             yesBtn = options.yesBtn, 
<br>             noBtn = options.noBtn, 
<br>             closeBtn = options.closeBtn, 
<br>             showMask = _undef(options.showMask, true); 
<br>         self.div.addClass('ke-dialog').bind('click,mousedown', function(e){ 
<br>             e.stopPropagation(); 
<br>         }); 
<br>         var contentDiv = K('&lt;div class="ke-dialog-content"&gt;&lt;/div&gt;').appendTo(self.div); 
<br>         if (_IE &amp;&amp; _V &lt; 7) { 
<br>             self.iframeMask = K('&lt;iframe src="about:blank" class="ke-dialog-shadow"&gt;&lt;/iframe&gt;').appendTo(self.div); 
<br>         } else if (shadowMode) { 
<br>             K('&lt;div class="ke-dialog-shadow"&gt;&lt;/div&gt;').appendTo(self.div); 
<br>         } 
<br>         var headerDiv = K('&lt;div class="ke-dialog-header"&gt;&lt;/div&gt;'); 
<br>         contentDiv.append(headerDiv); 
<br>         headerDiv.html(title); 
<br>         self.closeIcon = K('&lt;span class="ke-dialog-icon-close" title="' + closeBtn.name + '"&gt;&lt;/span&gt;').click(closeBtn.click); 
<br>         headerDiv.append(self.closeIcon); 
<br>         self.draggable({ 
<br>             clickEl : headerDiv, 
<br>             beforeDrag : options.beforeDrag 
<br>         }); 
<br>         var bodyDiv = K('&lt;div class="ke-dialog-body"&gt;&lt;/div&gt;'); 
<br>         contentDiv.append(bodyDiv); 
<br>         bodyDiv.append(body); 
<br>         var footerDiv = K('&lt;div class="ke-dialog-footer"&gt;&lt;/div&gt;'); 
<br>         if (previewBtn || yesBtn || noBtn) { 
<br>             contentDiv.append(footerDiv); 
<br>         } 
<br>         _each([ 
<br>             { btn : previewBtn, name : 'preview' }, 
<br>             { btn : yesBtn, name : 'yes' }, 
<br>             { btn : noBtn, name : 'no' } 
<br>         ], function() { 
<br>             if (this.btn) { 
<br>                 var button = _createButton(this.btn); 
<br>                 button.addClass('ke-dialog-' + this.name); 
<br>                 footerDiv.append(button); 
<br>             } 
<br>         }); 
<br>         if (self.height) { 
<br>             bodyDiv.height(_removeUnit(self.height) - headerDiv.height() - footerDiv.height()); 
<br>         } 
<br>         self.div.width(self.div.width()); 
<br>         self.div.height(self.div.height()); 
<br>         self.mask = null; 
<br>         if (showMask) { 
<br>             var docEl = _docElement(self.doc), 
<br>                 docWidth = Math.max(docEl.scrollWidth, docEl.clientWidth), 
<br>                 docHeight = Math.max(docEl.scrollHeight, docEl.clientHeight); 
<br>             self.mask = _widget({ 
<br>                 x : 0, 
<br>                 y : 0, 
<br>                 z : self.z - 1, 
<br>                 cls : 'ke-dialog-mask', 
<br>                 width : docWidth, 
<br>                 height : docHeight 
<br>             }); 
<br>         } 
<br>         self.autoPos(self.div.width(), self.div.height()); 
<br>         self.footerDiv = footerDiv; 
<br>         self.bodyDiv = bodyDiv; 
<br>         self.headerDiv = headerDiv; 
<br>         self.isLoading = false; 
<br>     }, 
<br>     setMaskIndex : function(z) { 
<br>         var self = this; 
<br>         self.mask.div.css('z-index', z); 
<br>     }, 
<br>     showLoading : function(msg) { 
<br>         msg = _undef(msg, ''); 
<br>         var self = this, body = self.bodyDiv; 
<br>         self.loading = K('&lt;div class="ke-dialog-loading"&gt;&lt;div class="ke-inline-block ke-dialog-loading-content" style="margin-top:' + Math.round(body.height() / 3) + 'px;"&gt;' + msg + '&lt;/div&gt;&lt;/div&gt;') 
<br>             .width(body.width()).height(body.height()) 
<br>             .css('top', self.headerDiv.height() + 'px'); 
<br>         body.css('visibility', 'hidden').after(self.loading); 
<br>         self.isLoading = true; 
<br>         return self; 
<br>     }, 
<br>     hideLoading : function() { 
<br>         this.loading &amp;&amp; this.loading.remove(); 
<br>         this.bodyDiv.css('visibility', 'visible'); 
<br>         this.isLoading = false; 
<br>         return this; 
<br>     }, 
<br>     remove : function() { 
<br>         var self = this; 
<br>         if (self.options.beforeRemove) { 
<br>             self.options.beforeRemove.call(self); 
<br>         } 
<br>         self.mask &amp;&amp; self.mask.remove(); 
<br>         self.iframeMask &amp;&amp; self.iframeMask.remove(); 
<br>         self.closeIcon.unbind(); 
<br>         K('input', self.div).unbind(); 
<br>         K('button', self.div).unbind(); 
<br>         self.footerDiv.unbind(); 
<br>         self.bodyDiv.unbind(); 
<br>         self.headerDiv.unbind(); 
<br>         K('iframe', self.div).each(function() { 
<br>             K(this).remove(); 
<br>         }); 
<br>         KDialog.parent.remove.call(self); 
<br>         return self; 
<br>     } 
<br> }); 
<br> function _dialog(options) { 
<br>     return new KDialog(options); 
<br> } 
<br> K.dialog = _dialog; 
<br> function _tabs(options) { 
<br>     var self = _widget(options), 
<br>         remove = self.remove, 
<br>         afterSelect = options.afterSelect, 
<br>         div = self.div, 
<br>         liList = []; 
<br>     div.addClass('ke-tabs') 
<br>         .bind('contextmenu,mousedown,mousemove', function(e) { 
<br>             e.preventDefault(); 
<br>         }); 
<br>     var ul = K('&lt;ul class="ke-tabs-ul ke-clearfix"&gt;&lt;/ul&gt;'); 
<br>     div.append(ul); 
<br>     self.add = function(tab) { 
<br>         var li = K('&lt;li class="ke-tabs-li"&gt;' + tab.title + '&lt;/li&gt;'); 
<br>         li.data('tab', tab); 
<br>         liList.push(li); 
<br>         ul.append(li); 
<br>     }; 
<br>     self.selectedIndex = 0; 
<br>     self.select = function(index) { 
<br>         self.selectedIndex = index; 
<br>         _each(liList, function(i, li) { 
<br>             li.unbind(); 
<br>             if (i === index) { 
<br>                 li.addClass('ke-tabs-li-selected'); 
<br>                 K(li.data('tab').panel).show(''); 
<br>             } else { 
<br>                 li.removeClass('ke-tabs-li-selected').removeClass('ke-tabs-li-on') 
<br>                 .mouseover(function() { 
<br>                     K(this).addClass('ke-tabs-li-on'); 
<br>                 }) 
<br>                 .mouseout(function() { 
<br>                     K(this).removeClass('ke-tabs-li-on'); 
<br>                 }) 
<br>                 .click(function() { 
<br>                     self.select(i); 
<br>                 }); 
<br>                 K(li.data('tab').panel).hide(); 
<br>             } 
<br>         }); 
<br>         if (afterSelect) { 
<br>             afterSelect.call(self, index); 
<br>         } 
<br>     }; 
<br>     self.remove = function() { 
<br>         _each(liList, function() { 
<br>             this.remove(); 
<br>         }); 
<br>         ul.remove(); 
<br>         remove.call(self); 
<br>     }; 
<br>     return self; 
<br> } 
<br> K.tabs = _tabs; 
<br> function _loadScript(url, fn) { 
<br>     var head = document.getElementsByTagName('head')[0] || (_QUIRKS ? document.body : document.documentElement), 
<br>         script = document.createElement('script'); 
<br>     head.appendChild(script); 
<br>     script.src = url; 
<br>     script.charset = 'utf-8'; 
<br>     script.onload = script.onreadystatechange = function() { 
<br>         if (!this.readyState || this.readyState === 'loaded') { 
<br>             if (fn) { 
<br>                 fn(); 
<br>             } 
<br>             script.onload = script.onreadystatechange = null; 
<br>             head.removeChild(script); 
<br>         } 
<br>     }; 
<br> } 
<br> function _chopQuery(url) { 
<br>     var index = url.indexOf('?'); 
<br>     return index &gt; 0 ? url.substr(0, index) : url; 
<br> } 
<br> function _loadStyle(url) { 
<br>     var head = document.getElementsByTagName('head')[0] || (_QUIRKS ? document.body : document.documentElement), 
<br>         link = document.createElement('link'), 
<br>         absoluteUrl = _chopQuery(_formatUrl(url, 'absolute')); 
<br>     var links = K('link[rel="stylesheet"]', head); 
<br>     for (var i = 0, len = links.length; i &lt; len; i++) { 
<br>         if (_chopQuery(_formatUrl(links[i].href, 'absolute')) === absoluteUrl) { 
<br>             return; 
<br>         } 
<br>     } 
<br>     head.appendChild(link); 
<br>     link.href = url; 
<br>     link.rel = 'stylesheet'; 
<br> } 
<br> function _ajax(url, fn, method, param, dataType) { 
<br>     method = method || 'GET'; 
<br>     dataType = dataType || 'json'; 
<br>     var xhr = window.XMLHttpRequest ? new window.XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP'); 
<br>     xhr.open(method, url, true); 
<br>     xhr.onreadystatechange = function () { 
<br>         if (xhr.readyState == 4 &amp;&amp; xhr.status == 200) { 
<br>             if (fn) { 
<br>                 var data = _trim(xhr.responseText); 
<br>                 if (dataType == 'json') { 
<br>                     data = _json(data); 
<br>                 } 
<br>                 fn(data); 
<br>             } 
<br>         } 
<br>     }; 
<br>     if (method == 'POST') { 
<br>         var params = []; 
<br>         _each(param, function(key, val) { 
<br>             params.push(encodeURIComponent(key) + '=' + encodeURIComponent(val)); 
<br>         }); 
<br>         try { 
<br>             xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); 
<br>         } catch (e) {} 
<br>         xhr.send(params.join('&amp;')); 
<br>     } else { 
<br>         xhr.send(null); 
<br>     } 
<br> } 
<br> K.loadScript = _loadScript; 
<br> K.loadStyle = _loadStyle; 
<br> K.ajax = _ajax; 
<br> var _plugins = {}; 
<br> function _plugin(name, fn) { 
<br>     if (name === undefined) { 
<br>         return _plugins; 
<br>     } 
<br>     if (!fn) { 
<br>         return _plugins[name]; 
<br>     } 
<br>     _plugins[name] = fn; 
<br> } 
<br> var _language = {}; 
<br> function _parseLangKey(key) { 
<br>     var match, ns = 'core'; 
<br>     if ((match = /^(\w+)\.(\w+)$/.exec(key))) { 
<br>         ns = match[1]; 
<br>         key = match[2]; 
<br>     } 
<br>     return { ns : ns, key : key }; 
<br> } 
<br> function _lang(mixed, langType) { 
<br>     langType = langType === undefined ? K.options.langType : langType; 
<br>     if (typeof mixed === 'string') { 
<br>         if (!_language[langType]) { 
<br>             return 'no language'; 
<br>         } 
<br>         var pos = mixed.length - 1; 
<br>         if (mixed.substr(pos) === '.') { 
<br>             return _language[langType][mixed.substr(0, pos)]; 
<br>         } 
<br>         var obj = _parseLangKey(mixed); 
<br>         return _language[langType][obj.ns][obj.key]; 
<br>     } 
<br>     _each(mixed, function(key, val) { 
<br>         var obj = _parseLangKey(key); 
<br>         if (!_language[langType]) { 
<br>             _language[langType] = {}; 
<br>         } 
<br>         if (!_language[langType][obj.ns]) { 
<br>             _language[langType][obj.ns] = {}; 
<br>         } 
<br>         _language[langType][obj.ns][obj.key] = val; 
<br>     }); 
<br> } 
<br> function _getImageFromRange(range, fn) { 
<br>     if (range.collapsed) { 
<br>         return; 
<br>     } 
<br>     range = range.cloneRange().up(); 
<br>     var sc = range.startContainer, so = range.startOffset; 
<br>     if (!_WEBKIT &amp;&amp; !range.isControl()) { 
<br>         return; 
<br>     } 
<br>     var img = K(sc.childNodes[so]); 
<br>     if (!img || img.name != 'img') { 
<br>         return; 
<br>     } 
<br>     if (fn(img)) { 
<br>         return img; 
<br>     } 
<br> } 
<br> function _bindContextmenuEvent() { 
<br>     var self = this, doc = self.edit.doc; 
<br>     K(doc).contextmenu(function(e) { 
<br>         if (self.menu) { 
<br>             self.hideMenu(); 
<br>         } 
<br>         if (!self.useContextmenu) { 
<br>             e.preventDefault(); 
<br>             return; 
<br>         } 
<br>         if (self._contextmenus.length === 0) { 
<br>             return; 
<br>         } 
<br>         var maxWidth = 0, items = []; 
<br>         _each(self._contextmenus, function() { 
<br>             if (this.title == '-') { 
<br>                 items.push(this); 
<br>                 return; 
<br>             } 
<br>             if (this.cond &amp;&amp; this.cond()) { 
<br>                 items.push(this); 
<br>                 if (this.width &amp;&amp; this.width &gt; maxWidth) { 
<br>                     maxWidth = this.width; 
<br>                 } 
<br>             } 
<br>         }); 
<br>         while (items.length &gt; 0 &amp;&amp; items[0].title == '-') { 
<br>             items.shift(); 
<br>         } 
<br>         while (items.length &gt; 0 &amp;&amp; items[items.length - 1].title == '-') { 
<br>             items.pop(); 
<br>         } 
<br>         var prevItem = null; 
<br>         _each(items, function(i) { 
<br>             if (this.title == '-' &amp;&amp; prevItem.title == '-') { 
<br>                 delete items[i]; 
<br>             } 
<br>             prevItem = this; 
<br>         }); 
<br>         if (items.length &gt; 0) { 
<br>             e.preventDefault(); 
<br>             var pos = K(self.edit.iframe).pos(), 
<br>                 menu = _menu({ 
<br>                     x : pos.x + e.clientX, 
<br>                     y : pos.y + e.clientY, 
<br>                     width : maxWidth, 
<br>                     css : { visibility: 'hidden' }, 
<br>                     shadowMode : self.shadowMode 
<br>                 }); 
<br>             _each(items, function() { 
<br>                 if (this.title) { 
<br>                     menu.addItem(this); 
<br>                 } 
<br>             }); 
<br>             var docEl = _docElement(menu.doc), 
<br>                 menuHeight = menu.div.height(); 
<br>             if (e.clientY + menuHeight &gt;= docEl.clientHeight - 100) { 
<br>                 menu.pos(menu.x, _removeUnit(menu.y) - menuHeight); 
<br>             } 
<br>             menu.div.css('visibility', 'visible'); 
<br>             self.menu = menu; 
<br>         } 
<br>     }); 
<br> } 
<br> function _bindNewlineEvent() { 
<br>     var self = this, doc = self.edit.doc, newlineTag = self.newlineTag; 
<br>     if (_IE &amp;&amp; newlineTag !== 'br') { 
<br>         return; 
<br>     } 
<br>     if (_GECKO &amp;&amp; _V &lt; 3 &amp;&amp; newlineTag !== 'p') { 
<br>         return; 
<br>     } 
<br>     if (_OPERA &amp;&amp; _V &lt; 9) { 
<br>         return; 
<br>     } 
<br>     var brSkipTagMap = _toMap('h1,h2,h3,h4,h5,h6,pre,li'), 
<br>         pSkipTagMap = _toMap('p,h1,h2,h3,h4,h5,h6,pre,li,blockquote'); 
<br>     function getAncestorTagName(range) { 
<br>         var ancestor = K(range.commonAncestor()); 
<br>         while (ancestor) { 
<br>             if (ancestor.type == 1 &amp;&amp; !ancestor.isStyle()) { 
<br>                 break; 
<br>             } 
<br>             ancestor = ancestor.parent(); 
<br>         } 
<br>         return ancestor.name; 
<br>     } 
<br>     K(doc).keydown(function(e) { 
<br>         if (e.which != 13 || e.shiftKey || e.ctrlKey || e.altKey) { 
<br>             return; 
<br>         } 
<br>         self.cmd.selection(); 
<br>         var tagName = getAncestorTagName(self.cmd.range); 
<br>         if (tagName == 'marquee' || tagName == 'select') { 
<br>             return; 
<br>         } 
<br>         if (newlineTag === 'br' &amp;&amp; !brSkipTagMap[tagName]) { 
<br>             e.preventDefault(); 
<br>             self.insertHtml('&lt;br /&gt;' + (_IE &amp;&amp; _V &lt; 9 ? '' : '\u200B')); 
<br>             return; 
<br>         } 
<br>         if (!pSkipTagMap[tagName]) { 
<br>             _nativeCommand(doc, 'formatblock', '&lt;p&gt;'); 
<br>         } 
<br>     }); 
<br>     K(doc).keyup(function(e) { 
<br>         if (e.which != 13 || e.shiftKey || e.ctrlKey || e.altKey) { 
<br>             return; 
<br>         } 
<br>         if (newlineTag == 'br') { 
<br>             return; 
<br>         } 
<br>         self.cmd.selection(); 
<br>         var tagName = getAncestorTagName(self.cmd.range); 
<br>         if (tagName == 'marquee' || tagName == 'select') { 
<br>             return; 
<br>         } 
<br>         if (!pSkipTagMap[tagName]) { 
<br>             _nativeCommand(doc, 'formatblock', '&lt;p&gt;'); 
<br>         } 
<br>         var div = self.cmd.commonAncestor('div'); 
<br>         if (div) { 
<br>             var p = K('&lt;p&gt;&lt;/p&gt;'), 
<br>                 child = div[0].firstChild; 
<br>             while (child) { 
<br>                 var next = child.nextSibling; 
<br>                 p.append(child); 
<br>                 child = next; 
<br>             } 
<br>             div.before(p); 
<br>             div.remove(); 
<br>             self.cmd.range.selectNodeContents(p[0]); 
<br>             self.cmd.select(); 
<br>         } 
<br>     }); 
<br> } 
<br> function _bindTabEvent() { 
<br>     var self = this, doc = self.edit.doc; 
<br>     K(doc).keydown(function(e) { 
<br>         if (e.which == 9) { 
<br>             e.preventDefault(); 
<br>             if (self.afterTab) { 
<br>                 self.afterTab.call(self, e); 
<br>                 return; 
<br>             } 
<br>             var cmd = self.cmd, range = cmd.range; 
<br>             range.shrink(); 
<br>             if (range.collapsed &amp;&amp; range.startContainer.nodeType == 1) { 
<br>                 range.insertNode(K('@&amp;nbsp;', doc)[0]); 
<br>                 cmd.select(); 
<br>             } 
<br>             self.insertHtml('&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;'); 
<br>         } 
<br>     }); 
<br> } 
<br> function _bindFocusEvent() { 
<br>     var self = this; 
<br>     K(self.edit.textarea[0], self.edit.win).focus(function(e) { 
<br>         if (self.afterFocus) { 
<br>             self.afterFocus.call(self, e); 
<br>         } 
<br>     }).blur(function(e) { 
<br>         if (self.afterBlur) { 
<br>             self.afterBlur.call(self, e); 
<br>         } 
<br>     }); 
<br> } 
<br> function _removeBookmarkTag(html) { 
<br>     return _trim(html.replace(/&lt;span [^&gt;]*id="?__kindeditor_bookmark_\w+_\d+__"?[^&gt;]*&gt;&lt;\/span&gt;/ig, '')); 
<br> } 
<br> function _removeTempTag(html) { 
<br>     return html.replace(/&lt;div[^&gt;]+class="?__kindeditor_paste__"?[^&gt;]*&gt;[\s\S]*?&lt;\/div&gt;/ig, ''); 
<br> } 
<br> function _addBookmarkToStack(stack, bookmark) { 
<br>     if (stack.length === 0) { 
<br>         stack.push(bookmark); 
<br>         return; 
<br>     } 
<br>     var prev = stack[stack.length - 1]; 
<br>     if (_removeBookmarkTag(bookmark.html) !== _removeBookmarkTag(prev.html)) { 
<br>         stack.push(bookmark); 
<br>     } 
<br> } 
<br> function _undoToRedo(fromStack, toStack) { 
<br>     var self = this, edit = self.edit, 
<br>         body = edit.doc.body, 
<br>         range, bookmark; 
<br>     if (fromStack.length === 0) { 
<br>         return self; 
<br>     } 
<br>     if (edit.designMode) { 
<br>         range = self.cmd.range; 
<br>         bookmark = range.createBookmark(true); 
<br>         bookmark.html = body.innerHTML; 
<br>     } else { 
<br>         bookmark = { 
<br>             html : body.innerHTML 
<br>         }; 
<br>     } 
<br>     _addBookmarkToStack(toStack, bookmark); 
<br>     var prev = fromStack.pop(); 
<br>     if (_removeBookmarkTag(bookmark.html) === _removeBookmarkTag(prev.html) &amp;&amp; fromStack.length &gt; 0) { 
<br>         prev = fromStack.pop(); 
<br>     } 
<br>     if (edit.designMode) { 
<br>         edit.html(prev.html); 
<br>         if (prev.start) { 
<br>             range.moveToBookmark(prev); 
<br>             self.select(); 
<br>         } 
<br>     } else { 
<br>         K(body).html(_removeBookmarkTag(prev.html)); 
<br>     } 
<br>     return self; 
<br> } 
<br> function KEditor(options) { 
<br>     var self = this; 
<br>     self.options = {}; 
<br>     function setOption(key, val) { 
<br>         if (KEditor.prototype[key] === undefined) { 
<br>             self[key] = val; 
<br>         } 
<br>         self.options[key] = val; 
<br>     } 
<br>     _each(options, function(key, val) { 
<br>         setOption(key, options[key]); 
<br>     }); 
<br>     _each(K.options, function(key, val) { 
<br>         if (self[key] === undefined) { 
<br>             setOption(key, val); 
<br>         } 
<br>     }); 
<br>     var se = K(self.srcElement || '&lt;textarea/&gt;'); 
<br>     if (!self.width) { 
<br>         self.width = se[0].style.width || se.width(); 
<br>     } 
<br>     if (!self.height) { 
<br>         self.height = se[0].style.height || se.height(); 
<br>     } 
<br>     setOption('width', _undef(self.width, self.minWidth)); 
<br>     setOption('height', _undef(self.height, self.minHeight)); 
<br>     setOption('width', _addUnit(self.width)); 
<br>     setOption('height', _addUnit(self.height)); 
<br>     if (_MOBILE &amp;&amp; (!_IOS || _V &lt; 534)) { 
<br>         self.designMode = false; 
<br>     } 
<br>     self.srcElement = se; 
<br>     self.initContent = ''; 
<br>     self.plugin = {}; 
<br>     self.isCreated = false; 
<br>     self.isLoading = false; 
<br>     self._handlers = {}; 
<br>     self._contextmenus = []; 
<br>     self._undoStack = []; 
<br>     self._redoStack = []; 
<br>     self._calledPlugins = {}; 
<br>     self._firstAddBookmark = true; 
<br>     self.menu = self.contextmenu = null; 
<br>     self.dialogs = []; 
<br> } 
<br> KEditor.prototype = { 
<br>     lang : function(mixed) { 
<br>         return _lang(mixed, this.langType); 
<br>     }, 
<br>     loadPlugin : function(name, fn) { 
<br>         var self = this; 
<br>         if (_plugins[name]) { 
<br>             if (self._calledPlugins[name]) { 
<br>                 if (fn) { 
<br>                     fn.call(self); 
<br>                 } 
<br>                 return self; 
<br>             } 
<br>             _plugins[name].call(self, KindEditor); 
<br>             if (fn) { 
<br>                 fn.call(self); 
<br>             } 
<br>             self._calledPlugins[name] = true; 
<br>             return self; 
<br>         } 
<br>         if (self.isLoading) { 
<br>             return self; 
<br>         } 
<br>         self.isLoading = true; 
<br>         _loadScript(self.pluginsPath + name + '/' + name + '.js?ver=' + encodeURIComponent(K.DEBUG ? _TIME : _VERSION), function() { 
<br>             self.isLoading = false; 
<br>             if (_plugins[name]) { 
<br>                 self.loadPlugin(name, fn); 
<br>             } 
<br>         }); 
<br>         return self; 
<br>     }, 
<br>     handler : function(key, fn) { 
<br>         var self = this; 
<br>         if (!self._handlers[key]) { 
<br>             self._handlers[key] = []; 
<br>         } 
<br>         if (_isFunction(fn)) { 
<br>             self._handlers[key].push(fn); 
<br>             return self; 
<br>         } 
<br>         _each(self._handlers[key], function() { 
<br>             fn = this.call(self, fn); 
<br>         }); 
<br>         return fn; 
<br>     }, 
<br>     clickToolbar : function(name, fn) { 
<br>         var self = this, key = 'clickToolbar' + name; 
<br>         if (fn === undefined) { 
<br>             if (self._handlers[key]) { 
<br>                 return self.handler(key); 
<br>             } 
<br>             self.loadPlugin(name, function() { 
<br>                 self.handler(key); 
<br>             }); 
<br>             return self; 
<br>         } 
<br>         return self.handler(key, fn); 
<br>     }, 
<br>     updateState : function() { 
<br>         var self = this; 
<br>         _each(('justifyleft,justifycenter,justifyright,justifyfull,insertorderedlist,insertunorderedlist,' + 
<br>             'subscript,superscript,bold,italic,underline,strikethrough').split(','), function(i, name) { 
<br>             self.cmd.state(name) ? self.toolbar.select(name) : self.toolbar.unselect(name); 
<br>         }); 
<br>         return self; 
<br>     }, 
<br>     addContextmenu : function(item) { 
<br>         this._contextmenus.push(item); 
<br>         return this; 
<br>     }, 
<br>     afterCreate : function(fn) { 
<br>         return this.handler('afterCreate', fn); 
<br>     }, 
<br>     beforeRemove : function(fn) { 
<br>         return this.handler('beforeRemove', fn); 
<br>     }, 
<br>     beforeGetHtml : function(fn) { 
<br>         return this.handler('beforeGetHtml', fn); 
<br>     }, 
<br>     beforeSetHtml : function(fn) { 
<br>         return this.handler('beforeSetHtml', fn); 
<br>     }, 
<br>     afterSetHtml : function(fn) { 
<br>         return this.handler('afterSetHtml', fn); 
<br>     }, 
<br>     create : function() { 
<br>         var self = this, fullscreenMode = self.fullscreenMode; 
<br>         if (self.isCreated) { 
<br>             return self; 
<br>         } 
<br>         if (fullscreenMode) { 
<br>             _docElement().style.overflow = 'hidden'; 
<br>         } else { 
<br>             _docElement().style.overflow = ''; 
<br>         } 
<br>         var width = fullscreenMode ? _docElement().clientWidth + 'px' : self.width, 
<br>             height = fullscreenMode ? _docElement().clientHeight + 'px' : self.height; 
<br>         if ((_IE &amp;&amp; _V &lt; 8) || _QUIRKS) { 
<br>             height = _addUnit(_removeUnit(height) + 2); 
<br>         } 
<br>         var container = self.container = K(self.layout); 
<br>         if (fullscreenMode) { 
<br>             K(document.body).append(container); 
<br>         } else { 
<br>             self.srcElement.before(container); 
<br>         } 
<br>         var toolbarDiv = K('.toolbar', container), 
<br>             editDiv = K('.edit', container), 
<br>             statusbar = self.statusbar = K('.statusbar', container); 
<br>         container.removeClass('container') 
<br>             .addClass('ke-container ke-container-' + self.themeType).css('width', width); 
<br>         if (fullscreenMode) { 
<br>             container.css({ 
<br>                 position : 'absolute', 
<br>                 left : 0, 
<br>                 top : 0, 
<br>                 'z-index' : 811211 
<br>             }); 
<br>             if (!_GECKO) { 
<br>                 self._scrollPos = _getScrollPos(); 
<br>             } 
<br>             window.scrollTo(0, 0); 
<br>             K(document.body).css({ 
<br>                 'height' : '1px', 
<br>                 'overflow' : 'hidden' 
<br>             }); 
<br>             K(document.body.parentNode).css('overflow', 'hidden'); 
<br>             self._fullscreenExecuted = true; 
<br>         } else { 
<br>             if (self._fullscreenExecuted) { 
<br>                 K(document.body).css({ 
<br>                     'height' : '', 
<br>                     'overflow' : '' 
<br>                 }); 
<br>                 K(document.body.parentNode).css('overflow', ''); 
<br>             } 
<br>             if (self._scrollPos) { 
<br>                 window.scrollTo(self._scrollPos.x, self._scrollPos.y); 
<br>             } 
<br>         } 
<br>         var htmlList = []; 
<br>         K.each(self.items, function(i, name) { 
<br>             if (name == '|') { 
<br>                 htmlList.push('&lt;span class="ke-inline-block ke-separator"&gt;&lt;/span&gt;'); 
<br>             } else if (name == '/') { 
<br>                 htmlList.push('&lt;div class="ke-hr"&gt;&lt;/div&gt;'); 
<br>             } else { 
<br>                 htmlList.push('&lt;span class="ke-outline" data-name="' + name + '" title="' + self.lang(name) + '" unselectable="on"&gt;'); 
<br>                 htmlList.push('&lt;span class="ke-toolbar-icon ke-toolbar-icon-url ke-icon-' + name + '" unselectable="on"&gt;&lt;/span&gt;&lt;/span&gt;'); 
<br>             } 
<br>         }); 
<br>         var toolbar = self.toolbar = _toolbar({ 
<br>             src : toolbarDiv, 
<br>             html : htmlList.join(''), 
<br>             noDisableItems : self.noDisableItems, 
<br>             click : function(e, name) { 
<br>                 e.stop(); 
<br>                 if (self.menu) { 
<br>                     var menuName = self.menu.name; 
<br>                     self.hideMenu(); 
<br>                     if (menuName === name) { 
<br>                         return; 
<br>                     } 
<br>                 } 
<br>                 self.clickToolbar(name); 
<br>             } 
<br>         }); 
<br>         var editHeight = _removeUnit(height) - toolbar.div.height(); 
<br>         var edit = self.edit = _edit({ 
<br>             height : editHeight &gt; 0 &amp;&amp; _removeUnit(height) &gt; self.minHeight ? editHeight : self.minHeight, 
<br>             src : editDiv, 
<br>             srcElement : self.srcElement, 
<br>             designMode : self.designMode, 
<br>             themesPath : self.themesPath, 
<br>             bodyClass : self.bodyClass, 
<br>             cssPath : self.cssPath, 
<br>             cssData : self.cssData, 
<br>             beforeGetHtml : function(html) { 
<br>                 html = self.beforeGetHtml(html); 
<br>                 return _formatHtml(html, self.filterMode ? self.htmlTags : null, self.urlType, self.wellFormatMode, self.indentChar); 
<br>             }, 
<br>             beforeSetHtml : function(html) { 
<br>                 html = _formatHtml(html, self.filterMode ? self.htmlTags : null, '', false); 
<br>                 return self.beforeSetHtml(html); 
<br>             }, 
<br>             afterSetHtml : function() { 
<br>                 self.edit = edit = this; 
<br>                 self.afterSetHtml(); 
<br>             }, 
<br>             afterCreate : function() { 
<br>                 self.edit = edit = this; 
<br>                 self.cmd = edit.cmd; 
<br>                 self._docMousedownFn = function(e) { 
<br>                     if (self.menu) { 
<br>                         self.hideMenu(); 
<br>                     } 
<br>                 }; 
<br>                 K(edit.doc, document).mousedown(self._docMousedownFn); 
<br>                 _bindContextmenuEvent.call(self); 
<br>                 _bindNewlineEvent.call(self); 
<br>                 _bindTabEvent.call(self); 
<br>                 _bindFocusEvent.call(self); 
<br>                 edit.afterChange(function(e) { 
<br>                     if (!edit.designMode) { 
<br>                         return; 
<br>                     } 
<br>                     self.updateState(); 
<br>                     self.addBookmark(); 
<br>                     if (self.options.afterChange) { 
<br>                         self.options.afterChange.call(self); 
<br>                     } 
<br>                 }); 
<br>                 edit.textarea.keyup(function(e) { 
<br>                     if (!e.ctrlKey &amp;&amp; !e.altKey &amp;&amp; _INPUT_KEY_MAP[e.which]) { 
<br>                         if (self.options.afterChange) { 
<br>                             self.options.afterChange.call(self); 
<br>                         } 
<br>                     } 
<br>                 }); 
<br>                 if (self.readonlyMode) { 
<br>                     self.readonly(); 
<br>                 } 
<br>                 self.isCreated = true; 
<br>                 if (self.initContent === '') { 
<br>                     self.initContent = self.html(); 
<br>                 } 
<br>                 self.afterCreate(); 
<br>                 if (self.options.afterCreate) { 
<br>                     self.options.afterCreate.call(self); 
<br>                 } 
<br>             } 
<br>         }); 
<br>         statusbar.removeClass('statusbar').addClass('ke-statusbar') 
<br>             .append('&lt;span class="ke-inline-block ke-statusbar-center-icon"&gt;&lt;/span&gt;') 
<br>             .append('&lt;span class="ke-inline-block ke-statusbar-right-icon"&gt;&lt;/span&gt;'); 
<br>         K(window).unbind('resize'); 
<br>         function initResize() { 
<br>             if (statusbar.height() === 0) { 
<br>                 setTimeout(initResize, 100); 
<br>                 return; 
<br>             } 
<br>             self.resize(width, height); 
<br>         } 
<br>         initResize(); 
<br>         function newResize(width, height, updateProp) { 
<br>             updateProp = _undef(updateProp, true); 
<br>             if (width &amp;&amp; width &gt;= self.minWidth) { 
<br>                 self.resize(width, null); 
<br>                 if (updateProp) { 
<br>                     self.width = _addUnit(width); 
<br>                 } 
<br>             } 
<br>             if (height &amp;&amp; height &gt;= self.minHeight) { 
<br>                 self.resize(null, height); 
<br>                 if (updateProp) { 
<br>                     self.height = _addUnit(height); 
<br>                 } 
<br>             } 
<br>         } 
<br>         if (fullscreenMode) { 
<br>             K(window).bind('resize', function(e) { 
<br>                 if (self.isCreated) { 
<br>                     newResize(_docElement().clientWidth, _docElement().clientHeight, false); 
<br>                 } 
<br>             }); 
<br>             toolbar.select('fullscreen'); 
<br>             statusbar.first().css('visibility', 'hidden'); 
<br>             statusbar.last().css('visibility', 'hidden'); 
<br>         } else { 
<br>             if (_GECKO) { 
<br>                 K(window).bind('scroll', function(e) { 
<br>                     self._scrollPos = _getScrollPos(); 
<br>                 }); 
<br>             } 
<br>             if (self.resizeType &gt; 0) { 
<br>                 _drag({ 
<br>                     moveEl : container, 
<br>                     clickEl : statusbar, 
<br>                     moveFn : function(x, y, width, height, diffX, diffY) { 
<br>                         height += diffY; 
<br>                         newResize(null, height); 
<br>                     } 
<br>                 }); 
<br>             } else { 
<br>                 statusbar.first().css('visibility', 'hidden'); 
<br>             } 
<br>             if (self.resizeType === 2) { 
<br>                 _drag({ 
<br>                     moveEl : container, 
<br>                     clickEl : statusbar.last(), 
<br>                     moveFn : function(x, y, width, height, diffX, diffY) { 
<br>                         width += diffX; 
<br>                         height += diffY; 
<br>                         newResize(width, height); 
<br>                     } 
<br>                 }); 
<br>             } else { 
<br>                 statusbar.last().css('visibility', 'hidden'); 
<br>             } 
<br>         } 
<br>         return self; 
<br>     }, 
<br>     remove : function() { 
<br>         var self = this; 
<br>         if (!self.isCreated) { 
<br>             return self; 
<br>         } 
<br>         self.beforeRemove(); 
<br>         if (self.menu) { 
<br>             self.hideMenu(); 
<br>         } 
<br>         _each(self.dialogs, function() { 
<br>             self.hideDialog(); 
<br>         }); 
<br>         K(document).unbind('mousedown', self._docMousedownFn); 
<br>         self.toolbar.remove(); 
<br>         self.edit.remove(); 
<br>         self.statusbar.last().unbind(); 
<br>         self.statusbar.unbind(); 
<br>         self.container.remove(); 
<br>         self.container = self.toolbar = self.edit = self.menu = null; 
<br>         self.dialogs = []; 
<br>         self.isCreated = false; 
<br>         return self; 
<br>     }, 
<br>     resize : function(width, height) { 
<br>         var self = this; 
<br>         if (width !== null) { 
<br>             if (_removeUnit(width) &gt; self.minWidth) { 
<br>                 self.container.css('width', _addUnit(width)); 
<br>             } 
<br>         } 
<br>         if (height !== null) { 
<br>             height = _removeUnit(height) - self.toolbar.div.height() - self.statusbar.height(); 
<br>             if (height &gt; 0 &amp;&amp; _removeUnit(height) &gt; self.minHeight) { 
<br>                 self.edit.setHeight(height); 
<br>             } 
<br>         } 
<br>         return self; 
<br>     }, 
<br>     select : function() { 
<br>         this.isCreated &amp;&amp; this.cmd.select(); 
<br>         return this; 
<br>     }, 
<br>     html : function(val) { 
<br>         var self = this; 
<br>         if (val === undefined) { 
<br>             return self.isCreated ? self.edit.html() : _elementVal(self.srcElement); 
<br>         } 
<br>         self.isCreated ? self.edit.html(val) : _elementVal(self.srcElement, val); 
<br>         return self; 
<br>     }, 
<br>     fullHtml : function() { 
<br>         return this.isCreated ? this.edit.html(undefined, true) : ''; 
<br>     }, 
<br>     text : function(val) { 
<br>         var self = this; 
<br>         if (val === undefined) { 
<br>             return _trim(self.html().replace(/&lt;(?!img|embed).*?&gt;/ig, '').replace(/&amp;nbsp;/ig, ' ')); 
<br>         } else { 
<br>             return self.html(_escape(val)); 
<br>         } 
<br>     }, 
<br>     isEmpty : function() { 
<br>         return _trim(this.text().replace(/\r\n|\n|\r/, '')) === ''; 
<br>     }, 
<br>     isDirty : function() { 
<br>         return _trim(this.initContent.replace(/\r\n|\n|\r|t/g, '')) !== _trim(this.html().replace(/\r\n|\n|\r|t/g, '')); 
<br>     }, 
<br>     selectedHtml : function() { 
<br>         return this.isCreated ? this.cmd.range.html() : ''; 
<br>     }, 
<br>     count : function(mode) { 
<br>         var self = this; 
<br>         mode = (mode || 'html').toLowerCase(); 
<br>         if (mode === 'html') { 
<br>             return _removeBookmarkTag(_removeTempTag(self.html())).length; 
<br>         } 
<br>         if (mode === 'text') { 
<br>             return self.text().replace(/&lt;(?:img|embed).*?&gt;/ig, 'K').replace(/\r\n|\n|\r/g, '').length; 
<br>         } 
<br>         return 0; 
<br>     }, 
<br>     exec : function(key) { 
<br>         key = key.toLowerCase(); 
<br>         var self = this, cmd = self.cmd, 
<br>             changeFlag = _inArray(key, 'selectall,copy,paste,print'.split(',')) &lt; 0; 
<br>         if (changeFlag) { 
<br>             self.addBookmark(false); 
<br>         } 
<br>         cmd[key].apply(cmd, _toArray(arguments, 1)); 
<br>         if (changeFlag) { 
<br>             self.updateState(); 
<br>             self.addBookmark(false); 
<br>             if (self.options.afterChange) { 
<br>                 self.options.afterChange.call(self); 
<br>             } 
<br>         } 
<br>         return self; 
<br>     }, 
<br>     insertHtml : function(val) { 
<br>         if (!this.isCreated) { 
<br>             return this; 
<br>         } 
<br>         val = this.beforeSetHtml(val); 
<br>         this.exec('inserthtml', val); 
<br>         return this; 
<br>     }, 
<br>     appendHtml : function(val) { 
<br>         this.html(this.html() + val); 
<br>         if (this.isCreated) { 
<br>             var cmd = this.cmd; 
<br>             cmd.range.selectNodeContents(cmd.doc.body).collapse(false); 
<br>             cmd.select(); 
<br>         } 
<br>         return this; 
<br>     }, 
<br>     sync : function() { 
<br>         _elementVal(this.srcElement, this.html()); 
<br>         return this; 
<br>     }, 
<br>     focus : function() { 
<br>         this.isCreated ? this.edit.focus() : this.srcElement[0].focus(); 
<br>         return this; 
<br>     }, 
<br>     blur : function() { 
<br>         this.isCreated ? this.edit.blur() : this.srcElement[0].blur(); 
<br>         return this; 
<br>     }, 
<br>     addBookmark : function(checkSize) { 
<br>         checkSize = _undef(checkSize, true); 
<br>         var self = this, edit = self.edit, 
<br>             body = edit.doc.body, 
<br>             html = _removeTempTag(body.innerHTML), bookmark; 
<br>         if (checkSize &amp;&amp; self._undoStack.length &gt; 0) { 
<br>             var prev = self._undoStack[self._undoStack.length - 1]; 
<br>             if (Math.abs(html.length -  _removeBookmarkTag(prev.html).length) &lt; self.minChangeSize) { 
<br>                 return self; 
<br>             } 
<br>         } 
<br>         if (edit.designMode &amp;&amp; !self._firstAddBookmark) { 
<br>             var range = self.cmd.range; 
<br>             bookmark = range.createBookmark(true); 
<br>             bookmark.html = _removeTempTag(body.innerHTML); 
<br>             range.moveToBookmark(bookmark); 
<br>         } else { 
<br>             bookmark = { 
<br>                 html : html 
<br>             }; 
<br>         } 
<br>         self._firstAddBookmark = false; 
<br>         _addBookmarkToStack(self._undoStack, bookmark); 
<br>         return self; 
<br>     }, 
<br>     undo : function() { 
<br>         return _undoToRedo.call(this, this._undoStack, this._redoStack); 
<br>     }, 
<br>     redo : function() { 
<br>         return _undoToRedo.call(this, this._redoStack, this._undoStack); 
<br>     }, 
<br>     fullscreen : function(bool) { 
<br>         this.fullscreenMode = (bool === undefined ? !this.fullscreenMode : bool); 
<br>         return this.remove().create(); 
<br>     }, 
<br>     readonly : function(isReadonly) { 
<br>         isReadonly = _undef(isReadonly, true); 
<br>         var self = this, edit = self.edit, doc = edit.doc; 
<br>         if (self.designMode) { 
<br>             self.toolbar.disableAll(isReadonly, []); 
<br>         } else { 
<br>             _each(self.noDisableItems, function() { 
<br>                 self.toolbar[isReadonly ? 'disable' : 'enable'](this); 
<br>             }); 
<br>         } 
<br>         if (_IE) { 
<br>             doc.body.contentEditable = !isReadonly; 
<br>         } else { 
<br>             doc.designMode = isReadonly ? 'off' : 'on'; 
<br>         } 
<br>         edit.textarea[0].disabled = isReadonly; 
<br>     }, 
<br>     createMenu : function(options) { 
<br>         var self = this, 
<br>             name = options.name, 
<br>             knode = self.toolbar.get(name), 
<br>             pos = knode.pos(); 
<br>         options.x = pos.x; 
<br>         options.y = pos.y + knode.height(); 
<br>         options.shadowMode = _undef(options.shadowMode, self.shadowMode); 
<br>         if (options.selectedColor !== undefined) { 
<br>             options.cls = 'ke-colorpicker-' + self.themeType; 
<br>             options.noColor = self.lang('noColor'); 
<br>             self.menu = _colorpicker(options); 
<br>         } else { 
<br>             options.cls = 'ke-menu-' + self.themeType; 
<br>             options.centerLineMode = false; 
<br>             self.menu = _menu(options); 
<br>         } 
<br>         return self.menu; 
<br>     }, 
<br>     hideMenu : function() { 
<br>         this.menu.remove(); 
<br>         this.menu = null; 
<br>         return this; 
<br>     }, 
<br>     hideContextmenu : function() { 
<br>         this.contextmenu.remove(); 
<br>         this.contextmenu = null; 
<br>         return this; 
<br>     }, 
<br>     createDialog : function(options) { 
<br>         var self = this, name = options.name; 
<br>         options.autoScroll = _undef(options.autoScroll, true); 
<br>         options.shadowMode = _undef(options.shadowMode, self.shadowMode); 
<br>         options.closeBtn = _undef(options.closeBtn, { 
<br>             name : self.lang('close'), 
<br>             click : function(e) { 
<br>                 self.hideDialog(); 
<br>                 if (_IE &amp;&amp; self.cmd) { 
<br>                     self.cmd.select(); 
<br>                 } 
<br>             } 
<br>         }); 
<br>         options.noBtn = _undef(options.noBtn, { 
<br>             name : self.lang(options.yesBtn ? 'no' : 'close'), 
<br>             click : function(e) { 
<br>                 self.hideDialog(); 
<br>                 if (_IE &amp;&amp; self.cmd) { 
<br>                     self.cmd.select(); 
<br>                 } 
<br>             } 
<br>         }); 
<br>         if (self.dialogAlignType != 'page') { 
<br>             options.alignEl = self.container; 
<br>         } 
<br>         options.cls = 'ke-dialog-' + self.themeType; 
<br>         if (self.dialogs.length &gt; 0) { 
<br>             var firstDialog = self.dialogs[0], 
<br>                 parentDialog = self.dialogs[self.dialogs.length - 1]; 
<br>             firstDialog.setMaskIndex(parentDialog.z + 2); 
<br>             options.z = parentDialog.z + 3; 
<br>             options.showMask = false; 
<br>         } 
<br>         var dialog = _dialog(options); 
<br>         self.dialogs.push(dialog); 
<br>         return dialog; 
<br>     }, 
<br>     hideDialog : function() { 
<br>         var self = this; 
<br>         if (self.dialogs.length &gt; 0) { 
<br>             self.dialogs.pop().remove(); 
<br>         } 
<br>         if (self.dialogs.length &gt; 0) { 
<br>             var firstDialog = self.dialogs[0], 
<br>                 parentDialog = self.dialogs[self.dialogs.length - 1]; 
<br>             firstDialog.setMaskIndex(parentDialog.z - 1); 
<br>         } 
<br>         return self; 
<br>     }, 
<br>     errorDialog : function(html) { 
<br>         var self = this; 
<br>         var dialog = self.createDialog({ 
<br>             width : 750, 
<br>             title : self.lang('uploadError'), 
<br>             body : '&lt;div style="padding:10px 20px;"&gt;&lt;iframe frameborder="0" style="width:708px;height:400px;"&gt;&lt;/iframe&gt;&lt;/div&gt;' 
<br>         }); 
<br>         var iframe = K('iframe', dialog.div), doc = K.iframeDoc(iframe); 
<br>         doc.open(); 
<br>         doc.write(html); 
<br>         doc.close(); 
<br>         K(doc.body).css('background-color', '#FFF'); 
<br>         iframe[0].contentWindow.focus(); 
<br>         return self; 
<br>     } 
<br> }; 
<br> function _editor(options) { 
<br>     return new KEditor(options); 
<br> } 
<br> _instances = []; 
<br> function _create(expr, options) { 
<br>     options = options || {}; 
<br>     options.basePath = _undef(options.basePath, K.basePath); 
<br>     options.themesPath = _undef(options.themesPath, options.basePath + 'themes/'); 
<br>     options.langPath = _undef(options.langPath, options.basePath + 'lang/'); 
<br>     options.pluginsPath = _undef(options.pluginsPath, options.basePath + 'plugins/'); 
<br>     if (_undef(options.loadStyleMode, K.options.loadStyleMode)) { 
<br>         var themeType = _undef(options.themeType, K.options.themeType); 
<br>         _loadStyle(options.themesPath + 'default/default.css'); 
<br>         _loadStyle(options.themesPath + themeType + '/' + themeType + '.css'); 
<br>     } 
<br>     function create(editor) { 
<br>         _each(_plugins, function(name, fn) { 
<br>             fn.call(editor, KindEditor); 
<br>         }); 
<br>         return editor.create(); 
<br>     } 
<br>     var knode = K(expr); 
<br>     if (!knode) { 
<br>         return; 
<br>     } 
<br>     if (knode.length &gt; 1) { 
<br>         knode.each(function() { 
<br>             _create(this, options); 
<br>         }); 
<br>         return _instances[0]; 
<br>     } 
<br>     options.srcElement = knode[0]; 
<br>     var editor = new KEditor(options); 
<br>     _instances.push(editor); 
<br>     if (_language[editor.langType]) { 
<br>         return create(editor); 
<br>     } 
<br>     _loadScript(editor.langPath + editor.langType + '.js?ver=' + encodeURIComponent(K.DEBUG ? _TIME : _VERSION), function() { 
<br>         create(editor); 
<br>     }); 
<br>     return editor; 
<br> } 
<br> if (_IE &amp;&amp; _V &lt; 7) { 
<br>     _nativeCommand(document, 'BackgroundImageCache', true); 
<br> } 
<br> K.EditorClass = KEditor; 
<br> K.editor = _editor; 
<br> K.create = _create; 
<br> K.instances = _instances; 
<br> K.plugin = _plugin; 
<br> K.lang = _lang; 
<br> _plugin('core', function(K) { 
<br>     var self = this, 
<br>         shortcutKeys = { 
<br>             undo : 'Z', redo : 'Y', bold : 'B', italic : 'I', underline : 'U', print : 'P', selectall : 'A' 
<br>         }; 
<br>     self.afterSetHtml(function() { 
<br>         if (self.options.afterChange) { 
<br>             self.options.afterChange.call(self); 
<br>         } 
<br>     }); 
<br>     self.afterCreate(function() { 
<br>         if (self.syncType != 'form') { 
<br>             return; 
<br>         } 
<br>         var el = K(self.srcElement), hasForm = false; 
<br>         while ((el = el.parent())) { 
<br>             if (el.name == 'form') { 
<br>                 hasForm = true; 
<br>                 break; 
<br>             } 
<br>         } 
<br>         if (hasForm) { 
<br>             el.bind('submit', function(e) { 
<br>                 self.sync(); 
<br>                 K(window).bind('unload', function() { 
<br>                     self.edit.textarea.remove(); 
<br>                 }); 
<br>             }); 
<br>             var resetBtn = K('[type="reset"]', el); 
<br>             resetBtn.click(function() { 
<br>                 self.html(self.initContent); 
<br>                 self.cmd.selection(); 
<br>             }); 
<br>             self.beforeRemove(function() { 
<br>                 el.unbind(); 
<br>                 resetBtn.unbind(); 
<br>             }); 
<br>         } 
<br>     }); 
<br>     self.clickToolbar('source', function() { 
<br>         if (self.edit.designMode) { 
<br>             self.toolbar.disableAll(true); 
<br>             self.edit.design(false); 
<br>             self.toolbar.select('source'); 
<br>         } else { 
<br>             self.toolbar.disableAll(false); 
<br>             self.edit.design(true); 
<br>             self.toolbar.unselect('source'); 
<br>         } 
<br>         self.designMode = self.edit.designMode; 
<br>     }); 
<br>     self.afterCreate(function() { 
<br>         if (!self.designMode) { 
<br>             self.toolbar.disableAll(true).select('source'); 
<br>         } 
<br>     }); 
<br>     self.clickToolbar('fullscreen', function() { 
<br>         self.fullscreen(); 
<br>     }); 
<br>     if (self.fullscreenShortcut) { 
<br>         var loaded = false; 
<br>         self.afterCreate(function() { 
<br>             K(self.edit.doc, self.edit.textarea).keyup(function(e) { 
<br>                 if (e.which == 27) { 
<br>                     setTimeout(function() { 
<br>                         self.fullscreen(); 
<br>                     }, 0); 
<br>                 } 
<br>             }); 
<br>             if (loaded) { 
<br>                 if (_IE &amp;&amp; !self.designMode) { 
<br>                     return; 
<br>                 } 
<br>                 self.focus(); 
<br>             } 
<br>             if (!loaded) { 
<br>                 loaded = true; 
<br>             } 
<br>         }); 
<br>     } 
<br>     _each('undo,redo'.split(','), function(i, name) { 
<br>         if (shortcutKeys[name]) { 
<br>             self.afterCreate(function() { 
<br>                 _ctrl(this.edit.doc, shortcutKeys[name], function() { 
<br>                     self.clickToolbar(name); 
<br>                 }); 
<br>             }); 
<br>         } 
<br>         self.clickToolbar(name, function() { 
<br>             self[name](); 
<br>         }); 
<br>     }); 
<br>     self.clickToolbar('formatblock', function() { 
<br>         var blocks = self.lang('formatblock.formatBlock'), 
<br>             heights = { 
<br>                 h1 : 28, 
<br>                 h2 : 24, 
<br>                 h3 : 18, 
<br>                 H4 : 14, 
<br>                 p : 12 
<br>             }, 
<br>             curVal = self.cmd.val('formatblock'), 
<br>             menu = self.createMenu({ 
<br>                 name : 'formatblock', 
<br>                 width : self.langType == 'en' ? 200 : 150 
<br>             }); 
<br>         _each(blocks, function(key, val) { 
<br>             var style = 'font-size:' + heights[key] + 'px;'; 
<br>             if (key.charAt(0) === 'h') { 
<br>                 style += 'font-weight:bold;'; 
<br>             } 
<br>             menu.addItem({ 
<br>                 title : '&lt;span style="' + style + '" unselectable="on"&gt;' + val + '&lt;/span&gt;', 
<br>                 height : heights[key] + 12, 
<br>                 checked : (curVal === key || curVal === val), 
<br>                 click : function() { 
<br>                     self.select().exec('formatblock', '&lt;' + key + '&gt;').hideMenu(); 
<br>                 } 
<br>             }); 
<br>         }); 
<br>     }); 
<br>     self.clickToolbar('fontname', function() { 
<br>         var curVal = self.cmd.val('fontname'), 
<br>             menu = self.createMenu({ 
<br>                 name : 'fontname', 
<br>                 width : 150 
<br>             }); 
<br>         _each(self.lang('fontname.fontName'), function(key, val) { 
<br>             menu.addItem({ 
<br>                 title : '&lt;span style="font-family: ' + key + ';" unselectable="on"&gt;' + val + '&lt;/span&gt;', 
<br>                 checked : (curVal === key.toLowerCase() || curVal === val.toLowerCase()), 
<br>                 click : function() { 
<br>                     self.exec('fontname', key).hideMenu(); 
<br>                 } 
<br>             }); 
<br>         }); 
<br>     }); 
<br>     self.clickToolbar('fontsize', function() { 
<br>         var curVal = self.cmd.val('fontsize'), 
<br>             menu = self.createMenu({ 
<br>                 name : 'fontsize', 
<br>                 width : 150 
<br>             }); 
<br>         _each(self.fontSizeTable, function(i, val) { 
<br>             menu.addItem({ 
<br>                 title : '&lt;span style="font-size:' + val + ';" unselectable="on"&gt;' + val + '&lt;/span&gt;', 
<br>                 height : _removeUnit(val) + 12, 
<br>                 checked : curVal === val, 
<br>                 click : function() { 
<br>                     self.exec('fontsize', val).hideMenu(); 
<br>                 } 
<br>             }); 
<br>         }); 
<br>     }); 
<br>     _each('forecolor,hilitecolor'.split(','), function(i, name) { 
<br>         self.clickToolbar(name, function() { 
<br>             self.createMenu({ 
<br>                 name : name, 
<br>                 selectedColor : self.cmd.val(name) || 'default', 
<br>                 colors : self.colorTable, 
<br>                 click : function(color) { 
<br>                     self.exec(name, color).hideMenu(); 
<br>                 } 
<br>             }); 
<br>         }); 
<br>     }); 
<br>     _each(('cut,copy,paste').split(','), function(i, name) { 
<br>         self.clickToolbar(name, function() { 
<br>             self.focus(); 
<br>             try { 
<br>                 self.exec(name, null); 
<br>             } catch(e) { 
<br>                 alert(self.lang(name + 'Error')); 
<br>             } 
<br>         }); 
<br>     }); 
<br>     self.clickToolbar('about', function() { 
<br>         var html = '&lt;div style="margin:20px;"&gt;' + 
<br>             '&lt;div&gt;KindEditor ' + _VERSION + '&lt;/div&gt;' + 
<br>             '&lt;div&gt;Copyright &amp;copy; &lt;a href="http://www.kindsoft.net/" target="_blank"&gt;kindsoft.net&lt;/a&gt; All rights reserved.&lt;/div&gt;' + 
<br>             '&lt;/div&gt;'; 
<br>         self.createDialog({ 
<br>             name : 'about', 
<br>             width : 300, 
<br>             title : self.lang('about'), 
<br>             body : html 
<br>         }); 
<br>     }); 
<br>     self.plugin.getSelectedLink = function() { 
<br>         return self.cmd.commonAncestor('a'); 
<br>     }; 
<br>     self.plugin.getSelectedImage = function() { 
<br>         return _getImageFromRange(self.edit.cmd.range, function(img) { 
<br>             return !/^ke-\w+$/i.test(img[0].className); 
<br>         }); 
<br>     }; 
<br>     self.plugin.getSelectedFlash = function() { 
<br>         return _getImageFromRange(self.edit.cmd.range, function(img) { 
<br>             return img[0].className == 'ke-flash'; 
<br>         }); 
<br>     }; 
<br>     self.plugin.getSelectedMedia = function() { 
<br>         return _getImageFromRange(self.edit.cmd.range, function(img) { 
<br>             return img[0].className == 'ke-media' || img[0].className == 'ke-rm'; 
<br>         }); 
<br>     }; 
<br>     self.plugin.getSelectedAnchor = function() { 
<br>         return _getImageFromRange(self.edit.cmd.range, function(img) { 
<br>             return img[0].className == 'ke-anchor'; 
<br>         }); 
<br>     }; 
<br>     _each('link,image,flash,media,anchor'.split(','), function(i, name) { 
<br>         var uName = name.charAt(0).toUpperCase() + name.substr(1); 
<br>         _each('edit,delete'.split(','), function(j, val) { 
<br>             self.addContextmenu({ 
<br>                 title : self.lang(val + uName), 
<br>                 click : function() { 
<br>                     self.loadPlugin(name, function() { 
<br>                         self.plugin[name][val](); 
<br>                         self.hideMenu(); 
<br>                     }); 
<br>                 }, 
<br>                 cond : self.plugin['getSelected' + uName], 
<br>                 width : 150, 
<br>                 iconClass : val == 'edit' ? 'ke-icon-' + name : undefined 
<br>             }); 
<br>         }); 
<br>         self.addContextmenu({ title : '-' }); 
<br>     }); 
<br>     self.plugin.getSelectedTable = function() { 
<br>         return self.cmd.commonAncestor('table'); 
<br>     }; 
<br>     self.plugin.getSelectedRow = function() { 
<br>         return self.cmd.commonAncestor('tr'); 
<br>     }; 
<br>     self.plugin.getSelectedCell = function() { 
<br>         return self.cmd.commonAncestor('td'); 
<br>     }; 
<br>     _each(('prop,cellprop,colinsertleft,colinsertright,rowinsertabove,rowinsertbelow,rowmerge,colmerge,' + 
<br>     'rowsplit,colsplit,coldelete,rowdelete,insert,delete').split(','), function(i, val) { 
<br>         var cond = _inArray(val, ['prop', 'delete']) &lt; 0 ? self.plugin.getSelectedCell : self.plugin.getSelectedTable; 
<br>         self.addContextmenu({ 
<br>             title : self.lang('table' + val), 
<br>             click : function() { 
<br>                 self.loadPlugin('table', function() { 
<br>                     self.plugin.table[val](); 
<br>                     self.hideMenu(); 
<br>                 }); 
<br>             }, 
<br>             cond : cond, 
<br>             width : 170, 
<br>             iconClass : 'ke-icon-table' + val 
<br>         }); 
<br>     }); 
<br>     self.addContextmenu({ title : '-' }); 
<br>     _each(('selectall,justifyleft,justifycenter,justifyright,justifyfull,insertorderedlist,' + 
<br>         'insertunorderedlist,indent,outdent,subscript,superscript,hr,print,' + 
<br>         'bold,italic,underline,strikethrough,removeformat,unlink').split(','), function(i, name) { 
<br>         if (shortcutKeys[name]) { 
<br>             self.afterCreate(function() { 
<br>                 _ctrl(this.edit.doc, shortcutKeys[name], function() { 
<br>                     self.cmd.selection(); 
<br>                     self.clickToolbar(name); 
<br>                 }); 
<br>             }); 
<br>         } 
<br>         self.clickToolbar(name, function() { 
<br>             self.focus().exec(name, null); 
<br>         }); 
<br>     }); 
<br>     self.afterCreate(function() { 
<br>         var doc = self.edit.doc, cmd, bookmark, div, 
<br>             cls = '__kindeditor_paste__', pasting = false; 
<br>         function movePastedData() { 
<br>             cmd.range.moveToBookmark(bookmark); 
<br>             cmd.select(); 
<br>             if (_WEBKIT) { 
<br>                 K('div.' + cls, div).each(function() { 
<br>                     K(this).after('&lt;br /&gt;').remove(true); 
<br>                 }); 
<br>                 K('span.Apple-style-span', div).remove(true); 
<br>                 K('span.Apple-tab-span', div).remove(true); 
<br>                 K('span[style]', div).each(function() { 
<br>                     if (K(this).css('white-space') == 'nowrap') { 
<br>                         K(this).remove(true); 
<br>                     } 
<br>                 }); 
<br>                 K('meta', div).remove(); 
<br>             } 
<br>             var html = div[0].innerHTML; 
<br>             div.remove(); 
<br>             if (html === '') { 
<br>                 return; 
<br>             } 
<br>             if (self.pasteType === 2) { 
<br>                 if (/schemas-microsoft-com|worddocument|mso-\w+/i.test(html)) { 
<br>                     html = _clearMsWord(html, self.filterMode ? self.htmlTags : K.options.htmlTags); 
<br>                 } else { 
<br>                     html = _formatHtml(html, self.filterMode ? self.htmlTags : null); 
<br>                     html = self.beforeSetHtml(html); 
<br>                 } 
<br>             } 
<br>             if (self.pasteType === 1) { 
<br>                 html = html.replace(/&lt;br[^&gt;]*&gt;/ig, '\n'); 
<br>                 html = html.replace(/&lt;\/p&gt;&lt;p[^&gt;]*&gt;/ig, '\n'); 
<br>                 html = html.replace(/&lt;[^&gt;]+&gt;/g, ''); 
<br>                 html = html.replace(/&amp;nbsp;/ig, ' '); 
<br>                 html = html.replace(/\n\s*\n/g, '\n'); 
<br>                 html = html.replace(/ {2}/g, ' &amp;nbsp;'); 
<br>                 if (self.newlineTag == 'p') { 
<br>                     if (/\n/.test(html)) { 
<br>                         html = html.replace(/^/, '&lt;p&gt;').replace(/$/, '&lt;/p&gt;').replace(/\n/g, '&lt;/p&gt;&lt;p&gt;'); 
<br>                     } 
<br>                 } else { 
<br>                     html = html.replace(/\n/g, '&lt;br /&gt;$&amp;'); 
<br>                 } 
<br>             } 
<br>             self.insertHtml(html, true); 
<br>         } 
<br>         K(doc.body).bind('paste', function(e){ 
<br>             if (self.pasteType === 0) { 
<br>                 e.stop(); 
<br>                 return; 
<br>             } 
<br>             if (pasting) { 
<br>                 return; 
<br>             } 
<br>             pasting = true; 
<br>             K('div.' + cls, doc).remove(); 
<br>             cmd = self.cmd.selection(); 
<br>             bookmark = cmd.range.createBookmark(); 
<br>             div = K('&lt;div class="' + cls + '"&gt;&lt;/div&gt;', doc).css({ 
<br>                 position : 'absolute', 
<br>                 width : '1px', 
<br>                 height : '1px', 
<br>                 overflow : 'hidden', 
<br>                 left : '-1981px', 
<br>                 top : K(bookmark.start).pos().y + 'px', 
<br>                 'white-space' : 'nowrap' 
<br>             }); 
<br>             K(doc.body).append(div); 
<br>             if (_IE) { 
<br>                 var rng = cmd.range.get(true); 
<br>                 rng.moveToElementText(div[0]); 
<br>                 rng.select(); 
<br>                 rng.execCommand('paste'); 
<br>                 e.preventDefault(); 
<br>             } else { 
<br>                 cmd.range.selectNodeContents(div[0]); 
<br>                 cmd.select(); 
<br>             } 
<br>             setTimeout(function() { 
<br>                 movePastedData(); 
<br>                 pasting = false; 
<br>             }, 0); 
<br>         }); 
<br>     }); 
<br>     self.beforeGetHtml(function(html) { 
<br>         return html.replace(/(&lt;(?:noscript|noscript\s[^&gt;]*)&gt;)([\s\S]*?)(&lt;\/noscript&gt;)/ig, function($0, $1, $2, $3) { 
<br>             return $1 + _unescape($2).replace(/\s+/g, ' ') + $3; 
<br>         }) 
<br>         .replace(/&lt;img[^&gt;]*class="?ke-(flash|rm|media)"?[^&gt;]*&gt;/ig, function(full) { 
<br>             var imgAttrs = _getAttrList(full), 
<br>                 styles = _getCssList(imgAttrs.style || ''), 
<br>                 attrs = _mediaAttrs(imgAttrs['data-ke-tag']); 
<br>             attrs.width = _undef(imgAttrs.width, _removeUnit(_undef(styles.width, ''))); 
<br>             attrs.height = _undef(imgAttrs.height, _removeUnit(_undef(styles.height, ''))); 
<br>             return _mediaEmbed(attrs); 
<br>         }) 
<br>         .replace(/&lt;img[^&gt;]*class="?ke-anchor"?[^&gt;]*&gt;/ig, function(full) { 
<br>             var imgAttrs = _getAttrList(full); 
<br>             return '&lt;a name="' + unescape(imgAttrs['data-ke-name']) + '"&gt;&lt;/a&gt;'; 
<br>         }) 
<br>         .replace(/&lt;div\s+[^&gt;]*data-ke-script-attr="([^"]*)"[^&gt;]*&gt;([\s\S]*?)&lt;\/div&gt;/ig, function(full, attr, code) { 
<br>             return '&lt;script' + unescape(attr) + '&gt;' + unescape(code) + '&lt;/script&gt;'; 
<br>         }) 
<br>         .replace(/&lt;div\s+[^&gt;]*data-ke-noscript-attr="([^"]*)"[^&gt;]*&gt;([\s\S]*?)&lt;\/div&gt;/ig, function(full, attr, code) { 
<br>             return '&lt;noscript' + unescape(attr) + '&gt;' + unescape(code) + '&lt;/noscript&gt;'; 
<br>         }) 
<br>         .replace(/(&lt;[^&gt;]*)data-ke-src="([^"]*)"([^&gt;]*&gt;)/ig, function(full, start, src, end) { 
<br>             full = full.replace(/(\s+(?:href|src)=")[^"]*(")/i, '$1' + src + '$2'); 
<br>             full = full.replace(/\s+data-ke-src="[^"]*"/i, ''); 
<br>             return full; 
<br>         }) 
<br>         .replace(/(&lt;[^&gt;]+\s)data-ke-(on\w+="[^"]*"[^&gt;]*&gt;)/ig, function(full, start, end) { 
<br>             return start + end; 
<br>         }); 
<br>     }); 
<br>     self.beforeSetHtml(function(html) { 
<br>         return html.replace(/&lt;embed[^&gt;]*type="([^"]+)"[^&gt;]*&gt;(?:&lt;\/embed&gt;)?/ig, function(full) { 
<br>             var attrs = _getAttrList(full); 
<br>             attrs.src = _undef(attrs.src, ''); 
<br>             attrs.width = _undef(attrs.width, 0); 
<br>             attrs.height = _undef(attrs.height, 0); 
<br>             return _mediaImg(self.themesPath + 'common/blank.gif', attrs); 
<br>         }) 
<br>         .replace(/&lt;a[^&gt;]*name="([^"]+)"[^&gt;]*&gt;(?:&lt;\/a&gt;)?/ig, function(full) { 
<br>             var attrs = _getAttrList(full); 
<br>             if (attrs.href !== undefined) { 
<br>                 return full; 
<br>             } 
<br>             return '&lt;img class="ke-anchor" src="' + self.themesPath + 'common/anchor.gif" data-ke-name="' + escape(attrs.name) + '" /&gt;'; 
<br>         }) 
<br>         .replace(/&lt;script([^&gt;]*)&gt;([\s\S]*?)&lt;\/script&gt;/ig, function(full, attr, code) { 
<br>             return '&lt;div class="ke-script" data-ke-script-attr="' + escape(attr) + '"&gt;' + escape(code) + '&lt;/div&gt;'; 
<br>         }) 
<br>         .replace(/&lt;noscript([^&gt;]*)&gt;([\s\S]*?)&lt;\/noscript&gt;/ig, function(full, attr, code) { 
<br>             return '&lt;div class="ke-noscript" data-ke-noscript-attr="' + escape(attr) + '"&gt;' + escape(code) + '&lt;/div&gt;'; 
<br>         }) 
<br>         .replace(/(&lt;[^&gt;]*)(href|src)="([^"]*)"([^&gt;]*&gt;)/ig, function(full, start, key, src, end) { 
<br>             if (full.match(/\sdata-ke-src="[^"]*"/i)) { 
<br>                 return full; 
<br>             } 
<br>             full = start + key + '="' + src + '"' + ' data-ke-src="' + src + '"' + end; 
<br>             return full; 
<br>         }) 
<br>         .replace(/(&lt;[^&gt;]+\s)(on\w+="[^"]*"[^&gt;]*&gt;)/ig, function(full, start, end) { 
<br>             return start + 'data-ke-' + end; 
<br>         }) 
<br>         .replace(/&lt;table[^&gt;]*\s+border="0"[^&gt;]*&gt;/ig, function(full) { 
<br>             if (full.indexOf('ke-zeroborder') &gt;= 0) { 
<br>                 return full; 
<br>             } 
<br>             return _addClassToTag(full, 'ke-zeroborder'); 
<br>         }); 
<br>     }); 
<br> }); 
<br> })(window); 
<br> 
<p><br> </p> 
<p><br> </p> 
<p><span style="color:#cc0000">（5）。编辑器中 zh_CN.js代码</span></p> 
<p><br> </p> 
<p>/*******************************************************************************<br> * KindEditor - WYSIWYG HTML Editor for Internet<br> * Copyright (C) 2006-2011 kindsoft.net<br> *<br> * @author Roddy &lt;luolonghao@gmail.com&gt;<br> * @site http://www.kindsoft.net/<br> * @licence http://www.kindsoft.net/license.php<br> *******************************************************************************/<br> <br> KindEditor.lang({<!-- --><br>     source : 'HTML代码',<br>     preview : '预览',<br>     undo : '后退(Ctrl+Z)',<br>     redo : '前进(Ctrl+Y)',<br>     cut : '剪切(Ctrl+X)',<br>     copy : '复制(Ctrl+C)',<br>     paste : '粘贴(Ctrl+V)',<br>     plainpaste : '粘贴为无格式文本',<br>     wordpaste : '从Word粘贴',<br>     selectall : '全选(Ctrl+A)',<br>     justifyleft : '左对齐',<br>     justifycenter : '居中',<br>     justifyright : '右对齐',<br>     justifyfull : '两端对齐',<br>     insertorderedlist : '编号',<br>     insertunorderedlist : '项目符号',<br>     indent : '增加缩进',<br>     outdent : '减少缩进',<br>     subscript : '下标',<br>     superscript : '上标',<br>     formatblock : '段落',<br>     fontname : '字体',<br>     fontsize : '文字大小',<br>     forecolor : '文字颜色',<br>     hilitecolor : '文字背景',<br>     bold : '粗体(Ctrl+B)',<br>     italic : '斜体(Ctrl+I)',<br>     underline : '下划线(Ctrl+U)',<br>     strikethrough : '删除线',<br>     removeformat : '删除格式',<br>     image : '图片',<br>     multiimage : '批量图片上传',<br>     flash : 'Flash',<br>     media : '视音频',<br>     table : '表格',<br>     tablecell : '单元格',<br>     hr : '插入横线',<br>     emoticons : '插入表情',<br>     link : '超级链接',<br>     unlink : '取消超级链接',<br>     fullscreen : '全屏显示(Esc)',<br>     about : '关于',<br>     print : '打印(Ctrl+P)',<br>     filemanager : '文件空间',<br>     code : '插入程序代码',<br>     map : 'Google地图',<br>     baidumap : '百度地图',<br>     lineheight : '行距',<br>     clearhtml : '清理HTML代码',<br>     pagebreak : '插入分页符',<br>     quickformat : '一键排版',<br>     insertfile : '插入文件',<br>     template : '插入模板',<br>     anchor : '锚点',<br>     yes : '确定',<br>     no : '取消',<br>     close : '关闭',<br>     editImage : '图片属性',<br>     deleteImage : '删除图片',<br>     editFlash : 'Flash属性',<br>     deleteFlash : '删除Flash',<br>     editMedia : '视音频属性',<br>     deleteMedia : '删除视音频',<br>     editLink : '超级链接属性',<br>     deleteLink : '取消超级链接',<br>     editAnchor : '锚点属性',<br>     deleteAnchor : '删除锚点',<br>     tableprop : '表格属性',<br>     tablecellprop : '单元格属性',<br>     tableinsert : '插入表格',<br>     tabledelete : '删除表格',<br>     tablecolinsertleft : '左侧插入列',<br>     tablecolinsertright : '右侧插入列',<br>     tablerowinsertabove : '上方插入行',<br>     tablerowinsertbelow : '下方插入行',<br>     tablerowmerge : '向下合并单元格',<br>     tablecolmerge : '向右合并单元格',<br>     tablerowsplit : '拆分行',<br>     tablecolsplit : '拆分列',<br>     tablecoldelete : '删除列',<br>     tablerowdelete : '删除行',<br>     noColor : '无颜色',<br>     pleaseSelectFile : '请选择文件。',<br>     invalidImg : "请输入有效的URL地址。\n只允许jpg,gif,bmp,png格式。",<br>     invalidMedia : "请输入有效的URL地址。\n只允许swf,flv,mp3,wav,wma,wmv,mid,avi,mpg,asf,rm,rmvb格式。",<br>     invalidWidth : "宽度必须为数字。",<br>     invalidHeight : "高度必须为数字。",<br>     invalidBorder : "边框必须为数字。",<br>     invalidUrl : "请输入有效的URL地址。",<br>     invalidRows : '行数为必选项，只允许输入大于0的数字。',<br>     invalidCols : '列数为必选项，只允许输入大于0的数字。',<br>     invalidPadding : '边距必须为数字。',<br>     invalidSpacing : '间距必须为数字。',<br>     invalidJson : '服务器发生故障。',<br>     uploadSuccess : '上传成功。',<br>     cutError : '您的浏览器安全设置不允许使用剪切操作，请使用快捷键(Ctrl+X)来完成。',<br>     copyError : '您的浏览器安全设置不允许使用复制操作，请使用快捷键(Ctrl+C)来完成。',<br>     pasteError : '您的浏览器安全设置不允许使用粘贴操作，请使用快捷键(Ctrl+V)来完成。',<br>     ajaxLoading : '加载中，请稍候 ...',<br>     uploadLoading : '上传中，请稍候 ...',<br>     uploadError : '上传错误',<br>     'plainpaste.comment' : '请使用快捷键(Ctrl+V)把内容粘贴到下面的方框里。',<br>     'wordpaste.comment' : '请使用快捷键(Ctrl+V)把内容粘贴到下面的方框里。',<br>     'link.url' : 'URL',<br>     'link.linkType' : '打开类型',<br>     'link.newWindow' : '新窗口',<br>     'link.selfWindow' : '当前窗口',<br>     'flash.url' : 'URL',<br>     'flash.width' : '宽度',<br>     'flash.height' : '高度',<br>     'flash.upload' : '上传',<br>     'flash.viewServer' : '文件空间',<br>     'media.url' : 'URL',<br>     'media.width' : '宽度',<br>     'media.height' : '高度',<br>     'media.autostart' : '自动播放',<br>     'media.upload' : '上传',<br>     'media.viewServer' : '文件空间',<br>     'image.remoteImage' : '网络图片',<br>     'image.localImage' : '本地上传',<br>     'image.remoteUrl' : '图片地址',<br>     'image.localUrl' : '上传文件',<br>     'image.size' : '图片大小',<br>     'image.width' : '宽',<br>     'image.height' : '高',<br>     'image.resetSize' : '重置大小',<br>     'image.align' : '对齐方式',<br>     'image.defaultAlign' : '默认方式',<br>     'image.leftAlign' : '左对齐',<br>     'image.rightAlign' : '右对齐',<br>     'image.imgTitle' : '图片说明',<br>     'image.upload' : '浏览...',<br>     'image.viewServer' : '图片空间',<br>     'multiimage.uploadDesc' : '允许用户同时上传&lt;%=uploadLimit%&gt;张图片，单张图片容量不超过&lt;%=sizeLimit%&gt;',<br>     'multiimage.startUpload' : '开始上传',<br>     'multiimage.clearAll' : '全部清空',<br>     'multiimage.insertAll' : '全部插入',<br>     'multiimage.queueLimitExceeded' : '文件数量超过限制。',<br>     'multiimage.fileExceedsSizeLimit' : '文件大小超过限制。',<br>     'multiimage.zeroByteFile' : '无法上传空文件。',<br>     'multiimage.invalidFiletype' : '文件类型不正确。',<br>     'multiimage.unknownError' : '发生异常，无法上传。',<br>     'multiimage.pending' : '等待上传',<br>     'multiimage.uploadError' : '上传失败',<br>     'filemanager.emptyFolder' : '空文件夹',<br>     'filemanager.moveup' : '移到上一级文件夹',<br>     'filemanager.viewType' : '显示方式：',<br>     'filemanager.viewImage' : '缩略图',<br>     'filemanager.listImage' : '详细信息',<br>     'filemanager.orderType' : '排序方式：',<br>     'filemanager.fileName' : '名称',<br>     'filemanager.fileSize' : '大小',<br>     'filemanager.fileType' : '类型',<br>     'insertfile.url' : 'URL',<br>     'insertfile.title' : '文件说明',<br>     'insertfile.upload' : '上传',<br>     'insertfile.viewServer' : '文件空间',<br>     'table.cells' : '单元格数',<br>     'table.rows' : '行数',<br>     'table.cols' : '列数',<br>     'table.size' : '大小',<br>     'table.width' : '宽度',<br>     'table.height' : '高度',<br>     'table.percent' : '%',<br>     'table.px' : 'px',<br>     'table.space' : '边距间距',<br>     'table.padding' : '边距',<br>     'table.spacing' : '间距',<br>     'table.align' : '对齐方式',<br>     'table.textAlign' : '水平对齐',<br>     'table.verticalAlign' : '垂直对齐',<br>     'table.alignDefault' : '默认',<br>     'table.alignLeft' : '左对齐',<br>     'table.alignCenter' : '居中',<br>     'table.alignRight' : '右对齐',<br>     'table.alignTop' : '顶部',<br>     'table.alignMiddle' : '中部',<br>     'table.alignBottom' : '底部',<br>     'table.alignBaseline' : '基线',<br>     'table.border' : '边框',<br>     'table.borderWidth' : '边框',<br>     'table.borderColor' : '颜色',<br>     'table.backgroundColor' : '背景颜色',<br>     'map.address' : '地址: ',<br>     'map.search' : '搜索',<br>     'baidumap.address' : '地址: ',<br>     'baidumap.search' : '搜索',<br>     'anchor.name' : '锚点名称',<br>     'formatblock.formatBlock' : {<!-- --><br>         h1 : '标题 1',<br>         h2 : '标题 2',<br>         h3 : '标题 3',<br>         h4 : '标题 4',<br>         p : '正 文'<br>     },<br>     'fontname.fontName' : {<!-- --><br>         'SimSun' : '宋体',<br>         'NSimSun' : '新宋体',<br>         'FangSong_GB2312' : '仿宋_GB2312',<br>         'KaiTi_GB2312' : '楷体_GB2312',<br>         'SimHei' : '黑体',<br>         'Microsoft YaHei' : '微软雅黑',<br>         'Arial' : 'Arial',<br>         'Arial Black' : 'Arial Black',<br>         'Times New Roman' : 'Times New Roman',<br>         'Courier New' : 'Courier New',<br>         'Tahoma' : 'Tahoma',<br>         'Verdana' : 'Verdana'<br>     },<br>     'lineheight.lineHeight' : [<br>         {'1' : '单倍行距'},<br>         {'1.5' : '1.5倍行距'},<br>         {'2' : '2倍行距'},<br>         {'2.5' : '2.5倍行距'},<br>         {'3' : '3倍行距'}<br>     ],<br>     'template.selectTemplate' : '可选模板',<br>     'template.replaceContent' : '替换当前内容',<br>     'template.fileList' : {<!-- --><br>         '1.html' : '图片和文字',<br>         '2.html' : '表格',<br>         '3.html' : '项目编号'<br>     }<br> }, 'zh_CN');<br> <br> </p> 
<p> </p> 
<p> </p> 
<p>（6）。新建另一表单</p> 
<p>代码：</p> 
<p>“文件上传控件” “按钮”（按钮中夫人命令：@Command([FileSave]);@Command([EditDocument])）</p> 
<p>“三个域”分别为：fldDocID (计算) ，fileName（编辑），ParDocID（编辑）</p> 
<p>&lt;计算的值&gt;<br> &lt;input type="hidden" name="fldDocID" value="&lt;计算的值&gt;"&gt;<br> &lt;input type="hidden" name="fileName" value="&lt;计算的值&gt;"&gt;<br> &lt;input type="hidden" name="ParDocID" value=""&gt;</p> 
<p> “最后一个域”：$v2attachmentoptions（计算）</p> 
<p>所有域都是在web下隐藏</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bfa6cbcfc0246841ad24cb12104cffe9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CentOS安装搭建bugfree</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5f473bda1d01878a43ccfb095eb1958a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java中string.trim()函数的使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>