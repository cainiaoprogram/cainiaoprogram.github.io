<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>golang学习笔记 casbin授权库学习记录 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="golang学习笔记 casbin授权库学习记录" />
<meta property="og:description" content="目录 权限控制管理模型ACLRBACABAC Casbin介绍Casbin概述Casbin工作原理请求策略匹配器效果 Casbin结合golang基本使用添加policy结合gorm适配器使用对policy经行增删改查 自定义匹配函数 权限控制管理模型 ACL ACL 基于用户的权限管理模型
基于用户的概念就是说直接对用户进行权限分配管理，好处是模型构建简单，只需要给用户授予或者取消对应权限即可。但是相对的，如果用户数量庞大的情况下，这套模型就很不实用。因为需要对每一位用户对应权限进行维护，这导致维护成本太高。
ACL模型表结构很简单，只需要用户user表和权限节点node以及user和node的多对多关系表user_node。同时，只需要维护user_node表中user和node关系即可。
ACL的适用于用户数量较小的管理系统中，例如：2112班有10位同学，张三拥有班长权限、李四拥有学委权限、王五拥有纪委权限，其它同学只拥有普通权限。
RBAC 一、RBAC是什么
1、RBAC模型概述
RBAC模型（Role-Based Access Control：基于角色的访问控制）模型是20世纪90年代研究出来的一种新模型，但其实在20世纪70年代的多用户计算时期，这种思想就已经被提出来，直到20世纪90年代中后期，RBAC才在研究团体中得到一些重视，并先后提出了许多类型的RBAC模型。其中以美国George Mason大学信息安全技术实验室（LIST）提出的RBAC96模型最具有代表，并得到了普遍的公认。
RBAC认为权限授权的过程可以抽象地概括为：Who是否可以对What进行How的访问操作，并对这个逻辑表达式进行判断是否为True的求解过程，也即是将权限问题转换为What、How的问题，Who、What、How构成了访问权限三元组；
2、RBAC的组成
在RBAC模型里面，有3个基础组成部分，分别是：用户、角色和权限。
RBAC通过定义角色的权限，并对用户授予某个角色从而来控制用户的权限，实现了用户和权限的逻辑分离（区别于ACL模型），极大地方便了权限的管理
：
User（用户）：每个用户都有唯一的UID识别，并被授予不同的角色
Role（角色）：不同角色具有不同的权限
Permission（权限）：访问权限
用户-角色映射：用户和角色之间的映射关系
角色-权限映射：角色和权限之间的映射
3、RBAC支持的安全原则
RBAC支持三个著名的安全原则：最小权限原则、责任分离原则和数据抽象原则
最小权限原则：RBAC可以将角色配置成其完成任务所需的最小权限集合
责任分离原则：可以通过调用相互独立互斥的角色来共同完成敏感的任务，例如要求一个计账员和财务管理员共同参与统一过账操作
数据抽象原则：可以通过权限的抽象来体现，例如财务操作用借款、存款等抽象权限，而不是使用典型的读、写、执行权限
4、RBAC的优缺点
（1）优点：
简化了用户和权限的关系
易扩展、易维护
（2）缺点：
RBAC模型没有提供操作顺序的控制机制，这一缺陷使得RBAC模型很难适应哪些对操作次序有严格要求的系统
5、RBAC的3种模型
（1）RBAC0
RBAC0，是最简单、最原始的实现方式，也是其他RBAC模型的基础。
在该模型中，用户和角色之间可以是多对多的关系，即一个用户在不同场景下是可以有不同的角色，例如：项目经理也可能是组长也可能是架构师。同时每个角色都至少有一个权限。这种模型下，用户和权限被分离独立开来，使得权限的授权认证更加灵活。
（2）RBAC1
基于RBAC0模型，引入了角色间的继承关系，即角色上有了上下级的区别。
角色间的继承关系可分为一般继承关系和受限继承关系。一般继承关系仅要求角色继承关系是一个绝对偏序关系，允许角色间的多继承。而受限继承关系则进一步要求角色继承关系是一个树结构，实现角色间的单继承。
这种模型适合于角色之间层次分明，可以给角色分组分层。
（3）RBAC2
RBAC2，基于RBAC0模型的基础上，进行了角色的访问控制。
RBAC2中的一个基本限制是互斥角色的限制，互斥角色是指各自权限可以互相制约的两个角色。对于这类角色一个用户在某一次活动中只能被分配其中的一个角色，不能同时获得两个角色的使用权。
该模型有以下几种约束：
互斥角色 ：同一用户只能分配到一组互斥角色集合中至多一个角色，支持责任分离的原则。互斥角色是指各自权限互相制约的两个角色。对于这类角色一个用户在某一次活动中只能被分配其中的一个角色，不能同时获得两个角色的使用权。常举的例子：在审计活动中，一个角色不能同时被指派给会计角色和审计员角色。
基数约束 ：一个角色被分配的用户数量受限；一个用户可拥有的角色数目受限；同样一个角色对应的访问权限数目也应受限，以控制高级权限在系统中的分配。例如公司的领导人有限的；
先决条件角色 ：可以分配角色给用户仅当该用户已经是另一角色的成员；对应的可以分配访问权限给角色，仅当该角色已经拥有另一种访问权限。指要想获得较高的权限，要首先拥有低一级的权限。就像我们生活中，国家主席是从副主席中选举的一样。
运行时互斥 ：例如，允许一个用户具有两个角色的成员资格，但在运行中不可同时激活这两个角色。
ABAC 基于用户属性进行访问权限判断，对于ABAC模型的学习，后续会再写一篇博客来进行记录。
Casbin介绍 Casbin概述 Casbin 是一个授权库，在我们希望特定用户访问特定的 对象 或实体的流程中可以使用 主题 访问类型，例如 动作 可以是 读取, 写入, 删除 或开发者设置的任何其他动作。 这是Casbin最广泛的使用，它叫做&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f6f22182c0c670ebac81069ccfd618ea/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-09T22:43:53+08:00" />
<meta property="article:modified_time" content="2023-03-09T22:43:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">golang学习笔记 casbin授权库学习记录</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">权限控制管理模型</a></li><li><ul><li><a href="#ACL_2" rel="nofollow">ACL</a></li><li><a href="#RBAC_7" rel="nofollow">RBAC</a></li><li><a href="#ABAC_81" rel="nofollow">ABAC</a></li></ul> 
  </li><li><a href="#Casbin_84" rel="nofollow">Casbin介绍</a></li><li><ul><li><a href="#Casbin_85" rel="nofollow">Casbin概述</a></li><li><a href="#Casbin_89" rel="nofollow">Casbin工作原理</a></li><li><ul><li><a href="#_93" rel="nofollow">请求</a></li><li><a href="#_101" rel="nofollow">策略</a></li><li><a href="#_111" rel="nofollow">匹配器</a></li><li><a href="#_119" rel="nofollow">效果</a></li></ul> 
  </li></ul> 
  </li><li><a href="#Casbingolang_139" rel="nofollow">Casbin结合golang</a></li><li><ul><li><a href="#_140" rel="nofollow">基本使用</a></li><li><a href="#policy_199" rel="nofollow">添加policy</a></li><li><a href="#gorm_237" rel="nofollow">结合gorm适配器使用</a></li><li><ul><li><a href="#policy_271" rel="nofollow">对policy经行增删改查</a></li></ul> 
   </li><li><a href="#_309" rel="nofollow">自定义匹配函数</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>权限控制管理模型</h2> 
<h3><a id="ACL_2"></a>ACL</h3> 
<p>ACL 基于用户的权限管理模型<br> 基于用户的概念就是说直接对用户进行权限分配管理，好处是模型构建简单，只需要给用户授予或者取消对应权限即可。但是相对的，如果用户数量庞大的情况下，这套模型就很不实用。因为需要对每一位用户对应权限进行维护，这导致维护成本太高。<br> ACL模型表结构很简单，只需要用户user表和权限节点node以及user和node的多对多关系表user_node。同时，只需要维护user_node表中user和node关系即可。<br> ACL的适用于用户数量较小的管理系统中，例如：2112班有10位同学，张三拥有班长权限、李四拥有学委权限、王五拥有纪委权限，其它同学只拥有普通权限。</p> 
<h3><a id="RBAC_7"></a>RBAC</h3> 
<p>一、RBAC是什么</p> 
<p>1、RBAC模型概述</p> 
<p>RBAC模型（Role-Based Access Control：基于角色的访问控制）模型是20世纪90年代研究出来的一种新模型，但其实在20世纪70年代的多用户计算时期，这种思想就已经被提出来，直到20世纪90年代中后期，RBAC才在研究团体中得到一些重视，并先后提出了许多类型的RBAC模型。其中以美国George Mason大学信息安全技术实验室（LIST）提出的RBAC96模型最具有代表，并得到了普遍的公认。</p> 
<p>RBAC认为权限授权的过程可以抽象地概括为：Who是否可以对What进行How的访问操作，并对这个逻辑表达式进行判断是否为True的求解过程，也即是将权限问题转换为What、How的问题，Who、What、How构成了访问权限三元组；<br> 2、RBAC的组成</p> 
<p>在RBAC模型里面，有3个基础组成部分，分别是：用户、角色和权限。</p> 
<p>RBAC通过定义角色的权限，并对用户授予某个角色从而来控制用户的权限，实现了用户和权限的逻辑分离（区别于ACL模型），极大地方便了权限的管理<br> ：</p> 
<p>User（用户）：每个用户都有唯一的UID识别，并被授予不同的角色<br> Role（角色）：不同角色具有不同的权限<br> Permission（权限）：访问权限<br> 用户-角色映射：用户和角色之间的映射关系<br> 角色-权限映射：角色和权限之间的映射</p> 
<p>3、RBAC支持的安全原则</p> 
<p>RBAC支持三个著名的安全原则：最小权限原则、责任分离原则和数据抽象原则</p> 
<p>最小权限原则：RBAC可以将角色配置成其完成任务所需的最小权限集合<br> 责任分离原则：可以通过调用相互独立互斥的角色来共同完成敏感的任务，例如要求一个计账员和财务管理员共同参与统一过账操作<br> 数据抽象原则：可以通过权限的抽象来体现，例如财务操作用借款、存款等抽象权限，而不是使用典型的读、写、执行权限<br> 4、RBAC的优缺点</p> 
<p>（1）优点：</p> 
<p>简化了用户和权限的关系<br> 易扩展、易维护<br> （2）缺点：</p> 
<p>RBAC模型没有提供操作顺序的控制机制，这一缺陷使得RBAC模型很难适应哪些对操作次序有严格要求的系统<br> 5、RBAC的3种模型</p> 
<p>（1）RBAC0</p> 
<p>RBAC0，是最简单、最原始的实现方式，也是其他RBAC模型的基础。</p> 
<p><img src="https://images2.imgbox.com/c1/8c/LI5vkMbT_o.png" alt="在这里插入图片描述"></p> 
<p>在该模型中，用户和角色之间可以是多对多的关系，即一个用户在不同场景下是可以有不同的角色，例如：项目经理也可能是组长也可能是架构师。同时每个角色都至少有一个权限。这种模型下，用户和权限被分离独立开来，使得权限的授权认证更加灵活。</p> 
<p>（2）RBAC1</p> 
<p>基于RBAC0模型，引入了角色间的继承关系，即角色上有了上下级的区别。<br> <img src="https://images2.imgbox.com/79/8e/ToAgeIeT_o.png" alt="在这里插入图片描述"></p> 
<p>角色间的继承关系可分为一般继承关系和受限继承关系。一般继承关系仅要求角色继承关系是一个绝对偏序关系，允许角色间的多继承。而受限继承关系则进一步要求角色继承关系是一个树结构，实现角色间的单继承。</p> 
<p>这种模型适合于角色之间层次分明，可以给角色分组分层。</p> 
<p>（3）RBAC2</p> 
<p>RBAC2，基于RBAC0模型的基础上，进行了角色的访问控制。<br> <img src="https://images2.imgbox.com/71/f1/h2Wob2N9_o.png" alt="在这里插入图片描述"></p> 
<p>RBAC2中的一个基本限制是互斥角色的限制，互斥角色是指各自权限可以互相制约的两个角色。对于这类角色一个用户在某一次活动中只能被分配其中的一个角色，不能同时获得两个角色的使用权。</p> 
<p>该模型有以下几种约束：</p> 
<p>互斥角色 ：同一用户只能分配到一组互斥角色集合中至多一个角色，支持责任分离的原则。互斥角色是指各自权限互相制约的两个角色。对于这类角色一个用户在某一次活动中只能被分配其中的一个角色，不能同时获得两个角色的使用权。常举的例子：在审计活动中，一个角色不能同时被指派给会计角色和审计员角色。<br> 基数约束 ：一个角色被分配的用户数量受限；一个用户可拥有的角色数目受限；同样一个角色对应的访问权限数目也应受限，以控制高级权限在系统中的分配。例如公司的领导人有限的；<br> 先决条件角色 ：可以分配角色给用户仅当该用户已经是另一角色的成员；对应的可以分配访问权限给角色，仅当该角色已经拥有另一种访问权限。指要想获得较高的权限，要首先拥有低一级的权限。就像我们生活中，国家主席是从副主席中选举的一样。<br> 运行时互斥 ：例如，允许一个用户具有两个角色的成员资格，但在运行中不可同时激活这两个角色。</p> 
<h3><a id="ABAC_81"></a>ABAC</h3> 
<p>基于用户属性进行访问权限判断，对于ABAC模型的学习，后续会再写一篇博客来进行记录。</p> 
<h2><a id="Casbin_84"></a>Casbin介绍</h2> 
<h3><a id="Casbin_85"></a>Casbin概述</h3> 
<p>Casbin 是一个授权库，在我们希望特定用户访问特定的 对象 或实体的流程中可以使用 主题 访问类型，例如 动作 可以是 读取, 写入, 删除 或开发者设置的任何其他动作。 这是Casbin最广泛的使用，它叫做"标准" 或经典 { subject, object, action } 流程。</p> 
<p>Casbin能够处理除标准流量以外的许多复杂的许可使用者。 可以添加 角色 (RBAC), 属性 (ABAC) 等。</p> 
<h3><a id="Casbin_89"></a>Casbin工作原理</h3> 
<p>在 Casbin 中, 访问控制模型被抽象为基于 <strong>PERM (Policy, Effect, Request, Matcher)</strong> 的一个配置文件。 因此，切换或升级项目的授权机制与修改配置一样简单。 您可以通过组合可用的模型来定制您自己的访问控制模型。 例如，您可以在一个model中结合RBAC角色和ABAC属性，并共享一组策略规则。</p> 
<p>PERM模式由四个基础（策略、效果、请求、匹配）组成，描述了资源与用户之间的关系。</p> 
<h4><a id="_93"></a>请求</h4> 
<p>定义请求参数。 基本请求是一个元组对象，至少需要主题(访问实体)、目标(访问资源) 和动作(访问方式)</p> 
<p>例如，一个请求可能长这样：</p> 
<pre><code> r={sub,obj,act}
</code></pre> 
<p>它实际上定义了我们应该提供访问控制匹配功能的参数名称和顺序。</p> 
<h4><a id="_101"></a>策略</h4> 
<p>定义访问策略的模式。 事实上，它在策略规则文件中界定了字段的名称和顺序。</p> 
<p>例如：</p> 
<pre><code> p={sub, obj, act} 
 或 
 p={sub, obj, act, eft}
</code></pre> 
<p>注：如果未定义eft (policy result)，则策略文件中的结果字段将不会被读取， 和匹配的策略结果将默认被允许。</p> 
<h4><a id="_111"></a>匹配器</h4> 
<p>匹配请求和政策的规则。</p> 
<p>例如：</p> 
<pre><code>m = r.sub == p.sub &amp;&amp; r.act == p.act &amp;&amp; r.obj == p.obj 
</code></pre> 
<p>这个简单和常见的匹配规则意味着如果请求的参数(访问实体，访问资源和访问方式)匹配， 如果可以在策略中找到资源和方法，那么策略结果（p.eft）便会返回。 策略的结果将保存在 p.eft 中。</p> 
<h4><a id="_119"></a>效果</h4> 
<p>它可以被理解为一种模型，在这种模型中，对匹配结果再次作出逻辑组合判断。</p> 
<p>例如：</p> 
<pre><code> e = some (where (p.eft == allow))
</code></pre> 
<p>这句话意味着，如果匹配的策略结果有一些是允许的，那么最终结果为真。</p> 
<p>让我们看看另一个示例：</p> 
<pre><code>e = some (where (p.eft == allow)) &amp;&amp; !some(where (p.eft == deny) 
</code></pre> 
<p>此示例组合的逻辑含义是：如果有符合允许结果的策略且没有符合拒绝结果的策略， 结果是为真。 换言之，当匹配策略均为允许（没有任何否认）是为真（更简单的是，既允许又同时否认，拒绝就具有优先地位)。</p> 
<p>———————</p> 
<p>更多关于的casbin的使用说明请查看官方文档<a href="https://casbin.org/zh/" rel="nofollow">Casbin</a></p> 
<h2><a id="Casbingolang_139"></a>Casbin结合golang</h2> 
<h3><a id="_140"></a>基本使用</h3> 
<p>首先安装casbin</p> 
<pre><code>go get github.com/casbin/casbin/v2
</code></pre> 
<p>Casbin使用配置文件来设置访问控制模型</p> 
<p>它有两个配置文件，<strong>model.conf</strong>和 <strong>policy.csv</strong>。 其中, model.conf 存储了我们的访问模型, 而 policy.csv 存储的是我们具体的用户权限配置。 Casbin的使用非常精炼。 基本上，我们只需要一种主要的结构：enforcer 当构造这个结构的时候， model.conf 和 policy.csv 将会被加载。</p> 
<pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token string">"github.com/casbin/casbin/v2"</span>

e<span class="token punctuation">,</span> err <span class="token operator">:=</span> casbin<span class="token punctuation">.</span><span class="token function">NewEnforcer</span><span class="token punctuation">(</span><span class="token string">"path/to/model.conf"</span><span class="token punctuation">,</span> <span class="token string">"path/to/policy.csv"</span><span class="token punctuation">)</span>
</code></pre> 
<p>接下来开始编写配置文件<br> policy.csv<br> <img src="https://images2.imgbox.com/1f/26/eWofuVJ2_o.png" alt="在这里插入图片描述"><br> model.conf<br> <img src="https://images2.imgbox.com/e8/ab/binyLJQJ_o.png" alt="在这里插入图片描述"><br> 配置文件的编写规则具体还得看官方文档给出的解释。<br> 配置文档编写好后，即可开始测试</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	e<span class="token punctuation">,</span> err <span class="token operator">:=</span> casbin<span class="token punctuation">.</span><span class="token function">NewEnforcer</span><span class="token punctuation">(</span><span class="token string">"./model.conf"</span><span class="token punctuation">,</span> <span class="token string">"./policy.csv"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	sub <span class="token operator">:=</span> <span class="token string">"ylj"</span>
	obj <span class="token operator">:=</span> <span class="token string">"date1"</span>
	act <span class="token operator">:=</span> <span class="token string">"read"</span>
	act2 <span class="token operator">:=</span> <span class="token string">"write"</span>
	<span class="token comment">//add, err := e.AddPolicy(sub, obj, act2)</span>
	<span class="token comment">//if err != nil {<!-- --></span>
	<span class="token comment">//	return</span>
	<span class="token comment">//}</span>
	<span class="token comment">//fmt.Println(add)</span>
	ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> act<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ok<span class="token punctuation">)</span>
	ok<span class="token punctuation">,</span> err <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> act2<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ok<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中代码NewEnforcer函数会根据配置文件路径来返回一个Enforcer类型的指针。该指针下的Enforce方法即是经行授权处理，由于policy文档中’ylj’用户对于资源date1只有read权限，<br> <img src="https://images2.imgbox.com/bc/70/rfOo7tVz_o.png" alt="在这里插入图片描述"><br> 所以对于第一个权限处理<br> <img src="https://images2.imgbox.com/79/c2/HoHrPN1k_o.png" alt="在这里插入图片描述"><br> 返回true<br> 而第二权限处理是ylj对date1经行write操作，<br> <img src="https://images2.imgbox.com/01/03/F7ubkeyQ_o.png" alt="在这里插入图片描述"><br> 则会返回false</p> 
<h3><a id="policy_199"></a>添加policy</h3> 
<p>官方提供了一个方法AddPolicy（）可以直接添加policy，但发现此添加方法并不会改变policy.csv文档</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	e<span class="token punctuation">,</span> err <span class="token operator">:=</span> casbin<span class="token punctuation">.</span><span class="token function">NewEnforcer</span><span class="token punctuation">(</span><span class="token string">"./model.conf"</span><span class="token punctuation">,</span> <span class="token string">"./policy.csv"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	sub <span class="token operator">:=</span> <span class="token string">"ylj"</span>
	obj <span class="token operator">:=</span> <span class="token string">"date1"</span>
	act <span class="token operator">:=</span> <span class="token string">"read"</span>
	act2 <span class="token operator">:=</span> <span class="token string">"write"</span>
	add<span class="token punctuation">,</span> err <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> act2<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"添加结果："</span><span class="token punctuation">,</span> add<span class="token punctuation">)</span>
	ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> act<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"权限1："</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
	ok<span class="token punctuation">,</span> err <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> act2<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"权限2："</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/ee/f7/DhqdNobH_o.png" alt="在这里插入图片描述"><br> 但发现policy.csv文件却没有改变<br> <img src="https://images2.imgbox.com/a1/b8/ouSF2qHD_o.png" alt="在这里插入图片描述"><br> 如果注销掉addPolicy方法则权限二会重新返回false。所以在实际使用中还是会结合适配器去使用casbin</p> 
<h3><a id="gorm_237"></a>结合gorm适配器使用</h3> 
<p>安装</p> 
<pre><code>go get github.com/casbin/gorm-adapter/v3
</code></pre> 
<p>初始化与mysql的连接</p> 
<pre><code class="prism language-go">adapter<span class="token punctuation">,</span> err <span class="token operator">:=</span> gormadapter<span class="token punctuation">.</span><span class="token function">NewAdapter</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"root:adss123@tcp(127.0.0.1:3306)/casbin"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>其中连接函数最后的参数true是用于判断是否存在一个名为”casbin_rule“的表，若不存在则会自动去创建，若不想自动创建，则不需要设置该参数。<br> 后续只用将该连接返回的变量代替policy的配置文件，正常初始化enforce即可</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   adapter<span class="token punctuation">,</span> err <span class="token operator">:=</span> gormadapter<span class="token punctuation">.</span><span class="token function">NewAdapter</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"root:adss123@tcp(127.0.0.1:3306)/casbin"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
   	<span class="token keyword">return</span>
   <span class="token punctuation">}</span>
   e<span class="token punctuation">,</span> err <span class="token operator">:=</span> casbin<span class="token punctuation">.</span><span class="token function">NewEnforcer</span><span class="token punctuation">(</span><span class="token string">"model.conf"</span><span class="token punctuation">,</span> adapter<span class="token punctuation">)</span>
   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
   	<span class="token keyword">return</span>
   <span class="token punctuation">}</span>
   sub <span class="token operator">:=</span> <span class="token string">"ylj"</span>
   obj <span class="token operator">:=</span> <span class="token string">"date1"</span>
   act <span class="token operator">:=</span> <span class="token string">"read"</span>
   ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> act<span class="token punctuation">)</span>
   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
   	<span class="token keyword">return</span>
   <span class="token punctuation">}</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ok<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="policy_271"></a>对policy经行增删改查</h4> 
<p>官方已经给出了非常完善的指令文档，这里只展示一些基本指令。</p> 
<p><strong>AddPolicy()</strong><br> AddPolicy 向当前策略添加授权规则。 如果规则已经存在，函数返回false，并且不会添加规则。 否则，函数通过添加新规则并返回true。</p> 
<pre><code class="prism language-go">added <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token char">'eve'</span><span class="token punctuation">,</span> <span class="token char">'data3'</span><span class="token punctuation">,</span> <span class="token char">'read'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>AddPolicies()</strong><br> AddPolicy 向当前策略添加授权许多规则。 该操作本质上是原子的 因此，如果授权规则由不符合现行政策的规则组成， 函数返回false，当前政策中没有添加任何政策规则。 如果所有授权规则都符合政策规则，则函数返回true，每项政策规则都被添加到目前的政策中。</p> 
<pre><code class="prism language-go">rules <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span><span class="token string">"jack"</span><span class="token punctuation">,</span> <span class="token string">"data4"</span><span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span><span class="token string">"katy"</span><span class="token punctuation">,</span> <span class="token string">"data4"</span><span class="token punctuation">,</span> <span class="token string">"write"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span><span class="token string">"leyo"</span><span class="token punctuation">,</span> <span class="token string">"data4"</span><span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span><span class="token string">"ham"</span><span class="token punctuation">,</span> <span class="token string">"data4"</span><span class="token punctuation">,</span> <span class="token string">"write"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

areRulesAdded <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">AddPolicies</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span>

</code></pre> 
<p><strong>RemovePolicy()</strong><br> RemovePolicy 从当前策略中删除授权规则。</p> 
<pre><code class="prism language-go">removed <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">RemovePolicy</span><span class="token punctuation">(</span><span class="token string">"alice"</span><span class="token punctuation">,</span> <span class="token string">"data1"</span><span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>UpdatePolicy()</strong><br> UpdatePolicy 把旧的政策更新到新的政策</p> 
<pre><code class="prism language-go">updated<span class="token punctuation">,</span> err <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">UpdatePolicy</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"eve"</span><span class="token punctuation">,</span> <span class="token string">"data3"</span><span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"eve"</span><span class="token punctuation">,</span> <span class="token string">"data3"</span><span class="token punctuation">,</span> <span class="token string">"write"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>GetPolicy</strong><br> 获取策略中的所有授权规则。</p> 
<pre><code class="prism language-go">policy <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">GetPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>不同于之前，这些指令再结合适配器后会在数据库内对policy进行修改，使其有更好的记录。</p> 
<h3><a id="_309"></a>自定义匹配函数</h3> 
<p>首先准备函数。 它接受一些参数，然后返回一个布尔类型：<br> 这里自定义一个超级管理员，若其名称为”*“则可以拥有所有用户的权限</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">KeyMatch</span><span class="token punctuation">(</span>key1 <span class="token builtin">string</span><span class="token punctuation">,</span> key2 <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span> key1 <span class="token operator">==</span> <span class="token string">"*"</span> <span class="token operator">||</span> key2 <span class="token operator">==</span> <span class="token string">"*"</span> <span class="token punctuation">{<!-- --></span>
   	<span class="token keyword">return</span> <span class="token boolean">true</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> key1 <span class="token operator">==</span> key2
<span class="token punctuation">}</span>
</code></pre> 
<p>然后用 interface{} 类型的接口包装它：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">KeyMatchFunc</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    name1 <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
    name2 <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">KeyMatch</span><span class="token punctuation">(</span>name1<span class="token punctuation">,</span> name2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后，在Casbin的执行者(enforcer)中注册这个函数：</p> 
<pre><code class="prism language-go">e<span class="token punctuation">.</span><span class="token function">AddFunction</span><span class="token punctuation">(</span><span class="token string">"my_func"</span><span class="token punctuation">,</span> KeyMatchFunc<span class="token punctuation">)</span>
</code></pre> 
<p>这样就可以在model.conf中使用函数了<br> <img src="https://images2.imgbox.com/42/75/t5akzLAi_o.png" alt="在这里插入图片描述"></p> 
<p>当前数据库中记录的policy为<br> <img src="https://images2.imgbox.com/1f/21/1X92CAxz_o.png" alt="在这里插入图片描述"><br> 执行代码</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/casbin/casbin/v2"</span>
	gormadapter <span class="token string">"github.com/casbin/gorm-adapter/v3"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	adapter<span class="token punctuation">,</span> err <span class="token operator">:=</span> gormadapter<span class="token punctuation">.</span><span class="token function">NewAdapter</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"root:adss123@tcp(127.0.0.1:3306)/casbin"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	e<span class="token punctuation">,</span> err <span class="token operator">:=</span> casbin<span class="token punctuation">.</span><span class="token function">NewEnforcer</span><span class="token punctuation">(</span><span class="token string">"model.conf"</span><span class="token punctuation">,</span> adapter<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	e<span class="token punctuation">.</span><span class="token function">AddFunction</span><span class="token punctuation">(</span><span class="token string">"my_func"</span><span class="token punctuation">,</span> KeyMatchFunc<span class="token punctuation">)</span>

	sub <span class="token operator">:=</span> <span class="token string">"*"</span>
	obj <span class="token operator">:=</span> <span class="token string">"data4"</span>
	act <span class="token operator">:=</span> <span class="token string">"read"</span>
	ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> act<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ok<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">KeyMatch</span><span class="token punctuation">(</span>key1 <span class="token builtin">string</span><span class="token punctuation">,</span> key2 <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> key1 <span class="token operator">==</span> <span class="token string">"*"</span> <span class="token operator">||</span> key2 <span class="token operator">==</span> <span class="token string">"*"</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> key1 <span class="token operator">==</span> key2
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">KeyMatchFunc</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	name1 <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	name2 <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token function">KeyMatch</span><span class="token punctuation">(</span>name1<span class="token punctuation">,</span> name2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>结果为<br> <img src="https://images2.imgbox.com/59/81/xKCqbeiw_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0ebbf0e3bdae034ffe1429301e17440d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">微服务与分布式——SpringCloud</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c9d86b61db48dfee43c831ce5c36fb2e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue中使用jsp页面问题（vue与iframe相互传值问题）解决，将jsp页面移植到vue项目中的问题解决</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>