<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql query_time单位_深入mysql慢查询设置的详解 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql query_time单位_深入mysql慢查询设置的详解" />
<meta property="og:description" content="set long_query_time=1; #设置慢查询时间为1 秒;
set global slow_query_log=on; #开启慢查询日志;
show global status like &#39;slow_queries&#39;; #显示慢查询次数
show variables like &#39;long_query_time&#39; ; #显示慢查询时间;
show variables like &#39;slow_query_log&#39; ; #显示慢查询日志是否开启
日志文件默认在data目录下
在web开发中，我们经常会写出一些SQL语句，一条糟糕的SQL语句可能让你的整个程序都非常慢，超过10秒一般用户就会选择关闭网页，如何优化 SQL语句将那些运行时间 比较长的SQL语句找出呢？MySQL给我们提供了一个很好的功能，那就是慢查询！所谓的慢查询就是通过设置来记录超过一定时间的SQL语句！那么如何应 用慢查询呢？
slow_query_log
long_query_time = 1
2.测试慢查询日志功能(1)进入MySql控制台，执行如下语句:
select sleep(2);
mysql&gt; select sleep(2);
&#43;----------&#43;
| sleep(2) |
&#43;----------&#43;
| 0 |
&#43;----------&#43;
1 row in set (2.12 sec)
(2)查看慢查询日志文件think-slow.log，在文件最后发现：
# Time: 121120 20:06:23
# User@Host: root[root] @ localhost [127.0.0.1]
# Query_time: 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3de7d8d629fc7465930fa8e9cb399eb6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-19T17:15:56+08:00" />
<meta property="article:modified_time" content="2021-01-19T17:15:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql query_time单位_深入mysql慢查询设置的详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>set long_query_time=1; #设置慢查询时间为1 秒;</p> 
 <p>set global slow_query_log=on; #开启慢查询日志;</p> 
 <p>show global status like 'slow_queries';   #显示慢查询次数</p> 
 <p>show variables like 'long_query_time' ;   #显示慢查询时间;</p> 
 <p>show variables like 'slow_query_log' ;  #显示慢查询日志是否开启</p> 
 <p>日志文件默认在data目录下</p> 
 <p>在web开发中，我们经常会写出一些SQL语句，一条糟糕的SQL语句可能让你的整个程序都非常慢，超过10秒一般用户就会选择关闭网页，如何优化 SQL语句将那些运行时间 比较长的SQL语句找出呢？MySQL给我们提供了一个很好的功能，那就是慢查询！所谓的慢查询就是通过设置来记录超过一定时间的SQL语句！那么如何应 用慢查询呢？</p> 
 <p>slow_query_log</p> 
 <p>long_query_time = 1</p> 
 <p>2.测试慢查询日志功能(1)进入MySql控制台，执行如下语句:</p> 
 <p>select sleep(2);</p> 
 <p>mysql&gt; select sleep(2);</p> 
 <p>+----------+</p> 
 <p>| sleep(2) |</p> 
 <p>+----------+</p> 
 <p>|        0 |</p> 
 <p>+----------+</p> 
 <p>1 row in set (2.12 sec)</p> 
 <p>(2)查看慢查询日志文件think-slow.log，在文件最后发现：</p> 
 <p># Time: 121120 20:06:23</p> 
 <p># User@Host: root[root] @ localhost [127.0.0.1]</p> 
 <p># Query_time: 2.104120  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0</p> 
 <p>SET timestamp=1353413183;</p> 
 <p>select sleep(2);</p> 
 <p>3.解释：(1)slow_query_log 这句是开启记录mysql 慢查询功能，slow_query_log=0关闭；slow_query_log=1开启(这个1可以不写)</p> 
 <p>(2)long_query_time = 1 这句是记录超过1秒的SQL执行语句</p> 
 <p>(3)那么这个日志文件存放在什么地方呢？默认是放在mysql的data目录，并且文件名为host_name-slow.log即 主机名-slow.log,比如在笔者的开发机上就是THINK-slow.log(因为偶用的Thinkpad，呵呵)</p> 
 <p>(4)如果日志文件不想放在data目录，我们可以通过如下配置指定存放的目录及日志文件名：slow_query_log_file=file_name其中file_name就是你的存放日志的目录和文件名，在这里注意有的资料上可能是log-slow-queries=file_name,这个在mysql5.5版已经过时！</p> 
 <p>4.如何记录低于1s的慢查询记录呢？MySQL5.21版以前long_query_time 参数的单位是秒，默认值是10。这相当于说最低只能记录执行时间超过 1 秒的查询，怎么记录查询时间超过100毫秒的SQL语句记录呢？在mysql5.21+后版本支持毫秒记录</p> 
 <p>(1)进入MySql控制台，运行如下sql语句：</p> 
 <p>set global long_query_time=0.1</p> 
 <p>该句是设置记录慢查询超过时间100ms的SQL，记住要重启mysql才能生效！</p> 
 <p>(2)测试进入mysql控制台，执行如下sql语句：</p> 
 <p>select sleep(0.5);</p> 
 <p>查看慢查询日志文件，看到最后添加的新信息：</p> 
 <p># Time: 121120 20:42:06</p> 
 <p># User@Host: root[root] @ localhost [127.0.0.1]</p> 
 <p># Query_time: 0.500028  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0</p> 
 <p>SET timestamp=1353415326;</p> 
 <p>select sleep(0.5);</p> 
 <p>优化MySQL最重要的一部分工作是先确定”有问题”的查询语句。只有先找出这些查询较慢的sql查询(执行时间较长)，我们才能进一步分析原因并且优化它。MySQL为我们提供了Slow Query Log记录功能，它能记录执行时间超过了特定时长的查询。分析Slow Query Log有助于帮我们找到”问题”查询。记录slow queries</p> 
 <p>首先，我们需要查看mysql server版本号，以及是否配置启用了slow query log。</p> 
 <p>#打开服务</p> 
 <p>log_slow_queries = ON</p> 
 <p>当log_slow_queries是ON时，才表示已经启用了记录slow query功能。默认是不记录slow query的。</p> 
 <p>启用slow query日志</p> 
 <p>#//将下列配置放到my.cnf中</p> 
 <p>[mysqld]</p> 
 <p>log-slow-queries = /var/lib/mysql/slow-queries.log</p> 
 <p>//新增加的参数</p> 
 <p>long_query_time = 3</p> 
 <p>log-queries-not-using-indexes</p> 
 <p>log-slow-admin-statements</p> 
 <p>上面的配置打开了slow query日志,将会捕获了执行时间超过了3秒的查询，包括执行速度较慢的管理命令(比如OPTIMEZE TABLE),并且记录了没有使用索引的查询。这些SQL，都会被记录到log-slow-queries指定的文件/var/lib/mysql/slow-queries.log文件中。</p> 
 <p>log-slow-queries </p> 
 <p>存放slow query日志的文件。你必须保证mysql server进程mysqld_safe进程用户对该文件有w权限。</p> 
 <p>long_query_time</p> 
 <p>如果query time超过了该值，则认为是较慢查询，并被记录下来。单位是秒，最小值是1,默认值是10秒。10秒对于大多数应用来讲，太长了。我们推荐从3秒开始， 依次减少，每次都找出最”昂贵”的10条SQL语句并且优化他们。日复一日，一步一步优化。一次性找出很多条SQL语句，对于优化来讲，意义并不大。</p> 
 <p>log-queries-not-using-indexes</p> 
 <p>MySQL会将没有使用索引的查询记录到slow query日志中。无论它执行有多快，查询语句没有使用索引，都会被记录。有的时候，有些没有使用引索的查询非常快(例如扫描很小的表)，但也有可能导致服务器变慢，甚至还会使用大量的磁盘空间。</p> 
 <p>log-slow-admin-statements</p> 
 <p>一些管理指令，也会被记录。比如OPTIMEZE TABLE, ALTER TABLE等等。</p> 
 <p>日志文件</p> 
 <p>我们可以通过tail -f查看日志文件。</p> 
 <p>$tail -f /var/lib/mysql/slow-queries.log</p> 
 <p># Time: 110107 16:22:11</p> 
 <p># User@Host: root[root] @ localhost []</p> 
 <p># Query_time: 9.869362 Lock_time: 0.000035 Rows_sent: 1 Rows_examined: 6261774</p> 
 <p>SET timestamp=1294388531;</p> 
 <p>select count(*) from ep_friends;</p> 
 <p>第一行,SQL查询执行的时间</p> 
 <p>第二行,执行SQL查询的连接信息</p> 
 <p>第三行记录了一些我们比较有用的信息</p> 
 <p>Query_time SQL执行的时间,越长则越慢</p> 
 <p>Lock_time 在MySQL服务器阶段(不是在存储引擎阶段)等待表锁时间</p> 
 <p>Rows_sent 查询返回的行数</p> 
 <p>Rows_examined 查询检查的行数</p> 
 <p>Slow Query日志，虽然帮助你记录了那些执行过了的SQL语句。但它不是万能的，意义可能没有你想象的那么大。它只告诉了你哪些语句慢，但是为什么慢?具体 原因，还是需要你自己去分析，不断的调试。也许，你只需要换一条更有效的sql语句，也许你只需简单地增加一个索引，但也有可能你需要调整你应用程序的设 计方案。比如，上面那条语句是很明显，它检查了600多万行数据。不幸的是，并不是每条语句都这么明显。也许还有别的原因，比如:</p> 
 <p>*锁表了，导致查询处于等态状态。lock_time显示了查询等待锁被翻译的时间</p> 
 <p>*数据或索引没有被缓存。常见于第一次启动服务器或者服务器没有调优</p> 
 <p>*备份数据库，I/O变慢</p> 
 <p>*也许同时运行了其它的查询，减少了当前查询</p> 
 <p>所以,不要过于紧张日志文件某条记录，而应该理性地审记，找出真正的原因。如果经常出现的slow query需要特别注意。如果个别出现，则做一些常规检查即可。我们建议，统计并且形成基准报告，进行比较排除，比胡乱瞎撞有用。希望大家不要在这部分过于浪费时间与精力。</p> 
 <p>线上记录slow query</p> 
 <p>上文的配置需要重启mysql server进程mysqld才会生效。但是很多时候，尤其是产品运营环境，不希望每次修改都需要重新启动mysql服务器，也希望能在某些特定时间记 录。MySQL5.1给我们提供了更为灵活的运行时控制，使得你不必重新启动mysql服务器，也能选择性地记录或者不记录某些slow queries。</p> 
 <p>MySQL5.1中，提供了全局变量slow_query_log、slow_query_log_file可以灵活地控制enable/disable慢查询。同时可以通过long_query_time设置时间</p> 
 <p>#//停用slow query记录</p> 
 <p>#注意:设置了slow_query_log全局变量, log_slow_queries也会隐性地跟着改变</p> 
 <p>mysql&gt;set global slow_query_log=OFF</p> 
 <p>不幸运的是,在MySQL5.0并没有提供类似的全局变量来灵活控制，但是我们可以通过将long_query_time设置得足够大来避免记录某些查询语句。比如</p> 
 <p>mysql&gt;set global long_query_time = 3600;</p> 
 <p>MySQL5.0, 不关服务的情况下，希望不记录日志的办法是将日志文件成为/dev/null的符号链接(symbolic link)。注意:你只需要在改变后运行FLUSH LOGS以确定MYSQL释放当前的日志文件描述符，重新把日志记录到/dev/null</p> 
 <p>和MySQL5.0不同,MySQL5.1可以在运行时改变日记行为，将日志记录到数据库表中。只要将mysql全局变量log_output设置为 TABLE即可。MySQL会将日志分别记录到表mysql.gengera_log和mysql.slow_log二张表中。但是，我们推荐将日志记录 在日记文件中。</p> 
 <p>mysql&gt; show variables like ‘log_output’\G</p> 
 <p>Variable_name: log_output</p> 
 <p>Value: FILE</p> 
 <p>mysql&gt;set global log_output=’table’;</p> 
 <p>缺陷与审记</p> 
 <p>虽然记录了slow query能够帮助你优化产品。但是MySQL目前版本，还有几大蹩足的地方。</p> 
 <p>1.MySQL5.0版本, long_query_time时间粒度不够细,最小值为1秒。对于高并发性能的网页脚本而言，1秒出现的意义不大。即出现1秒的查询比较少。直到mysql5.1.21才提供更细粒度的long_query_time设定.</p> 
 <p>2.不能将服务器执行的所有查询记录到慢速日志中。虽然MySQL普通日志记录了所有查询，但是它们是解析查询之前就记录下来了。这意味着普通日志没办法包含诸如执行时间，锁表时间，检查行数等信息。</p> 
 <p>3.如果开启了log_queries_not_using_indexes选项，slow query日志会充满过多的垃圾日志记录，这些快且高效的全表扫描查询(表小)会冲掉真正有用的slow queries记录。比如select * from category这样的查询也会被记录下来。</p> 
 <p>通过microslow-patch补丁可使用更细的时间粒度，和记录所有执行过的sql语句。不过，使用这个补订不得不自己编译MySQL，出于稳定性考滤，我们推荐在开发测试环境，可以打上这个补丁，享受这个补丁带来的便利。在运营环境尽量不要这么做…</p> 
 <p>MySQL自带了mysqldumpslow工具用来分析slow query日志，除此之外，还有一些好用的开源工具。比如MyProfi、mysql-log-filter，当然还有mysqlsla</p> 
 <p>转自:</p> 
 <p>http://blog.csdn.net/showwair/article/details/7529874</p> 
 <p>http://www.cnblogs.com/cfinder010/p/3434778.html</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f5357c641e7dc937dfbb9d67ae9045f6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C/C&#43;&#43;编程：openssl使用（win10&#43;vs2019）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/de9fc13dd5f4e55ea6650d3f517e669f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">BERT多语言版本预训练模型上线前需要对句子进行人工分字</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>