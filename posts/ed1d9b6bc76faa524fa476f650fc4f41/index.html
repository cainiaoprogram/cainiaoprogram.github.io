<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Android12】WindowManagerService架构分析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Android12】WindowManagerService架构分析" />
<meta property="og:description" content="Android WindowManagerService架构分析 WindowManagerService(以下简称WMS) 是Android的核心服务。WMS管理所有应用程序窗口(Window)的Create、Display、Update、Destory。
因为Android系统中只有一个WMS（运行在SystemServer进程），可以称其为全局的WMS。其主要的任务有两个：
全局的窗口管理
应用程序的显示(在屏幕上看到应用）在WMS的协助下有序、有层次的输出给底层服务，最终显示到物理屏幕上。
全局的事件管理派发
WMS为Android输入系统（InputManagerService）提供窗口相关信息，让输入事件（比如touch、homekey等等）可派发给适合的应用（窗口）。
触摸屏：主流Android设备都使用了出触控屏，支持手势触控、多指触控。
鼠标：android系统加入鼠标，通过光标触发相应动作。
硬按键：Home、back、menu等等功能按键。
WMS的客户端WindowManager WindowManager是WMS提供给使用者的API。Manager的命名方式遵循了Android通过的Service/Client框架的命名方法，即
Service端：XXXService
客户端API：XXXManager
WindowManager封装了WMS提供的AIDL对象，主要包括：
IWindowManager.aidl：官方注释为**“System private interface to the window manager.”**，定义了WMS服务提供的能力接口。 //frameworks/base/core/java/android/view/IWindowManager.aidl /* ** Copyright 2006, The Android Open Source Project ** ** Licensed under the Apache License, Version 2.0 (the &#34;License&#34;); ** you may not use this file except in compliance with the License. ** You may obtain a copy of the License at ** ** http://www." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ed1d9b6bc76faa524fa476f650fc4f41/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-16T19:24:46+08:00" />
<meta property="article:modified_time" content="2023-12-16T19:24:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Android12】WindowManagerService架构分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Android_WindowManagerService_0"></a>Android WindowManagerService架构分析</h3> 
<p>WindowManagerService(以下简称WMS) 是Android的核心服务。WMS管理所有应用程序窗口(Window)的Create、Display、Update、Destory。<br> 因为Android系统中只有一个WMS（运行在SystemServer进程），可以称其为全局的WMS。其主要的任务有两个：<br> <strong>全局的窗口管理</strong><br> 应用程序的显示(在屏幕上看到应用）在WMS的协助下<strong>有序、有层次的</strong>输出给底层服务，最终显示到物理屏幕上。<br> <strong>全局的事件管理派发</strong><br> WMS为Android输入系统（InputManagerService）提供窗口相关信息，让输入事件（比如touch、homekey等等）可派发给适合的应用（窗口）。<br> 触摸屏：主流Android设备都使用了出触控屏，支持手势触控、多指触控。<br> 鼠标：android系统加入鼠标，通过光标触发相应动作。<br> 硬按键：Home、back、menu等等功能按键。<br> <img src="https://images2.imgbox.com/94/62/BrBaGGUo_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="WMSWindowManager_11"></a>WMS的客户端WindowManager</h4> 
<p>WindowManager是WMS提供给使用者的API。Manager的命名方式遵循了Android通过的Service/Client框架的命名方法，即<br> Service端：XXXService<br> 客户端API：XXXManager</p> 
<p>WindowManager封装了WMS提供的AIDL对象，主要包括：</p> 
<ul><li>IWindowManager.aidl：官方注释为**“System private interface to the window manager.”**，定义了WMS服务提供的能力接口。</li></ul> 
<pre><code class="prism language-java"><span class="token comment">//frameworks/base/core/java/android/view/IWindowManager.aidl</span>

<span class="token comment">/*
** Copyright 2006, The Android Open Source Project
**
** Licensed under the Apache License, Version 2.0 (the "License");
** you may not use this file except in compliance with the License.
** You may obtain a copy of the License at
**
**     http://www.apache.org/licenses/LICENSE-2.0
**
** Unless required by applicable law or agreed to in writing, software
** distributed under the License is distributed on an "AS IS" BASIS,
** WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
** See the License for the specific language governing permissions and
** limitations under the License.
*/</span>

<span class="token keyword">package</span> <span class="token namespace">android<span class="token punctuation">.</span>view</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">IResultReceiver</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>policy<span class="token punctuation">.</span></span><span class="token class-name">IKeyguardDismissCallback</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>policy<span class="token punctuation">.</span></span><span class="token class-name">IShortcutService</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">IAssistDataReceiver</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>res<span class="token punctuation">.</span></span><span class="token class-name">CompatibilityInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>res<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Bitmap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">GraphicBuffer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Insets</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Point</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Rect</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Region</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">Bundle</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">IRemoteCallback</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">ParcelFileDescriptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">DisplayCutout</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IApplicationToken</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IAppTransitionAnimationSpecsFuture</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">ICrossWindowBlurEnabledListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IDisplayWindowInsetsController</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IDisplayWindowListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IDisplayFoldListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IDisplayWindowRotationController</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IOnKeyguardExitResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IPinnedTaskListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IScrollCaptureResponseListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">RemoteAnimationAdapter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IRotationWatcher</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">ISystemGestureExclusionListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IWallpaperVisibilityListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IWindow</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IWindowSession</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IWindowSessionCallback</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">KeyEvent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">InputEvent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">InsetsState</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">MagnificationSpec</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">MotionEvent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">InputChannel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">InputDevice</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IInputFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">AppTransitionAnimationSpec</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">WindowContentFrameStats</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">WindowManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">SurfaceControl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>displayhash<span class="token punctuation">.</span></span><span class="token class-name">DisplayHash</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>displayhash<span class="token punctuation">.</span></span><span class="token class-name">VerifiedDisplayHash</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * System private interface to the window manager.
 *
 * {@hide}
 */</span>
<span class="token keyword">interface</span> <span class="token class-name">IWindowManager</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">// 省略</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>IWindowSession.aidl：官方注释为“System private per-application interface to the window manager.”，同样定义WMS服务提供的能力接口。</li></ul> 
<pre><code class="prism language-java"><span class="token comment">//frameworks/base/core/java/android/view/IWindowSession.aidl</span>
<span class="token comment">/* //device/java/android/android/view/IWindowSession.aidl
**
** Copyright 2006, The Android Open Source Project
**
** Licensed under the Apache License, Version 2.0 (the "License");
** you may not use this file except in compliance with the License.
** You may obtain a copy of the License at
**
**     http://www.apache.org/licenses/LICENSE-2.0
**
** Unless required by applicable law or agreed to in writing, software
** distributed under the License is distributed on an "AS IS" BASIS,
** WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
** See the License for the specific language governing permissions and
** limitations under the License.
*/</span>

<span class="token keyword">package</span> <span class="token namespace">android<span class="token punctuation">.</span>view</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ClipData</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Point</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Rect</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Region</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">Bundle</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">RemoteCallback</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">MergedConfiguration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">DisplayCutout</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">InputChannel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IWindow</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">IWindowId</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">MotionEvent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">WindowManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">InsetsSourceControl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">InsetsState</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">Surface</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">SurfaceControl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">SurfaceControl</span><span class="token punctuation">.</span><span class="token class-name">Transaction</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>window<span class="token punctuation">.</span></span><span class="token class-name">ClientWindowFrames</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
* System private per-application interface to the window manager.
*
* {@hide}
*/</span>
<span class="token keyword">interface</span> <span class="token class-name">IWindowSession</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// 省略</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>WindowManager常用的方法有三个addView、removeView、updateViewLayout，分别对应添加窗口、移除窗口、更新窗口布局功能。</p> 
<pre><code class="prism language-java"><span class="token comment">// 获取WindowManager对象</span>
<span class="token class-name">WindowManager</span> mWindowManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WindowManager</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">WINDOW_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 构建布局</span>
<span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span> wmParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
wmParams<span class="token punctuation">.</span>xxx <span class="token operator">=</span> xxx<span class="token punctuation">;</span>
<span class="token comment">// 添加窗口到wms</span>
mWindowManager<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>xxxView，wmParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 更新窗口布局</span>
mWindowManager<span class="token punctuation">.</span><span class="token function">updateViewLayout</span><span class="token punctuation">(</span>xxxView<span class="token punctuation">,</span> xxxWmParams<span class="token punctuation">)</span>
<span class="token comment">// 从wms中移除窗口</span>
mWindowmanager<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>xxxView<span class="token punctuation">,</span> wmParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>Android支持多Display（多块物理屏或虚拟屏），在多Display情况下可以指定WindowManager绑定的Display，从而在指定的屏幕上显示内容。默认情况下，WindowManager绑定到DefaultDisplay。</p> 
<pre><code class="prism language-java"><span class="token comment">// 获取DisplayManager对象</span>
<span class="token class-name">DisplayManager</span> mDisplayManager<span class="token punctuation">;</span>
mDisplayManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DisplayManager</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">DISPLAY_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取指定DisplayID的Display，可以通过DisplayManager的getDisplays接口取得ID。</span>
<span class="token comment">// 取得Display对象</span>
<span class="token class-name">Display</span> display <span class="token operator">=</span> mDisplayManager<span class="token punctuation">.</span><span class="token function">getDisplay</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 通过特定的Display创建Context</span>
<span class="token class-name">Context</span> displayContext <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">createDisplayContext</span><span class="token punctuation">(</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取特定Display的WindowManager对象</span>
<span class="token class-name">WindowManager</span> displayWindowManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WindowManager</span><span class="token punctuation">)</span> displayContext<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">WINDOW_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="WMS_183"></a>WMS提供的主要方法源码分析</h4> 
<p>这里针对WMS提供的主要方法，根据Android12源码进行分析。</p> 
<h5><a id="WindowManager_185"></a>获取WindowManager对象</h5> 
<p>在应用中可通过如下方法获取WindowManager对象。</p> 
<pre><code class="prism language-java"><span class="token comment">// 获取WindowManager对象</span>
<span class="token class-name">WindowManager</span> mWindowManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WindowManager</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">WINDOW_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>调用context的getSystemService方法，其实现在ContextImpl.java中。</p> 
<pre><code class="prism language-java"><span class="token comment">//frameworks/base/core/java/android/app/ContextImpl.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">vmIncorrectContextUseEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Check incorrect Context usage.</span>
		<span class="token comment">// 省略</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token class-name">SystemServiceRegistry</span><span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>调用SystemServiceRegistry对象的getSystemService方法。name为<strong>window</strong>(Context.WINDOW_SERVICE对应的值）</p> 
<pre><code class="prism language-java"><span class="token comment">//frameworks/base/core/java/android/app/SystemServiceRegistry.java</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">ContextImpl</span> ctx<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// 从SYSTEM_SERVICE_FETCHERS(map)中取的Key为"Window"的value</span>
	<span class="token keyword">final</span> <span class="token class-name">ServiceFetcher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> fetcher <span class="token operator">=</span> <span class="token constant">SYSTEM_SERVICE_FETCHERS</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>fetcher <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sEnableServiceNotFoundWtf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Unknown manager requested: "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 调用getService方法</span>
	<span class="token comment">// CachedServiceFetcher&lt;T&gt;对应的getService</span>
	<span class="token keyword">final</span> <span class="token class-name">Object</span> ret <span class="token operator">=</span> fetcher<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>sEnableServiceNotFoundWtf <span class="token operator">&amp;&amp;</span> ret <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 省略</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
 * Override this class when the system service constructor needs a
 * ContextImpl and should be cached and retained by that context.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CachedServiceFetcher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ServiceFetcher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> mCacheIndex<span class="token punctuation">;</span>

	<span class="token class-name">CachedServiceFetcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Note this class must be instantiated only by the static initializer of the</span>
		<span class="token comment">// outer class (SystemServiceRegistry), which already does the synchronization,</span>
		<span class="token comment">// so bare access to sServiceCacheSize is okay here.</span>
		mCacheIndex <span class="token operator">=</span> sServiceCacheSize<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">T</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">ContextImpl</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cache <span class="token operator">=</span> ctx<span class="token punctuation">.</span>mServiceCache<span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gates <span class="token operator">=</span> ctx<span class="token punctuation">.</span>mServiceInitializationStateArray<span class="token punctuation">;</span>
		<span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

		<span class="token class-name">T</span> ret <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">boolean</span> doInitialize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Return it if we already have a cached instance.</span>
				<span class="token comment">// 如果有缓存，从缓存中取出来</span>
				<span class="token class-name">T</span> service <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> cache<span class="token punctuation">[</span>mCacheIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					ret <span class="token operator">=</span> service<span class="token punctuation">;</span>
					<span class="token comment">// 跳出循环，直接返回</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// exit the for (;;)</span>
				<span class="token punctuation">}</span>

				<span class="token comment">// If we get here, there's no cached instance.</span>

				<span class="token comment">// Grr... if gate is STATE_READY, then this means we initialized the service</span>
				<span class="token comment">// once but someone cleared it.</span>
				<span class="token comment">// We start over from STATE_UNINITIALIZED.</span>
				<span class="token comment">// Similarly, if the previous attempt returned null, we'll retry again.</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>gates<span class="token punctuation">[</span>mCacheIndex<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token constant">STATE_READY</span>
						<span class="token operator">||</span> gates<span class="token punctuation">[</span>mCacheIndex<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token constant">STATE_NOT_FOUND</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					gates<span class="token punctuation">[</span>mCacheIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token constant">STATE_UNINITIALIZED</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token comment">// It's possible for multiple threads to get here at the same time, so</span>
				<span class="token comment">// use the "gate" to make sure only the first thread will call createService().</span>

				<span class="token comment">// At this point, the gate must be either UNINITIALIZED or INITIALIZING.</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>gates<span class="token punctuation">[</span>mCacheIndex<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token constant">STATE_UNINITIALIZED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					doInitialize <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
					gates<span class="token punctuation">[</span>mCacheIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token constant">STATE_INITIALIZING</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>doInitialize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Only the first thread gets here.</span>

				<span class="token class-name">T</span> service <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token annotation punctuation">@ServiceInitializationState</span> <span class="token keyword">int</span> newState <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token constant">STATE_NOT_FOUND</span><span class="token punctuation">;</span>
				<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// This thread is the first one to get here. Instantiate the service</span>
					<span class="token comment">// *without* the cache lock held.</span>
					<span class="token comment">// 创建新的对象。对于Context.WINDOW_SERVICE，创建的是WindowManagerImpl</span>
					<span class="token comment">// 在SystemServiceRegistry初始化时，注册了各个服务对应的代理对象，感兴趣的可自行阅读源码。</span>
					service <span class="token operator">=</span> <span class="token function">createService</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
					newState <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token constant">STATE_READY</span><span class="token punctuation">;</span>

				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ServiceNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token function">onServiceNotFound</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						cache<span class="token punctuation">[</span>mCacheIndex<span class="token punctuation">]</span> <span class="token operator">=</span> service<span class="token punctuation">;</span>
						gates<span class="token punctuation">[</span>mCacheIndex<span class="token punctuation">]</span> <span class="token operator">=</span> newState<span class="token punctuation">;</span>
						cache<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				ret <span class="token operator">=</span> service<span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// exit the for (;;)</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 省略</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>interrupted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">T</span> <span class="token function">createService</span><span class="token punctuation">(</span><span class="token class-name">ContextImpl</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServiceNotFoundException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面创建了WindowManagerImpl对象，这个对象实现了 WindowManager接口类，是WMS提供的客户端代理真正实现类。</p> 
<pre><code class="prism language-java"><span class="token comment">//frameworks/base/core/java/android/view/WindowManagerImpl.java</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WindowManagerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">WindowManager</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@UnsupportedAppUsage</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">WindowManagerGlobal</span> mGlobal <span class="token operator">=</span> <span class="token class-name">WindowManagerGlobal</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@UiContext</span>
    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Context</span> mContext<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Window</span> mParentWindow<span class="token punctuation">;</span>

    <span class="token comment">/**
     * If {@link LayoutParams#token} is {@code null} and no parent window is specified, the value
     * of {@link LayoutParams#token} will be overridden to {@code mDefaultToken}.
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">IBinder</span> mDefaultToken<span class="token punctuation">;</span>

    <span class="token comment">/**
     * This token will be set to {@link LayoutParams#mWindowContextToken} and used to receive
     * configuration changes from the server side.
     */</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">IBinder</span> mWindowContextToken<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">WindowManagerImpl</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* parentWindow */</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* clientToken */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">WindowManagerImpl</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Window</span> parentWindow<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">IBinder</span> windowContextToken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
        mParentWindow <span class="token operator">=</span> parentWindow<span class="token punctuation">;</span>
        mWindowContextToken <span class="token operator">=</span> windowContextToken<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>WindowManagerImpl构造时，会调用WindowManagerGlobal单例类的getInstance方法。WindowManagerGlobal持有IWindowManager对象。所以对应一个进程来讲，默认情况下只需要一个IWindowManager对象。</p> 
<pre><code class="prism language-java"><span class="token comment">//frameworks/base/core/java/android/view/WindowManagerGlobal.java</span>
 <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">IWindowManager</span> sWindowManagerService<span class="token punctuation">;</span>

<span class="token comment">// 应用启动加载Activity时就会调用这个初始化。</span>
<span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">getWindowManagerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">WindowManagerGlobal</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">WindowManagerGlobal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sDefaultWindowManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			sDefaultWindowManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowManagerGlobal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> sDefaultWindowManager<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@UnsupportedAppUsage</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IWindowManager</span> <span class="token function">getWindowManagerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">WindowManagerGlobal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sWindowManagerService <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			sWindowManagerService <span class="token operator">=</span> <span class="token class-name">IWindowManager<span class="token punctuation">.</span>Stub</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>
					<span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token string">"window"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>sWindowManagerService <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token class-name">ValueAnimator</span><span class="token punctuation">.</span><span class="token function">setDurationScale</span><span class="token punctuation">(</span>
							sWindowManagerService<span class="token punctuation">.</span><span class="token function">getCurrentAnimatorScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					sUseBLASTAdapter <span class="token operator">=</span> sWindowManagerService<span class="token punctuation">.</span><span class="token function">useBLAST</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> sWindowManagerService<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>综上，getSystemService(Context.WINDOW_SERVICE)返回的实际上是WindowManagerImpl。WindowManagerImpl通过WindowManagerGlobal这个单例类获取IWindowManager。<br> <img src="https://images2.imgbox.com/2c/f4/CugTFL0O_o.jpg" alt="在这里插入图片描述"></p> 
<h5><a id="WindowManager_AddView_403"></a>WindowManager AddView</h5> 
<p>通过addView添加窗口到屏幕上，例如：</p> 
<pre><code class="prism language-java"><span class="token comment">// 添加窗口到wms</span>
mWindowManager<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>xxxView，wmParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>调用WindowManagerImpl的addView方法</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ViewGroup<span class="token punctuation">.</span>LayoutParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">applyTokens</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mGlobal<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> params<span class="token punctuation">,</span> mContext<span class="token punctuation">.</span><span class="token function">getDisplayNoVerify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mParentWindow<span class="token punctuation">,</span>
            mContext<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>直接调用WindowManagerGlobal的addView方法，在这个方法主要是创建了ViewRootImpl，更新了mViews和mRoots等变量。然后调用了ViewRootImpl的setView方法。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addView</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">ViewGroup<span class="token punctuation">.</span>LayoutParams</span> params<span class="token punctuation">,</span>
		<span class="token class-name">Display</span> display<span class="token punctuation">,</span> <span class="token class-name">Window</span> parentWindow<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 省略</span>
	<span class="token class-name">ViewRootImpl</span> root<span class="token punctuation">;</span>
	<span class="token class-name">View</span> panelParentView <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 创建ViewRoot</span>
		<span class="token comment">// 一个Window对应一个ViewRoot</span>
		root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewRootImpl</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> display<span class="token punctuation">)</span><span class="token punctuation">;</span>

		view<span class="token punctuation">.</span><span class="token function">setLayoutParams</span><span class="token punctuation">(</span>wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// mDyingViews：进程中所有要销毁的View</span>
		<span class="token comment">// mViews：进程中所有View</span>
		<span class="token comment">// mRoots：进程中所有ViewRootImpl</span>
		mViews<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mRoots<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mParams<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// do this last because it fires off messages to start doing things</span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			root<span class="token punctuation">.</span><span class="token function">setView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> wparams<span class="token punctuation">,</span> panelParentView<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// BadTokenException or InvalidDisplayException, clean up.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">removeViewLocked</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">throw</span> e<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ViewRootImpl的setView方法中，通过IWindowSession调用了WMS的addToDisplayAsUser方法，向WMS添加Window。WMS收到请求后，后创建WindowState与客户端的Window 一对一对应。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * We have one child
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setView</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span> attrs<span class="token punctuation">,</span> <span class="token class-name">View</span> panelParentView<span class="token punctuation">,</span>
		<span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mView <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			mView <span class="token operator">=</span> view<span class="token punctuation">;</span>
			<span class="token comment">// 省略</span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 调用IWindowSession，向WMS添加Window</span>
				res <span class="token operator">=</span> mWindowSession<span class="token punctuation">.</span><span class="token function">addToDisplayAsUser</span><span class="token punctuation">(</span>mWindow<span class="token punctuation">,</span> mWindowAttributes<span class="token punctuation">,</span>
						<span class="token function">getHostVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mDisplay<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
						mInsetsController<span class="token punctuation">.</span><span class="token function">getRequestedVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inputChannel<span class="token punctuation">,</span> mTempInsets<span class="token punctuation">,</span>
						mTempControls<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				mAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				mView <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				mAttachInfo<span class="token punctuation">.</span>mRootView <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				mFallbackEventHandler<span class="token punctuation">.</span><span class="token function">setView</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">unscheduleTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">setAccessibilityFocus</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Adding window failed"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>restore<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					attrs<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1d/c1/TvelBRBQ_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="WMS_487"></a>WMS架构</h4> 
<p><img src="https://images2.imgbox.com/9f/56/HAHIddfz_o.png" alt="在这里插入图片描述"><br> <strong>Window</strong></p> 
<ul><li>Window是一个窗口，很多图形系统都会有Window这个概念。比如CEGUI（天龙八部使用的UI系统）将Window作为最小的渲染单位，每个画面都是系列Window组成的二叉树。对于WMS来说，Window是最终呈现给用户的一块显示容器，是一系列View组成的一个画面。</li><li>实现上Window是一个抽象类，PhoneWindow是它的实现类。PhoneWindow对View进行管理。</li><li>一个Activity对应一个PhoneWindow，Activity启动时会创建与自身一一对应的PhoneWindow。</li><li><strong>Window是View的容器，View是Window的表现内容。</strong></li></ul> 
<p><strong>WindowManager</strong></p> 
<ul><li>WMS的接口类，继承ViewManager。用于给客户端管理窗口，它的实现类是WindowManagerImpl</li></ul> 
<p><strong>InputManagerService</strong></p> 
<ul><li>通过EventHub方式，从系统的输入Device节点中读取Input事件。通过WMS的协助派发给适当的应用。</li></ul> 
<p><strong>SurfaceFlinger</strong></p> 
<ul><li>分配应用程序需要的图形缓冲区，对系统整个图像窗口做Composition，最终图形窗口更新显示到Display。</li></ul> 
<p>WMS的主要功能：</p> 
<ul><li>Surface管理：wms会为所有窗口分配Surface（通过surfaceFlinger创建Surface）。客户端向WMS添加窗口（addView）的过程，实质上是WMS为其分配一块Surface的过程。一系列Surface通过WMS进行管理，有序排布（z-order）。所以，View是表象、Window载体、Surface是本质。</li><li>窗口属性管理：显示层次、size、posotion等等属性管理，这些属性经过WMS的管理后最终反馈到SurfaceFlinger中。</li><li>窗口动画：进场、退场动画。</li><li>输入中转：WMS是窗口的管理者，IMS通过EventHub输入的系统Input事件，会经由WMS转发给恰当的应用（窗口）</li></ul> 
<h5><a id="WMS_512"></a>WMS的启动</h5> 
<p>WMS在SystemServer的startOtherServices阶段启动。<br> <img src="https://images2.imgbox.com/35/d0/ejzwz56G_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="WMS_515"></a>WMS的构造方法</h4> 
<p><img src="https://images2.imgbox.com/84/f3/gsQCVu69_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="WMS_517"></a>WMS添加窗口</h5> 
<p>通过调用WMS的addWindow添加窗口，WMS在添加窗口过程中，主要完成了以下内容</p> 
<ul><li>登记Window：创建WindowState，WindowState与客户端的ViewRoot/View一一对应，通过WindowState对象，WMS可以通知到客户端的ViewRoot。创建完成后，将WindowState加入到WindowMap中进行管理。</li><li>设置DisplayContent：一个屏幕对应一个DisplayContent，将窗口与对应的DisplayContent进行绑定。</li><li>申请Surface画布：WMS向SurfaceFligner申请一块Window画布（在SurfaceFlinger中是一个Layer），Surface画布对应着一块内存（fb buffer），Surface画面申请成功后View上的内容才可能显示到屏幕上。</li></ul> 
<p>如果View没有通过WindowManager.addView添加到WMS之前，View的onDraw是不会被调用的。View上绘制的内容与WMS无关，应用端可以会用接口直接告知SurfaceFlinger进行重绘。针对描画来讲，WMS只负责窗口的管理。</p> 
<h4><a id="WMSSurfaceFlinger_525"></a>WMS与SurfaceFlinger的关系</h4> 
<p><img src="https://images2.imgbox.com/30/fc/iRGWqKZz_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="WMS_527"></a>如何调试WMS</h4> 
<p>可以通过以下几种方法调试WMS</p> 
<ul><li>dumpsys windows: WMS提供了dump方式，可以通过dumpsys查看wms内部状态。对比WMS的实现源码，以进行相关问题调查。</li></ul> 
<pre><code class="prism language-java"><span class="token comment">//frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doDump</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">,</span> <span class="token class-name">PrintWriter</span> pw<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useProto<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>使用dumpsys window -h查看支持的命令</li><li>WMS的LogTag：TAG_WITH_CLASS_NAME可以让WMS以统一的Tag”WindowManager”输出。其配置在WindowManagerDebugConfig.java文件中。</li></ul> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/WindowManagerDebugConfig.java</span>
<span class="token comment">/**
 * Common class for the various debug {@link android.util.Log} output configuration in the window
 * manager package.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowManagerDebugConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// All output logs in the window manager package use the {@link #TAG_WM} string for tagging</span>
    <span class="token comment">// their log output. This makes it easy to identify the origin of the log message when sifting</span>
    <span class="token comment">// through a large amount of log output from multiple sources. However, it also makes trying</span>
    <span class="token comment">// to figure-out the origin of a log message while debugging the window manager a little</span>
    <span class="token comment">// painful. By setting this constant to true, log messages from the window manager package</span>
    <span class="token comment">// will be tagged with their class names instead fot the generic tag.</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token constant">TAG_WITH_CLASS_NAME</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// Default log tag for the window manager package.</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG_WM</span> <span class="token operator">=</span> <span class="token string">"WindowManager"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="WMS_559"></a>关于WMS的扩展探讨</h4> 
<p>大多数系统上WMS都是核心模块之一，拥有良好人机交互是系统流行的基础。WMS虽然与描画系统有关联，但其应属于AppFramework范畴。<br> 考虑WMS，其通用性设计应该包括几个方面：</p> 
<ul><li>北向：提供稳定的API接口，提供窗口管理、层次管理、动画管理、输入管理等功能。应用通过北向接口，可以申请一块用于上屏的画布。</li><li>南向：封装并适配底层描画系统。<br> <img src="https://images2.imgbox.com/5d/e0/auDK7dx4_o.png" alt="在这里插入图片描述"></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8fabaa58d12900aee362508eb94d250a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue-cli2.x.x源码解析(部分)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/188cb74e0abd7d227a51f31e2f56e452/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">初识RabbitMq</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>