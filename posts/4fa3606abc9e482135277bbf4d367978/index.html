<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Flink Checkpoint超时 引发TaskManager进程挂掉 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Flink Checkpoint超时 引发TaskManager进程挂掉" />
<meta property="og:description" content="文章目录 Flink Checkpoint超时问题 问题现象问题分析 问题1：TaskManager进程挂掉问题2：任务长时间处于CANCELING问题3：Checkpoint超时问题4：数据无法正常同步 解决思路总结参考文档 问题现象 业务部门最近使用Flink来做数据实时同步，通过同步工具把CDC消息接入Kafka，其中上百张表同步到单个topic里，然后通过Flink来消费Kafka，做数据解析、数据分发、然后发送到目标数据库(mysql/oracle)，整个链路相对比较简单，之前通过Jstorm来实现，最近才迁移到Flink，通过Flink DataStream API来实现。代码里仅用到Kafka Source、Map、Process几个简单的算子，发送目标库的逻辑在Process的逻辑里实现，因此process的逻辑里涉及数据库连接的创建与清理、通过队列来缓存数据，创建额外线程来启动发送和消费队列的逻辑，先不说整个逻辑是否合理，本文主要基于此案例来阐述遇到的问题和排查思路以及解决方法。
业务部门使用的Flink版本为1.11.2，部署模式采用Standalone。出问题的是单机环境，即有一个JobManager进程和一个TaskManager进程。
问题现象是通过web页面观察发现启动任务后很短时间任务就发生重启，同时还会出现重启去Cancel任务的时候无法Cancel，一直处于CANCELING状态(正常会很快变成CANCELED)。并且过一段时候后TaskManager进程挂掉，导致任务一直处于无法申请Slot的状态，最终导致数据无法正常同步。因此，问题主要有以下几个现象：
Checkpoint超时子任务长时间处于CANCELING，任务长时间处于RESTARTING状态一段时间后TaskManager进程挂掉数据无法正常同步 问题分析 问题1：TaskManager进程挂掉 看到问题的第一反应是首先看TaskManager进程为什么会挂掉，这个问题比较严重，因为涉及到集群层面而不单单是任务了。查看Taskmanager日志，发现有以下片段：
// 日志1 ERROR org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Task did not exit gracefully within 180 &#43; seconds. org.apache.flink.util.FlinkRuntimeException: Task did not exit gracefully within 180 &#43; seconds. at org.apache.flink.runtime.taskmanager.Task$TaskCancelerWatchDog.run(Task.java:1572) [flink-dist_2.11-1.11.2.jar:1.11.2] at java.lang.Thread.run(Thread.java:748) [?:1.8.0_181] 2021-03-05 04:09:30,816 ERROR org.apache.flink.runtime.taskexecutor.TaskManagerRunner [] - Fatal error occurred while executing the TaskManager. Shutting it down... org.apache.flink.util.FlinkRuntimeException: Task did not exit gracefully within 180 &#43; seconds." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4fa3606abc9e482135277bbf4d367978/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-23T16:59:28+08:00" />
<meta property="article:modified_time" content="2021-12-23T16:59:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Flink Checkpoint超时 引发TaskManager进程挂掉</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <div id="content_views" class="markdown_views prism-atom-one-dark"> 
</div> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Flink_Checkpoint_0" rel="nofollow noopener noreferrer" target="_self">Flink Checkpoint超时问题</a></li><li> 
   <ul><li><a href="#_3" rel="nofollow noopener noreferrer" target="_self">问题现象</a></li><li><a href="#_20" rel="nofollow noopener noreferrer" target="_self">问题分析</a></li><li> 
     <ul><li><a href="#1TaskManager_22" rel="nofollow noopener noreferrer" target="_self">问题1：TaskManager进程挂掉</a></li><li><a href="#2CANCELING_111" rel="nofollow noopener noreferrer" target="_self">问题2：任务长时间处于CANCELING</a></li><li><a href="#3Checkpoint_135" rel="nofollow noopener noreferrer" target="_self">问题3：Checkpoint超时</a></li><li><a href="#4_206" rel="nofollow noopener noreferrer" target="_self">问题4：数据无法正常同步</a></li></ul> </li><li><a href="#_212" rel="nofollow noopener noreferrer" target="_self">解决思路</a></li><li><a href="#_222" rel="nofollow noopener noreferrer" target="_self">总结</a></li><li><a href="#_226" rel="nofollow noopener noreferrer" target="_self">参考文档</a></li></ul> </li></ul> 
</div> 
<p></p> 
<h3><a id="_3"></a>问题现象</h3> 
<p>业务部门最近使用Flink来做数据实时同步，通过同步工具把CDC消息接入Kafka，其中上百张表同步到单个topic里，然后通过Flink来消费Kafka，做数据解析、数据分发、然后发送到目标数据库(mysql/oracle)，整个链路相对比较简单，之前通过Jstorm来实现，最近才迁移到Flink，通过Flink DataStream API来实现。代码里仅用到Kafka Source、Map、Process几个简单的算子，发送目标库的逻辑在Process的逻辑里实现，因此process的逻辑里涉及数据库连接的创建与清理、通过队列来缓存数据，创建额外线程来启动发送和消费队列的逻辑，先不说整个逻辑是否合理，本文主要基于此案例来阐述遇到的问题和排查思路以及解决方法。<br> <img src="https://images2.imgbox.com/e0/f9/JgZiJHmY_o.png" alt="在这里插入图片描述"></p> 
<p>业务部门使用的Flink版本为1.11.2，部署模式采用<code>Standalone</code>。出问题的是单机环境，即有一个<code>JobManager</code>进程和一个<code>TaskManager</code>进程。</p> 
<p>问题现象是通过web页面观察发现启动任务后很短时间任务就发生重启，同时还会出现重启去<code>Cancel</code>任务的时候无法<code>Cancel</code>，一直处于<code>CANCELING</code>状态(正常会很快变成<code>CANCELED</code>)。并且过一段时候后<code>TaskManager</code>进程挂掉，导致任务一直处于无法申请<code>Slot</code>的状态，最终导致数据无法正常同步。因此，问题主要有以下几个现象：</p> 
<ol><li><code>Checkpoint</code>超时</li><li>子任务长时间处于<code>CANCELING</code>，任务长时间处于<code>RESTARTING</code>状态</li><li>一段时间后<code>TaskManager</code>进程挂掉</li><li>数据无法正常同步</li></ol> 
<h3><a id="_20"></a>问题分析</h3> 
<h4><a id="1TaskManager_22"></a>问题1：TaskManager进程挂掉</h4> 
<p>看到问题的第一反应是首先看<code>TaskManager</code>进程为什么会挂掉，这个问题比较严重，因为涉及到集群层面而不单单是任务了。查看<code>Taskmanager</code>日志，发现有以下片段：</p> 
<pre><code class="prism language-java"><span class="token comment">// 日志1</span>
ERROR <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>taskexecutor<span class="token punctuation">.</span></span>TaskExecutor</span>           <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Task</span> did not exit gracefully within <span class="token number">180</span> <span class="token operator">+</span> <span class="token class-name"><span class="token namespace">seconds<span class="token punctuation">.</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>FlinkRuntimeException</span><span class="token operator">:</span> <span class="token class-name">Task</span> did not exit gracefully within <span class="token number">180</span> <span class="token operator">+</span> seconds<span class="token punctuation">.</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>taskmanager<span class="token punctuation">.</span></span>Task</span>$<span class="token class-name">TaskCancelerWatchDog</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1572</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>flink<span class="token operator">-</span>dist_2<span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">1.11</span><span class="token number">.2</span><span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">1.11</span><span class="token number">.2</span><span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token operator">?</span><span class="token operator">:</span><span class="token number">1.8</span><span class="token number">.0_181</span><span class="token punctuation">]</span>
<span class="token number">2021</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">04</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">816</span> ERROR <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>taskexecutor<span class="token punctuation">.</span></span>TaskManagerRunner</span>      <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Fatal</span> error occurred <span class="token keyword">while</span> executing the <span class="token class-name">TaskManager<span class="token punctuation">.</span> Shutting</span> it down<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>FlinkRuntimeException</span><span class="token operator">:</span> <span class="token class-name">Task</span> did not exit gracefully within <span class="token number">180</span> <span class="token operator">+</span> seconds<span class="token punctuation">.</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>taskmanager<span class="token punctuation">.</span></span>Task</span>$<span class="token class-name">TaskCancelerWatchDog</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1572</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>flink<span class="token operator">-</span>dist_2<span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">1.11</span><span class="token number">.2</span><span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">1.11</span><span class="token number">.2</span><span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token operator">?</span><span class="token operator">:</span><span class="token number">1.8</span><span class="token number">.0_181</span><span class="token punctuation">]</span>

</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// 日志2</span>
WARN  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>taskmanager<span class="token punctuation">.</span></span>Task</span>                    <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Task</span> <span class="token string">'Source: Custom Source -&gt; Map -&gt; Process (1/1)'</span> did not react <span class="token keyword">to</span> <span class="token namespace">cancelling</span> signal <span class="token keyword">for</span> <span class="token number">30</span> seconds<span class="token punctuation">,</span> but is stuck in method<span class="token operator">:</span>
 <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>StreamTaskActionExecutor</span>$<span class="token class-name">SynchronizedStreamTaskActionExecutor</span><span class="token punctuation">.</span><span class="token function">runThrowing</span><span class="token punctuation">(</span><span class="token class-name">StreamTaskActionExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">91</span><span class="token punctuation">)</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>mailbox<span class="token punctuation">.</span></span>Mail</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Mail</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">78</span><span class="token punctuation">)</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>mailbox<span class="token punctuation">.</span></span>MailboxProcessor</span><span class="token punctuation">.</span><span class="token function">processMail</span><span class="token punctuation">(</span><span class="token class-name">MailboxProcessor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">282</span><span class="token punctuation">)</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>mailbox<span class="token punctuation">.</span></span>MailboxProcessor</span><span class="token punctuation">.</span><span class="token function">runMailboxStep</span><span class="token punctuation">(</span><span class="token class-name">MailboxProcessor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">190</span><span class="token punctuation">)</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>mailbox<span class="token punctuation">.</span></span>MailboxProcessor</span><span class="token punctuation">.</span><span class="token function">runMailboxLoop</span><span class="token punctuation">(</span><span class="token class-name">MailboxProcessor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">181</span><span class="token punctuation">)</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>StreamTask</span><span class="token punctuation">.</span><span class="token function">runMailboxLoop</span><span class="token punctuation">(</span><span class="token class-name">StreamTask</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">566</span><span class="token punctuation">)</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>StreamTask</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">StreamTask</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">536</span><span class="token punctuation">)</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>taskmanager<span class="token punctuation">.</span></span>Task</span><span class="token punctuation">.</span><span class="token function">doRun</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">721</span><span class="token punctuation">)</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>taskmanager<span class="token punctuation">.</span></span>Task</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">546</span><span class="token punctuation">)</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span>

</code></pre> 
<p>看日志1发现有关键日志<code>Task did not exit gracefully within 180 + seconds</code>打印，于是查看Flink源码，查看包含此日志的代码。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TaskCancelerWatchDog</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> hardKillDeadline <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timeoutMillis <span class="token operator">*</span> <span class="token number">1_000_000</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> millisLeft<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>executerThread<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>millisLeft <span class="token operator">=</span> <span class="token punctuation">(</span>hardKillDeadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1_000_000</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    executerThread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>millisLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>executerThread<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">"Task did not exit gracefully within "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>timeoutMillis <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" + seconds."</span><span class="token punctuation">;</span>
                taskManager<span class="token punctuation">.</span><span class="token function">notifyFatalError</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">FlinkRuntimeException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>可以看到<code>TaskCancelerWatchDog</code>是用来监听Cancel任务是否成功的线程，如果超过<code>timeoutMillis</code>执行线程还处理alive状态，则向<code>TaskManager</code>进程抛出<code>FatalError</code>，而这个<code>timeoutMillis</code>是通过<code>task.cancellation.timeout</code>参数来指定，默认是180s，如果指定为0则不开启这个功能。</p> 
<p>日志2涉及的源码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TaskInterrupter</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            executerThread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>interruptIntervalMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">shouldInterruptOnCancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> executerThread<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Task '{}' did not react to cancelling signal for {} seconds, but is stuck in method:\n {}"</span><span class="token punctuation">,</span>
                        taskName<span class="token punctuation">,</span> <span class="token punctuation">(</span>interruptIntervalMillis <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bld<span class="token punctuation">)</span><span class="token punctuation">;</span>
                executerThread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    executerThread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>interruptIntervalMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// we ignore this and fall through the loop</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// FatalError</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><code>TaskInterrupter</code>是用来中断执行线程的线程，这个日志可以看出需要Cancel但还在执行的线程的堆栈信息。从以上两段日志可以看出，<code>TaskManager</code>进程挂掉的原因是由于任务在180s内没被正常Cancel导致。为了防止<code>TaskManager</code>进程挂掉，我们添加参数<code>task.cancellation.timeout: 0</code></p> 
<h4><a id="2CANCELING_111"></a>问题2：任务长时间处于CANCELING</h4> 
<p>显然，问题1是由于问题2导致的，那问题2是什么原因导致的呢，从问题1的日志堆栈可以看到在执行<code>StreamTask.invoke</code>，此堆栈好像也没提供比较有用的信息。我们只能猜测，某个Task在执行<code>Cancel</code>的时候未被<code>Cancel</code>掉，可能是因为某种原因hang住导致，下面再进一步分析。但还有一个问题是这个Task是什么原因需要去执行<code>Cancel</code>操作呢？因为没有人为的去执行<code>Cancel</code>操作，所以肯定是Flink自己去<code>Cancel</code>的，具体的原因继续往下看，我们发现<code>standalonesession</code>(<code>JobManager</code>日志)日志里存在<code>checkpoint</code>超时的错误日志，关键信息为<code>expired before completing</code>：</p> 
<pre><code class="prism language-java">INFO  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>checkpoint<span class="token punctuation">.</span></span>CheckpointCoordinator</span>    <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Checkpoint</span> <span class="token number">58</span> of job f46ee0d14fe0e6f91253e78487796f5b expired before completing<span class="token punctuation">.</span>
INFO  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>jobmaster<span class="token punctuation">.</span></span>JobMaster</span>                 <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Trying</span> <span class="token keyword">to</span> <span class="token namespace">recover</span> from a global <span class="token class-name"><span class="token namespace">failure<span class="token punctuation">.</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>FlinkRuntimeException</span><span class="token operator">:</span> <span class="token class-name">Exceeded</span> checkpoint tolerable failure threshold<span class="token punctuation">.</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>checkpoint<span class="token punctuation">.</span></span>CheckpointFailureManager</span><span class="token punctuation">.</span><span class="token function">handleJobLevelCheckpointException</span><span class="token punctuation">(</span><span class="token class-name">CheckpointFailureManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">66</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>flink<span class="token operator">-</span>dist_2<span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">1.11</span><span class="token number">.2</span><span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">1.11</span><span class="token number">.2</span><span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>checkpoint<span class="token punctuation">.</span></span>CheckpointCoordinator</span><span class="token punctuation">.</span><span class="token function">abortPendingCheckpoint</span><span class="token punctuation">(</span><span class="token class-name">CheckpointCoordinator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1673</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>flink<span class="token operator">-</span>dist_2<span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">1.11</span><span class="token number">.2</span><span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">1.11</span><span class="token number">.2</span><span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>checkpoint<span class="token punctuation">.</span></span>CheckpointCoordinator</span><span class="token punctuation">.</span><span class="token function">abortPendingCheckpoint</span><span class="token punctuation">(</span><span class="token class-name">CheckpointCoordinator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1650</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>flink<span class="token operator">-</span>dist_2<span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">1.11</span><span class="token number">.2</span><span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">1.11</span><span class="token number">.2</span><span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>checkpoint<span class="token punctuation">.</span></span>CheckpointCoordinator</span><span class="token punctuation">.</span>access$<span class="token function">600</span><span class="token punctuation">(</span><span class="token class-name">CheckpointCoordinator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">91</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>flink<span class="token operator">-</span>dist_2<span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">1.11</span><span class="token number">.2</span><span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">1.11</span><span class="token number">.2</span><span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>checkpoint<span class="token punctuation">.</span></span>CheckpointCoordinator</span>$<span class="token class-name">CheckpointCanceller</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">CheckpointCoordinator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1783</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>flink<span class="token operator">-</span>dist_2<span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">1.11</span><span class="token number">.2</span><span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">1.11</span><span class="token number">.2</span><span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>Executors</span>$<span class="token class-name">RunnableAdapter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">Executors</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">511</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span><span class="token operator">?</span><span class="token operator">:</span><span class="token number">1.8</span><span class="token number">.0_181</span><span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>FutureTask</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">FutureTask</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">266</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span><span class="token operator">?</span><span class="token operator">:</span><span class="token number">1.8</span><span class="token number">.0_181</span><span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>ScheduledThreadPoolExecutor</span>$<span class="token class-name">ScheduledFutureTask</span><span class="token punctuation">.</span>access$<span class="token function">201</span><span class="token punctuation">(</span><span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">180</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span><span class="token operator">?</span><span class="token operator">:</span><span class="token number">1.8</span><span class="token number">.0_181</span><span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>ScheduledThreadPoolExecutor</span>$<span class="token class-name">ScheduledFutureTask</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">293</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span><span class="token operator">?</span><span class="token operator">:</span><span class="token number">1.8</span><span class="token number">.0_181</span><span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>ThreadPoolExecutor</span><span class="token punctuation">.</span><span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1149</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span><span class="token operator">?</span><span class="token operator">:</span><span class="token number">1.8</span><span class="token number">.0_181</span><span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>ThreadPoolExecutor</span>$<span class="token class-name">Worker</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">624</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span><span class="token operator">?</span><span class="token operator">:</span><span class="token number">1.8</span><span class="token number">.0_181</span><span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span><span class="token operator">?</span><span class="token operator">:</span><span class="token number">1.8</span><span class="token number">.0_181</span><span class="token punctuation">]</span>

</code></pre> 
<p>因此接着看第三个问题</p> 
<h4><a id="3Checkpoint_135"></a>问题3：Checkpoint超时</h4> 
<p><code>expired before completing</code>的日志意味着<code>checkpoint</code>发生超时，确认任务配置参数，配置如下：</p> 
<pre><code class="prism language-java">execution<span class="token punctuation">.</span>checkpointing<span class="token punctuation">.</span>interval<span class="token operator">:</span> <span class="token number">60000</span>
execution<span class="token punctuation">.</span>checkpointing<span class="token punctuation">.</span>timeout<span class="token operator">:</span> <span class="token number">60000</span>
execution<span class="token punctuation">.</span>checkpointing<span class="token punctuation">.</span>max<span class="token operator">-</span>concurrent<span class="token operator">-</span>checkpoints<span class="token operator">:</span> <span class="token number">500</span>
execution<span class="token punctuation">.</span>checkpointing<span class="token punctuation">.</span>min<span class="token operator">-</span>pause<span class="token operator">:</span> <span class="token number">500</span>
</code></pre> 
<p>一开始以为<code>checkpoint</code>超时时间设置太短，于是增大超时时间到30分钟，但从web界面发现，大量<code>checkpoint</code>处于pendding状态，最终还会超时。因为未设置<code>execution.checkpointing.tolerable-failed-checkpoints</code>，因此一旦发生超时，任务将会发生重启。</p> 
<p>看代码和日志都看不出个所以然，只能查看<code>TaskManager</code>进程的堆栈来排查了，目的是看下发生<code>checkpoint</code>超时的时候内部线程运行情况是怎么样的。Flink1.11.2也提供了web界面查看stack的功能，但相比jstack命令打印的还是有点区别，这里还是采用jstack -l id &gt; id.jstack的方式来进行排查。<br> <img src="https://images2.imgbox.com/bd/de/Z7IRCuYf_o.png" alt="在这里插入图片描述"></p> 
<p>查看stack发现有处于<code>BLOCKED</code>状态的线程</p> 
<pre><code class="prism language-java"><span class="token string">"Source: Custom Source -&gt; Map -&gt; mysqlmsg (1/1)"</span> #<span class="token number">77</span> prio<span class="token operator">=</span><span class="token number">5</span> os_prio<span class="token operator">=</span><span class="token number">0</span> tid<span class="token operator">=</span><span class="token number">0x00007fb560080800</span> nid<span class="token operator">=</span><span class="token number">0x7c3b</span> waiting <span class="token keyword">for</span> monitor entry <span class="token punctuation">[</span><span class="token number">0x00007fb539609000</span><span class="token punctuation">]</span>
   <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread<span class="token punctuation">.</span>State</span><span class="token operator">:</span> BLOCKED <span class="token punctuation">(</span>on object monitor<span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>StreamTaskActionExecutor</span>$<span class="token class-name">SynchronizedStreamTaskActionExecutor</span><span class="token punctuation">.</span><span class="token function">runThrowing</span><span class="token punctuation">(</span><span class="token class-name">StreamTaskActionExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">91</span><span class="token punctuation">)</span>
	<span class="token operator">-</span> waiting <span class="token keyword">to</span> <span class="token namespace">lock</span> <span class="token generics"><span class="token punctuation">&lt;</span>0x0000000702a61a58<span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span>

</code></pre> 
<p>接着查看<code>0x0000000702a61a58</code>对应的线程</p> 
<pre><code class="prism language-java"><span class="token string">"Legacy Source Thread - Source: Custom Source -&gt; Map -&gt; mysqlmsg (1/1)"</span> #<span class="token number">82</span> prio<span class="token operator">=</span><span class="token number">5</span> os_prio<span class="token operator">=</span><span class="token number">0</span> tid<span class="token operator">=</span><span class="token number">0x00007fb48c485000</span> nid<span class="token operator">=</span><span class="token number">0x7c4e</span> in <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0x00007fb47f3fd000</span><span class="token punctuation">]</span>
   <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread<span class="token punctuation">.</span>State</span><span class="token operator">:</span> TIMED_WAITING <span class="token punctuation">(</span>on object monitor<span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>pooled<span class="token punctuation">.</span></span>PooledDataSource</span><span class="token punctuation">.</span><span class="token function">popConnection</span><span class="token punctuation">(</span><span class="token class-name">PooledDataSource</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">451</span><span class="token punctuation">)</span>
	<span class="token operator">-</span> locked <span class="token generics"><span class="token punctuation">&lt;</span>0x000000070396d180<span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>pooled<span class="token punctuation">.</span></span>PoolState</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>pooled<span class="token punctuation">.</span></span>PooledDataSource</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token class-name">PooledDataSource</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">90</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>JdbcTransaction</span><span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token class-name">JdbcTransaction</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">139</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>JdbcTransaction</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token class-name">JdbcTransaction</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">61</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span></span>BaseExecutor</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token class-name">BaseExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">338</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span></span>SimpleExecutor</span><span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token class-name">SimpleExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">84</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span></span>SimpleExecutor</span><span class="token punctuation">.</span><span class="token function">doQuery</span><span class="token punctuation">(</span><span class="token class-name">SimpleExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">62</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span></span>BaseExecutor</span><span class="token punctuation">.</span><span class="token function">queryFromDatabase</span><span class="token punctuation">(</span><span class="token class-name">BaseExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">326</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span></span>BaseExecutor</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">BaseExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">156</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span></span>CachingExecutor</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">CachingExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">109</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span></span>CachingExecutor</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">CachingExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">83</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span></span>DefaultSqlSession</span><span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">DefaultSqlSession</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">148</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span></span>DefaultSqlSession</span><span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">DefaultSqlSession</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">141</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span></span>DefaultSqlSession</span><span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token class-name">DefaultSqlSession</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">77</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>binding<span class="token punctuation">.</span></span>MapperMethod</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">MapperMethod</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">83</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>binding<span class="token punctuation">.</span></span>MapperProxy</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MapperProxy</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">59</span><span class="token punctuation">)</span>
	at com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>$<span class="token class-name">Proxy35</span><span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token punctuation">)</span>
<span class="token comment">//省略</span>
       <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>operators<span class="token punctuation">.</span></span>StreamSourceContexts</span>$<span class="token class-name">NonTimestampContext</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">StreamSourceContexts</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">104</span><span class="token punctuation">)</span>
	<span class="token operator">-</span> locked <span class="token generics"><span class="token punctuation">&lt;</span>0x0000000702a61a58<span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>operators<span class="token punctuation">.</span></span>StreamSourceContexts</span>$<span class="token class-name">NonTimestampContext</span><span class="token punctuation">.</span><span class="token function">collectWithTimestamp</span><span class="token punctuation">(</span><span class="token class-name">StreamSourceContexts</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">111</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>internals<span class="token punctuation">.</span></span>AbstractFetcher</span><span class="token punctuation">.</span><span class="token function">emitRecordsWithTimestamps</span><span class="token punctuation">(</span><span class="token class-name">AbstractFetcher</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">352</span><span class="token punctuation">)</span>
	<span class="token operator">-</span> locked <span class="token generics"><span class="token punctuation">&lt;</span>0x0000000702a61a58<span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>internal<span class="token punctuation">.</span></span>KafkaFetcher</span><span class="token punctuation">.</span><span class="token function">partitionConsumerRecordsHandler</span><span class="token punctuation">(</span><span class="token class-name">KafkaFetcher</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">185</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>internal<span class="token punctuation">.</span></span>KafkaFetcher</span><span class="token punctuation">.</span><span class="token function">runFetchLoop</span><span class="token punctuation">(</span><span class="token class-name">KafkaFetcher</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">141</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span>FlinkKafkaConsumerBase</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">FlinkKafkaConsumerBase</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">755</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>operators<span class="token punctuation">.</span></span>StreamSource</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">StreamSource</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">100</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>operators<span class="token punctuation">.</span></span>StreamSource</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">StreamSource</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">63</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>SourceStreamTask</span>$<span class="token class-name">LegacySourceFunctionThread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SourceStreamTask</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">213</span><span class="token punctuation">)</span>

   <span class="token class-name">Locked</span> ownable synchronizers<span class="token operator">:</span>
	<span class="token operator">-</span> <span class="token class-name">None</span>

</code></pre> 
<p>可以看到<code>PooledDataSource.popConnection</code>一直在阻塞，即在获取连接时阻塞了。于是查看初始化连接池的配置，没有配置<code>poolMaximumActiveConnections</code>，即默认最大连接数为10，而代码在<code>ProcessFunction</code>的<code>processElement</code>方法里采用短连接方式获取数据库连接，每次来一波数据都创建连接，发送完断开连接。因此很容易因为获取不到连接而使得<code>processElement</code>方法处于阻塞状态。而<code>processElement</code>方法阻塞进而影响<code>Barrier</code>的流动，所以导致了<code>Checkpoint</code>发生超时。</p> 
<h4><a id="4_206"></a>问题4：数据无法正常同步</h4> 
<p>基于以上几个问题的定位，这个问题就很好解释了，首先由于阻塞导致了<code>Checkpoint</code>发生超时(问题3)，然后导致任务重启，在重启时由于阻塞的线程hang住无法<code>Cancel</code>(问题2)，由于<code>TaskCancelerWatchDog</code>的存在导致超过默认时间180s后<code>TaskManager</code>挂掉(问题1)。最后导致了问题4数据无法正常同步。</p> 
<h3><a id="_212"></a>解决思路</h3> 
<p>原因定位清楚了，离解决问题就近在咫尺了，可以采用几种方式：</p> 
<ul><li>增加最大活跃线程数<code>poolMaximumActiveConnections</code>；</li><li>采用长连接，在<code>open</code>时初始化连接，<code>close</code>方法销毁连接；</li><li>不用另外开启连接，直接采用<code>flink-jdbc-connector</code>来发送数据，因为数据源涉及上百张表，需要有分流的操作。</li></ul> 
<h3><a id="_222"></a>总结</h3> 
<p>本文基于实时同步任务遇到无法正常同步的问题进行排查分析，旨在提供一种当遇到<code>Flink Checkpoint</code>超时问题时的排查思路，同时也顺便介绍了在<code>Standalone</code>部署模式下运行Flink任务的一种典型问题-<code>TaskManager</code>无缘无故挂掉的问题，希望给正在使用Flink的同学提供一种思路，避免踩坑。</p> 
<h3><a id="_226"></a>参考文档</h3> 
<p><a href="https://www.xncoding.com/2018/06/25/java/jstack.html" rel="nofollow">jstack详解</a><br> <a href="https://www.cnblogs.com/jabnih/p/5738432.html" rel="nofollow">MyBatis-内置DataSource实现</a></p> 原文链接：https://blog.csdn.net/lisenyeahyeah/article/details/114582285
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6aac6f62b5e0b07ce24129c32f54eab8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">一个傻瓜式构建可视化 web的 Python 神器 -- streamlit 教程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/43780264018f36182e83b80828d1d807/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">VS工程中报错 常量中有换行符</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>