<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>用NetCore手撸RTSP交互协议 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="用NetCore手撸RTSP交互协议" />
<meta property="og:description" content="注意点
1. DESCRIBE 第1次发送时返回401错误，返回信息带 realm，nonce，参数使用MD5校验后重新发送；
2. SETUP 的url信息，由DESCRIBE返回的head中的sdp字符串中解析，readonly，x-dimensions（视频分辨率），control（视频url），rtpmap（编解码信息）
3.PLAY的Session信息，由SETUP返回的head中的Session
4.解析完后，tcpclient接收rtp数据包，可用ffmepg进行解码
核心代码RTSPClient.cs
using System.Net.Sockets; using System.Text; namespace RtspClientCore { class RtspClient { string rtspUrl = &#34;rtsp://192.168.0.2:554/h264/ch1/main/av_stream&#34;; string username = &#34;admin&#34;; string password = &#34;thzn123456&#34;; TcpClient tcpClient; NetworkStream tcpStream; private int cseq; public Uri rtspUri { get; set; } public int NewCSeq { get { return &#43;&#43;cseq; } } string Authorization = &#34;&#34;; string Session = &#34;&#34;; string UserAgent = &#34;C# RTSP Client&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6d113f69e5edbcd774491ff121b635e6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-16T17:21:27+08:00" />
<meta property="article:modified_time" content="2023-03-16T17:21:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">用NetCore手撸RTSP交互协议</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p class="img-center"><img alt="" src="https://images2.imgbox.com/49/5e/64K7SKem_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/0e/8b/oC4yPwVr_o.png"></p> 
<p> 注意点</p> 
<p>1. DESCRIBE 第1次发送时返回401错误，返回信息带 realm，nonce，参数使用MD5校验后重新发送；</p> 
<p>2. SETUP 的url信息，由DESCRIBE返回的head中的sdp字符串中解析，readonly，x-dimensions（视频分辨率），control（视频url），rtpmap（编解码信息）</p> 
<p>3.PLAY的Session信息，由SETUP返回的head中的Session</p> 
<p>4.解析完后，tcpclient接收rtp数据包，可用ffmepg进行解码</p> 
<p> </p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/c6/dc/GKrWgNHv_o.png"></p> 
<p>核心代码RTSPClient.cs</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/f8/fe/bxKafvHm_o.gif"></p> 
<pre>using System.Net.Sockets;
using System.Text;

namespace RtspClientCore
{
    class RtspClient
    {
        string rtspUrl = "rtsp://192.168.0.2:554/h264/ch1/main/av_stream";
        string username = "admin";
        string password = "thzn123456";

        TcpClient tcpClient;
        NetworkStream tcpStream;

        private int cseq;

        public Uri rtspUri { get; set; }

        public int NewCSeq
        {
            get
            {
                return ++cseq;
            }
        }

        string Authorization = "";
        string Session = "";
        string UserAgent = "C# RTSP Client";

        public RtspClient(string rtspUrl, string username, string password)
        {
            this.rtspUrl = rtspUrl;
            this.username = username;
            this.password = password;

            this.rtspUri = new Uri(rtspUrl);
            this.tcpClient = new TcpClient(rtspUri.Host, rtspUri.Port);
            this.tcpStream = tcpClient.GetStream();
        }

        RTSPResponse ExcuteRequest(string method, string url, string request, bool skip = false)
        {
            string temp = request + "\r\n";
            temp = temp.Replace("@CSeq", NewCSeq.ToString());

            Logger.Info(temp);

            // SendRequest
            byte[] requestBytes = Encoding.ASCII.GetBytes(temp);
            tcpStream.Write(requestBytes, 0, requestBytes.Length);

            // ReadResponse 
            StreamReader reader = new StreamReader(tcpStream);

            RTSPResponse r1 = new RTSPResponse(reader, skip); 

            switch (r1.StatusCode)
            { 
                case "401":
                    {
                        //RTSP / 1.0 401 Unauthorized
                        //CSeq: 1
                        //WWW - Authenticate: Digest realm = "IP Camera(G7574)", nonce = "d355a9a6a081d0d5ce50d0dd90a14148", stale = "FALSE"
                        //Date: Thu, Mar 16 2023 10:34:24 GMT 
                        string realm = string.Empty;
                        string nonce = string.Empty;
                        string authType = string.Empty;

                        var auth = r1.Headers.Where(x =&gt; x.Key == "WWW-Authenticate").FirstOrDefault(); 

                        if (auth.Value.Contains("Digest"))
                        {
                            // 摘要认证
                            authType = "Digest";
                            RtspUtil.GetDigestParams(auth.Value, ref realm, ref nonce); 
                        }
                        else if (auth.Value.Contains("Basic"))
                        {
                            // 基本认证
                            authType = "Basic";// Authorization: Basic YWRtaW46YWRtaW4=\r\n\r\n
                        }
                        else
                        {
                            throw new Exception("Server auth mode not support:" + auth);
                        }
                         
                        Authorization = RtspUtil.GetAuthorization(authType, url, username, password, realm, nonce, method);

                        request += "Authorization:" + Authorization + "\r\n";

                        r1 = ExcuteRequest(method, url, request, false);
                    }
                    break;
            }

            return r1;
        }

        public RTSPResponse DESCRIBE()
        {
            string mothed = "DESCRIBE";
            StringBuilder request = new StringBuilder();
            request.Append(mothed + " " + rtspUrl + " RTSP/1.0\r\n");
            request.Append("CSeq: @CSeq\r\n");
            request.Append("User-Agent: " + UserAgent + "\r\n");
            request.Append("Accept: application/sdp\r\n");
            return ExcuteRequest(mothed, rtspUrl, request.ToString());  
        }

        public RTSPResponse SETUP(string url)
        {
            string mothed = "SETUP";
            StringBuilder request = new StringBuilder();
            request.Append(mothed + " " + url + " RTSP/1.0\r\n");
            request.Append("CSeq: @CSeq\r\n"); 
            request.Append("Authorization: " + Authorization + "\r\n");
            request.Append("User-Agent: " + UserAgent + "\r\n");
            request.Append("Transport: RTP/AVP/TCP;unicast;interleaved=0-1\r\n");
            return ExcuteRequest(mothed, rtspUrl, request.ToString()); 
        }

        public RTSPResponse PLAY(string url)
        {
            string mothed = "PLAY";
            StringBuilder request = new StringBuilder();
            request.Append(mothed + " " + url + " RTSP/1.0\r\n");
            request.Append("CSeq: @CSeq\r\n");
            request.Append("Authorization: " + Authorization + "\r\n");
            request.Append("User-Agent: " + UserAgent + "\r\n");
            request.Append("Session: " + this.Session + "\r\n");
            request.Append("Range: npt=0.000-\r\n");
            return ExcuteRequest(mothed, rtspUrl, request.ToString(), true);
        }

        public RTSPResponse TEARDOWN(string url, string session)
        {
            string mothed = "TEARDOWN";
            StringBuilder request = new StringBuilder();
            request.Append(mothed + " " + url + " RTSP/1.0\r\n");
            request.Append("CSeq: @CSeq\r\n");
            request.Append("Authorization: " + Authorization + "\r\n");
            request.Append("User-Agent: " + UserAgent + "\r\n");
            request.Append("Session: " + this.Session + "\r\n"); 
            return ExcuteRequest(mothed, rtspUrl, request.ToString(), true);
        } 

        public void Start()
        {
            RTSPResponse r1 = DESCRIBE();

            if ("200" == r1.StatusCode)
            {
                SDP sdp_data = new SDP(r1.Response);

                bool find = false; bool video1 = false; bool video2 = false; var dimensions = string.Empty; var control = string.Empty; var rtpmap = string.Empty;

                for (int x = 0; x &lt; sdp_data.MediaDescribes.Count; x++)
                {
                    var items = sdp_data.MediaDescribes[x].a;

                    foreach (var item in items)
                    {
                        string mediainfo = item.ToLower();

                        if (mediainfo.Contains("recvonly"))
                        {
                            video1 = true;
                        }
                        if (mediainfo.Contains("x-dimensions"))
                        {
                            video2 = true;
                            dimensions = item;
                        }
                        if (mediainfo.Contains("control"))
                        {
                            control = item.Replace("control:", "");
                        }
                        if (mediainfo.Contains("rtpmap"))
                        {
                            rtpmap = item.Replace("rtpmap:", "");
                        } 
                        if (video1 &amp;&amp; video2 &amp; !string.IsNullOrEmpty(control) &amp; !string.IsNullOrEmpty(rtpmap))
                        {
                            find = true;
                            break;
                        }
                    }

                    if (find)
                    {
                        break;
                    }
                }

                RTSPResponse r2 = SETUP(control);
                if ("200" == r2.StatusCode)
                { 
                    string sessionVal = r2.Headers.Where(x =&gt; x.Key == "Session").FirstOrDefault().Value;
                    if (!string.IsNullOrEmpty(sessionVal))
                    {
                        string[] sessionParms = sessionVal.Split(';');
                        if (sessionParms.Length &gt; 1)
                        {
                            this.Session = sessionParms[0];
                        }
                        else
                        {
                            this.Session = sessionVal;
                        }
                        RTSPResponse r3 = PLAY(control);
                        if ("200" == r3.StatusCode)
                        {
                            // 接收rtp数据
                            byte[] buffer = new byte[1024];
                            while (true)
                            {
                                int bytesRead = tcpStream.Read(buffer, 0, buffer.Length);
                                if (bytesRead == 0)
                                {
                                    break;
                                }
                                // 处理接收到的RTP数据
                                //Console.WriteLine($"Received {bytesRead} bytes of RTP data.");
                            }
                        }
                    }
                }
            }
        }
    }
}</pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b1d4e73d9a94f21dec7187ae14958337/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python如何打包exe文件? 如何换成喜欢的图标?</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a071855cfe49d79d5aac422f726df76c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">经典卷积模型回顾25—利用蒸馏对DenseNet201进行处理，并实现图像分类（matlab）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>