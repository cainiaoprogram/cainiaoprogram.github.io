<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C&#43;&#43;操作Windows防火墙添加例外程序 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C&#43;&#43;操作Windows防火墙添加例外程序" />
<meta property="og:description" content="C&#43;&#43;操作Windows防火墙添加例外程序 以下代码示例练习Windows防火墙配置文件。 显示当前配置文件，关闭防火墙，打开防火墙并添加应用程序。
/* Copyright (c) Microsoft Corporation SYNOPSIS Sample code for the Windows Firewall COM interface. */ #include &lt;windows.h&gt; #include &lt;crtdbg.h&gt; #include &lt;netfw.h&gt; #include &lt;objbase.h&gt; #include &lt;oleauto.h&gt; #include &lt;stdio.h&gt; #pragma comment( lib, &#34;ole32.lib&#34; ) #pragma comment( lib, &#34;oleaut32.lib&#34; ) HRESULT WindowsFirewallInitialize(OUT INetFwProfile** fwProfile) { HRESULT hr = S_OK; INetFwMgr* fwMgr = NULL; INetFwPolicy* fwPolicy = NULL; _ASSERT(fwProfile != NULL); *fwProfile = NULL; // Create an instance of the firewall settings manager." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a842c4102cfdf7173c0381687508c17a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-15T17:24:15+08:00" />
<meta property="article:modified_time" content="2020-05-15T17:24:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C&#43;&#43;操作Windows防火墙添加例外程序</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="CWindows_0"></a>C++操作Windows防火墙添加例外程序</h3> 
<p>以下代码示例练习Windows防火墙配置文件。 显示当前配置文件，关闭防火墙，打开防火墙并添加应用程序。</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*
    Copyright (c) Microsoft Corporation

    SYNOPSIS

        Sample code for the Windows Firewall COM interface.
*/</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;windows.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;crtdbg.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netfw.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;objbase.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;oleauto.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">pragma</span> comment( lib, "ole32.lib" )</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> comment( lib, "oleaut32.lib" )</span>


HRESULT <span class="token function">WindowsFirewallInitialize</span><span class="token punctuation">(</span>OUT INetFwProfile<span class="token operator">*</span><span class="token operator">*</span> fwProfile<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    HRESULT hr <span class="token operator">=</span> S_OK<span class="token punctuation">;</span>
    INetFwMgr<span class="token operator">*</span> fwMgr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    INetFwPolicy<span class="token operator">*</span> fwPolicy <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>fwProfile <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>fwProfile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">// Create an instance of the firewall settings manager.</span>
    hr <span class="token operator">=</span> <span class="token function">CoCreateInstance</span><span class="token punctuation">(</span>
            <span class="token function">__uuidof</span><span class="token punctuation">(</span>NetFwMgr<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span>
            CLSCTX_INPROC_SERVER<span class="token punctuation">,</span>
            <span class="token function">__uuidof</span><span class="token punctuation">(</span>INetFwMgr<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>fwMgr
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"CoCreateInstance failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Retrieve the local firewall policy.</span>
    hr <span class="token operator">=</span> fwMgr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_LocalPolicy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fwPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get_LocalPolicy failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Retrieve the firewall profile currently in effect.</span>
    hr <span class="token operator">=</span> fwPolicy<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_CurrentProfile</span><span class="token punctuation">(</span>fwProfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get_CurrentProfile failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

error<span class="token operator">:</span>

    <span class="token comment">// Release the local firewall policy.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwPolicy <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        fwPolicy<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Release the firewall settings manager.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwMgr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        fwMgr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> hr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">WindowsFirewallCleanup</span><span class="token punctuation">(</span>IN INetFwProfile<span class="token operator">*</span> fwProfile<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Release the firewall profile.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwProfile <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        fwProfile<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


HRESULT <span class="token function">WindowsFirewallIsOn</span><span class="token punctuation">(</span>IN INetFwProfile<span class="token operator">*</span> fwProfile<span class="token punctuation">,</span> OUT BOOL<span class="token operator">*</span> fwOn<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    HRESULT hr <span class="token operator">=</span> S_OK<span class="token punctuation">;</span>
    VARIANT_BOOL fwEnabled<span class="token punctuation">;</span>

    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>fwProfile <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>fwOn <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>fwOn <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>

    <span class="token comment">// Get the current state of the firewall.</span>
    hr <span class="token operator">=</span> fwProfile<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_FirewallEnabled</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fwEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get_FirewallEnabled failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Check to see if the firewall is on.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwEnabled <span class="token operator">!=</span> VARIANT_FALSE<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>fwOn <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The firewall is on.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The firewall is off.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

error<span class="token operator">:</span>

    <span class="token keyword">return</span> hr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


HRESULT <span class="token function">WindowsFirewallTurnOn</span><span class="token punctuation">(</span>IN INetFwProfile<span class="token operator">*</span> fwProfile<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    HRESULT hr <span class="token operator">=</span> S_OK<span class="token punctuation">;</span>
    BOOL fwOn<span class="token punctuation">;</span>

    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>fwProfile <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Check to see if the firewall is off.</span>
    hr <span class="token operator">=</span> <span class="token function">WindowsFirewallIsOn</span><span class="token punctuation">(</span>fwProfile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fwOn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WindowsFirewallIsOn failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If it is, turn it on.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fwOn<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Turn the firewall on.</span>
        hr <span class="token operator">=</span> fwProfile<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">put_FirewallEnabled</span><span class="token punctuation">(</span>VARIANT_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"put_FirewallEnabled failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The firewall is now on.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

error<span class="token operator">:</span>

    <span class="token keyword">return</span> hr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


HRESULT <span class="token function">WindowsFirewallTurnOff</span><span class="token punctuation">(</span>IN INetFwProfile<span class="token operator">*</span> fwProfile<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    HRESULT hr <span class="token operator">=</span> S_OK<span class="token punctuation">;</span>
    BOOL fwOn<span class="token punctuation">;</span>

    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>fwProfile <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Check to see if the firewall is on.</span>
    hr <span class="token operator">=</span> <span class="token function">WindowsFirewallIsOn</span><span class="token punctuation">(</span>fwProfile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fwOn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WindowsFirewallIsOn failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If it is, turn it off.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwOn<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Turn the firewall off.</span>
        hr <span class="token operator">=</span> fwProfile<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">put_FirewallEnabled</span><span class="token punctuation">(</span>VARIANT_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"put_FirewallEnabled failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The firewall is now off.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

error<span class="token operator">:</span>

    <span class="token keyword">return</span> hr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


HRESULT <span class="token function">WindowsFirewallAppIsEnabled</span><span class="token punctuation">(</span>
            IN INetFwProfile<span class="token operator">*</span> fwProfile<span class="token punctuation">,</span>
            IN <span class="token keyword">const</span> <span class="token keyword">wchar_t</span><span class="token operator">*</span> fwProcessImageFileName<span class="token punctuation">,</span>
            OUT BOOL<span class="token operator">*</span> fwAppEnabled
            <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    HRESULT hr <span class="token operator">=</span> S_OK<span class="token punctuation">;</span>
    BSTR fwBstrProcessImageFileName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    VARIANT_BOOL fwEnabled<span class="token punctuation">;</span>
    INetFwAuthorizedApplication<span class="token operator">*</span> fwApp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    INetFwAuthorizedApplications<span class="token operator">*</span> fwApps <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>fwProfile <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>fwProcessImageFileName <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>fwAppEnabled <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>fwAppEnabled <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>

    <span class="token comment">// Retrieve the authorized application collection.</span>
    hr <span class="token operator">=</span> fwProfile<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_AuthorizedApplications</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fwApps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get_AuthorizedApplications failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Allocate a BSTR for the process image file name.</span>
    fwBstrProcessImageFileName <span class="token operator">=</span> <span class="token function">SysAllocString</span><span class="token punctuation">(</span>fwProcessImageFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwBstrProcessImageFileName <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        hr <span class="token operator">=</span> E_OUTOFMEMORY<span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SysAllocString failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Attempt to retrieve the authorized application.</span>
    hr <span class="token operator">=</span> fwApps<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Item</span><span class="token punctuation">(</span>fwBstrProcessImageFileName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fwApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Find out if the authorized application is enabled.</span>
        hr <span class="token operator">=</span> fwApp<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_Enabled</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fwEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get_Enabled failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fwEnabled <span class="token operator">!=</span> VARIANT_FALSE<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// The authorized application is enabled.</span>
            <span class="token operator">*</span>fwAppEnabled <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>

            <span class="token function">printf</span><span class="token punctuation">(</span>
                <span class="token string">"Authorized application %lS is enabled in the firewall.\n"</span><span class="token punctuation">,</span>
                fwProcessImageFileName
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span>
                <span class="token string">"Authorized application %lS is disabled in the firewall.\n"</span><span class="token punctuation">,</span>
                fwProcessImageFileName
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// The authorized application was not in the collection.</span>
        hr <span class="token operator">=</span> S_OK<span class="token punctuation">;</span>

        <span class="token function">printf</span><span class="token punctuation">(</span>
            <span class="token string">"Authorized application %lS is disabled in the firewall.\n"</span><span class="token punctuation">,</span>
            fwProcessImageFileName
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

error<span class="token operator">:</span>

    <span class="token comment">// Free the BSTR.</span>
    <span class="token function">SysFreeString</span><span class="token punctuation">(</span>fwBstrProcessImageFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Release the authorized application instance.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwApp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        fwApp<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Release the authorized application collection.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwApps <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        fwApps<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> hr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


HRESULT <span class="token function">WindowsFirewallAddApp</span><span class="token punctuation">(</span>
            IN INetFwProfile<span class="token operator">*</span> fwProfile<span class="token punctuation">,</span>
            IN <span class="token keyword">const</span> <span class="token keyword">wchar_t</span><span class="token operator">*</span> fwProcessImageFileName<span class="token punctuation">,</span>
            IN <span class="token keyword">const</span> <span class="token keyword">wchar_t</span><span class="token operator">*</span> fwName
            <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    HRESULT hr <span class="token operator">=</span> S_OK<span class="token punctuation">;</span>
    BOOL fwAppEnabled<span class="token punctuation">;</span>
    BSTR fwBstrName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    BSTR fwBstrProcessImageFileName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    INetFwAuthorizedApplication<span class="token operator">*</span> fwApp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    INetFwAuthorizedApplications<span class="token operator">*</span> fwApps <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>fwProfile <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>fwProcessImageFileName <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>fwName <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// First check to see if the application is already authorized.</span>
    hr <span class="token operator">=</span> <span class="token function">WindowsFirewallAppIsEnabled</span><span class="token punctuation">(</span>
            fwProfile<span class="token punctuation">,</span>
            fwProcessImageFileName<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>fwAppEnabled
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WindowsFirewallAppIsEnabled failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Only add the application if it isn't already authorized.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fwAppEnabled<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Retrieve the authorized application collection.</span>
        hr <span class="token operator">=</span> fwProfile<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_AuthorizedApplications</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fwApps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get_AuthorizedApplications failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Create an instance of an authorized application.</span>
        hr <span class="token operator">=</span> <span class="token function">CoCreateInstance</span><span class="token punctuation">(</span>
                <span class="token function">__uuidof</span><span class="token punctuation">(</span>NetFwAuthorizedApplication<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token constant">NULL</span><span class="token punctuation">,</span>
                CLSCTX_INPROC_SERVER<span class="token punctuation">,</span>
                <span class="token function">__uuidof</span><span class="token punctuation">(</span>INetFwAuthorizedApplication<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>fwApp
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"CoCreateInstance failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Allocate a BSTR for the process image file name.</span>
        fwBstrProcessImageFileName <span class="token operator">=</span> <span class="token function">SysAllocString</span><span class="token punctuation">(</span>fwProcessImageFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fwBstrProcessImageFileName <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            hr <span class="token operator">=</span> E_OUTOFMEMORY<span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SysAllocString failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Set the process image file name.</span>
        hr <span class="token operator">=</span> fwApp<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">put_ProcessImageFileName</span><span class="token punctuation">(</span>fwBstrProcessImageFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"put_ProcessImageFileName failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Allocate a BSTR for the application friendly name.</span>
        fwBstrName <span class="token operator">=</span> <span class="token function">SysAllocString</span><span class="token punctuation">(</span>fwName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SysStringLen</span><span class="token punctuation">(</span>fwBstrName<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            hr <span class="token operator">=</span> E_OUTOFMEMORY<span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SysAllocString failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Set the application friendly name.</span>
        hr <span class="token operator">=</span> fwApp<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">put_Name</span><span class="token punctuation">(</span>fwBstrName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"put_Name failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Add the application to the collection.</span>
        hr <span class="token operator">=</span> fwApps<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Add</span><span class="token punctuation">(</span>fwApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Add failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">printf</span><span class="token punctuation">(</span>
            <span class="token string">"Authorized application %lS is now enabled in the firewall.\n"</span><span class="token punctuation">,</span>
            fwProcessImageFileName
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

error<span class="token operator">:</span>

    <span class="token comment">// Free the BSTRs.</span>
    <span class="token function">SysFreeString</span><span class="token punctuation">(</span>fwBstrName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SysFreeString</span><span class="token punctuation">(</span>fwBstrProcessImageFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Release the authorized application instance.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwApp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        fwApp<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Release the authorized application collection.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwApps <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        fwApps<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> hr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


HRESULT <span class="token function">WindowsFirewallPortIsEnabled</span><span class="token punctuation">(</span>
            IN INetFwProfile<span class="token operator">*</span> fwProfile<span class="token punctuation">,</span>
            IN LONG portNumber<span class="token punctuation">,</span>
            IN NET_FW_IP_PROTOCOL ipProtocol<span class="token punctuation">,</span>
            OUT BOOL<span class="token operator">*</span> fwPortEnabled
            <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    HRESULT hr <span class="token operator">=</span> S_OK<span class="token punctuation">;</span>
    VARIANT_BOOL fwEnabled<span class="token punctuation">;</span>
    INetFwOpenPort<span class="token operator">*</span> fwOpenPort <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    INetFwOpenPorts<span class="token operator">*</span> fwOpenPorts <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>fwProfile <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>fwPortEnabled <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>fwPortEnabled <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>

    <span class="token comment">// Retrieve the globally open ports collection.</span>
    hr <span class="token operator">=</span> fwProfile<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_GloballyOpenPorts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fwOpenPorts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get_GloballyOpenPorts failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Attempt to retrieve the globally open port.</span>
    hr <span class="token operator">=</span> fwOpenPorts<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Item</span><span class="token punctuation">(</span>portNumber<span class="token punctuation">,</span> ipProtocol<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fwOpenPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Find out if the globally open port is enabled.</span>
        hr <span class="token operator">=</span> fwOpenPort<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_Enabled</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fwEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get_Enabled failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fwEnabled <span class="token operator">!=</span> VARIANT_FALSE<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// The globally open port is enabled.</span>
            <span class="token operator">*</span>fwPortEnabled <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>

            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Port %ld is open in the firewall.\n"</span><span class="token punctuation">,</span> portNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Port %ld is not open in the firewall.\n"</span><span class="token punctuation">,</span> portNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// The globally open port was not in the collection.</span>
        hr <span class="token operator">=</span> S_OK<span class="token punctuation">;</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Port %ld is not open in the firewall.\n"</span><span class="token punctuation">,</span> portNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

error<span class="token operator">:</span>

    <span class="token comment">// Release the globally open port.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwOpenPort <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        fwOpenPort<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Release the globally open ports collection.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwOpenPorts <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        fwOpenPorts<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> hr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


HRESULT <span class="token function">WindowsFirewallPortAdd</span><span class="token punctuation">(</span>
            IN INetFwProfile<span class="token operator">*</span> fwProfile<span class="token punctuation">,</span>
            IN LONG portNumber<span class="token punctuation">,</span>
            IN NET_FW_IP_PROTOCOL ipProtocol<span class="token punctuation">,</span>
            IN <span class="token keyword">const</span> <span class="token keyword">wchar_t</span><span class="token operator">*</span> name
            <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    HRESULT hr <span class="token operator">=</span> S_OK<span class="token punctuation">;</span>
    BOOL fwPortEnabled<span class="token punctuation">;</span>
    BSTR fwBstrName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    INetFwOpenPort<span class="token operator">*</span> fwOpenPort <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    INetFwOpenPorts<span class="token operator">*</span> fwOpenPorts <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>fwProfile <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// First check to see if the port is already added.</span>
    hr <span class="token operator">=</span> <span class="token function">WindowsFirewallPortIsEnabled</span><span class="token punctuation">(</span>
            fwProfile<span class="token punctuation">,</span>
            portNumber<span class="token punctuation">,</span>
            ipProtocol<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>fwPortEnabled
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WindowsFirewallPortIsEnabled failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Only add the port if it isn't already added.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fwPortEnabled<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Retrieve the collection of globally open ports.</span>
        hr <span class="token operator">=</span> fwProfile<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_GloballyOpenPorts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fwOpenPorts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get_GloballyOpenPorts failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Create an instance of an open port.</span>
        hr <span class="token operator">=</span> <span class="token function">CoCreateInstance</span><span class="token punctuation">(</span>
                <span class="token function">__uuidof</span><span class="token punctuation">(</span>NetFwOpenPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token constant">NULL</span><span class="token punctuation">,</span>
                CLSCTX_INPROC_SERVER<span class="token punctuation">,</span>
                <span class="token function">__uuidof</span><span class="token punctuation">(</span>INetFwOpenPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>fwOpenPort
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"CoCreateInstance failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Set the port number.</span>
        hr <span class="token operator">=</span> fwOpenPort<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">put_Port</span><span class="token punctuation">(</span>portNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"put_Port failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Set the IP protocol.</span>
        hr <span class="token operator">=</span> fwOpenPort<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">put_Protocol</span><span class="token punctuation">(</span>ipProtocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"put_Protocol failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Allocate a BSTR for the friendly name of the port.</span>
        fwBstrName <span class="token operator">=</span> <span class="token function">SysAllocString</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SysStringLen</span><span class="token punctuation">(</span>fwBstrName<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            hr <span class="token operator">=</span> E_OUTOFMEMORY<span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SysAllocString failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Set the friendly name of the port.</span>
        hr <span class="token operator">=</span> fwOpenPort<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">put_Name</span><span class="token punctuation">(</span>fwBstrName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"put_Name failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Opens the port and adds it to the collection.</span>
        hr <span class="token operator">=</span> fwOpenPorts<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Add</span><span class="token punctuation">(</span>fwOpenPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Add failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Port %ld is now open in the firewall.\n"</span><span class="token punctuation">,</span> portNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

error<span class="token operator">:</span>

    <span class="token comment">// Free the BSTR.</span>
    <span class="token function">SysFreeString</span><span class="token punctuation">(</span>fwBstrName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Release the open port instance.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwOpenPort <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        fwOpenPort<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Release the globally open ports collection.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwOpenPorts <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        fwOpenPorts<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> hr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> __cdecl <span class="token function">wmain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">wchar_t</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    HRESULT hr <span class="token operator">=</span> S_OK<span class="token punctuation">;</span>
    HRESULT comInit <span class="token operator">=</span> E_FAIL<span class="token punctuation">;</span>
    INetFwProfile<span class="token operator">*</span> fwProfile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">// Initialize COM.</span>
    comInit <span class="token operator">=</span> <span class="token function">CoInitializeEx</span><span class="token punctuation">(</span>
                <span class="token number">0</span><span class="token punctuation">,</span>
                COINIT_APARTMENTTHREADED <span class="token operator">|</span> COINIT_DISABLE_OLE1DDE
                <span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// Ignore RPC_E_CHANGED_MODE; this just means that COM has already been</span>
   <span class="token comment">// initialized with a different mode. Since we don't care what the mode is,</span>
   <span class="token comment">// we'll just use the existing mode.</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>comInit <span class="token operator">!=</span> RPC_E_CHANGED_MODE<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
        hr <span class="token operator">=</span> comInit<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"CoInitializeEx failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

    <span class="token comment">// Retrieve the firewall profile currently in effect.</span>
    hr <span class="token operator">=</span> <span class="token function">WindowsFirewallInitialize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fwProfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WindowsFirewallInitialize failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Turn off the firewall.</span>
    hr <span class="token operator">=</span> <span class="token function">WindowsFirewallTurnOff</span><span class="token punctuation">(</span>fwProfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WindowsFirewallTurnOff failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Turn on the firewall.</span>
    hr <span class="token operator">=</span> <span class="token function">WindowsFirewallTurnOn</span><span class="token punctuation">(</span>fwProfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WindowsFirewallTurnOn failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Add Windows Messenger to the authorized application collection.</span>
    hr <span class="token operator">=</span> <span class="token function">WindowsFirewallAddApp</span><span class="token punctuation">(</span>
            fwProfile<span class="token punctuation">,</span>
            L<span class="token string">"%ProgramFiles%\\Messenger\\msmsgs.exe"</span><span class="token punctuation">,</span>
            L<span class="token string">"Windows Messenger"</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WindowsFirewallAddApp failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Add TCP::80 to list of globally open ports.</span>
    hr <span class="token operator">=</span> <span class="token function">WindowsFirewallPortAdd</span><span class="token punctuation">(</span>fwProfile<span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> NET_FW_IP_PROTOCOL_TCP<span class="token punctuation">,</span> L<span class="token string">"WWW"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FAILED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WindowsFirewallPortAdd failed: 0x%08lx\n"</span><span class="token punctuation">,</span> hr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

error<span class="token operator">:</span>

    <span class="token comment">// Release the firewall profile.</span>
    <span class="token function">WindowsFirewallCleanup</span><span class="token punctuation">(</span>fwProfile<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Uninitialize COM.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>comInit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">CoUninitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fc94a44af7485f614b8a1badb11382bb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">疫情得到控制之后的广州</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8e9d454d206a04c865bb81d64c747604/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Dijkstra算法及代码详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>