<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 发布 aar 到 maven 仓库（maven 和 maven-publish 插件的区别） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 发布 aar 到 maven 仓库（maven 和 maven-publish 插件的区别）" />
<meta property="og:description" content="本文转载自这篇文章：https://juejin.cn/post/7017608469901475847
在日常开发中，不可避免的需要把自己的 library 发布到 maven 仓库中，这样使用起来也更加方便。
发布 aar 包到 maven 仓库，主要是使用 Gradle 提供的插件：
maven 插件（旧版），在 Gradle 6.2 之后，就完全被弃用了（增加了 @Deprecated 注解）
maven-publish 插件
maven插件，是 Gradle 1.0 的时候提供的用于发布aar/jar包到 Maven 仓库的插件。在 Gradle 1.3 中，引入了一种新的发布插件，即：maven-publish ，这个新的插件引入了一些新概念和新功能，使 Gradle 发布功能更加强大，现在是发布工件的首选选项。
一、基本概念 1、什么是POM？ POM（Project Object Model）指项目对象模型，用于描述项目构件的基本信息。一个有效的 POM 节点中主要包含一下信息：
配置描述举例（‘com.github.bumptech.glide:glide:4.11.0’）groupId组织 / 公司的名称com.github.bumptech.glideartifactId组件的名称glideversion组件的版本4.11.0packaging打包的格式aar/jar 2、 什么是仓库（repository）？ 在项目中，我们会需要依赖各种各样的二方库或三方库，这些依赖一定会存放在某个位置（Place），这个 “位置” 就叫做仓库。使用仓库可以帮助我们管理项目构件，例如 jar、aar 等等。
主流的构建工具都有三个层次的仓库概念：
1、本地仓库： 无论使用 Linux 还是 Window，计算机中会有一个目录用来存放从中央仓库或远程仓库下载的依赖文件；2、中央仓库： 开源社区提供的仓库，是绝大多数开源库的存放位置。比如 Maven 社区的中央仓库 Maven Central；3、私有仓库： 公司或组织的自定义仓库，可以理解为二方库的存放位置。 构建时搜索依赖的顺序如下：
1、在本地仓库搜索，如果搜索不到，执行步骤 2；2、在中央仓库和私有仓库中搜索，搜索顺序按照repositories中声明的顺序依次查找。如果找到，则下载依赖文件到本地仓库，否则执行步骤 3；3、如果最终找不到依赖项，则抛出错误 “无法找到依赖项”。 了解这些基本概念之后，下面就介绍一下，通过 Gradle 提供的 maven 插件 和 maven-publish 插件，如何发布aar/jar包。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/dc1b44c9c5c8ee511570117ee2aee779/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-16T01:09:09+08:00" />
<meta property="article:modified_time" content="2023-10-16T01:09:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 发布 aar 到 maven 仓库（maven 和 maven-publish 插件的区别）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>本文转载自这篇文章：<a href="https://juejin.cn/post/7017608469901475847" rel="nofollow">https://juejin.cn/post/7017608469901475847</a></p> 
</blockquote> 
<p>在日常开发中，不可避免的需要把自己的 library 发布到 maven 仓库中，这样使用起来也更加方便。</p> 
<p>发布 aar 包到 maven 仓库，主要是使用 Gradle 提供的插件：</p> 
<ol><li> <p><a href="https://docs.gradle.org/4.8/userguide/maven_plugin.html" rel="nofollow">maven 插件</a>（旧版），在 Gradle 6.2 之后，就完全被弃用了（增加了 <code>@Deprecated</code> 注解）</p> </li><li> <p><a href="https://docs.gradle.org/current/userguide/publishing_maven.html" rel="nofollow">maven-publish 插件</a></p> </li></ol> 
<p>maven插件，是 Gradle 1.0 的时候提供的用于发布aar/jar包到 Maven 仓库的插件。在 Gradle 1.3 中，引入了一种新的发布插件，即：<strong>maven-publish</strong> ，这个新的插件引入了一些新概念和新功能，使 Gradle 发布功能更加强大，现在是发布工件的首选选项。</p> 
<h3><a id="_12"></a>一、基本概念</h3> 
<h4><a id="1POM_14"></a>1、什么是POM？</h4> 
<p>POM（Project Object Model）指项目对象模型，用于描述项目构件的基本信息。一个有效的 POM 节点中主要包含一下信息：</p> 
<table><thead><tr><th align="left">配置</th><th align="left">描述</th><th align="left">举例（‘com.github.bumptech.glide:glide:4.11.0’）</th></tr></thead><tbody><tr><td align="left">groupId</td><td align="left">组织 / 公司的名称</td><td align="left">com.github.bumptech.glide</td></tr><tr><td align="left">artifactId</td><td align="left">组件的名称</td><td align="left">glide</td></tr><tr><td align="left">version</td><td align="left">组件的版本</td><td align="left">4.11.0</td></tr><tr><td align="left">packaging</td><td align="left">打包的格式</td><td align="left">aar/jar</td></tr></tbody></table> 
<h4><a id="2_repository_24"></a>2、 什么是仓库（repository）？</h4> 
<p>在项目中，我们会需要依赖各种各样的二方库或三方库，这些依赖一定会存放在某个位置（Place），这个 “位置” 就叫做仓库。使用仓库可以帮助我们管理项目构件，例如 jar、aar 等等。</p> 
<p><strong>主流的构建工具都有三个层次的仓库概念：</strong></p> 
<ul><li><strong>1、本地仓库</strong>： 无论使用 Linux 还是 Window，计算机中会有一个目录用来存放从中央仓库或远程仓库下载的依赖文件；</li><li><strong>2、中央仓库</strong>： 开源社区提供的仓库，是绝大多数开源库的存放位置。比如 Maven 社区的中央仓库 <a href="https://search.maven.org/" rel="nofollow">Maven Central</a>；</li><li><strong>3、私有仓库</strong>： 公司或组织的自定义仓库，可以理解为二方库的存放位置。</li></ul> 
<p><strong>构建时搜索依赖的顺序如下：</strong></p> 
<ul><li>1、在本地仓库搜索，如果搜索不到，执行步骤 2；</li><li>2、在中央仓库和私有仓库中搜索，搜索顺序按照<code>repositories</code>中声明的顺序依次查找。如果找到，则下载依赖文件到本地仓库，否则执行步骤 3；</li><li>3、如果最终找不到依赖项，则抛出错误 “无法找到依赖项”。</li></ul> 
<p><img src="https://images2.imgbox.com/01/a3/rHnGcBjo_o.png" alt="在这里插入图片描述" width="600"></p> 
<p>了解这些基本概念之后，下面就介绍一下，通过 Gradle 提供的 <code>maven</code> 插件 和 <code>maven-publish</code> 插件，如何发布aar/jar包。</p> 
<h3><a id="maven__44"></a>二、maven 插件</h3> 
<p>maven 插件是 Gradle 1.0 的时候提供的，使用文档：<a href="https://docs.gradle.org/4.8/userguide/maven_plugin.html" rel="nofollow">https://docs.gradle.org/4.8/userguide/maven_plugin.html</a></p> 
<p>使用 maven 插件，遵循如下步骤：</p> 
<h4><a id="1_maven__50"></a>1、应用 maven 插件</h4> 
<p>在 需要发布aar包的 library 模块的 <code>build.gradle</code> 文件中，应用 maven 插件：</p> 
<pre><code class="prism language-groovy">apply plugin<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">"maven"</span></span>
</code></pre> 
<h4><a id="2POM_58"></a>2、配置POM</h4> 
<p>在 <code>build.gradle</code> 文件中，增加如下的 配置信息：</p> 
<pre><code class="prism language-groovy"><span class="token keyword">def</span> localDefaultRepo <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"file://"</span></span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"user.home"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'.m2/repository'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>absolutePath
uploadArchives <span class="token punctuation">{<!-- --></span>
    repositories<span class="token punctuation">.</span>mavenDeployer <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// repository(url: uri('~/.m2/repository')) // 注释1</span>
        <span class="token comment">// 配置仓库地址</span>
        <span class="token function">repository</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token function">uri</span><span class="token punctuation">(</span>localDefaultRepo<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// repository(url: uri('../repo'))</span>
      
        <span class="token comment">// 配置 pom 信息</span>
        pom<span class="token punctuation">.</span>groupId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"com.mei.http"</span></span>
        pom<span class="token punctuation">.</span>artifactId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"myhttp"</span></span>
        pom<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"1.0.0-SNAPSHOT"</span></span>
        pom<span class="token punctuation">.</span>packaging <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"aar"</span></span>
      
      	<span class="token comment">// pom.project {<!-- --></span>
        <span class="token comment">//    groupId "com.mei.http"</span>
        <span class="token comment">//    artifactId "myhttp"</span>
        <span class="token comment">//    version "1.0.1-SNAPSHOT"</span>
        <span class="token comment">//    packaging "aar"</span>
        <span class="token comment">// }</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如上所示，指定仓库的地址，配置 <code>pom</code> 信息。这样配置完成之后，在 <code>task</code> 任务列表中，就可以看到 <code>upload/uploadArchives</code> 任务。</p> 
<p>这里配置的仓库地址是一个本地路径，即把 aar 发布到本地的一个文件夹中。这里的 <code>USER_HOME/.m2/repository/</code> 目录，是 Gradle 默认的本地仓库地址，其中 <code>USER_HOME</code> 是用户目录。</p> 
<h5><a id="21_89"></a>2-1、默认本地仓库</h5> 
<p>在指定本地仓库地址的时候，踩了一个坑，如果想使用 本地默认仓库地址，如：</p> 
<pre><code class="prism language-groovy"><span class="token function">repository</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">'/.m2/repository'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
println <span class="token interpolation-string"><span class="token string">"path=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression"><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">'~/.m2/repository'</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
</code></pre> 
<p>打印出的路径：</p> 
<pre><code class="prism language-kotlin">path<span class="token operator">=</span>file<span class="token operator">:</span><span class="token operator">/</span>Users<span class="token operator">/</span>mei<span class="token operator">/</span>WorkSpace<span class="token operator">/</span>AndroidDemo<span class="token operator">/</span>MAarPublish<span class="token operator">/</span>myhttpjava<span class="token operator">/</span>~<span class="token operator">/</span><span class="token punctuation">.</span>m2<span class="token operator">/</span>repository<span class="token operator">/</span>
</code></pre> 
<p>执行 <code>uploadArchives</code> 任务之后，在 <code>USER_HOME/.m2/repository/</code> 目录 中，是没有 aar 文件的，如：</p> 
<p><img src="https://images2.imgbox.com/69/7a/taUYK3h3_o.png" alt="在这里插入图片描述"><br> 所以这个时候，去使用的话，是加载不到 aar 文件的。</p> 
<pre><code class="prism language-groovy">implementation <span class="token string">'com.mei.http:myhttp:1.0.0-SNAPSHOT'</span>
</code></pre> 
<p>这是什么原因导致的呢，其实就是路径问题。</p> 
<p>当用绝对路径的时候，即：</p> 
<pre><code class="prism language-groovy"><span class="token keyword">def</span> localDefaultRepo <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"file://"</span></span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"user.home"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'.m2/repository'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>absolutePath
</code></pre> 
<p>当仓库地址用 <code>localDefaultRepo</code> 的时候，在 <code>USER_HOME/.m2/repository/</code> 目录就可以看到发布之后的 aar 包了，如：</p> 
<p><img src="https://images2.imgbox.com/52/8f/QMyV2ry2_o.png" alt="在这里插入图片描述"></p> 
<p>这样 aar 包就发布成功了。</p> 
<h6><a id="_127"></a>使用</h6> 
<p>在工程的 <code>build.gradle</code> 文件中，引入默认的本地仓库，如：</p> 
<pre><code class="prism language-groovy">allprojects <span class="token punctuation">{<!-- --></span>
    repositories <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.....</span>
        <span class="token function">mavenLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 使用默认的本地仓库</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 <code>app</code> 的 <code>build.gradle</code> 文件中，引用 <code>myhttp</code> 库：</p> 
<pre><code class="prism language-groovy">dependencies <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.....</span>
    implementation <span class="token string">'com.mei.http:myhttp:1.0.1-SNAPSHOT'</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这样，在 app 中就可以使用 myhttp 中的代码了。</p> 
<h5><a id="22_151"></a>2-2、自定义本地仓库</h5> 
<p>除了使用默认的本地仓库之外，还可以指定自定义的本地仓库，即：自己指定一个目录，作为本地仓库，如：</p> 
<pre><code class="prism language-groovy">uploadArchives <span class="token punctuation">{<!-- --></span>
    repositories<span class="token punctuation">.</span>mavenDeployer <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 配置仓库地址</span>
        <span class="token function">repository</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">'../repo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">/*{
            authentication(userName: "xxx", password: "xxx")
        }*/</span>
      
        <span class="token comment">// 配置 pom 信息</span>
        pom<span class="token punctuation">.</span>groupId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"com.mei.http"</span></span>
        pom<span class="token punctuation">.</span>artifactId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"myhttp"</span></span>
        pom<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"1.0.0-SNAPSHOT"</span></span>
        pom<span class="token punctuation">.</span>packaging <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"aar"</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如：上面的路径就是在本工程的根目录下，创建一个 <code>repo</code> 文件夹，用于充当本地仓库，执行 <code>uploadArchives</code> 任务之后，在工程的目录下就可以看到 <code>repo</code> 目录，如：</p> 
<p><img src="https://images2.imgbox.com/a7/3c/FP9vaHbd_o.png" alt="在这里插入图片描述" width="500"></p> 
<p>可以看到，这也是发布成功了的，在使用的时候，也是需要明确指定本地仓库的路径，即存放该 aar 包的文件路径，与上面类似，在工程的 <code>build.gradle</code> 文件中，增加如下代码，指明本地仓库路径：</p> 
<pre><code class="prism language-groovy">allprojects <span class="token punctuation">{<!-- --></span>
    repositories <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.....</span>
       maven <span class="token punctuation">{<!-- --></span>
           url <span class="token string">'../repo'</span> <span class="token comment">// 如果是本工程的路径，可以直接这样显示</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果是其他的工程想要用这个库的话，则需要使用绝对路径，即：</p> 
<pre><code class="prism language-groovy">allprojects <span class="token punctuation">{<!-- --></span>
    repositories <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.....</span>
       maven <span class="token punctuation">{<!-- --></span>
           url <span class="token string">'/Users/mei/WorkSpace/AndroidDemo/MAarPublish/repo'</span> 
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="3_199"></a>3、上传源码和文档</h4> 
<p>通过上面的步骤，aar 基本上就发布成功了，但 aar 包中的代码，都是没有注释的，也没有源码，只是反编译看到一些代码信息，这种体验就不是很好，如：</p> 
<p><img src="https://images2.imgbox.com/89/ab/3rKM7JE4_o.png" alt="在这里插入图片描述" width="750"></p> 
<p>造成这个问题的原因就是，在 上传 aar 文件的时候，没有上传源码和文档。</p> 
<h5><a id="31_208"></a>3-1、上传源码</h5> 
<p>参考文档：<a href="https://docs.gradle.org/current/dsl/org.gradle.api.tasks.bundling.Jar.html" rel="nofollow">https://docs.gradle.org/current/dsl/org.gradle.api.tasks.bundling.Jar.html</a></p> 
<p>创建一个 Task 任务，用于上传源代码，具体如下：</p> 
<pre><code class="prism language-groovy">task <span class="token function">uploadSourceJar</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Jar<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 定义一个标志 (生成的jar包后面加上sources, 如: myhttp-1.0.2-20210927.115550-2-sources.jar)</span>
    classifier <span class="token operator">=</span> <span class="token string">'sources'</span>
    println <span class="token interpolation-string"><span class="token string">"srcDirs=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">project<span class="token punctuation">.</span>android<span class="token punctuation">.</span>sourceSets<span class="token punctuation">.</span>main<span class="token punctuation">.</span>java<span class="token punctuation">.</span>sourceFiles</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
  <span class="token comment">// 指定源码文件路径</span>
    from project<span class="token punctuation">.</span>android<span class="token punctuation">.</span>sourceSets<span class="token punctuation">.</span>main<span class="token punctuation">.</span>java<span class="token punctuation">.</span>sourceFiles
<span class="token punctuation">}</span>
 
<span class="token comment">// 指定发包的时候，需要执行的task任务</span>
artifacts <span class="token punctuation">{<!-- --></span>
    archives uploadSourceJar
<span class="token punctuation">}</span>
</code></pre> 
<p>增加上面的代码之后，在执行 <code>uploadArchives</code> 任务，就会上传 源码，如：</p> 
<p><img src="https://images2.imgbox.com/e4/68/tkv4XCyD_o.png" alt="在这里插入图片描述"></p> 
<p>在 Android Studio 中，查看 myhttp 的源码，如下：</p> 
<p><img src="https://images2.imgbox.com/79/a6/l2BDjdOW_o.png" alt="在这里插入图片描述" width="740"></p> 
<p>确实是可以看到源码和注释了。</p> 
<p><strong>扩展：artifact</strong></p> 
<p><code>artifact</code>方法是提供<code>Object</code>对象，具体是什么呢？主要是三种。</p> 
<ol><li><code>artifact 'my-file-name.jar'</code>具体的文件。</li><li><code>artifact sourceJar</code>任务<code>sourceJar</code>输出物，例如这里是对源码进行了打包的Jar包。</li><li><code>artifact source: sourceJar, classifier: 'src', extension: 'zip'</code>通过<code>source</code>、<code>classifier</code>以及<code>extension</code>构造的<code>MavenArtifact</code>实例，参数分别对应源文件，名称类别(<code>artifactId-classifier</code>)以及扩展名称(<code>.jar/.zip</code>等)。</li></ol> 
<h5><a id="32_246"></a>3-2、生成文档并上传</h5> 
<p>参考文档：</p> 
<ol><li><a href="https://docs.gradle.org/current/dsl/org.gradle.api.tasks.javadoc.Javadoc.html#org.gradle.api.tasks.javadoc.Javadoc:destinationDir" rel="nofollow">https://docs.gradle.org/current/dsl/org.gradle.api.tasks.javadoc.Javadoc.html#org.gradle.api.tasks.javadoc.Javadoc:destinationDir</a></li><li><a href="https://books.didispace.com/GradleUserGuide/the_java_plugin/java_plugin_javadoc.html?h=javadoc" rel="nofollow">https://books.didispace.com/GradleUserGuide/the_java_plugin/java_plugin_javadoc.html?h=javadoc</a></li></ol> 
<p>通过上面的操作，源码就上传到maven仓库了，在引用 aar 文件到时候，就可以看到源码和注释信息。</p> 
<p>如果是一个 SDK 的话，那么为了方便别人接入，还需要上传文档。</p> 
<pre><code class="prism language-groovy">task <span class="token function">androidJavadocs</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Javadoc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    doLast <span class="token punctuation">{<!-- --></span>
        source <span class="token operator">=</span> project<span class="token punctuation">.</span>android<span class="token punctuation">.</span>sourceSets<span class="token punctuation">.</span>main<span class="token punctuation">.</span>java<span class="token punctuation">.</span>srcDirs
        <span class="token comment">// 需要生成 doc 的 代码路径</span>
        classpath <span class="token operator">+=</span> project<span class="token punctuation">.</span><span class="token function">files</span><span class="token punctuation">(</span>project<span class="token punctuation">.</span>android<span class="token punctuation">.</span><span class="token function">getBootClasspath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>File<span class="token punctuation">.</span>pathSeparator<span class="token punctuation">)</span><span class="token punctuation">)</span>
        failOnError <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// javadoc 解析错误时task 不会异常停止</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// 解决 JavaDoc 中文注释生成失败的问题</span>
tasks<span class="token punctuation">.</span><span class="token function">withType</span><span class="token punctuation">(</span>Javadoc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    options<span class="token punctuation">.</span><span class="token function">addStringOption</span><span class="token punctuation">(</span><span class="token string">'Xdoclint:none'</span><span class="token punctuation">,</span> <span class="token string">'-quiet'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span><span class="token function">addStringOption</span><span class="token punctuation">(</span><span class="token string">'encoding'</span><span class="token punctuation">,</span> <span class="token string">'UTF-8'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span><span class="token function">addStringOption</span><span class="token punctuation">(</span><span class="token string">'charSet'</span><span class="token punctuation">,</span> <span class="token string">'UTF-8'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
 
task <span class="token function">androidJavadocsJar</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Jar<span class="token punctuation">,</span> dependsOn<span class="token punctuation">:</span> androidJavadocs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    doLast <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//archiveFileName  The archive name. If the name has not been explicitly set</span>
        <span class="token comment">// , the pattern for the name is:</span>
        <span class="token comment">//[archiveBaseName]-[archiveAppendix]-[archiveVersion]-[archiveClassifier].[archiveExtension]</span>
        <span class="token comment">// 存档名称的分类器部分，名称后面加的类别区分的名字.e.g. xxxx-javadoc.jar。</span>
        classifier <span class="token operator">=</span> <span class="token string">'javadoc'</span>
        from androidJavadocs<span class="token punctuation">.</span>destinationDir
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
artifacts <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// aar包增加注释</span>
    archives androidJavadocsJar
<span class="token punctuation">}</span>
</code></pre> 
<p>增加如上代码，就可以生成 Java 文档。</p> 
<h4><a id="4_Maven__292"></a>4、上传远程 Maven 仓库</h4> 
<p>要想把 aar 包上传到远程的 maven 仓库，只需要把上面的 maven 仓库地址替换成 远程maven 仓库地址就可以了，除此之外还需要增提供maven 仓库的用户名和密码，因为构建的 私有maven仓库，一般都是需要用户名和密码的。</p> 
<p>具体如下：</p> 
<pre><code class="prism language-groovy">uploadArchives <span class="token punctuation">{<!-- --></span>
    repositories<span class="token punctuation">.</span>mavenDeployer <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 假设远程maven仓库地址为：http://10.0.192.56:8081/repository/core/</span>
      <span class="token comment">// 账号：meiTest，密码：123456</span>
        <span class="token function">repository</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">"http://10.0.192.56:8081/repository/core/"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">authentication</span><span class="token punctuation">(</span>userName<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">"meiTest"</span></span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">"123456"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 配置 pom 信息</span>
        pom<span class="token punctuation">.</span>groupId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"com.mei.http"</span></span>
        pom<span class="token punctuation">.</span>artifactId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"myhttp"</span></span>
        pom<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"1.0.0-SNAPSHOT"</span></span>
        pom<span class="token punctuation">.</span>packaging <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"aar"</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如上，替换maven仓库地址，增加仓库的账号和密码，就可以上传到远程仓库中。</p> 
<p><strong>使用</strong></p> 
<p>把 aar 包上传到 maven 私有仓库时，需要校验账号和密码，在使用的的时候，同样也要校验账号和密码，如：</p> 
<pre><code class="prism language-groovy">allprojects <span class="token punctuation">{<!-- --></span>
    repositories <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">....</span>
        <span class="token comment">// 指定私服路径和账号密码</span>
        maven<span class="token punctuation">{<!-- --></span>
            url <span class="token string">'http://10.0.192.56:8081/repository/core/'</span>
            credentials <span class="token punctuation">{<!-- --></span>
                username <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"meiTest"</span></span>
                password <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"123456"</span></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="mavenpublish__337"></a>三、maven-publish 插件</h3> 
<p>插件类：<code>MavenPublishPlugin</code></p> 
<p>文档：</p> 
<ul><li> <p><a href="https://docs.gradle.org/current/userguide/publishing_maven.html" rel="nofollow">maven-publish 插件文档</a></p> </li><li> <p><a href="https://docs.gradle.org/current/dsl/org.gradle.api.publish.maven.MavenPublication.html" rel="nofollow">MavenPublication 参数说明</a></p> </li></ul> 
<p>在 <code>Gradle 6.2</code> 之后， maven 插件就彻底被废弃，无法使用了，只能使用 <code>maven-publish</code> 插件，因此 <code>maven-publish</code> 插件的使用一样也要掌握。下面就来看看具体的使用方式。</p> 
<h4><a id="1mavenpublish__350"></a>1、maven-publish 插件的基本使用</h4> 
<p><strong>应用插件：</strong></p> 
<pre><code class="prism language-groovy">apply plugin<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">"maven-publish"</span></span>
</code></pre> 
<p>使用 <code>maven-publish</code> 插件发布 aar 包的时候，基础 <strong>配置信息</strong> 如下：</p> 
<pre><code class="prism language-groovy">publishing <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 配置maven 仓库</span>
    repositories <span class="token punctuation">{<!-- --></span> RepositoryHandler handler<span class="token operator">-&gt;</span>
        handler<span class="token punctuation">.</span><span class="token function">mavenLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 发布到默认的 本地maven 仓库 ，路径： USER_HOME/.m2/repository/</span>
    <span class="token punctuation">}</span>
  <span class="token comment">// 配置发布产物</span>
    publications <span class="token punctuation">{<!-- --></span>PublicationContainer publication<span class="token operator">-&gt;</span>
      <span class="token comment">// 名称可以随便定义，这里定义成 maven，是因为我的 aar 包是发布到 maven 仓库的，所以这里为了见名知义，定义成了 maven</span>
      <span class="token comment">// 名称：maven </span>
        <span class="token function">maven</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 容器可配置的信息 MavenPublication</span>
            <span class="token comment">// 依赖 bundleReleaseAar 任务，并上传其产出的aar</span>
            afterEvaluate <span class="token punctuation">{<!-- --></span> <span class="token function">artifact</span><span class="token punctuation">(</span>tasks<span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"bundleReleaseAar"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            groupId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"com.mei.http"</span></span>
            artifactId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"myhttp"</span></span>
            version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"1.0.4-SNAPSHOT"</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>maven-publish</code> 插件的扩展配置类是：<code>PublishingExtension</code>，查看 <code>PublishingExtension</code> 类的源码可以看到，<code>publishing</code> 配置，可以配置的信息有两个：</p> 
<ul><li> <p><strong><code>repositories</code>：用于配置 maven 仓库地址</strong></p> <p>地址可以配置多个，在执行 <code>publish</code> 任务的时候，就会把 aar 包发布到所有指定的 maven 仓库地址中去。</p> </li></ul> 
<pre><code class="prism language-groovy">repositories <span class="token punctuation">{<!-- --></span> RepositoryHandler handler <span class="token operator">-&gt;</span>
    handler<span class="token punctuation">.</span><span class="token function">mavenLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    handler<span class="token punctuation">.</span>maven <span class="token punctuation">{<!-- --></span>
        url <span class="token interpolation-string"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">rootDir</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/repo"</span></span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 仓库用户名密码</span>
    <span class="token comment">// handler.maven { MavenArtifactRepository mavenArtifactRepository -&gt;</span>
    <span class="token comment">//     // maven 仓库地址</span>
    <span class="token comment">//     url 'http://10.0.192.56:8081/repository/core/'</span>
    <span class="token comment">//     // 访问仓库的 账号和密码</span>
    <span class="token comment">//     credentials {<!-- --></span>
    <span class="token comment">//         username = "meiTest"</span>
    <span class="token comment">//         password = "123456"</span>
    <span class="token comment">//     }</span>
    <span class="token comment">// }</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>publications：配置需要发布的jar的信息，即产物aar包的信息</strong>。<code>publications</code> 是一个容器，类型是 <code>PublicationContainer</code> ，其可以配置的信息类型是 <code>MavenPublication</code>。即可以理解成 <code>publications</code> 是一个列表集合，而集合中存储的对象是 <code>MavenPublication</code>，而对象的名称可以由自己随便定义。 所以 <code>publications</code> 也是可以配置多个的，如：</li></ul> 
<pre><code class="prism language-groovy">publications <span class="token punctuation">{<!-- --></span> PublicationContainer publicationContainer <span class="token operator">-&gt;</span>
    <span class="token comment">// 发布 snapshot 包</span>
    <span class="token function">debug</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        afterEvaluate <span class="token punctuation">{<!-- --></span> <span class="token function">artifact</span><span class="token punctuation">(</span>tasks<span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"bundleReleaseAar"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        groupId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"com.mei.http"</span></span>
        artifactId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"myhttp"</span></span>
        version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"1.0.4-SNAPSHOT"</span></span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 发布正式包</span>
    <span class="token function">release</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        afterEvaluate <span class="token punctuation">{<!-- --></span> <span class="token function">artifact</span><span class="token punctuation">(</span>tasks<span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"bundleReleaseAar"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        groupId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"com.mei.http"</span></span>
        artifactId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"myhttp"</span></span>
        version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"1.0.4"</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>指定上传的aar包的方式：</strong></p> 
<ul><li>通过依赖生成 aar 包任务，如：<code>afterEvaluate { artifact(tasks.getByName("bundleReleaseAar")) }</code></li><li>通过指定生成的 aar 路径，如：<code>artifact "buildDir/outputs/aar/buildDir/outputs/aar/buildDir/outputs/aar/{project.name}-release.aar"</code></li></ul> 
<p><strong>发布 aar：</strong></p> 
<p>增加上述配置之后，执行 AS 右侧的 <strong>Tasks</strong> 列表中的 <strong>publishing / publish</strong> 任务，就可以发布 aar 包。</p> 
<p><img src="https://images2.imgbox.com/9c/70/lNLeLyeS_o.png" alt="在这里插入图片描述"></p> 
<p>配置了两个发版产品，<code>debug</code> 和 <code>release</code>，执行发布任务后，可以看到，在默认的 本地仓库中，确实是有正式包和测试包，如下图：</p> 
<p><img src="https://images2.imgbox.com/70/79/77JKG0hC_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2_442"></a>2、上传源码</h4> 
<p>在 <code>maven-publish</code> 插件的基本使用中，是没有上传 aar 包的源码的，在Android Studio 中，打开类查看源码可以看到：</p> 
<p><img src="https://images2.imgbox.com/9e/20/ooMTWwuz_o.png" alt="在这里插入图片描述" width="780"></p> 
<p>提示用户选择源码，这里能看到代码，是 Android Studio 根据字节码反编译的。所以这里还需要上传源码。</p> 
<p>增加上传源码的 task，如：</p> 
<pre><code class="prism language-groovy"><span class="token comment">// 1. 增加上传源码的task</span>
task <span class="token function">sourceJar</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Jar<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    from android<span class="token punctuation">.</span>sourceSets<span class="token punctuation">.</span>main<span class="token punctuation">.</span>java<span class="token punctuation">.</span>srcDirs
    archiveClassifier <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"sources"</span></span>
<span class="token punctuation">}</span>
 
publishing <span class="token punctuation">{<!-- --></span>
    repositories <span class="token punctuation">{<!-- --></span> RepositoryHandler handler <span class="token operator">-&gt;</span>
        handler<span class="token punctuation">.</span><span class="token function">mavenLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    publications <span class="token punctuation">{<!-- --></span> PublicationContainer publicationContainer <span class="token operator">-&gt;</span>
        <span class="token function">maven</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            artifact sourceJar <span class="token comment">// 增加上传源码的 task </span>
          
            afterEvaluate <span class="token punctuation">{<!-- --></span> <span class="token function">artifact</span><span class="token punctuation">(</span>tasks<span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"bundleReleaseAar"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            groupId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"com.mei.http"</span></span>
            artifactId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"myhttp"</span></span>
            version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"1.0.5-SNAPSHOT"</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>增加上面的注释处的代码之后，在发布 aar 包的时候，就会连同源码一起上传了，如：</p> 
<p><img src="https://images2.imgbox.com/b2/41/PiY2MToO_o.png" alt="在这里插入图片描述" width="700"><br> 从上面的代码可以看出，源码确实是上传了，注释都能看到了。</p> 
<h4><a id="3_480"></a>3、依赖传递</h4> 
<p>通过上面的步骤，发布的 aar 包，是不会进行依赖传递的，如：我在 demo：myHttpjava 中，依赖了 OkHttp，对 myHttpjava 发布 aar 包并引用之后，在 app 工程中，无法使用 OkHttp 相关的 Api，这就是因为依赖没有传递过来。在app 模块中：</p> 
<pre><code class="prism language-groovy">dependencies <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">......</span>
    implementation <span class="token string">'com.mei.http:myhttp:1.0.4-SNAPSHOT'</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>无法使用 OkHttp 相关的 Api，但 myHttpjava 自己写的类可以调用，如：</p> 
<p><img src="https://images2.imgbox.com/d2/6f/VkPDxzLC_o.png" alt="在这里插入图片描述" width="600"><br> 从上图也可以看出，OkHttp 的依赖，确实没有传递过来。</p> 
<p>在 maven 仓库中，可以打开 <code>.pom</code> 文件，如图：</p> 
<p><img src="https://images2.imgbox.com/5e/0c/UpWBBHYI_o.png" alt="在这里插入图片描述"></p> 
<p>发现里面只有 myHttpjava 库的声明，没有其依赖库的声明，如：</p> 
<p><img src="https://images2.imgbox.com/27/b0/Il2dPdgk_o.png" alt="在这里插入图片描述" width="600"></p> 
<p>这就只有 myHttpjava 的声明信息，没有依赖库的，如 OkHttp 的声明信息。而<strong>使用 maven 插件发布的 aar 包，默认是依赖传递的</strong>，如：</p> 
<p><img src="https://images2.imgbox.com/c3/3c/PsGxyNgT_o.png" alt="在这里插入图片描述" width="600"></p> 
<p>当然，<code>maven-publish</code> 插件，对依赖传递也提供了支持。把 <code>library</code> 中的依赖信息，手动的添加到 <code>pom</code> 文件中（配置信息参考：<code>MavenPom</code> 类），就可以完成依赖传递了，具体如下：</p> 
<pre><code class="prism language-groovy"><span class="token function">maven</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 依赖 bundleReleaseAar 任务，并上传其产出的aar</span>
    afterEvaluate <span class="token punctuation">{<!-- --></span> <span class="token function">artifact</span><span class="token punctuation">(</span>tasks<span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"bundleReleaseAar"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    artifact sourceJar
    groupId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"com.mei.http"</span></span>
    artifactId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"myhttp"</span></span>
    version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"1.0.6-SNAPSHOT"</span></span>
    <span class="token comment">// pom文件中声明依赖，从而传递到使用方</span>
    pom<span class="token punctuation">.</span>withXml <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">def</span> dependenciesNode <span class="token operator">=</span> <span class="token function">asNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendNode</span><span class="token punctuation">(</span><span class="token string">'dependencies'</span><span class="token punctuation">)</span>
        configurations<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span>allDependencies<span class="token punctuation">.</span>each <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 避免出现空节点或 artifactId=unspecified 的节点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span>group <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span>name <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token interpolation-string"><span class="token string">"unspecified"</span></span> <span class="token operator">!=</span> it<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> it<span class="token punctuation">.</span>version <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                println <span class="token interpolation-string"><span class="token string">"dependency=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">it<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
                <span class="token keyword">def</span> dependencyNode <span class="token operator">=</span> dependenciesNode<span class="token punctuation">.</span><span class="token function">appendNode</span><span class="token punctuation">(</span><span class="token string">'dependency'</span><span class="token punctuation">)</span>
                dependencyNode<span class="token punctuation">.</span><span class="token function">appendNode</span><span class="token punctuation">(</span><span class="token string">'groupId'</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span>group<span class="token punctuation">)</span>
                dependencyNode<span class="token punctuation">.</span><span class="token function">appendNode</span><span class="token punctuation">(</span><span class="token string">'artifactId'</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
                dependencyNode<span class="token punctuation">.</span><span class="token function">appendNode</span><span class="token punctuation">(</span><span class="token string">'version'</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span>version<span class="token punctuation">)</span>
                dependencyNode<span class="token punctuation">.</span><span class="token function">appendNode</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">,</span> <span class="token string">'implementation'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>增加上面的 pom 模块，在 发布 aar 包的时候，打开 pom 文件，就可以看到依赖的库的声明信息，如图：</p> 
<p><img src="https://images2.imgbox.com/f9/01/PxZpcwjf_o.png" alt="在这里插入图片描述" width="600"></p> 
<p>在app 模块中，使用 myhttp 库时，虽然还是没有手动引用 OkHttp 库，但发现已经可以使用 OkHttp 相关的 Api了。说明依赖确实得到了传递。</p> 
<p>依赖是否传递，我们通过打印 依赖库的信息也可以看出来，如：</p> 
<p><img src="https://images2.imgbox.com/6c/9a/syl4ezek_o.png" alt="在这里插入图片描述"></p> 
<p>pom 闭包中配置的信息，最终都会保存到 <code>.pom</code> 文件中，如描述信息，名称，licenses，developers，scm 等，如：</p> 
<pre><code class="prism language-groovy">pom <span class="token punctuation">{<!-- --></span>
    name <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"Demo"</span></span>
    description <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"A demonstration of Maven POM customization"</span></span>
    url <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"http://www.example.com/project"</span></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果：</p> 
<p><img src="https://images2.imgbox.com/0e/ec/RTn9Z1IY_o.png" alt="在这里插入图片描述" width="600"></p> 
<h4><a id="4_Android_Gradle_aar_557"></a>4、结合 Android Gradle 插件，完成aar包的发布</h4> 
<p>在上面的步骤中，publications 闭包中的有些配置还是不够优雅的，比较繁琐，如：</p> 
<ol><li> <p>配置发布的内容（即配置上传的 aar 文件），是通过如下两种方式：</p> 
  <ul><li>依赖生成aar包的Task 任务，如：<code>afterEvaluate { artifact(tasks.getByName("bundleReleaseAar")) }</code></li><li>通过指定生成的 aar 文件路径，如：<code>artifact "buildDir/outputs/aar/buildDir/outputs/aar/buildDir/outputs/aar/{project.name}-release.aar"</code></li></ul> </li><li> <p>依赖传递：通过手动配置的方式，即 使用 <code>withXml</code> 闭包往 <code>.pom</code> 文件中，追加 <code>dependency</code> 依赖信息。</p> </li></ol> 
<p>具体如下：</p> 
<pre><code class="prism language-groovy">publishing <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 配置maven 仓库</span>
    repositories <span class="token punctuation">{<!-- --></span> RepositoryHandler handler <span class="token operator">-&gt;</span>
        handler<span class="token punctuation">.</span><span class="token function">mavenLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    publications <span class="token punctuation">{<!-- --></span> PublicationContainer publicationContainer <span class="token operator">-&gt;</span>
        <span class="token function">maven</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 依赖 bundleReleaseAar 任务，并上传其产出的aar</span>
            afterEvaluate <span class="token punctuation">{<!-- --></span> <span class="token function">artifact</span><span class="token punctuation">(</span>tasks<span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"bundleReleaseAar"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token comment">// // 也可以指定上传的AAR包，但是需要先手动生成aar</span>
            <span class="token comment">// artifact "$buildDir/outputs/aar/${project.name}-release.aar"</span>
            artifact sourceJar
            groupId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"com.mei.http"</span></span>
            artifactId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"myhttp"</span></span>
            version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"1.0.8-SNAPSHOT"</span></span>
            <span class="token comment">// pom文件中声明依赖，从而传递到使用方</span>
            pom<span class="token punctuation">.</span>withXml <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">def</span> dependenciesNode <span class="token operator">=</span> <span class="token function">asNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendNode</span><span class="token punctuation">(</span><span class="token string">'dependencies'</span><span class="token punctuation">)</span>
                configurations<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span>allDependencies<span class="token punctuation">.</span>each <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 避免出现空节点或 artifactId=unspecified 的节点</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span>group <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span>name <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token interpolation-string"><span class="token string">"unspecified"</span></span> <span class="token operator">!=</span> it<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> it<span class="token punctuation">.</span>version <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        println <span class="token interpolation-string"><span class="token string">"dependency=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">it<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
                        <span class="token keyword">def</span> dependencyNode <span class="token operator">=</span> dependenciesNode<span class="token punctuation">.</span><span class="token function">appendNode</span><span class="token punctuation">(</span><span class="token string">'dependency'</span><span class="token punctuation">)</span>
                        dependencyNode<span class="token punctuation">.</span><span class="token function">appendNode</span><span class="token punctuation">(</span><span class="token string">'groupId'</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span>group<span class="token punctuation">)</span>
                        dependencyNode<span class="token punctuation">.</span><span class="token function">appendNode</span><span class="token punctuation">(</span><span class="token string">'artifactId'</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
                        dependencyNode<span class="token punctuation">.</span><span class="token function">appendNode</span><span class="token punctuation">(</span><span class="token string">'version'</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span>version<span class="token punctuation">)</span>
                        dependencyNode<span class="token punctuation">.</span><span class="token function">appendNode</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">,</span> <span class="token string">'implementation'</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>而在 Android 开发中，上述配置是可以简化的。具体来说就是 Android Gradle 插件对 <code>maven-publish</code> 插件有了支持。</p> 
<p>但从 Android Gradle 插件 <code>3.6.0</code> 及更高版本（说的是这里 <code>classpath 'com.android.tools.build:gradle:3.6.0'</code>）之后，也支持 <code>maven-publish</code> 插件了，使配置可以更加简洁。</p> 
<p>Android Gradle 插件会为应用或库模块中的每个<strong>构建变体工件</strong>创建一个组件，您可以使用它来自定义要发布到 Maven 代码库的发布内容。</p> 
<p>Android 插件所创建的组件取决于模块是否使用应用或库插件，如下表所述。</p> 
<table><thead><tr><th align="left">module</th><th align="left">发布内容</th><th align="left">工件组件名称</th></tr></thead><tbody><tr><td align="left">com.android.library</td><td align="left">AAR</td><td align="left">components.variant</td></tr><tr><td align="left">com.android.application</td><td align="left">APK 和可用的 ProGuard 或 R8 映射文件的ZIP</td><td align="left">components.variant_apk</td></tr><tr><td align="left">com.android.application</td><td align="left">Android App Bundle (AAB)</td><td align="left">components.variant_aab</td></tr></tbody></table> 
<p>知道这些之后，<code>publications</code> 的配置就变得很简单了，具体如下：</p> 
<pre><code class="prism language-groovy">afterEvaluate <span class="token punctuation">{<!-- --></span><span class="token comment">// components.release 只有在配置完成之后，才能拿到值</span>
    publishing <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 配置maven 仓库</span>
        repositories <span class="token punctuation">{<!-- --></span> RepositoryHandler handler <span class="token operator">-&gt;</span>
            handler<span class="token punctuation">.</span><span class="token function">mavenLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        publications <span class="token punctuation">{<!-- --></span> PublicationContainer publicationContainer <span class="token operator">-&gt;</span>
            <span class="token function">maven</span><span class="token punctuation">(</span>MavenPublication<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                from components<span class="token punctuation">.</span>release <span class="token comment">// 注释1:使用 Android Gradle 插件生成的组件，作为发布的内容</span>
                artifact sourceJar <span class="token comment">// 上传源码</span>
                groupId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"com.mei.http"</span></span>
                artifactId <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"myhttp"</span></span>
                version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"1.0.8-SNAPSHOT"</span></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如上所示，在注释1处：通过 <code>from</code> 方法，设置发布的内容，而内容是 Android Gradle 插件生成的组件。</p> 
<p>这样指定之后，就可以正常的上传 aar 包了。并且不需要手动的添加依赖传递信息，Android Gradle 插件已经帮我们添加好了。</p> 
<p>发布aar包 之后，查看 <code>.pom</code> 文件，依赖库的配置信息，也都是有的，如：</p> 
<p><img src="https://images2.imgbox.com/52/31/3Yaj5e5Q_o.png" alt="在这里插入图片描述" width="600"><br> 所以，使用 Android Gradle 插件 创建的 <strong>组件</strong>，当作发布内容的时候，<strong>aar 文件</strong> 和 <strong>依赖传递</strong>，都得到了解决，非常完美。</p> 
<p><strong>这里需要特别注意一个问题</strong></p> 
<p>就是 <code>components</code> 组件信息，只有在 Gradle 配置完成之后，才能够拿到，所以在使用的时候，需要放在 <code>afterEvaluate</code> 闭包内。这点一定要注意，我就是在这个地方，被坑了，开始没有放在 <code>afterEvaluate</code> 闭包内，所以一直找不到 <code>release</code> 组件。<a href="https://developer.android.com/studio/build/maven-publish-plugin?hl=zh-cn" rel="nofollow">Android 官网</a>也提示我们了：</p> 
<p><img src="https://images2.imgbox.com/51/da/HCeAbCHc_o.png" alt="在这里插入图片描述"></p> 
<p>Maven-publish 插件 结合 Android Gradle 插件，使得 上传 aar包 的配置也变得简单了。</p> 
<h3><a id="_Kotlin_aar_664"></a>四、发布 Kotlin 项目的aar包，源码上传问题</h3> 
<p>在配置上传源码的任务时，基本配置如下：</p> 
<pre><code class="prism language-groovy">task <span class="token function">sourceJar</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Jar<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    from android<span class="token punctuation">.</span>sourceSets<span class="token punctuation">.</span>main<span class="token punctuation">.</span>java<span class="token punctuation">.</span>srcDirs
    archiveClassifier <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"sources"</span></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>但这种配置，如果库工程是用 Java 写的话，源码可以正常上传，但如果是 Kotlin 编写的库，发布 aar 包时，无法查看源码。</p> 
<p>通过 <code>android.sourceSets.main.java.srcDirs</code> 指定的源码，只能识别到 <code>Java</code> 文件，而 <code>kt</code> 文件被忽略了，但 通过查看官方文档可以知道，<code>from</code> 函数是可以指定源码路径的，所以这里直接把 <code>from</code> 函数的参数替换为 <strong>源码路径</strong>，即：</p> 
<pre><code class="prism language-groovy">task <span class="token function">sourceJar</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Jar<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    from android<span class="token punctuation">.</span>sourceSets<span class="token punctuation">.</span>main<span class="token punctuation">.</span>java<span class="token punctuation">.</span><span class="token function">getSrcDirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 源码路径</span>
    archiveClassifier <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"sources"</span></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这样在 发布 aar 包的时候，发现可以正常的访问源码了。</p> 
<h3><a id="_686"></a>总结</h3> 
<p><strong>maven 与 maven-publish 插件的区别：</strong></p> 
<ul><li>maven 插件比较老，配置简单，在Gradle 6.2 之后，就完全废弃了。</li><li>maven-publish 插件，从 gradle 1.3 之后开始支持，且是现在的通用方案，且功能更加强大，配置稍微复杂一点，但还是推荐使用。</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c76edb44ccf6f06cb708784a092e7ba1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">用代码在C和C&#43;&#43;环境中实现中缀表达式转后缀表达式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a1c23e6dc0737ef29abdcaad4ed85888/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于51单片机的汽车智能灯光控制系统设计</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>