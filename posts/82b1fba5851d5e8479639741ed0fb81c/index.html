<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux Kdump和Crash工具 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux Kdump和Crash工具" />
<meta property="og:description" content="文章目录 一、Kdump 和 Crash 工具介绍1.1 Kdump1.2 Crash 二、配置kdump和Crash工具2.1 安装kexec-tools2.2 设置crashkernel预留内存大小2.3 修改kdump默认配置/etc/kdump.conf2.4 开启kdump服务2.5 测试kdump功能 检查kdump是否开启成功2.6 手动触发crash2.7 查看生成的crash文件 三、Crash命令3.1 bt 命令3.2 dis命令3.3 mod 命令3.4 sym 命令3.5 rd 命令3.6 struct 命令3.7 其他参考文章： 一、Kdump 和 Crash 工具介绍 1.1 Kdump Kdump是一种基于kexec的Linux内核崩溃捕获机制，kexec的全称是Kernel execution，即立即执行，它可以跳过BIOS或者bootloader等引导程序，快速启动一个新的内核。这样第一个内核的内存就得以保留。在第二个内核中可以对第一个内核产生的崩溃数据进行分析。
1.2 Crash Crash是由Red Hat Enterprise Linux 项目师开发的，和Kdump配套使用的一个用于分析内核转储文件的工具。
Kdump&#43;Crash分析宕机问题的流程并不复杂，首先Kdump会在内存中保留一块区域，这个区域用来存放捕获内核。当生产内核在运行过程中遇到崩溃等情况。Kdump会通过kexec机制自动启动捕获内核，跳过BIOS，以免破坏了生产内核的内存，然后把生产内核的完整信息（包括CPU寄存器，栈数据等）转储到指定文件中。接着使用Crash工具来分析这个转储文件，以快速定位宕机问题。
二、配置kdump和Crash工具 目前大部分服务器基于RHEL或者其开源版本Centos部署，本节介绍如何在Centos中配置和安装Kdump和Crash工具。
2.1 安装kexec-tools yum install kexec-tools 2.2 设置crashkernel预留内存大小 GRUB_CMDLINE_LINUX=&#34;rd.lvm.lv=centos/root rd.lvm.lv=centos/swap crashkernel=256M&#34; 修改crashkernel的大小，我的系统内存是3G，保留了256M，注意预留内存大小，过小会导致生成coredump文件失败（不知道设置多少时，可以尝试每次增加128M）
修改后还需重新生成grub配置文件，重启系统才能生效
[vagrant@localhost ~]$ grub2-mkconfig -o /boot/grub2/grub.cfg [vagrant@localhost ~]$ reboot [root@localhost ~]$ cat /etc/default/grub GRUB_TIMEOUT=5 GRUB_DISTRIBUTOR=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/82b1fba5851d5e8479639741ed0fb81c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-09T15:16:03+08:00" />
<meta property="article:modified_time" content="2024-01-09T15:16:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux Kdump和Crash工具</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Kdump__Crash__2" rel="nofollow">一、Kdump 和 Crash 工具介绍</a></li><li><ul><li><a href="#11_Kdump_3" rel="nofollow">1.1 Kdump</a></li><li><a href="#12_Crash_5" rel="nofollow">1.2 Crash</a></li></ul> 
  </li><li><a href="#kdumpCrash_10" rel="nofollow">二、配置kdump和Crash工具</a></li><li><ul><li><a href="#21_kexectools_13" rel="nofollow">2.1 安装kexec-tools</a></li><li><a href="#22_crashkernel_18" rel="nofollow">2.2 设置crashkernel预留内存大小</a></li><li><a href="#23_kdumpetckdumpconf_42" rel="nofollow">2.3 修改kdump默认配置/etc/kdump.conf</a></li><li><a href="#24_kdump_53" rel="nofollow">2.4 开启kdump服务</a></li><li><a href="#25_kdump_kdump_60" rel="nofollow">2.5 测试kdump功能 检查kdump是否开启成功</a></li><li><a href="#26_crash_76" rel="nofollow">2.6 手动触发crash</a></li><li><a href="#27_crash_81" rel="nofollow">2.7 查看生成的crash文件</a></li></ul> 
  </li><li><a href="#Crash_87" rel="nofollow">三、Crash命令</a></li><li><ul><li><a href="#31_bt__98" rel="nofollow">3.1 bt 命令</a></li><li><a href="#32_dis_139" rel="nofollow">3.2 dis命令</a></li><li><a href="#33_mod__156" rel="nofollow">3.3 mod 命令</a></li><li><a href="#34_sym__183" rel="nofollow">3.4 sym 命令</a></li><li><a href="#35_rd__202" rel="nofollow">3.5 rd 命令</a></li><li><a href="#36_struct__212" rel="nofollow">3.6 struct 命令</a></li><li><a href="#37__262" rel="nofollow">3.7 其他</a></li><li><a href="#_302" rel="nofollow">参考文章：</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Kdump__Crash__2"></a>一、Kdump 和 Crash 工具介绍</h2> 
<h3><a id="11_Kdump_3"></a>1.1 Kdump</h3> 
<p>Kdump是一种基于kexec的Linux内核崩溃捕获机制，kexec的全称是Kernel execution，即立即执行，它可以跳过BIOS或者bootloader等引导程序，快速启动一个新的内核。这样第一个内核的内存就得以保留。在第二个内核中可以对第一个内核产生的崩溃数据进行分析。</p> 
<h3><a id="12_Crash_5"></a>1.2 Crash</h3> 
<p>Crash是由Red Hat Enterprise Linux 项目师开发的，和Kdump配套使用的一个用于分析内核转储文件的工具。</p> 
<p>Kdump+Crash分析宕机问题的流程并不复杂，首先Kdump会在内存中保留一块区域，这个区域用来存放捕获内核。当生产内核在运行过程中遇到崩溃等情况。Kdump会通过kexec机制自动启动捕获内核，跳过BIOS，以免破坏了生产内核的内存，然后把生产内核的完整信息（包括CPU寄存器，栈数据等）转储到指定文件中。接着使用Crash工具来分析这个转储文件，以快速定位宕机问题。</p> 
<h2><a id="kdumpCrash_10"></a>二、配置kdump和Crash工具</h2> 
<p>目前大部分服务器基于RHEL或者其开源版本Centos部署，本节介绍如何在Centos中配置和安装Kdump和Crash工具。</p> 
<h3><a id="21_kexectools_13"></a>2.1 安装kexec-tools</h3> 
<pre><code class="prism language-bash">yum <span class="token function">install</span> kexec-tools
</code></pre> 
<h3><a id="22_crashkernel_18"></a>2.2 设置crashkernel预留内存大小</h3> 
<pre><code class="prism language-bash"><span class="token assign-left variable">GRUB_CMDLINE_LINUX</span><span class="token operator">=</span><span class="token string">"rd.lvm.lv=centos/root rd.lvm.lv=centos/swap crashkernel=256M"</span>
</code></pre> 
<p>修改crashkernel的大小，我的系统内存是3G，保留了256M，注意预留内存大小，过小会导致生成coredump文件失败（不知道设置多少时，可以尝试每次增加128M）</p> 
<p>修改后还需重新生成grub配置文件，重启系统才能生效</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>vagrant@localhost ~<span class="token punctuation">]</span>$ grub2-mkconfig <span class="token parameter variable">-o</span> /boot/grub2/grub.cfg
<span class="token punctuation">[</span>vagrant@localhost ~<span class="token punctuation">]</span>$ <span class="token function">reboot</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> /etc/default/grub
<span class="token assign-left variable">GRUB_TIMEOUT</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token assign-left variable">GRUB_DISTRIBUTOR</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">sed</span> <span class="token string">'s, release .*$,,g'</span> /etc/system-release<span class="token variable">)</span></span>"</span>
<span class="token assign-left variable">GRUB_DEFAULT</span><span class="token operator">=</span>saved
<span class="token assign-left variable">GRUB_DISABLE_SUBMENU</span><span class="token operator">=</span>true
<span class="token assign-left variable">GRUB_TERMINAL_OUTPUT</span><span class="token operator">=</span><span class="token string">"console"</span>
<span class="token assign-left variable">GRUB_CMDLINE_LINUX</span><span class="token operator">=</span><span class="token string">"crashkernel=256M rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet"</span>
<span class="token assign-left variable">GRUB_DISABLE_RECOVERY</span><span class="token operator">=</span><span class="token string">"true"</span>
</code></pre> 
<h3><a id="23_kdumpetckdumpconf_42"></a>2.3 修改kdump默认配置/etc/kdump.conf</h3> 
<p>centos7 默认已安装kdump，根据需要修改默认配置</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> /etc/kdump.conf
path /var/crash <span class="token comment">#指定coredump文件存储位置</span>
core_collector makedumpfile <span class="token parameter variable">-c</span> <span class="token parameter variable">-l</span> --message-level <span class="token number">1</span> <span class="token parameter variable">-d</span> <span class="token number">31</span> <span class="token comment">#增加-c参数，代表压缩coredump文件</span>
default <span class="token function">reboot</span> <span class="token comment">#生成coredump后，重启系统</span>
</code></pre> 
<h3><a id="24_kdump_53"></a>2.4 开启kdump服务</h3> 
<pre><code class="prism language-bash">systemctl start kdump.service //启动kdump
systemctl <span class="token builtin class-name">enable</span> kdump.service //设置开机启动
</code></pre> 
<h3><a id="25_kdump_kdump_60"></a>2.5 测试kdump功能 检查kdump是否开启成功</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># service kdump status</span>
Redirecting to /bin/systemctl status kdump.service
● kdump.service - Crash recovery kernel arming
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/kdump.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>exited<span class="token punctuation">)</span> since Wed <span class="token number">2022</span>-11-16 <span class="token number">10</span>:48:09 CST<span class="token punctuation">;</span> 18s ago
  Process: <span class="token number">1342</span> <span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/kdumpctl start <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">0</span>/SUCCESS<span class="token punctuation">)</span>
 Main PID: <span class="token number">1342</span> <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">0</span>/SUCCESS<span class="token punctuation">)</span>
   CGroup: /system.slice/kdump.service
<span class="token punctuation">..</span>.
Jan 05 <span class="token number">11</span>:07:03 localhost.localdomain kdumpctl<span class="token punctuation">[</span><span class="token number">1082</span><span class="token punctuation">]</span>: Starting kdump: <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>
<span class="token punctuation">..</span>.
</code></pre> 
<p>如果看到”Starting kdump: [OK]“字样，说明Kdump服务已经成功配置。</p> 
<h3><a id="26_crash_76"></a>2.6 手动触发crash</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@cloud ~<span class="token punctuation">]</span><span class="token comment"># echo 1 &gt; /proc/sys/kernel/sysrq ; echo c &gt; /proc/sysrq-trigger</span>
</code></pre> 
<p>如果Kdump配置正确，上述命令会让系统快速重启并且启动捕获内核以进行转储。</p> 
<h3><a id="27_crash_81"></a>2.7 查看生成的crash文件</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ls /var/crash/</span>
<span class="token number">127.0</span>.0.1-2022-11-16-11:11:43
</code></pre> 
<p>转储完成之后会自动切换回生产内核。在<code>/var/crash</code>目录下存放了对应的coredump目录。（在2.3节中设置了将coredump目录存放在/var/crash中）。该目录是以IP地址和日期来命令的，目录里面包含了<code>vmcore</code>和<code>vmcore-dmesg.txt</code>两个文件，其中<code>vmcore</code>是捕获的<strong>内核转储文件</strong>，<code>vmcore-dmesg.txt</code>是生产内核发生崩溃时生成的<strong>内核日志信息</strong>。</p> 
<h2><a id="Crash_87"></a>三、Crash命令</h2> 
<p>在使用Crash工具进行分析之前，需要安装生产内核对应的调试信息的内核符号表。</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> yum update <span class="token parameter variable">-y</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kernel-debuginfo-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-r</span><span class="token variable">)</span></span>
</code></pre> 
<p>安装完成之后，带调试符号信息的内核在<code>/usr/lib/debug/lib/modules/</code>目录下面</p> 
<pre><code class="prism language-bash">crash vmcore /usr/lib/debug/lib/modules/<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-r</span><span class="token variable">)</span></span>/vmlinux
</code></pre> 
<p>这里vmlinux提供内核符号表，里面存了大量的全局变量地址和数据结构原理和代码等。 crash 根据你输入的命令去vmlinux中查找符号和地址，再去vmcore里面对应的位置获取真实数据，这样解析就完成了。</p> 
<h3><a id="31_bt__98"></a>3.1 bt 命令</h3> 
<ul><li>查看异常时的堆栈</li></ul> 
<pre><code class="prism language-c">crash<span class="token operator">&gt;</span> bt
PID<span class="token operator">:</span> <span class="token number">53022</span>  TASK<span class="token operator">:</span> ffff9dbe1ebc1040  CPU<span class="token operator">:</span> <span class="token number">0</span>   COMMAND<span class="token operator">:</span> <span class="token string">"bash"</span>
 #<span class="token number">0</span> <span class="token punctuation">[</span>ffff9dbe2060bae0<span class="token punctuation">]</span> machine_kexec at ffffffffb7e63674
 #<span class="token number">1</span> <span class="token punctuation">[</span>ffff9dbe2060bb40<span class="token punctuation">]</span> __crash_kexec at ffffffffb7f1ce12
 #<span class="token number">2</span> <span class="token punctuation">[</span>ffff9dbe2060bc10<span class="token punctuation">]</span> crash_kexec at ffffffffb7f1cf00
 #<span class="token number">3</span> <span class="token punctuation">[</span>ffff9dbe2060bc28<span class="token punctuation">]</span> oops_end at ffffffffb856c758
 #<span class="token number">4</span> <span class="token punctuation">[</span>ffff9dbe2060bc50<span class="token punctuation">]</span> no_context at ffffffffb855aa7e
 #<span class="token number">5</span> <span class="token punctuation">[</span>ffff9dbe2060bca0<span class="token punctuation">]</span> __bad_area_nosemaphore at ffffffffb855ab15
 #<span class="token number">6</span> <span class="token punctuation">[</span>ffff9dbe2060bcf0<span class="token punctuation">]</span> bad_area_nosemaphore at ffffffffb855ac86
 #<span class="token number">7</span> <span class="token punctuation">[</span>ffff9dbe2060bd00<span class="token punctuation">]</span> __do_page_fault at ffffffffb856f6b0
 #<span class="token number">8</span> <span class="token punctuation">[</span>ffff9dbe2060bd70<span class="token punctuation">]</span> do_page_fault at ffffffffb856f915
 #<span class="token number">9</span> <span class="token punctuation">[</span>ffff9dbe2060bda0<span class="token punctuation">]</span> page_fault at ffffffffb856b758
    <span class="token punctuation">[</span>exception RIP<span class="token operator">:</span> sysrq_handle_crash<span class="token operator">+</span><span class="token number">22</span><span class="token punctuation">]</span>
    RIP<span class="token operator">:</span> ffffffffb8261bf6  RSP<span class="token operator">:</span> ffff9dbe2060be58  RFLAGS<span class="token operator">:</span> <span class="token number">00010246</span>
    RAX<span class="token operator">:</span> ffffffffb8261be0  RBX<span class="token operator">:</span> ffffffffb8ae4c60  RCX<span class="token operator">:</span> <span class="token number">0000000000000000</span>
    RDX<span class="token operator">:</span> <span class="token number">0000000000000000</span>  RSI<span class="token operator">:</span> ffff9dbe3a613898  RDI<span class="token operator">:</span> <span class="token number">0000000000000063</span>
    RBP<span class="token operator">:</span> ffff9dbe2060be58   R8<span class="token operator">:</span> ffffffffb8de38bc   R9<span class="token operator">:</span> <span class="token number">6873617263206120</span>
    R10<span class="token operator">:</span> <span class="token number">000000000000073</span>a  R11<span class="token operator">:</span> <span class="token number">0000000000000739</span>  R12<span class="token operator">:</span> <span class="token number">0000000000000063</span>
    R13<span class="token operator">:</span> <span class="token number">0000000000000000</span>  R14<span class="token operator">:</span> <span class="token number">0000000000000004</span>  R15<span class="token operator">:</span> <span class="token number">0000000000000000</span>
    ORIG_RAX<span class="token operator">:</span> ffffffffffffffff  CS<span class="token operator">:</span> <span class="token number">0010</span>  SS<span class="token operator">:</span> <span class="token number">0018</span>
#<span class="token number">10</span> <span class="token punctuation">[</span>ffff9dbe2060be60<span class="token punctuation">]</span> __handle_sysrq at ffffffffb826241d
#<span class="token number">11</span> <span class="token punctuation">[</span>ffff9dbe2060be90<span class="token punctuation">]</span> write_sysrq_trigger at ffffffffb8262888
#<span class="token number">12</span> <span class="token punctuation">[</span>ffff9dbe2060bea8<span class="token punctuation">]</span> proc_reg_write at ffffffffb80b7f30
#<span class="token number">13</span> <span class="token punctuation">[</span>ffff9dbe2060bec8<span class="token punctuation">]</span> vfs_write at ffffffffb80410a0
#<span class="token number">14</span> <span class="token punctuation">[</span>ffff9dbe2060bf08<span class="token punctuation">]</span> sys_write at ffffffffb8041ebf
#<span class="token number">15</span> <span class="token punctuation">[</span>ffff9dbe2060bf50<span class="token punctuation">]</span> system_call_fastpath at ffffffffb8574ddb
    RIP<span class="token operator">:</span> <span class="token number">00007f</span><span class="token number">8f</span>eee9aba0  RSP<span class="token operator">:</span> <span class="token number">00007ff</span>cde15a468  RFLAGS<span class="token operator">:</span> <span class="token number">00000246</span>
    RAX<span class="token operator">:</span> <span class="token number">0000000000000001</span>  RBX<span class="token operator">:</span> <span class="token number">0000000000000002</span>  RCX<span class="token operator">:</span> ffffffffffffffff
    RDX<span class="token operator">:</span> <span class="token number">0000000000000002</span>  RSI<span class="token operator">:</span> <span class="token number">00007f</span><span class="token number">8f</span>ef7c6000  RDI<span class="token operator">:</span> <span class="token number">0000000000000001</span>
    RBP<span class="token operator">:</span> <span class="token number">00007f</span><span class="token number">8f</span>ef7c6000   R8<span class="token operator">:</span> <span class="token number">000000000000000</span>a   R9<span class="token operator">:</span> <span class="token number">00007f</span><span class="token number">8f</span>ef7ae740
    R10<span class="token operator">:</span> <span class="token number">00007f</span><span class="token number">8f</span>ef7ae740  R11<span class="token operator">:</span> <span class="token number">0000000000000246</span>  R12<span class="token operator">:</span> <span class="token number">00007f</span><span class="token number">8f</span>ef173400
    R13<span class="token operator">:</span> <span class="token number">0000000000000002</span>  R14<span class="token operator">:</span> <span class="token number">0000000000000001</span>  R15<span class="token operator">:</span> <span class="token number">0000000000000000</span>
    ORIG_RAX<span class="token operator">:</span> <span class="token number">0000000000000001</span>  CS<span class="token operator">:</span> <span class="token number">0033</span>  SS<span class="token operator">:</span> <span class="token number">002</span>b

</code></pre> 
<p>其中第一行显示了进程的pid，task_struct结构体地址，进程所在CPU和运行进程的命令。</p> 
<p>后面的栈帧列出了该进程在内核态的函数调用关系，执行顺序是从下往上。#15是最开始执行的系统调用，一般#0是切换到crashkernel的执行。重点关注#9这个位置，打印出很多寄存器的地址， 标准的信息是 exception RIP表示出问题时候执行的指令。</p> 
<h3><a id="32_dis_139"></a>3.2 dis命令</h3> 
<p>dis命令可以用来输出反汇编结果。</p> 
<ul><li>显示10行崩溃点的反汇编代码。</li></ul> 
<pre><code class="prism language-c">crash<span class="token operator">&gt;</span> dis sysrq_handle_crash<span class="token operator">+</span><span class="token number">22</span> <span class="token number">10</span>
<span class="token number">0xffffffffb8261bf6</span> <span class="token operator">&lt;</span>sysrq_handle_crash<span class="token operator">+</span><span class="token number">22</span><span class="token operator">&gt;</span><span class="token operator">:</span>     movb   $<span class="token number">0x1</span><span class="token punctuation">,</span><span class="token number">0x0</span>
<span class="token number">0xffffffffb8261bfe</span> <span class="token operator">&lt;</span>sysrq_handle_crash<span class="token operator">+</span><span class="token number">30</span><span class="token operator">&gt;</span><span class="token operator">:</span>     pop    <span class="token operator">%</span>rbp
<span class="token number">0xffffffffb8261bff</span> <span class="token operator">&lt;</span>sysrq_handle_crash<span class="token operator">+</span><span class="token number">31</span><span class="token operator">&gt;</span><span class="token operator">:</span>     retq
<span class="token number">0xffffffffb8261c00</span> <span class="token operator">&lt;</span>sysrq_handle_loglevel<span class="token operator">&gt;</span><span class="token operator">:</span>     nopl   <span class="token number">0x0</span><span class="token punctuation">(</span><span class="token operator">%</span>rax<span class="token punctuation">,</span><span class="token operator">%</span>rax<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>FTRACE NOP<span class="token punctuation">]</span>
<span class="token number">0xffffffffb8261c05</span> <span class="token operator">&lt;</span>sysrq_handle_loglevel<span class="token operator">+</span><span class="token number">5</span><span class="token operator">&gt;</span><span class="token operator">:</span>   push   <span class="token operator">%</span>rbp
<span class="token number">0xffffffffb8261c06</span> <span class="token operator">&lt;</span>sysrq_handle_loglevel<span class="token operator">+</span><span class="token number">6</span><span class="token operator">&gt;</span><span class="token operator">:</span>   xor    <span class="token operator">%</span>eax<span class="token punctuation">,</span><span class="token operator">%</span>eax
<span class="token number">0xffffffffb8261c08</span> <span class="token operator">&lt;</span>sysrq_handle_loglevel<span class="token operator">+</span><span class="token number">8</span><span class="token operator">&gt;</span><span class="token operator">:</span>   movl   $<span class="token number">0x7</span><span class="token punctuation">,</span><span class="token number">0x7e599e</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span>        # <span class="token number">0xffffffffb8a475b0</span>
<span class="token number">0xffffffffb8261c12</span> <span class="token operator">&lt;</span>sysrq_handle_loglevel<span class="token operator">+</span><span class="token number">18</span><span class="token operator">&gt;</span><span class="token operator">:</span>  mov    <span class="token operator">%</span>rsp<span class="token punctuation">,</span><span class="token operator">%</span>rbp
<span class="token number">0xffffffffb8261c15</span> <span class="token operator">&lt;</span>sysrq_handle_loglevel<span class="token operator">+</span><span class="token number">21</span><span class="token operator">&gt;</span><span class="token operator">:</span>  push   <span class="token operator">%</span>rbx
<span class="token number">0xffffffffb8261c16</span> <span class="token operator">&lt;</span>sysrq_handle_loglevel<span class="token operator">+</span><span class="token number">22</span><span class="token operator">&gt;</span><span class="token operator">:</span>  lea    <span class="token operator">-</span><span class="token number">0x30</span><span class="token punctuation">(</span><span class="token operator">%</span>rdi<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">%</span>ebx
</code></pre> 
<p>其中 <code>movb $0x1,0x0</code> 表示把数字1赋值到地址0，地址0系统会判断为空指针，所以产生了panic，除此之外查看bt的打印，上面有write_sysrq_trigger函数，说明是我们手动echo c写sysrq-trigger触发的。</p> 
<h3><a id="33_mod__156"></a>3.3 mod 命令</h3> 
<p>显示当前系统加载的内核模块信息，加载某个内核模块的符号(symbol)信息和调试信息等。</p> 
<pre><code class="prism language-bash">NAME
  mod - module information and loading of symbols and debugging data

SYNOPSIS
  mod <span class="token parameter variable">-s</span> module <span class="token punctuation">[</span>objfile<span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token parameter variable">-d</span> module <span class="token operator">|</span> <span class="token parameter variable">-S</span> <span class="token punctuation">[</span>directory<span class="token punctuation">]</span> <span class="token punctuation">[</span>-D<span class="token operator">|</span>-t<span class="token operator">|</span>-r<span class="token operator">|</span>-R<span class="token operator">|</span>-o<span class="token operator">|</span>-g<span class="token punctuation">]</span>
</code></pre> 
<ul><li>显示当前系统的模块信息</li></ul> 
<pre><code class="prism language-bash">crash<span class="token operator">&gt;</span> mod
     MODULE       NAME                            SIZE  OBJECT FILE
ffffffffc01591a0  fuse                           <span class="token number">91880</span>  <span class="token punctuation">(</span>not loaded<span class="token punctuation">)</span>  <span class="token punctuation">[</span>CONFIG_KALLSYMS<span class="token punctuation">]</span>
ffffffffc0162160  dm_log                         <span class="token number">18411</span>  <span class="token punctuation">(</span>not loaded<span class="token punctuation">)</span>  <span class="token punctuation">[</span>CONFIG_KALLSYMS<span class="token punctuation">]</span>
ffffffffc017e880  dm_mod                        <span class="token number">124407</span>  <span class="token punctuation">(</span>not loaded<span class="token punctuation">)</span>  <span class="token punctuation">[</span>CONFIG_KALLSYMS<span class="token punctuation">]</span>
ffffffffc018b000  dm_region_hash                 <span class="token number">20813</span>  <span class="token punctuation">(</span>not loaded<span class="token punctuation">)</span>  <span class="token punctuation">[</span>CONFIG_KALLSYMS<span class="token punctuation">]</span>
ffffffffc0196280  dm_mirror                      <span class="token number">22289</span>  <span class="token punctuation">(</span>not loaded<span class="token punctuation">)</span>  <span class="token punctuation">[</span>CONFIG_KALLSYMS<span class="token punctuation">]</span>
</code></pre> 
<ul><li>加载某个模块的符号信息</li></ul> 
<pre><code class="prism language-bash">crash<span class="token operator">&gt;</span> mod <span class="token parameter variable">-s</span> oops  /root/rlk_lab/oops.ko
     MODULE       NAME                            SIZE  OBJECT FILE
ffffffffc0856000  oops                           <span class="token number">12741</span>  /root/rlk_lab/oops.ko
</code></pre> 
<h3><a id="34_sym__183"></a>3.4 sym 命令</h3> 
<p>解析内核符号信息，即将符号转化成虚拟地址，或者将虚拟地址转化成符号。</p> 
<pre><code class="prism language-bash">NAME
  sym - translate a symbol to its virtual address, or vice-versa

SYNOPSIS
  sym <span class="token punctuation">[</span>-l<span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token punctuation">[</span>-M<span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token punctuation">[</span>-m module<span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token punctuation">[</span>-p<span class="token operator">|</span>-n<span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token punctuation">[</span>-q string<span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token punctuation">[</span>symbol <span class="token operator">|</span> vaddr<span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-bash">crash<span class="token operator">&gt;</span> sym ffffffffc0854019
ffffffffc0854019 <span class="token punctuation">(</span>T<span class="token punctuation">)</span> create_oops+0x19 <span class="token punctuation">[</span>oops<span class="token punctuation">]</span> /root/rlk_lab/oops_test.c: <span class="token number">16</span>
</code></pre> 
<ul><li>-l: 显示所有符号信息，等同于查看System.map</li><li>-m:显示某个内核模块的所有符号信息</li><li>-q: 查询某个符号信息</li></ul> 
<h3><a id="35_rd__202"></a>3.5 rd 命令</h3> 
<p>读取内存地址中的值</p> 
<pre><code class="prism language-bash">NAME
  rd - <span class="token builtin class-name">read</span> memory

SYNOPSIS
  rd <span class="token punctuation">[</span>-adDsSupxmfN<span class="token punctuation">]</span><span class="token punctuation">[</span>-8<span class="token operator">|</span>-16<span class="token operator">|</span>-32<span class="token operator">|</span>-64<span class="token punctuation">]</span><span class="token punctuation">[</span>-o offs<span class="token punctuation">]</span><span class="token punctuation">[</span>-e addr<span class="token punctuation">]</span><span class="token punctuation">[</span>-r file<span class="token punctuation">]</span><span class="token punctuation">[</span>address<span class="token operator">|</span>symbol<span class="token punctuation">]</span>
     <span class="token punctuation">[</span>count<span class="token punctuation">]</span>
</code></pre> 
<h3><a id="36_struct__212"></a>3.6 struct 命令</h3> 
<p>展示数据结构定义或具体的值</p> 
<pre><code class="prism language-bash">NAME
  struct - structure contents

SYNOPSIS
  struct struct_name<span class="token punctuation">[</span>.member<span class="token punctuation">[</span>,member<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span>-o<span class="token punctuation">]</span><span class="token punctuation">[</span>-l offset<span class="token punctuation">]</span><span class="token punctuation">[</span>-rfuxdp<span class="token punctuation">]</span>
         <span class="token punctuation">[</span>address <span class="token operator">|</span> symbol<span class="token punctuation">]</span><span class="token punctuation">[</span>:cpuspec<span class="token punctuation">]</span> <span class="token punctuation">[</span>count <span class="token operator">|</span> <span class="token parameter variable">-c</span> count<span class="token punctuation">]</span>
</code></pre> 
<ul><li><strong>按照数据结构格式显示每个成员的值</strong></li></ul> 
<pre><code class="prism language-bash">   crash<span class="token operator">&gt;</span> struct vm_area_struct c1e44f10
   struct vm_area_struct <span class="token punctuation">{<!-- --></span>
     vm_mm <span class="token operator">=</span> 0xc2857750,
     vm_start <span class="token operator">=</span> 0x8048000,
     vm_end <span class="token operator">=</span> 0x80a5000,
     vm_next <span class="token operator">=</span> 0xc1e44a10,
     vm_page_prot <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
       pgprot <span class="token operator">=</span> 0x25
     <span class="token punctuation">}</span>
     <span class="token punctuation">..</span>.
   <span class="token punctuation">}</span>
</code></pre> 
<ul><li>显示数据结构中每个成员的偏移</li></ul> 
<pre><code class="prism language-bash">    crash<span class="token operator">&gt;</span> struct vm_area_struct <span class="token parameter variable">-o</span>
    struct vm_area_struct <span class="token punctuation">{<!-- --></span>
       <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> struct mm_struct *vm_mm<span class="token punctuation">;</span>
       <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> long unsigned int vm_start<span class="token punctuation">;</span>
       <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> long unsigned int vm_end<span class="token punctuation">;</span>
      <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> struct vm_area_struct *vm_next<span class="token punctuation">;</span>
      <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> pgprot_t vm_page_prot<span class="token punctuation">;</span>
      <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> short unsigned int vm_flags<span class="token punctuation">;</span>
      <span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> short int vm_avl_height<span class="token punctuation">;</span>
      <span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span> struct vm_area_struct *vm_avl_left<span class="token punctuation">;</span>
      <span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> struct vm_area_struct *vm_avl_right<span class="token punctuation">;</span>
      <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span> struct vm_area_struct *vm_next_share<span class="token punctuation">;</span>
      <span class="token punctuation">[</span><span class="token number">36</span><span class="token punctuation">]</span> struct vm_area_struct **vm_pprev_share<span class="token punctuation">;</span>
      <span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span> struct vm_operations_struct *vm_ops<span class="token punctuation">;</span>
      <span class="token punctuation">[</span><span class="token number">44</span><span class="token punctuation">]</span> long unsigned int vm_offset<span class="token punctuation">;</span>
      <span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">]</span> struct <span class="token function">file</span> *vm_file<span class="token punctuation">;</span>
      <span class="token punctuation">[</span><span class="token number">52</span><span class="token punctuation">]</span> long unsigned int vm_pte<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    SIZE: <span class="token number">56</span>

</code></pre> 
<h3><a id="37__262"></a>3.7 其他</h3> 
<p>使用help命令可以查看其他更多命令</p> 
<pre><code class="prism language-bash">crash<span class="token operator">&gt;</span> <span class="token builtin class-name">help</span>

*              extend         log            rd             task
<span class="token builtin class-name">alias</span>          files          mach           repeat         timer
ascii          foreach        mod            runq           tree
bpf            <span class="token function">fuser</span>          <span class="token function">mount</span>          search         union
bt             gdb            net            <span class="token builtin class-name">set</span>            vm
btop           <span class="token builtin class-name">help</span>           p              sig            vtop
dev            ipcs           <span class="token function">ps</span>             struct         waitq
dis            irq            pte            swap           whatis
<span class="token builtin class-name">eval</span>           kmem           ptob           sym            wr
<span class="token builtin class-name">exit</span>           list           ptov           sys            q
</code></pre> 
<p>也可以使用help命令具体查看某一个子命令的帮助说明，如查看struct命令的帮助说明。</p> 
<pre><code class="prism language-bash">crash<span class="token operator">&gt;</span> <span class="token builtin class-name">help</span> struct

NAME
  struct - structure contents

SYNOPSIS
  struct struct_name<span class="token punctuation">[</span>.member<span class="token punctuation">[</span>,member<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span>-o<span class="token punctuation">]</span><span class="token punctuation">[</span>-l offset<span class="token punctuation">]</span><span class="token punctuation">[</span>-rfuxdp<span class="token punctuation">]</span>
         <span class="token punctuation">[</span>address <span class="token operator">|</span> symbol<span class="token punctuation">]</span><span class="token punctuation">[</span>:cpuspec<span class="token punctuation">]</span> <span class="token punctuation">[</span>count <span class="token operator">|</span> <span class="token parameter variable">-c</span> count<span class="token punctuation">]</span>

DESCRIPTION
  This <span class="token builtin class-name">command</span> displays either a structure definition, or a formatted display
  of the contents of a structure at a specified address.  When no address is
  specified, the structure definition is shown along with the structure size.
  A structure member may be appended to the structure name <span class="token keyword">in</span> order to limit
  the scope of the data displayed to that particular member<span class="token punctuation">;</span> when no address
  is specified, the member's offset and definition are shown.

    struct_name  name of a C-code structure used by the kernel.

</code></pre> 
<h3><a id="_302"></a>参考文章：</h3> 
<ol><li><a href="https://www.cnblogs.com/augusite/p/10613794.html" rel="nofollow">Centos7/RHEL7 开启kdump</a></li><li><a href="https://blog.csdn.net/weixin_42915431/article/details/105666507">crash分析linux内核崩溃转储文件vmcore</a></li><li><a href="https://blog.csdn.net/guowenyan001/article/details/12975221">Linux内核：分析coredump文件 - 内核代码崩溃</a></li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d8958cb365f4aa13b6fc68ba2bd06f82/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【前端】前后端的网络通信基础操作（原生ajax, axios, fetch）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f067de235c5f4138e4e399ad9d840174/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">u-input 输入框失去焦点时 只保留2位小数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>