<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MyBatis-Plus使用笔记（二）：MyBatis-Plus增删改查、Wapper条件查询、分页、逻辑删除、性能分析、 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MyBatis-Plus使用笔记（二）：MyBatis-Plus增删改查、Wapper条件查询、分页、逻辑删除、性能分析、" />
<meta property="og:description" content="一、insert 1、插入操作 测试：
@SpringBootTest class MybatisPlusApplicationTests { @Autowired UserMapper userMapper; @Test void insertUser() { User user = new User(); user.setName(&#34;Ada&#34;); user.setAge(30); user.setEmail(&#34;ada@qq.com&#34;); int i = userMapper.insert(user); System.out.println(&#34;insert : &#34; &#43; i); } } 结果：
**注意：**数据库插入id值默认为：全局唯一id（雪花算法生成，下面会介绍）
2、常见主键生成策略 1）数据库自增长序列或字段
最常见的方式。利用数据库，全数据库唯一。
优点：
简单，代码方便，性能可以接受。数字ID天然排序，对分页或者需要排序的结果很有帮助。 缺点：
在单个数据库或读写分离或一主多从的情况下，只有一个主库可以生成。有单点故障的风险。如果遇见多个系统需要合并或者涉及到数据迁移会相当痛苦。分表分库的时候会有麻烦。 2）UUID
常见的方式。可以利用数据库也可以利用程序生成，一般来说全球唯一。
优点：
简单，代码方便。生成ID性能非常好，基本不会有性能问题。全球唯一，在遇见数据迁移，系统数据合并，或者数据库变更等情况下，可以从容应对。 缺点：
没有排序，无法保证趋势递增UUID往往是使用字符串存储，查询的效率比较低。存储空间比较大，如果是海量数据库，就需要考虑存储量的问题。传输数据量大 3）Redis生成ID
当使用数据库来生成ID性能不够要求的时候，我们可以尝试使用Redis来生成ID。这主要依赖于Redis是单线程的，所以也可以用生成全局唯一的ID。可以用Redis的原子操作 INCR和INCRBY来实现。
可以使用Redis集群来获取更高的吞吐量。假如一个集群中有5台Redis。可以初始化每台Redis的值分别是1,2,3,4,5，然后步长都是5。各个Redis生成的ID为：
A：1,6,11,16,21
B：2,7,12,17,22
C：3,8,13,18,23
D：4,9,14,19,24
E：5,10,15,20,25
优点：
不依赖于数据库，灵活方便，且性能优于数据库。数字ID天然排序，对分页或者需要排序的结果很有帮助。 缺点：
如果系统中没有Redis，还需要引入新的组件，增加系统复杂度。需要编码和配置的工作量比较大。 4）Twitter的snowflake算法
snowflake是Twitter开源的分布式ID生成算法，结果是一个long型的ID。其核心思想是：使用41bit作为毫秒数，10bit作为机器的ID（5个bit是数据中心，5个bit的机器ID），12bit作为毫秒内的流水号（意味着每个节点在每毫秒可以产生 4096 个 ID），最后还有一个符号位，永远是0。具体实现的代码可以参看https://github.com/twitter-archive/snowflake/releases/tag/snowflake-2010
snowflake算法可以根据自身项目的需要进行一定的修改。比如估算未来的数据中心个数，每个数据中心的机器数以及统一毫秒可以能的并发数来调整在算法中所需要的bit数。
优点：
不依赖于数据库，灵活方便，且性能优于数据库。ID按照时间在单机上是递增的。 缺点：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/54aad9b1597e3bdf048048a306747224/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-06-19T14:22:39+08:00" />
<meta property="article:modified_time" content="2020-06-19T14:22:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MyBatis-Plus使用笔记（二）：MyBatis-Plus增删改查、Wapper条件查询、分页、逻辑删除、性能分析、</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="insert_0"></a><strong>一、insert</strong></h2> 
<h3><a id="1_2"></a><strong>1、插入操作</strong></h3> 
<p>测试：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">MybatisPlusApplicationTests</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    UserMapper userMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">insertUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Ada"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">"ada@qq.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"insert : "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre> 
<p>结果：</p> 
<p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/89/1f/HvSsUw3L_o.png"></p> 
<p>**注意：**数据库插入id值默认为：全局唯一id（雪花算法生成，下面会介绍）</p> 
<h3><a id="2_32"></a>2、常见主键生成策略</h3> 
<p><strong>1）数据库自增长序列或字段</strong></p> 
<p>最常见的方式。利用数据库，全数据库唯一。</p> 
<p>优点：</p> 
<ul><li>简单，代码方便，性能可以接受。</li><li>数字ID天然排序，对分页或者需要排序的结果很有帮助。</li></ul> 
<p>缺点：</p> 
<ul><li>在单个数据库或读写分离或一主多从的情况下，只有一个主库可以生成。有单点故障的风险。</li><li>如果遇见多个系统需要合并或者涉及到数据迁移会相当痛苦。</li><li>分表分库的时候会有麻烦。</li></ul> 
<p><strong>2）UUID</strong></p> 
<p>常见的方式。可以利用数据库也可以利用程序生成，一般来说全球唯一。<br> <img alt="在这里插入图片描述" src="https://images2.imgbox.com/01/c5/lGVFG0o1_o.png"><br> 优点：</p> 
<ul><li>简单，代码方便。</li><li>生成ID性能非常好，基本不会有性能问题。</li><li>全球唯一，在遇见数据迁移，系统数据合并，或者数据库变更等情况下，可以从容应对。</li></ul> 
<p>缺点：</p> 
<ul><li>没有排序，无法保证趋势递增</li><li>UUID往往是使用字符串存储，查询的效率比较低。</li><li>存储空间比较大，如果是海量数据库，就需要考虑存储量的问题。</li><li>传输数据量大</li></ul> 
<p><strong>3）Redis生成ID</strong></p> 
<p>当使用数据库来生成ID性能不够要求的时候，我们可以尝试使用Redis来生成ID。这主要依赖于Redis是单线程的，所以也可以用生成全局唯一的ID。可以用Redis的原子操作 INCR和INCRBY来实现。</p> 
<p>可以使用Redis集群来获取更高的吞吐量。假如一个集群中有5台Redis。可以初始化每台Redis的值分别是1,2,3,4,5，然后步长都是5。各个Redis生成的ID为：</p> 
<p>A：1,6,11,16,21</p> 
<p>B：2,7,12,17,22</p> 
<p>C：3,8,13,18,23</p> 
<p>D：4,9,14,19,24</p> 
<p>E：5,10,15,20,25</p> 
<p>优点：</p> 
<ul><li>不依赖于数据库，灵活方便，且性能优于数据库。</li><li>数字ID天然排序，对分页或者需要排序的结果很有帮助。</li></ul> 
<p>缺点：</p> 
<ul><li>如果系统中没有Redis，还需要引入新的组件，增加系统复杂度。</li><li>需要编码和配置的工作量比较大。</li></ul> 
<p><strong>4）Twitter的snowflake算法</strong></p> 
<p>snowflake是Twitter开源的分布式ID生成算法，结果是一个long型的ID。其核心思想是：使用41bit作为毫秒数，10bit作为机器的ID（5个bit是数据中心，5个bit的机器ID），12bit作为毫秒内的流水号（意味着每个节点在每毫秒可以产生 4096 个 ID），最后还有一个符号位，永远是0。具体实现的代码可以参看https://github.com/twitter-archive/snowflake/releases/tag/snowflake-2010</p> 
<p>snowflake算法可以根据自身项目的需要进行一定的修改。比如估算未来的数据中心个数，每个数据中心的机器数以及统一毫秒可以能的并发数来调整在算法中所需要的bit数。</p> 
<p>优点：</p> 
<ul><li>不依赖于数据库，灵活方便，且性能优于数据库。</li><li>ID按照时间在单机上是递增的。</li></ul> 
<p>缺点：</p> 
<ul><li>在单机上是递增的，但是由于涉及到分布式环境，每台机器上的时钟不可能完全同步，也许有时候也会出现不是全局递增的情况。</li></ul> 
<h3><a id="3MP_107"></a>3、MP的主键生成策略</h3> 
<p><strong>1）ID_WORKER</strong></p> 
<p>MyBatis-Plus默认的主键策略是：ID_WORKER <em>全局唯一ID</em>（雪花算法）</p> 
<p><strong>2）自增策略</strong></p> 
<p>要想主键自增需要配置如下主键策略：</p> 
<ul><li>需要在创建<strong>数据表</strong>的时候设置<strong>主键自增</strong></li><li>实体字段中配置 @TableId(type = IdType.AUTO)</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>type <span class="token operator">=</span> IdType<span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span>
<span class="token keyword">private</span> Long id<span class="token punctuation">;</span></code></pre> 
<p>要想影响所有实体的配置，可以设置全局主键配置</p> 
<pre><code class="prism language-properties">#全局设置主键生成策略
mybatis-plus.global-config.db-config.id-type=auto
</code></pre> 
<p>其它主键策略：分析 IdType 源码可知:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> IdType <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 数据库ID自增
     */</span>
    <span class="token function">AUTO</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">/**
     * 该类型为未设置主键类型
     */</span>
    <span class="token function">NONE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">/**
     * 用户输入ID
     * &lt;p&gt;该类型可以通过自己注册自动填充插件进行填充&lt;/p&gt;
     */</span>
    <span class="token function">INPUT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/* 以下3种类型、只有当插入对象ID 为空，才自动填充。 */</span>
    <span class="token comment">/**
     * 全局唯一ID (idWorker)
     */</span>
    <span class="token function">ID_WORKER</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">/**
     * 全局唯一ID (UUID)
     */</span>
    <span class="token function">UUID</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">/**
     * 字符串全局唯一ID (idWorker 的字符串表示)
     */</span>
    <span class="token function">ID_WORKER_STR</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> key<span class="token punctuation">;</span>

    <span class="token function">IdType</span><span class="token punctuation">(</span><span class="token keyword">int</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> 
<h2><a id="update_172"></a>二、update</h2> 
<h3><a id="1Id_174"></a><strong>1、根据Id更新操作</strong></h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
UserMapper userMapper<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">updateUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">2</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> row <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p>此时自动生成的SQL语句为：<code>UPDATE user SET age=? WHERE id=?</code></p> 
<h3><a id="2_192"></a>2、自动填充</h3> 
<p>项目中经常会遇到一些数据，每次都使用相同的方式填充，例如记录的创建时间，更新时间等。</p> 
<p>我们可以使用MyBatis Plus的自动填充功能，完成这些字段的赋值工作：</p> 
<p><strong>1）数据库表中添加自动填充字段</strong></p> 
<p>在User表中添加datetime类型的新的字段 create_time、update_time</p> 
<p><strong>2）实体类上添加属性以及注解</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
    <span class="token comment">//注意使用小驼峰，框架会自动将下划线转为小驼峰</span>
    <span class="token comment">//设置自动填充时机</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>fill <span class="token operator">=</span> FieldFill<span class="token punctuation">.</span>INSERT<span class="token punctuation">)</span>
    <span class="token keyword">private</span> Date createTime<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>fill <span class="token operator">=</span> FieldFill<span class="token punctuation">.</span>INSERT_UPDATE<span class="token punctuation">)</span>
    <span class="token keyword">private</span> Date updateTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p><strong>3）实现元对象处理器接口</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyMetaObjectHandler</span> <span class="token keyword">implements</span> <span class="token class-name">MetaObjectHandler</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//使用mp实现添加的自动填充时，这个方法就会执行</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertFill</span><span class="token punctuation">(</span>MetaObject metaObject<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setFieldValByName</span><span class="token punctuation">(</span><span class="token string">"createTime"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metaObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setFieldValByName</span><span class="token punctuation">(</span><span class="token string">"updateTime"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metaObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//使用mp实现更新的自动填充时，这个方法就会执行</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateFill</span><span class="token punctuation">(</span>MetaObject metaObject<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setFieldValByName</span><span class="token punctuation">(</span><span class="token string">"updateTime"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metaObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre> 
<p><strong>注意：不要忘记添加 @Component 注解</strong></p> 
<p><strong>4）测试</strong></p> 
<p>添加：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">insertUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Eva"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">"Eva@qq.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"insert : "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/e0/2e/De5o9ZQv_o.png"></p> 
<p>修改：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">updateUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1273807629415706625</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> row <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/e5/05/PwRR9PLQ_o.png"></p> 
<h3><a id="3_275"></a>3、乐观锁</h3> 
<p>**主要适用场景：**当要更新一条记录的时候，希望这条记录没有被别人更新，也就是说实现线程安全的数据更新</p> 
<p><strong>乐观锁实现方式：</strong></p> 
<ul><li>取出记录时，获取当前version</li><li>更新时，带上这个version</li><li>执行更新时， <code>set version = newVersion where version = oldVersion</code></li><li>如果version不对，就更新失败</li></ul> 
<p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/66/d2/jbTvKiJi_o.png"></p> 
<p><strong>1）数据库中添加version字段</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span> <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> <span class="token punctuation">`</span>version<span class="token punctuation">`</span> <span class="token keyword">INT</span></code></pre> 
<p><strong>2）实体类添加version字段</strong></p> 
<p>并添加 @Version 注解</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Version</span>
<span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>fill <span class="token operator">=</span> FieldFill<span class="token punctuation">.</span>INSERT<span class="token punctuation">)</span>
<span class="token keyword">private</span> Integer version<span class="token punctuation">;</span> <span class="token comment">//版本号，用于乐观锁</span></code></pre> 
<p><strong>3）元对象处理器接口添加version的insert默认值</strong></p> 
<pre><code class="prism language-java"><span class="token comment">//使用mp实现添加的自动填充时，这个方法就会执行</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertFill</span><span class="token punctuation">(</span>MetaObject metaObject<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setFieldValByName</span><span class="token punctuation">(</span><span class="token string">"version"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> metaObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre> 
<p><strong>特别说明:</strong></p> 
<ul><li>支持的数据类型只有 int,Integer,long,Long,Date,Timestamp,LocalDateTime</li><li>整数类型下 <code>newVersion = oldVersion + 1</code></li><li><code>newVersion</code> 会回写到 <code>entity</code> 中</li><li>仅支持 <code>updateById(id)</code> 与 <code>update(entity, wrapper)</code> 方法</li><li>在 <code>update(entity, wrapper)</code> 方法下, <code>wrapper</code> 不能复用!!!</li></ul> 
<p><strong>4）创建配置类 MybatisPlusConfig 并注册 Bean</strong></p> 
<pre><code class="prism language-java"><span class="token comment">//不要忘了@Configuration注解</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">"cn.hanzhuang42.mybatisplus.mapper"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyBatisPlusConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
    *乐观锁插件
    */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> OptimisticLockerInterceptor <span class="token function">optimisticLockerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OptimisticLockerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre> 
<p><strong>5）测试乐观锁</strong></p> 
<p>插入数据：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">insertUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"奎托斯"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">"Eva@qq.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"insert : "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/a3/29/LFFntNTD_o.png"></p> 
<p>更新数据：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testOptimisticLocker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//先查询</span>
    User user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span><span class="token number">1273814734310735873</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//再修改</span>
    user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/a7/a9/kipf8BJJ_o.png"></p> 
<h2><a id="select_377"></a><strong>三、select</strong></h2> 
<h3><a id="1id_379"></a><strong>1、根据id查询记录</strong></h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testOptimisticLocker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//先查询</span>
    User user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span><span class="token number">1273814734310735873</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//再修改</span>
    user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<h3><a id="2id_392"></a><strong>2、通过多个id批量查询</strong></h3> 
<pre><code class="prism language-java"><span class="token comment">//多个id批量查询</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testSelectBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectBatchIds</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p>SQL语句用的时IN</p> 
<pre><code class="prism language-sql"><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">&gt;</span>  Preparing: <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>email<span class="token punctuation">,</span>create_time<span class="token punctuation">,</span>update_time<span class="token punctuation">,</span>version <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> id <span class="token operator">IN</span> <span class="token punctuation">(</span> ? <span class="token punctuation">,</span> ? <span class="token punctuation">,</span> ? <span class="token punctuation">)</span> 
<span class="token operator">=</span><span class="token operator">=</span><span class="token operator">&gt;</span> Parameters: <span class="token number">1</span><span class="token punctuation">(</span><span class="token keyword">Integer</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">(</span><span class="token keyword">Integer</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">(</span><span class="token keyword">Integer</span><span class="token punctuation">)</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>    <span class="token keyword">Columns</span>: id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> email<span class="token punctuation">,</span> create_time<span class="token punctuation">,</span> update_time<span class="token punctuation">,</span> version
<span class="token operator">&lt;=</span><span class="token operator">=</span>        <span class="token keyword">Row</span>: <span class="token number">1</span><span class="token punctuation">,</span> Jone<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> test1<span class="token variable">@baomidou.com</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>        <span class="token keyword">Row</span>: <span class="token number">2</span><span class="token punctuation">,</span> Jack<span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> test2<span class="token variable">@baomidou.com</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>        <span class="token keyword">Row</span>: <span class="token number">3</span><span class="token punctuation">,</span> Tom<span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> test3<span class="token variable">@baomidou.com</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>      Total: <span class="token number">3</span></code></pre> 
<h3><a id="3_415"></a><strong>3、分页查询</strong></h3> 
<p>MyBatis Plus自带分页插件，只要简单的配置即可实现分页功能</p> 
<p><strong>1）创建配置类</strong></p> 
<pre><code class="prism language-java"><span class="token comment">//分页插件</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> PaginationInterceptor <span class="token function">paginationInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PaginationInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p><strong>2）测试selectPage分页</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1、创建page对象</span>
    <span class="token comment">//传入两个参数：当前页码 和 每页显示记录数</span>
    Page<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2、调用mp的分页查询方法</span>
    userMapper<span class="token punctuation">.</span><span class="token function">selectPage</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3、通过page获取分页数据</span>
    <span class="token comment">//分页的所有信息都会封装到page对象中</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//当前页码</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//每个页的数据</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//每页的记录数量</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//表中的总记录数</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//总页数</span>

    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//是否有下一页</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">hasPrevious</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//是否有前一页</span>
<span class="token punctuation">}</span></code></pre> 
<p>可以在控制台看到首先使用<code>SELECT COUNT(1) FROM user</code>查询了数据的总个数，然后使用LIMIT进行了分页查询</p> 
<pre><code class="prism language-sql"><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">&gt;</span>  Preparing: <span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> 
<span class="token operator">=</span><span class="token operator">=</span><span class="token operator">&gt;</span> Parameters: 
<span class="token operator">&lt;=</span><span class="token operator">=</span>    <span class="token keyword">Columns</span>: <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>        <span class="token keyword">Row</span>: <span class="token number">8</span>
<span class="token operator">=</span><span class="token operator">=</span><span class="token operator">&gt;</span>  Preparing: <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>email<span class="token punctuation">,</span>create_time<span class="token punctuation">,</span>update_time<span class="token punctuation">,</span>version <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">LIMIT</span> ?<span class="token punctuation">,</span>? 
<span class="token operator">=</span><span class="token operator">=</span><span class="token operator">&gt;</span> Parameters: <span class="token number">0</span><span class="token punctuation">(</span>Long<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">(</span>Long<span class="token punctuation">)</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>    <span class="token keyword">Columns</span>: id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> email<span class="token punctuation">,</span> create_time<span class="token punctuation">,</span> update_time<span class="token punctuation">,</span> version
<span class="token operator">&lt;=</span><span class="token operator">=</span>        <span class="token keyword">Row</span>: <span class="token number">1</span><span class="token punctuation">,</span> Jone<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> test1<span class="token variable">@baomidou.com</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>        <span class="token keyword">Row</span>: <span class="token number">2</span><span class="token punctuation">,</span> Jack<span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> test2<span class="token variable">@baomidou.com</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>        <span class="token keyword">Row</span>: <span class="token number">3</span><span class="token punctuation">,</span> Tom<span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> test3<span class="token variable">@baomidou.com</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>      Total: <span class="token number">3</span>
Closing non transactional SqlSession <span class="token punctuation">[</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span><span class="token keyword">session</span><span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>DefaultSqlSession<span class="token variable">@68b58644</span><span class="token punctuation">]</span></code></pre> 
<h2><a id="delete_469"></a>四、delete</h2> 
<h3><a id="1id_471"></a><strong>1、根据id删除记录</strong></h3> 
<pre><code class="prism language-java"><span class="token comment">//测试删除，物理删除</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> row <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token number">1</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p>可以看到id为1的数据被删除</p> 
<p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/e6/2a/tHTNRURN_o.png"></p> 
<h3><a id="2_486"></a><strong>2、批量删除</strong></h3> 
<pre><code class="prism language-java"><span class="token comment">//批量物理删除</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testDeleteBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> row <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">deleteBatchIds</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<h3><a id="3_497"></a>3、逻辑删除</h3> 
<ul><li>物理删除：真实删除，将对应数据从数据库中删除，之后查询不到此条被删除数据</li><li>逻辑删除：假删除，将对应数据中代表是否被删除字段状态修改为“被删除状态”，之后在数据库中仍旧能看到此条数据记录</li></ul> 
<p><strong>1）数据库中添加 deleted字段</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span> <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> <span class="token punctuation">`</span>deleted<span class="token punctuation">`</span> <span class="token keyword">boolean</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span></code></pre> 
<p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/5f/22/SR2exTA5_o.png"></p> 
<p><strong>2）实体类添加deleted 字段</strong></p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@TableLogic</span>
    <span class="token keyword">private</span> Integer deleted<span class="token punctuation">;</span></code></pre> 
<p><strong>3）application.properties 加入配置</strong></p> 
<p>此为默认值，如果你的默认值和mp默认的一样,该配置可无</p> 
<pre><code class="prism language-properties">mybatis-plus.global-config.db-config.logic-delete-value=1
mybatis-plus.global-config.db-config.logic-not-delete-value=0
</code></pre> 
<p><strong>4）在 MybatisPlusConfig 中注册 逻辑删除Bean</strong></p> 
<pre><code class="prism language-java"><span class="token comment">//逻辑删除插件</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> ISqlInjector <span class="token function">sqlInjector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LogicSqlInjector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p><strong>5）测试</strong></p> 
<p>首先插入一条数据，可以看到deleted默认值为0</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">insertUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"里昂"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">"Eva@qq.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"insert : "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/76/49/l3TSX6zw_o.png"></p> 
<p>然后将这条数据进行删除</p> 
<pre><code class="prism language-java"><span class="token comment">//测试删除，逻辑删除</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testLogicDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> row <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token number">1273835938400808961</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p>从控制台的sql语句可以看出，执行的操作时update，并不是delete</p> 
<pre><code class="prism language-sql"><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">&gt;</span>  Preparing: <span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">SET</span> deleted<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span>? <span class="token operator">AND</span> deleted<span class="token operator">=</span><span class="token number">0</span> 
<span class="token operator">=</span><span class="token operator">=</span><span class="token operator">&gt;</span> Parameters: <span class="token number">1273835938400808961</span><span class="token punctuation">(</span>Long<span class="token punctuation">)</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>    Updates: <span class="token number">1</span></code></pre> 
<p>数据库中deleted的值也被设为1<br> <img alt="在这里插入图片描述" src="https://images2.imgbox.com/68/ba/drAUH52X_o.png"><br> 如果这时进行查询所有操作可以看到，无法将上述数据查出：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> userList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p>可以看到查询时也加了<code>deleted=0</code>的判断条件</p> 
<pre><code class="prism language-sql"><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">&gt;</span>  Preparing: <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>email<span class="token punctuation">,</span>create_time<span class="token punctuation">,</span>update_time<span class="token punctuation">,</span>version<span class="token punctuation">,</span>deleted <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> deleted<span class="token operator">=</span><span class="token number">0</span> 
<span class="token operator">=</span><span class="token operator">=</span><span class="token operator">&gt;</span> Parameters: 
<span class="token operator">&lt;=</span><span class="token operator">=</span>    <span class="token keyword">Columns</span>: id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> email<span class="token punctuation">,</span> create_time<span class="token punctuation">,</span> update_time<span class="token punctuation">,</span> version<span class="token punctuation">,</span> deleted
<span class="token operator">&lt;=</span><span class="token operator">=</span>        <span class="token keyword">Row</span>: <span class="token number">2</span><span class="token punctuation">,</span> Jack<span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> test2<span class="token variable">@baomidou.com</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>        <span class="token keyword">Row</span>: <span class="token number">3</span><span class="token punctuation">,</span> Tom<span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> test3<span class="token variable">@baomidou.com</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>        <span class="token keyword">Row</span>: <span class="token number">4</span><span class="token punctuation">,</span> Sandy<span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> test4<span class="token variable">@baomidou.com</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>        <span class="token keyword">Row</span>: <span class="token number">5</span><span class="token punctuation">,</span> Billie<span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> test5<span class="token variable">@baomidou.com</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>        <span class="token keyword">Row</span>: <span class="token number">1273618618428489730</span><span class="token punctuation">,</span> Ada<span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> ada<span class="token variable">@qq.com</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>        <span class="token keyword">Row</span>: <span class="token number">1273807629415706625</span><span class="token punctuation">,</span> Eva<span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> Eva<span class="token variable">@qq.com</span><span class="token punctuation">,</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">19</span> <span class="token number">10</span>:<span class="token number">39</span>:<span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">19</span> <span class="token number">10</span>:<span class="token number">43</span>:<span class="token number">32</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>        <span class="token keyword">Row</span>: <span class="token number">1273814734310735873</span><span class="token punctuation">,</span> 奎托斯<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> Eva<span class="token variable">@qq.com</span><span class="token punctuation">,</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">19</span> <span class="token number">11</span>:<span class="token number">07</span>:<span class="token number">54</span><span class="token punctuation">,</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">19</span> <span class="token number">11</span>:<span class="token number">11</span>:<span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token operator">&lt;=</span><span class="token operator">=</span>      Total: <span class="token number">7</span></code></pre> 
<h2><a id="_601"></a>五、性能分析</h2> 
<h3><a id="1_603"></a>1、配置插件</h3> 
<p><strong>1）在 MybatisPlusConfig 中配置</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * SQL执行效率插件
 * 该插件只用于开发环境，不建议生产环境使用。
 * dev: 开发环境
 * test：测试环境
 * prod：生产环境
 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@Profile</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"dev"</span><span class="token punctuation">,</span><span class="token string">"test"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">// 设置 dev test 环境开启</span>
<span class="token keyword">public</span> PerformanceInterceptor <span class="token function">performanceInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    PerformanceInterceptor performanceInterceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    performanceInterceptor<span class="token punctuation">.</span><span class="token function">setMaxTime</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ms, maxTime SQL 执行最大时长，超过自动停止运行</span>
    performanceInterceptor<span class="token punctuation">.</span><span class="token function">setFormat</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//format SQL SQL是否格式化，默认false。</span>
    <span class="token keyword">return</span> performanceInterceptor<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p><strong>2）Spring Boot 中设置dev环境</strong></p> 
<pre><code class="prism language-properties">#环境设置：dev、test、prod
spring.profiles.active=dev
</code></pre> 
<h3><a id="2_632"></a>2、测试</h3> 
<p><strong>1）常规测试</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> userList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> 
<p>控制台输出：</p> 
<pre><code class="prism language-java"> Time：<span class="token number">98</span> ms <span class="token operator">-</span> ID：cn<span class="token punctuation">.</span>hanzhuang42<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>UserMapper<span class="token punctuation">.</span>selectList
Execute SQL：SELECT id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>email<span class="token punctuation">,</span>create_time<span class="token punctuation">,</span>update_time<span class="token punctuation">,</span>version<span class="token punctuation">,</span>deleted FROM user WHERE deleted<span class="token operator">=</span><span class="token number">0</span></code></pre> 
<p><strong>2）将maxTime 改小之后再次进行测试</strong></p> 
<pre><code class="prism language-java">performanceInterceptor<span class="token punctuation">.</span><span class="token function">setMaxTime</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> 
<p>如果执行时间过长，则抛出异常：The SQL execution time is too large,</p> 
<pre><code class="prism language-java">Time：<span class="token number">279</span> ms <span class="token operator">-</span> ID：cn<span class="token punctuation">.</span>hanzhuang42<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>UserMapper<span class="token punctuation">.</span>selectList
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>MybatisPlusException<span class="token operator">:</span>  The SQL execution time is too large<span class="token punctuation">,</span> please optimize <span class="token operator">!</span> </code></pre> 
<h2><a id="wapper_665"></a><strong>六、wapper介绍</strong></h2> 
<h3><a id="1_667"></a>1、相关类</h3> 
<p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/06/dc/yG4Xa5w1_o.png"></p> 
<ul><li>Wrapper ： 条件构造抽象类，最顶端父类</li><li>AbstractWrapper ： 用于查询条件封装，生成 sql 的 where 条件</li><li>QueryWrapper ： Entity 对象封装操作类，不使用lambda语法（常用）</li><li>UpdateWrapper ： Update 条件封装，用于Entity对象更新操作</li><li>AbstractLambdaWrapper ： Lambda 语法使用 Wrapper统一处理解析 lambda 获取 column。</li><li>LambdaQueryWrapper ：看名称也能明白就是用于Lambda语法使用的查询Wrapper</li><li>LambdaQueryWrapper ：看名称也能明白就是用于Lambda语法使用的查询Wrapper</li><li>LambdaUpdateWrapper ： Lambda 更新封装Wrapper</li></ul> 
<h3><a id="2QueryWrapper__678"></a>2、QueryWrapper 使用</h3> 
<p>具体参考官网：https://mp.baomidou.com/guide/wrapper.html</p> 
<pre><code class="prism language-java">    <span class="token comment">//测试条件查询</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testSelectQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1、创建QueryWrapper对象</span>
        QueryWrapper<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//ge、gt、le、lt：大于等于 、大于、小于等于 、小于</span>
        <span class="token comment">//查询age大于等30的用户</span>
<span class="token comment">//        wrapper.ge("age", 30);</span>
<span class="token comment">//        List&lt;User&gt; users = userMapper.selectList(wrapper);</span>
<span class="token comment">//        users.forEach(System.out::println);</span>

        <span class="token comment">//eq、ne： 等于、不等于</span>
<span class="token comment">//        wrapper.eq("name", "奎托斯");</span>
<span class="token comment">//        wrapper.ne("name", "奎托斯");</span>
<span class="token comment">//        userMapper.selectList(wrapper).forEach(System.out::println);</span>

        <span class="token comment">//between</span>
        <span class="token comment">//查询年龄在20到30之间的</span>
<span class="token comment">//        wrapper.between("age", 20, 30);</span>
<span class="token comment">//        userMapper.selectList(wrapper).forEach(System.out::println);</span>

        <span class="token comment">//like</span>
<span class="token comment">//        wrapper.like("name", "a");</span>
<span class="token comment">//        userMapper.selectList(wrapper).forEach(System.out::println);</span>

        <span class="token comment">//orderBy</span>
<span class="token comment">//        wrapper.orderByDesc("id");</span>
<span class="token comment">//        userMapper.selectList(wrapper).forEach(System.out::println);</span>

        <span class="token comment">//last：直接在sql语句后追加语句</span>
<span class="token comment">//        wrapper.between("age",20,30)</span>
<span class="token comment">//                .last("limit 1");</span>
<span class="token comment">//        userMapper.selectList(wrapper).forEach(System.out::println);</span>

        <span class="token comment">//指定查询的列</span>
        wrapper<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0a4335d39e322dd7d0198689735f4aa2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C&#43;&#43; 中的 Unicode 与 UTF-8 字符编码互转</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/33c067fd3173cedc40fd580bed1c5fb3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Java学习-进阶】-java线程池ThreadPoolExecutor八种拒绝策略浅析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>