<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux下实现FFmpeg&#43;nginx（nginx-http-flv-module）搭建 RTMP&amp;flv流媒体服务器 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux下实现FFmpeg&#43;nginx（nginx-http-flv-module）搭建 RTMP&amp;flv流媒体服务器" />
<meta property="og:description" content="前言 因为有需要所以简单研究下监控视频直播流，需要把监控的(Onvif)协议通过硬盘录像机(RTSP)转成视频播放(RTMP)通过flv.js进行web直播，所以先从简单入手，走了不少坑，在此记录一下
建议有问题的话多看官方文档，文档地址在下面
先简单介绍下各种流媒体协议
RTMP（Real Time Messaging Protocol）是基于TCP的，由Adobe公司为Flash播放器和服务器之间音频、视频传输开发的开放协议。
HLS（HTTP Live Streaming）是基于HTTP的，是Apple公司开放的音视频传输协议。
HTTP FLV则是将RTMP封装在HTTP协议之上的，可以更好的穿透防火墙等。
Http_flv 对比 RTMP
这两个协议实际上传输数据是一样的，数据都是flv文件的tag。http_flv是一个无限大的http流的文件，相比rtmp就只能直播，而rtmp还可以推流和更多的操作。但是http有个好处，就是是以80http通信的，穿透性强，而且rtmp是非开放协议。
这两个协议是如今直播平台主选的直播方式，主要原因就是延时极低
关于Flv.js
flv.js是B站开源的一款HTML5 Flash Video（FLV）播放器
官方文档：https://github.com/Bilibili/flv.js
搭建服务 一、环境准备 1.1、环境描述 服务器系统CentOS7.4（os：这两天的Centos新闻挺多啊，希望RockyLinux早点出来）
服务器：Nginx和nginx-http-flv-module模块作为推流服务端（之前是用的旧的nginx-rtmp-module,坑，nginx-http-flv-module具有nginx-rtmp-module所有功能）
nginx-http-flv-module和nginx-rtmp-module的对比
推流端工具：FFmpeg
拉流端:h5&#43;ng、VLC测试
视频转码:x264
重点文档，有问题可以查询这里，非常详细
nginx-http-flv-module的官方地址：https://github.com/winshining/nginx-http-flv-module/blob/master/README.CN.md
1.2、所需材料提前准备，如果后续步骤下载失败，可手动下载 1 . Nginx编译包：https://nginx.org/download/nginx-1.19.5.tar.gz
2 . Nginx所需模块nginx-http-flv-module：https://github.com/winshining/nginx-http-flv-module/archive/master.zip
3 . FFmpeg：http://www.ffmpeg.org/releases/ffmpeg-4.3.tar.gz
4 . x264: https://code.videolan.org/videolan/x264/-/archive/master/x264-master.zip
5 . nasm: https://www.nasm.us/pub/nasm/releasebuilds/2.14/nasm-2.14.tar.gz
如果以上仍下载失败，可以到百度网盘进行下载，如果需要新版本下载可留言
链接：https://pan.baidu.com/s/1S8lMmX2pi8GDM8pd-ehm8w
提取码：7cq6
1.3、所需依赖项，需提前装好 # yum install unzip -y # yum install gcc-c&#43;&#43; -y # yum install pcre pcre-devel -y # yum install zlib zlib-devel -y # yum install openssl openssl-devel -y # yum install yasm -y 注意：安装yasm的时候，可能会失败" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2fba87bc2e3fecea20e350c92a506927/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-14T06:30:48+08:00" />
<meta property="article:modified_time" content="2021-06-14T06:30:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux下实现FFmpeg&#43;nginx（nginx-http-flv-module）搭建 RTMP&amp;flv流媒体服务器</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>前言</h2> 
<p><strong>因为有需要所以简单研究下监控视频直播流，需要把监控的(Onvif)协议通过硬盘录像机(RTSP)转成视频播放(RTMP)通过flv.js进行web直播，所以先从简单入手，走了不少坑，在此记录一下<br> 建议有问题的话多看官方文档，文档地址在下面<br> 先简单介绍下各种流媒体协议</strong></p> 
<p>RTMP（Real Time Messaging Protocol）是基于TCP的，由Adobe公司为Flash播放器和服务器之间音频、视频传输开发的开放协议。</p> 
<p>HLS（HTTP Live Streaming）是基于HTTP的，是Apple公司开放的音视频传输协议。</p> 
<p>HTTP FLV则是将RTMP封装在HTTP协议之上的，可以更好的穿透防火墙等。</p> 
<p><strong>Http_flv 对比 RTMP</strong></p> 
<p>这两个协议实际上传输数据是一样的，数据都是flv文件的tag。http_flv是一个无限大的http流的文件，相比rtmp就只能直播，而rtmp还可以推流和更多的操作。但是http有个好处，就是是以80http通信的，穿透性强，而且rtmp是非开放协议。</p> 
<p>这两个协议是如今直播平台主选的直播方式，主要原因就是延时极低</p> 
<p><strong>关于Flv.js<br> flv.js是B站开源的一款HTML5 Flash Video（FLV）播放器<br> 官方文档：<a href="https://github.com/Bilibili/flv.js">https://github.com/Bilibili/flv.js</a></strong></p> 
<h2><a name="t1"></a><a id="_21"></a>搭建服务</h2> 
<h3><a name="t2"></a><a id="_22"></a>一、环境准备</h3> 
<h4><a name="t3"></a><a id="11_23"></a>1.1、环境描述</h4> 
<p>服务器系统CentOS7.4（os：这两天的Centos新闻挺多啊，希望RockyLinux早点出来）<br> 服务器：Nginx和nginx-http-flv-module模块作为推流服务端（之前是用的旧的nginx-rtmp-module,坑，nginx-http-flv-module具有nginx-rtmp-module所有功能）<br> nginx-http-flv-module和nginx-rtmp-module的对比<br><img alt="在这里插入图片描述" src="https://images2.imgbox.com/47/36/gIKdvvtq_o.png"><br> 推流端工具：FFmpeg<br> 拉流端:h5+ng、VLC测试</p> 
<p>视频转码:x264</p> 
<p>重点文档，有问题可以查询这里，非常详细<br> nginx-http-flv-module的官方地址：<a href="https://github.com/winshining/nginx-http-flv-module/blob/master/README.CN.md">https://github.com/winshining/nginx-http-flv-module/blob/master/README.CN.md</a></p> 
<h4><a name="t4"></a><a id="12_35"></a>1.2、所需材料提前准备，如果后续步骤下载失败，可手动下载</h4> 
<ul><li> <p>1 . Nginx编译包：<a href="https://nginx.org/download/nginx-1.19.5.tar.gz" rel="nofollow">https://nginx.org/download/nginx-1.19.5.tar.gz</a></p> </li><li> <p>2 . Nginx所需模块nginx-http-flv-module：<a href="https://github.com/winshining/nginx-http-flv-module/archive/master.zip">https://github.com/winshining/nginx-http-flv-module/archive/master.zip</a></p> </li><li> <p>3 . FFmpeg：<a href="http://www.ffmpeg.org/releases/ffmpeg-4.3.tar.gz" rel="nofollow">http://www.ffmpeg.org/releases/ffmpeg-4.3.tar.gz</a></p> </li><li> <p>4 . x264: <a href="https://code.videolan.org/videolan/x264/-/archive/master/x264-master.zip" rel="nofollow">https://code.videolan.org/videolan/x264/-/archive/master/x264-master.zip</a></p> </li><li> <p>5 . nasm: <a href="https://www.nasm.us/pub/nasm/releasebuilds/2.14/nasm-2.14.tar.gz" rel="nofollow">https://www.nasm.us/pub/nasm/releasebuilds/2.14/nasm-2.14.tar.gz</a></p> </li></ul> 
<p>如果以上仍下载失败，可以到百度网盘进行下载，如果需要新版本下载可留言<br> 链接：<a href="https://pan.baidu.com/s/1S8lMmX2pi8GDM8pd-ehm8w" rel="nofollow">https://pan.baidu.com/s/1S8lMmX2pi8GDM8pd-ehm8w</a><br> 提取码：7cq6</p> 
<h4><a name="t5"></a><a id="13_50"></a>1.3、所需依赖项，需提前装好</h4> 
<pre><code># yum install unzip -y
# yum install gcc-c++ -y
# yum install pcre pcre-devel -y  
# yum install zlib zlib-devel -y 
# yum install openssl openssl-devel -y
# yum install yasm -y
</code></pre> 
<p>注意：安装yasm的时候，可能会失败<br> No package XXX available</p> 
<p>解决：用wget方式安装</p> 
<pre><code># wget http://www.tortall.net/projects/yasm/releases/yasm-1.3.0.tar.gz
# tar zxvf yasm-1.3.0.tar.gz
# cd yasm-1.3.0
# ./configure
# make &amp;&amp; make install
</code></pre> 
<h4><a name="t6"></a><a id="14RSTP_72"></a>1.4、海康等摄像头RSTP协议获取</h4> 
<p>这里是我用到的</p> 
<pre><code>rtsp://admin:123456@192.168.1.114:554/Streaming/Channels/101?transportmode=unicast
</code></pre> 
<p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/83/47/CnPKSGEG_o.png"><br> 各种品牌的协议地址：<a href="https://blog.csdn.net/qq_38880380/article/details/80652697">https://blog.csdn.net/qq_38880380/article/details/80652697</a></p> 
<h3><a name="t7"></a><a id="_81"></a>二、环境安装</h3> 
<p>安装默认目录:/usr/local</p> 
<h4><a name="t8"></a><a id="21Nginxnginxhttpflvmodule_83"></a>2.1、安装Nginx和nginx-http-flv-module模块</h4> 
<p>这里使用源码编译的方式安装nginx</p> 
<pre><code># cd /usr/local/
# wget http://nginx.org/download/nginx-1.19.5.tar.gz                        //下载nginx
# tar -zxvf nginx-1.19.5.tar.gz                                             //解压ng
# cd nginx-1.19.5
# wget https://github.com/winshining/nginx-http-flv-module/archive/master.zip           
# unzip nginx-http-flv-module-master.zip
# ./configure --prefix=/usr/local/nginx --add-module=./nginx-http-flv-module-master --with-http_ssl_module    //编译安装nginx，并指定上面下载的模块路径
# make &amp;&amp; make install
</code></pre> 
<h4><a name="t9"></a><a id="22Nginx_96"></a>2.2、修改Nginx的配置文件</h4> 
<pre><code># cd /usr/local/nginx/conf
# vim nginx.conf
</code></pre> 
<pre><code>#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile            on;
    keepalive_timeout  65;
    server {
        listen       9938;
        server_name  localhost;
        location /live {
            flv_live on; 
            chunked_transfer_encoding  on;
            add_header 'Access-Control-Allow-Origin' '*'; 
            add_header 'Access-Control-Allow-Credentials' 'true'; 
        }
        location / {
            root   html;
            index  index.html index.htm;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
  include /usr/local/nginx/conf/vhost/*.conf;
}

rtmp {  
    out_queue               4096;
    out_cork                 8;
    max_streams             128; 
    timeout                 15s;
    drop_idle_publisher     15s;
    log_interval 5s; 
    log_size     1m; 
    server {  
        listen 9909;      #监听的端口号
        #server_name 127.0.0.1;        
        application live {     #自定义的名字
            live on;  
       }  
        application hls {  
            live on;  
            hls on;  
            hls_path /tmp/hls;   
            hls_fragment 1s;
            hls_playlist_length 3s;  
       }  
    } 
}

</code></pre> 
<p>wq进行保存<br><img alt="在这里插入图片描述" src="https://images2.imgbox.com/13/66/U6hLQxui_o.png"><br> 检查nginx配置文件，有问题及时修改</p> 
<pre><code># cd /usr/local/nginx/sbin
# ./nginx -t                    //检查nginx
# ./nginx                      //启动nginx
# ./nginx -s reload           //重载nginx配置使其配置生效
</code></pre> 
<h4><a name="t10"></a><a id="23FFmpeg_180"></a>2.3、安装FFmpeg</h4> 
<p>先安装nasm</p> 
<pre><code># cd /usr/local
# wget https://www.nasm.us/pub/nasm/releasebuilds/2.14/nasm-2.14.tar.gz
# tar -zxvf nasm-2.14.tar.gz
# cd nasm-2.14
# ./configure
# make &amp;&amp; make install
</code></pre> 
<p>再安装x264（视频流转码，必用，不然会推流失败）</p> 
<pre><code># cd /usr/local
# wget https://code.videolan.org/videolan/x264/-/archive/master/x264-master.zip
# unzip x264-master.zip
# cd x264-master
# ./configure --enable-static --enable-shared
# make &amp;&amp; make install
</code></pre> 
<p>安装FFmpeg,时间长耐心等待</p> 
<pre><code># cd /usr/local
# wget http://www.ffmpeg.org/releases/ffmpeg-4.3.tar.gz
# tar ffmpeg-4.3.tar.gz
# tar -zxvf nasm-2.14.tar.gz
# cd ffmpeg-4.3
# ./configure --prefix=/usr/local/ffmpeg  --enable-gpl --enable-libx264
# make &amp;&amp; make install
# cp /usr/local/ffmpeg/bin/* /usr/bin/
# ffmpeg -version
</code></pre> 
<h3><a name="t11"></a><a id="_213"></a>三、推流</h3> 
<pre><code>ffmpeg -re -rtsp_transport tcp -i "rtsp://admin:123456@192.168.1.114:554/Streaming/Channels/101?transportmode=unicast" -f flv -vcodec libx264 -vprofile baseline -acodec aac -strict experimental -ar 44100 -ac 2 -b:a 96k -r 25 -b:v 500k -s 640*480  -f flv  -q 10  rtmp://192.168.1.187:9909/live/101

服务器推本地视频流命令：
ffmpeg -re -i /usr/local/mp4/1.mp4 -f flv -vcodec libx264 -vprofile baseline -acodec aac -strict experimental -ar 44100 -ac 2 -b:a 96k -r 25 -b:v 500k -s 640*480  -f flv  -q 10  rtmp://192.168.1.187:9909/live/101

OBS工具推流：
推流服务器：rtmp://192.168.1.187:9909/live/
串流秘钥：101

对应的拉流地址：
http方式：
http://192.168.1.187:9938/live?port=9909&amp;app=live&amp;stream=101
rtmp方式(VLC工具可以播放视频和音频，PotPlayer工具只能播放音频)：
rtmp://192.168.1.187:9909/live/101
</code></pre> 
<p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/8c/c7/yq1Pfygj_o.png"><br> FFmpeg命令大全：<a href="https://www.cnblogs.com/AllenChou/p/7048528.html" rel="nofollow">https://www.cnblogs.com/AllenChou/p/7048528.html</a></p> 
<p>推流过程可能会遇到ffmpeg: error while loading shared libraries: libx264.so.157: cannot open shared object file: No such file or directory 错误</p> 
<p>解决办法：</p> 
<pre><code>vim /etc/ld.so.conf
</code></pre> 
<p>添加：</p> 
<pre><code>include /usr/local/lib/
/usr/local/lib/
</code></pre> 
<p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/75/b1/6aet53oG_o.png"><br> 保存后进行重载<br> ldconfig</p> 
<h2><a name="t12"></a><a id="_250"></a>测试</h2> 
<h3><a name="t13"></a><a id="web_251"></a>一、web直播拉流</h3> 
<p>这里有两种web直播方式，RTMP直播和flv.js流直播</p> 
<h4><a name="t14"></a><a id="11videoDemoiisnginxwebstorm_253"></a>1.1、video直播流Demo，需要服务器支持，iis，nginx等，或者使用webstorm进行调试,界面如下（假装好使）</h4> 
<pre><code>&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Live&lt;/title&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;link href="http://vjs.zencdn.net/5.5.3/video-js.css" rel="stylesheet"&gt;
    &lt;!-- If you'd like to support IE8 --&gt;
    &lt;script src="http://vjs.zencdn.net/ie8/1.1.1/videojs-ie8.min.js"&gt;&lt;/script&gt;
    &lt;script src="http://vjs.zencdn.net/5.5.3/video.js"&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;video id="my-video" class="video-js" controls preload="auto" width="640" height="300"
       poster="http://img1.178.com/news/201705/289777912560/289777981574.jpg" data-setup="{}"&gt;
    &lt;source src="rtmp://192.168.1.187:9909/live/101" type="flv"&gt;
    &lt;/p&gt;
&lt;/video&gt;

&lt;/body&gt;
&lt;/html&gt;

</code></pre> 
<h4><a name="t15"></a><a id="12FLVdemoflvjs_295"></a>1.2、FLV直播demo，flv.js文件在上面的百度云里面</h4> 
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;

&lt;head&gt;
    &lt;meta content="text/html; charset=utf-8" http-equiv="Content-Type"&gt;
    &lt;title&gt;flv.js demo&lt;/title&gt;
    &lt;style&gt;
        .mainContainer {
            display: block;
            width: 1024px;
            margin-left: auto;
            margin-right: auto;
        }

        .urlInput {
            display: block;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            margin-top: 8px;
            margin-bottom: 8px;
        }

        .centeredVideo {
            display: block;
            width: 100%;
            height: 576px;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: auto;
        }

        .controls {
            display: block;
            width: 100%;
            text-align: center;
            margin-left: auto;
            margin-right: auto;
        }
    &lt;/style&gt;
&lt;/head&gt;

&lt;body&gt;

&lt;p class="mainContainer"&gt;
    &lt;video name="videoElement" id="videoElement" class="centeredVideo" controls muted autoplay width="1024" height="576"&gt;
        Your browser is too old which doesn't support HTML5 video.
    &lt;/video&gt;
&lt;/p&gt;

&lt;script src="./flv.js"&gt;&lt;/script&gt;

&lt;script&gt;

    function start() {
        if (flvjs.isSupported()) {
            var videoElement = document.getElementById('videoElement');
            var flvPlayer = flvjs.createPlayer({
                type: 'flv',
                url: 'http://192.168.1.187:9938/live?port=9909&amp;app=live&amp;stream=101'
            });
            flvPlayer.attachMediaElement(videoElement);
            flvPlayer.load();
            flvPlayer.play();
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        start();
    });
&lt;/script&gt;

&lt;/body&gt;

&lt;/html&gt;
</code></pre> 
<h4><a name="t16"></a><a id="13VLC_374"></a>1.3、VLC拉流</h4> 
<p>关于VLC拉流详见：<a href="https://blog.csdn.net/macmacip/article/details/90301414">https://blog.csdn.net/macmacip/article/details/90301414</a>，这里不过多介绍了</p> 
<h2><a name="t17"></a><a id="_377"></a>错误汇总</h2> 
<p>第一个：</p> 
<pre><code>DemuxException: type = CodecUnsupported, info = Flv: Unsupported audio codec idx: 7

flv.min.js:1 Uncaught (in promise) Error: Uncaught, unspecified “error” event. (MediaError)
</code></pre> 
<p>flv无法播放，这里需要在FFmpeg里添加x264转码流即可</p> 
<p>还有个问题是FFmpeg无法推监控的rtmp视频流到腾讯云，flv文件的话就可以，但是用OBS可以正常推，不知道什么问题，如果有知道的麻烦告知一下</p> 
<p>第二个：<br> 用网页flv.js拉流播放，需要把这个html配置到服务器的nginx中，通过nginx去访问这个html网页<br> 才可以正常拉流<br> 否则各种不行，我也懒得去解决</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/82325ce2e6b58bc0977a6480b8ac736a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java EE大作业——基于Java EE的图书管理系统的设计与实现（二）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7e2f72dec456f4dd5c33b311e6430018/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">解决visio中插入符号出现乱码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>