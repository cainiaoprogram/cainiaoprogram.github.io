<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python opencv 简单的车牌识别 —— 简单学习 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Python opencv 简单的车牌识别 —— 简单学习" />
<meta property="og:description" content="前言 本文源码大部分是采用的OpenCV实战（一）——简单的车牌识别这篇文章所提供的代码，对其代码进行了整合，追加了HSV、tesseract-OCR等内容。大佬文章中有对其步骤的详细讲解和分析，本文只是在原有基础上，进行了拓展和改造，细节内容可直接参考大佬的博文。由于大佬没有提供完整项目和模型，我这进行了自己简单的数据集构建和模型训练。
Windows tesseract-OCR 的安装和简单测试
ps：所有图片素材均源自网络，如果侵权可私信，立删。
开发环境：
pycharm-2020python-3.8.5opencv-python-4.5.4.58matplotlib-3.5.0pip-21.2.3Tesseract-OCR-5.0.0numpy-1.21.4sklearn-0.0.0joblib-1.1.0
工程下载 码云 github
效果图 简易流程图 源码 import cv2 import numpy as np import matplotlib.pyplot as plt import os import time import sklearn # import pytesseract # 开发环境 pycharm python-3.8.5 opencv-python-4.5.4.58 matplotlib-3.5.0 pip-21.2.3 Tesseract-OCR-5.0.0 # 参考：https://blog.csdn.net/weixin_41695564/article/details/79712393 # 该函数能够读取磁盘中的图片文件，默认以彩色图像的方式进行读取 def imread_photo(filename, flags=cv2.IMREAD_COLOR): &#34;&#34;&#34; 该函数能够读取磁盘中的图片文件，默认以彩色图像的方式进行读取 输入： filename 指的图像文件名（可以包括路径） flags用来表示按照什么方式读取图片，有以下选择（默认采用彩色图像的方式）： IMREAD_COLOR 彩色图像 IMREAD_GRAYSCALE 灰度图像 IMREAD_ANYCOLOR 任意图像 输出: 返回图片的通道矩阵 &#34;&#34;&#34; return cv2.imread(filename, flags) # 等比缩放 参考：https://blog.csdn.net/JulyLi2019/article/details/120720752 def resize_keep_aspectratio(image_src, dst_size): src_h, src_w = image_src." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/89db69cae39b26dedd3a6375f7b95119/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-20T16:01:14+08:00" />
<meta property="article:modified_time" content="2022-05-20T16:01:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python opencv 简单的车牌识别 —— 简单学习</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<p>    本文源码大部分是采用的<a href="https://blog.csdn.net/weixin_41695564/article/details/79712393">OpenCV实战（一）——简单的车牌识别</a>这篇文章所提供的代码，对其代码进行了整合，追加了HSV、tesseract-OCR等内容。大佬文章中有对其步骤的详细讲解和分析，本文只是在原有基础上，进行了拓展和改造，细节内容可直接参考大佬的博文。由于大佬没有提供完整项目和模型，我这进行了自己简单的数据集构建和模型训练。<br> <a href="https://ikaros.blog.csdn.net/article/details/121465714" rel="nofollow">Windows tesseract-OCR 的安装和简单测试</a><br> <em>ps：所有图片素材均源自网络，如果侵权可私信，立删。</em><br>    <strong>开发环境：</strong></p> 
<ul><li>pycharm-2020</li><li>python-3.8.5</li><li>opencv-python-4.5.4.58</li><li>matplotlib-3.5.0</li><li>pip-21.2.3</li><li>Tesseract-OCR-5.0.0</li><li>numpy-1.21.4</li><li>sklearn-0.0.0</li><li>joblib-1.1.0<br> <img src="https://images2.imgbox.com/f8/df/4kb4BnbG_o.png" alt="在这里插入图片描述"></li></ul> 
<h3><a id="_17"></a>工程下载</h3> 
<p><a href="https://gitee.com/ikaros-521/python_opencv_LPR" rel="nofollow">码云</a> <a href="https://github.com/Ikaros-521/python_opencv_LPR">github</a></p> 
<h2><a id="_20"></a>效果图</h2> 
<p><img src="https://images2.imgbox.com/ac/d2/2AphELcN_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/20/1d/pArekJk8_o.png" alt="请添加图片描述"></p> 
<h2><a id="_24"></a>简易流程图</h2> 
<p><img src="https://images2.imgbox.com/73/77/fi6qFqek_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_28"></a>源码</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> os
<span class="token keyword">import</span> time
<span class="token keyword">import</span> sklearn


<span class="token comment"># import pytesseract</span>

<span class="token comment"># 开发环境 pycharm python-3.8.5 opencv-python-4.5.4.58 matplotlib-3.5.0 pip-21.2.3 Tesseract-OCR-5.0.0</span>
<span class="token comment"># 参考：https://blog.csdn.net/weixin_41695564/article/details/79712393</span>

<span class="token comment"># 该函数能够读取磁盘中的图片文件，默认以彩色图像的方式进行读取</span>
<span class="token keyword">def</span> <span class="token function">imread_photo</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> flags<span class="token operator">=</span>cv2<span class="token punctuation">.</span>IMREAD_COLOR<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    该函数能够读取磁盘中的图片文件，默认以彩色图像的方式进行读取
    输入： filename 指的图像文件名（可以包括路径）
          flags用来表示按照什么方式读取图片，有以下选择（默认采用彩色图像的方式）：
              IMREAD_COLOR 彩色图像
              IMREAD_GRAYSCALE 灰度图像
              IMREAD_ANYCOLOR 任意图像
    输出: 返回图片的通道矩阵
    """</span>
    <span class="token keyword">return</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> flags<span class="token punctuation">)</span>


<span class="token comment"># 等比缩放 参考：https://blog.csdn.net/JulyLi2019/article/details/120720752</span>
<span class="token keyword">def</span> <span class="token function">resize_keep_aspectratio</span><span class="token punctuation">(</span>image_src<span class="token punctuation">,</span> dst_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    src_h<span class="token punctuation">,</span> src_w <span class="token operator">=</span> image_src<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token comment"># print(src_h, src_w)</span>
    dst_h<span class="token punctuation">,</span> dst_w <span class="token operator">=</span> dst_size

    <span class="token comment"># 判断应该按哪个边做等比缩放</span>
    h <span class="token operator">=</span> dst_w <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>src_h<span class="token punctuation">)</span> <span class="token operator">/</span> src_w<span class="token punctuation">)</span>  <span class="token comment"># 按照ｗ做等比缩放</span>
    w <span class="token operator">=</span> dst_h <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>src_w<span class="token punctuation">)</span> <span class="token operator">/</span> src_h<span class="token punctuation">)</span>  <span class="token comment"># 按照h做等比缩放</span>

    h <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span>
    w <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>

    <span class="token keyword">if</span> h <span class="token operator">&lt;=</span> dst_h<span class="token punctuation">:</span>
        image_dst <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>image_src<span class="token punctuation">,</span> <span class="token punctuation">(</span>dst_w<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        image_dst <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>image_src<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">,</span> dst_h<span class="token punctuation">)</span><span class="token punctuation">)</span>

    h_<span class="token punctuation">,</span> w_ <span class="token operator">=</span> image_dst<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token comment"># print(h_, w_)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'等比缩放完毕'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> image_dst


<span class="token comment"># 这个函数的作用就是来调整图像的尺寸大小，当输入图像尺寸的宽度大于阈值（默认1000），我们会将图像按比例缩小</span>
<span class="token keyword">def</span> <span class="token function">resize_photo</span><span class="token punctuation">(</span>imgArr<span class="token punctuation">,</span> MAX_WIDTH<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    这个函数的作用就是来调整图像的尺寸大小，当输入图像尺寸的宽度大于阈值（默认1000），我们会将图像按比例缩小
    输入： imgArr是输入的图像数字矩阵
    输出:  经过调整后的图像数字矩阵
    拓展：OpenCV自带的cv2.resize()函数可以实现放大与缩小，函数声明如下：
            cv2.resize(src, dsize[, dst[, fx[, fy[, interpolation]]]]) → dst
        其参数解释如下：
            src 输入图像矩阵
            dsize 二元元祖（宽，高），即输出图像的大小
            dst 输出图像矩阵
            fx 在水平方向上缩放比例，默认值为0
            fy 在垂直方向上缩放比例，默认值为0
            interpolation 插值法，如INTER_NEAREST，INTER_LINEAR，INTER_AREA，INTER_CUBIC，INTER_LANCZOS4等
    """</span>
    img <span class="token operator">=</span> imgArr
    rows<span class="token punctuation">,</span> cols <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># 获取输入图像的高和宽</span>
    <span class="token comment"># 如果宽度大于设定的阈值</span>
    <span class="token keyword">if</span> cols <span class="token operator">&gt;</span> MAX_WIDTH<span class="token punctuation">:</span>
        change_rate <span class="token operator">=</span> MAX_WIDTH <span class="token operator">/</span> cols
        img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>MAX_WIDTH<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>rows <span class="token operator">*</span> change_rate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_AREA<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img


<span class="token comment"># hsv提取蓝色部分</span>
<span class="token keyword">def</span> <span class="token function">hsv_color_find</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    img_copy <span class="token operator">=</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token triple-quoted-string string">"""
    提取图中的蓝色部分 hsv范围可以自行优化
    """</span>
    hsv <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img_copy<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2HSV<span class="token punctuation">)</span>
    low_hsv <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    high_hsv <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">124</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># 设置HSV的阈值</span>
    mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>inRange<span class="token punctuation">(</span>hsv<span class="token punctuation">,</span> lowerb<span class="token operator">=</span>low_hsv<span class="token punctuation">,</span> upperb<span class="token operator">=</span>high_hsv<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"hsv_color_find"</span><span class="token punctuation">,</span> mask<span class="token punctuation">)</span>
    <span class="token comment"># 将掩膜与图像层逐像素相加</span>
    res <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_and<span class="token punctuation">(</span>img_copy<span class="token punctuation">,</span> img_copy<span class="token punctuation">,</span> mask<span class="token operator">=</span>mask<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"hsv_color_find2"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'hsv提取蓝色部分完毕'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> res


<span class="token comment"># 找到可能是车牌的一些矩形区域</span>
<span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>imageArr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    这个函数通过一系列的处理，找到可能是车牌的一些矩形区域
    输入： imageArr是原始图像的数字矩阵
    输出：gray_img_原始图像经过高斯平滑后的二值图
          contours是找到的多个轮廓
    """</span>
    img_copy <span class="token operator">=</span> imageArr<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    img_copy <span class="token operator">=</span> hsv_color_find<span class="token punctuation">(</span>img_copy<span class="token punctuation">)</span>
    <span class="token comment"># RGB-&gt;灰度</span>
    gray_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img_copy<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
    <span class="token comment"># 该函数将源图像转换为指定的高斯核。支持就地过滤。</span>
    gray_img_ <span class="token operator">=</span> cv2<span class="token punctuation">.</span>GaussianBlur<span class="token punctuation">(</span>gray_img<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>BORDER_DEFAULT<span class="token punctuation">)</span>
    kernel <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    <span class="token comment"># 使用侵蚀和膨胀作为基本操作来执行高级形态转换。任何操作都可以就地完成.在多通道图像的情况下，每个通道都是独立处理的.</span>
    img_opening <span class="token operator">=</span> cv2<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>gray_img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>MORPH_OPEN<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span>
    <span class="token comment"># 计算两个数组的加权和</span>
    img_opening <span class="token operator">=</span> cv2<span class="token punctuation">.</span>addWeighted<span class="token punctuation">(</span>gray_img<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> img_opening<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"img_opening"</span><span class="token punctuation">,</span> img_opening<span class="token punctuation">)</span>

    <span class="token comment"># 该函数将固定电平阈值应用于多通道阵列.该函数通常用于从灰度图像中获取双级(二进制)图像(比较也可用于此目的)或消除噪声，即滤除值过小或过大的像素。</span>
    ret<span class="token punctuation">,</span> img_thresh <span class="token operator">=</span> cv2<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>img_opening<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>THRESH_BINARY <span class="token operator">+</span> cv2<span class="token punctuation">.</span>THRESH_OTSU<span class="token punctuation">)</span>
    ret2<span class="token punctuation">,</span> img_thresh2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>img_opening<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>THRESH_BINARY<span class="token punctuation">)</span>

    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"img_thresh"</span><span class="token punctuation">,</span> img_thresh<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"img_thresh2"</span><span class="token punctuation">,</span> img_thresh2<span class="token punctuation">)</span>

    <span class="token comment"># 该函数在输入图像中查找边缘，并使用Canny算法在输出映射边缘进行标记。阈值1和阈值2之间的最小值用于边缘连接。最大值用于寻找强边的初始段。</span>
    img_edge <span class="token operator">=</span> cv2<span class="token punctuation">.</span>Canny<span class="token punctuation">(</span>img_thresh<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>

    <span class="token comment"># cv2.imshow("img_edge", img_edge)</span>

    <span class="token comment"># # 使用开运算和闭运算让图像边缘成为一个整体</span>
    <span class="token comment"># kernel = np.ones((10, 10), np.uint8)</span>
    <span class="token comment"># 30*30 矩形 其大小需要根据 车牌在图片中宽度的占比和图片像素进行转换， 简测下来大概是 ( 宽占比 * 原图宽像素 / 10 ) 例 0.6 * 500 / 10 = 30</span>
    kernel <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getStructuringElement<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>MORPH_RECT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    img_edge1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>img_edge<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>MORPH_CLOSE<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span>
    img_edge2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>img_edge1<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>MORPH_OPEN<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span>
    img_edge3 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>img_thresh2<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>MORPH_CLOSE<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span>
    img_edge4 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>img_edge3<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>MORPH_CLOSE<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span>
    <span class="token comment"># img_edge1 = cv2.morphologyEx(img_edge2, cv2.MORPH_CLOSE, kernel)</span>
    <span class="token comment"># img_edge2 = cv2.morphologyEx(img_edge1, cv2.MORPH_OPEN, kernel)</span>

    <span class="token comment"># cv2.imshow("img_edge1", img_edge1)</span>
    <span class="token comment"># cv2.imshow("img_edge2", img_edge2)</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"img_edge3"</span><span class="token punctuation">,</span> img_edge3<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"img_edge4"</span><span class="token punctuation">,</span> img_edge4<span class="token punctuation">)</span>

    <span class="token comment"># 查找图像边缘整体形成的矩形区域，可能有很多，车牌就在其中一个矩形区域中</span>
    contours<span class="token punctuation">,</span> hierarchy <span class="token operator">=</span> cv2<span class="token punctuation">.</span>findContours<span class="token punctuation">(</span>img_edge2<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>RETR_TREE<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>CHAIN_APPROX_SIMPLE<span class="token punctuation">)</span>

    contours2<span class="token punctuation">,</span> hierarchy2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>findContours<span class="token punctuation">(</span>img_edge4<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>RETR_TREE<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>CHAIN_APPROX_SIMPLE<span class="token punctuation">)</span>
    <span class="token comment"># print("hierarchy:")</span>
    <span class="token comment"># print(hierarchy)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'可能是车牌的一些矩形区域提取完毕'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> gray_img_<span class="token punctuation">,</span> contours<span class="token punctuation">,</span> contours2


<span class="token comment"># 根据findContours返回的contours 画出轮廓</span>
<span class="token keyword">def</span> <span class="token function">draw_contours</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> contours<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> c <span class="token keyword">in</span> contours<span class="token punctuation">:</span>
        x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> cv2<span class="token punctuation">.</span>boundingRect<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">"""
        传入一个轮廓图像，返回 x y 是左上角的点， w和h是矩形边框的宽度和高度
        """</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> w<span class="token punctuation">,</span> y <span class="token operator">+</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">"""
        画出矩形
            img 是要画出轮廓的原图
            (x, y) 是左上角点的坐标
            (x+w, y+h) 是右下角的坐标
            0,255,0）是画线对应的rgb颜色
            2 是画出线的宽度
        """</span>

        <span class="token comment"># 获得最小的矩形轮廓 可能带旋转角度</span>
        rect <span class="token operator">=</span> cv2<span class="token punctuation">.</span>minAreaRect<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token comment"># 计算最小区域的坐标</span>
        box <span class="token operator">=</span> cv2<span class="token punctuation">.</span>boxPoints<span class="token punctuation">(</span>rect<span class="token punctuation">)</span>
        <span class="token comment"># 坐标规范化为整数</span>
        box <span class="token operator">=</span> np<span class="token punctuation">.</span>int0<span class="token punctuation">(</span>box<span class="token punctuation">)</span>
        <span class="token comment"># 画出轮廓</span>
        cv2<span class="token punctuation">.</span>drawContours<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">[</span>box<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>

    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"contours"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>


<span class="token comment"># 根据车牌的一些物理特征（面积等）对所得的矩形进行过滤</span>
<span class="token keyword">def</span> <span class="token function">chose_licence_plate</span><span class="token punctuation">(</span>contours<span class="token punctuation">,</span> Min_Area<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    这个函数根据车牌的一些物理特征（面积等）对所得的矩形进行过滤
    输入：contours是一个包含多个轮廓的列表，其中列表中的每一个元素是一个N*1*2的三维数组
    输出：返回经过过滤后的轮廓集合

    拓展：
    （1） OpenCV自带的cv2.contourArea()函数可以实现计算点集（轮廓）所围区域的面积，函数声明如下：
            contourArea(contour[, oriented]) -&gt; retval
        其中参数解释如下：
            contour代表输入点集，此点集形式是一个n*2的二维ndarray或者n*1*2的三维ndarray
            retval 表示点集（轮廓）所围区域的面积
    （2） OpenCV自带的cv2.minAreaRect()函数可以计算出点集的最小外包旋转矩形，函数声明如下：
             minAreaRect(points) -&gt; retval
        其中参数解释如下：
            points表示输入的点集，如果使用的是Opencv 2.X,则输入点集有两种形式：一是N*2的二维ndarray，其数据类型只能为 int32
                                    或者float32， 即每一行代表一个点；二是N*1*2的三维ndarray，其数据类型只能为int32或者float32
            retval是一个由三个元素组成的元组，依次代表旋转矩形的中心点坐标、尺寸和旋转角度（根据中心坐标、尺寸和旋转角度
                                    可以确定一个旋转矩形）
    （3） OpenCV自带的cv2.boxPoints()函数可以根据旋转矩形的中心的坐标、尺寸和旋转角度，计算出旋转矩形的四个顶点，函数声明如下：
             boxPoints(box[, points]) -&gt; points
        其中参数解释如下：
            box是旋转矩形的三个属性值，通常用一个元组表示，如（（3.0，5.0），（8.0，4.0），-60）
            points是返回的四个顶点，所返回的四个顶点是4行2列、数据类型为float32的ndarray，每一行代表一个顶点坐标
    """</span>
    temp_contours <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> contour <span class="token keyword">in</span> contours<span class="token punctuation">:</span>
        <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>contourArea<span class="token punctuation">(</span>contour<span class="token punctuation">)</span> <span class="token operator">&gt;</span> Min_Area<span class="token punctuation">:</span>
            temp_contours<span class="token punctuation">.</span>append<span class="token punctuation">(</span>contour<span class="token punctuation">)</span>
    car_plate1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    car_plate2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    car_plate3 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> temp_contour <span class="token keyword">in</span> temp_contours<span class="token punctuation">:</span>
        rect_tupple <span class="token operator">=</span> cv2<span class="token punctuation">.</span>minAreaRect<span class="token punctuation">(</span>temp_contour<span class="token punctuation">)</span>
        rect_width<span class="token punctuation">,</span> rect_height <span class="token operator">=</span> rect_tupple<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> rect_width <span class="token operator">&lt;</span> rect_height<span class="token punctuation">:</span>
            rect_width<span class="token punctuation">,</span> rect_height <span class="token operator">=</span> rect_height<span class="token punctuation">,</span> rect_width
        aspect_ratio <span class="token operator">=</span> rect_width <span class="token operator">/</span> rect_height
        <span class="token comment"># 中国：蓝牌和黑牌是440×140，黄牌前牌尺寸同，后牌为440×220；摩托车及轻便摩托车前牌是220×95，后牌是220×140。</span>
        <span class="token comment"># 车牌正常情况下宽高比在2 - 3.15之间 稍微放宽点范围</span>
        <span class="token keyword">if</span> aspect_ratio <span class="token operator">&gt;</span> <span class="token number">1.5</span> <span class="token keyword">and</span> aspect_ratio <span class="token operator">&lt;</span> <span class="token number">4.65</span><span class="token punctuation">:</span>
            car_plate1<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_contour<span class="token punctuation">)</span>
            rect_vertices <span class="token operator">=</span> cv2<span class="token punctuation">.</span>boxPoints<span class="token punctuation">(</span>rect_tupple<span class="token punctuation">)</span>
            rect_vertices <span class="token operator">=</span> np<span class="token punctuation">.</span>int0<span class="token punctuation">(</span>rect_vertices<span class="token punctuation">)</span>
            <span class="token comment"># print(temp_contour)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'一次筛查后，符合比例的矩形有'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>car_plate1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'个'</span><span class="token punctuation">)</span>

    <span class="token comment"># 二次筛查 如果符合尺寸的矩形大于1，则缩小宽高比</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>car_plate1<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> temp_contour <span class="token keyword">in</span> car_plate1<span class="token punctuation">:</span>
            rect_tupple <span class="token operator">=</span> cv2<span class="token punctuation">.</span>minAreaRect<span class="token punctuation">(</span>temp_contour<span class="token punctuation">)</span>
            rect_width<span class="token punctuation">,</span> rect_height <span class="token operator">=</span> rect_tupple<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> rect_width <span class="token operator">&lt;</span> rect_height<span class="token punctuation">:</span>
                rect_width<span class="token punctuation">,</span> rect_height <span class="token operator">=</span> rect_height<span class="token punctuation">,</span> rect_width
            aspect_ratio <span class="token operator">=</span> rect_width <span class="token operator">/</span> rect_height
            <span class="token comment"># 中国：蓝牌和黑牌是440×140，黄牌前牌尺寸同，后牌为440×220；摩托车及轻便摩托车前牌是220×95，后牌是220×140。</span>
            <span class="token comment"># 车牌正常情况下宽高比在2 - 3.15之间 稍微放宽点范围</span>
            <span class="token keyword">if</span> aspect_ratio <span class="token operator">&gt;</span> <span class="token number">1.6</span> <span class="token keyword">and</span> aspect_ratio <span class="token operator">&lt;</span> <span class="token number">4.15</span><span class="token punctuation">:</span>
                car_plate2<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_contour<span class="token punctuation">)</span>
                rect_vertices <span class="token operator">=</span> cv2<span class="token punctuation">.</span>boxPoints<span class="token punctuation">(</span>rect_tupple<span class="token punctuation">)</span>
                rect_vertices <span class="token operator">=</span> np<span class="token punctuation">.</span>int0<span class="token punctuation">(</span>rect_vertices<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'二次筛查后，符合比例的矩形还有'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>car_plate2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'个'</span><span class="token punctuation">)</span>

    <span class="token comment"># 三次筛查 如果符合尺寸的矩形大于1，则缩小宽高比</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>car_plate2<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> temp_contour <span class="token keyword">in</span> car_plate2<span class="token punctuation">:</span>
            rect_tupple <span class="token operator">=</span> cv2<span class="token punctuation">.</span>minAreaRect<span class="token punctuation">(</span>temp_contour<span class="token punctuation">)</span>
            rect_width<span class="token punctuation">,</span> rect_height <span class="token operator">=</span> rect_tupple<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> rect_width <span class="token operator">&lt;</span> rect_height<span class="token punctuation">:</span>
                rect_width<span class="token punctuation">,</span> rect_height <span class="token operator">=</span> rect_height<span class="token punctuation">,</span> rect_width
            aspect_ratio <span class="token operator">=</span> rect_width <span class="token operator">/</span> rect_height
            <span class="token comment"># 中国：蓝牌和黑牌是440×140，黄牌前牌尺寸同，后牌为440×220；摩托车及轻便摩托车前牌是220×95，后牌是220×140。</span>
            <span class="token comment"># 车牌正常情况下宽高比在2 - 3.15之间 稍微放宽点范围</span>
            <span class="token keyword">if</span> aspect_ratio <span class="token operator">&gt;</span> <span class="token number">1.8</span> <span class="token keyword">and</span> aspect_ratio <span class="token operator">&lt;</span> <span class="token number">3.35</span><span class="token punctuation">:</span>
                car_plate3<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_contour<span class="token punctuation">)</span>
                rect_vertices <span class="token operator">=</span> cv2<span class="token punctuation">.</span>boxPoints<span class="token punctuation">(</span>rect_tupple<span class="token punctuation">)</span>
                rect_vertices <span class="token operator">=</span> np<span class="token punctuation">.</span>int0<span class="token punctuation">(</span>rect_vertices<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'三次筛查后，符合比例的矩形还有'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>car_plate3<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'个'</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>car_plate3<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> car_plate3
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>car_plate2<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> car_plate2
    <span class="token keyword">return</span> car_plate1


<span class="token comment"># 根据得到的车牌定位，将车牌从原始图像中截取出来，并存在指定目录中。</span>
<span class="token keyword">def</span> <span class="token function">license_segment</span><span class="token punctuation">(</span>car_plates<span class="token punctuation">,</span> out_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    此函数根据得到的车牌定位，将车牌从原始图像中截取出来，并存在指定目录中。
    输入： car_plates是经过初步筛选之后的车牌轮廓的点集
    输出:   out_path是车牌的存储路径
    """</span>
    i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>car_plates<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> car_plate <span class="token keyword">in</span> car_plates<span class="token punctuation">:</span>
            row_min<span class="token punctuation">,</span> col_min <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>car_plate<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            row_max<span class="token punctuation">,</span> col_max <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>car_plate<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>row_min<span class="token punctuation">,</span> col_min<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>row_max<span class="token punctuation">,</span> col_max<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            card_img <span class="token operator">=</span> img<span class="token punctuation">[</span>col_min<span class="token punctuation">:</span>col_max<span class="token punctuation">,</span> row_min<span class="token punctuation">:</span>row_max<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
            cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>out_path <span class="token operator">+</span> <span class="token string">"/card_img"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".jpg"</span><span class="token punctuation">,</span> card_img<span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"card_img"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".jpg"</span><span class="token punctuation">,</span> card_img<span class="token punctuation">)</span>
            i <span class="token operator">+=</span> <span class="token number">1</span>
            cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'共切出'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'张车牌图。'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> out_path <span class="token operator">+</span> <span class="token string">"/card_img0.jpg"</span>


<span class="token comment"># 根据设定的阈值和图片直方图，找出波峰，用于分隔字符</span>
<span class="token keyword">def</span> <span class="token function">find_waves</span><span class="token punctuation">(</span>threshold<span class="token punctuation">,</span> histogram<span class="token punctuation">)</span><span class="token punctuation">:</span>
    up_point <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token comment"># 上升点</span>
    is_peak <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword">if</span> histogram<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> threshold<span class="token punctuation">:</span>
        up_point <span class="token operator">=</span> <span class="token number">0</span>
        is_peak <span class="token operator">=</span> <span class="token boolean">True</span>
    wave_peaks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> x <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>histogram<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> is_peak <span class="token keyword">and</span> x <span class="token operator">&lt;</span> threshold<span class="token punctuation">:</span>
            <span class="token keyword">if</span> i <span class="token operator">-</span> up_point <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
                is_peak <span class="token operator">=</span> <span class="token boolean">False</span>
                wave_peaks<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>up_point<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> <span class="token keyword">not</span> is_peak <span class="token keyword">and</span> x <span class="token operator">&gt;=</span> threshold<span class="token punctuation">:</span>
            is_peak <span class="token operator">=</span> <span class="token boolean">True</span>
            up_point <span class="token operator">=</span> i
    <span class="token keyword">if</span> is_peak <span class="token keyword">and</span> up_point <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">and</span> i <span class="token operator">-</span> up_point <span class="token operator">&gt;</span> <span class="token number">4</span><span class="token punctuation">:</span>
        wave_peaks<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>up_point<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> wave_peaks


<span class="token comment"># 将截取到的车牌照片转化为灰度图，然后去除车牌的上下无用的边缘部分，确定上下边框</span>
<span class="token keyword">def</span> <span class="token function">remove_plate_upanddown_border</span><span class="token punctuation">(</span>card_img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    这个函数将截取到的车牌照片转化为灰度图，然后去除车牌的上下无用的边缘部分，确定上下边框
    输入： card_img是从原始图片中分割出的车牌照片
    输出: 在高度上缩小后的字符二值图片
    """</span>
    plate_Arr <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>card_img<span class="token punctuation">)</span>
    plate_gray_Arr <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>plate_Arr<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
    ret<span class="token punctuation">,</span> plate_binary_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>plate_gray_Arr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>THRESH_BINARY <span class="token operator">+</span> cv2<span class="token punctuation">.</span>THRESH_OTSU<span class="token punctuation">)</span>
    row_histogram <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>plate_binary_img<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 数组的每一行求和</span>
    row_min <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>row_histogram<span class="token punctuation">)</span>
    row_average <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>row_histogram<span class="token punctuation">)</span> <span class="token operator">/</span> plate_binary_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    row_threshold <span class="token operator">=</span> <span class="token punctuation">(</span>row_min <span class="token operator">+</span> row_average<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    wave_peaks <span class="token operator">=</span> find_waves<span class="token punctuation">(</span>row_threshold<span class="token punctuation">,</span> row_histogram<span class="token punctuation">)</span>
    <span class="token comment"># 接下来挑选跨度最大的波峰</span>
    wave_span <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">for</span> wave_peak <span class="token keyword">in</span> wave_peaks<span class="token punctuation">:</span>
        span <span class="token operator">=</span> wave_peak<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> wave_peak<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> span <span class="token operator">&gt;</span> wave_span<span class="token punctuation">:</span>
            wave_span <span class="token operator">=</span> span
            selected_wave <span class="token operator">=</span> wave_peak
    plate_binary_img <span class="token operator">=</span> plate_binary_img<span class="token punctuation">[</span>selected_wave<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>selected_wave<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"plate_binary_img"</span><span class="token punctuation">,</span> plate_binary_img<span class="token punctuation">)</span>

    <span class="token keyword">return</span> plate_binary_img

    <span class="token comment">##################################################</span>
    <span class="token comment"># 测试用</span>
    <span class="token comment"># print( row_histogram )</span>
    <span class="token comment"># fig = plt.figure()</span>
    <span class="token comment"># plt.hist( row_histogram )</span>
    <span class="token comment"># plt.show()</span>
    <span class="token comment"># 其中row_histogram是一个列表，列表当中的每一个元素是车牌二值图像每一行的灰度值之和，列表的长度等于二值图像的高度</span>
    <span class="token comment"># 认为在高度方向，跨度最大的波峰为车牌区域</span>
    <span class="token comment"># cv2.imshow("plate_gray_Arr", plate_binary_img[selected_wave[0]:selected_wave[1], :])</span>
    <span class="token comment">##################################################</span>


<span class="token comment">#####################二分-K均值聚类算法############################</span>

<span class="token keyword">def</span> <span class="token function">distEclud</span><span class="token punctuation">(</span>vecA<span class="token punctuation">,</span> vecB<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    计算两个坐标向量之间的街区距离
    """</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">(</span>vecA <span class="token operator">-</span> vecB<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">randCent</span><span class="token punctuation">(</span>dataSet<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>
    n <span class="token operator">=</span> dataSet<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># 列数</span>
    centroids <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 用来保存k个类的质心</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        minJ <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>dataSet<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> j<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        rangeJ <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dataSet<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> minJ
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>
            centroids<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> minJ <span class="token operator">+</span> rangeJ <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> k
    <span class="token keyword">return</span> centroids


<span class="token keyword">def</span> <span class="token function">kMeans</span><span class="token punctuation">(</span>dataSet<span class="token punctuation">,</span> k<span class="token punctuation">,</span> distMeas<span class="token operator">=</span>distEclud<span class="token punctuation">,</span> createCent<span class="token operator">=</span>randCent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    m <span class="token operator">=</span> dataSet<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    clusterAssment <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 这个簇分配结果矩阵包含两列，一列记录簇索引值，第二列存储误差。这里的误差是指当前点到簇质心的街区距离</span>
    centroids <span class="token operator">=</span> createCent<span class="token punctuation">(</span>dataSet<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
    clusterChanged <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">while</span> clusterChanged<span class="token punctuation">:</span>
        clusterChanged <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>
            minDist <span class="token operator">=</span> np<span class="token punctuation">.</span>inf
            minIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>
                distJI <span class="token operator">=</span> distMeas<span class="token punctuation">(</span>centroids<span class="token punctuation">[</span>j<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dataSet<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> distJI <span class="token operator">&lt;</span> minDist<span class="token punctuation">:</span>
                    minDist <span class="token operator">=</span> distJI
                    minIndex <span class="token operator">=</span> j
            <span class="token keyword">if</span> clusterAssment<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> minIndex<span class="token punctuation">:</span>
                clusterChanged <span class="token operator">=</span> <span class="token boolean">True</span>
            clusterAssment<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> minIndex<span class="token punctuation">,</span> minDist <span class="token operator">**</span> <span class="token number">2</span>
        <span class="token keyword">for</span> cent <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>
            ptsInClust <span class="token operator">=</span> dataSet<span class="token punctuation">[</span>np<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>clusterAssment<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> cent<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
            centroids<span class="token punctuation">[</span>cent<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>ptsInClust<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> centroids<span class="token punctuation">,</span> clusterAssment


<span class="token comment"># 将所有点作为一个簇，然后将该簇一分为二。之后选择其中一个簇继续进行划分，选择哪一个簇进行划分取决于对其划分是否可以最大程度降低SSE的值。</span>
<span class="token keyword">def</span> <span class="token function">biKmeans</span><span class="token punctuation">(</span>dataSet<span class="token punctuation">,</span> k<span class="token punctuation">,</span> distMeas<span class="token operator">=</span>distEclud<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    这个函数首先将所有点作为一个簇，然后将该簇一分为二。之后选择其中一个簇继续进行划分，选择哪一个簇进行划分取决于对其划分是否可以最大程度降低SSE的值。
    输入：dataSet是一个ndarray形式的输入数据集
          k是用户指定的聚类后的簇的数目
         distMeas是距离计算函数
    输出:  centList是一个包含类质心的列表，其中有k个元素，每个元素是一个元组形式的质心坐标
            clusterAssment是一个数组，第一列对应输入数据集中的每一行样本属于哪个簇，第二列是该样本点与所属簇质心的距离
    """</span>
    m <span class="token operator">=</span> dataSet<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    clusterAssment <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    centroid0 <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>dataSet<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
    centList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    centList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>centroid0<span class="token punctuation">)</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>
        clusterAssment<span class="token punctuation">[</span>j<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> distMeas<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>centroid0<span class="token punctuation">)</span><span class="token punctuation">,</span> dataSet<span class="token punctuation">[</span>j<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span>
    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>centList<span class="token punctuation">)</span> <span class="token operator">&lt;</span> k<span class="token punctuation">:</span>  <span class="token comment"># 小于K个簇时</span>
        lowestSSE <span class="token operator">=</span> np<span class="token punctuation">.</span>inf
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>centList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            ptsInCurrCluster <span class="token operator">=</span> dataSet<span class="token punctuation">[</span>np<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>clusterAssment<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> i<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
            centroidMat<span class="token punctuation">,</span> splitClustAss <span class="token operator">=</span> kMeans<span class="token punctuation">(</span>ptsInCurrCluster<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> distMeas<span class="token punctuation">)</span>
            sseSplit <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>splitClustAss<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            sseNotSplit <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>clusterAssment<span class="token punctuation">[</span>np<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>clusterAssment<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sseSplit <span class="token operator">+</span> sseNotSplit<span class="token punctuation">)</span> <span class="token operator">&lt;</span> lowestSSE<span class="token punctuation">:</span>  <span class="token comment"># 如果满足，则保存本次划分</span>
                bestCentTosplit <span class="token operator">=</span> i
                bestNewCents <span class="token operator">=</span> centroidMat
                bestClustAss <span class="token operator">=</span> splitClustAss<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                lowestSSE <span class="token operator">=</span> sseSplit <span class="token operator">+</span> sseNotSplit
        bestClustAss<span class="token punctuation">[</span>np<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>bestClustAss<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>centList<span class="token punctuation">)</span>
        bestClustAss<span class="token punctuation">[</span>np<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>bestClustAss<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> bestCentTosplit
        centList<span class="token punctuation">[</span>bestCentTosplit<span class="token punctuation">]</span> <span class="token operator">=</span> bestNewCents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
        centList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>bestNewCents<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        clusterAssment<span class="token punctuation">[</span>np<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>clusterAssment<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> bestCentTosplit<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> bestClustAss
    <span class="token keyword">return</span> centList<span class="token punctuation">,</span> clusterAssment


<span class="token comment"># 对车牌的二值图进行水平方向的切分，将字符分割出来</span>
<span class="token keyword">def</span> <span class="token function">split_licensePlate_character</span><span class="token punctuation">(</span>plate_binary_img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    此函数用来对车牌的二值图进行水平方向的切分，将字符分割出来
    输入： plate_gray_Arr是车牌的二值图，rows * cols的数组形式
    输出： character_list是由分割后的车牌单个字符图像二值图矩阵组成的列表
    """</span>
    plate_binary_Arr <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>plate_binary_img<span class="token punctuation">)</span>
    row_list<span class="token punctuation">,</span> col_list <span class="token operator">=</span> np<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>plate_binary_Arr <span class="token operator">&gt;=</span> <span class="token number">255</span><span class="token punctuation">)</span>
    dataArr <span class="token operator">=</span> np<span class="token punctuation">.</span>column_stack<span class="token punctuation">(</span><span class="token punctuation">(</span>col_list<span class="token punctuation">,</span> row_list<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># dataArr的第一列是列索引，第二列是行索引，要注意</span>
    centroids<span class="token punctuation">,</span> clusterAssment <span class="token operator">=</span> biKmeans<span class="token punctuation">(</span>dataArr<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> distMeas<span class="token operator">=</span>distEclud<span class="token punctuation">)</span>
    centroids_sorted <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>centroids<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> centroid<span class="token punctuation">:</span> centroid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    split_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> centroids_ <span class="token keyword">in</span> centroids_sorted<span class="token punctuation">:</span>
        i <span class="token operator">=</span> centroids<span class="token punctuation">.</span>index<span class="token punctuation">(</span>centroids_<span class="token punctuation">)</span>
        current_class <span class="token operator">=</span> dataArr<span class="token punctuation">[</span>np<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>clusterAssment<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> i<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
        x_min<span class="token punctuation">,</span> y_min <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>current_class<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        x_max<span class="token punctuation">,</span> y_max <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>current_class<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        split_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>y_min<span class="token punctuation">,</span> y_max<span class="token punctuation">,</span> x_min<span class="token punctuation">,</span> x_max<span class="token punctuation">]</span><span class="token punctuation">)</span>
    character_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>split_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        single_character_Arr <span class="token operator">=</span> plate_binary_img<span class="token punctuation">[</span>split_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span> split_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> split_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>split_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        character_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>single_character_Arr<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'character'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> single_character_Arr<span class="token punctuation">)</span>
        <span class="token comment"># 存储所有字符切图</span>
        cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span><span class="token string">'img/LPR/character'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.jpg'</span><span class="token punctuation">,</span> single_character_Arr<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'字符切割完毕'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> character_list  <span class="token comment"># character_list中保存着每个字符的二值图数据</span>

    <span class="token comment">############################</span>
    <span class="token comment"># 测试用</span>
    <span class="token comment"># print(col_histogram )</span>
    <span class="token comment"># fig = plt.figure()</span>
    <span class="token comment"># plt.hist( col_histogram )</span>
    <span class="token comment"># plt.show()</span>
    <span class="token comment">############################</span>


<span class="token comment"># 输入灰度图，返回hash</span>
<span class="token keyword">def</span> <span class="token function">getHash</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    avreage <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    <span class="token builtin">hash</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> image<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">&gt;</span> avreage<span class="token punctuation">:</span>
                <span class="token builtin">hash</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token builtin">hash</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">hash</span>


<span class="token comment"># 计算汉明距离</span>
<span class="token keyword">def</span> <span class="token function">Hamming_distance</span><span class="token punctuation">(</span>hash1<span class="token punctuation">,</span> hash2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    num <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>hash1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> hash1<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">!=</span> hash2<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">:</span>
            num <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">return</span> num


<span class="token comment"># 参考：https://zhuanlan.zhihu.com/p/29868652</span>
<span class="token comment"># 感知哈希算法(pHash)</span>
<span class="token comment"># 缩小图片：32 * 32是一个较好的大小，这样方便DCT计算</span>
<span class="token comment"># 转化为灰度图</span>
<span class="token comment"># 计算DCT：利用Opencv中提供的dct()方法，注意输入的图像必须是32位浮点型，所以先利用numpy中的float32进行转换</span>
<span class="token comment"># 缩小DCT：DCT计算后的矩阵是32 * 32，保留左上角的8 * 8，这些代表的图片的最低频率</span>
<span class="token comment"># 计算平均值：计算缩小DCT后的所有像素点的平均值。</span>
<span class="token comment"># 进一步减小DCT：大于平均值记录为1，反之记录为0.</span>
<span class="token comment"># 得到信息指纹：组合64个信息位，顺序随意保持一致性。</span>
<span class="token comment"># 最后比对两张图片的指纹，获得汉明距离即可。</span>
<span class="token keyword">def</span> <span class="token function">classify_pHash</span><span class="token punctuation">(</span>image1_path<span class="token punctuation">,</span> image2_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    image1 <span class="token operator">=</span> imread_photo<span class="token punctuation">(</span>image1_path<span class="token punctuation">)</span>
    image2 <span class="token operator">=</span> imread_photo<span class="token punctuation">(</span>image2_path<span class="token punctuation">)</span>
    image1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>image1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    image2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>image2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    gray1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>image1<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
    gray2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>image2<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
    <span class="token comment"># 将灰度图转为浮点型，再进行dct变换</span>
    dct1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>dct<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span>gray1<span class="token punctuation">)</span><span class="token punctuation">)</span>
    dct2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>dct<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span>gray2<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 取左上角的8*8，这些代表图片的最低频率</span>
    <span class="token comment"># 这个操作等价于c++中利用opencv实现的掩码操作</span>
    <span class="token comment"># 在python中进行掩码操作，可以直接这样取出图像矩阵的某一部分</span>
    dct1_roi <span class="token operator">=</span> dct1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span>
    dct2_roi <span class="token operator">=</span> dct2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span>
    hash1 <span class="token operator">=</span> getHash<span class="token punctuation">(</span>dct1_roi<span class="token punctuation">)</span>
    hash2 <span class="token operator">=</span> getHash<span class="token punctuation">(</span>dct2_roi<span class="token punctuation">)</span>
    <span class="token keyword">return</span> Hamming_distance<span class="token punctuation">(</span>hash1<span class="token punctuation">,</span> hash2<span class="token punctuation">)</span>


<span class="token comment"># 原文链接：https://blog.csdn.net/qq_45453185/article/details/103450129</span>
<span class="token keyword">def</span> <span class="token function">findSmallest</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    smallest <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 存储最小的值</span>
    smallest_index <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 存储最小元素的索引</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> smallest<span class="token punctuation">:</span>
            smallest <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            smallest_index <span class="token operator">=</span> i
    <span class="token keyword">return</span> smallest_index


<span class="token comment"># 字符识别 传入切好的车牌字符路径，字母集合路径</span>
<span class="token keyword">def</span> <span class="token function">ocr_pHash</span><span class="token punctuation">(</span>char_path<span class="token punctuation">,</span> letter_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\n函数ocr_pHash识别结果如下：'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'跳过第一个中文字符'</span><span class="token punctuation">)</span>
    hamming_distance_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    license_plate <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 计算汉明距离结果放入hamming_distance_arr</span>
            hamming_distance_arr<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                classify_pHash<span class="token punctuation">(</span>char_path <span class="token operator">+</span> <span class="token string">'/character'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.jpg'</span><span class="token punctuation">,</span> letter_path <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.png'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 输出汉明距离最小值所对应的字母</span>
        num <span class="token operator">=</span> findSmallest<span class="token punctuation">(</span>hamming_distance_arr<span class="token punctuation">)</span>
        <span class="token keyword">if</span> num <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
            license_plate <span class="token operator">+=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            license_plate <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">55</span><span class="token punctuation">)</span>
        <span class="token comment"># 清空数组</span>
        hamming_distance_arr<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'车牌为：某'</span> <span class="token operator">+</span> license_plate <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>


<span class="token comment"># Tesseract-OCR 图像识别 传入车牌路径</span>
<span class="token keyword">def</span> <span class="token function">tesseract_ocr</span><span class="token punctuation">(</span>car_img_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\n函数tesseract_ocr识别结果如下：'</span><span class="token punctuation">)</span>
    <span class="token comment"># 替换成你的路径</span>
    ret <span class="token operator">=</span> os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">'D:\Tesseract-OCR\\tesseract.exe '</span> <span class="token operator">+</span> car_img_path <span class="token operator">+</span> <span class="token string">' result -l chi_sim'</span><span class="token punctuation">)</span>
    <span class="token comment"># print(ret)</span>

    <span class="token comment"># 给tesseract一点处理时间</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># 读写模式打开文件</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'result.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token comment"># 读取第一行</span>
        line1 <span class="token operator">=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        rows <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># print(rows)</span>
        <span class="token keyword">if</span> rows <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'车牌为：'</span> <span class="token operator">+</span> line1 <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'识别失败，哦豁\n'</span><span class="token punctuation">)</span>


<span class="token comment"># 配合pytesseract食用 需要配置Tesseract-OCR的环境变量</span>
<span class="token comment"># def pytesseract_ocr(car_img_path):</span>
<span class="token comment">#     print('\n函数pytesseract_ocr识别结果如下：')</span>
<span class="token comment">#     img_cv = cv2.imread(car_img_path)</span>
<span class="token comment">#</span>
<span class="token comment">#     # By default OpenCV stores images in BGR format and since pytesseract assumes RGB format,</span>
<span class="token comment">#     # we need to convert from BGR to RGB format/mode:</span>
<span class="token comment">#     img_rgb = cv2.cvtColor(img_cv, cv2.COLOR_BGR2RGB)</span>
<span class="token comment">#     ret = pytesseract.image_to_string(img_rgb, lang='chi_sim')</span>
<span class="token comment">#     print('车牌为：' + ret + '\n')</span>


<span class="token comment">############################机器学习识别字符##########################################</span>
<span class="token comment">#这部分是支持向量机的代码</span>
<span class="token comment">############################机器学习识别字符##########################################</span>


<span class="token comment"># 加载数据集 传入图片需要压缩的像素比</span>
<span class="token keyword">def</span> <span class="token function">load_data</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    这个函数用来加载数据集
    """</span>

    middle_route <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">,</span> <span class="token string">'8'</span><span class="token punctuation">,</span> <span class="token string">'9'</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">,</span> <span class="token string">'E'</span><span class="token punctuation">,</span> <span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'G'</span><span class="token punctuation">,</span> <span class="token string">'H'</span><span class="token punctuation">,</span> <span class="token string">'J'</span><span class="token punctuation">,</span> <span class="token string">'K'</span><span class="token punctuation">,</span>
                    <span class="token string">'L'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'P'</span><span class="token punctuation">,</span> <span class="token string">'Q'</span><span class="token punctuation">,</span> <span class="token string">'R'</span><span class="token punctuation">,</span> <span class="token string">'S'</span><span class="token punctuation">,</span> <span class="token string">'T'</span><span class="token punctuation">,</span> <span class="token string">'U'</span><span class="token punctuation">,</span> <span class="token string">'V'</span><span class="token punctuation">,</span> <span class="token string">'W'</span><span class="token punctuation">,</span> <span class="token string">'X'</span><span class="token punctuation">,</span> <span class="token string">'Y'</span><span class="token punctuation">,</span> <span class="token string">'Z'</span><span class="token punctuation">]</span>
    sample_number <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 用来计算总的样本数</span>
    <span class="token comment"># 遍历每一个字符照片，得到34*2个1 * w * h的一维数组，把它们合并成为一个68 * w * h（即68行w * h列）的数据集</span>
    dataArr <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">68</span><span class="token punctuation">,</span> w <span class="token operator">*</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
    label_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># 循环数字+字母次</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">r'img\LPR\letter\dizhi\\'</span> <span class="token operator">+</span> middle_route<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fr_2<span class="token punctuation">:</span>
            temp_address <span class="token operator">=</span> <span class="token punctuation">[</span>row_1<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> row_1 <span class="token keyword">in</span> fr_2<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token comment"># print(temp_address)</span>
        <span class="token comment"># sample_number += len(temp_address)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>temp_address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            sample_number <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token comment"># print(middle_route[i])</span>
            <span class="token comment"># print(temp_address_2[j])</span>
            <span class="token comment"># 读入数据图片，转单通道灰度</span>
            temp_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'img\LPR\letter\\'</span> <span class="token operator">+</span> middle_route<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\\'</span> <span class="token operator">+</span> temp_address<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>IMREAD_GRAYSCALE<span class="token punctuation">)</span>
            <span class="token comment"># print('img\LPR\letter\\' + middle_route[i] + '\\' + temp_address[j])</span>
            <span class="token comment"># 将图片压缩到 w * h</span>
            temp_img2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>temp_img<span class="token punctuation">,</span> <span class="token punctuation">[</span>w<span class="token punctuation">,</span> h<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># cv2.imshow("temp_img2", temp_img2)</span>
            <span class="token comment"># cv2.waitKey(0)</span>
            <span class="token comment"># cv2.destroyAllWindows()</span>
            <span class="token comment"># 改变矩阵的通道数、行数 对矩阵元素进行序列化</span>
            temp_img2 <span class="token operator">=</span> temp_img2<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> w <span class="token operator">*</span> h<span class="token punctuation">)</span>
            dataArr<span class="token punctuation">[</span>sample_number <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp_img2
        label_list<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>temp_address<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># print(label_list)</span>
    <span class="token comment"># print(len(label_list))</span>
    <span class="token keyword">return</span> dataArr<span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>label_list<span class="token punctuation">)</span>


<span class="token comment"># 保存训练好的模型</span>
<span class="token keyword">def</span> <span class="token function">SVM_rocognition</span><span class="token punctuation">(</span>dataArr<span class="token punctuation">,</span> label_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 同步注释点1</span>
    <span class="token comment"># 从sklearn.decomposition 导入PCA</span>
    <span class="token comment"># from sklearn.decomposition import PCA</span>
    <span class="token comment"># 初始化一个可以压缩至7个维度的PCA</span>
    <span class="token comment"># estimator = PCA(n_components=7)</span>
    <span class="token comment"># 用dataArr来训练PCA模型，同时返回降维后的数据。</span>
    <span class="token comment"># new_dataArr = estimator.fit_transform(dataArr)</span>
    <span class="token comment"># 使用默认配置初始化SVM，对降维后的训练数据进行建模，并在测试集上做出预测</span>
    <span class="token comment"># svc.fit(new_dataArr, label_list)</span>

    <span class="token keyword">import</span> sklearn<span class="token punctuation">.</span>svm
    svc <span class="token operator">=</span> sklearn<span class="token punctuation">.</span>svm<span class="token punctuation">.</span>SVC<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 使用默认配置初始化SVM，对原始315维像素特征的训练数据进行建模，并在测试集上做出预测</span>
    svc<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>dataArr<span class="token punctuation">,</span> label_list<span class="token punctuation">)</span>

    <span class="token comment"># 通过joblib的dump可以将模型保存到本地，clf是训练的分类器</span>
    <span class="token keyword">import</span> joblib
    <span class="token comment"># 保存训练好的模型，通过svc = joblib.load("based_SVM_character_train_model.m")调用</span>
    joblib<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>svc<span class="token punctuation">,</span> <span class="token string">"based_SVM_character_train_model.m"</span><span class="token punctuation">)</span>


<span class="token comment"># SVM字符识别</span>
<span class="token keyword">def</span> <span class="token function">SVM_rocognition_character</span><span class="token punctuation">(</span>character_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\n函数SVM_rocognition_character识别结果如下：'</span><span class="token punctuation">)</span>
    w <span class="token operator">=</span> <span class="token number">20</span>
    h <span class="token operator">=</span> <span class="token number">40</span>
    character_Arr <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>character_list<span class="token punctuation">)</span><span class="token punctuation">,</span> w <span class="token operator">*</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># print(len(character_list))</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>character_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        character_ <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>character_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">)</span>
        new_character_ <span class="token operator">=</span> character_<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> w <span class="token operator">*</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        character_Arr<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_character_

    <span class="token comment"># 同步注释点1</span>
    <span class="token comment"># 从sklearn.decomposition 导入PCA</span>
    <span class="token comment"># from sklearn.decomposition import PCA</span>
    <span class="token comment"># # 要求降维后的feature数量少于样本数</span>
    <span class="token comment"># # 初始化一个可以降到7个维度的PCA</span>
    <span class="token comment"># estimator = PCA(n_components=7)</span>
    <span class="token comment"># # 用character_Arr来训练PCA模型，同时返回降维后的数据 character_Arr。</span>
    <span class="token comment"># character_Arr = estimator.fit_transform(character_Arr)</span>

    dataArr<span class="token punctuation">,</span> label_list <span class="token operator">=</span> load_data<span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
    SVM_rocognition<span class="token punctuation">(</span>dataArr<span class="token punctuation">,</span> label_list<span class="token punctuation">)</span>

    <span class="token keyword">import</span> joblib
    clf <span class="token operator">=</span> joblib<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"based_SVM_character_train_model.m"</span><span class="token punctuation">)</span>
    <span class="token comment"># 返回预测结果，显示标签值</span>
    predict_result <span class="token operator">=</span> clf<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>character_Arr<span class="token punctuation">)</span>
    middle_route <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">,</span> <span class="token string">'8'</span><span class="token punctuation">,</span> <span class="token string">'9'</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">,</span> <span class="token string">'E'</span><span class="token punctuation">,</span> <span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'G'</span><span class="token punctuation">,</span>
                    <span class="token string">'H'</span><span class="token punctuation">,</span> <span class="token string">'J'</span><span class="token punctuation">,</span> <span class="token string">'K'</span><span class="token punctuation">,</span> <span class="token string">'L'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'P'</span><span class="token punctuation">,</span> <span class="token string">'Q'</span><span class="token punctuation">,</span> <span class="token string">'R'</span><span class="token punctuation">,</span> <span class="token string">'S'</span><span class="token punctuation">,</span> <span class="token string">'T'</span><span class="token punctuation">,</span> <span class="token string">'U'</span><span class="token punctuation">,</span> <span class="token string">'V'</span><span class="token punctuation">,</span> <span class="token string">'W'</span><span class="token punctuation">,</span> <span class="token string">'X'</span><span class="token punctuation">,</span> <span class="token string">'Y'</span><span class="token punctuation">,</span> <span class="token string">'Z'</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>predict_result<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    license_plate <span class="token operator">=</span> <span class="token string">'车牌为：某'</span>
    <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>predict_result<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 跳过第一个中文的识别结果</span>
        <span class="token keyword">if</span> k <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            license_plate <span class="token operator">+=</span> middle_route<span class="token punctuation">[</span>predict_result<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'车牌为：某'</span> <span class="token operator">+</span> license_plate <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># 你要识别的图片</span>
    img <span class="token operator">=</span> imread_photo<span class="token punctuation">(</span><span class="token string">"img/LPR/car05.jpg"</span><span class="token punctuation">)</span>
    gray_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'gray_img'</span><span class="token punctuation">,</span> gray_img<span class="token punctuation">)</span>

    <span class="token comment"># 调整图像的尺寸大小 等比缩放至500*500</span>
    img <span class="token operator">=</span> resize_keep_aspectratio<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    gray_img <span class="token operator">=</span> resize_keep_aspectratio<span class="token punctuation">(</span>gray_img<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># 过一系列的处理，找到可能是车牌的一些矩形区域</span>
    gray_img_<span class="token punctuation">,</span> contours<span class="token punctuation">,</span> contours2 <span class="token operator">=</span> predict<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'gray_img_'</span><span class="token punctuation">,</span> gray_img_<span class="token punctuation">)</span>

    <span class="token comment"># 画出轮廓</span>
    <span class="token comment"># draw_contours(gray_img_, contours)</span>
    draw_contours<span class="token punctuation">(</span>gray_img<span class="token punctuation">,</span> contours2<span class="token punctuation">)</span>

    <span class="token comment"># 根据车牌的一些物理特征（面积等）对所得的矩形进行过滤</span>
    car_plate <span class="token operator">=</span> chose_licence_plate<span class="token punctuation">(</span>contours2<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>car_plate<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'没有识别到车牌，程序结束。'</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 根据得到的车牌定位，将车牌从原始图像中截取出来，并存在当前目录中。</span>
        car_img_path <span class="token operator">=</span> license_segment<span class="token punctuation">(</span>car_plate<span class="token punctuation">,</span> <span class="token string">"img/LPR"</span><span class="token punctuation">)</span>

        <span class="token comment"># 将截取到的车牌照片转化为灰度图，然后去除车牌的上下无用的边缘部分，确定上下边框</span>
        plate_binary_img <span class="token operator">=</span> remove_plate_upanddown_border<span class="token punctuation">(</span>car_img_path<span class="token punctuation">)</span>

        <span class="token comment"># 对车牌的二值图进行水平方向的切分，将字符分割出来</span>
        character_list <span class="token operator">=</span> split_licensePlate_character<span class="token punctuation">(</span>plate_binary_img<span class="token punctuation">)</span>

        <span class="token comment"># SVM字符识别</span>
        SVM_rocognition_character<span class="token punctuation">(</span>character_list<span class="token punctuation">)</span>

        <span class="token comment"># 感知哈希算法的字符识别</span>
        ocr_pHash<span class="token punctuation">(</span><span class="token string">'img/LPR'</span><span class="token punctuation">,</span> <span class="token string">'img/LPR/letter'</span><span class="token punctuation">)</span>

        <span class="token comment"># Tesseract-OCR 图像识别</span>
        tesseract_ocr<span class="token punctuation">(</span>car_img_path<span class="token punctuation">)</span>
        <span class="token comment"># 配合pytesseract食用</span>
        <span class="token comment"># pytesseract_ocr(car_img_path)</span>

        cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h2><a id="_789"></a>拓展</h2> 
<h3><a id="_790"></a>切出的车牌图传入百度云做云识别</h3> 
<p><img src="https://images2.imgbox.com/97/23/w4lZcNCh_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c4/e4/JEC5W4co_o.png" alt="在这里插入图片描述"><br> 参考：<a href="https://cloud.baidu.com/doc/OCR/s/Pkrwx9ye4" rel="nofollow">https://cloud.baidu.com/doc/OCR/s/Pkrwx9ye4</a><br> 官方源码微调如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># coding=utf-8</span>

<span class="token keyword">import</span> sys
<span class="token keyword">import</span> json
<span class="token keyword">import</span> base64


<span class="token comment"># 保证兼容python2以及python3</span>
IS_PY3 <span class="token operator">=</span> sys<span class="token punctuation">.</span>version_info<span class="token punctuation">.</span>major <span class="token operator">==</span> <span class="token number">3</span>
<span class="token keyword">if</span> IS_PY3<span class="token punctuation">:</span>
    <span class="token keyword">from</span> urllib<span class="token punctuation">.</span>request <span class="token keyword">import</span> urlopen
    <span class="token keyword">from</span> urllib<span class="token punctuation">.</span>request <span class="token keyword">import</span> Request
    <span class="token keyword">from</span> urllib<span class="token punctuation">.</span>error <span class="token keyword">import</span> URLError
    <span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlencode
    <span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote_plus
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> urllib2
    <span class="token keyword">from</span> urllib <span class="token keyword">import</span> quote_plus
    <span class="token keyword">from</span> urllib2 <span class="token keyword">import</span> urlopen
    <span class="token keyword">from</span> urllib2 <span class="token keyword">import</span> Request
    <span class="token keyword">from</span> urllib2 <span class="token keyword">import</span> URLError
    <span class="token keyword">from</span> urllib <span class="token keyword">import</span> urlencode

<span class="token comment"># 防止https证书校验不正确</span>
<span class="token keyword">import</span> ssl
ssl<span class="token punctuation">.</span>_create_default_https_context <span class="token operator">=</span> ssl<span class="token punctuation">.</span>_create_unverified_context

<span class="token comment"># 修改为你的个人配置</span>
API_KEY <span class="token operator">=</span> <span class="token string">'GmhC18eVP1Fo1ECX911dtOzw'</span>
SECRET_KEY <span class="token operator">=</span> <span class="token string">'PQ2ukO4Aec2PTsgQU9UkiEKYciavlZk8'</span>
<span class="token comment"># 通用文字识别</span>
OCR_URL1 <span class="token operator">=</span> <span class="token string">"https://aip.baidubce.com/rest/2.0/ocr/v1/accurate_basic"</span>
<span class="token comment"># 车牌识别</span>
OCR_URL2 <span class="token operator">=</span> <span class="token string">"https://aip.baidubce.com/rest/2.0/ocr/v1/license_plate"</span>


<span class="token triple-quoted-string string">"""  TOKEN start """</span>
TOKEN_URL <span class="token operator">=</span> <span class="token string">'https://aip.baidubce.com/oauth/2.0/token'</span>


<span class="token triple-quoted-string string">"""
    获取token
"""</span>
<span class="token keyword">def</span> <span class="token function">fetch_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'grant_type'</span><span class="token punctuation">:</span> <span class="token string">'client_credentials'</span><span class="token punctuation">,</span>
              <span class="token string">'client_id'</span><span class="token punctuation">:</span> API_KEY<span class="token punctuation">,</span>
              <span class="token string">'client_secret'</span><span class="token punctuation">:</span> SECRET_KEY<span class="token punctuation">}</span>
    post_data <span class="token operator">=</span> urlencode<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>IS_PY3<span class="token punctuation">)</span><span class="token punctuation">:</span>
        post_data <span class="token operator">=</span> post_data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    req <span class="token operator">=</span> Request<span class="token punctuation">(</span>TOKEN_URL<span class="token punctuation">,</span> post_data<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        f <span class="token operator">=</span> urlopen<span class="token punctuation">(</span>req<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
        result_str <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> URLError <span class="token keyword">as</span> err<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>IS_PY3<span class="token punctuation">)</span><span class="token punctuation">:</span>
        result_str <span class="token operator">=</span> result_str<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>


    result <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>result_str<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'access_token'</span> <span class="token keyword">in</span> result<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token string">'scope'</span> <span class="token keyword">in</span> result<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token string">'brain_all_scope'</span> <span class="token keyword">in</span> result<span class="token punctuation">[</span><span class="token string">'scope'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'please ensure has check the  ability'</span><span class="token punctuation">)</span>
            exit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result<span class="token punctuation">[</span><span class="token string">'access_token'</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'please overwrite the correct API_KEY and SECRET_KEY'</span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
    读取文件
"""</span>
<span class="token keyword">def</span> <span class="token function">read_file</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    f <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'read image file fail'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> f<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token triple-quoted-string string">"""
    调用远程服务
"""</span>
<span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    req <span class="token operator">=</span> Request<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    has_error <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        f <span class="token operator">=</span> urlopen<span class="token punctuation">(</span>req<span class="token punctuation">)</span>
        result_str <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>IS_PY3<span class="token punctuation">)</span><span class="token punctuation">:</span>
            result_str <span class="token operator">=</span> result_str<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result_str
    <span class="token keyword">except</span>  URLError <span class="token keyword">as</span> err<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token comment"># 获取access token</span>
    token <span class="token operator">=</span> fetch_token<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 拼接通用文字识别高精度url</span>
    image_url1 <span class="token operator">=</span> OCR_URL1 <span class="token operator">+</span> <span class="token string">"?access_token="</span> <span class="token operator">+</span> token
    <span class="token comment"># 拼接车牌识别高精度url</span>
    image_url2 <span class="token operator">=</span> OCR_URL2 <span class="token operator">+</span> <span class="token string">"?access_token="</span> <span class="token operator">+</span> token

    text <span class="token operator">=</span> <span class="token string">""</span>

    <span class="token comment"># 读取测试图片</span>
    file_content <span class="token operator">=</span> read_file<span class="token punctuation">(</span><span class="token string">'img/LPR/card_img0.jpg'</span><span class="token punctuation">)</span>

    <span class="token comment"># 调用文字识别服务</span>
    result1 <span class="token operator">=</span> request<span class="token punctuation">(</span>image_url1<span class="token punctuation">,</span> urlencode<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'image'</span><span class="token punctuation">:</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>file_content<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 调用车牌识别服务</span>
    result2 <span class="token operator">=</span> request<span class="token punctuation">(</span>image_url2<span class="token punctuation">,</span> urlencode<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'image'</span><span class="token punctuation">:</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>file_content<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 解析返回结果</span>
    result_json1 <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>result1<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result1<span class="token punctuation">)</span>
    result_json2 <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>result2<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result2<span class="token punctuation">)</span>

    <span class="token comment"># 通用文字识别</span>
    <span class="token keyword">for</span> words_result <span class="token keyword">in</span> result_json1<span class="token punctuation">[</span><span class="token string">"words_result"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        text <span class="token operator">=</span> text <span class="token operator">+</span> words_result<span class="token punctuation">[</span><span class="token string">"words"</span><span class="token punctuation">]</span>
    <span class="token comment"># 打印文字</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>

    text <span class="token operator">=</span> <span class="token string">""</span>

    <span class="token comment"># 车牌识别</span>
    text <span class="token operator">=</span> text <span class="token operator">+</span> result_json2<span class="token punctuation">[</span><span class="token string">"words_result"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"number"</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2994bc03163567c07ce41c5531c35ca7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">在vs mac中基于.Net6 Mvc EFcore生成数据表（mysql版）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fc64dee12af909391700ecc59a8ad448/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Gradle 和插件这两者的最新版本</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>