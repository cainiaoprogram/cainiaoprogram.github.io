<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>shap库源码和代码实现 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="shap库源码和代码实现" />
<meta property="og:description" content="SHAP有两个核心，分别是shap values和shap interaction values，在官方的应用中，主要有三种，分别是force plot、summary plot和dependence plot，这三种应用都是对shap values和shap interaction values进行处理后得到的。
代码实现 a waterfall plot def waterfall(shap_values, max_display=10, show=True): &#34;&#34;&#34; Plots an explantion of a single prediction as a waterfall plot. The SHAP value of a feature represents the impact of the evidence provided by that feature on the model&#39;s output. The waterfall plot is designed to visually display how the SHAP values (evidence) of each feature move the model output from our prior expectation under the background data distribution, to the final model prediction given the evidence of all the features." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e2e5aab312f98f0dc0bc6ceea6f025d2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-06T10:45:40+08:00" />
<meta property="article:modified_time" content="2022-08-06T10:45:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">shap库源码和代码实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>SHAP有两个核心，分别是shap values和shap interaction values，在官方的应用中，主要有三种，分别是force plot、summary plot和dependence plot，这三种应用都是对shap values和shap interaction values进行处理后得到的。</p> 
<h2><a id="_2"></a>代码实现</h2> 
<h3><a id="a_waterfall_plot_4"></a>a waterfall plot</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">waterfall</span><span class="token punctuation">(</span>shap_values<span class="token punctuation">,</span> max_display<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> show<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" Plots an explantion of a single prediction as a waterfall plot.

    The SHAP value of a feature represents the impact of the evidence provided by that feature on the model's
    output. The waterfall plot is designed to visually display how the SHAP values (evidence) of each feature
    move the model output from our prior expectation under the background data distribution, to the final model
    prediction given the evidence of all the features. Features are sorted by the magnitude of their SHAP values
    with the smallest magnitude features grouped together at the bottom of the plot when the number of features
    in the models exceeds the max_display parameter.

    Parameters
    ----------
    shap_values : Explanation
        A one-dimensional Explanation object that contains the feature values and SHAP values to plot.

    max_display : str
        The maximum number of features to plot.

    show : bool
        Whether matplotlib.pyplot.show() is called before returning. Setting this to False allows the plot
        to be customized further after it has been created.
    """</span>
</code></pre> 
<h2><a id="shapsummary_plot_31"></a>shap.summary_plot</h2> 
<p>取每个特征的SHAP值的绝对值的平均值作为该特征的重要性，得到一个标准的条形图(multi-class则生成堆叠的条形图)</p> 
<pre><code class="prism language-python">shap<span class="token punctuation">.</span>summary_plot<span class="token punctuation">(</span>shap_values<span class="token punctuation">,</span> features<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> feature_names<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> max_display<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> plot_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> axis_color<span class="token operator">=</span><span class="token string">'#333333'</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> show<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> sort<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> color_bar<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> plot_size<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">,</span> layered_violin_max_num_bins<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> class_names<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> class_inds<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> color_bar_label<span class="token operator">=</span><span class="token string">'Feature value'</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token operator">&lt;</span>matplotlib<span class="token punctuation">.</span>colors<span class="token punctuation">.</span>LinearSegmentedColormap <span class="token builtin">object</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> auto_size_plot<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> use_log_scale<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<p>Create a SHAP beeswarm plot, colored by feature values when they are provided.</p> 
<h4><a id="Parameters_39"></a>Parameters</h4> 
<blockquote> 
 <p><strong>shap_valuesnumpy.array</strong></p> 
</blockquote> 
<p>For single output explanations this is a matrix of SHAP values (# samples x # features). For multi-output explanations this is a list of such matrices of SHAP values.</p> 
<blockquote> 
 <p><strong>featuresnumpy.array or pandas.DataFrame or list</strong></p> 
</blockquote> 
<p>Matrix of feature values (# samples x # features) or a feature_names list as shorthand</p> 
<blockquote> 
 <p><strong>feature_nameslist</strong></p> 
</blockquote> 
<p>Names of the features (length # features)</p> 
<blockquote> 
 <p><strong>max_display:int</strong></p> 
</blockquote> 
<p>How many top features to include in the plot (default is 20, or 7 for interaction plots)</p> 
<blockquote> 
 <p><strong>plot_type“dot” (default for single output), “bar” (default formulti-output), “violin”,</strong></p> 
</blockquote> 
<p>or “compact_dot”. What type of summary plot to produce. Note that “compact_dot” is only used for SHAP interaction values.</p> 
<blockquote> 
 <p>plot_size“auto” (default), float, (float, float), or None</p> 
</blockquote> 
<p>What size to make the plot. By default the size is auto-scaled based on the number of features that are being displayed. Passing a single float will cause each row to be that many inches high. Passing a pair of floats will scale the plot by that number of inches. If None is passed then the size of the current figure will be left unchanged.</p> 
<h2><a id="shapforce_plot_68"></a>shap.force_plot</h2> 
<pre><code class="prism language-python">shap<span class="token punctuation">.</span>force_plot<span class="token punctuation">(</span>base_value<span class="token punctuation">,</span> shap_values<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> features<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> feature_names<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> out_names<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> link<span class="token operator">=</span><span class="token string">'identity'</span><span class="token punctuation">,</span> plot_cmap<span class="token operator">=</span><span class="token string">'RdBu'</span><span class="token punctuation">,</span> matplotlib<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> show<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> ordering_keys<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> ordering_keys_time_format<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> text_rotation<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<p>Visualize the given SHAP values with an additive force layout.</p> 
<h4><a id="Parameters_76"></a>Parameters</h4> 
<blockquote> 
 <p><strong>base_value:float</strong></p> 
</blockquote> 
<p>This is the reference value that the feature contributions start from. For SHAP values it should be the value of explainer.expected_value.</p> 
<blockquote> 
 <p><strong>shap_values:numpy.array</strong></p> 
</blockquote> 
<p>Matrix of SHAP values (# features) or (# samples x # features). If this is a 1D array then a single force plot will be drawn, if it is a 2D array then a stacked force plot will be drawn.</p> 
<blockquote> 
 <p><strong>features:numpy.array</strong></p> 
</blockquote> 
<p>Matrix of feature values (# features) or (# samples x # features). This provides the values of all the features, and should be the same shape as the shap_values argument.</p> 
<blockquote> 
 <p><strong>feature_names:list</strong></p> 
</blockquote> 
<p>List of feature names (# features).</p> 
<blockquote> 
 <p><strong>out_names:str</strong></p> 
</blockquote> 
<p>The name of the output of the model (plural to support multi-output plotting in the future).</p> 
<blockquote> 
 <p><strong>link“identity” or “logit”</strong></p> 
</blockquote> 
<p>The transformation used when drawing the tick mark labels. Using logit will change log-odds numbers into probabilities.</p> 
<blockquote> 
 <p><strong>matplotlib:bool</strong></p> 
</blockquote> 
<p>Whether to use the default Javascript output, or the (less developed) matplotlib output. Using matplotlib can be helpful in scenarios where rendering Javascript/HTML is inconvenient.</p> 
<h3><a id="shap_values_112"></a>shap_values</h3> 
<pre><code class="prism language-python">  <span class="token keyword">def</span> <span class="token function">shap_values</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">,</span> ranked_outputs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> output_rank_order<span class="token operator">=</span><span class="token string">'max'</span><span class="token punctuation">,</span> check_additivity<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre> 
<p>Return approximate SHAP values for the model applied to the data given by X.</p> 
<h3><a id="Parameters_120"></a>Parameters</h3> 
<pre><code>    X : list,
        if framework == 'tensorflow': numpy.array, or pandas.DataFrame
        if framework == 'pytorch': torch.tensor
        A tensor (or list of tensors) of samples (where X.shape[0] == # samples) on which to
        explain the model's output.

    ranked_outputs : None or int
        If ranked_outputs is None then we explain all the outputs in a multi-output model. If
        ranked_outputs is a positive integer then we only explain that many of the top model
        outputs (where "top" is determined by output_rank_order). Note that this causes a pair
        of values to be returned (shap_values, indexes), where shap_values is a list of numpy
        arrays for each of the output ranks, and indexes is a matrix that indicates for each sample
        which output indexes were choses as "top".

    output_rank_order : "max", "min", or "max_abs"
        How to order the model outputs when using ranked_outputs, either by maximum, minimum, or
        maximum absolute value.

    Returns
    -------
    array or list
        For a models with a single output this returns a tensor of SHAP values with the same shape
        as X. For a model with multiple outputs this returns a list of SHAP value tensors, each of
        which are the same shape as X. If ranked_outputs is None then this list of tensors matches
        the number of model outputs. If ranked_outputs is a positive integer a pair is returned
        (shap_values, indexes), where shap_values is a list of tensors with a length of
        ranked_outputs, and indexes is a matrix that indicates for each sample which output indexes
        were chosen as "top".
    """
    return self.explainer.shap_values(X, ranked_outputs, output_rank_order, check_additivity=check_additivity)
</code></pre> 
<h3><a id="SHAP_Decision_Plots_153"></a>SHAP Decision Plots</h3> 
<blockquote> 
 <p>https://slundberg.github.io/shap/notebooks/plots/decision_plot.html</p> 
</blockquote> 
<h2><a id="_157"></a>图类型</h2> 
<h3><a id="Feature_Importance_159"></a>Feature Importance：</h3> 
<p>之前提到传统的importance的计算方法效果不好，SHAP提供了另一种计算特征重要性的思路。</p> 
<p>取每个特征的SHAP值的绝对值的平均值作为该特征的重要性，得到一个标准的条形图(multi-class则生成堆叠的条形图)</p> 
<p>shap.summary_plot(shap_values, X, plot_type=“bar”)</p> 
<h3><a id="_166"></a>摘要图</h3> 
<p>summary plot 为每个样本绘制其每个特征的SHAP值，这可以更好地理解整体模式，并允许发现预测异常值。每一行代表一个特征，横坐标为SHAP值。一个点代表一个样本，颜色表示特征值(红色高，蓝色低)。比如，这张图表明LSTAT特征较高的取值会降低预测的房价</p> 
<p>结合了特征重要度和特征的影响。摘要图上的每个点都是一个特征和一个实例的Shapley值，y轴上的位置由特征决定，x轴上的位置由Shapley值决定，颜色代表特征值从小到大，重叠点在y轴方向上抖动，因此我们可以了解每个特征的Shapley值的分布。</p> 
<p>对特征的总体分析<br> 除了能对单个样本的SHAP值进行可视化之外，还能对特征进行整体的可视化。</p> 
<p>下图中每一行代表一个特征，横坐标为SHAP值。一个点代表一个样本，颜色越红说明特征本身数值越大，颜色越蓝说明特征本身数值越小。</p> 
<p>我们可以直观地看出潜力potential是一个很重要的特征，而且基本上是与身价成正相关的。年龄age也会明显影响身价，蓝色点主要集中在SHAP小于0的区域，可见年纪小会降低身价估值，另一方面如果年纪很大，也会降低估值，甚至降低得更明显，因为age这一行最左端的点基本上都是红色的。<br> <img src="https://images2.imgbox.com/02/83/Mw7MYBNk_o.png" alt="在这里插入图片描述"><br> SHAP摘要图显示服用激素避孕药的年数（Hormonal.Contraceptives…years.）越少，患癌症的风险越低，服用年数越多，患癌症的风险越高。不过所有的影响都只是描述了模型的行为，在现实世界中不一定是因果关系。</p> 
<p>在摘要图中，我们首先看到特征值与预测影响之间的关系，但要了解这种关系的确切形式，我们必须看看SHAP依赖图。</p> 
<h3><a id="SHAP_182"></a>SHAP依赖图</h3> 
<p>官网文档<br> https://shap-lrjball.readthedocs.io/en/latest/generated/shap.dependence_plot.html<br> SHAP依赖图可能是最简单的全局解释图：</p> 
<p>选择一个特性。对于每个数据实例，绘制一个点，x轴上是特征值，y轴上是对应的Shapley值。<br> 完成。<br> 下图显示了服用激素避孕药的年数（Hormonal.Contraceptives…years.）的SHAP依赖图，该图包含所有的点​ ：<br> <img src="https://images2.imgbox.com/3f/c3/ImAjImsh_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到，与0年相比，服用激素避孕药的年数少则预测概率低，年数多则预测癌症概率高。</p> 
<p>SHAP依赖图可以替代部分依赖图（Partial Dependence Plot）和累积局部效应图（Accumulated Local Effects Plot）。SHAP依赖图也显示y轴上的方差，这是因为有其他特征的相互作用，所以依赖图在y轴上会分散。通过显示这些特性交互，可以改进依赖图。</p> 
<h3><a id="Partial_Dependence_Plot_196"></a>部分依赖图Partial Dependence Plot</h3> 
<p>SHAP也提供了部分依赖图的功能，与传统的部分依赖图不同的是，这里纵坐标不是目标变量y的数值而是SHAP值。</p> 
<p>比如下图中，年纪大概呈现出金字塔分布，也就是24到31岁这个年纪对球员的身价是拉抬作用，小于24以及大于31岁的球员身价则会被年纪所累。<br> <img src="https://images2.imgbox.com/a1/d1/ZbEn4rVo_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">shap<span class="token punctuation">.</span>dependence_plot<span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> shap_values<span class="token punctuation">,</span> data<span class="token punctuation">[</span>cols<span class="token punctuation">]</span><span class="token punctuation">,</span> interaction_index<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> show<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_207"></a>对多个变量的交互进行分析</h3> 
<p>https://zhuanlan.zhihu.com/p/64799119<br> 我们也可以多个变量的交互作用进行分析。一种方式是采用summary_plot描绘出散点图，如下：</p> 
<pre><code class="prism language-python">shap_interaction_values <span class="token operator">=</span> shap<span class="token punctuation">.</span>TreeExplainer<span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">.</span>shap_interaction_values<span class="token punctuation">(</span>data<span class="token punctuation">[</span>cols<span class="token punctuation">]</span><span class="token punctuation">)</span>
shap<span class="token punctuation">.</span>summary_plot<span class="token punctuation">(</span>shap_interaction_values<span class="token punctuation">,</span> data<span class="token punctuation">[</span>cols<span class="token punctuation">]</span><span class="token punctuation">,</span> max_display<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
</code></pre> 
<p>我们也可以用dependence_plot描绘两个变量交互下变量对目标值的影响。</p> 
<pre><code class="prism language-python">shap<span class="token punctuation">.</span>dependence_plot<span class="token punctuation">(</span><span class="token string">'potential'</span><span class="token punctuation">,</span> shap_values<span class="token punctuation">,</span> data<span class="token punctuation">[</span>cols<span class="token punctuation">]</span><span class="token punctuation">,</span> interaction_index<span class="token operator">=</span><span class="token string">'international_reputation'</span><span class="token punctuation">,</span> show<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<p>参考链接：<br> https://zhuanlan.zhihu.com/p/85791430<br> https://zhuanlan.zhihu.com/p/338526488<br> https://blog.csdn.net/qq_41103204/article/details/104896630<br> https://zhuanlan.zhihu.com/p/64799119</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6f63cd8328cbf17c21c1e825d878af45/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">uniapp开发的h5网页如何去掉网址里的#号</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fae661a0b3cba17b25745faaecfe133e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">（附代码）入门 | 如何使用C/C&#43;&#43;调用Python脚本</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>