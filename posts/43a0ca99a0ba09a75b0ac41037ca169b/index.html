<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Flutter 笔记 | Flutter 自定义组件 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Flutter 笔记 | Flutter 自定义组件" />
<meta property="og:description" content="Flutter 自定义组件的几种方式 当Flutter提供的现有组件无法满足我们的需求，或者我们为了共享代码需要封装一些通用组件，这时我们就需要自定义组件。在Flutter中自定义组件有三种方式：通过组合其他组件、自绘和实现RenderObject。
1. 组合多个Widget
这种方式是通过拼装多个组件来组合成一个新的组件。例如我们之前介绍的Container就是一个组合组件，它是由DecoratedBox、ConstrainedBox、Transform、Padding、Align等组件组成。
在Flutter中，组合的思想非常重要，Flutter提供了非常多的基础组件，而我们的界面开发其实就是按照需要组合这些组件来实现各种不同的布局而已。
2. 通过CustomPaint自绘
如果遇到无法通过现有的组件来实现需要的UI时，我们可以通过自绘组件的方式来实现，例如我们需要一个颜色渐变的圆形进度条，而Flutter提供的CircularProgressIndicator并不支持在显示精确进度时对进度条应用渐变色（其valueColor 属性只支持执行旋转动画时变化Indicator的颜色），这时最好的方法就是通过自定义组件来绘制出我们期望的外观。我们可以通过Flutter中提供的CustomPaint和Canvas来实现UI自绘。
3. 通过RenderObject自绘
Flutter提供的自身具有UI外观的组件，如文本Text、Image都是通过相应的RenderObject渲染出来的，如Text是由RenderParagraph渲染；而Image是由RenderImage渲染。RenderObject是一个抽象类，它定义了一个抽象方法paint(...)：
void paint(PaintingContext context, Offset offset) PaintingContext代表组件的绘制上下文，通过PaintingContext.canvas可以获得Canvas，而绘制逻辑主要是通过Canvas API来实现。子类需要重写此方法以实现自身的绘制逻辑，如RenderParagraph需要实现文本绘制逻辑，而RenderImage需要实现图片绘制逻辑。
可以发现，RenderObject中最终也是通过Canvas API来绘制的，那么通过实现RenderObject的方式和上面介绍的通过CustomPaint和Canvas自绘的方式有什么区别？其实答案很简单，CustomPaint只是为了方便开发者封装的一个代理类，它直接继承自SingleChildRenderObjectWidget，通过RenderCustomPaint的paint方法将Canvas和画笔Painter(需要开发者实现，后面介绍)连接起来实现了最终的绘制（绘制逻辑在Painter中）。
总结：“组合”是自定义组件最简单的方法，在任何需要自定义组件的场景下，我们都应该优先考虑是否能够通过组合来实现。而通过CustomPaint和RenderObject自绘的方式本质上是一样的，都需要开发者调用Canvas API手动去绘制UI，优点是强大灵活，理论上可以实现任何外观的UI，而缺点是必须了解Canvas API细节，并且得自己去实现绘制逻辑。
组合现有组件 实例：自定义渐变按钮 Flutter Material组件库中的按钮默认不支持渐变背景，为了实现渐变背景按钮，我们自定义一个GradientButton组件，它需要支持以下功能：
背景支持渐变色手指按下时有涟漪效果可以支持圆角 我们先来看看最终要实现的效果：
DecoratedBox可以支持背景色渐变和圆角，InkWell在手指按下有涟漪效果，所以我们可以通过组合DecoratedBox和InkWell来实现GradientButton，代码如下：
import &#39;package:flutter/material.dart&#39;; ///组合方式定义一个渐变色按钮 ///使用DecoratedBox、Padding、Center、InkWell等组合而成 class GradientButton extends StatelessWidget { const GradientButton({ Key? key, this.colors, this.width, this.height, this.onPressed, this.borderRadius, required this.child, }): super(key: key); // 渐变色数组 final List&lt;Color&gt;? colors; // 按钮宽高 final double? width; final double? height; final Widget child; final BorderRadius?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/43a0ca99a0ba09a75b0ac41037ca169b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-29T00:00:53+08:00" />
<meta property="article:modified_time" content="2023-05-29T00:00:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Flutter 笔记 | Flutter 自定义组件</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Flutter__0"></a>Flutter 自定义组件的几种方式</h3> 
<p>当Flutter提供的现有组件无法满足我们的需求，或者我们为了共享代码需要封装一些通用组件，这时我们就需要自定义组件。在Flutter中自定义组件有三种方式：<strong>通过组合其他组件</strong>、<strong>自绘</strong>和<strong>实现<code>RenderObject</code></strong>。</p> 
<p><strong>1. 组合多个Widget</strong></p> 
<p>这种方式是通过拼装多个组件来组合成一个新的组件。例如我们之前介绍的<code>Container</code>就是一个组合组件，它是由<code>DecoratedBox、ConstrainedBox、Transform、Padding、Align</code>等组件组成。</p> 
<p>在Flutter中，组合的思想非常重要，Flutter提供了非常多的基础组件，而我们的界面开发其实就是按照需要组合这些组件来实现各种不同的布局而已。</p> 
<p><strong>2. 通过CustomPaint自绘</strong></p> 
<p>如果遇到无法通过现有的组件来实现需要的UI时，我们可以通过自绘组件的方式来实现，例如我们需要一个颜色渐变的圆形进度条，而Flutter提供的<code>CircularProgressIndicator</code>并不支持在显示精确进度时对进度条应用渐变色（其<code>valueColor</code> 属性只支持执行旋转动画时变化<code>Indicator</code>的颜色），这时最好的方法就是通过自定义组件来绘制出我们期望的外观。我们可以通过Flutter中提供的<code>CustomPaint</code>和<code>Canvas</code>来实现UI自绘。</p> 
<p><strong>3. 通过RenderObject自绘</strong></p> 
<p>Flutter提供的自身具有UI外观的组件，如文本<code>Text、Image</code>都是通过相应的<code>RenderObject</code>渲染出来的，如<code>Text</code>是由<code>RenderParagraph</code>渲染；而<code>Image</code>是由<code>RenderImage</code>渲染。<code>RenderObject</code>是一个抽象类，它定义了一个抽象方法<code>paint(...)</code>：</p> 
<pre><code class="prism language-dart"><span class="token keyword">void</span> <span class="token function">paint</span><span class="token punctuation">(</span><span class="token class-name">PaintingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Offset</span> offset<span class="token punctuation">)</span>
</code></pre> 
<p><code>PaintingContext</code>代表组件的绘制上下文，通过<code>PaintingContext.canvas</code>可以获得<code>Canvas</code>，而绘制逻辑主要是通过<code>Canvas</code> API来实现。子类需要重写此方法以实现自身的绘制逻辑，如<code>RenderParagraph</code>需要实现文本绘制逻辑，而<code>RenderImage</code>需要实现图片绘制逻辑。</p> 
<p>可以发现，<code>RenderObject</code>中最终也是通过<code>Canvas</code> API来绘制的，那么通过实现<code>RenderObject</code>的方式和上面介绍的通过<code>CustomPaint</code>和<code>Canvas</code>自绘的方式有什么区别？其实答案很简单，<code>CustomPaint</code>只是为了方便开发者封装的一个代理类，它直接继承自<code>SingleChildRenderObjectWidget</code>，通过<code>RenderCustomPaint</code>的<code>paint</code>方法将<code>Canvas</code>和画笔<code>Painter</code>(需要开发者实现，后面介绍)连接起来实现了最终的绘制（绘制逻辑在<code>Painter</code>中）。</p> 
<p><strong>总结</strong>：<strong>“组合”是自定义组件最简单的方法，在任何需要自定义组件的场景下，我们都应该优先考虑是否能够通过组合来实现</strong>。而通过<code>CustomPaint</code>和<code>RenderObject</code>自绘的方式本质上是一样的，都需要开发者调用<code>Canvas</code> API手动去绘制UI，优点是强大灵活，理论上可以实现任何外观的UI，而缺点是必须了解<code>Canvas</code> API细节，并且得自己去实现绘制逻辑。</p> 
<h3><a id="_28"></a>组合现有组件</h3> 
<h4><a id="_29"></a>实例：自定义渐变按钮</h4> 
<p>Flutter Material组件库中的按钮默认不支持渐变背景，为了实现渐变背景按钮，我们自定义一个<code>GradientButton</code>组件，它需要支持以下功能：</p> 
<ol><li>背景支持渐变色</li><li>手指按下时有涟漪效果</li><li>可以支持圆角</li></ol> 
<p>我们先来看看最终要实现的效果：</p> 
<p><img src="https://images2.imgbox.com/3c/c6/YrBguHXV_o.png" alt="在这里插入图片描述" width="350"></p> 
<p><code>DecoratedBox</code>可以支持背景色渐变和圆角，<code>InkWell</code>在手指按下有涟漪效果，所以我们可以通过组合<code>DecoratedBox</code>和<code>InkWell</code>来实现<code>GradientButton</code>，代码如下：</p> 
<pre><code class="prism language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/material.dart'</span></span><span class="token punctuation">;</span>

<span class="token comment">///组合方式定义一个渐变色按钮</span>
<span class="token comment">///使用DecoratedBox、Padding、Center、InkWell等组合而成</span>
<span class="token keyword">class</span> <span class="token class-name">GradientButton</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">GradientButton</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>height<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onPressed<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>borderRadius<span class="token punctuation">,</span>
    required <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 渐变色数组</span>
  <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Color</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> colors<span class="token punctuation">;</span>

  <span class="token comment">// 按钮宽高</span>
  <span class="token keyword">final</span> double<span class="token operator">?</span> width<span class="token punctuation">;</span>
  <span class="token keyword">final</span> double<span class="token operator">?</span> height<span class="token punctuation">;</span>

  <span class="token keyword">final</span> <span class="token class-name">Widget</span> child<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">BorderRadius</span><span class="token operator">?</span> borderRadius<span class="token punctuation">;</span>

  <span class="token comment">//点击回调</span>
  <span class="token keyword">final</span> <span class="token class-name">GestureTapCallback</span><span class="token operator">?</span> onPressed<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ThemeData</span> theme <span class="token operator">=</span> <span class="token class-name">Theme</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//确保colors数组不空</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Color</span><span class="token punctuation">&gt;</span></span> _colors <span class="token operator">=</span> colors <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">[</span>theme<span class="token punctuation">.</span>primaryColor<span class="token punctuation">,</span> theme<span class="token punctuation">.</span>primaryColorDark<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">DecoratedBox</span><span class="token punctuation">(</span>
      decoration<span class="token punctuation">:</span> <span class="token class-name">BoxDecoration</span><span class="token punctuation">(</span>
        gradient<span class="token punctuation">:</span> <span class="token class-name">LinearGradient</span><span class="token punctuation">(</span>colors<span class="token punctuation">:</span> _colors<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//渐变色</span>
        borderRadius<span class="token punctuation">:</span> borderRadius<span class="token punctuation">,</span> <span class="token comment">//圆角</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token class-name">Material</span><span class="token punctuation">(</span>
        type<span class="token punctuation">:</span> <span class="token class-name">MaterialType</span><span class="token punctuation">.</span>transparency<span class="token punctuation">,</span>
        child<span class="token punctuation">:</span> <span class="token class-name">InkWell</span><span class="token punctuation">(</span>
          splashColor<span class="token punctuation">:</span> _colors<span class="token punctuation">.</span>last<span class="token punctuation">,</span><span class="token comment">//水波颜色</span>
          highlightColor<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>transparent<span class="token punctuation">,</span><span class="token comment">//高亮色</span>
          borderRadius<span class="token punctuation">:</span> borderRadius<span class="token punctuation">,</span><span class="token comment">//圆角</span>
          onTap<span class="token punctuation">:</span> onPressed<span class="token punctuation">,</span>
          child<span class="token punctuation">:</span> <span class="token class-name">ConstrainedBox</span><span class="token punctuation">(</span>
            constraints<span class="token punctuation">:</span> <span class="token class-name">BoxConstraints</span><span class="token punctuation">.</span><span class="token function">tightFor</span><span class="token punctuation">(</span>height<span class="token punctuation">:</span> height<span class="token punctuation">,</span> width<span class="token punctuation">:</span> width<span class="token punctuation">)</span><span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>
              child<span class="token punctuation">:</span> <span class="token class-name">Padding</span><span class="token punctuation">(</span>
                padding<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">8.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                child<span class="token punctuation">:</span> <span class="token class-name">DefaultTextStyle</span><span class="token punctuation">(</span>
                  style<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>fontWeight<span class="token punctuation">:</span> <span class="token class-name">FontWeight</span><span class="token punctuation">.</span>bold<span class="token punctuation">)</span><span class="token punctuation">,</span>
                  child<span class="token punctuation">:</span> child<span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使用<code>GradientButton</code>:</p> 
<pre><code class="prism language-dart"><span class="token keyword">class</span> <span class="token class-name">GradientButtonRoute</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">GradientButtonRoute</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">State</span> <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_GradientButtonRouteState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> _GradientButtonRouteState <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GradientButtonRoute</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">Scaffold</span><span class="token punctuation">(</span>
        appBar<span class="token punctuation">:</span> <span class="token class-name">AppBar</span><span class="token punctuation">(</span>
          title<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"组合方式自定义组件"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        body<span class="token punctuation">:</span> <span class="token class-name">Column</span><span class="token punctuation">(</span>
          children<span class="token punctuation">:</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Widget</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>
            <span class="token class-name">GradientButton</span><span class="token punctuation">(</span>
              colors<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token class-name">Colors</span><span class="token punctuation">.</span>orange<span class="token punctuation">,</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>red<span class="token punctuation">]</span><span class="token punctuation">,</span>
              height<span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token punctuation">,</span>
              onPressed<span class="token punctuation">:</span> onTap<span class="token punctuation">,</span>
              child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Submit"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">GradientButton</span><span class="token punctuation">(</span>
              width<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
              height<span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token punctuation">,</span>
              colors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Colors</span><span class="token punctuation">.</span>lightGreen<span class="token punctuation">,</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>green<span class="token punctuation">[</span><span class="token number">700</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              onPressed<span class="token punctuation">:</span> onTap<span class="token punctuation">,</span>
              child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Save"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Container</span><span class="token punctuation">(</span>
              margin<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">only</span><span class="token punctuation">(</span>top<span class="token punctuation">:</span> <span class="token number">20.0</span><span class="token punctuation">,</span> left<span class="token punctuation">:</span> <span class="token number">30.0</span><span class="token punctuation">,</span> right<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              child<span class="token punctuation">:</span> <span class="token class-name">GradientButton</span><span class="token punctuation">(</span>
                width<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
                height<span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token punctuation">,</span>
                colors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Colors</span><span class="token punctuation">.</span>lightBlue<span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">,</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>blueAccent<span class="token punctuation">]</span><span class="token punctuation">,</span>
                borderRadius<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">BorderRadius</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token class-name">Radius</span><span class="token punctuation">.</span><span class="token function">circular</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                onPressed<span class="token punctuation">:</span> onTap<span class="token punctuation">,</span>
                child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Delete"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">onTap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"button click"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过组合的方式定义组件和我们之前写界面并无差异，不过在抽离出单独的组件时我们要考虑代码规范性，如必要参数要用<code>required</code>关键词标注，对于可选参数在特定场景需要判空或设置默认值等。这是由于使用者大多时候可能不了解组件的内部细节，所以为了保证代码健壮性，我们需要在用户错误地使用组件时能够兼容或报错提示（使用<code>assert</code>断言函数）。</p> 
<h3><a id="TurnBox_164"></a>组合实例：TurnBox</h3> 
<p>我们之前已经介绍过<code>RotatedBox</code>，它可以旋转子组件，但是它有两个缺点：一是只能将其子节点以<code>90</code>度的倍数旋转；二是当旋转的角度发生变化时，旋转角度更新过程没有动画。</p> 
<p>下面我们将实现一个<code>TurnBox</code>组件，它不仅可以以任意角度来旋转其子节点，而且可以在角度发生变化时执行一个动画以过渡到新状态，同时，我们可以手动指定动画速度。</p> 
<p><code>TurnBox</code>的完整代码如下：</p> 
<pre><code class="prism language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/material.dart'</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">class</span> <span class="token class-name">TurnBox</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">TurnBox</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>turns <span class="token operator">=</span> <span class="token number">.0</span><span class="token punctuation">,</span> <span class="token comment">//旋转的“圈”数,一圈为360度，如0.25圈即90度</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>duration <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token comment">//过渡动画执行的总时长</span>
    required <span class="token keyword">this</span><span class="token punctuation">.</span>child
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> double turns<span class="token punctuation">;</span>
  <span class="token keyword">final</span> int duration<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Widget</span> child<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">State</span> <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_TurnBoxState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> _TurnBoxState <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TurnBox</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">with</span> <span class="token class-name">SingleTickerProviderStateMixin</span> <span class="token punctuation">{<!-- --></span>
  late <span class="token class-name">AnimationController</span> _controller<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _controller <span class="token operator">=</span> <span class="token class-name">AnimationController</span><span class="token punctuation">(</span>
        vsync<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
        lowerBound<span class="token punctuation">:</span> <span class="token operator">-</span>double<span class="token punctuation">.</span>infinity<span class="token punctuation">,</span>
        upperBound<span class="token punctuation">:</span> double<span class="token punctuation">.</span>infinity
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    _controller<span class="token punctuation">.</span>value <span class="token operator">=</span> widget<span class="token punctuation">.</span>turns<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _controller<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//旋转动画</span>
    <span class="token keyword">return</span> <span class="token class-name">RotationTransition</span><span class="token punctuation">(</span>
      turns<span class="token punctuation">:</span> _controller<span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> widget<span class="token punctuation">.</span>child<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">didUpdateWidget</span><span class="token punctuation">(</span><span class="token class-name">TurnBox</span> oldWidget<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">didUpdateWidget</span><span class="token punctuation">(</span>oldWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//旋转角度发生变化时执行过渡动画</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldWidget<span class="token punctuation">.</span>turns <span class="token operator">!=</span> widget<span class="token punctuation">.</span>turns<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      _controller<span class="token punctuation">.</span><span class="token function">animateTo</span><span class="token punctuation">(</span>widget<span class="token punctuation">.</span>turns<span class="token punctuation">,</span>
        duration<span class="token punctuation">:</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>milliseconds<span class="token punctuation">:</span> widget<span class="token punctuation">.</span>duration<span class="token punctuation">)</span><span class="token punctuation">,</span>
        curve<span class="token punctuation">:</span> <span class="token class-name">Curves</span><span class="token punctuation">.</span>easeOut<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面代码中：</p> 
<ol><li>我们是通过组合<code>RotationTransition</code>和<code>child</code>来实现的旋转效果。</li><li>在<code>didUpdateWidget</code>中，我们判断要旋转的角度是否发生了变化，如果变了，则执行一个过渡动画。</li></ol> 
<p>下面我们测试一下<code>TurnBox</code>的功能，测试代码如下：</p> 
<pre><code class="prism language-dart"><span class="token keyword">class</span> <span class="token class-name">TurnBoxRoute</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">TurnBoxRoute</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">State</span> <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_TurnBoxRouteState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> _TurnBoxRouteState <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TurnBoxRoute</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  double _turns <span class="token operator">=</span> <span class="token number">.0</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">Scaffold</span><span class="token punctuation">(</span>
      appBar<span class="token punctuation">:</span> <span class="token class-name">AppBar</span><span class="token punctuation">(</span>
        title<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"任意角度旋转子组件"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      body<span class="token punctuation">:</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>
        child<span class="token punctuation">:</span> <span class="token class-name">Column</span><span class="token punctuation">(</span>
          children<span class="token punctuation">:</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Widget</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>
            <span class="token class-name">TurnBox</span><span class="token punctuation">(</span>
              turns<span class="token punctuation">:</span> _turns<span class="token punctuation">,</span>
              duration<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
              child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Icon</span><span class="token punctuation">(</span>
                <span class="token class-name">Icons</span><span class="token punctuation">.</span>refresh<span class="token punctuation">,</span>
                size<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Padding</span><span class="token punctuation">(</span>
              padding<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              child<span class="token punctuation">:</span> <span class="token class-name">TurnBox</span><span class="token punctuation">(</span>
                turns<span class="token punctuation">:</span> _turns<span class="token punctuation">,</span>
                duration<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
                child<span class="token punctuation">:</span> <span class="token class-name">Image</span><span class="token punctuation">.</span><span class="token function">asset</span><span class="token punctuation">(</span>
                  <span class="token string-literal"><span class="token string">"images/ic_timg.jpg"</span></span><span class="token punctuation">,</span>
                  width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">ElevatedButton</span><span class="token punctuation">(</span>
              child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"顺时针旋转1/5圈"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              onPressed<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _turns <span class="token operator">+=</span> <span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">ElevatedButton</span><span class="token punctuation">(</span>
              child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"逆时针旋转1/5圈"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              onPressed<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _turns <span class="token operator">-=</span> <span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>效果：</p> 
<p><img src="https://images2.imgbox.com/ec/78/v1Fbs5YJ_o.gif" alt="在这里插入图片描述" width="350"><br> 当我们点击旋转按钮时，两个图标的旋转都会旋转1/5圈，但旋转的速度是不同的。</p> 
<p>实际上本示例只组合了<code>RotationTransition</code>一个组件，它是一个最简的组合类组件示例。另外，如果我们封装的是<code>StatefulWidget</code>，那么一定要注意在组件更新时是否需要同步状态。比如我们要封装一个富文本展示组件<code>MyRichText</code> ，它可以自动处理<code>url</code>链接，定义如下：</p> 
<pre><code class="prism language-dart"><span class="token keyword">class</span> <span class="token class-name">MyRichText</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">MyRichText</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Key</span> key<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>text<span class="token punctuation">,</span> <span class="token comment">// 文本字符串</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>linkStyle<span class="token punctuation">,</span> <span class="token comment">// url链接样式</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> <span class="token class-name">String</span> text<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">TextStyle</span> linkStyle<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  _MyRichTextState <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_MyRichTextState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接下来我们在<code>_MyRichTextState</code>中要实现的功能有两个：</p> 
<ol><li>解析文本字符串“<code>text</code>”，生成<code>TextSpan</code>缓存起来；</li><li>在<code>build</code>中返回最终的富文本样式；</li></ol> 
<p><code>_MyRichTextState</code> 实现的代码大致如下：</p> 
<pre><code class="prism language-dart"><span class="token keyword">class</span> _MyRichTextState <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MyRichText</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

  <span class="token class-name">TextSpan</span> _textSpan<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">RichText</span><span class="token punctuation">(</span>
      text<span class="token punctuation">:</span> _textSpan<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">TextSpan</span> <span class="token function">parseText</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 耗时操作：解析文本字符串，构建出TextSpan。</span>
    <span class="token comment">// 省略具体实现。</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _textSpan <span class="token operator">=</span> <span class="token function">parseText</span><span class="token punctuation">(</span>widget<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>由于解析文本字符串，构建出<code>TextSpan</code>是一个耗时操作，为了不在每次<code>build</code>的时候都解析一次，所以我们在<code>initState</code>中对解析的结果进行了缓存，然后再<code>build</code>中直接使用解析的结果<code>_textSpan</code>。</p> 
<p>这看起来很不错，但是上面的代码有一个严重的问题，就是父组件传入的<code>text</code>发生变化时（组件树结构不变），那么<code>MyRichText</code>显示的内容不会更新，原因就是<code>initState</code>只会在<code>State</code>创建时被调用，所以在<code>text</code>发生变化时，<code>parseText</code>没有重新执行，导致<code>_textSpan</code>任然是旧的解析值。</p> 
<p>要解决这个问题也很简单，我们只需添加一个<code>didUpdateWidget</code>回调，然后再里面重新调用<code>parseText</code>即可：</p> 
<pre><code class="prism language-dart"><span class="token metadata function">@override</span>
<span class="token keyword">void</span> <span class="token function">didUpdateWidget</span><span class="token punctuation">(</span><span class="token class-name">MyRichText</span> oldWidget<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>widget<span class="token punctuation">.</span>text <span class="token operator">!=</span> oldWidget<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _textSpan <span class="token operator">=</span> <span class="token function">parseText</span><span class="token punctuation">(</span>widget<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">didUpdateWidget</span><span class="token punctuation">(</span>oldWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>有些开发者可能会觉得这个点也很简单，是的，的确很简单，之所以要在这里反复强调是因为这个点在实际开发中很容易被忽略，它虽然简单，但却很重要。总之，当我们在<code>State</code>中会缓存某些依赖<code>Widget</code>参数的数据时，一定要注意在组件更新时是否需要同步状态。</p> 
<blockquote> 
 <p>再次强调，自定义组件的一个重要点，就是在<code>didUpdateWidget</code>中根据新旧组件的状态值比较决定是否要重新构建UI。</p> 
</blockquote> 
<h3><a id="CustomPaint__Canvas_372"></a>CustomPaint 与 Canvas</h3> 
<p>对于一些复杂或不规则的UI，我们可能无法通过组合其他组件的方式来实现，比如我们需要一个正六边形、一个渐变的圆形进度条、一个棋盘等。当然，有时候我们可以使用图片来实现，但在一些需要动态交互的场景静态图片也是实现不了的，比如要实现一个手写输入面板，这时，我们就需要来自己绘制UI外观。</p> 
<p>几乎所有的UI系统都会提供一个自绘UI的接口，这个接口通常会提供一块2D画布<code>Canvas</code>，<code>Canvas</code>内部封装了一些基本绘制的API，开发者可以通过<code>Canvas</code>绘制各种自定义图形。在Flutter中，提供了一个<code>CustomPaint</code> 组件，它可以结合画笔<code>CustomPainter</code>来实现自定义图形绘制。</p> 
<h4><a id="CustomPaint_378"></a>CustomPaint</h4> 
<p>我们看看<code>CustomPaint</code>构造函数：</p> 
<pre><code class="prism language-dart"><span class="token class-name">CustomPaint</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token class-name">Key</span> key<span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>painter<span class="token punctuation">,</span> 
  <span class="token keyword">this</span><span class="token punctuation">.</span>foregroundPainter<span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token class-name">Size</span><span class="token punctuation">.</span>zero<span class="token punctuation">,</span> 
  <span class="token keyword">this</span><span class="token punctuation">.</span>isComplex <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> 
  <span class="token keyword">this</span><span class="token punctuation">.</span>willChange <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> 
  <span class="token class-name">Widget</span> child<span class="token punctuation">,</span> <span class="token comment">//子节点，可以为空</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li><code>painter</code>: 背景画笔，会显示在子节点后面;</li><li><code>foregroundPainter</code>: 前景画笔，会显示在子节点前面</li><li><code>size</code>：当<code>child</code>为<code>null</code>时，代表默认绘制区域大小，如果有<code>child</code>则忽略此参数，画布尺寸则为<code>child</code>尺寸。如果有<code>child</code>但是想指定画布为特定大小，可以使用<code>SizeBox</code>包裹<code>CustomPaint</code>实现。</li><li><code>isComplex</code>：是否复杂的绘制，如果是，Flutter会应用一些缓存策略来减少重复渲染的开销。</li><li><code>willChange</code>：和<code>isComplex</code>配合使用，当启用缓存时，该属性代表在下一帧中绘制是否会改变。</li></ul> 
<p>可以看到，绘制时我们需要提供前景或背景画笔，两者也可以同时提供。我们的画笔需要继承<code>CustomPainter</code>类，我们在画笔类中实现真正的绘制逻辑。</p> 
<p><strong>1. 绘制边界 RepaintBoundary</strong></p> 
<p>如果<code>CustomPaint</code>有子节点，为了避免子节点不必要的重绘并提高性能，通常情况下都会将子节点包裹在<code>RepaintBoundary</code>组件中，这样会在绘制时就会创建一个新的绘制层（<code>Layer</code>），其子组件将在新的<code>Layer</code>上绘制，而父组件将在原来<code>Layer</code>上绘制，也就是说<code>RepaintBoundary</code> 子组件的绘制将独立于父组件的绘制，<code>RepaintBoundary</code>会隔离其子节点和<code>CustomPaint</code>本身的绘制边界。</p> 
<p>示例如下：</p> 
<pre><code class="prism language-dart"><span class="token class-name">CustomPaint</span><span class="token punctuation">(</span>
  size<span class="token punctuation">:</span> <span class="token class-name">Size</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//指定画布大小</span>
  painter<span class="token punctuation">:</span> <span class="token class-name">MyPainter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  child<span class="token punctuation">:</span> <span class="token class-name">RepaintBoundary</span><span class="token punctuation">(</span>
  		child<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  	<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">)</span>
</code></pre> 
<p><strong>2. CustomPainter 与 Canvas</strong></p> 
<p><code>CustomPainter</code>是一个抽象类，我们自定义的画笔需要实现<code>CustomPainter</code>，<code>CustomPainter</code> 中定义了一个抽象方法 <code>paint</code>：</p> 
<pre><code class="prism language-dart"><span class="token keyword">void</span> <span class="token function">paint</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> <span class="token class-name">Size</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>paint</code>有两个参数:</p> 
<ul><li><code>canvas</code>：一个画布，包括各种绘制方法</li><li><code>size</code>：当前绘制区域大小。</li></ul> 
<p>下面是 <code>Canvas</code> 中常用的方法：</p> 
<table><thead><tr><th>API名称</th><th>功能</th></tr></thead><tbody><tr><td><strong>drawLine</strong></td><td><strong>画线</strong></td></tr><tr><td><strong>drawPoint</strong></td><td><strong>画点</strong></td></tr><tr><td><strong>drawPath</strong></td><td><strong>画路径</strong></td></tr><tr><td><strong>drawImage</strong></td><td><strong>画图像</strong></td></tr><tr><td><strong>drawRect</strong></td><td><strong>画矩形</strong></td></tr><tr><td><strong>drawCircle</strong></td><td><strong>画圆</strong></td></tr><tr><td><strong>drawOval</strong></td><td><strong>画椭圆</strong></td></tr><tr><td><strong>drawArc</strong></td><td><strong>画圆弧</strong></td></tr></tbody></table> 
<p><strong>3. 画笔Paint</strong></p> 
<p>现在画布有了，我们最后还缺一个画笔，Flutter提供了<code>Paint</code>类来实现画笔。在<code>Paint</code>中，我们可以配置画笔的各种属性如粗细、颜色、样式等。如：</p> 
<pre><code class="prism language-dart"><span class="token keyword">var</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//创建一个画笔并配置其属性</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span>isAntiAlias <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">//是否抗锯齿</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>fill <span class="token comment">//画笔样式：填充</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span>color<span class="token operator">=</span><span class="token class-name">Color</span><span class="token punctuation">(</span><span class="token number">0x77cdb175</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//画笔颜色</span>
</code></pre> 
<p>更多的配置属性可以参考<code>Paint</code>类定义。</p> 
<h4><a id="_457"></a>实例：五子棋/盘</h4> 
<p><strong>1. 绘制棋盘、棋子</strong></p> 
<p>下面我们通过一个五子棋游戏中棋盘和棋子的绘制来演示自绘UI的过程，首先我们看一下我们的目标效果，如图所示：<br> <img src="https://images2.imgbox.com/c2/c5/lA738RgL_o.png" alt="在这里插入图片描述" width="300"><br> 代码：</p> 
<pre><code class="prism language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/material.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'dart:math'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">CustomPaintRoute</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">CustomPaintRoute</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>
      child<span class="token punctuation">:</span> <span class="token class-name">CustomPaint</span><span class="token punctuation">(</span>
        size<span class="token punctuation">:</span> <span class="token class-name">Size</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//指定画布大小</span>
        painter<span class="token punctuation">:</span> <span class="token class-name">MyPainter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MyPainter</span> <span class="token keyword">extends</span> <span class="token class-name">CustomPainter</span> <span class="token punctuation">{<!-- --></span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">paint</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> <span class="token class-name">Size</span> size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'paint'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> rect <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">.</span>zero <span class="token operator">&amp;</span> size<span class="token punctuation">;</span>
    <span class="token comment">//画棋盘</span>
    <span class="token function">drawChessboard</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//画棋子</span>
    <span class="token function">drawPieces</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 返回false, 后面介绍</span>
  <span class="token metadata function">@override</span>
  bool <span class="token function">shouldRepaint</span><span class="token punctuation">(</span><span class="token class-name">CustomPainter</span> oldDelegate<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们先实现棋盘绘制：</p> 
<pre><code class="prism language-dart"><span class="token keyword">void</span> <span class="token function">drawChessboard</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> <span class="token class-name">Rect</span> rect<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//棋盘背景</span>
  <span class="token keyword">var</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span>isAntiAlias <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>fill <span class="token comment">//填充</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token class-name">Color</span><span class="token punctuation">(</span><span class="token number">0xFFDCC48C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span><span class="token function">drawRect</span><span class="token punctuation">(</span>rect<span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//画棋盘网格</span>
  paint
    <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke <span class="token comment">//线</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>black38
    <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>

  <span class="token comment">//画横线</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">15</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    double dy <span class="token operator">=</span> rect<span class="token punctuation">.</span>top <span class="token operator">+</span> rect<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">15</span> <span class="token operator">*</span> i<span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">drawLine</span><span class="token punctuation">(</span><span class="token class-name">Offset</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span>left<span class="token punctuation">,</span> dy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span>right<span class="token punctuation">,</span> dy<span class="token punctuation">)</span><span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">15</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    double dx <span class="token operator">=</span> rect<span class="token punctuation">.</span>left <span class="token operator">+</span> rect<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">15</span> <span class="token operator">*</span> i<span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">drawLine</span><span class="token punctuation">(</span><span class="token class-name">Offset</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> rect<span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> rect<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>再实现棋子绘制：</p> 
<pre><code class="prism language-dart"><span class="token comment">//画棋子</span>
<span class="token keyword">void</span> <span class="token function">drawPieces</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> <span class="token class-name">Rect</span> rect<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  double eWidth <span class="token operator">=</span> rect<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">15</span><span class="token punctuation">;</span>
  double eHeight <span class="token operator">=</span> rect<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">15</span><span class="token punctuation">;</span>
  <span class="token comment">//画一个黑子</span>
  <span class="token keyword">var</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>fill
    <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>black<span class="token punctuation">;</span>
  <span class="token comment">//画一个黑子</span>
  canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>
    <span class="token class-name">Offset</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span>center<span class="token punctuation">.</span>dx <span class="token operator">-</span> eWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> rect<span class="token punctuation">.</span>center<span class="token punctuation">.</span>dy <span class="token operator">-</span> eHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">min</span><span class="token punctuation">(</span>eWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> eHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span>
    paint<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//画一个白子</span>
  paint<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>
    <span class="token class-name">Offset</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span>center<span class="token punctuation">.</span>dx <span class="token operator">+</span> eWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> rect<span class="token punctuation">.</span>center<span class="token punctuation">.</span>dy <span class="token operator">-</span> eHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">min</span><span class="token punctuation">(</span>eWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> eHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span>
    paint<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>2. 绘制性能</strong></p> 
<p>绘制是比较昂贵的操作，所以我们在实现自绘控件时应该考虑到性能开销，下面是两条关于性能优化的建议：</p> 
<ol><li> <p>尽可能的利用好 <strong><code>shouldRepaint</code></strong> 返回值；在UI树重新<code>build</code>时，控件在绘制前都会先调用该方法以确定是否有必要重绘；</p> <p>假如我们绘制的UI不依赖外部状态，即外部状态改变不会影响我们的UI外观，那么就应该返回<code>false</code>；如果绘制依赖外部状态，那么我们就应该在<code>shouldRepaint</code>中判断依赖的状态是否改变，如果已改变则应返回<code>true</code>来重绘，反之则应返回<code>false</code>不需要重绘。</p> </li><li> <p>绘制尽可能多的<strong>分层</strong>；</p> <p>在上面五子棋的示例中，我们将棋盘和棋子的绘制放在了一起，这样会有一个问题：由于棋盘始终是不变的，用户每次落子时变的只是棋子，但是如果按照上面的代码来实现，每次绘制棋子时都要重新绘制一次棋盘，这是没必要的。优化的方法就是将棋盘单独抽为一个组件，并设置其<code>shouldRepaint</code>回调值为<code>false</code>，然后将棋盘组件作为背景。然后将棋子的绘制放到另一个组件中，这样每次落子时只需要绘制棋子。</p> </li></ol> 
<p><strong>3. 防止意外重绘</strong></p> 
<p>我们在上例的基础上添加一个 <code>ElevatedButton</code>，点击后什么也不做：</p> 
<pre><code class="prism language-dart"><span class="token keyword">class</span> <span class="token class-name">CustomPaintRoute</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">CustomPaintRoute</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>
      child<span class="token punctuation">:</span> <span class="token class-name">Column</span><span class="token punctuation">(</span>
        mainAxisSize<span class="token punctuation">:</span> <span class="token class-name">MainAxisSize</span><span class="token punctuation">.</span>min<span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token class-name">CustomPaint</span><span class="token punctuation">(</span>
            size<span class="token punctuation">:</span> <span class="token class-name">Size</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//指定画布大小</span>
            painter<span class="token punctuation">:</span> <span class="token class-name">MyPainter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token comment">// 添加一个刷新button</span>
          <span class="token class-name">ElevatedButton</span><span class="token punctuation">(</span>onPressed<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> child<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"刷新"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行后如图所示：</p> 
<p><img src="https://images2.imgbox.com/5c/a2/CUCcarKv_o.png" alt="在这里插入图片描述" width="350"><br> 运行后我们点击“刷新”按钮，发现日志面板输出了很多 “<code>paint</code>”，也就是说在点击按钮的时候发生了多次重绘。奇怪，<code>shouldRepaint</code> 我们返回的是<code>false</code>，并且点击刷新按钮也不会触发页面重新构建，那是什么导致的重绘呢？ 刷新按钮的画布和<code>CustomPaint</code>的画布是同一个，刷新按钮点击时会执行一个水波动画，水波动画执行过程中画布会不停的刷新，所以就导致了<code>CustomPaint</code> 不停的重绘。要解决这个问题的方案很简单，给刷新按钮 或 <code>CustomPaint</code> 任意一个添加一个 <code>RepaintBoundary</code> 父组件即可，现在可以先简单认为这样做可以生成一个新的画布:</p> 
<pre><code class="prism language-dart"><span class="token class-name">RepaintBoundary</span><span class="token punctuation">(</span>
  child<span class="token punctuation">:</span> <span class="token class-name">CustomPaint</span><span class="token punctuation">(</span>
    size<span class="token punctuation">:</span> <span class="token class-name">Size</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//指定画布大小</span>
    painter<span class="token punctuation">:</span> <span class="token class-name">MyPainter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token comment">// 或者给刷新按钮添加RepaintBoundary</span>
<span class="token comment">// RepaintBoundary(child: ElevatedButton(onPressed: () {}, child: Text("刷新")))</span>
</code></pre> 
<h4><a id="_611"></a>自绘实例：圆形背景渐变进度条</h4> 
<p>下面我们实现一个圆形背景渐变进度条，它支持：</p> 
<ol><li>支持多种背景渐变色。</li><li>任意弧度；进度条可以不是整圆。</li><li>可以自定义粗细、两端是否圆角等样式。</li></ol> 
<p>可以发现要实现这样的一个进度条是无法通过现有组件组合而成的，所以我们通过自绘方式实现，代码如下：</p> 
<pre><code class="prism language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'dart:math'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/material.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">GradientCircularProgressIndicator</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">GradientCircularProgressIndicator</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
    required <span class="token keyword">this</span><span class="token punctuation">.</span>radius<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stops<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>strokeCapRound <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token class-name">Color</span><span class="token punctuation">(</span><span class="token number">0xFFEEEEEE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>totalAngle <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> pi<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">///粗细</span>
  <span class="token keyword">final</span> double strokeWidth<span class="token punctuation">;</span>

  <span class="token comment">/// 圆的半径</span>
  <span class="token keyword">final</span> double radius<span class="token punctuation">;</span>

  <span class="token comment">///两端是否为圆角</span>
  <span class="token keyword">final</span> bool strokeCapRound<span class="token punctuation">;</span>

  <span class="token comment">/// 当前进度，取值范围 [0.0-1.0]</span>
  <span class="token keyword">final</span> double<span class="token operator">?</span> value<span class="token punctuation">;</span>

  <span class="token comment">/// 进度条背景色</span>
  <span class="token keyword">final</span> <span class="token class-name">Color</span> backgroundColor<span class="token punctuation">;</span>

  <span class="token comment">/// 进度条的总弧度，2*PI为整圆，小于2*PI则不是整圆</span>
  <span class="token keyword">final</span> double totalAngle<span class="token punctuation">;</span>

  <span class="token comment">/// 渐变色数组</span>
  <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Color</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> colors<span class="token punctuation">;</span>

  <span class="token comment">/// 渐变色的终止点，对应colors属性</span>
  <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>double<span class="token punctuation">&gt;</span></span><span class="token operator">?</span> stops<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    double _offset <span class="token operator">=</span> <span class="token number">.0</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果两端为圆角，则需要对起始位置进行调整，否则圆角部分会偏离起始位置</span>
    <span class="token comment">// 下面调整的角度的计算公式是通过数学几何知识得出，读者有兴趣可以研究一下为什么是这样</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strokeCapRound <span class="token operator">&amp;&amp;</span> totalAngle <span class="token operator">!=</span> <span class="token number">2</span> <span class="token operator">*</span> pi<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      _offset <span class="token operator">=</span> <span class="token function">asin</span><span class="token punctuation">(</span>strokeWidth <span class="token operator">/</span> <span class="token punctuation">(</span>radius <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> strokeWidth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> _colors <span class="token operator">=</span> colors<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_colors <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Color</span> color <span class="token operator">=</span> <span class="token class-name">Theme</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>colorScheme<span class="token punctuation">.</span>secondary<span class="token punctuation">;</span>
      _colors <span class="token operator">=</span> <span class="token punctuation">[</span>color<span class="token punctuation">,</span> color<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Transform</span><span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>
      angle<span class="token punctuation">:</span> <span class="token operator">-</span>pi <span class="token operator">/</span> <span class="token number">2.0</span> <span class="token operator">-</span> _offset<span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token class-name">CustomPaint</span><span class="token punctuation">(</span>
          size<span class="token punctuation">:</span> <span class="token class-name">Size</span><span class="token punctuation">.</span><span class="token function">fromRadius</span><span class="token punctuation">(</span>radius<span class="token punctuation">)</span><span class="token punctuation">,</span>
          painter<span class="token punctuation">:</span> <span class="token function">_GradientCircularProgressPainter</span><span class="token punctuation">(</span>
            strokeWidth<span class="token punctuation">:</span> strokeWidth<span class="token punctuation">,</span>
            strokeCapRound<span class="token punctuation">:</span> strokeCapRound<span class="token punctuation">,</span>
            backgroundColor<span class="token punctuation">:</span> backgroundColor<span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> value<span class="token punctuation">,</span>
            total<span class="token punctuation">:</span> totalAngle<span class="token punctuation">,</span>
            radius<span class="token punctuation">:</span> radius<span class="token punctuation">,</span>
            colors<span class="token punctuation">:</span> _colors<span class="token punctuation">,</span>
          <span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//实现画笔</span>
<span class="token keyword">class</span> _GradientCircularProgressPainter <span class="token keyword">extends</span> <span class="token class-name">CustomPainter</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token function">_GradientCircularProgressPainter</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>strokeCapRound <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token class-name">Color</span><span class="token punctuation">(</span><span class="token number">0xFFEEEEEE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>radius<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>total <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> pi<span class="token punctuation">,</span>
    required <span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stops<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fullColor<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> double strokeWidth<span class="token punctuation">;</span>
  <span class="token keyword">final</span> bool strokeCapRound<span class="token punctuation">;</span>
  <span class="token keyword">final</span> double<span class="token operator">?</span> value<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Color</span> backgroundColor<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Color</span><span class="token punctuation">&gt;</span></span> colors<span class="token punctuation">;</span>
  <span class="token keyword">final</span> double total<span class="token punctuation">;</span>
  <span class="token keyword">final</span> double<span class="token operator">?</span> radius<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>double<span class="token punctuation">&gt;</span></span><span class="token operator">?</span> stops<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Color</span><span class="token operator">?</span> fullColor<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">paint</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> <span class="token class-name">Size</span> size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>radius <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      size <span class="token operator">=</span> <span class="token class-name">Size</span><span class="token punctuation">.</span><span class="token function">fromRadius</span><span class="token punctuation">(</span>radius<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    double _offset <span class="token operator">=</span> strokeWidth <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    double _value <span class="token operator">=</span> <span class="token punctuation">(</span>value <span class="token operator">?</span><span class="token operator">?</span> <span class="token number">.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将_value控制在指定区间 大于最大值取最大值小于最小值取最小值</span>
    _value <span class="token operator">=</span> _value<span class="token punctuation">.</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> total<span class="token punctuation">;</span>
    double _start <span class="token operator">=</span> <span class="token number">.0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>strokeCapRound<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      _start <span class="token operator">=</span> <span class="token function">asin</span><span class="token punctuation">(</span>strokeWidth<span class="token operator">/</span> <span class="token punctuation">(</span>size<span class="token punctuation">.</span>width <span class="token operator">-</span> strokeWidth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Rect</span> rect <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>_offset<span class="token punctuation">,</span> _offset<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Size</span><span class="token punctuation">(</span>
        size<span class="token punctuation">.</span>width <span class="token operator">-</span> strokeWidth<span class="token punctuation">,</span>
        size<span class="token punctuation">.</span>height <span class="token operator">-</span> strokeWidth
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeCap <span class="token operator">=</span> strokeCapRound <span class="token operator">?</span> <span class="token class-name">StrokeCap</span><span class="token punctuation">.</span>round <span class="token punctuation">:</span> <span class="token class-name">StrokeCap</span><span class="token punctuation">.</span>butt
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke
      <span class="token punctuation">.</span><span class="token punctuation">.</span>isAntiAlias <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> strokeWidth<span class="token punctuation">;</span>

    <span class="token comment">// 先画背景</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>backgroundColor <span class="token operator">!=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>transparent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      paint<span class="token punctuation">.</span>color <span class="token operator">=</span> backgroundColor<span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span><span class="token function">drawArc</span><span class="token punctuation">(</span>rect<span class="token punctuation">,</span> _start<span class="token punctuation">,</span> total<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 再画前景，应用渐变</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> fullColor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      paint<span class="token punctuation">.</span>color <span class="token operator">=</span> fullColor<span class="token operator">!</span><span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span><span class="token function">drawArc</span><span class="token punctuation">(</span>rect<span class="token punctuation">,</span> _start<span class="token punctuation">,</span> _value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_value <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// draw foreground arc and apply gradient</span>
      paint<span class="token punctuation">.</span>shader <span class="token operator">=</span> <span class="token class-name">SweepGradient</span><span class="token punctuation">(</span>
        startAngle<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
        endAngle<span class="token punctuation">:</span> _value<span class="token punctuation">,</span>
        colors<span class="token punctuation">:</span> colors<span class="token punctuation">,</span>
        stops<span class="token punctuation">:</span> stops<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createShader</span><span class="token punctuation">(</span>rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span><span class="token function">drawArc</span><span class="token punctuation">(</span>rect<span class="token punctuation">,</span> _start<span class="token punctuation">,</span> _value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  bool <span class="token function">shouldRepaint</span><span class="token punctuation">(</span>_GradientCircularProgressPainter old<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> old<span class="token punctuation">.</span>strokeWidth <span class="token operator">!=</span> strokeWidth <span class="token operator">||</span>
        old<span class="token punctuation">.</span>strokeCapRound <span class="token operator">!=</span> strokeCapRound <span class="token operator">||</span>
        old<span class="token punctuation">.</span>backgroundColor <span class="token operator">!=</span> backgroundColor <span class="token operator">||</span>
        old<span class="token punctuation">.</span>radius <span class="token operator">!=</span> radius <span class="token operator">||</span>
        old<span class="token punctuation">.</span>value <span class="token operator">!=</span> value <span class="token operator">||</span>
        old<span class="token punctuation">.</span>fullColor <span class="token operator">!=</span> fullColor <span class="token operator">||</span>
        old<span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> colors<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        old<span class="token punctuation">.</span>stops<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> stops<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下面我们来测试一下，为了尽可能多的展示<code>GradientCircularProgressIndicator</code>的不同外观和用途，这个示例代码会比较长，并且添加了动画。</p> 
<p>示例代码：</p> 
<pre><code class="prism language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'dart:math'</span></span><span class="token punctuation">;</span> 
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/material.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_app_3_7_7/util/gradient_circular_progress_indicator.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_app_3_7_7/util/turn_box.dart'</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">class</span> <span class="token class-name">GradientCircularProgressRoute</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">GradientCircularProgressRoute</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">GradientCircularProgressRouteState</span> <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">GradientCircularProgressRouteState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">GradientCircularProgressRouteState</span>
    <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GradientCircularProgressRoute</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">with</span> <span class="token class-name">TickerProviderStateMixin</span> <span class="token punctuation">{<!-- --></span>
  late <span class="token class-name">AnimationController</span> _animationController<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _animationController <span class="token operator">=</span>
        <span class="token class-name">AnimationController</span><span class="token punctuation">(</span>vsync<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span> duration<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bool isForward <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    _animationController<span class="token punctuation">.</span><span class="token function">addStatusListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>forward<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        isForward <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>completed <span class="token operator">||</span>
          status <span class="token operator">==</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>dismissed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isForward<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          _animationController<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          _animationController<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>reverse<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        isForward <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _animationController<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _animationController<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">Scaffold</span><span class="token punctuation">(</span>
      appBar<span class="token punctuation">:</span> <span class="token class-name">AppBar</span><span class="token punctuation">(</span>
        title<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"GradientCircularProgress"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      body<span class="token punctuation">:</span> <span class="token class-name">SingleChildScrollView</span><span class="token punctuation">(</span>
        child<span class="token punctuation">:</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>
          child<span class="token punctuation">:</span> <span class="token class-name">Column</span><span class="token punctuation">(</span>
            crossAxisAlignment<span class="token punctuation">:</span> <span class="token class-name">CrossAxisAlignment</span><span class="token punctuation">.</span>center<span class="token punctuation">,</span>
            children<span class="token punctuation">:</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Widget</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>
              <span class="token class-name">AnimatedBuilder</span><span class="token punctuation">(</span>
                animation<span class="token punctuation">:</span> _animationController<span class="token punctuation">,</span>
                builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Widget</span><span class="token operator">?</span> child<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token keyword">return</span> <span class="token class-name">Padding</span><span class="token punctuation">(</span>
                    padding<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">symmetric</span><span class="token punctuation">(</span>vertical<span class="token punctuation">:</span> <span class="token number">16.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    child<span class="token punctuation">:</span> <span class="token class-name">Column</span><span class="token punctuation">(</span>
                      children<span class="token punctuation">:</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Widget</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>
                        <span class="token class-name">Wrap</span><span class="token punctuation">(</span>
                          spacing<span class="token punctuation">:</span> <span class="token number">10.0</span><span class="token punctuation">,</span>
                          runSpacing<span class="token punctuation">:</span> <span class="token number">16.0</span><span class="token punctuation">,</span>
                          children<span class="token punctuation">:</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Widget</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>
                            <span class="token class-name">GradientCircularProgressIndicator</span><span class="token punctuation">(</span>
                              <span class="token comment">// No gradient</span>
                              colors<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">,</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">]</span><span class="token punctuation">,</span>
                              radius<span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token punctuation">,</span>
                              strokeWidth<span class="token punctuation">:</span> <span class="token number">3.0</span><span class="token punctuation">,</span>
                              value<span class="token punctuation">:</span> _animationController<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                            <span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">GradientCircularProgressIndicator</span><span class="token punctuation">(</span>
                              colors<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token class-name">Colors</span><span class="token punctuation">.</span>red<span class="token punctuation">,</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>orange<span class="token punctuation">]</span><span class="token punctuation">,</span>
                              radius<span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token punctuation">,</span>
                              strokeWidth<span class="token punctuation">:</span> <span class="token number">3.0</span><span class="token punctuation">,</span>
                              value<span class="token punctuation">:</span> _animationController<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                            <span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">GradientCircularProgressIndicator</span><span class="token punctuation">(</span>
                              colors<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token punctuation">[</span>
                                <span class="token class-name">Colors</span><span class="token punctuation">.</span>red<span class="token punctuation">,</span>
                                <span class="token class-name">Colors</span><span class="token punctuation">.</span>orange<span class="token punctuation">,</span>
                                <span class="token class-name">Colors</span><span class="token punctuation">.</span>red
                              <span class="token punctuation">]</span><span class="token punctuation">,</span>
                              radius<span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token punctuation">,</span>
                              strokeWidth<span class="token punctuation">:</span> <span class="token number">5.0</span><span class="token punctuation">,</span>
                              value<span class="token punctuation">:</span> _animationController<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                            <span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">GradientCircularProgressIndicator</span><span class="token punctuation">(</span>
                              colors<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token class-name">Colors</span><span class="token punctuation">.</span>teal<span class="token punctuation">,</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>cyan<span class="token punctuation">]</span><span class="token punctuation">,</span>
                              radius<span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token punctuation">,</span>
                              strokeWidth<span class="token punctuation">:</span> <span class="token number">5.0</span><span class="token punctuation">,</span>
                              strokeCapRound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                              value<span class="token punctuation">:</span> <span class="token class-name">CurvedAnimation</span><span class="token punctuation">(</span>
                                      parent<span class="token punctuation">:</span> _animationController<span class="token punctuation">,</span>
                                      curve<span class="token punctuation">:</span> <span class="token class-name">Curves</span><span class="token punctuation">.</span>decelerate<span class="token punctuation">)</span>
                                  <span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                            <span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">TurnBox</span><span class="token punctuation">(</span>
                              turns<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span>
                              child<span class="token punctuation">:</span> <span class="token class-name">GradientCircularProgressIndicator</span><span class="token punctuation">(</span>
                                  colors<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token punctuation">[</span>
                                    <span class="token class-name">Colors</span><span class="token punctuation">.</span>red<span class="token punctuation">,</span>
                                    <span class="token class-name">Colors</span><span class="token punctuation">.</span>orange<span class="token punctuation">,</span>
                                    <span class="token class-name">Colors</span><span class="token punctuation">.</span>red
                                  <span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  radius<span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token punctuation">,</span>
                                  strokeWidth<span class="token punctuation">:</span> <span class="token number">5.0</span><span class="token punctuation">,</span>
                                  strokeCapRound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                                  backgroundColor<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>red<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">,</span>
                                  totalAngle<span class="token punctuation">:</span> <span class="token number">1.5</span> <span class="token operator">*</span> pi<span class="token punctuation">,</span>
                                  value<span class="token punctuation">:</span> <span class="token class-name">CurvedAnimation</span><span class="token punctuation">(</span>
                                          parent<span class="token punctuation">:</span> _animationController<span class="token punctuation">,</span>
                                          curve<span class="token punctuation">:</span> <span class="token class-name">Curves</span><span class="token punctuation">.</span>ease<span class="token punctuation">)</span>
                                      <span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">RotatedBox</span><span class="token punctuation">(</span>
                              quarterTurns<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                              child<span class="token punctuation">:</span> <span class="token class-name">GradientCircularProgressIndicator</span><span class="token punctuation">(</span>
                                  colors<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                                    <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">[</span><span class="token number">700</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">,</span>
                                    <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token operator">!</span>
                                  <span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  radius<span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token punctuation">,</span>
                                  strokeWidth<span class="token punctuation">:</span> <span class="token number">3.0</span><span class="token punctuation">,</span>
                                  strokeCapRound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                                  backgroundColor<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>transparent<span class="token punctuation">,</span>
                                  value<span class="token punctuation">:</span> _animationController<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">GradientCircularProgressIndicator</span><span class="token punctuation">(</span>
                              colors<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                                <span class="token class-name">Colors</span><span class="token punctuation">.</span>red<span class="token punctuation">,</span>
                                <span class="token class-name">Colors</span><span class="token punctuation">.</span>amber<span class="token punctuation">,</span>
                                <span class="token class-name">Colors</span><span class="token punctuation">.</span>cyan<span class="token punctuation">,</span>
                                <span class="token class-name">Colors</span><span class="token punctuation">.</span>green<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">,</span>
                                <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">,</span>
                                <span class="token class-name">Colors</span><span class="token punctuation">.</span>red
                              <span class="token punctuation">]</span><span class="token punctuation">,</span>
                              radius<span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token punctuation">,</span>
                              strokeWidth<span class="token punctuation">:</span> <span class="token number">5.0</span><span class="token punctuation">,</span>
                              strokeCapRound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                              value<span class="token punctuation">:</span> _animationController<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                            <span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">GradientCircularProgressIndicator</span><span class="token punctuation">(</span>
                          colors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">[</span><span class="token number">700</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">,</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                          radius<span class="token punctuation">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
                          strokeWidth<span class="token punctuation">:</span> <span class="token number">20.0</span><span class="token punctuation">,</span>
                          value<span class="token punctuation">:</span> _animationController<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                        <span class="token punctuation">)</span><span class="token punctuation">,</span>

                        <span class="token class-name">Padding</span><span class="token punctuation">(</span>
                          padding<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">symmetric</span><span class="token punctuation">(</span>vertical<span class="token punctuation">:</span> <span class="token number">16.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          child<span class="token punctuation">:</span> <span class="token class-name">GradientCircularProgressIndicator</span><span class="token punctuation">(</span>
                            colors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">[</span><span class="token number">700</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">,</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            radius<span class="token punctuation">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
                            strokeWidth<span class="token punctuation">:</span> <span class="token number">20.0</span><span class="token punctuation">,</span>
                            value<span class="token punctuation">:</span> _animationController<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                            strokeCapRound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                          <span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token comment">//剪裁半圆</span>
                        <span class="token class-name">ClipRect</span><span class="token punctuation">(</span>
                          child<span class="token punctuation">:</span> <span class="token class-name">Align</span><span class="token punctuation">(</span>
                            alignment<span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">.</span>topCenter<span class="token punctuation">,</span>
                            heightFactor<span class="token punctuation">:</span> <span class="token number">.5</span><span class="token punctuation">,</span>
                            child<span class="token punctuation">:</span> <span class="token class-name">Padding</span><span class="token punctuation">(</span>
                              padding<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">only</span><span class="token punctuation">(</span>bottom<span class="token punctuation">:</span> <span class="token number">8.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              child<span class="token punctuation">:</span> <span class="token class-name">SizedBox</span><span class="token punctuation">(</span>
                                <span class="token comment">//width: 100.0,</span>
                                child<span class="token punctuation">:</span> <span class="token class-name">TurnBox</span><span class="token punctuation">(</span>
                                  turns<span class="token punctuation">:</span> <span class="token number">.75</span><span class="token punctuation">,</span>
                                  child<span class="token punctuation">:</span> <span class="token class-name">GradientCircularProgressIndicator</span><span class="token punctuation">(</span>
                                    colors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Colors</span><span class="token punctuation">.</span>teal<span class="token punctuation">,</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>cyan<span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                    radius<span class="token punctuation">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
                                    strokeWidth<span class="token punctuation">:</span> <span class="token number">8.0</span><span class="token punctuation">,</span>
                                    value<span class="token punctuation">:</span> _animationController<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                                    totalAngle<span class="token punctuation">:</span> pi<span class="token punctuation">,</span>
                                    strokeCapRound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                                  <span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">SizedBox</span><span class="token punctuation">(</span>
                          height<span class="token punctuation">:</span> <span class="token number">104.0</span><span class="token punctuation">,</span>
                          width<span class="token punctuation">:</span> <span class="token number">200.0</span><span class="token punctuation">,</span>
                          child<span class="token punctuation">:</span> <span class="token class-name">Stack</span><span class="token punctuation">(</span>
                            alignment<span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">.</span>center<span class="token punctuation">,</span>
                            children<span class="token punctuation">:</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Widget</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>
                              <span class="token class-name">Positioned</span><span class="token punctuation">(</span>
                                height<span class="token punctuation">:</span> <span class="token number">200.0</span><span class="token punctuation">,</span>
                                top<span class="token punctuation">:</span> <span class="token number">.0</span><span class="token punctuation">,</span>
                                child<span class="token punctuation">:</span> <span class="token class-name">TurnBox</span><span class="token punctuation">(</span>
                                  turns<span class="token punctuation">:</span> <span class="token number">.75</span><span class="token punctuation">,</span>
                                  child<span class="token punctuation">:</span> <span class="token class-name">GradientCircularProgressIndicator</span><span class="token punctuation">(</span>
                                    colors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Colors</span><span class="token punctuation">.</span>teal<span class="token punctuation">,</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>cyan<span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                    radius<span class="token punctuation">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
                                    strokeWidth<span class="token punctuation">:</span> <span class="token number">8.0</span><span class="token punctuation">,</span>
                                    value<span class="token punctuation">:</span> _animationController<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                                    totalAngle<span class="token punctuation">:</span> pi<span class="token punctuation">,</span>
                                    strokeCapRound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                                  <span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token class-name">Padding</span><span class="token punctuation">(</span>
                                padding<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">only</span><span class="token punctuation">(</span>top<span class="token punctuation">:</span> <span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                child<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>
                                  <span class="token string-literal"><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression"><span class="token punctuation">(</span>_animationController<span class="token punctuation">.</span>value <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">%"</span></span><span class="token punctuation">,</span>
                                  style<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
                                    fontSize<span class="token punctuation">:</span> <span class="token number">25.0</span><span class="token punctuation">,</span>
                                    color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>blueGrey<span class="token punctuation">,</span>
                                  <span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token punctuation">)</span>
                            <span class="token punctuation">]</span><span class="token punctuation">,</span>
                          <span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span><span class="token punctuation">,</span>
                      <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行效果：</p> 
<p><img src="https://images2.imgbox.com/f4/74/szjksXl1_o.gif" alt="在这里插入图片描述" width="350"></p> 
<h4><a id="CustomCheckbox_1024"></a>自绘组件：CustomCheckbox</h4> 
<p>Flutter 自带的 <code>Checkbox</code> 组件是不能自由指定大小的，下面我们通过自定义一个可以自由指定大小的 <code>CustomCheckbox</code> 组件来演示如何通过定义 <code>RenderObject</code> 的方式来自定义组件（而不是通过组合）。我们要实现的 <code>CustomCheckbox</code> 组件效果如图所示：</p> 
<p><img src="https://images2.imgbox.com/cd/a5/hkIiY8hb_o.gif" alt="在这里插入图片描述" width="350"></p> 
<ol><li>有选中和未选中两种状态。</li><li>状态切换时要执行动画。</li><li>可以自定义外观。</li></ol> 
<p><code>CustomCheckbox</code> 定义如下：</p> 
<pre><code class="prism language-dart"><span class="token keyword">class</span> <span class="token class-name">CustomCheckbox</span> <span class="token keyword">extends</span> <span class="token class-name">LeafRenderObjectWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">CustomCheckbox</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>strokeColor <span class="token operator">=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fillColor <span class="token operator">=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>radius <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onChanged<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> double strokeWidth<span class="token punctuation">;</span> <span class="token comment">// “勾”的线条宽度</span>
  <span class="token keyword">final</span> <span class="token class-name">Color</span> strokeColor<span class="token punctuation">;</span> <span class="token comment">// “勾”的线条宽度</span>
  <span class="token keyword">final</span> <span class="token class-name">Color</span><span class="token operator">?</span> fillColor<span class="token punctuation">;</span> <span class="token comment">// 背景填充颜色</span>
  <span class="token keyword">final</span> bool value<span class="token punctuation">;</span> <span class="token comment">//选中状态</span>
  <span class="token keyword">final</span> double radius<span class="token punctuation">;</span> <span class="token comment">// 圆角</span>
  <span class="token keyword">final</span> <span class="token class-name">ValueChanged</span><span class="token generics"><span class="token punctuation">&lt;</span>bool<span class="token punctuation">&gt;</span></span><span class="token operator">?</span> onChanged<span class="token punctuation">;</span> <span class="token comment">// 选中状态发生改变后的回调</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">RenderObject</span> <span class="token function">createRenderObject</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">RenderCustomCheckbox</span><span class="token punctuation">(</span>
      strokeWidth<span class="token punctuation">,</span>
      strokeColor<span class="token punctuation">,</span>
      fillColor <span class="token operator">?</span><span class="token operator">?</span> <span class="token class-name">Theme</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>primaryColor<span class="token punctuation">,</span> <span class="token comment">// 填充颜色如果未指定则使用主题色</span>
      value<span class="token punctuation">,</span>
      radius<span class="token punctuation">,</span>
      onChanged<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">updateRenderObject</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">RenderCustomCheckbox</span> renderObject<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>renderObject<span class="token punctuation">.</span>value <span class="token operator">!=</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 选中状态发生了变化，则需要调整动画状态以执行过渡动画</span>
      <span class="token comment">// 当从未选中切换为选中状态时，执行正向动画；当从选中状态切换为未选中状态时执行反向动画。</span>
      renderObject<span class="token punctuation">.</span>animationStatus <span class="token operator">=</span>
          value <span class="token operator">?</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>forward <span class="token punctuation">:</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>reverse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    renderObject
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> strokeWidth
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeColor <span class="token operator">=</span> strokeColor
      <span class="token punctuation">.</span><span class="token punctuation">.</span>fillColor <span class="token operator">=</span> fillColor <span class="token operator">?</span><span class="token operator">?</span> <span class="token class-name">Theme</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>primaryColor
      <span class="token punctuation">.</span><span class="token punctuation">.</span>radius <span class="token operator">=</span> radius
      <span class="token punctuation">.</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
      <span class="token punctuation">.</span><span class="token punctuation">.</span>onChanged <span class="token operator">=</span> onChanged<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面代码中唯一需要注意的就是 <code>updateRenderObject</code> 方法中当选中状态发生变化时，我们要更新<code>RenderObject</code>中的动画状态，具体逻辑是：当从未选中切换为选中状态时，执行正向动画；当从选中状态切换为未选中状态时执行反向动画。</p> 
<p>接下来需要实现 <code>RenderCustomCheckbox</code>：</p> 
<pre><code class="prism language-dart"><span class="token keyword">class</span> <span class="token class-name">RenderCustomCheckbox</span> <span class="token keyword">extends</span> <span class="token class-name">RenderBox</span> <span class="token punctuation">{<!-- --></span>
  bool value<span class="token punctuation">;</span>
  int pointerId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  double strokeWidth<span class="token punctuation">;</span>
  <span class="token class-name">Color</span> strokeColor<span class="token punctuation">;</span>
  <span class="token class-name">Color</span> fillColor<span class="token punctuation">;</span>
  double radius<span class="token punctuation">;</span>
  <span class="token class-name">ValueChanged</span><span class="token generics"><span class="token punctuation">&lt;</span>bool<span class="token punctuation">&gt;</span></span><span class="token operator">?</span> onChanged<span class="token punctuation">;</span>

  <span class="token comment">// 下面的属性用于调度动画</span>
  double progress <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 动画当前进度</span>
  int<span class="token operator">?</span> _lastTimeStamp<span class="token punctuation">;</span><span class="token comment">//上一次绘制的时间</span>
  <span class="token comment">//动画执行时长</span>
  <span class="token class-name">Duration</span> <span class="token keyword">get</span> duration <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">const</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>milliseconds<span class="token punctuation">:</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//动画当前状态</span>
  <span class="token class-name">AnimationStatus</span> _animationStatus <span class="token operator">=</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>completed<span class="token punctuation">;</span>
  <span class="token keyword">set</span> <span class="token function">animationStatus</span><span class="token punctuation">(</span><span class="token class-name">AnimationStatus</span> v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_animationStatus <span class="token operator">!=</span> v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">markNeedsPaint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _animationStatus <span class="token operator">=</span> v<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//背景动画时长占比（背景动画要在前40%的时间内执行完毕，之后执行打勾动画）</span>
  <span class="token keyword">final</span> double bgAnimationInterval <span class="token operator">=</span> <span class="token number">.4</span><span class="token punctuation">;</span>

  <span class="token class-name">RenderCustomCheckbox</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>strokeWidth<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>strokeColor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fillColor<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>radius<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onChanged<span class="token punctuation">)</span>
      <span class="token punctuation">:</span> progress <span class="token operator">=</span> value <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">performLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>  <span class="token comment">//布局</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">paint</span><span class="token punctuation">(</span><span class="token class-name">PaintingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Offset</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Rect</span> rect <span class="token operator">=</span> offset <span class="token operator">&amp;</span> size<span class="token punctuation">;</span>
    <span class="token comment">// 将绘制分为背景（矩形）和 前景（打勾）两部分，先画背景，再绘制'勾'</span>
    <span class="token function">_drawBackground</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_drawCheckMark</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调度动画</span>
    <span class="token function">_scheduleAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 画背景</span>
  <span class="token keyword">void</span> <span class="token function">_drawBackground</span><span class="token punctuation">(</span><span class="token class-name">PaintingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Rect</span> rect<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  <span class="token comment">//画 "勾"</span>
  <span class="token keyword">void</span> <span class="token function">_drawCheckMark</span><span class="token punctuation">(</span><span class="token class-name">PaintingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Rect</span> rect<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
  <span class="token comment">//调度动画</span>
  <span class="token keyword">void</span> <span class="token function">_scheduleAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">//响应点击事件</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>1. 实现布局算法</strong></p> 
<p>为了使用户可以自定义宽高，我们的布局策略是：如果父组件指定了固定宽高，则使用父组件指定的，否则宽高默认置为 <code>25</code>：</p> 
<pre><code class="prism language-dart">  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">performLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果父组件指定了固定宽高，则使用父组件指定的，否则宽高默认置为 25</span>
    size <span class="token operator">=</span> constraints<span class="token punctuation">.</span><span class="token function">constrain</span><span class="token punctuation">(</span>
      constraints<span class="token punctuation">.</span>isTight <span class="token operator">?</span> <span class="token class-name">Size</span><span class="token punctuation">.</span>infinite <span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Size</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><strong>2. 绘制 CustomCheckbox</strong></p> 
<p>接下来重点就是绘制 <code>CustomCheckbox</code> 了，为了清晰起见，我们将绘制分为背景（矩形）和 前景（打勾）两部分，先画背景，再绘制’勾’，这里需要注意两点：</p> 
<ol><li>我们绘制的是动画执行过程中的一帧，所以需要通过动画执行的进度（<code>progress</code>）来计算每一帧要绘制的样子。</li><li>当 <code>CustomCheckbox</code> 从未选中变为选中时，我们执行正向动画，<code>progress</code> 的值会从 <code>0</code> 逐渐变为 <code>1</code>，因为 <code>CustomCheckbox</code> 的背景和前景（‘勾’）的颜色要有对比，所以我们在背景绘制完之后再绘制前景。因此，我们将动画分割为两端，前 <code>40%</code> 的时间画背景，后 60%的时间画’勾’。</li></ol> 
<p><strong>1）绘制背景</strong></p> 
<p><img src="https://images2.imgbox.com/e8/6a/l0UBPhlu_o.png" alt="在这里插入图片描述" width="150"></p> 
<p>结合上图，我们先看看如何绘制背景：</p> 
<ol><li>当状态切换为选中状态时，将矩形逐渐从边缘向中心收缩填充，直到填满 <code>Checkbox</code> 区域。</li><li>当状态切换为未选中状态时，填充从中间逐渐向边缘消散，直到只剩一个边框为止。</li></ol> 
<p>实现的思路是先将整个背景矩形区域全部填充满蓝色，然后在上面绘制一个白色背景的矩形，根据动画进度来动态改变白色矩形区域大小即可。幸运的是 <code>Canvas</code> API 中已经帮助我们实现了我们期望的功能，<code>drawDRRect</code> 可以指定内外两个矩形，然后画出不相交的部分，并且可以指定圆角，下面是具体实现：</p> 
<pre><code class="prism language-dart"><span class="token keyword">void</span> <span class="token function">_drawBackground</span><span class="token punctuation">(</span><span class="token class-name">PaintingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Rect</span> rect<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">Color</span> color <span class="token operator">=</span> value <span class="token operator">?</span> fillColor <span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>grey<span class="token punctuation">;</span>
  <span class="token keyword">var</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span>isAntiAlias <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>fill <span class="token comment">//填充</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth
    <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>
  
  <span class="token comment">// 我们需要算出每一帧里面矩形的大小，为此我们可以直接根据矩形插值方法来确定里面矩形</span>
  <span class="token keyword">final</span> outer <span class="token operator">=</span> <span class="token class-name">RRect</span><span class="token punctuation">.</span><span class="token function">fromRectXY</span><span class="token punctuation">(</span>rect<span class="token punctuation">,</span> radius<span class="token punctuation">,</span> radius<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> rects <span class="token operator">=</span> <span class="token punctuation">[</span>
    rect<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span><span class="token operator">-</span>strokeWidth<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Rect</span><span class="token punctuation">.</span><span class="token function">fromCenter</span><span class="token punctuation">(</span>center<span class="token punctuation">:</span> rect<span class="token punctuation">.</span>center<span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 根据动画执行进度调整来确定里面矩形在每一帧的大小</span>
  <span class="token keyword">var</span> rectProgress <span class="token operator">=</span> <span class="token class-name">Rect</span><span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>
    rects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    rects<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 背景动画的执行时长是前 40% 的时间</span>
    <span class="token function">min</span><span class="token punctuation">(</span>progress<span class="token punctuation">,</span> bgAnimationInterval<span class="token punctuation">)</span> <span class="token operator">/</span> bgAnimationInterval<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> inner <span class="token operator">=</span> <span class="token class-name">RRect</span><span class="token punctuation">.</span><span class="token function">fromRectXY</span><span class="token punctuation">(</span>rectProgress<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 绘制</span>
  context<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">drawDRRect</span><span class="token punctuation">(</span>outer<span class="token punctuation">,</span> inner<span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>2）绘制前景</strong></p> 
<p>前景是一个"勾"，它有三个点的连线构成，为了简单起见，我们将起始点和中点拐点的位置根据 <code>Checkbox</code> 的大小算出固定的坐标，然后我们在每一帧中动态调整第三个点的位置就可以实现打勾动画：</p> 
<pre><code class="prism language-dart"><span class="token comment">//画 "勾"</span>
<span class="token keyword">void</span> <span class="token function">_drawCheckMark</span><span class="token punctuation">(</span><span class="token class-name">PaintingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Rect</span> rect<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 在画好背景后再画前景</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>progress <span class="token operator">&gt;</span> bgAnimationInterval<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">//确定中间拐点位置</span>
    <span class="token keyword">final</span> secondOffset <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>
      rect<span class="token punctuation">.</span>left <span class="token operator">+</span> rect<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2.5</span><span class="token punctuation">,</span>
      rect<span class="token punctuation">.</span>bottom <span class="token operator">-</span> rect<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 第三个点的位置</span>
    <span class="token keyword">final</span> lastOffset <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>
      rect<span class="token punctuation">.</span>right <span class="token operator">-</span> rect<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">6</span><span class="token punctuation">,</span>
      rect<span class="token punctuation">.</span>top <span class="token operator">+</span> rect<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 我们只对第三个点的位置做插值</span>
    <span class="token keyword">final</span> _lastOffset <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>
      secondOffset<span class="token punctuation">,</span>
      lastOffset<span class="token punctuation">,</span>
      <span class="token punctuation">(</span>progress <span class="token operator">-</span> bgAnimationInterval<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> bgAnimationInterval<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>

    <span class="token comment">// 将三个点连起来</span>
    <span class="token keyword">final</span> path <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span>left <span class="token operator">+</span> rect<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">7</span><span class="token punctuation">,</span> rect<span class="token punctuation">.</span>top <span class="token operator">+</span> rect<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>secondOffset<span class="token punctuation">.</span>dx<span class="token punctuation">,</span> secondOffset<span class="token punctuation">.</span>dy<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>_lastOffset<span class="token punctuation">.</span>dx<span class="token punctuation">,</span> _lastOffset<span class="token punctuation">.</span>dy<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>isAntiAlias <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke
      <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> strokeColor
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> strokeWidth<span class="token punctuation">;</span>

    context<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">drawPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> paint<span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>3. 实现动画</strong></p> 
<p>最后，我们需要让UI动起来，Flutter 的动画框架是依赖于 <code>StatefulWidget</code> 的，即当状态改变时显式或隐式的去调用 <code>setState</code> 触发更新。但是我们直接通过定义 <code>RenderObject</code> 的方式来实现的 <code>CustomCheckbox</code>，并不是基于 <code>StatefulWidget</code> ，那该怎么来调度动画呢？有两种办法：</p> 
<ol><li>将 <code>CustomCheckbox</code> 用一个 <code>StatefulWidget</code> 包装起来，这样就可以复用之前介绍的执行动画的方法。</li><li>自定义动画调度。</li></ol> 
<p>第一种方法相信已经很熟悉了，不再赘述，下面我们演示一下第二种方法，我们的思路是：<strong>在一帧绘制结束后判断动画是否结束，如果动画未结束，则将将当前组件标记为”需要重绘“，然后等待下一帧即可</strong>：</p> 
<pre><code class="prism language-dart"><span class="token keyword">void</span> <span class="token function">_scheduleAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_animationStatus <span class="token operator">!=</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>completed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 需要在Flutter 当前frame 结束之前再执行，因为不能在绘制过程中又将组件标记为需要重绘</span>
    <span class="token class-name">SchedulerBinding</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">addPostFrameCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Duration</span> timeStamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_lastTimeStamp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        double delta <span class="token operator">=</span> <span class="token punctuation">(</span>timeStamp<span class="token punctuation">.</span>inMilliseconds <span class="token operator">-</span> _lastTimeStamp<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token operator">/</span>
          duration<span class="token punctuation">.</span>inMilliseconds<span class="token punctuation">;</span>
        <span class="token comment">// 如果是反向动画，则 progress值要逐渐减小</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_animationStatus <span class="token operator">==</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>reverse<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          delta <span class="token operator">=</span> <span class="token operator">-</span>delta<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//更新动画进度</span>
        progress <span class="token operator">=</span> progress <span class="token operator">+</span> delta<span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>progress <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">||</span> progress <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">//动画执行结束</span>
          _animationStatus <span class="token operator">=</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>completed<span class="token punctuation">;</span>
          progress <span class="token operator">=</span> progress<span class="token punctuation">.</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
       <span class="token comment">//标记为需要重绘</span>
      <span class="token function">markNeedsPaint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _lastTimeStamp <span class="token operator">=</span> timeStamp<span class="token punctuation">.</span>inMilliseconds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    _lastTimeStamp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>4. 响应点击事件</strong></p> 
<p>根据之前事件处理相关的介绍，如果我们要让渲染对象能处理事件，则它必须能通过命中测试，之后才能在 <code>handleEvent</code> 方法中处理事件，所以我们需要添加如下代码：</p> 
<pre><code class="prism language-dart"><span class="token comment">// 必须置为true，确保能通过命中测试</span>
<span class="token metadata function">@override</span>
bool <span class="token function">hitTestSelf</span><span class="token punctuation">(</span><span class="token class-name">Offset</span> position<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token comment">// 只有通过命中测试，才会调用本方法，我们在手指抬起时触发事件即可</span>
<span class="token metadata function">@override</span>
<span class="token keyword">void</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span><span class="token class-name">PointerEvent</span> event<span class="token punctuation">,</span> <span class="token keyword">covariant</span> <span class="token class-name">BoxHitTestEntry</span> entry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>down<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    pointerId <span class="token operator">=</span> event<span class="token punctuation">.</span>pointer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pointerId <span class="token operator">==</span> event<span class="token punctuation">.</span>pointer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   	  <span class="token comment">// 判断手指抬起时是在组件范围内的话才触发onChange</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>size<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>localPosition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        onChanged<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">!</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>动画调度抽象 RenderObjectAnimationMixin</strong></p> 
<p>我们可以看到，在 <code>RenderObject</code> 中调度动画还是比较复杂的，为此我们抽象了一个 <code>RenderObjectAnimationMixin</code>，如果还有其他 <code>RenderObject</code> 中需要执行动画，可以直接复用。</p> 
<pre><code class="prism language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/scheduler.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/widgets.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">mixin</span> <span class="token class-name">RenderObjectAnimationMixin</span> <span class="token keyword">on</span> <span class="token class-name">RenderObject</span> <span class="token punctuation">{<!-- --></span>
  double _progress <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 动画当前进度</span>
  int<span class="token operator">?</span> _lastTimeStamp<span class="token punctuation">;</span> <span class="token comment">// 上一次绘制的时间</span>

  double <span class="token keyword">get</span> progress <span class="token operator">=</span><span class="token operator">&gt;</span> _progress<span class="token punctuation">;</span>

  <span class="token comment">// 动画执行时长，子类可以重写</span>
  <span class="token class-name">Duration</span> <span class="token keyword">get</span> duration <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">const</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>milliseconds<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 动画当前状态</span>
  <span class="token class-name">AnimationStatus</span> _animationStatus <span class="token operator">=</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>completed<span class="token punctuation">;</span>
  <span class="token comment">// 设置动画状态</span>
  <span class="token keyword">set</span> <span class="token function">animationStatus</span><span class="token punctuation">(</span><span class="token class-name">AnimationStatus</span> v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_animationStatus <span class="token operator">!=</span> v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">markNeedsPaint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _animationStatus <span class="token operator">=</span> v<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">progress</span><span class="token punctuation">(</span>double v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _progress <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">paint</span><span class="token punctuation">(</span><span class="token class-name">PaintingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Offset</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 调用子类绘制逻辑</span>
    <span class="token function">doPaint</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调度动画</span>
    <span class="token function">_scheduleAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 
 
  <span class="token keyword">void</span> <span class="token function">_scheduleAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//SchedulerBinding.instance.remo</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_animationStatus <span class="token operator">!=</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>completed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 需要在Flutter 当前frame 结束之前再执行，因为不能在绘制过程中又将组件标记为需要重绘</span>
      <span class="token class-name">SchedulerBinding</span><span class="token punctuation">.</span>instance<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">addPostFrameCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Duration</span> timeStamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_lastTimeStamp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          double delta <span class="token operator">=</span> <span class="token punctuation">(</span>timeStamp<span class="token punctuation">.</span>inMilliseconds <span class="token operator">-</span> _lastTimeStamp<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token operator">/</span> duration<span class="token punctuation">.</span>inMilliseconds<span class="token punctuation">;</span>
          <span class="token comment">//在特定情况下，可能在一帧中连续的往frameCallback中添加了多次，导致两次回调时间间隔为0，</span>
          <span class="token comment">//这种情况下应该继续请求重绘。</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>delta <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">markNeedsPaint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// 如果是反向动画，则 progress值要逐渐减小</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>_animationStatus <span class="token operator">==</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>reverse<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            delta <span class="token operator">=</span> <span class="token operator">-</span>delta<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// 更新动画进度</span>
          _progress <span class="token operator">=</span> _progress <span class="token operator">+</span> delta<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>_progress <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">||</span> _progress <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 动画执行结束</span>
            _animationStatus <span class="token operator">=</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>completed<span class="token punctuation">;</span>
            _progress <span class="token operator">=</span> _progress<span class="token punctuation">.</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 标记为需要重绘</span>
        <span class="token function">markNeedsPaint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _lastTimeStamp <span class="token operator">=</span> timeStamp<span class="token punctuation">.</span>inMilliseconds<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      _lastTimeStamp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 子类实现绘制逻辑的地方</span>
  <span class="token keyword">void</span> <span class="token function">doPaint</span><span class="token punctuation">(</span><span class="token class-name">PaintingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Offset</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>CustomCheckbox 的完整源码</strong></p> 
<p>最终 <code>CustomCheckbox</code> 的完整源码为：</p> 
<pre><code class="prism language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'dart:math'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/material.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/rendering.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter_app_3_7_7/util/render_object_animation_mixin.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">CustomCheckbox</span> <span class="token keyword">extends</span> <span class="token class-name">LeafRenderObjectWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">CustomCheckbox</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>strokeColor <span class="token operator">=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fillColor <span class="token operator">=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>radius <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onChanged<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> double strokeWidth<span class="token punctuation">;</span> <span class="token comment">// “勾”的线条宽度</span>
  <span class="token keyword">final</span> <span class="token class-name">Color</span> strokeColor<span class="token punctuation">;</span> <span class="token comment">// “勾”的线条宽度</span>
  <span class="token keyword">final</span> <span class="token class-name">Color</span><span class="token operator">?</span> fillColor<span class="token punctuation">;</span> <span class="token comment">// 背景填充颜色</span>
  <span class="token keyword">final</span> bool value<span class="token punctuation">;</span> <span class="token comment">//选中状态</span>
  <span class="token keyword">final</span> double radius<span class="token punctuation">;</span> <span class="token comment">// 圆角</span>
  <span class="token keyword">final</span> <span class="token class-name">ValueChanged</span><span class="token generics"><span class="token punctuation">&lt;</span>bool<span class="token punctuation">&gt;</span></span><span class="token operator">?</span> onChanged<span class="token punctuation">;</span> <span class="token comment">// 选中状态发生改变后的回调</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">RenderObject</span> <span class="token function">createRenderObject</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">RenderCustomCheckbox</span><span class="token punctuation">(</span>
      strokeWidth<span class="token punctuation">,</span>
      strokeColor<span class="token punctuation">,</span>
      fillColor <span class="token operator">?</span><span class="token operator">?</span> <span class="token class-name">Theme</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>primaryColor<span class="token punctuation">,</span> <span class="token comment">// 填充颜色如果未指定则使用主题色</span>
      value<span class="token punctuation">,</span>
      radius<span class="token punctuation">,</span>
      onChanged<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">updateRenderObject</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">RenderCustomCheckbox</span> renderObject<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>renderObject<span class="token punctuation">.</span>value <span class="token operator">!=</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 选中状态发生了变化，则需要调整动画状态以执行过渡动画</span>
      <span class="token comment">// 具体逻辑是：当从未选中切换为选中状态时，执行正向动画；当从选中状态切换为未选中状态时执行反向动画。</span>
      renderObject<span class="token punctuation">.</span>animationStatus <span class="token operator">=</span>
          value <span class="token operator">?</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>forward <span class="token punctuation">:</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>reverse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    renderObject
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> strokeWidth
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeColor <span class="token operator">=</span> strokeColor
      <span class="token punctuation">.</span><span class="token punctuation">.</span>fillColor <span class="token operator">=</span> fillColor <span class="token operator">?</span><span class="token operator">?</span> <span class="token class-name">Theme</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>primaryColor
      <span class="token punctuation">.</span><span class="token punctuation">.</span>radius <span class="token operator">=</span> radius
      <span class="token punctuation">.</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
      <span class="token punctuation">.</span><span class="token punctuation">.</span>onChanged <span class="token operator">=</span> onChanged<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 动画调度相关逻辑直接 with  RenderObjectAnimationMixin即可</span>
<span class="token keyword">class</span> <span class="token class-name">RenderCustomCheckbox</span> <span class="token keyword">extends</span> <span class="token class-name">RenderBox</span> <span class="token keyword">with</span> <span class="token class-name">RenderObjectAnimationMixin</span> <span class="token punctuation">{<!-- --></span>
  bool value<span class="token punctuation">;</span>
  int pointerId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  double strokeWidth<span class="token punctuation">;</span>
  <span class="token class-name">Color</span> strokeColor<span class="token punctuation">;</span>
  <span class="token class-name">Color</span> fillColor<span class="token punctuation">;</span>
  double radius<span class="token punctuation">;</span>
  <span class="token class-name">ValueChanged</span><span class="token generics"><span class="token punctuation">&lt;</span>bool<span class="token punctuation">&gt;</span></span><span class="token operator">?</span> onChanged<span class="token punctuation">;</span>

  <span class="token class-name">RenderCustomCheckbox</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>strokeWidth<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>strokeColor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fillColor<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>radius<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onChanged<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    progress <span class="token operator">=</span> value <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  bool <span class="token keyword">get</span> isRepaintBoundary <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token comment">//背景动画时长占比（背景动画要在前40%的时间内执行完毕，之后执行打勾动画）</span>
  <span class="token keyword">final</span> double bgAnimationInterval <span class="token operator">=</span> <span class="token number">.4</span><span class="token punctuation">;</span>

  <span class="token comment">/// 我们将绘制分为背景（矩形）和 前景（打勾）两部分，先画背景，再绘制'勾'，这里需要注意两点：</span>
  <span class="token comment">/// 1.我们绘制的是动画执行过程中的一帧，所以需要通过动画执行的进度（progress）来计算每一帧要绘制的样子。</span>
  <span class="token comment">/// 2.当 CustomCheckbox 从未选中变为选中时，我们执行正向动画，progress 的值会从 0 逐渐变为 1，</span>
  <span class="token comment">///   因为 CustomCheckbox 的背景和前景（'勾'）的颜色要有对比，所以我们在背景绘制完之后再绘制前景。</span>
  <span class="token comment">///   因此，我们将动画分割为两端，前 40% 的时间画背景，后 60%的时间画'勾'。</span>
  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">doPaint</span><span class="token punctuation">(</span><span class="token class-name">PaintingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Offset</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Rect</span> rect <span class="token operator">=</span> offset <span class="token operator">&amp;</span> size<span class="token punctuation">;</span>
    <span class="token comment">// 将绘制分为背景（矩形）和 前景（打勾）两部分，先画背景，再绘制'勾'</span>
    <span class="token function">_drawBackground</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_drawCheckMark</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 画背景</span>
  <span class="token comment">// 1.当状态切换为选中状态时，将矩形逐渐从边缘向中心收缩填充，直到填满 Checkbox 区域。</span>
  <span class="token comment">// 2.当状态切换为未选中状态时，填充从中间逐渐向边缘消散，直到只剩一个边框为止。 </span>
  <span class="token comment">// 实现的思路是先将整个背景矩形区域全部填充满蓝色，然后在上面绘制一个白色背景的矩形，</span>
  <span class="token comment">// 根据动画进度来动态改变白色矩形区域大小即可。 </span>
  <span class="token keyword">void</span> <span class="token function">_drawBackground</span><span class="token punctuation">(</span><span class="token class-name">PaintingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Rect</span> rect<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Color</span> color <span class="token operator">=</span> value <span class="token operator">?</span> fillColor <span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>grey<span class="token punctuation">;</span>
    <span class="token keyword">var</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>isAntiAlias <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>fill <span class="token comment">//填充</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth
      <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>

    <span class="token comment">// 我们对矩形做插值</span>
    <span class="token comment">// 我们需要算出每一帧里面矩形的大小，为此我们可以直接根据矩形插值方法来确定里面矩形</span>
    <span class="token keyword">final</span> outer <span class="token operator">=</span> <span class="token class-name">RRect</span><span class="token punctuation">.</span><span class="token function">fromRectXY</span><span class="token punctuation">(</span>rect<span class="token punctuation">,</span> radius<span class="token punctuation">,</span> radius<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> rects <span class="token operator">=</span> <span class="token punctuation">[</span>
      rect<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span><span class="token operator">-</span>strokeWidth<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token class-name">Rect</span><span class="token punctuation">.</span><span class="token function">fromCenter</span><span class="token punctuation">(</span>center<span class="token punctuation">:</span> rect<span class="token punctuation">.</span>center<span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据动画执行进度调整来确定里面矩形在每一帧的大小</span>
    <span class="token keyword">var</span> rectProgress <span class="token operator">=</span> <span class="token class-name">Rect</span><span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>
      rects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      rects<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token comment">// 背景动画的执行时长是前 40% 的时间</span>
      <span class="token function">min</span><span class="token punctuation">(</span>progress<span class="token punctuation">,</span> bgAnimationInterval<span class="token punctuation">)</span> <span class="token operator">/</span> bgAnimationInterval<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> inner <span class="token operator">=</span> <span class="token class-name">RRect</span><span class="token punctuation">.</span><span class="token function">fromRectXY</span><span class="token punctuation">(</span>rectProgress<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 绘制 drawDRRect 可以指定内外两个矩形，然后画出不相交的部分，并且可以指定圆角</span>
    context<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">drawDRRect</span><span class="token punctuation">(</span>outer<span class="token punctuation">,</span> inner<span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 画 "勾"</span>
  <span class="token comment">// 它有三个点的连线构成，为了简单起见，我们将起始点和中点拐点的位置根据 Checkbox 的大小</span>
  <span class="token comment">// 算出固定的坐标，然后我们在每一帧中动态调整第三个点的位置就可以实现打勾动画</span>
  <span class="token keyword">void</span> <span class="token function">_drawCheckMark</span><span class="token punctuation">(</span><span class="token class-name">PaintingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Rect</span> rect<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 在画好背景后再画前景</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>progress <span class="token operator">&gt;</span> bgAnimationInterval<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//确定中间拐点位置</span>
      <span class="token keyword">final</span> secondOffset <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>
        rect<span class="token punctuation">.</span>left <span class="token operator">+</span> rect<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2.5</span><span class="token punctuation">,</span>
        rect<span class="token punctuation">.</span>bottom <span class="token operator">-</span> rect<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 第三个点的位置</span>
      <span class="token keyword">final</span> lastOffset <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>
        rect<span class="token punctuation">.</span>right <span class="token operator">-</span> rect<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">6</span><span class="token punctuation">,</span>
        rect<span class="token punctuation">.</span>top <span class="token operator">+</span> rect<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 我们只对第三个点的位置做插值</span>
      <span class="token keyword">final</span> _lastOffset <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>
        secondOffset<span class="token punctuation">,</span>
        lastOffset<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>progress <span class="token operator">-</span> bgAnimationInterval<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> bgAnimationInterval<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>

      <span class="token comment">// 将三个点连起来</span>
      <span class="token keyword">final</span> path <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span>left <span class="token operator">+</span> rect<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">7</span><span class="token punctuation">,</span> rect<span class="token punctuation">.</span>top <span class="token operator">+</span> rect<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>secondOffset<span class="token punctuation">.</span>dx<span class="token punctuation">,</span> secondOffset<span class="token punctuation">.</span>dy<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>_lastOffset<span class="token punctuation">.</span>dx<span class="token punctuation">,</span> _lastOffset<span class="token punctuation">.</span>dy<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">final</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span>isAntiAlias <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke
        <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> strokeColor
        <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> strokeWidth<span class="token punctuation">;</span>

      context<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">drawPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> paint<span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">performLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果父组件指定了固定宽高，则使用父组件指定的，否则宽高默认置为 25</span>
    size <span class="token operator">=</span> constraints<span class="token punctuation">.</span><span class="token function">constrain</span><span class="token punctuation">(</span>
      constraints<span class="token punctuation">.</span>isTight <span class="token operator">?</span> <span class="token class-name">Size</span><span class="token punctuation">.</span>infinite <span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Size</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// 如果我们要让渲染对象能处理事件，则它必须能通过命中测试，之后才能在 handleEvent 方法中处理事件</span>
  <span class="token comment">// 必须置为true，否则不可以响应事件</span>
  <span class="token metadata function">@override</span>
  bool <span class="token function">hitTestSelf</span><span class="token punctuation">(</span><span class="token class-name">Offset</span> position<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token comment">// 只有通过命中测试，才会调用本方法，我们在手指抬起时触发事件即可</span>
  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span><span class="token class-name">PointerEvent</span> event<span class="token punctuation">,</span> <span class="token keyword">covariant</span> <span class="token class-name">BoxHitTestEntry</span> entry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>down<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      pointerId <span class="token operator">=</span> event<span class="token punctuation">.</span>pointer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pointerId <span class="token operator">==</span> event<span class="token punctuation">.</span>pointer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 判断手指抬起时是在组件范围内的话才触发onChange</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>size<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>localPosition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        onChanged<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">!</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试代码如下：我们创建三个大小不同的复选框，点击其中任意一个，另外两个复选框的状态也会跟着联动：</p> 
<pre><code class="prism language-dart"><span class="token keyword">class</span> <span class="token class-name">CustomCheckboxTest</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">CustomCheckboxTest</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CustomCheckboxTest</span><span class="token punctuation">&gt;</span></span> <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_CustomCheckboxTestState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> _CustomCheckboxTestState <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CustomCheckboxTest</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  bool _checked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>
      child<span class="token punctuation">:</span> <span class="token class-name">Column</span><span class="token punctuation">(</span>mainAxisAlignment<span class="token punctuation">:</span> <span class="token class-name">MainAxisAlignment</span><span class="token punctuation">.</span>center<span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token class-name">CustomCheckbox2</span><span class="token punctuation">(</span>
            value<span class="token punctuation">:</span> _checked<span class="token punctuation">,</span>
            onChanged<span class="token punctuation">:</span> _onChange<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">Padding</span><span class="token punctuation">(</span>
            padding<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">18.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token class-name">SizedBox</span><span class="token punctuation">(</span>
              width<span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
              height<span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
              child<span class="token punctuation">:</span> <span class="token class-name">CustomCheckbox</span><span class="token punctuation">(</span>
                strokeWidth<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                radius<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                value<span class="token punctuation">:</span> _checked<span class="token punctuation">,</span>
                onChanged<span class="token punctuation">:</span> _onChange<span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">SizedBox</span><span class="token punctuation">(</span>
            width<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token class-name">CustomCheckbox</span><span class="token punctuation">(</span>
              strokeWidth<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
              radius<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
              value<span class="token punctuation">:</span> _checked<span class="token punctuation">,</span>
              onChanged<span class="token punctuation">:</span> _onChange<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">_onChange</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _checked <span class="token operator">=</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到通过 <code>RenderObject</code> 来自定义组件会比组合的方式更复杂一些，但这种方式会更接近 Flutter 组件的本质。</p> 
<h4><a id="_DoneWidget_1639"></a>自绘组件: DoneWidget</h4> 
<p>下面我们将实现一个 <code>DoneWidget</code>，它可以在创建时执行一个打勾动画，效果如图：</p> 
<p><img src="https://images2.imgbox.com/47/bd/85j8PuWH_o.gif" alt="在这里插入图片描述" height="200"></p> 
<p>实现代码如下：</p> 
<pre><code class="prism language-dart"><span class="token keyword">class</span> <span class="token class-name">DoneWidget</span> <span class="token keyword">extends</span> <span class="token class-name">LeafRenderObjectWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">DoneWidget</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>green<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>outline <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//线条宽度</span>
  <span class="token keyword">final</span> double strokeWidth<span class="token punctuation">;</span>
  <span class="token comment">//轮廓颜色或填充色</span>
  <span class="token keyword">final</span> <span class="token class-name">Color</span> color<span class="token punctuation">;</span>
  <span class="token comment">//如果为true，则没有填充色，color代表轮廓的颜色；如果为false，则color为填充色</span>
  <span class="token keyword">final</span> bool outline<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">RenderObject</span> <span class="token function">createRenderObject</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">RenderDoneObject</span><span class="token punctuation">(</span>
      strokeWidth<span class="token punctuation">,</span>
      color<span class="token punctuation">,</span>
      outline<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span>animationStatus <span class="token operator">=</span> <span class="token class-name">AnimationStatus</span><span class="token punctuation">.</span>forward<span class="token punctuation">;</span> <span class="token comment">// 创建时执行正向动画</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">updateRenderObject</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">RenderDoneObject</span> renderObject<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    renderObject
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> strokeWidth
      <span class="token punctuation">.</span><span class="token punctuation">.</span>outline <span class="token operator">=</span> outline
      <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>DoneWidget</code> 有两种模式，一种是 <code>outline</code> 模式，该模式背景没有填充色，此时 <code>color</code> 表示的是轮廓线条的颜色；如果是非 <code>outline</code> 模式，则 <code>color</code> 表示填充的背景色，此时 “勾” 的颜色简单设置为白色。</p> 
<p>接下来需要实现 <code>RenderDoneObject</code>，由于组件不需要响应事件，所以我们可以不用添加事件相关的处理代码；但是组件需要执行动画，因此我们可以直接使用上一节中封装的 <code>RenderObjectAnimationMixin</code>，具体实现代码如下：</p> 
<pre><code class="prism language-dart"><span class="token keyword">class</span> <span class="token class-name">RenderDoneObject</span> <span class="token keyword">extends</span> <span class="token class-name">RenderBox</span> <span class="token keyword">with</span> <span class="token class-name">RenderObjectAnimationMixin</span> <span class="token punctuation">{<!-- --></span>
  double strokeWidth<span class="token punctuation">;</span>
  <span class="token class-name">Color</span> color<span class="token punctuation">;</span>
  bool outline<span class="token punctuation">;</span>

  <span class="token class-name">ValueChanged</span><span class="token generics"><span class="token punctuation">&lt;</span>bool<span class="token punctuation">&gt;</span></span><span class="token operator">?</span> onChanged<span class="token punctuation">;</span>

  <span class="token class-name">RenderDoneObject</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>strokeWidth<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>color<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>outline<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 动画执行时间为 300ms</span>
  <span class="token metadata function">@override</span>
  <span class="token class-name">Duration</span> <span class="token keyword">get</span> duration <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">const</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>milliseconds<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">doPaint</span><span class="token punctuation">(</span><span class="token class-name">PaintingContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Offset</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 可以对动画运用曲线</span>
    <span class="token class-name">Curve</span> curve <span class="token operator">=</span> <span class="token class-name">Curves</span><span class="token punctuation">.</span>easeIn<span class="token punctuation">;</span>
    <span class="token keyword">final</span> _progress <span class="token operator">=</span> curve<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>progress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Rect</span> rect <span class="token operator">=</span> offset <span class="token operator">&amp;</span> size<span class="token punctuation">;</span>
    <span class="token keyword">final</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>isAntiAlias <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> outline <span class="token operator">?</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke <span class="token punctuation">:</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>fill <span class="token comment">//填充</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>outline<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      paint<span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> strokeWidth<span class="token punctuation">;</span>
      rect <span class="token operator">=</span> rect<span class="token punctuation">.</span><span class="token function">deflate</span><span class="token punctuation">(</span>strokeWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 画背景圆</span>
    context<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span>center<span class="token punctuation">,</span> rect<span class="token punctuation">.</span>shortestSide <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    paint
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke
      <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> outline <span class="token operator">?</span> color <span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> strokeWidth<span class="token punctuation">;</span>

    <span class="token keyword">final</span> path <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//接下来画 "勾"</span>
    <span class="token class-name">Offset</span> firstOffset <span class="token operator">=</span>
        <span class="token class-name">Offset</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span>left <span class="token operator">+</span> rect<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">6</span><span class="token punctuation">,</span> rect<span class="token punctuation">.</span>top <span class="token operator">+</span> rect<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> secondOffset <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>
      rect<span class="token punctuation">.</span>left <span class="token operator">+</span> rect<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2.5</span><span class="token punctuation">,</span>
      rect<span class="token punctuation">.</span>bottom <span class="token operator">-</span> rect<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">3.3</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    path<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>firstOffset<span class="token punctuation">.</span>dx<span class="token punctuation">,</span> firstOffset<span class="token punctuation">.</span>dy<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// adjustProgress 的作用主要是将“打勾”动画氛围两部分，第一部分是第一个点和第二个点的连线动画，</span>
    <span class="token comment">// 这部分动画站总动画时长的 前 60%； 第二部分是第二点和第三个点的连线动画，该部分动画占总时长的后 40%。</span>
    <span class="token keyword">const</span> adjustProgress <span class="token operator">=</span> <span class="token number">.6</span><span class="token punctuation">;</span>
    <span class="token comment">//画 "勾"</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_progress <span class="token operator">&lt;</span> adjustProgress<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//第一个点到第二个点的连线做动画(第二个点不停的变)</span>
      <span class="token class-name">Offset</span> _secondOffset <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>
        firstOffset<span class="token punctuation">,</span>
        secondOffset<span class="token punctuation">,</span>
        _progress <span class="token operator">/</span> adjustProgress<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
      path<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>_secondOffset<span class="token punctuation">.</span>dx<span class="token punctuation">,</span> _secondOffset<span class="token punctuation">.</span>dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//连接第一个点和第二个点</span>
      path<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>secondOffset<span class="token punctuation">.</span>dx<span class="token punctuation">,</span> secondOffset<span class="token punctuation">.</span>dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//第三个点位置随着动画变，做动画</span>
      <span class="token keyword">final</span> lastOffset <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>
        rect<span class="token punctuation">.</span>right <span class="token operator">-</span> rect<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">,</span>
        rect<span class="token punctuation">.</span>top <span class="token operator">+</span> rect<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">3.5</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Offset</span> _lastOffset <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>
        secondOffset<span class="token punctuation">,</span>
        lastOffset<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>progress <span class="token operator">-</span> adjustProgress<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> adjustProgress<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
      path<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>_lastOffset<span class="token punctuation">.</span>dx<span class="token punctuation">,</span> _lastOffset<span class="token punctuation">.</span>dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    context<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">drawPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> paint<span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">performLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果父组件指定了固定宽高，则使用父组件指定的，否则宽高默认置为 25</span>
    size <span class="token operator">=</span> constraints<span class="token punctuation">.</span><span class="token function">constrain</span><span class="token punctuation">(</span>
      constraints<span class="token punctuation">.</span>isTight <span class="token operator">?</span> <span class="token class-name">Size</span><span class="token punctuation">.</span>infinite <span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Size</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面代码很简单，但需要注意三点：</p> 
<ol><li> <p>我们对动画应用了<code>easeIn</code> 曲线，可以看到如何在 <code>RenderObject</code> 中对动画应用曲线，曲线的本质其实就是对动画的进度加了一层映射，通过不同的映射规则就可以控制动画在不同阶段的快慢。</p> </li><li> <p>我们重写了 <code>RenderObjectAnimationMixin</code> 中的 <code>duration</code>，该参数用于指定动画时长。</p> </li><li> <p><code>adjustProgress</code> 的作用主要是将“打勾”动画分为两部分，第一部分是第一个点和第二个点的连线动画，这部分动画站总动画时长的前 <code>60%</code>； 第二部分是第二点和第三个点的连线动画，该部分动画占总时长的后 <code>40%</code>。</p> </li></ol> 
<h3><a id="__1789"></a>水印实例: 文本绘制与离屏渲染</h3> 
<p>下面将通过实现一个水印组件来介绍一下如何绘制文本以及如何进行离屏渲染。</p> 
<p>在实际场景中，大多数情况下水印是要铺满整个屏幕的，如果不需要铺满屏幕，通常直接用组件组合即可实现，本节我们主要讨论的是需要铺满屏幕的水印。</p> 
<h4><a id="_WaterMark_1795"></a>水印组件 WaterMark</h4> 
<p>我们可以通过绘制一个“单元水印”，然后让它在整个水印组件的背景中重复即可实现我们期望的功能，因此我们可以直接使用 <code>DecoratedBox</code> ，它拥有背景图重复功能。重复的问题解决后，那么主要的问题便是如何绘制单元水印，为了灵活好扩展，我们定义一个水印画笔接口，这样一来我们可以预置一些常用的画笔实现来满足大多数场景，同时如果开发者有自定义需求的话也可以通过自定义画笔来实现。</p> 
<p>下面是水印组件 <code>WaterMark</code> 的定义：</p> 
<pre><code class="prism language-dart"><span class="token keyword">class</span> <span class="token class-name">WaterMark</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">WaterMark</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>repeat <span class="token operator">=</span> <span class="token class-name">ImageRepeat</span><span class="token punctuation">.</span>repeat<span class="token punctuation">,</span>
    required <span class="token keyword">this</span><span class="token punctuation">.</span>painter<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// 单元水印画笔</span>
  <span class="token keyword">final</span> <span class="token class-name">WaterMarkPainter</span> painter<span class="token punctuation">;</span>

  <span class="token comment">/// 单元水印的重复方式</span>
  <span class="token keyword">final</span> <span class="token class-name">ImageRepeat</span> repeat<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterMark</span><span class="token punctuation">&gt;</span></span> <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_WaterMarkState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下面看一下 <code>State</code> 实现：</p> 
<pre><code class="prism language-dart"><span class="token keyword">class</span> _WaterMarkState <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterMark</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  late <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemoryImage</span><span class="token punctuation">&gt;</span></span> _memoryImageFuture<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 缓存的是promise</span>
    _memoryImageFuture <span class="token operator">=</span> <span class="token function">_getWaterMarkImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">SizedBox</span><span class="token punctuation">.</span><span class="token function">expand</span><span class="token punctuation">(</span> <span class="token comment">// 水印尽可能大 </span>
      child<span class="token punctuation">:</span> <span class="token class-name">FutureBuilder</span><span class="token punctuation">(</span>
        future<span class="token punctuation">:</span> _memoryImageFuture<span class="token punctuation">,</span>
        builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">,</span> <span class="token class-name">AsyncSnapshot</span> snapshot<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>snapshot<span class="token punctuation">.</span>connectionState <span class="token operator">!=</span> <span class="token class-name">ConnectionState</span><span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果单元水印还没有绘制好先返回一个空的Container</span>
            <span class="token keyword">return</span> <span class="token class-name">Container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果单元水印已经绘制好，则渲染水印</span>
            <span class="token keyword">return</span> <span class="token class-name">DecoratedBox</span><span class="token punctuation">(</span>
              decoration<span class="token punctuation">:</span> <span class="token class-name">BoxDecoration</span><span class="token punctuation">(</span>
                image<span class="token punctuation">:</span> <span class="token class-name">DecorationImage</span><span class="token punctuation">(</span>
                  image<span class="token punctuation">:</span> snapshot<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token comment">// 背景图，即我们绘制的单元水印图片</span>
                  repeat<span class="token punctuation">:</span> widget<span class="token punctuation">.</span>repeat<span class="token punctuation">,</span>
                  alignment<span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">.</span>topLeft<span class="token punctuation">,</span> <span class="token comment">// 指定重复方式</span>
                  scale<span class="token punctuation">:</span> <span class="token class-name">MediaQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>devicePixelRatio<span class="token punctuation">,</span> <span class="token comment">// 很重要</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">didUpdateWidget</span><span class="token punctuation">(</span><span class="token class-name">WaterMark</span> oldWidget<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">//待实现</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 离屏绘制单元水印并将绘制结果转为图片缓存起来</span>
  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemoryImage</span><span class="token punctuation">&gt;</span></span> <span class="token function">_getWaterMarkImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">//待实现</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">// 待实现</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>	
</code></pre> 
<p>我们通过 <code>DecoratedBox</code> 来实现背景图重复，同时我们在组件初始化时开始进行离屏绘制单元水印，并将结果缓存在 <code>MemoryImage</code> 中，因为离屏绘制是一个异步任务，所以直接缓存 <code>Future</code> 即可。这里需要注意，当组件重新<code>build</code>时，如果画笔配置发生变化，则我们需要重新绘制单元水印并缓存新的绘制结果：</p> 
<pre><code class="prism language-dart"> <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">didUpdateWidget</span><span class="token punctuation">(</span><span class="token class-name">WaterMark</span> oldWidget<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token comment">// 如果画笔发生了变化（类型或者配置）则重新绘制水印</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>widget<span class="token punctuation">.</span>painter<span class="token punctuation">.</span>runtimeType <span class="token operator">!=</span> oldWidget<span class="token punctuation">.</span>painter<span class="token punctuation">.</span>runtimeType <span class="token operator">||</span>
        widget<span class="token punctuation">.</span>painter<span class="token punctuation">.</span><span class="token function">shouldRepaint</span><span class="token punctuation">(</span>oldWidget<span class="token punctuation">.</span>painter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//先释放之前的缓存</span>
      _memoryImageFuture<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> value<span class="token punctuation">.</span><span class="token function">evict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//重新绘制并缓存</span>
      _memoryImageFuture <span class="token operator">=</span> <span class="token function">_getWaterMarkImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">didUpdateWidget</span><span class="token punctuation">(</span>oldWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token punctuation">}</span>
</code></pre> 
<p>注意，在重新绘制单元水印之前要先将旧单元水印的缓存清理掉，清理缓存可以通过调用 <code>MemoryImage</code> 的 <code>evict</code> 方法。同时，当组件卸载时，我们也要释放缓存：</p> 
<pre><code class="prism language-dart">  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//释放图片缓存</span>
    _memoryImageFuture<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> value<span class="token punctuation">.</span><span class="token function">evict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>接下来就需要重新绘制单元水印了，调用 <code>_getWaterMarkImage()</code> 方法即可，该方法的功能是离屏绘制单元水印并将绘制结果转为图片缓存起来，下面我们看一下它的实现。</p> 
<p><strong>离屏绘制</strong></p> 
<p>离屏绘制的代码如下：</p> 
<pre><code class="prism language-dart">  <span class="token comment">// 离屏绘制单元水印并将绘制结果保存为图片缓存起来</span>
  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemoryImage</span><span class="token punctuation">&gt;</span></span> <span class="token function">_getWaterMarkImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建一个 Canvas 进行离屏绘制 </span>
    <span class="token keyword">final</span> recorder <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PictureRecorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> canvas <span class="token operator">=</span> <span class="token class-name">Canvas</span><span class="token punctuation">(</span>recorder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 绘制单元水印并获取其大小</span>
    <span class="token keyword">final</span> size <span class="token operator">=</span> widget<span class="token punctuation">.</span>painter<span class="token punctuation">.</span><span class="token function">paintUnit</span><span class="token punctuation">(</span>
      canvas<span class="token punctuation">,</span>
      <span class="token class-name">MediaQueryData</span><span class="token punctuation">.</span><span class="token function">fromView</span><span class="token punctuation">(</span>ui<span class="token punctuation">.</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span>devicePixelRatio<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> picture <span class="token operator">=</span> recorder<span class="token punctuation">.</span><span class="token function">endRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将单元水印导为图片并缓存起来</span>
    <span class="token keyword">final</span> img <span class="token operator">=</span> <span class="token keyword">await</span> picture<span class="token punctuation">.</span><span class="token function">toImage</span><span class="token punctuation">(</span>size<span class="token punctuation">.</span>width<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">.</span>height<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    picture<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> byteData <span class="token operator">=</span> <span class="token keyword">await</span> img<span class="token punctuation">.</span><span class="token function">toByteData</span><span class="token punctuation">(</span>format<span class="token punctuation">:</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>ImageByteFormat</span><span class="token punctuation">.</span>png<span class="token punctuation">)</span><span class="token punctuation">;</span>
    img<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> pngBytes <span class="token operator">=</span> byteData<span class="token operator">!</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">asUint8List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">MemoryImage</span><span class="token punctuation">(</span>pngBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>我们通过手动创建了一个 <code>Canvas</code> 和一个 <code>PictureRecorder</code> 来实现离屏绘制，<code>PictureRecorder</code> 的功能简单来说：调用 <code>Canvas</code> API 后，实际上产生的是一系列绘制指令，这些绘制指令执行后才能获取绘制结果，而<code>PictureRecorder</code> 就是一个绘制指令记录器，它可以记录一段时间内所有绘制指令，我们可以通过调用 <code>recorder.endRecording()</code> 方法来获取记录的绘制指令，该方法返回一个 <code>Picture</code> 对象，它是绘制指令的载体，它有一个 <code>toImage</code> 方法，调用后会执行绘制指令获得绘制的像素结果（<code>ui.Image</code> 对象），之后我们就可以将像素结果转为 <code>png</code> 格式的数据并缓存在<code>MemoryImage</code> 中。</p> 
<h4><a id="_1930"></a>单元水印画笔</h4> 
<p>现在我们看一下如何绘制单元水印，我们先看一下水印画笔接口的定义：</p> 
<pre><code class="prism language-dart"><span class="token comment">/// 定义水印画笔</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">WaterMarkPainter</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/// 绘制"单元水印"，完整的水印是由单元水印重复平铺组成,返回值为"单元水印"占用空间的大小。</span>
  <span class="token comment">/// [devicePixelRatio]: 因为最终要将绘制内容保存为图片，所以在绘制时需要根据屏幕的DPR来放大，以防止失真 </span>
  <span class="token class-name">Size</span> <span class="token function">paintUnit</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> double devicePixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// 是否需要重绘</span>
  bool <span class="token function">shouldRepaint</span><span class="token punctuation">(</span><span class="token keyword">covariant</span> <span class="token class-name">WaterMarkPainter</span> oldPainter<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>定义很简单，就两个函数：</p> 
<ul><li><code>paintUnit</code> 用于绘制单元水印，这里需要注意一点，因为很多 UI 元素的大小只能在绘制时获取，无法提前知道大小，所以 <code>paintUnit</code> 在完成绘制单元水印任务的同时，最后得返回单元水印的大小信息，它在导为图片时要用到。</li><li><code>shouldRepaint</code>：当画笔状态发生变化且会影响单元水印的外观时返回 <code>true</code>，否则返回 <code>false</code>，返回 <code>true</code> 后重绘单元水印。它是在 <code>_WaterMarkState</code> 的 <code>didUpdateWidget</code> 方法中调用，可以结合源码理解。</li></ul> 
<h4><a id="_1950"></a>文本水印画笔</h4> 
<p>下面我们实现一个文本水印画笔，它可以绘制一段文本，我们可以指定文本的样式和旋转角度。</p> 
<pre><code class="prism language-dart"><span class="token comment">/// 文本水印画笔</span>
<span class="token keyword">class</span> <span class="token class-name">TextWaterMarkPainter</span> <span class="token keyword">extends</span> <span class="token class-name">WaterMarkPainter</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">TextWaterMarkPainter</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
    double<span class="token operator">?</span> rotate<span class="token punctuation">,</span>
    <span class="token class-name">EdgeInsets</span><span class="token operator">?</span> padding<span class="token punctuation">,</span>
    <span class="token class-name">TextStyle</span><span class="token operator">?</span> textStyle<span class="token punctuation">,</span>
    required <span class="token keyword">this</span><span class="token punctuation">.</span>text<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">:</span> <span class="token keyword">assert</span><span class="token punctuation">(</span>rotate <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> rotate <span class="token operator">&gt;=</span> <span class="token operator">-</span><span class="token number">90</span> <span class="token operator">&amp;&amp;</span> rotate <span class="token operator">&lt;=</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rotate <span class="token operator">=</span> rotate <span class="token operator">?</span><span class="token operator">?</span> <span class="token number">0</span><span class="token punctuation">,</span>
        padding <span class="token operator">=</span> padding <span class="token operator">?</span><span class="token operator">?</span> <span class="token keyword">const</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        textStyle <span class="token operator">=</span> textStyle <span class="token operator">?</span><span class="token operator">?</span>
            <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
              color<span class="token punctuation">:</span> <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">fromARGB</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              fontSize<span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

  double rotate<span class="token punctuation">;</span> <span class="token comment">// 文本旋转的度数，是角度不是弧度</span>
  <span class="token class-name">TextStyle</span> textStyle<span class="token punctuation">;</span> <span class="token comment">// 文本样式</span>
  <span class="token class-name">EdgeInsets</span> padding<span class="token punctuation">;</span> <span class="token comment">// 文本的 padding</span>
  <span class="token class-name">String</span> text<span class="token punctuation">;</span> <span class="token comment">// 文本</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Size</span> <span class="token function">paintUnit</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span>double devicePixelRatio<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">// 1. 先绘制文本</span>
   <span class="token comment">// 2. 应用旋转和padding </span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  bool <span class="token function">shouldRepaint</span><span class="token punctuation">(</span><span class="token class-name">TextWaterMarkPainter</span> oldPainter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">// 待实现</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>paintUnit</code> 的绘制分两步：</p> 
<ol><li>绘制文本</li><li>应用旋转和<code>padding</code></li></ol> 
<p><strong>绘制文本</strong></p> 
<ol><li>创建一个 <code>ParagraphBuilder</code>，记为 <code>builder</code>。</li><li>调用 <code>builder.add</code> 添加要绘制的字符串。</li><li>构建文本并进行 <code>layout</code>，因为在 <code>layout</code> 后才能知道文本所占用的空间。</li><li>调用 <code>canvas.drawParagraph</code> 绘制。</li></ol> 
<p>具体代码如下：</p> 
<pre><code class="prism language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'dart:ui'</span></span> <span class="token operator">as</span> ui<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token metadata function">@override</span>
  <span class="token class-name">Size</span> <span class="token function">paintUnit</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span>double devicePixelRatio<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//根据屏幕 devicePixelRatio 对文本样式中长度相关的一些值乘以devicePixelRatio</span>
    <span class="token keyword">final</span> _textStyle <span class="token operator">=</span> <span class="token function">_handleTextStyle</span><span class="token punctuation">(</span>textStyle<span class="token punctuation">,</span> devicePixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> _padding <span class="token operator">=</span> padding <span class="token operator">*</span> devicePixelRatio<span class="token punctuation">;</span>
  
    <span class="token comment">//构建文本段落</span>
    <span class="token keyword">final</span> builder <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>ParagraphBuilder</span><span class="token punctuation">(</span>_textStyle<span class="token punctuation">.</span><span class="token function">getParagraphStyle</span><span class="token punctuation">(</span>
      textDirection<span class="token punctuation">:</span> textDirection<span class="token punctuation">,</span>
      textAlign<span class="token punctuation">:</span> <span class="token class-name">TextAlign</span><span class="token punctuation">.</span>start<span class="token punctuation">,</span>
      textScaleFactor<span class="token punctuation">:</span> devicePixelRatio<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//添加要绘制的文本及样式</span>
    builder
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">pushStyle</span><span class="token punctuation">(</span>_textStyle<span class="token punctuation">.</span><span class="token function">getTextStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// textStyle 为 ui.TextStyle</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">addText</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//layout 后我们才能知道文本占用的空间</span>
    <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>Paragraph</span> paragraph <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>ParagraphConstraints</span><span class="token punctuation">(</span>width<span class="token punctuation">:</span> double<span class="token punctuation">.</span>infinity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//文本占用的真实宽度</span>
    <span class="token keyword">final</span> textWidth <span class="token operator">=</span> paragraph<span class="token punctuation">.</span>longestLine<span class="token punctuation">.</span><span class="token function">ceilToDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文本占用的真实高度</span>
    <span class="token keyword">final</span> fontSize <span class="token operator">=</span> paragraph<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//省略应用旋转和 padding 的相关代码</span>

    <span class="token comment">//绘制文本</span>
    canvas<span class="token punctuation">.</span><span class="token function">drawParagraph</span><span class="token punctuation">(</span>paragraph<span class="token punctuation">,</span> <span class="token class-name">Offset</span><span class="token punctuation">.</span>zero<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span>

  <span class="token class-name">TextStyle</span> <span class="token function">_handleTextStyle</span><span class="token punctuation">(</span>double devicePixelRatio<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> style <span class="token operator">=</span> textStyle<span class="token punctuation">;</span>
    double <span class="token function">_scale</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> attr <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token punctuation">:</span> devicePixelRatio<span class="token punctuation">;</span>
    <span class="token keyword">return</span> style<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>
      decorationThicknessFactor<span class="token punctuation">:</span> <span class="token function">_scale</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>decorationThickness<span class="token punctuation">)</span><span class="token punctuation">,</span>
      letterSpacingFactor<span class="token punctuation">:</span> <span class="token function">_scale</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>letterSpacing<span class="token punctuation">)</span><span class="token punctuation">,</span>
      wordSpacingFactor<span class="token punctuation">:</span> <span class="token function">_scale</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>wordSpacing<span class="token punctuation">)</span><span class="token punctuation">,</span>
      heightFactor<span class="token punctuation">:</span> <span class="token function">_scale</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>可以看到绘制文本的过程还是比较复杂的，为此 Flutter 提供了一个专门用于绘制文本的画笔 <code>TextPainter</code>，我们用 <code>TextPainter</code> 改造上面代码：</p> 
<pre><code class="prism language-dart"><span class="token comment">//构建文本画笔</span>
<span class="token class-name">TextPainter</span> painter <span class="token operator">=</span> <span class="token class-name">TextPainter</span><span class="token punctuation">(</span>
  textDirection<span class="token punctuation">:</span> <span class="token class-name">TextDirection</span><span class="token punctuation">.</span>ltr<span class="token punctuation">,</span>
  textScaleFactor<span class="token punctuation">:</span> devicePixelRatio<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//添加文本和样式</span>
painter<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token class-name">TextSpan</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> text<span class="token punctuation">,</span> style<span class="token punctuation">:</span> _textStyle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//对文本进行布局</span>
painter<span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//文本占用的真实宽度</span>
<span class="token keyword">final</span> textWidth <span class="token operator">=</span> painter<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
<span class="token comment">//文本占用的真实高度</span>
<span class="token keyword">final</span> textHeight <span class="token operator">=</span> painter<span class="token punctuation">.</span>height<span class="token punctuation">;</span>

 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//省略应用旋转和 padding 的相关代码</span>
   
<span class="token comment">// 绘制文本</span>
painter<span class="token punctuation">.</span><span class="token function">paint</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> <span class="token class-name">Offset</span><span class="token punctuation">.</span>zero<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>可以看到，代码实际上少不了多少，但是清晰了一些。</p> 
<p>另外 <code>TextPainter</code> 在实战中还有一个用处就是我们想提前知道 <code>Text</code> 组件的宽高时，可以通过 <code>TextPainter</code> 来提前测量，比如：</p> 
<pre><code class="prism language-dart"><span class="token class-name">Widget</span> <span class="token function">wTextPainterTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 我们想提前知道 Text 组件的大小</span>
    <span class="token class-name">Text</span> text <span class="token operator">=</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'flutter'</span></span><span class="token punctuation">,</span> style<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>fontSize<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用 TextPainter 来测量</span>
    <span class="token class-name">TextPainter</span> painter <span class="token operator">=</span> <span class="token class-name">TextPainter</span><span class="token punctuation">(</span>textDirection<span class="token punctuation">:</span> <span class="token class-name">TextDirection</span><span class="token punctuation">.</span>ltr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 Text 组件文本和样式透传给TextPainter</span>
    painter<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token class-name">TextSpan</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> text<span class="token punctuation">.</span>data<span class="token punctuation">,</span>style<span class="token punctuation">:</span>text<span class="token punctuation">.</span>style<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 开始布局测量，调用 layout 后就能获取文本大小了</span>
    painter<span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 自定义组件 AfterLayout 可以在布局结束后获取子组件的大小，我们用它来验证一下</span>
    <span class="token comment">// TextPainter 测量的宽高是否正确</span>
    <span class="token keyword">return</span> <span class="token class-name">AfterLayout</span><span class="token punctuation">(</span>
      callback<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">RenderAfterLayout</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 输出日志</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'text size(painter): </span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">painter<span class="token punctuation">.</span>size</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'text size(after layout): </span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">value<span class="token punctuation">.</span>size</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> text<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><strong>应用旋转和 padding</strong></p> 
<p>应用旋转效果本身比较简单，但难的是文本旋转后它占用的空间大小会发生变化，所以我们得动态计算旋转后文本所占用空间的大小，假设沿顺时针方向旋转了了 <code>rotate</code> 角度，画出布局图：</p> 
<p><img src="https://images2.imgbox.com/67/6f/gpoj3IuC_o.png" alt="在这里插入图片描述" width="800"></p> 
<p>我们可以根据上面公式求出最终的宽度和高度，是不是感觉高中学的三角函数终于派上用场了！注意，上面的公式中并没有考虑<code>padding</code>，<code>padding</code> 的处理比较简单，不赘述，看代码：</p> 
<pre><code class="prism language-dart"> <span class="token metadata function">@override</span>
  <span class="token class-name">Size</span> <span class="token function">paintUnit</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> double devicePixelRatio<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 省略</span>
    <span class="token comment">//文本占用的真实宽度</span>
    <span class="token keyword">final</span> textWidth <span class="token operator">=</span> painter<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    <span class="token comment">//文本占用的真实高度</span>
    <span class="token keyword">final</span> textHeight <span class="token operator">=</span> painter<span class="token punctuation">.</span>height<span class="token punctuation">;</span>

    <span class="token comment">// 将弧度转化为度数</span>
    <span class="token keyword">final</span> radians <span class="token operator">=</span> math<span class="token punctuation">.</span>pi <span class="token operator">*</span> rotate <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>

    <span class="token comment">//通过三角函数计算旋转后的位置和size</span>
    <span class="token keyword">final</span> orgSin <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>radians<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> sin <span class="token operator">=</span> orgSin<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> cos <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>radians<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> width <span class="token operator">=</span> textWidth <span class="token operator">*</span> cos<span class="token punctuation">;</span>
    <span class="token keyword">final</span> height <span class="token operator">=</span> textWidth <span class="token operator">*</span> sin<span class="token punctuation">;</span>
    <span class="token keyword">final</span> adjustWidth <span class="token operator">=</span> fontSize <span class="token operator">*</span> sin<span class="token punctuation">;</span>
    <span class="token keyword">final</span> adjustHeight <span class="token operator">=</span> fontSize <span class="token operator">*</span> cos<span class="token punctuation">;</span>

    <span class="token comment">// 为什么要平移？下面解释</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>orgSin <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 旋转角度为正</span>
      canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>
        adjustWidth <span class="token operator">+</span> padding<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
        padding<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 旋转角度为负</span>
      canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>
        padding<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
        height <span class="token operator">+</span> padding<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    canvas<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>radians<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 绘制文本</span>
    painter<span class="token punctuation">.</span><span class="token function">paint</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> <span class="token class-name">Offset</span><span class="token punctuation">.</span>zero<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回水印单元所占的真实空间大小（需要加上padding）</span>
    <span class="token keyword">return</span> <span class="token class-name">Size</span><span class="token punctuation">(</span>
      width <span class="token operator">+</span> adjustWidth <span class="token operator">+</span> padding<span class="token punctuation">.</span>horizontal<span class="token punctuation">,</span>
      height <span class="token operator">+</span> adjustHeight <span class="token operator">+</span> padding<span class="token punctuation">.</span>vertical<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>注意，在旋转前我们对 <code>canvas</code> 进行了平移操作，如果不限平移，就会导致旋转之后一部分内容的位置跑在画布之外了，如图：</p> 
<p><img src="https://images2.imgbox.com/38/b4/Fowx4KLj_o.png" alt="在这里插入图片描述" width="350"></p> 
<p>接下来实现 <code>shouldRepaint</code> 方法：</p> 
<pre><code class="prism language-dart"><span class="token metadata function">@override</span>
bool <span class="token function">shouldRepaint</span><span class="token punctuation">(</span><span class="token class-name">TextWaterMarkPainter</span> oldPainter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> oldPainter<span class="token punctuation">.</span>rotate <span class="token operator">!=</span> rotate <span class="token operator">||</span>
      oldPainter<span class="token punctuation">.</span>text <span class="token operator">!=</span> text <span class="token operator">||</span>
      oldPainter<span class="token punctuation">.</span>padding <span class="token operator">!=</span> padding <span class="token operator">||</span>
      oldPainter<span class="token punctuation">.</span>textDirection <span class="token operator">!=</span> textDirection <span class="token operator">||</span>
      oldPainter<span class="token punctuation">.</span>textStyle <span class="token operator">!=</span> textStyle<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面这些属性发生变化时都会导致水印 UI 发生变化，所以需要重绘。</p> 
<p><strong>完整代码：</strong></p> 
<pre><code class="prism language-dart"><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'dart:math'</span></span> <span class="token operator">as</span> math<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'dart:ui'</span></span> <span class="token operator">as</span> ui<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string-literal"><span class="token string">'package:flutter/widgets.dart'</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">WaterMark</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">WaterMark</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>repeat <span class="token operator">=</span> <span class="token class-name">ImageRepeat</span><span class="token punctuation">.</span>repeat<span class="token punctuation">,</span>
    required <span class="token keyword">this</span><span class="token punctuation">.</span>painter<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// 单元水印画笔</span>
  <span class="token keyword">final</span> <span class="token class-name">WaterMarkPainter</span> painter<span class="token punctuation">;</span>

  <span class="token comment">/// 单元水印的重复方式</span>
  <span class="token keyword">final</span> <span class="token class-name">ImageRepeat</span> repeat<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterMark</span><span class="token punctuation">&gt;</span></span> <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_WaterMarkState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> _WaterMarkState <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WaterMark</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  late <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemoryImage</span><span class="token punctuation">&gt;</span></span> _memoryImageFuture<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 缓存的是promise</span>
    _memoryImageFuture <span class="token operator">=</span> <span class="token function">_getWaterMarkImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">SizedBox</span><span class="token punctuation">.</span><span class="token function">expand</span><span class="token punctuation">(</span>
      <span class="token comment">// 水印尽可能大</span>
      child<span class="token punctuation">:</span> <span class="token class-name">FutureBuilder</span><span class="token punctuation">(</span>
        future<span class="token punctuation">:</span> _memoryImageFuture<span class="token punctuation">,</span>
        builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">,</span> <span class="token class-name">AsyncSnapshot</span> snapshot<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>snapshot<span class="token punctuation">.</span>connectionState <span class="token operator">!=</span> <span class="token class-name">ConnectionState</span><span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果单元水印还没有绘制好先返回一个空的Container</span>
            <span class="token keyword">return</span> <span class="token class-name">Container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果单元水印已经绘制好，则渲染水印</span>
            <span class="token keyword">return</span> <span class="token class-name">DecoratedBox</span><span class="token punctuation">(</span>
              decoration<span class="token punctuation">:</span> <span class="token class-name">BoxDecoration</span><span class="token punctuation">(</span>
                image<span class="token punctuation">:</span> <span class="token class-name">DecorationImage</span><span class="token punctuation">(</span>
                  image<span class="token punctuation">:</span> snapshot<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token comment">// 背景图，即我们绘制的单元水印图片</span>
                  repeat<span class="token punctuation">:</span> widget<span class="token punctuation">.</span>repeat<span class="token punctuation">,</span>
                  alignment<span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">.</span>topLeft<span class="token punctuation">,</span> <span class="token comment">// 指定重复方式</span>
                  scale<span class="token punctuation">:</span> <span class="token class-name">MediaQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>devicePixelRatio<span class="token punctuation">,</span> <span class="token comment">// 很重要</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">didUpdateWidget</span><span class="token punctuation">(</span><span class="token class-name">WaterMark</span> oldWidget<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果画笔发生了变化（类型或者配置）则重新绘制水印</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>widget<span class="token punctuation">.</span>painter<span class="token punctuation">.</span>runtimeType <span class="token operator">!=</span> oldWidget<span class="token punctuation">.</span>painter<span class="token punctuation">.</span>runtimeType <span class="token operator">||</span>
        widget<span class="token punctuation">.</span>painter<span class="token punctuation">.</span><span class="token function">shouldRepaint</span><span class="token punctuation">(</span>oldWidget<span class="token punctuation">.</span>painter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//先释放之前的缓存</span>
      _memoryImageFuture<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> value<span class="token punctuation">.</span><span class="token function">evict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//重新绘制并缓存</span>
      _memoryImageFuture <span class="token operator">=</span> <span class="token function">_getWaterMarkImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">didUpdateWidget</span><span class="token punctuation">(</span>oldWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 离屏绘制单元水印并将绘制结果保存为图片缓存起来</span>
  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemoryImage</span><span class="token punctuation">&gt;</span></span> <span class="token function">_getWaterMarkImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建一个 Canvas 进行离屏绘制 </span>
    <span class="token keyword">final</span> recorder <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PictureRecorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> canvas <span class="token operator">=</span> <span class="token class-name">Canvas</span><span class="token punctuation">(</span>recorder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 绘制单元水印并获取其大小</span>
    <span class="token keyword">final</span> size <span class="token operator">=</span> widget<span class="token punctuation">.</span>painter<span class="token punctuation">.</span><span class="token function">paintUnit</span><span class="token punctuation">(</span>
      canvas<span class="token punctuation">,</span>
      <span class="token class-name">MediaQueryData</span><span class="token punctuation">.</span><span class="token function">fromView</span><span class="token punctuation">(</span>ui<span class="token punctuation">.</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span>devicePixelRatio<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">final</span> picture <span class="token operator">=</span> recorder<span class="token punctuation">.</span><span class="token function">endRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将单元水印导为图片并缓存起来</span>
    <span class="token keyword">final</span> img <span class="token operator">=</span> <span class="token keyword">await</span> picture<span class="token punctuation">.</span><span class="token function">toImage</span><span class="token punctuation">(</span>size<span class="token punctuation">.</span>width<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">.</span>height<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    picture<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> byteData <span class="token operator">=</span> <span class="token keyword">await</span> img<span class="token punctuation">.</span><span class="token function">toByteData</span><span class="token punctuation">(</span>format<span class="token punctuation">:</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>ImageByteFormat</span><span class="token punctuation">.</span>png<span class="token punctuation">)</span><span class="token punctuation">;</span>
    img<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> pngBytes <span class="token operator">=</span> byteData<span class="token operator">!</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">asUint8List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">MemoryImage</span><span class="token punctuation">(</span>pngBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 释放图片缓存</span>
    _memoryImageFuture<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> value<span class="token punctuation">.</span><span class="token function">evict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// 定义水印画笔</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">WaterMarkPainter</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/// 绘制"单元水印"，完整的水印是由单元水印重复平铺组成,返回值为"单元水印"占用空间的大小。</span>
  <span class="token comment">/// [devicePixelRatio]: 因为最终要将绘制内容保存为图片，所以在绘制时需要根据屏幕的</span>
  <span class="token comment">/// DPR来放大，以防止失真</span>
  <span class="token class-name">Size</span> <span class="token function">paintUnit</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> double devicePixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// 是否需要重绘</span>
  bool <span class="token function">shouldRepaint</span><span class="token punctuation">(</span><span class="token keyword">covariant</span> <span class="token class-name">WaterMarkPainter</span> oldPainter<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/// 文本水印画笔</span>
<span class="token keyword">class</span> <span class="token class-name">TextWaterMarkPainter</span> <span class="token keyword">extends</span> <span class="token class-name">WaterMarkPainter</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">TextWaterMarkPainter</span><span class="token punctuation">(</span>
      <span class="token punctuation">{<!-- --></span><span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
      double<span class="token operator">?</span> rotate<span class="token punctuation">,</span>
      <span class="token class-name">EdgeInsets</span><span class="token operator">?</span> padding<span class="token punctuation">,</span>
      <span class="token class-name">TextStyle</span><span class="token operator">?</span> textStyle<span class="token punctuation">,</span>
      required <span class="token keyword">this</span><span class="token punctuation">.</span>text<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>textDirection <span class="token operator">=</span> <span class="token class-name">TextDirection</span><span class="token punctuation">.</span>ltr<span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">:</span> <span class="token keyword">assert</span><span class="token punctuation">(</span>rotate <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> rotate <span class="token operator">&gt;=</span> <span class="token operator">-</span><span class="token number">90</span> <span class="token operator">&amp;&amp;</span> rotate <span class="token operator">&lt;=</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rotate <span class="token operator">=</span> rotate <span class="token operator">?</span><span class="token operator">?</span> <span class="token number">0</span><span class="token punctuation">,</span>
        padding <span class="token operator">=</span> padding <span class="token operator">?</span><span class="token operator">?</span> <span class="token keyword">const</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        textStyle <span class="token operator">=</span> textStyle <span class="token operator">?</span><span class="token operator">?</span>
            <span class="token keyword">const</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
              color<span class="token punctuation">:</span> <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">fromARGB</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              fontSize<span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

  double rotate<span class="token punctuation">;</span> <span class="token comment">// 文本旋转的度数，是角度不是弧度</span>
  <span class="token class-name">TextStyle</span> textStyle<span class="token punctuation">;</span> <span class="token comment">// 文本样式</span>
  <span class="token class-name">EdgeInsets</span> padding<span class="token punctuation">;</span> <span class="token comment">// 文本的 padding</span>
  <span class="token class-name">String</span> text<span class="token punctuation">;</span> <span class="token comment">// 文本</span>
  <span class="token class-name">TextDirection</span> textDirection<span class="token punctuation">;</span>
 
  <span class="token comment">// Flutter 提供了一个专门用于绘制文本的画笔 TextPainter </span>
  <span class="token metadata function">@override</span>
  <span class="token class-name">Size</span> <span class="token function">paintUnit</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> double devicePixelRatio<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//根据屏幕 devicePixelRatio 对文本样式中长度相关的一些值乘以devicePixelRatio</span>
    <span class="token keyword">final</span> _textStyle <span class="token operator">=</span> <span class="token function">_handleTextStyle</span><span class="token punctuation">(</span>devicePixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> _padding <span class="token operator">=</span> padding <span class="token operator">*</span> devicePixelRatio<span class="token punctuation">;</span>

    <span class="token comment">//构建文本画笔</span>
    <span class="token class-name">TextPainter</span> painter <span class="token operator">=</span> <span class="token class-name">TextPainter</span><span class="token punctuation">(</span>
      textDirection<span class="token punctuation">:</span> <span class="token class-name">TextDirection</span><span class="token punctuation">.</span>ltr<span class="token punctuation">,</span>
      textScaleFactor<span class="token punctuation">:</span> devicePixelRatio<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//添加文本和样式</span>
    painter<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token class-name">TextSpan</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> text<span class="token punctuation">,</span> style<span class="token punctuation">:</span> _textStyle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//对文本进行布局</span>
    painter<span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//文本占用的真实宽度</span>
    <span class="token keyword">final</span> textWidth <span class="token operator">=</span> painter<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    <span class="token comment">//文本占用的真实高度</span>
    <span class="token keyword">final</span> textHeight <span class="token operator">=</span> painter<span class="token punctuation">.</span>height<span class="token punctuation">;</span>

    <span class="token comment">// 将弧度转化为度数</span>
    <span class="token keyword">final</span> radians <span class="token operator">=</span> math<span class="token punctuation">.</span>pi <span class="token operator">*</span> rotate <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>

    <span class="token comment">//通过三角函数计算旋转后的位置和size</span>
    <span class="token keyword">final</span> orgSin <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>radians<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> sin <span class="token operator">=</span> orgSin<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> cos <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>radians<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> width <span class="token operator">=</span> textWidth <span class="token operator">*</span> cos<span class="token punctuation">;</span>
    <span class="token keyword">final</span> height <span class="token operator">=</span> textWidth <span class="token operator">*</span> sin<span class="token punctuation">;</span>
    <span class="token keyword">final</span> adjustWidth <span class="token operator">=</span> textHeight <span class="token operator">*</span> sin<span class="token punctuation">;</span>
    <span class="token keyword">final</span> adjustHeight <span class="token operator">=</span> textHeight <span class="token operator">*</span> cos<span class="token punctuation">;</span>

    <span class="token comment">// 为什么要平移？ </span>
    <span class="token comment">// 如果不限平移，就会导致旋转之后一部分内容的位置跑在画布之外了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>orgSin <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 旋转角度为正</span>
      canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>
        adjustWidth <span class="token operator">+</span> _padding<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
        _padding<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 旋转角度为负</span>
      canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>
        _padding<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
        height <span class="token operator">+</span> _padding<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    canvas<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>radians<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 绘制文本</span>
    painter<span class="token punctuation">.</span><span class="token function">paint</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> <span class="token class-name">Offset</span><span class="token punctuation">.</span>zero<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回水印单元所占的真实空间大小（需要加上padding）</span>
    <span class="token keyword">return</span> <span class="token class-name">Size</span><span class="token punctuation">(</span>
      width <span class="token operator">+</span> adjustWidth <span class="token operator">+</span> _padding<span class="token punctuation">.</span>horizontal<span class="token punctuation">,</span>
      height <span class="token operator">+</span> adjustHeight <span class="token operator">+</span> _padding<span class="token punctuation">.</span>vertical<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 
 
  <span class="token class-name">TextStyle</span> <span class="token function">_handleTextStyle</span><span class="token punctuation">(</span>double devicePixelRatio<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> style <span class="token operator">=</span> textStyle<span class="token punctuation">;</span>
    double <span class="token function">_scale</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> attr <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token punctuation">:</span> devicePixelRatio<span class="token punctuation">;</span>
    <span class="token keyword">return</span> style<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>
      decorationThicknessFactor<span class="token punctuation">:</span> <span class="token function">_scale</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>decorationThickness<span class="token punctuation">)</span><span class="token punctuation">,</span>
      letterSpacingFactor<span class="token punctuation">:</span> <span class="token function">_scale</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>letterSpacing<span class="token punctuation">)</span><span class="token punctuation">,</span>
      wordSpacingFactor<span class="token punctuation">:</span> <span class="token function">_scale</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>wordSpacing<span class="token punctuation">)</span><span class="token punctuation">,</span>
      heightFactor<span class="token punctuation">:</span> <span class="token function">_scale</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  bool <span class="token function">shouldRepaint</span><span class="token punctuation">(</span><span class="token class-name">TextWaterMarkPainter</span> oldPainter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> oldPainter<span class="token punctuation">.</span>rotate <span class="token operator">!=</span> rotate <span class="token operator">||</span>
        oldPainter<span class="token punctuation">.</span>text <span class="token operator">!=</span> text <span class="token operator">||</span>
        oldPainter<span class="token punctuation">.</span>padding <span class="token operator">!=</span> padding <span class="token operator">||</span>
        oldPainter<span class="token punctuation">.</span>textDirection <span class="token operator">!=</span> textDirection <span class="token operator">||</span>
        oldPainter<span class="token punctuation">.</span>textStyle <span class="token operator">!=</span> textStyle<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>测试代码：</strong></p> 
<pre><code class="prism language-dart"><span class="token metadata function">@override</span>
<span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token function">wTextWaterMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Widget</span> <span class="token function">wTextWaterMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token class-name">Stack</span><span class="token punctuation">(</span>
    children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token function">wPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token class-name">IgnorePointer</span><span class="token punctuation">(</span>
        child<span class="token punctuation">:</span> <span class="token class-name">WaterMark</span><span class="token punctuation">(</span>
          painter<span class="token punctuation">:</span> <span class="token class-name">TextWaterMarkPainter</span><span class="token punctuation">(</span>
            text<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'Flutter 中国 @wendux'</span></span><span class="token punctuation">,</span>
            textStyle<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
              fontSize<span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
              fontWeight<span class="token punctuation">:</span> <span class="token class-name">FontWeight</span><span class="token punctuation">.</span>w200<span class="token punctuation">,</span>
              color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>black38<span class="token punctuation">,</span> <span class="token comment">//为了水印能更清晰一些，颜色深一点</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            rotate<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 旋转 -20 度</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Widget</span> <span class="token function">wPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token class-name">Center</span><span class="token punctuation">(</span>
    child<span class="token punctuation">:</span> <span class="token class-name">ElevatedButton</span><span class="token punctuation">(</span>
      child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'按钮'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      onPressed<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'tab'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">//省略无关代码</span>
</code></pre> 
<p>运行效果：</p> 
<p><img src="https://images2.imgbox.com/2b/7c/TZcdsMWm_o.png" alt="在这里插入图片描述" width="350"></p> 
<h4><a id="_2435"></a>单元水印画笔—交错文本水印</h4> 
<p>拥有交错效果的文本水印比较常见，效果如图：</p> 
<p><img src="https://images2.imgbox.com/30/5a/IYEW0uQS_o.png" alt="在这里插入图片描述" width="350"></p> 
<p>要实现这样的效果按照之前思路，我们只需要将单元水印绘制为图中红色框圈出来的部分即可，可以看到这个单元水印和之前<code>TextWaterMarkPainter</code> 有一点不同，即 <code>TextWaterMarkPainter</code> 只能绘制单个文本，而现在我们需要绘制两个问文本，且两个文本沿竖直方向排列，且两个文本左边起始位置有偏移。</p> 
<p>我们想想如何实现？直接能想到的是继续在 <code>TextWaterMarkPainter</code> 的 <code>paintUnit</code> 方法后面加逻辑，但这样会带来两个问题：</p> 
<ol><li><code>TextWaterMarkPainter</code> 的配置参数会变多。</li><li><code>TextWaterMarkPainter</code> 的 <code>paintUnit</code> 已经很复杂了，如果再往里面加代码，后期的理解成本和维护成本会比较大，心智负担重。</li></ol> 
<p>不能直接修改 <code>TextWaterMarkPainter</code> 实现，但我们又想复用 <code>TextWaterMarkPainter</code> 的逻辑，这时可以使用代理模式，即我们新建一个<code>WaterMarkPainter</code>，在里面来调用 <code>TextWaterMarkPainter</code> 方法即可。</p> 
<pre><code class="prism language-dart"><span class="token comment">/// 交错文本水印画笔，可以在水平或垂直方向上组合两个文本水印，</span>
<span class="token comment">/// 通过给第二个文本水印指定不同的 padding 来实现交错效果。</span>
<span class="token keyword">class</span> <span class="token class-name">StaggerTextWaterMarkPainter</span> <span class="token keyword">extends</span> <span class="token class-name">WaterMarkPainter</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">StaggerTextWaterMarkPainter</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    required <span class="token keyword">this</span><span class="token punctuation">.</span>text<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>padding1<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>padding2 <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rotate<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>textStyle<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>staggerAxis <span class="token operator">=</span> <span class="token class-name">Axis</span><span class="token punctuation">.</span>vertical<span class="token punctuation">,</span> 
    <span class="token class-name">String</span><span class="token operator">?</span> text2<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> text2 <span class="token operator">=</span> text2 <span class="token operator">?</span><span class="token operator">?</span> text<span class="token punctuation">;</span>
  <span class="token comment">//第一个文本</span>
  <span class="token class-name">String</span> text<span class="token punctuation">;</span>
  <span class="token comment">//第二个文本，如果不指定则和第二个文本相同</span>
  <span class="token class-name">String</span> text2<span class="token punctuation">;</span>
  <span class="token comment">//我们限制两个文本的旋转角度和文本样式必须相同，否则显得太乱了</span>
  double<span class="token operator">?</span> rotate<span class="token punctuation">;</span>
  <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>TextStyle</span><span class="token operator">?</span> textStyle<span class="token punctuation">;</span>
  <span class="token comment">//第一个文本的padding</span>
  <span class="token class-name">EdgeInsets</span><span class="token operator">?</span> padding1<span class="token punctuation">;</span>
  <span class="token comment">//第二个文本的padding</span>
  <span class="token class-name">EdgeInsets</span> padding2<span class="token punctuation">;</span>
  <span class="token comment">// 两个文本沿哪个方向排列</span>
  <span class="token class-name">Axis</span> staggerAxis<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Size</span> <span class="token function">paintUnit</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> double devicePixelRatio<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">TextWaterMarkPainter</span> painter <span class="token operator">=</span> <span class="token class-name">TextWaterMarkPainter</span><span class="token punctuation">(</span>
      text<span class="token punctuation">:</span> text<span class="token punctuation">,</span>
      padding<span class="token punctuation">:</span> padding1<span class="token punctuation">,</span>
      rotate<span class="token punctuation">:</span> rotate <span class="token operator">?</span><span class="token operator">?</span> <span class="token number">0</span><span class="token punctuation">,</span>
      textStyle<span class="token punctuation">:</span> textStyle<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 绘制第一个文本水印前保存画布状态，因为在绘制过程中可能会平移或旋转画布</span>
    canvas<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 绘制第一个文本水印</span>
    <span class="token keyword">final</span> size1 <span class="token operator">=</span> painter<span class="token punctuation">.</span><span class="token function">paintUnit</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> devicePixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 绘制完毕后恢复画布状态。</span>
    canvas<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 确定交错方向</span>
    bool vertical <span class="token operator">=</span> staggerAxis <span class="token operator">==</span> <span class="token class-name">Axis</span><span class="token punctuation">.</span>vertical<span class="token punctuation">;</span>
    <span class="token comment">// 将 Canvas平移至第二个文本水印的起始绘制点</span>
    canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>vertical <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> size1<span class="token punctuation">.</span>width<span class="token punctuation">,</span> vertical <span class="token operator">?</span> size1<span class="token punctuation">.</span>height <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置第二个文本水印的 padding 和 text2</span>
    painter
      <span class="token punctuation">.</span><span class="token punctuation">.</span>padding <span class="token operator">=</span> padding2
      <span class="token punctuation">.</span><span class="token punctuation">.</span>text <span class="token operator">=</span> text2<span class="token punctuation">;</span>
    <span class="token comment">// 绘制第二个文本水印</span>
    <span class="token keyword">final</span> size2 <span class="token operator">=</span> painter<span class="token punctuation">.</span><span class="token function">paintUnit</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> devicePixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回两个文本水印所占用的总大小</span>
    <span class="token keyword">return</span> <span class="token class-name">Size</span><span class="token punctuation">(</span>
      vertical <span class="token operator">?</span> math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>size1<span class="token punctuation">.</span>width<span class="token punctuation">,</span> size2<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token punctuation">:</span> size1<span class="token punctuation">.</span>width <span class="token operator">+</span> size2<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
      vertical
          <span class="token operator">?</span> size1<span class="token punctuation">.</span>height <span class="token operator">+</span> size2<span class="token punctuation">.</span>height
          <span class="token punctuation">:</span> math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>size1<span class="token punctuation">.</span>height<span class="token punctuation">,</span> size2<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  bool <span class="token function">shouldRepaint</span><span class="token punctuation">(</span><span class="token class-name">StaggerTextWaterMarkPainter</span> oldPainter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> oldPainter<span class="token punctuation">.</span>rotate <span class="token operator">!=</span> rotate <span class="token operator">||</span>
        oldPainter<span class="token punctuation">.</span>text <span class="token operator">!=</span> text <span class="token operator">||</span>
        oldPainter<span class="token punctuation">.</span>text2 <span class="token operator">!=</span> text2 <span class="token operator">||</span>
        oldPainter<span class="token punctuation">.</span>staggerAxis <span class="token operator">!=</span> staggerAxis <span class="token operator">||</span>
        oldPainter<span class="token punctuation">.</span>padding1 <span class="token operator">!=</span> padding1 <span class="token operator">||</span>
        oldPainter<span class="token punctuation">.</span>padding2 <span class="token operator">!=</span> padding2 <span class="token operator">||</span>
        oldPainter<span class="token punctuation">.</span>textDirection <span class="token operator">!=</span> textDirection <span class="token operator">||</span>      
        oldPainter<span class="token punctuation">.</span>textStyle <span class="token operator">!=</span> textStyle<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面代码有三点需要注意：</p> 
<ol><li>在绘制第一个文本之前需要调用 <code>canvas.save</code> 保存画布状态，因为在绘制过程中可能会平移或旋转画布，在绘制第二个文本之前恢复画布状态，并需要将 <code>Canvas</code>平移至第二个文本水印的起始绘制点。</li><li>两个文本可以沿水平方向排列，也可以沿竖直方向排列，不同的排列规则会影响最终水印单元的大小。</li><li>交错的偏移通过 <code>padding2</code> 来指定。</li></ol> 
<p>测试代码：</p> 
<pre><code class="prism language-dart"><span class="token class-name">Widget</span> <span class="token function">wStaggerTextWaterMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token class-name">Stack</span><span class="token punctuation">(</span>
    children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token function">wPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token class-name">IgnorePointer</span><span class="token punctuation">(</span>
        child<span class="token punctuation">:</span> <span class="token class-name">WaterMark</span><span class="token punctuation">(</span>
          painter<span class="token punctuation">:</span> <span class="token class-name">StaggerTextWaterMarkPainter</span><span class="token punctuation">(</span>
            text<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'《Flutter实战》'</span></span><span class="token punctuation">,</span>
            text2<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'wendux'</span></span><span class="token punctuation">,</span>
            textStyle<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
              color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>black38<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            padding2<span class="token punctuation">:</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">only</span><span class="token punctuation">(</span>left<span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 第二个文本左边向右偏移 40</span>
            rotate<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_2555"></a>对水印应用偏移</h4> 
<p>我们实现的两个文本水印画笔能对单元水印指定<code>padding</code>，但是如果我们需要对整个水印组件应用偏移效果呢？比如期望下图所示的效果：让 <code>WaterMark</code> 的整个背景向左平移了<code>30</code>像素，可以看到第一列的水印文本只显示了一部分。</p> 
<p><img src="https://images2.imgbox.com/77/f5/wdjxu6Ee_o.png" alt="在这里插入图片描述" width="350"></p> 
<p>首先，我们不能在文本水印画笔中应用偏移，因为水印画笔画的是单元水印，如果我们绘制的单元水印只显示了部分文本，则单元水印重复时每个重复区域也都只显示部分文本。所以我们得对 <code>WaterMark</code> 的背景整体做一个偏移，这时想必读者应该想到了 <code>Transform</code> 组件，OK，那我们先用 <code>Transform</code> 组件来试试。</p> 
<pre><code class="prism language-dart"><span class="token class-name">Transform</span><span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>
  offset<span class="token punctuation">:</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//向做偏移30像素</span>
  child<span class="token punctuation">:</span> <span class="token class-name">WaterMark</span><span class="token punctuation">(</span>
    painter<span class="token punctuation">:</span> <span class="token class-name">TextWaterMarkPainter</span><span class="token punctuation">(</span>
      text<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'Flutter 中国 @wendux'</span></span><span class="token punctuation">,</span>
      textStyle<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
        color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>black38<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      rotate<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> 
<p>运行效果：</p> 
<p><img src="https://images2.imgbox.com/32/36/7r8GWRKU_o.png" alt="在这里插入图片描述" width="350"></p> 
<p>可以发现虽然整体向做偏移了，但是右边出现了空白，这时因为 <code>WaterMark</code> 占用的空间本来就是和屏幕等宽的，所以它绘制时的区域也就和屏幕一样大，而<code>Transform.translate</code> 的作用相当于是在绘制时将绘制的原点向做平移了 <code>30</code> 像素，所以右边就出现了空白。</p> 
<p>既然如此，那如果能让 <code>WaterMark</code> 的绘制区域超过屏幕宽度 <code>30</code> 像素，这样平移后不就可以了么？这个思路是对的，我们知道 <code>WaterMark</code> 中是通过 <code>DecoratedBox</code> 去绘制的背景，但我们不能去修改 <code>DecoratedBox</code> 的绘制逻辑，如果将 <code>DecoratedBox</code> 相关代码拷贝一份出来修改，这样后期的维护成本就很大，所以直接修改 <code>DecoratedBox</code> 的方法不可取。</p> 
<p><strong>1. 方案一：使用可滚动组件来应用偏移</strong></p> 
<p>我们知道大多数组件的绘制区域是和自身布局大小是相同的，那么我们能不能强制让 <code>WaterMark</code> 的宽度超出屏幕宽度<code>30</code> 像素呢？当然可以，可滚动组件不都是这个原理么！那么肯定有一个方法能行的通，即强制指定<code>WaterMark</code>的宽度比屏幕宽度大<code>30</code>，然后用一个 <code>SingleChildScrollView</code>包裹：</p> 
<pre><code class="prism language-dart"><span class="token class-name">Widget</span> <span class="token function">wTextWaterMarkWithOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token class-name">Stack</span><span class="token punctuation">(</span>
    children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token function">wPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token class-name">IgnorePointer</span><span class="token punctuation">(</span>
        child<span class="token punctuation">:</span> <span class="token class-name">LayoutBuilder</span><span class="token punctuation">(</span>builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> constraints<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">print</span><span class="token punctuation">(</span>constraints<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token class-name">SingleChildScrollView</span><span class="token punctuation">(</span>
            scrollDirection<span class="token punctuation">:</span> <span class="token class-name">Axis</span><span class="token punctuation">.</span>horizontal<span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token class-name">Transform</span><span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>
              offset<span class="token punctuation">:</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              child<span class="token punctuation">:</span> <span class="token class-name">SizedBox</span><span class="token punctuation">(</span>
                <span class="token comment">// constraints.maxWidth 为屏幕宽度，+30 像素</span>
                width<span class="token punctuation">:</span> constraints<span class="token punctuation">.</span>maxWidth <span class="token operator">+</span> <span class="token number">30</span><span class="token punctuation">,</span>
                height<span class="token punctuation">:</span> constraints<span class="token punctuation">.</span>maxHeight<span class="token punctuation">,</span>
                child<span class="token punctuation">:</span> <span class="token class-name">WaterMark</span><span class="token punctuation">(</span>
                  painter<span class="token punctuation">:</span> <span class="token class-name">TextWaterMarkPainter</span><span class="token punctuation">(</span>
                    text<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'Flutter 中国 @wendux'</span></span><span class="token punctuation">,</span>
                    textStyle<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
                      color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>black38<span class="token punctuation">,</span>
                    <span class="token punctuation">)</span><span class="token punctuation">,</span>
                    rotate<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>
                  <span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面的代码可以实现我们期望的效果。</p> 
<p>需要说明的是因为 <code>SingleChildScrollView</code> 被 <code>IgnorePointer</code> 包裹着，所以它是接收不到事件的，所以不会受用户滑动的干扰。</p> 
<p>我们知道 <code>SingleChildScrollView</code> 内部要创建<code>Scrollable</code> 和 <code>Viewport</code> 对象，而在这个场景下 <code>SingleChildScrollView</code> 是不会响应事件的，所以创建 <code>Scrollable</code> 就属于多余的开销，我们需要探索一种更优的方案。</p> 
<p><strong>2. 方案二：使用 FittedBox 来应用偏移</strong></p> 
<p>我们能否先通过 <code>UnconstrainedBox</code> 取消父组件对子组件大小的约束，然后通过 <code>SizedBox</code> 指定 <code>WaterMark</code> 宽度比屏幕长 <code>30</code> 像素 来实现，比如：</p> 
<pre><code class="prism language-dart"><span class="token class-name">LayoutBuilder</span><span class="token punctuation">(</span>
  builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> constraints<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">UnconstrainedBox</span><span class="token punctuation">(</span> <span class="token comment">// 取消父组件对子组件大小的约束</span>
      alignment<span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">.</span>topRight<span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token class-name">SizedBox</span><span class="token punctuation">(</span>
        <span class="token comment">//指定 WaterMark 宽度比屏幕长 30 像素</span>
        width<span class="token punctuation">:</span> constraints<span class="token punctuation">.</span>maxWidth <span class="token operator">+</span> <span class="token number">30</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> constraints<span class="token punctuation">.</span>maxHeight<span class="token punctuation">,</span>
        child<span class="token punctuation">:</span> <span class="token class-name">WaterMark</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> 
<p>运行效果：</p> 
<p><img src="https://images2.imgbox.com/ee/e8/KAmuK6VC_o.png" alt="在这里插入图片描述" width="350"></p> 
<p>我们看到，左边出现了一个溢出提示条，这是因为 <code>UnconstrainedBox</code> 虽然在其子组件布局时可以取消约束（子组件可以为无限大），但是 <code>UnconstrainedBox</code> 自身是受其父组件约束的，所以当 <code>UnconstrainedBox</code> 随着其子组件变大后，如果 <code>UnconstrainedBox</code> 的大小超过它父组件大小时，就导致了溢出。</p> 
<p>如果没有这个溢出提示条，则我们想要的偏移效果实际上已经实现了！偏移的实现原理是我们指定了屏幕右对齐，因为子组件的右边界和父组件右边界对齐时，超出的 <code>30</code> 像素宽度就会在父组件的左边界之外，从而就实现了我们期望的效果。我们知道在 <code>Release</code> 模式下是不会绘制溢出提示条的，因为溢出条的绘制逻辑是在 <code>assert</code> 函数中，比如：</p> 
<pre><code class="prism language-dart"><span class="token comment">// Display the overflow indicator.</span>
<span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">paintOverflowIndicator</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> _overflowContainerRect<span class="token punctuation">,</span> _overflowChildRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>所以在 <code>Release</code> 模式下上面代码也不会有问题，但是我们还是不应该使用这种方法，因为既然有提示，则这就代表 <code>UnconstrainedBox</code> 子元素溢出是不被预期的行为。</p> 
<p>原因搞清楚后，我们解决思路就是：在取消约束的同时不要让组件大小超出父组件的空间即可。而我们之前章节介绍的 <code>FittedBox</code> 组件，它可以取消父组件对子组件的约束并同时可以让其子组件适配 <code>FittedBox</code> 父组件的大小，正好符合我们的要求，下面我们修改一下代码：</p> 
<pre><code class="prism language-dart"> <span class="token class-name">LayoutBuilder</span><span class="token punctuation">(</span>
  builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> constraints<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">FittedBox</span><span class="token punctuation">(</span> <span class="token comment">//FittedBox会取消父组件对子组件的约束</span>
      alignment<span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">.</span>topRight<span class="token punctuation">,</span> <span class="token comment">// 通过对齐方式来实现平移效果</span>
      fit<span class="token punctuation">:</span> <span class="token class-name">BoxFit</span><span class="token punctuation">.</span>none<span class="token punctuation">,</span><span class="token comment">//不进行任何适配处理</span>
      child<span class="token punctuation">:</span> <span class="token class-name">SizedBox</span><span class="token punctuation">(</span>
        <span class="token comment">//指定 WaterMark 宽度比屏幕长 30 像素</span>
        width<span class="token punctuation">:</span> constraints<span class="token punctuation">.</span>maxWidth <span class="token operator">+</span> <span class="token number">30</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> constraints<span class="token punctuation">.</span>maxHeight<span class="token punctuation">,</span>
        child<span class="token punctuation">:</span> <span class="token class-name">WaterMark</span><span class="token punctuation">(</span>
          painter<span class="token punctuation">:</span> <span class="token class-name">TextWaterMarkPainter</span><span class="token punctuation">(</span>
            text<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'Flutter 中国 @wendux'</span></span><span class="token punctuation">,</span>
            textStyle<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
              color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>black38<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            rotate<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> 
<p>运行后，能实现我们预期的效果。</p> 
<p><code>FittedBox</code> 主要的使用场景是对子组件进行一些缩放、拉升等以适配父组件的空间，而在本例的场景中我们并没有用到这个功能（适配方式指定了 <code>BoxFit.none</code> ），还是有点杀鸡用牛刀的感觉，那还有其他更合适的组件来解决这个问题吗？答案是有，<code>OverflowBox</code> ！</p> 
<p><strong>方案三：使用 OverflowBox 来应用偏移</strong></p> 
<p><code>OverflowBox</code> 和 <code>UnconstrainedBox</code> 相同的是可以取消父组件对子组件的约束，但不同的是 <strong><code>OverflowBox</code> 自身大小不会随着子组件大小而变化</strong>，它的大小只取决于其父组件的约束（约束为 <code>constraints.biggest</code>），即在满足父组件约束的前提下会尽可能大。我们封装一个 <code>TranslateWithExpandedPaintingArea</code> 组件来包裹 <code>WaterMark</code> 组件：</p> 
<pre><code class="prism language-dart"><span class="token keyword">class</span> <span class="token class-name">TranslateWithExpandedPaintingArea</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token class-name">TranslateWithExpandedPaintingArea</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
    required <span class="token keyword">this</span><span class="token punctuation">.</span>offset<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clipBehavior <span class="token operator">=</span> <span class="token class-name">Clip</span><span class="token punctuation">.</span>none<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Widget</span><span class="token operator">?</span> child<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Offset</span> offset<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Clip</span> clipBehavior<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">LayoutBuilder</span><span class="token punctuation">(</span>
      builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> constraints<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> dx <span class="token operator">=</span> offset<span class="token punctuation">.</span>dx<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> dy <span class="token operator">=</span> offset<span class="token punctuation">.</span>dy<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Widget</span> widget <span class="token operator">=</span> <span class="token class-name">OverflowBox</span><span class="token punctuation">(</span>
          <span class="token comment">//平移多少，则子组件相应轴的长度增加多少</span>
          minWidth<span class="token punctuation">:</span> constraints<span class="token punctuation">.</span>minWidth <span class="token operator">+</span> dx<span class="token punctuation">,</span>
          maxWidth<span class="token punctuation">:</span> constraints<span class="token punctuation">.</span>maxWidth <span class="token operator">+</span> dx<span class="token punctuation">,</span>
          minHeight<span class="token punctuation">:</span> constraints<span class="token punctuation">.</span>minHeight <span class="token operator">+</span> dy<span class="token punctuation">,</span>
          maxHeight<span class="token punctuation">:</span> constraints<span class="token punctuation">.</span>maxHeight <span class="token operator">+</span> dy<span class="token punctuation">,</span>
          alignment<span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">(</span>
            <span class="token comment">// 不同方向的平移，要指定不同的对齐方式</span>
            offset<span class="token punctuation">.</span>dx <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            offset<span class="token punctuation">.</span>dy <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          child<span class="token punctuation">:</span> child<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//超出组件布局空间的部分要剪裁掉</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clipBehavior <span class="token operator">!=</span> <span class="token class-name">Clip</span><span class="token punctuation">.</span>none<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          widget <span class="token operator">=</span> <span class="token class-name">ClipRect</span><span class="token punctuation">(</span>clipBehavior<span class="token punctuation">:</span> clipBehavior<span class="token punctuation">,</span> child<span class="token punctuation">:</span> widget<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> widget<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面代码有三点需要说明：</p> 
<ol><li>会根据用户指定的偏移来动态给子组件宽高增加相应的值。</li><li>我们需要根据用户指定的偏移来动态调整 <code>OverflowBox</code> 的对齐方式，比如要向左平移时，<code>OverflowBox</code> 就必须右对齐，因为右对齐后超出父容器的部分会在左边界之外，这就是我们想要的效果，如果我们没有右对齐而是左对齐，则超出屏幕的部分本来就在右边界之外，这不符合预期。</li><li>超出边界的内容默认会显示，当然本例中水印组件大小和屏幕剩余显示空间一样大，所以超出后就不会显示，但如果我们给水印组件指定一个较小的大小，就可以看到超出之后的内容了，因此，我们定义了一个剪裁的配置参数，使用者可以根据实际情况决定是否进行剪裁。</li></ol> 
<p>所以最终的调用代码就是：</p> 
<pre><code class="prism language-dart"><span class="token class-name">Widget</span> <span class="token function">wTextWaterMarkWithOffset2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token class-name">Stack</span><span class="token punctuation">(</span>
    children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token function">wPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token class-name">IgnorePointer</span><span class="token punctuation">(</span>
        child<span class="token punctuation">:</span> <span class="token class-name">TranslateWithExpandedPaintingArea</span><span class="token punctuation">(</span>
          offset<span class="token punctuation">:</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          child<span class="token punctuation">:</span> <span class="token class-name">WaterMark</span><span class="token punctuation">(</span>
            painter<span class="token punctuation">:</span> <span class="token class-name">TextWaterMarkPainter</span><span class="token punctuation">(</span>
              text<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'Flutter 中国 @wendux'</span></span><span class="token punctuation">,</span>
              textStyle<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
                color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>black38<span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
              rotate<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行后，能实现我们预期的效果。</p> 
<hr> 
<p>参考：<a href="https://book.flutterchina.club/" rel="nofollow">《Flutter实战·第二版》</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fcb770aa0172356f2663e76ac4bda092/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">centos下载内容失败---连接不上网络问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b673d8cef3a01c2621ebbb3794b7db3e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C#/.Net开发chatGPT、openAI的简单步骤</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>