<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mqtt安装及部署手册（包含与WebSocket通信配置） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Mqtt安装及部署手册（包含与WebSocket通信配置）" />
<meta property="og:description" content="下载并安装MQTT 1.首先搭建起MQTT服务
1.1安装mosquitto，mosquitto是开源的MQTT代理服务器，它的Windows安装包地址：https://mosquitto.org/download/
这里建议下载2.0.11版本，个别版本和Socket通信会出现问题，这个是个坑点，看下图； 1.2 安装完成后，去安装目录下找到mosquitt.conf 文件，记事本方式打开，配置参数；
*这里的8888，mqtt通信端口，9001是WebSocket协议端口，建议额外配置一下匿名访问：allow_anonymous true；
1.3 接下来启动Mqtt服务；
执行：mosquitto_passwd.exe -c pwfile.example -u vic
设置用户名：admin 设置密码：123456
配置文件检查：
mosquitto.exe -c mosquitto.conf
未报错说明配置正确（卡着不动了，重新打开cmd，定位到安装目录，执行下面的命令即可）
端口启动
默认端口：8888
启动：mosquitto.exe
指定端口启动：mosquitto.exe -p 8888
下面就可以启动订阅者和发布者了，上面的启动窗口不要关闭哦，下面分别再打开两个cmd窗口；
①订阅者启动
-u是用户名，-P是密码，-t是主题，-h是ip，-p是端口号
mosquitto_sub.exe -h 127.0.0.1 -p 8888 -t topic -u admin -P 123456
② 发布者
mosquitto_pub.exe -h 127.0.0.1 -p 8888 -u admin -P 123456 -t topic -m “hello world 123456”
这里的主题 “topic” 两方必须保持一致，否则收不到信息
若执行发布者和订阅者命令时，若出现*“由于目标计算机积极拒绝，无法连接”**，大概率是权限问题，设一下mosquitto.conf文件的权限，这个是个坑点；
用命令：mosquitto -c mosquitto.conf -v
重启一下服务即可；" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2a622dab86c575423fb27e1acd896c3e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-26T16:47:29+08:00" />
<meta property="article:modified_time" content="2022-06-26T16:47:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Mqtt安装及部署手册（包含与WebSocket通信配置）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="MQTT_0"></a>下载并安装MQTT</h2> 
<p>1.首先搭建起MQTT服务</p> 
<p>1.1安装mosquitto，mosquitto是开源的MQTT代理服务器，它的Windows安装包地址：https://mosquitto.org/download/<br> <img src="https://images2.imgbox.com/1b/e3/UmCQV76D_o.png" alt="* 这里建议下载2.0.11版本，个别版本和Socket通信会出现问题"></p> 
<ul><li>这里建议下载2.0.11版本，个别版本和Socket通信会出现问题，<strong>这个是个坑点</strong>，看下图；</li><li><img src="https://images2.imgbox.com/e9/4b/9ISn884W_o.png" alt="在这里插入图片描述"></li></ul> 
<p>1.2 安装完成后，去安装目录下找到mosquitt.conf 文件，记事本方式打开，配置参数；<br> <img src="https://images2.imgbox.com/8e/f9/GkN8pFaC_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d5/8b/ydWgZ8t6_o.png" alt="在这里插入图片描述"></p> 
<p>*这里的8888，mqtt通信端口，9001是WebSocket协议端口，建议额外配置一下匿名访问：allow_anonymous true；<br> <img src="https://images2.imgbox.com/fc/8e/vacxBdxl_o.png" alt="在这里插入图片描述"></p> 
<p>1.3 接下来启动Mqtt服务；<br> <img src="https://images2.imgbox.com/55/5b/RlY1tPUi_o.png" alt="打开cmd窗口，定位到安装目录下"><br> 执行：mosquitto_passwd.exe -c pwfile.example -u vic</p> 
<p>设置用户名：admin 设置密码：123456</p> 
<p>配置文件检查：<br> mosquitto.exe -c mosquitto.conf<br> 未报错说明配置正确（卡着不动了，重新打开cmd，定位到安装目录，执行下面的命令即可）</p> 
<p>端口启动</p> 
<p>默认端口：8888</p> 
<p>启动：mosquitto.exe</p> 
<p>指定端口启动：mosquitto.exe -p 8888</p> 
<p>下面就可以启动订阅者和发布者了，上面的启动窗口不要关闭哦，下面分别再打开两个cmd窗口；</p> 
<p>①订阅者启动</p> 
<p>-u是用户名，-P是密码，-t是主题，-h是ip，-p是端口号</p> 
<p>mosquitto_sub.exe -h 127.0.0.1 -p 8888 -t topic -u admin -P 123456</p> 
<p>② 发布者</p> 
<p>mosquitto_pub.exe -h 127.0.0.1 -p 8888 -u admin -P 123456 -t topic -m “hello world 123456”</p> 
<p><strong>这里的主题 “topic” 两方必须保持一致，否则收不到信息</strong></p> 
<p><em>若执行发布者和订阅者命令时，若出现</em>*“由于目标计算机积极拒绝，无法连接”**，大概率是权限问题，设一下mosquitto.conf文件的权限，<strong>这个是个坑点；</strong><br> <img src="https://images2.imgbox.com/16/b4/OmNdpfl6_o.png" alt=""><br> 用命令：mosquitto -c mosquitto.conf -v<br> 重启一下服务即可；</p> 
<p>上面配置完，就可以模拟MQTT正常通信了；</p> 
<h2><a id="Winform_58"></a>Winform采集信息（发布者）</h2> 
<p>1.安装Nuget包，M2Mqtt</p> 
<p>下面直接贴部分源码</p> 
<p>public class ProgramName<br> {<!-- --><br> // sub后的操作<br> static void client_MqttMsgSubscribed(object sender, MqttMsgSubscribedEventArgs e)<br> {<!-- --><br> Console.Write(“订阅完成!”);</p> 
<pre><code>    }
    // 接受消息后的操作
    static void client_MqttMsgPublishReceived(object sender, MqttMsgPublishEventArgs e)
    {
        Console.Write("接收到消息!");

    }
    // 发布消息后的操作
    static void client_MqttMsgPublished(object sender, MqttMsgPublishedEventArgs e)
    {
        Console.Write("发送完成!");

    }
    // 关闭连接后的操作
    static void client_ConnectionClosed(object sender, EventArgs e)
    {
        Console.Write("关闭后的操作!");

    }
    // 取消sub后的操作
    static void client_MqttMsgUnsubscribed(object sender, MqttMsgUnsubscribedEventArgs e)
    {
        Console.WriteLine("链接关闭"!);
    }


 
 
    static void Main(string[] args)
    {
        string ip = "www.mqqq.com";//或者192.168.1.20 Ip地址
        string user = "admin";
        string pwd = "123456";
        string clientid = Guid.NewGuid().ToString(); // 唯一ID
        string[] topic = new string[] { "topic" };//消息主题，很重要，WebSocket那里要保持一致
             
        byte[] qosLevels = new byte[] { MqttMsgBase.QOS_LEVEL_AT_LEAST_ONCE }; 
        
        MqttClient client = new MqttClient(ip ,8888,false,null,null,MqttSslProtocols.None);//端口号很重要
        client.ProtocolVersion = MqttProtocolVersion.Version_3_1;
        Console.WriteLine(Guid.NewGuid().ToString());
        byte code = client.Connect(clientid,
                                    user, 
                                    pwd,
                                    true, 
                                    60); 
        client.MqttMsgPublishReceived += client_MqttMsgPublishReceived;
        client.MqttMsgSubscribed += client_MqttMsgSubscribed;
        client.MqttMsgUnsubscribed += client_MqttMsgUnsubscribed;
        client.MqttMsgPublished += client_MqttMsgPublished;
        client.ConnectionClosed += client_ConnectionClosed;
        client.Subscribe(topic, qosLevels); 
         string msg1 = “message121221212122”;// message
            byte[] msg = Encoding.UTF8.GetBytes(msg1);//消息必须转一下
            ushort msgId = client.Publish("tt", // topic
                                          msg, 
                                          0, 
                                          false); // 消息发送

        client.Disconnect();
        
    }
}
</code></pre> 
<h2><a id="Web_137"></a>Web端接收信息（订阅者）</h2> 
<p>废话不多说，直接上Demo</p> 
<title>Serial Logger and Plotter</title> 
<div> 
 <label>ws地址：</label> 
 <label>端口号：</label> 
</div> 
<div> 
 <label>消息名称：</label> 
</div> 
<div>
  connect 
 end 
</div> 
<div>
  Received: 
</div> 
<div id="received-data-list"></div> 
<p>// 将在全局初始化一个 mqtt 变量<br> console.log(mqtt)<br> const clientId = ‘mqttjs_’ + Math.random().toString(16).substr(2, 8)；</p> 
<pre><code>&lt;!--线上地址--&gt;
$(function(){
   $("#butConnect").click(function(){
           //const host = 'ws://broker.emqx.io:8083/mqtt'
//const host = 'ws://broker.emqx.io:8083/mqtt'
          //const host = 'ws://broker.mqttdashboard.com:8000/mqtt'
          const host = 'ws://'+$("#mqttip").val()+':'+$("#mqttport").val()+'/mqtt'
</code></pre> 
<p>const options = {<!-- --><br> keepalive: 60,<br> clientId: clientId,<br> protocolId: ‘MQTT’,<br> protocolVersion: 4,<br> clean: true,<br> reconnectPeriod: 1000,<br> connectTimeout: 30 * 1000,<br> will: {<!-- --><br> topic: ‘testopic’,<br> payload: ‘Connection Closed abnormally…!’,<br> qos: 0,<br> retain: false<br> },<br> }<br> console.log(‘正在连接(Connecting mqtt client)’)<br> const client = mqtt.connect(host, options)</p> 
<p>client.on(‘error’, (err) =&gt; {<!-- --><br> console.log('Connection error: ', err)<br> client.end()<br> })</p> 
<p>client.on(‘connect’, () =&gt; {<!-- --><br> console.log(‘连接成功（Client connected）:’ + clientId)<br> // Subscribe<br> //消息名称<br> //client.subscribe(‘testopic’, { qos: 0 })<br> client.subscribe($(“#msname”).val(), { qos: 0 })<br> })</p> 
<p>client.on(‘reconnect’, () =&gt; {<!-- --><br> console.log(‘Reconnecting…’)<br> })<br> //接收消息<br> client.on(‘message’, (topic, message, packet) =&gt; {<!-- --><br> console.log('收到消息：Received Message: ’ + message.toString() + '\nOn topic: ’ + topic)</p> 
<p>$(“#received-data-list”).append(‘收到消息：Received Message: ’ + message.toString() + ‘\nOn topic: ’ + topic);<br> $(“#received-data-list”).append(’<br>’);<br> })<br> });<br> });</p> 
<pre><code>&lt;/script&gt;
</code></pre> 
<p>*<strong><strong>特别注意：</strong></strong></p> 
<p>这个引用很关键；<br> ws 协议下，必须使用上面mqtt的WebSocket端口 9001 ，千万不能错了；<br> 若要用mqtt，请换成const host = ‘mqtt://’+<span class="katex--inline">KaTeX parse error: Expected 'EOF', got '#' at position 3: ("#̲mqttip").val()+…</span>(“#mqttport”).val()+‘/mqtt’；（作者未尝试，请自行探索）</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/53e9a50f21caaa77b00903fbf964e661/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux time.h头文件详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/05ba5a4c633cb3fa96b4142a0cd48ea9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">写给信息学竞赛选手的趣味编程 基于DevC&#43;&#43;的SDL2图形程序设计（五） 三层汉诺塔的简单游戏实现</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>