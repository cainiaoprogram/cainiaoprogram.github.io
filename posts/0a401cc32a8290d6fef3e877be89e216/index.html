<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux 虚拟化技术 KVM - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux 虚拟化技术 KVM" />
<meta property="og:description" content="目录
virt-install 命令创建虚拟机 命令版 半手工
利用 qemu-img命令创建虚拟磁盘
基于已有系统直接创建新的虚拟机启动 复制
​编辑
复制 可以 适用于脚本 可以批量改 内存之类的 克隆没法子改
利用virt-clone克隆实现
半虚拟化设备统一接口virtio
创建 Windows Server 2008 虚拟机
生成Windows Server 2008 镜像模版、
libvirt 架构
快照
#查看虚拟机详细信息
#查看当前启动的虚拟机
#查看所有虚拟机
启动和关闭虚拟机
#列出开机状态虚拟机的UUID和名称
#列出所有虚拟机的UUID和name
查看虚拟机UUID,通过UUID启动关闭虚拟机
暂停和恢复虚拟机
配置虚拟机开机自动启动
磁盘预分配策略
虚拟磁盘类型 qcow2 格式选项
创建raw格式非稀疏文件 创建raw格式稀疏文件
raw文件复制的格式控制 virsh 管理虚拟机快照
使用virsh 命令还原快照 #删除快照 [root@ubuntu2004 isos]#virsh dominfo centos7.0 #查看虚拟机详细信息 Id: - Name: centos7.0 UUID: 266d67e2-8630-4dcf-955d-b0bbb71f9ae6 OS Type: hvm State: shut off CPU(s): 2 Max memory: 1048576 KiB Used memory: 1048576 KiB Persistent: yes Autostart: disable Managed save: no Security model: apparmor Security DOI: 0 apt update" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0a401cc32a8290d6fef3e877be89e216/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-09T15:42:21+08:00" />
<meta property="article:modified_time" content="2023-05-09T15:42:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux 虚拟化技术 KVM</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%C2%A0virt-install%20%E5%91%BD%E4%BB%A4%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%C2%A0%20%C2%A0%20%C2%A0%20%E5%91%BD%E4%BB%A4%E7%89%88%20%E5%8D%8A%E6%89%8B%E5%B7%A5-toc" style="margin-left:40px;"><a href="#%C2%A0virt-install%20%E5%91%BD%E4%BB%A4%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%C2%A0%20%C2%A0%20%C2%A0%20%E5%91%BD%E4%BB%A4%E7%89%88%20%E5%8D%8A%E6%89%8B%E5%B7%A5" rel="nofollow"> virt-install 命令创建虚拟机      命令版 半手工</a></p> 
<p id="%E5%88%A9%E7%94%A8%20qemu-img%E5%91%BD%E4%BB%A4%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98-toc" style="margin-left:80px;"><a href="#%E5%88%A9%E7%94%A8%20qemu-img%E5%91%BD%E4%BB%A4%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98" rel="nofollow">利用 qemu-img命令创建虚拟磁盘</a></p> 
<p id="%E5%9F%BA%E4%BA%8E%E5%B7%B2%E6%9C%89%E7%B3%BB%E7%BB%9F%E7%9B%B4%E6%8E%A5%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%90%AF%E5%8A%A8%C2%A0%20%C2%A0%E5%A4%8D%E5%88%B6-toc" style="margin-left:80px;"><a href="#%E5%9F%BA%E4%BA%8E%E5%B7%B2%E6%9C%89%E7%B3%BB%E7%BB%9F%E7%9B%B4%E6%8E%A5%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%90%AF%E5%8A%A8%C2%A0%20%C2%A0%E5%A4%8D%E5%88%B6" rel="nofollow">基于已有系统直接创建新的虚拟机启动   复制</a></p> 
<p id="%E2%80%8B%E7%BC%96%E8%BE%91-toc" style="margin-left:80px;"><a href="#%E2%80%8B%E7%BC%96%E8%BE%91" rel="nofollow">​编辑</a></p> 
<p id="%C2%A0%E5%A4%8D%E5%88%B6%20%E5%8F%AF%E4%BB%A5%C2%A0%C2%A0%20%E9%80%82%E7%94%A8%E4%BA%8E%E8%84%9A%E6%9C%AC%20%E5%8F%AF%E4%BB%A5%E6%89%B9%E9%87%8F%E6%94%B9%C2%A0%20%E5%86%85%E5%AD%98%E4%B9%8B%E7%B1%BB%E7%9A%84%C2%A0%20%C2%A0%E5%85%8B%E9%9A%86%E6%B2%A1%E6%B3%95%E5%AD%90%E6%94%B9-toc" style="margin-left:40px;"><a href="#%C2%A0%E5%A4%8D%E5%88%B6%20%E5%8F%AF%E4%BB%A5%C2%A0%C2%A0%20%E9%80%82%E7%94%A8%E4%BA%8E%E8%84%9A%E6%9C%AC%20%E5%8F%AF%E4%BB%A5%E6%89%B9%E9%87%8F%E6%94%B9%C2%A0%20%E5%86%85%E5%AD%98%E4%B9%8B%E7%B1%BB%E7%9A%84%C2%A0%20%C2%A0%E5%85%8B%E9%9A%86%E6%B2%A1%E6%B3%95%E5%AD%90%E6%94%B9" rel="nofollow"> 复制 可以   适用于脚本 可以批量改  内存之类的   克隆没法子改</a></p> 
<p id="%C2%A0%E5%88%A9%E7%94%A8virt-clone%E5%85%8B%E9%9A%86%E5%AE%9E%E7%8E%B0-toc" style="margin-left:40px;"><a href="#%C2%A0%E5%88%A9%E7%94%A8virt-clone%E5%85%8B%E9%9A%86%E5%AE%9E%E7%8E%B0" rel="nofollow"> 利用virt-clone克隆实现</a></p> 
<p id="%E5%8D%8A%E8%99%9A%E6%8B%9F%E5%8C%96%E8%AE%BE%E5%A4%87%E7%BB%9F%E4%B8%80%E6%8E%A5%E5%8F%A3virtio-toc" style="margin-left:40px;"><a href="#%E5%8D%8A%E8%99%9A%E6%8B%9F%E5%8C%96%E8%AE%BE%E5%A4%87%E7%BB%9F%E4%B8%80%E6%8E%A5%E5%8F%A3virtio" rel="nofollow">半虚拟化设备统一接口virtio</a></p> 
<p id="%C2%A0%E5%88%9B%E5%BB%BA%20Windows%20Server%202008%20%E8%99%9A%E6%8B%9F%E6%9C%BA-toc" style="margin-left:40px;"><a href="#%C2%A0%E5%88%9B%E5%BB%BA%20Windows%20Server%202008%20%E8%99%9A%E6%8B%9F%E6%9C%BA" rel="nofollow"> 创建 Windows Server 2008 虚拟机</a></p> 
<p id="%C2%A0%E7%94%9F%E6%88%90Windows%20Server%202008%20%E9%95%9C%E5%83%8F%E6%A8%A1%E7%89%88%E3%80%81-toc" style="margin-left:40px;"><a href="#%C2%A0%E7%94%9F%E6%88%90Windows%20Server%202008%20%E9%95%9C%E5%83%8F%E6%A8%A1%E7%89%88%E3%80%81" rel="nofollow"> 生成Windows Server 2008 镜像模版、</a></p> 
<p id="libvirt%20%E6%9E%B6%E6%9E%84-toc" style="margin-left:0px;"><a href="#libvirt%20%E6%9E%B6%E6%9E%84" rel="nofollow">libvirt 架构</a></p> 
<p id="%C2%A0%E5%BF%AB%E7%85%A7-toc" style="margin-left:0px;"><a href="#%C2%A0%E5%BF%AB%E7%85%A7" rel="nofollow"> 快照</a></p> 
<p id="%C2%A0%C2%A0%23%E6%9F%A5%E7%9C%8B%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF-toc" style="margin-left:40px;"><a href="#%C2%A0%C2%A0%23%E6%9F%A5%E7%9C%8B%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF" rel="nofollow">  #查看虚拟机详细信息</a></p> 
<p id="%23%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E5%90%AF%E5%8A%A8%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA-toc" style="margin-left:40px;"><a href="#%23%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E5%90%AF%E5%8A%A8%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA" rel="nofollow">#查看当前启动的虚拟机</a></p> 
<p id="%23%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E8%99%9A%E6%8B%9F%E6%9C%BA-toc" style="margin-left:40px;"><a href="#%23%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E8%99%9A%E6%8B%9F%E6%9C%BA" rel="nofollow">#查看所有虚拟机</a></p> 
<p id="%E5%90%AF%E5%8A%A8%E5%92%8C%E5%85%B3%E9%97%AD%E8%99%9A%E6%8B%9F%E6%9C%BA-toc" style="margin-left:40px;"><a href="#%E5%90%AF%E5%8A%A8%E5%92%8C%E5%85%B3%E9%97%AD%E8%99%9A%E6%8B%9F%E6%9C%BA" rel="nofollow">启动和关闭虚拟机</a></p> 
<p id="%23%E5%88%97%E5%87%BA%E5%BC%80%E6%9C%BA%E7%8A%B6%E6%80%81%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84UUID%E5%92%8C%E5%90%8D%E7%A7%B0-toc" style="margin-left:40px;"><a href="#%23%E5%88%97%E5%87%BA%E5%BC%80%E6%9C%BA%E7%8A%B6%E6%80%81%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84UUID%E5%92%8C%E5%90%8D%E7%A7%B0" rel="nofollow">#列出开机状态虚拟机的UUID和名称</a></p> 
<p id="%23%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84UUID%E5%92%8Cname-toc" style="margin-left:40px;"><a href="#%23%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84UUID%E5%92%8Cname" rel="nofollow">#列出所有虚拟机的UUID和name</a></p> 
<p id="%E6%9F%A5%E7%9C%8B%E8%99%9A%E6%8B%9F%E6%9C%BAUUID%2C%E9%80%9A%E8%BF%87UUID%E5%90%AF%E5%8A%A8%E5%85%B3%E9%97%AD%E8%99%9A%E6%8B%9F%E6%9C%BA-toc" style="margin-left:40px;"><a href="#%E6%9F%A5%E7%9C%8B%E8%99%9A%E6%8B%9F%E6%9C%BAUUID%2C%E9%80%9A%E8%BF%87UUID%E5%90%AF%E5%8A%A8%E5%85%B3%E9%97%AD%E8%99%9A%E6%8B%9F%E6%9C%BA" rel="nofollow">查看虚拟机UUID,通过UUID启动关闭虚拟机</a></p> 
<p id="%E6%9A%82%E5%81%9C%E5%92%8C%E6%81%A2%E5%A4%8D%E8%99%9A%E6%8B%9F%E6%9C%BA-toc" style="margin-left:40px;"><a href="#%E6%9A%82%E5%81%9C%E5%92%8C%E6%81%A2%E5%A4%8D%E8%99%9A%E6%8B%9F%E6%9C%BA" rel="nofollow">暂停和恢复虚拟机</a></p> 
<p id="%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%BC%80%E6%9C%BA%E8%87%AA%E5%8A%A8%E5%90%AF%E5%8A%A8-toc" style="margin-left:40px;"><a href="#%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%BC%80%E6%9C%BA%E8%87%AA%E5%8A%A8%E5%90%AF%E5%8A%A8" rel="nofollow">配置虚拟机开机自动启动</a></p> 
<p id="%C2%A0%E7%A3%81%E7%9B%98%E9%A2%84%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5-toc" style="margin-left:40px;"><a href="#%C2%A0%E7%A3%81%E7%9B%98%E9%A2%84%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5" rel="nofollow"> 磁盘预分配策略</a></p> 
<p id="%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98%E7%B1%BB%E5%9E%8B%C2%A0-toc" style="margin-left:40px;"><a href="#%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98%E7%B1%BB%E5%9E%8B%C2%A0" rel="nofollow">虚拟磁盘类型 </a></p> 
<p id="%C2%A0qcow2%20%E6%A0%BC%E5%BC%8F%E9%80%89%E9%A1%B9-toc" style="margin-left:40px;"><a href="#%C2%A0qcow2%20%E6%A0%BC%E5%BC%8F%E9%80%89%E9%A1%B9" rel="nofollow"> qcow2 格式选项</a></p> 
<p id="%E5%88%9B%E5%BB%BAraw%E6%A0%BC%E5%BC%8F%E9%9D%9E%E7%A8%80%E7%96%8F%E6%96%87%E4%BB%B6%C2%A0-toc" style="margin-left:40px;"><a href="#%E5%88%9B%E5%BB%BAraw%E6%A0%BC%E5%BC%8F%E9%9D%9E%E7%A8%80%E7%96%8F%E6%96%87%E4%BB%B6%C2%A0" rel="nofollow">创建raw格式非稀疏文件 </a></p> 
<p id="%C2%A0%E5%88%9B%E5%BB%BAraw%E6%A0%BC%E5%BC%8F%E7%A8%80%E7%96%8F%E6%96%87%E4%BB%B6-toc" style="margin-left:40px;"><a href="#%C2%A0%E5%88%9B%E5%BB%BAraw%E6%A0%BC%E5%BC%8F%E7%A8%80%E7%96%8F%E6%96%87%E4%BB%B6" rel="nofollow"> 创建raw格式稀疏文件</a></p> 
<p id="raw%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E7%9A%84%E6%A0%BC%E5%BC%8F%E6%8E%A7%E5%88%B6%C2%A0-toc" style="margin-left:40px;"><a href="#raw%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E7%9A%84%E6%A0%BC%E5%BC%8F%E6%8E%A7%E5%88%B6%C2%A0" rel="nofollow">raw文件复制的格式控制 </a></p> 
<p id="virsh%20%E7%AE%A1%E7%90%86%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%BF%AB%E7%85%A7-toc" style="margin-left:40px;"><a href="#virsh%20%E7%AE%A1%E7%90%86%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%BF%AB%E7%85%A7" rel="nofollow">virsh 管理虚拟机快照</a></p> 
<p id="%E4%BD%BF%E7%94%A8virsh%20%E5%91%BD%E4%BB%A4%E8%BF%98%E5%8E%9F%E5%BF%AB%E7%85%A7%C2%A0-toc" style="margin-left:40px;"><a href="#%E4%BD%BF%E7%94%A8virsh%20%E5%91%BD%E4%BB%A4%E8%BF%98%E5%8E%9F%E5%BF%AB%E7%85%A7%C2%A0" rel="nofollow">使用virsh 命令还原快照 </a></p> 
<p id="%23%E5%88%A0%E9%99%A4%E5%BF%AB%E7%85%A7%C2%A0-toc" style="margin-left:40px;"><a href="#%23%E5%88%A0%E9%99%A4%E5%BF%AB%E7%85%A7%C2%A0" rel="nofollow">#删除快照 </a></p> 
<hr id="hr-toc"> 
<p></p> 
<pre><code>[root@ubuntu2004 isos]#virsh dominfo centos7.0    #查看虚拟机详细信息
Id:             -
Name:           centos7.0
UUID:           266d67e2-8630-4dcf-955d-b0bbb71f9ae6
OS Type:        hvm
State:          shut off
CPU(s):         2
Max memory:     1048576 KiB
Used memory:    1048576 KiB
Persistent:     yes
Autostart:      disable
Managed save:   no
Security model: apparmor
Security DOI:   0
</code></pre> 
<blockquote> 
 <p>apt update</p> 
 <p>apt install cpu-checker </p> 
 <p> apt install qemu-kvm virt-manager libvirt-daemon-system  </p> 
 <p>apt install bridge-utils        #网桥</p> 
 <p></p> 
 <p>[root@rocky8 ~]#yum install bridge-utils.x86_64 </p> 
 <p></p> 
 <p>[root@ubuntu2004 ~]#export DISPLAY=10.0.0.1:0.0     </p> 
 <p>#如果没有需要加载一下环境变量，export=DISPLAY=ip地址:0.0</p> 
 <p>[root@ubuntu2004 ~]#virt-manager             #需要安装Xmanager </p> 
 <p></p> 
 <p><strong>CentOS 安装 KVM</strong></p> 
 <p>[root@centos8 ~]#yum -y install qemu-kvm libvirt virt-manager virt-install virt-viewer<br> [root@centos8 ~]#systemctl start --now libvirtd</p> 
 <p></p> 
 <p>CentOS 8 还提供基于Web的虚拟机管理方式</p> 
 <p>root@centos8 ~]#yum -y install cockpit cockpit-machines<br> [root@centos8 ~]#systemctl enable --now cockpit.socket</p> 
 <p>Created symlink /etc/systemd/system/sockets.target.wants/cockpit.socket →<br> /usr/lib/systemd/system/cockpit.socket.</p> 
 <p>#打开浏览器，访问以下地址：<br> https://centos8主机:9090</p> 
 <p></p> 
 <p>图形化工具 virt-manager</p> 
 <p>[root@rocky8 ~]#yum install bridge-utils.x86_64 <br> [root@rocky8 ~]#export DISPLAY=10.0.0.1:0.0<br> [root@rocky8 ~]#virt-manager <br><br>    </p> 
</blockquote> 
<ul><li>[root@ubuntu2004 ~]#localectl status        #查看当前字符集  （为乱码）</li><li>[root@ubuntu2004 ~]#localectl set-locale LANG=en_US.UTF-8        #把他改写成utf8格式</li><li>[root@ubuntu2004 ~]#exit           #退出之后重新执行</li><li>[root@ubuntu2004 ~]#virt-manager </li><li><img alt="" height="823" src="https://images2.imgbox.com/a6/8d/FZNyv8qh_o.png" width="843"></li></ul> 
<p>  cat /etc/libvirt/qemu/networks/default.xml </p> 
<pre><code>[root@ubuntu2004 ~]# cat /etc/libvirt/qemu/networks/default.xml    #定义范围
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  virsh net-edit default
or other application using the libvirt API.
--&gt;

&lt;network&gt;
  &lt;name&gt;default&lt;/name&gt;
  &lt;uuid&gt;d28f09ba-f940-4647-bed1-19fd734ff209&lt;/uuid&gt;
  &lt;forward mode='nat'/&gt;
  &lt;bridge name='virbr0' stp='on' delay='0'/&gt;
  &lt;mac address='52:54:00:a1:e2:bd'/&gt;
  &lt;ip address='192.168.122.1' netmask='255.255.255.0'&gt;
    &lt;dhcp&gt;
      &lt;range start='192.168.122.2' end='192.168.122.254'/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;
</code></pre> 
<p>   往下走    20G是立即20G</p> 
<p> <img alt="" height="262" src="https://images2.imgbox.com/b7/ce/mG8eQfnT_o.png" width="480"></p> 
<p> </p> 
<p> ​​​​​​​<img alt="" height="407" src="https://images2.imgbox.com/9f/94/9DKYJYqx_o.png" width="429"></p> 
<p> </p> 
<p> [root@ubuntu2004 isos]#ls /var/lib/libvirt/images/      #默认so路径</p> 
<p><img alt="" height="456" src="https://images2.imgbox.com/e9/8c/DnmXUH4P_o.png" width="664"></p> 
<p></p> 
<p><img alt="" height="484" src="https://images2.imgbox.com/60/cb/tnPANlXE_o.png" width="680"></p> 
<p> <img alt="" height="390" src="https://images2.imgbox.com/10/06/brph1pf0_o.png" width="557"></p> 
<p> ​​​​​​​<img alt="" height="372" src="https://images2.imgbox.com/5b/13/UdjURzQ5_o.png" width="473"></p> 
<p><img alt="" height="784" src="https://images2.imgbox.com/e8/2a/agMMcO19_o.png" width="977"></p> 
<p> <img alt="" height="380" src="https://images2.imgbox.com/6f/de/20GjGqWG_o.png" width="476"></p> 
<p> <img alt="" height="467" src="https://images2.imgbox.com/fd/9c/KxGq5skz_o.png" width="679"></p> 
<p> <img alt="" height="449" src="https://images2.imgbox.com/e4/0a/bUTu45wA_o.png" width="411"></p> 
<p> 一直确定</p> 
<p> <img alt="" height="460" src="https://images2.imgbox.com/0d/d3/wmcnCL5z_o.png" width="548"></p> 
<h3 id="%C2%A0virt-install%20%E5%91%BD%E4%BB%A4%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%C2%A0%20%C2%A0%20%C2%A0%20%E5%91%BD%E4%BB%A4%E7%89%88%20%E5%8D%8A%E6%89%8B%E5%B7%A5"> virt-install 命令创建虚拟机      命令版 半手工</h3> 
<h4 id="%E5%88%A9%E7%94%A8%20qemu-img%E5%91%BD%E4%BB%A4%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98">利用 qemu-img命令创建虚拟磁盘</h4> 
<p>注意: qemu-img create 一定要确认对应路径下没有此文件,如果存在将覆盖原文件</p> 
<blockquote> 
 <p>[root@centos8 ~]#qemu-img  create -f qcow2 /var/lib/libvirt/images/rocky8.qcow2 20G</p> 
 <p>       #模拟硬盘20G，不是要求立即20G<br> Formatting '/var/lib/libvirt/images/centos7.qcow2', fmt=qcow2 size=21474836480<br> cluster_size=65536 lazy_refcounts=off refcount_bits=16</p> 
 <p></p> 
 <p>#观察文件虚拟磁盘大小,比较用virt-manager创建的虚拟机磁盘文件大小<br> [root@centos8 ~]#ll -h /var/lib/libvirt/images/centos7.qcow2<br> -rw-r--r-- 1 root root 193K Sep 13 21:25 /var/lib/libvirt/images/centos7.qcow2</p> 
</blockquote> 
<p> [root@ubuntu2004 ~]#virsh list --all       #查看虚拟机鼠粮<br>  Id   Name        State<br> ---------------------------<br>  4    centos7.0   running</p> 
<p></p> 
<blockquote> 
 <p>virt-install --virt-type kvm --name rocky8 --ram 1024 --vcpus 2 --cdrom=/data/isos/Rocky-8.5-x86_64-minimal.iso --disk path=/var/lib/libvirt/images/rocky8.qcow2 --network network=default  --graphics vnc,listen=0.0.0.0 --noautoconsole --os-variant=rhel8.2<br>  #默认网络default模式     支持远程vnc链接  接听端口0.0.0.0     注意格式<br>  打开终端   安装操作系统<br> WARNING  Requested memory 1024 MiB is less than the recommended 1536 MiB for OS rhel8.2</p> 
 <p>Starting install...</p> 
</blockquote> 
<p><img alt="" height="607" src="https://images2.imgbox.com/30/ef/jRPPWmV3_o.png" width="671"></p> 
<p></p> 
<h4 id="%E5%9F%BA%E4%BA%8E%E5%B7%B2%E6%9C%89%E7%B3%BB%E7%BB%9F%E7%9B%B4%E6%8E%A5%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%90%AF%E5%8A%A8%C2%A0%20%C2%A0%E5%A4%8D%E5%88%B6"><strong>基于已有系统直接创建新的虚拟机启动   复制</strong></h4> 
<pre><code>[root@rocky8 images]# scp rocky8.qcow2 10.0.0.100:/var/lib/libvirt/images/
把rock8的复制到ubuntu


[root@ubuntu2004 images]#virt-install --virt-type kvm --name rocky8 --ram 2048 --vcpus 2  --disk bus=virtio,path=/var/lib/libvirt/images/rocky8.qcow2 --network network=default,model=virtio  --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart --boot hd
WARNING  No operating system detected, VM performance may suffer. Specify an OS with --os-variant for optimal results.

Starting install...
Domain creation completed.
 启动下</code></pre> 
<p> 导入现有的虚拟磁盘</p> 
<h4 id="%E2%80%8B%E7%BC%96%E8%BE%91"><img alt="" height="444" src="https://images2.imgbox.com/3e/0d/vgPOBhk9_o.png" width="441"></h4> 
<p> <img alt="" height="442" src="https://images2.imgbox.com/1c/c5/mquIkUyD_o.png" width="454"></p> 
<p> <img alt="" height="442" src="https://images2.imgbox.com/16/1d/7UCRj7ul_o.png" width="445"></p> 
<h3 id="%C2%A0%E5%A4%8D%E5%88%B6%20%E5%8F%AF%E4%BB%A5%C2%A0%C2%A0%20%E9%80%82%E7%94%A8%E4%BA%8E%E8%84%9A%E6%9C%AC%20%E5%8F%AF%E4%BB%A5%E6%89%B9%E9%87%8F%E6%94%B9%C2%A0%20%E5%86%85%E5%AD%98%E4%B9%8B%E7%B1%BB%E7%9A%84%C2%A0%20%C2%A0%E5%85%8B%E9%9A%86%E6%B2%A1%E6%B3%95%E5%AD%90%E6%94%B9"> 复制 可以   适用于脚本 可以批量改  内存之类的   克隆没法子改</h3> 
<pre><code>root@centos8 images]#pwd
/var/lib/libvirt/images

[root@centos8 images]#cp centos8.qcow2 centos8-2.qcow2

[root@centos8 images]#virt-install --virt-type kvm --name centos8-2 --ram 2048 --
vcpus 2 --disk bus=virtio,path=/var/lib/libvirt/images/centos8-2.qcow2 --network
network=default,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --
autostart --boot hd
WARNING No operating system detected, VM performance may suffer. Specify an OS
with --os-variant for optimal results.
Starting install...
Domain creation completed.

#运行工具,可以看到下面出现新的虚拟机
[root@centos8 images]#virt-manager</code></pre> 
<h3 id="%C2%A0%E5%88%A9%E7%94%A8virt-clone%E5%85%8B%E9%9A%86%E5%AE%9E%E7%8E%B0"> 利用virt-clone克隆实现</h3> 
<blockquote> 
 <p>#基于已有的虚拟机克隆生成新的虚拟机<br> [root@ubuntu2004 ~]#virt-clone -o rocky8 -f /var/lib/libvirt/images/rocky8-<br> 3.qcow2 -n rocky8-3<br> -o rocky8 #指已存在的虚拟机的名称<br> -f /var/lib/libvirt/images/rocky8-3.qcow2 #新虚拟机磁盘文件路径，此文件自动生成，不需要<br> 事先创建     两个名字<br> -n rocky8-3 #新虚拟机的名称</p> 
</blockquote> 
<pre><code>[root@ubuntu2004 ~]#virsh list --all
 Id   Name              State
----------------------------------
 -    centos7-2         shut off
 -    centos7.0         shut off
 -    rocky8            shut off
 -    rocky8-template   shut off

[root@ubuntu2004 ~]#virsh start rocky8-template   #跑起来
Domain rocky8-template started

[root@ubuntu2004 ~]#virsh list --all
 Id   Name              State
----------------------------------
 2    rocky8-template   running
 -    centos7-2         shut off
 -    centos7.0         shut off
 -    rocky8            shut off
</code></pre> 
<p> 虚拟化区别</p> 
<p><img alt="" height="339" src="https://images2.imgbox.com/0a/18/8CwPgfKe_o.png" width="499"></p> 
<p><strong>性能对比</strong></p> 
<pre><code>https://www.ilsistemista.net/index.php/virtualization/42-kvm-virtio-paravirtualized-drivers-why-they-matter.html?start=2</code></pre> 
<p>virtio 半虚拟化</p> 
<p>e1000全虚拟化</p> 
<h3 id="%E5%8D%8A%E8%99%9A%E6%8B%9F%E5%8C%96%E8%AE%BE%E5%A4%87%E7%BB%9F%E4%B8%80%E6%8E%A5%E5%8F%A3virtio">半虚拟化设备统一接口virtio</h3> 
<p><img alt="" height="274" src="https://images2.imgbox.com/be/da/PZinJF9Y_o.png" width="1109"></p> 
<p><strong> 过统一的接口virtio以支持的多种硬件设备</strong></p> 
<ul><li>不同的虚拟设备和不同的虚拟机可以有不同的前端驱动</li><li>不同的硬件设备可以有不同的后端驱动</li><li>两者之间的交互遵循virtio的标准</li></ul> 
<p>测试主机速度 </p> 
<blockquote> 
 <p>   [root@localhost ~]# dd | hdparm -t /dev/vda</p> 
 <p>/dev/vda:<br>  Timing buffered disk reads: 1774 MB in  3.00 seconds = 591.20 MB/sec</p> 
</blockquote> 
<h3 id="%C2%A0%E5%88%9B%E5%BB%BA%20Windows%20Server%202008%20%E8%99%9A%E6%8B%9F%E6%9C%BA"> 创建 Windows Server 2008 虚拟机</h3> 
<blockquote> 
 <p>#创建磁盘文件      倒入相关文件</p> 
 <pre><code>[root@ubuntu2004 images]#qemu-img create -f qcow2 /var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2 200G</code></pre> 
 <pre><code>[root@ubuntu2004 isos]#virt-install --virt-type kvm --name Win2008 --memory 3072 --vcpus=2 --os-variant=win2k8r2 --cdrom=/data/isos/cn_windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1_x64_dvd_617598.iso --disk path=/var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2,format=qcow2,bus=virtio --disk path=/data/isos/virtio-win-0.1.141_amd64.vfd,device=floppy --network bridge=virbr0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart</code></pre> 
 <p><img alt="" height="639" src="https://images2.imgbox.com/0d/e3/5itOm5Uq_o.png" width="802"></p> 
 <p><img alt="" height="639" src="https://images2.imgbox.com/07/ea/7GnxNKQ8_o.png" width="802"></p> 
 <p> <img alt="" height="639" src="https://images2.imgbox.com/bf/14/CrCBEc0r_o.png" width="802"></p> 
 <p> 挂载virtio-win的141的ISO光盘文件virtio-win-0.1.141.iso进行安装驱动<br> 注意:不要安装其它版本,比如189版本会蓝屏死机,185安装后显示黄色，工作不正常</p> 
</blockquote> 
<h3 id="%C2%A0%E7%94%9F%E6%88%90Windows%20Server%202008%20%E9%95%9C%E5%83%8F%E6%A8%A1%E7%89%88%E3%80%81"> 生成Windows Server 2008 镜像模版、</h3> 
<p>利用sysprep工具,清除个性信息,下次Windows开机时, 会自动生成初始化个性信息</p> 
<p>Linux 有相同打架 ，windows有SID相同打架  （就是机器名）</p> 
<p><img alt="" height="361" src="https://images2.imgbox.com/68/5d/sTcX8dRv_o.png" width="815"></p> 
<p></p> 
<p><img alt="" height="307" src="https://images2.imgbox.com/79/28/wNWsJPlf_o.png" width="513"></p> 
<p></p> 
<h2 id="libvirt%20%E6%9E%B6%E6%9E%84">libvirt 架构</h2> 
<p>注意: 如果libvirtd服务意外关闭,将导致相关工具,如:virt-manager等无法和虚拟机连接,但虚拟机仍会正常运行</p> 
<blockquote> 
 <p>[root@ubuntu2004 ~]#systemctl stop libvirtd libvirtd.socket libvirtd-admin.socket libvirtd-ro.socket</p> 
 <p></p> 
 <p>[root@centos8 ~]#systemctl stop libvirtd</p> 
 <p></p> 
 <p>[root@centos8 ~]#virsh list<br> error: failed to connect to the hypervisor<br> error: Failed to connect socket to '/var/run/libvirt/libvirt-sock': No such file<br> or directory</p> 
 <p></p> 
 <p>#virt-manager工具也无法连接虚拟机</p> 
</blockquote> 
<p> 开机自启动 点个对钩，自动创建快捷方式</p> 
<p><img alt="" height="626" src="https://images2.imgbox.com/c5/dc/H7AFMks9_o.png" width="753"></p> 
<h2 id="%C2%A0%E5%BF%AB%E7%85%A7"> 快照</h2> 
<p><img alt="" height="626" src="https://images2.imgbox.com/85/56/7FGS12Xh_o.png" width="758"></p> 
<p> <img alt="" height="617" src="https://images2.imgbox.com/76/64/8ZS0NNKB_o.png" width="739"></p> 
<p> <img alt="" height="720" src="https://images2.imgbox.com/77/3e/5jcaXzq8_o.png" width="519"></p> 
<h3 id="%C2%A0%C2%A0%23%E6%9F%A5%E7%9C%8B%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF">  #查看虚拟机详细信息</h3> 
<pre><code>[root@ubuntu2004 isos]#virsh dominfo centos7.0    #查看虚拟机详细信息
Id:             -
Name:           centos7.0
UUID:           266d67e2-8630-4dcf-955d-b0bbb71f9ae6
OS Type:        hvm
State:          shut off
CPU(s):         2
Max memory:     1048576 KiB
Used memory:    1048576 KiB
Persistent:     yes
Autostart:      disable
Managed save:   no
Security model: apparmor
Security DOI:   0</code></pre> 
<h3 id="%23%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E5%90%AF%E5%8A%A8%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA">#查看当前启动的虚拟机</h3> 
<p>[root@centos8 ~]#virsh list</p> 
<h3 id="%23%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E8%99%9A%E6%8B%9F%E6%9C%BA">#查看所有虚拟机</h3> 
<p>[root@centos8 ~]#virsh list --all</p> 
<h3 id="%E5%90%AF%E5%8A%A8%E5%92%8C%E5%85%B3%E9%97%AD%E8%99%9A%E6%8B%9F%E6%9C%BA">启动和关闭虚拟机</h3> 
<p>#正常关机<br> [root@centos8 ~]#virsh shutdown 1</p> 
<p>#强制关机,慎重使用<br> [root@centos8 ~]#virsh destroy 1</p> 
<h3 id="%23%E5%88%97%E5%87%BA%E5%BC%80%E6%9C%BA%E7%8A%B6%E6%80%81%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84UUID%E5%92%8C%E5%90%8D%E7%A7%B0">#列出开机状态虚拟机的UUID和名称</h3> 
<p>[root@centos8 ~]#virsh list --uuid --name</p> 
<h3 id="%23%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84UUID%E5%92%8Cname">#列出所有虚拟机的UUID和name</h3> 
<p>[root@ubuntu2004 ~]#virsh list --uuid --all --name</p> 
<h3 id="%E6%9F%A5%E7%9C%8B%E8%99%9A%E6%8B%9F%E6%9C%BAUUID%2C%E9%80%9A%E8%BF%87UUID%E5%90%AF%E5%8A%A8%E5%85%B3%E9%97%AD%E8%99%9A%E6%8B%9F%E6%9C%BA">查看虚拟机UUID,通过UUID启动关闭虚拟机</h3> 
<blockquote> 
 <p>[root@centos8 ~]#virsh list</p> 
 <p></p> 
 <p>#查看虚拟机的UUID<br> [root@centos8 ~]#virsh domuuid 1<br> 99765478-cfb1-4164-b038-f62004ccab9e</p> 
 <p></p> 
 <p>[root@centos8 ~]#virsh destroy 99765478-cfb1-4164-b038-f62004ccab9e<br> Domain 99765478-cfb1-4164-b038-f62004ccab9e destroyed</p> 
 <p></p> 
 <p>[root@centos8 ~]#virsh list --all</p> 
 <p></p> 
 <p>[root@centos8 ~]#virsh domuuid centos8<br> 99765478-cfb1-4164-b038-f62004ccab9e</p> 
 <p></p> 
 <p>[root@centos8 ~]#virsh start 99765478-cfb1-4164-b038-f62004ccab9e<br> Domain centos8 started</p> 
</blockquote> 
<h3 id="%E6%9A%82%E5%81%9C%E5%92%8C%E6%81%A2%E5%A4%8D%E8%99%9A%E6%8B%9F%E6%9C%BA">暂停和恢复虚拟机</h3> 
<blockquote> 
 <p>[root@centos8 ~]#virsh suspend centos8<br> Domain centos8 suspended</p> 
 <p></p> 
 <p>#虚拟机暂停后,宿主机中还存有相关的进程<br> [root@centos8 ~]#ps aux|grep kvm</p> 
</blockquote> 
<h3 id="%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%BC%80%E6%9C%BA%E8%87%AA%E5%8A%A8%E5%90%AF%E5%8A%A8">配置虚拟机开机自动启动</h3> 
<blockquote> 
 <p>[root@centos8 ~]#virsh autostart centos8<br> Domain centos8 marked as autostarted</p> 
 <p></p> 
 <p>#设置虚拟机随宿主机启动而自动启动,本质就是在下面目录生成软链接<br> [root@centos8 ~]#ll /etc/libvirt/qemu/autostart/<br> total 0<br> lrwxrwxrwx 1 root root 29 Sep 17 18:53 centos8.xml -&gt;<br> /etc/libvirt/qemu/centos8.xml</p> 
 <p></p> 
 <p>[root@centos8 ~]#virsh autostart 1 --disable<br> Domain 1 unmarked as autostarted<br> [root@centos8 ~]#ll /etc/libvirt/qemu/autostart/<br> total 0<br> lrwxrwxrwx 1 root root 29 Sep 17 18:53 centos8.xml -&gt;<br> /etc/libvirt/qemu/centos8.xml<br> [root@centos8 ~]#reboot<br> [root@centos8 ~]#virsh list<br> Id Name State<br> ----------------------------------------------------<br> 1 centos8 running</p> 
</blockquote> 
<h3 id="%C2%A0%E7%A3%81%E7%9B%98%E9%A2%84%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><strong> 磁盘预分配策略</strong></h3> 
<blockquote> 
 <p>raw 文件的预分配策略和文件系统是否支持有关,而qcow2则无关<br> 预分配策略<br><strong>off</strong><br> 此为缺省策略，即不使用预分配策略,预分配后的虚拟磁盘占用空间很小,不属于稀疏映像类型<br> 生成的磁盘文件占用空间很小<br><strong>metadata</strong><br> 只预分配元数据(metadata)，预分配后的磁盘文件属于稀疏映像类型,相当于vmware中的磁盘置备选项: Thin Provision(精简配置)生成的磁盘文件为稀疏格式,实际占用的空间比off策略稍大一些<br><strong>falloc</strong><br> 分配文件的块并标识它们的状态为未初始化，即只分配空间,但不置零. 预分配后的虚拟磁盘属于非稀疏映像类型,相对full模式来说，创建虚拟磁盘的速度要快很多,相当于vmware中的磁盘置备选项:厚置备延迟置零<br> 生成的磁盘文件实际占用的空间和分配的空间相同大小<br><strong>full</strong></p> 
 <p>分配所有磁盘空间并置零，预分配后的虚拟磁盘属于非稀疏映像类型,创建最慢,相当于vmware中的磁盘置备选项: 厚置备置零生成的磁盘文件实际占用的空间和分配的空间相同大小</p> 
 <p></p> 
 <p><strong>文件系统显示大小</strong><br> [root@centos8 ~]#ll -h test*.qcow2<br> -rw-r--r-- 1 root root 193K Sep 20 13:31 test1.qcow2<br> -rw-r--r-- 1 root root 193K Sep 20 13:32 test2.qcow2<br> -rw-r--r-- 1 root root 1.1G Sep 20 13:35 test3.qcow2<br> -rw-r--r-- 1 root root 1.1G Sep 20 13:36 test4.qcow2<br> -rw-r--r-- 1 root root 1.1G Sep 20 13:37 test5.qcow2<br><strong>#查看真实大小</strong><br> [root@centos8 ~]#du -h test*.qcow2<br> 196K test1.qcow2<br> 196K test2.qcow2<br> 836K test3.qcow2<br> 1.1G test4.qcow2<br> 1.1G test5.qcow</p> 
</blockquote> 
<h3 id="%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98%E7%B1%BB%E5%9E%8B%C2%A0">虚拟磁盘类型 </h3> 
<p><strong>固定Fixed</strong><br> 在配置时，指定磁盘大小<br> 不管在虚拟磁盘上实际存储多少数据，都将占用相同大小宿主机的磁盘空间<br><strong>动态Dynamic</strong><br> 初始空间占用小<br> 随着空间的使用逐渐增长到最大容量，但是只根据需求使用更多的空间<br><strong>差异Differencing</strong><br> 因为创建是差异磁盘，所以只保存变更的数据<br> 例如，将操作系统安装在父盘，然后创建差异化磁盘来执行进一步配置</p> 
<p></p> 
<p>写入最后面前面没有</p> 
<p><img alt="" height="261" src="https://images2.imgbox.com/bf/f0/GTIpFQUf_o.png" width="735"></p> 
<h3 id="%C2%A0qcow2%20%E6%A0%BC%E5%BC%8F%E9%80%89%E9%A1%B9"> qcow2 格式选项</h3> 
<blockquote> 
 <p>backing_file #指定后端镜像文件<br> backing_fmt #设置后端镜像的镜像格式<br> cluster_size #设置镜像中的簇大小，取值在512到2M之间，默认值为64K<br> preallocation #设置镜像文件空间的预分配模式<br> encryption #用于设置加密</p> 
</blockquote> 
<h3 id="%E5%88%9B%E5%BB%BAraw%E6%A0%BC%E5%BC%8F%E9%9D%9E%E7%A8%80%E7%96%8F%E6%96%87%E4%BB%B6%C2%A0">创建raw格式非稀疏文件 </h3> 
<blockquote> 
 <p>[root@centos8 ~]#<strong>dd if=/dev/zero of=vm2.img bs=1M count=102</strong>4<br> 1024+0 records in<br> 1024+0 records out<br> 1073741824 bytes (1.1 GB, 1.0 GiB) copied, 3.20332 s, 335 MB/s</p> 
 <p></p> 
 <p>[root@centos8 ~]#<strong>qemu-img info vm2.img</strong><br> image: vm2.img<br> file format: raw<br> virtual size: 1.0G (1073741824 bytes)<br> disk size: 1.0G</p> 
 <p></p> 
 <p>[root@centos8 ~]<strong>#ls -hl vm2.img</strong><br> -rw-r--r-- 1 root root 1.0G Sep 20 12:31 vm2.img</p> 
 <p></p> 
 <p>[root@centos8 ~]<strong>#du -h vm2.img</strong><br> 1.0G vm2.img</p> 
</blockquote> 
<h3 id="%C2%A0%E5%88%9B%E5%BB%BAraw%E6%A0%BC%E5%BC%8F%E7%A8%80%E7%96%8F%E6%96%87%E4%BB%B6"> 创建raw格式稀疏文件</h3> 
<blockquote> 
 <p>[root@centos8 ~]#<strong>dd if=/dev/zero of=vm3.img bs=1M count=0 seek=1024</strong><br> 0+0 records in<br> 0+0 records out<br> 0 bytes copied, 9.2173e-05 s, 0.0 kB/s</p> 
 <p></p> 
 <p>[root@centos8 ~]#<strong>qemu-img info vm3.img</strong><br> image: vm3.img<br> file format: raw<br> virtual size: 1.0G (1073741824 bytes)<br> disk size: 0</p> 
 <p></p> 
 <p>[root@centos8 ~]#ll -h vm3.img<br> -rw-r--r-- 1 root root 1.0G Sep 20 12:34 vm3.img<br> [root@centos8 ~]#du -h vm3.img<br> 0 vm3.img</p> 
</blockquote> 
<h3 id="raw%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E7%9A%84%E6%A0%BC%E5%BC%8F%E6%8E%A7%E5%88%B6%C2%A0">raw文件复制的格式控制 </h3> 
<pre><code>#复制非稀疏文件,默认也为非稀疏文件
[root@centos8 ~]#cp vm2.img vm2.img.bak
[root@centos8 ~]#du -h vm2.img.bak
1.0G vm2.img.bak

[root@centos8 ~]#ll -h vm2.img.bak
-rw-r--r-- 1 root root 1.0G Sep 20 12:38 vm2.img.bak
[root@centos8 ~]#qemu-img info vm2.img.bak
image: vm2.img.bak
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 1.0G

#复制稀疏文件,默认仍为稀疏文件
[root@centos8 ~]#cp vm3.img vm3.img.bak
[root@centos8 ~]#ll -h vm3.img.bak
-rw-r--r-- 1 root root 1.0G Sep 20 12:36 vm3.img.bak
[root@centos8 ~]#du -h vm3.img.bak
0 vm3.img.bak

[root@centos8 ~]#qemu-img info vm3.img.bak
image: vm3.img.bak
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 0

#指定将非稀疏文件复制为稀疏格式格式
[root@centos8 ~]#cp --sparse=always vm2.img vm2.img.bak2
[root@centos8 ~]#qemu-img info vm2.img
image: vm2.img
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 1.0G

[root@centos8 ~]#qemu-img info vm2.img.bak2
image: vm2.img.bak2
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 0

#指定将稀疏文件复制为非稀疏格式格式
[root@centos8 ~]#cp --sparse=never vm3.img vm3.img.bak2
[root@centos8 ~]#qemu-img info vm3.img
image: vm3.img
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 0

[root@centos8 ~]#qemu-img info vm3.img.bak2
image: vm3.img.bak2
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 1.0G</code></pre> 
<h3 id="virsh%20%E7%AE%A1%E7%90%86%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%BF%AB%E7%85%A7">virsh 管理虚拟机快照</h3> 
<blockquote> 
 <p>[root@centos8 ~]#virsh snapshot-list centos8<br> Name Creation Time State<br> ------------------------------------------------------------</p> 
 <p></p> 
 <p>#创建虚拟机快照<br> [root@centos8 ~]#virsh snapshot-create centos8<br> Domain snapshot 1600593611 created<br> [root@centos8 ~]#virsh snapshot-list centos8<br> Name Creation Time State<br> ------------------------------------------------------------<br> 1600593611 2020-09-20 17:20:11 +0800 shutoff</p> 
</blockquote> 
<h3 id="%E4%BD%BF%E7%94%A8virsh%20%E5%91%BD%E4%BB%A4%E8%BF%98%E5%8E%9F%E5%BF%AB%E7%85%A7%C2%A0">使用virsh 命令还原快照 </h3> 
<blockquote> 
 <p>[root@centos8 ~]#virsh list<br> Id Name State<br> ----------------------------------------------------<br> #无需关机，即可还原快照<br> [root@centos8 ~]#virsh snapshot-revert centos8 --snapshotname 1600593611 --<br> running<br> [root@centos8 ~]#virsh list<br> Id Name State<br> ----------------------------------------------------<br> 23 centos7 running</p> 
</blockquote> 
<h3 id="%23%E5%88%A0%E9%99%A4%E5%BF%AB%E7%85%A7%C2%A0">#删除快照 </h3> 
<blockquote> 
 <p> #删除快照<br> [root@centos8 ~]#virsh snapshot-delete centos8 --snapshotname 1600593611<br> Domain snapshot 1600593611 deleted<br> [root@centos8 ~]#virsh snapshot-list centos8<br> Name Creation Time State<br> ------------------------------------------------------------<br> [root@centos8 ~]#</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/65c83ee81828b12c7ae37f7a85233adf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【标准化方法】(3) Group Normalization 原理解析、代码复现，附Pytorch代码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e089ac71a50681d845f052baf934a3cf/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CSS-复合选择器</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>