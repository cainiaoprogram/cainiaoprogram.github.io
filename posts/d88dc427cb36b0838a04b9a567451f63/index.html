<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>谈谈https和证书 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="谈谈https和证书" />
<meta property="og:description" content="1. 前言
本篇文章我们讲解下关于https及证书的相关知识，因为我发现不理解证书感觉很难理解https，所以本篇会花大量的篇幅来讲证书，我们一开始会讲解一些相关概念帮助大家理解下，然后我们自己签发一个证书来理解这个过程，最后通过实例和抓包帮助大家理解https。因为本篇文章有很多代码及配置文件相关，最好通过电脑打开查看，篇幅很长，感谢耐心。
2. 概念区分
见到https时就会有很多不知道的概念，我们这里来区分下：
HTTPS：https即为http及其下边一层的可靠的安全加密的传输协议（tls/ssl），它主要思想是传输的双发验证对端的证书是否可以通过（被信任），以此生成加密的密钥，通过此密钥加密传输的内容，后边会详解。
SSL：Secure Socket Layer, 安全套接字层，http层下新增加的这一层构成了https
TLS：Transport Layer Security，同样是为了保证数据安全的加密协议层，是SSL的增强版，SSL有1.0，2.0，3.0版本，TLS目前1.0，1.1，1.2，1.3，TLS的1.0版本就是SSL的3.0
Key：https中有公钥和私钥，用公钥加密的内容，可以使用私钥解密，反之亦然，不过我们平常所说的key文件是指私钥文件
CRT： certificate证书文件，是证书机构颁发的保证安全通信的文件，由域名、公司信息、序列号和签名信息等组成
CER：也是证书文件，和CRT相比只是缩写不同，CRT缩写常见于类uninx系统，CER缩写常见于windows系统
X.509：这里特指颁发的证书的格式，而其根据不同的编码格式分为PEM和DER：
PEM - Privacy Enhanced Mail,打开看文本格式,以&#34;-----BEGIN…&#34;开头, &#34;-----END…&#34;结尾,内容是BASE64编码.Apache和*NIX服务器偏向于使用这种编码格式，这种也是我们所常见的
DER - Distinguished Encoding Rules,打开是二进制格式,不可读.Java和Windows服务器偏向于使用这种编码格式
CSR：Certificate Signing Request 证书签名请求，里面包含公钥等个体信息，这个发给公证机构作为申请，通过这个公证机构颁发证书给你
CA：Catificate Authority 证书颁发机构，它的作用就是给各个用户签发证书等，比如说Symantec、Comodo、Godaddy、GolbalSign 和 Digicert等
openssl：相当于SSL的一个实现，如果把SSL规范看成OO中的接口，那么OpenSSL则认为是接口的实现，个人理解openssl是作为针对SSL/TLS的一个工具，包括对证书的解析，个人颁发，证书编码转化等
3. CA和证书颁发
使用https进行通信，就需要一个证书，那么证书哪里来，就是来自于CA（证书颁发机构）颁发。所谓证书就是比较有公信的机构颁发给你，然后你用他来进行通信，另外一端验证通过后就会信任你，进行信息通信。举例来说如果你的服务器没有证书，浏览器访问你的网址时，会提示不安全。
那么如果有一个服务器，如何才能获取到证书呢，如果要从证书颁发机构申请的话，需要提供CSR文件及钱，然后机构就会颁发证书给你。如果你想要自己给自己颁发，只是用来本地玩玩，或者局域网各个机器之间的相互交流，便可以自己建立一个CA，使用这个CA来给自己颁发证书。我们下面以给自己颁发证书的全过程来描述下，我们使用openssl来进行构建。
CA角色也是需要一个自身的pair，pair包括key(private)和certificate，而最原始的被称为root pair，通常情况下，root CA 不会直接为服务器或者客户端签证，它们会先为自己生成几个中间 CA（intermediate CAs），这几个中间 CA 作为 root CA 的代表为服务器和客户端签证。自己实操的过程中其实也可以直接使用root pair来给服务器签发，为了演示全面，我们来使用intermediate CA来签发证书。
3.1 新建目录：
$ cd /etc/pki/ $ mkdir leap &amp;&amp; cd leap $ mkdir ca &amp;&amp; cd ca 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d88dc427cb36b0838a04b9a567451f63/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-28T11:12:54+08:00" />
<meta property="article:modified_time" content="2023-03-28T11:12:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">谈谈https和证书</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>1. 前言</strong><br> 本篇文章我们讲解下关于https及证书的相关知识，因为我发现不理解证书感觉很难理解https，所以本篇会花大量的篇幅来讲证书，我们一开始会讲解一些相关概念帮助大家理解下，然后我们自己签发一个证书来理解这个过程，最后通过实例和抓包帮助大家理解https。因为本篇文章有很多代码及配置文件相关，最好通过电脑打开查看，篇幅很长，感谢耐心。</p> 
<p><strong>2. 概念区分</strong><br> 见到https时就会有很多不知道的概念，我们这里来区分下：</p> 
<p><strong>HTTPS</strong>：https即为http及其下边一层的可靠的安全加密的传输协议（tls/ssl），它主要思想是传输的双发验证对端的证书是否可以通过（被信任），以此生成加密的密钥，通过此密钥加密传输的内容，后边会详解。</p> 
<p><strong>SSL</strong>：Secure Socket Layer, 安全套接字层，http层下新增加的这一层构成了https</p> 
<p><strong>TLS</strong>：Transport Layer Security，同样是为了保证数据安全的加密协议层，是SSL的增强版，SSL有1.0，2.0，3.0版本，TLS目前1.0，1.1，1.2，1.3，TLS的1.0版本就是SSL的3.0</p> 
<p><strong>Key</strong>：https中有公钥和私钥，用公钥加密的内容，可以使用私钥解密，反之亦然，不过我们平常所说的key文件是指私钥文件</p> 
<p><strong>CRT</strong>： certificate证书文件，是证书机构颁发的保证安全通信的文件，由域名、公司信息、序列号和签名信息等组成</p> 
<p><strong>CER</strong>：也是证书文件，和CRT相比只是缩写不同，CRT缩写常见于类uninx系统，CER缩写常见于windows系统</p> 
<p><strong>X.509</strong>：这里特指颁发的证书的格式，而其根据不同的编码格式分为PEM和DER：</p> 
<p>PEM - Privacy Enhanced Mail,打开看文本格式,以"-----BEGIN…"开头, "-----END…"结尾,内容是BASE64编码.Apache和*NIX服务器偏向于使用这种编码格式，这种也是我们所常见的<br> DER - Distinguished Encoding Rules,打开是二进制格式,不可读.Java和Windows服务器偏向于使用这种编码格式<br> CSR：Certificate Signing Request 证书签名请求，里面包含公钥等个体信息，这个发给公证机构作为申请，通过这个公证机构颁发证书给你</p> 
<p><strong>CA</strong>：Catificate Authority 证书颁发机构，它的作用就是给各个用户签发证书等，比如说Symantec、Comodo、Godaddy、GolbalSign 和 Digicert等</p> 
<p><strong>openssl</strong>：相当于SSL的一个实现，如果把SSL规范看成OO中的接口，那么OpenSSL则认为是接口的实现，个人理解openssl是作为针对SSL/TLS的一个工具，包括对证书的解析，个人颁发，证书编码转化等</p> 
<p><strong>3. CA和证书颁发</strong><br> 使用https进行通信，就需要一个证书，那么证书哪里来，就是来自于CA（证书颁发机构）颁发。所谓证书就是比较有公信的机构颁发给你，然后你用他来进行通信，另外一端验证通过后就会信任你，进行信息通信。举例来说如果你的服务器没有证书，浏览器访问你的网址时，会提示不安全。<br> <img src="https://images2.imgbox.com/84/be/tok30cTP_o.png" alt="在这里插入图片描述"></p> 
<p>那么如果有一个服务器，如何才能获取到证书呢，如果要从证书颁发机构申请的话，需要提供CSR文件及钱，然后机构就会颁发证书给你。如果你想要自己给自己颁发，只是用来本地玩玩，或者局域网各个机器之间的相互交流，便可以自己建立一个CA，使用这个CA来给自己颁发证书。我们下面以给自己颁发证书的全过程来描述下，我们使用openssl来进行构建。</p> 
<p>CA角色也是需要一个自身的pair，pair包括key(private)和certificate，而最原始的被称为root pair，通常情况下，root CA 不会直接为服务器或者客户端签证，它们会先为自己生成几个中间 CA（intermediate CAs），这几个中间 CA 作为 root CA 的代表为服务器和客户端签证。自己实操的过程中其实也可以直接使用root pair来给服务器签发，为了演示全面，我们来使用intermediate CA来签发证书。<br> <strong>3.1 新建目录：</strong></p> 
<pre><code class="prism language-csharp">$ cd <span class="token operator">/</span>etc<span class="token operator">/</span>pki<span class="token operator">/</span>
$ mkdir leap <span class="token operator">&amp;&amp;</span> cd leap
$ mkdir ca <span class="token operator">&amp;&amp;</span> cd ca

</code></pre> 
<p><strong>3.2 设置root CA:</strong><br> 生成root key</p> 
<pre><code class="prism language-csharp">$ mkdir root <span class="token operator">&amp;&amp;</span> cd root
$ mkdir certs crl newcerts <span class="token keyword">private</span>
$ openssl genrsa <span class="token operator">-</span>aes256 <span class="token operator">-</span><span class="token keyword">out</span> <span class="token keyword">private</span><span class="token operator">/</span>leap_ca_key<span class="token punctuation">.</span>pem <span class="token number">4096</span>
Enter pass phrase <span class="token keyword">for</span> root_ca<span class="token punctuation">.</span>key<span class="token punctuation">.</span>pem<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">pass</span></span><span class="token punctuation">]</span>
Verifying <span class="token operator">-</span> Enter pass phrase <span class="token keyword">for</span> root_ca<span class="token punctuation">.</span>key<span class="token punctuation">.</span>pem<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">passwd</span></span><span class="token punctuation">]</span>

$ chmod <span class="token number">400</span> <span class="token keyword">private</span><span class="token operator">/</span>leap_ca_key<span class="token punctuation">.</span>pem

</code></pre> 
<p>生成root cert<br> 首先复制cnf文件内容到openssl.cnf</p> 
<pre><code class="prism language-csharp">HOME                    <span class="token operator">=</span> <span class="token punctuation">.</span>
RANDFILE                <span class="token operator">=</span> <span class="token punctuation">.</span>rand

<span class="token punctuation">[</span>ca<span class="token punctuation">]</span>
default_ca              <span class="token operator">=</span> ca_default

<span class="token punctuation">[</span>ca_default<span class="token punctuation">]</span>
dir                     <span class="token operator">=</span> <span class="token punctuation">.</span>
certs                   <span class="token operator">=</span> $dir<span class="token operator">/</span><span class="token class-name">certs</span>
crl_dir                 <span class="token operator">=</span> $dir<span class="token operator">/</span><span class="token class-name">crl</span>
database                <span class="token operator">=</span> $dir<span class="token operator">/</span><span class="token class-name">index<span class="token punctuation">.</span>txt</span>
new_certs_dir           <span class="token operator">=</span> $dir<span class="token operator">/</span><span class="token class-name">newcerts</span>
certificate             <span class="token operator">=</span> $dir<span class="token operator">/</span>certs<span class="token operator">/</span><span class="token operator">%</span><span class="token class-name">s_ca_cert<span class="token punctuation">.</span>pem</span>
private_key             <span class="token operator">=</span> $dir<span class="token operator">/</span><span class="token keyword">private</span><span class="token operator">/</span><span class="token operator">%</span><span class="token class-name">s_ca_key<span class="token punctuation">.</span>pem</span>
serial                  <span class="token operator">=</span> $dir<span class="token operator">/</span><span class="token class-name">serial</span>
crl                     <span class="token operator">=</span> $dir<span class="token operator">/</span><span class="token class-name">crl<span class="token punctuation">.</span>pem</span>
x509_extensions         <span class="token operator">=</span> <span class="token class-name">usr_cert</span>
name_opt                <span class="token operator">=</span> <span class="token class-name">ca_default</span>
cert_opt                <span class="token operator">=</span> <span class="token class-name">ca_default</span>
default_days            <span class="token operator">=</span> <span class="token number">3650</span>
default_crl_days        <span class="token operator">=</span> <span class="token number">30</span>
default_md              <span class="token operator">=</span> <span class="token class-name">sha256</span>
preserve                <span class="token operator">=</span> <span class="token class-name">no</span>
policy                  <span class="token operator">=</span> policy_match

<span class="token punctuation">[</span>policy_match<span class="token punctuation">]</span>
<span class="token preprocessor property"># The root CA should only sign intermediate certificates that match.</span>
<span class="token preprocessor property"># See the POLICY FORMAT section of `man ca`.</span>
countryName             <span class="token operator">=</span> <span class="token class-name">match</span>
stateOrProvinceName     <span class="token operator">=</span> <span class="token class-name">match</span>
organizationName        <span class="token operator">=</span> <span class="token class-name">match</span>
organizationalUnitName  <span class="token operator">=</span> <span class="token class-name">optional</span>
commonName              <span class="token operator">=</span> <span class="token class-name">supplied</span>
emailAddress            <span class="token operator">=</span> optional

<span class="token punctuation">[</span> policy_loose <span class="token punctuation">]</span>
<span class="token preprocessor property"># Allow the intermediate CA to sign a more diverse range of certificates.</span>
<span class="token preprocessor property"># See the POLICY FORMAT section of the `ca` man page.</span>
countryName             <span class="token operator">=</span> <span class="token class-name">optional</span>
stateOrProvinceName     <span class="token operator">=</span> <span class="token class-name">optional</span>
localityName            <span class="token operator">=</span> <span class="token class-name">optional</span>
organizationName        <span class="token operator">=</span> <span class="token class-name">optional</span>
organizationalUnitName  <span class="token operator">=</span> <span class="token class-name">optional</span>
commonName              <span class="token operator">=</span> <span class="token class-name">supplied</span>
emailAddress            <span class="token operator">=</span> optional

<span class="token punctuation">[</span>req<span class="token punctuation">]</span>
default_bits            <span class="token operator">=</span> <span class="token number">2048</span>
default_keyfile         <span class="token operator">=</span> <span class="token class-name">privkey<span class="token punctuation">.</span>pem</span>
default_md              <span class="token operator">=</span> <span class="token class-name">sha256</span>
distinguished_name      <span class="token operator">=</span> <span class="token class-name">req_distinguished_name</span>
attributes              <span class="token operator">=</span> <span class="token class-name">req_attributes</span>
x509_extensions         <span class="token operator">=</span> v3_ca # The extensions to <span class="token keyword">add</span> to the self signed <span class="token class-name">cert</span>
string_mask             <span class="token operator">=</span> utf8only

<span class="token punctuation">[</span>req_distinguished_name<span class="token punctuation">]</span>
countryName                     <span class="token operator">=</span> <span class="token return-type class-name">Country</span> Name <span class="token punctuation">(</span><span class="token number">2</span> <span class="token class-name">letter</span> code<span class="token punctuation">)</span>
countryName_min                 <span class="token operator">=</span> <span class="token number">2</span>
countryName_max                 <span class="token operator">=</span> <span class="token number">2</span>
stateOrProvinceName             <span class="token operator">=</span> State <span class="token keyword">or</span> <span class="token return-type class-name">Province</span> Name <span class="token punctuation">(</span><span class="token class-name">full</span> name<span class="token punctuation">)</span>
localityName                    <span class="token operator">=</span> <span class="token return-type class-name">Locality</span> Name <span class="token punctuation">(</span>eg<span class="token punctuation">,</span> city<span class="token punctuation">)</span>
<span class="token number">0</span><span class="token punctuation">.</span>organizationName              <span class="token operator">=</span> <span class="token return-type class-name">Organization</span> Name <span class="token punctuation">(</span>eg<span class="token punctuation">,</span> company<span class="token punctuation">)</span>
organizationalUnitName          <span class="token operator">=</span> Organizational <span class="token return-type class-name">Unit</span> Name <span class="token punctuation">(</span>eg<span class="token punctuation">,</span> section<span class="token punctuation">)</span>
commonName                      <span class="token operator">=</span> <span class="token return-type class-name">Common</span> Name <span class="token punctuation">(</span>eg<span class="token punctuation">,</span> your name <span class="token keyword">or</span> your <span class="token class-name">server</span> hostname<span class="token punctuation">)</span>
commonName_max                  <span class="token operator">=</span> <span class="token number">64</span>
emailAddress                    <span class="token operator">=</span> Email <span class="token class-name">Address</span>
emailAddress_max                <span class="token operator">=</span> <span class="token number">64</span>

<span class="token preprocessor property"># Optionally, 修改下这里填写自己的相关信息</span>
countryName_default             <span class="token operator">=</span> <span class="token class-name">CN</span>
stateOrProvinceName_default     <span class="token operator">=</span> <span class="token class-name">Beijing</span>
localityName_default            <span class="token operator">=</span> Beijing
<span class="token number">0</span><span class="token punctuation">.</span>organizationName_default      <span class="token operator">=</span> <span class="token class-name">Leap</span>
organizationalUnitName_default  <span class="token operator">=</span>
emailAddress_default            <span class="token operator">=</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">req_attributes</span></span><span class="token punctuation">]</span>
challengePassword               <span class="token operator">=</span> A challenge <span class="token class-name">password</span>
challengePassword_min           <span class="token operator">=</span> <span class="token number">4</span>
challengePassword_max           <span class="token operator">=</span> <span class="token number">20</span>
unstructuredName                <span class="token operator">=</span> An optional company name

<span class="token punctuation">[</span>usr_cert<span class="token punctuation">]</span>
basicConstraints                <span class="token operator">=</span> CA<span class="token punctuation">:</span><span class="token class-name">FALSE</span>
nsComment                       <span class="token operator">=</span> <span class="token string">"OpenSSL Generated Certificate"</span>
subjectKeyIdentifier            <span class="token operator">=</span> <span class="token class-name">hash</span>
authorityKeyIdentifier          <span class="token operator">=</span> keyid<span class="token punctuation">,</span><span class="token named-parameter punctuation">issuer</span><span class="token punctuation">:</span>always

<span class="token punctuation">[</span>v3_ca<span class="token punctuation">]</span>
<span class="token preprocessor property"># Extensions for a </span><span class="token return-type class-name">typical</span> CA <span class="token punctuation">(</span>`man x509v3_config`<span class="token punctuation">)</span><span class="token punctuation">.</span>
subjectKeyIdentifier            <span class="token operator">=</span> <span class="token class-name">hash</span>
authorityKeyIdentifier          <span class="token operator">=</span> keyid<span class="token punctuation">:</span>always<span class="token punctuation">,</span><span class="token named-parameter punctuation">issuer</span><span class="token punctuation">:</span><span class="token class-name">always</span>
basicConstraints                <span class="token operator">=</span> critical<span class="token punctuation">,</span> <span class="token named-parameter punctuation">CA</span><span class="token punctuation">:</span><span class="token boolean">true</span>

<span class="token punctuation">[</span> v3_intermediate_ca <span class="token punctuation">]</span>
<span class="token preprocessor property"># Extensions for a typical </span><span class="token return-type class-name">intermediate</span> CA <span class="token punctuation">(</span>`man x509v3_config`<span class="token punctuation">)</span><span class="token punctuation">.</span>
subjectKeyIdentifier <span class="token operator">=</span> <span class="token class-name">hash</span>
authorityKeyIdentifier <span class="token operator">=</span> keyid<span class="token punctuation">:</span>always<span class="token punctuation">,</span><span class="token class-name">issuer</span>
basicConstraints <span class="token operator">=</span> critical<span class="token punctuation">,</span> <span class="token named-parameter punctuation">CA</span><span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">pathlen</span><span class="token punctuation">:</span><span class="token number">0</span>
keyUsage <span class="token operator">=</span> critical<span class="token punctuation">,</span> digitalSignature<span class="token punctuation">,</span> cRLSign<span class="token punctuation">,</span> keyCertSign

</code></pre> 
<p>自己使用的话，可以修改[req_distinguished_name]下的指定的内容为CA的相关信息</p> 
<p>然后我们再建立cnf中需要的文件([ca_default]下)：</p> 
<pre><code class="prism language-csharp">$ touch index<span class="token punctuation">.</span>txt
$ echo <span class="token number">1000</span> <span class="token operator">&gt;</span> serial

</code></pre> 
<p>准备工作完成，我们来生成CA的root cert</p> 
<pre><code class="prism language-csharp">$ openssl req <span class="token operator">-</span>config openssl<span class="token punctuation">.</span>cnf <span class="token operator">-</span><span class="token keyword">new</span> <span class="token operator">-</span>x509 <span class="token operator">-</span>days <span class="token number">3650</span> <span class="token operator">-</span>sha256 \
          <span class="token operator">-</span>key <span class="token keyword">private</span><span class="token operator">/</span>leap_ca_key<span class="token punctuation">.</span>pem <span class="token operator">-</span>extensions v3_ca \
          <span class="token operator">-</span><span class="token keyword">out</span> certs<span class="token operator">/</span>leap_ca_cert<span class="token punctuation">.</span>pem
Enter pass phrase <span class="token keyword">for</span> <span class="token keyword">private</span><span class="token operator">/</span>leap_ca_key<span class="token punctuation">.</span>pem<span class="token punctuation">:</span>
Can't load <span class="token punctuation">.</span>rand <span class="token keyword">into</span> RNG
<span class="token number">139906699818816</span><span class="token punctuation">:</span>error<span class="token punctuation">:</span>2406F079<span class="token punctuation">:</span>random <span class="token class-name">number</span> generator<span class="token punctuation">:</span>RAND_load_file<span class="token punctuation">:</span>Cannot <span class="token class-name">open</span> file<span class="token punctuation">:</span>crypto<span class="token operator">/</span>rand<span class="token operator">/</span>randfile<span class="token punctuation">.</span>c<span class="token punctuation">:</span><span class="token number">98</span><span class="token punctuation">:</span>Filename<span class="token operator">=</span><span class="token punctuation">.</span>rand
You are about to be asked to enter information that will be incorporated
<span class="token keyword">into</span> your certificate request<span class="token punctuation">.</span>
What you are about to enter <span class="token keyword">is</span> <span class="token class-name">what</span> <span class="token keyword">is</span> <span class="token class-name">called</span> a Distinguished Name <span class="token keyword">or</span> a DN<span class="token punctuation">.</span>
There are quite a few fields but you can leave some blank
For some fields there will be a <span class="token keyword">default</span> <span class="token keyword">value</span><span class="token punctuation">,</span>
If you enter <span class="token char">'.'</span><span class="token punctuation">,</span> the field will be left blank<span class="token punctuation">.</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token return-type class-name">Country</span> Name <span class="token punctuation">(</span><span class="token number">2</span> <span class="token class-name">letter</span> code<span class="token punctuation">)</span> <span class="token punctuation">[</span>CN<span class="token punctuation">]</span><span class="token punctuation">:</span>
State <span class="token keyword">or</span> <span class="token return-type class-name">Province</span> Name <span class="token punctuation">(</span><span class="token class-name">full</span> name<span class="token punctuation">)</span> <span class="token punctuation">[</span>Beijing<span class="token punctuation">]</span><span class="token punctuation">:</span>
<span class="token return-type class-name">Locality</span> Name <span class="token punctuation">(</span>eg<span class="token punctuation">,</span> city<span class="token punctuation">)</span> <span class="token punctuation">[</span>Beijing<span class="token punctuation">]</span><span class="token punctuation">:</span>
<span class="token return-type class-name">Organization</span> Name <span class="token punctuation">(</span>eg<span class="token punctuation">,</span> company<span class="token punctuation">)</span> <span class="token punctuation">[</span>Leap<span class="token punctuation">]</span><span class="token punctuation">:</span>
Organizational <span class="token return-type class-name">Unit</span> Name <span class="token punctuation">(</span>eg<span class="token punctuation">,</span> section<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>LeapCA
<span class="token return-type class-name">Common</span> Name <span class="token punctuation">(</span>eg<span class="token punctuation">,</span> your name <span class="token keyword">or</span> your server'<span class="token class-name">s</span> hostname<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>leap<span class="token punctuation">.</span>cn
Email Address <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>

</code></pre> 
<p>这里会出现交互界面，让你来填写，上面有一部分我们已经设定了默认值，除此之外我们需要设定其他的值，比较要注意的是Common Name一般就是指你的域名或者host名</p> 
<p>然后我们验证看下生成root证书：</p> 
<pre><code class="prism language-csharp">$ openssl x509 <span class="token operator">-</span>noout <span class="token operator">-</span>text <span class="token operator">-</span><span class="token keyword">in</span> certs<span class="token operator">/</span><span class="token class-name">leap_ca_cert<span class="token punctuation">.</span>pem</span>
Certificate<span class="token punctuation">:</span>
    Data<span class="token punctuation">:</span>
        Version<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">(</span><span class="token number">0x2</span><span class="token punctuation">)</span>
        <span class="token class-name">Serial</span> Number<span class="token punctuation">:</span>
            <span class="token number">7d</span><span class="token punctuation">:</span>f5<span class="token punctuation">:</span><span class="token number">69</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span>8b<span class="token punctuation">:</span><span class="token number">67</span><span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token number">83</span><span class="token punctuation">:</span><span class="token number">44</span><span class="token punctuation">:</span>a1<span class="token punctuation">:</span><span class="token number">71</span><span class="token punctuation">:</span>c7<span class="token punctuation">:</span>fb<span class="token punctuation">:</span><span class="token number">05</span><span class="token punctuation">:</span>8a<span class="token punctuation">:</span>f1<span class="token punctuation">:</span>c5<span class="token punctuation">:</span><span class="token number">47</span><span class="token punctuation">:</span><span class="token number">59</span>
        <span class="token class-name">Signature</span> Algorithm<span class="token punctuation">:</span> <span class="token class-name">sha256WithRSAEncryption</span>
        Issuer<span class="token punctuation">:</span> C <span class="token operator">=</span> CN<span class="token punctuation">,</span> ST <span class="token operator">=</span> Beijing<span class="token punctuation">,</span> L <span class="token operator">=</span> Beijing<span class="token punctuation">,</span> O <span class="token operator">=</span> Leap<span class="token punctuation">,</span> OU <span class="token operator">=</span> LeapCA<span class="token punctuation">,</span> CN <span class="token operator">=</span> leap<span class="token punctuation">.</span>cn
        Validity
            <span class="token class-name">Not</span> Before<span class="token punctuation">:</span> Oct <span class="token number">25</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">05</span><span class="token punctuation">:</span><span class="token number">32</span> <span class="token number">2021</span> GMT
            <span class="token class-name">Not</span> After <span class="token punctuation">:</span> Oct <span class="token number">23</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">05</span><span class="token punctuation">:</span><span class="token number">32</span> <span class="token number">2031</span> <span class="token class-name">GMT</span>
        Subject<span class="token punctuation">:</span> C <span class="token operator">=</span> CN<span class="token punctuation">,</span> ST <span class="token operator">=</span> Beijing<span class="token punctuation">,</span> L <span class="token operator">=</span> Beijing<span class="token punctuation">,</span> O <span class="token operator">=</span> Leap<span class="token punctuation">,</span> OU <span class="token operator">=</span> LeapCA<span class="token punctuation">,</span> CN <span class="token operator">=</span> leap<span class="token punctuation">.</span>cn
        Subject Public <span class="token class-name">Key</span> Info<span class="token punctuation">:</span>
            Public <span class="token class-name">Key</span> Algorithm<span class="token punctuation">:</span> rsaEncryption
                RSA Public<span class="token operator">-</span>Key<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">4096</span> bit<span class="token punctuation">)</span>
                Modulus<span class="token punctuation">:</span>
        <span class="token range operator">..</span><span class="token punctuation">.</span>
  <span class="token class-name">Signature</span> Algorithm<span class="token punctuation">:</span> sha256WithRSAEncryption
       2c<span class="token punctuation">:</span>e9<span class="token punctuation">:</span>ff<span class="token punctuation">:</span><span class="token number">57</span><span class="token punctuation">:</span>2c<span class="token punctuation">:</span>ca<span class="token punctuation">:</span>4a<span class="token punctuation">:</span>e0<span class="token punctuation">:</span>bc<span class="token punctuation">:</span><span class="token number">35</span><span class="token punctuation">:</span>dc<span class="token punctuation">:</span>e4<span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token number">89</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">:</span>6b<span class="token punctuation">:</span>4c<span class="token punctuation">:</span><span class="token number">44</span><span class="token punctuation">:</span>
       d8<span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">:</span>d7<span class="token punctuation">:</span>cd<span class="token punctuation">:</span>fe<span class="token punctuation">:</span><span class="token number">41</span><span class="token punctuation">:</span><span class="token number">88</span><span class="token punctuation">:</span><span class="token number">76</span><span class="token punctuation">:</span>eb<span class="token punctuation">:</span>c9<span class="token punctuation">:</span><span class="token number">35</span><span class="token punctuation">:</span><span class="token number">92</span><span class="token punctuation">:</span><span class="token number">34</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token number">98</span><span class="token punctuation">:</span>a2<span class="token punctuation">:</span>f0<span class="token punctuation">:</span><span class="token number">4d</span><span class="token punctuation">:</span>
       <span class="token number">23</span><span class="token punctuation">:</span>f5<span class="token punctuation">:</span>1c<span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">:</span><span class="token number">79</span><span class="token punctuation">:</span><span class="token number">75</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">:</span>e6<span class="token punctuation">:</span>a0<span class="token punctuation">:</span>
      <span class="token range operator">..</span><span class="token punctuation">.</span>

</code></pre> 
<p>这里就是和我们平常看到的证书是一样的了，可以看到颁发机构（Issuer）是LeapCA，颁发给（Subject）LeapCA。<br> 包含：</p> 
<ul><li>数字签名（Signature Algorithm）</li><li>有效时间（Validity）</li><li>主体（Issuer）</li><li>公钥（Public Key）</li><li>X509v3 扩展，openssl config 中配置了 v3_ca，所以会生成此项</li><li></ul> 
<p><strong>3.3 设置intermediate CA:</strong><br> 现在已经有了root pair，已经可以证书发放了，不过还是通过中间（intermediate）pair作为root pair的代理来颁发证书。</p> 
<p>新建目录及生成intermediate key：</p> 
<pre><code class="prism language-csharp">$ ls
certs  crl  newcerts  openssl<span class="token punctuation">.</span>cnf  <span class="token keyword">private</span>
$ pwd
<span class="token operator">/</span>etc<span class="token operator">/</span>pki<span class="token operator">/</span>leap<span class="token operator">/</span>ca<span class="token operator">/</span>root
$ cd <span class="token range operator">..</span>
$ mkdir intermediate <span class="token operator">&amp;&amp;</span> cd intermediate
$ mkdir certs crl csr newcerts <span class="token keyword">private</span>

$ openssl genrsa <span class="token operator">-</span>aes256 \
      <span class="token operator">-</span><span class="token keyword">out</span> <span class="token keyword">private</span><span class="token operator">/</span>leap_intermediate_key<span class="token punctuation">.</span>pem <span class="token number">4096</span>
$ chmod <span class="token number">400</span> <span class="token keyword">private</span><span class="token operator">/</span>leap_intermediate_key<span class="token punctuation">.</span>pem

</code></pre> 
<p>生成intermediate key</p> 
<p>最开始还是要设置配置文件，将上一个openssl.cnf拷贝到intermediate目录下，我们修改一下：</p> 
<pre><code class="prism language-csharp"><span class="token preprocessor property"># ...</span>
<span class="token punctuation">[</span>ca_default<span class="token punctuation">]</span>
<span class="token preprocessor property"># ...</span>
certificate             <span class="token operator">=</span> $dir<span class="token operator">/</span>certs<span class="token operator">/</span><span class="token operator">%</span><span class="token class-name">s_intermediate_cert<span class="token punctuation">.</span>pem</span>
private_key             <span class="token operator">=</span> $dir<span class="token operator">/</span><span class="token keyword">private</span><span class="token operator">/</span><span class="token operator">%</span>s_intermediate_key<span class="token punctuation">.</span>pem
<span class="token preprocessor property"># ...</span>
policy                  <span class="token operator">=</span> policy_loose
<span class="token preprocessor property"># ...</span>

<span class="token preprocessor property"># 增加下边</span>
<span class="token punctuation">[</span> <span class="token attribute"><span class="token class-name">server_cert</span></span> <span class="token punctuation">]</span>
<span class="token preprocessor property"># Extensions for </span><span class="token return-type class-name">server</span> certificates <span class="token punctuation">(</span>`man x509v3_config`<span class="token punctuation">)</span><span class="token punctuation">.</span>
basicConstraints <span class="token operator">=</span> CA<span class="token punctuation">:</span><span class="token class-name">FALSE</span>
nsCertType <span class="token operator">=</span> <span class="token class-name">server</span>
nsComment <span class="token operator">=</span> <span class="token string">"OpenSSL Generated Server Certificate"</span>
subjectKeyIdentifier <span class="token operator">=</span> <span class="token class-name">hash</span>
authorityKeyIdentifier <span class="token operator">=</span> keyid<span class="token punctuation">,</span><span class="token named-parameter punctuation">issuer</span><span class="token punctuation">:</span><span class="token class-name">always</span>
keyUsage <span class="token operator">=</span> critical<span class="token punctuation">,</span> digitalSignature<span class="token punctuation">,</span> <span class="token class-name">keyEncipherment</span>
extendedKeyUsage <span class="token operator">=</span> serverAuth<span class="token punctuation">,</span> clientAuth # 如签发的证书单向认证，只需要serverAuth

</code></pre> 
<p>同样也还是建立需要的文件：</p> 
<pre><code class="prism language-csharp">$ touch index<span class="token punctuation">.</span>txt
$ echo <span class="token number">1000</span> <span class="token operator">&gt;</span> serial

</code></pre> 
<p>生成csr文件：</p> 
<pre><code class="prism language-csharp">$ openssl req <span class="token operator">-</span>config openssl<span class="token punctuation">.</span>cnf <span class="token operator">-</span><span class="token keyword">new</span> <span class="token operator">-</span>sha256 \
      <span class="token operator">-</span>key <span class="token keyword">private</span><span class="token operator">/</span>leap_intermediate_key<span class="token punctuation">.</span>pem \
      <span class="token operator">-</span><span class="token keyword">out</span> csr<span class="token operator">/</span>leap_intermediate_csr<span class="token punctuation">.</span>pem
You are about to be asked to enter information that will be incorporated
<span class="token keyword">into</span> your certificate request<span class="token punctuation">.</span>
What you are about to enter <span class="token keyword">is</span> <span class="token class-name">what</span> <span class="token keyword">is</span> <span class="token class-name">called</span> a Distinguished Name <span class="token keyword">or</span> a DN<span class="token punctuation">.</span>
There are quite a few fields but you can leave some blank
For some fields there will be a <span class="token keyword">default</span> <span class="token keyword">value</span><span class="token punctuation">,</span>
If you enter <span class="token char">'.'</span><span class="token punctuation">,</span> the field will be left blank<span class="token punctuation">.</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token return-type class-name">Country</span> Name <span class="token punctuation">(</span><span class="token number">2</span> <span class="token class-name">letter</span> code<span class="token punctuation">)</span> <span class="token punctuation">[</span>CN<span class="token punctuation">]</span><span class="token punctuation">:</span>
State <span class="token keyword">or</span> <span class="token return-type class-name">Province</span> Name <span class="token punctuation">(</span><span class="token class-name">full</span> name<span class="token punctuation">)</span> <span class="token punctuation">[</span>Beijing<span class="token punctuation">]</span><span class="token punctuation">:</span>
<span class="token return-type class-name">Locality</span> Name <span class="token punctuation">(</span>eg<span class="token punctuation">,</span> city<span class="token punctuation">)</span> <span class="token punctuation">[</span>Beijing<span class="token punctuation">]</span><span class="token punctuation">:</span>
<span class="token return-type class-name">Organization</span> Name <span class="token punctuation">(</span>eg<span class="token punctuation">,</span> company<span class="token punctuation">)</span> <span class="token punctuation">[</span>Leap<span class="token punctuation">]</span><span class="token punctuation">:</span>
Organizational <span class="token return-type class-name">Unit</span> Name <span class="token punctuation">(</span>eg<span class="token punctuation">,</span> section<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>LeapIntermediate
<span class="token return-type class-name">Common</span> Name <span class="token punctuation">(</span>eg<span class="token punctuation">,</span> your name <span class="token keyword">or</span> your server'<span class="token class-name">s</span> hostname<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>leap<span class="token punctuation">.</span>sub<span class="token punctuation">.</span>cn
Email Address <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">passwd</span></span><span class="token punctuation">]</span> # passwd
An optional company name <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>   

</code></pre> 
<p>这里生成csr文件需要填写内容和之前很相似，除了需要设置csr的一些信息，要注意的是CommanName不要和CA一样。</p> 
<p>接下来通过root pair来为intermediate pair生成证书：</p> 
<pre><code class="prism language-csharp"><span class="token preprocessor property"># 用到刚刚生成csr文件</span>
$ cd <span class="token range operator">..</span><span class="token operator">/</span>root
$ openssl ca <span class="token operator">-</span>config openssl<span class="token punctuation">.</span>cnf <span class="token operator">-</span>extensions v3_intermediate_ca \
      <span class="token operator">-</span>keyfile <span class="token keyword">private</span><span class="token operator">/</span>leap_ca_key<span class="token punctuation">.</span>pem \
      <span class="token operator">-</span>cert certs<span class="token operator">/</span>leap_ca_cert<span class="token punctuation">.</span>pem \
      <span class="token operator">-</span>days <span class="token number">3650</span> <span class="token operator">-</span>notext <span class="token operator">-</span>md sha256 \
      <span class="token operator">-</span><span class="token keyword">in</span> <span class="token range operator">..</span><span class="token operator">/</span>intermediate<span class="token operator">/</span>csr<span class="token operator">/</span>leap_intermediate_csr<span class="token punctuation">.</span>pem \
      <span class="token operator">-</span><span class="token keyword">out</span> <span class="token range operator">..</span><span class="token operator">/</span>intermediate<span class="token operator">/</span>certs<span class="token operator">/</span>leap_intermediate_cert<span class="token punctuation">.</span>pem
<span class="token preprocessor property"># ...</span>
Signature ok
<span class="token class-name">Certificate</span> Details<span class="token punctuation">:</span>
        <span class="token class-name">Serial</span> Number<span class="token punctuation">:</span> <span class="token number">4096</span> <span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">)</span>
        Validity
            <span class="token class-name">Not</span> Before<span class="token punctuation">:</span> Oct <span class="token number">26</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">54</span><span class="token punctuation">:</span><span class="token number">20</span> <span class="token number">2021</span> GMT
            <span class="token class-name">Not</span> After <span class="token punctuation">:</span> Oct <span class="token number">24</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">54</span><span class="token punctuation">:</span><span class="token number">20</span> <span class="token number">2031</span> <span class="token class-name">GMT</span>
        Subject<span class="token punctuation">:</span>
            countryName               <span class="token operator">=</span> <span class="token class-name">CN</span>
            stateOrProvinceName       <span class="token operator">=</span> <span class="token class-name">Beijing</span>
            organizationName          <span class="token operator">=</span> <span class="token class-name">Leap</span>
            organizationalUnitName    <span class="token operator">=</span> <span class="token class-name">LeapIntermediate</span>
            commonName                <span class="token operator">=</span> leap<span class="token punctuation">.</span>sub<span class="token punctuation">.</span>cn  
<span class="token preprocessor property"># ...</span>
Certificate <span class="token keyword">is</span> <span class="token class-name">to</span> be certified until Oct <span class="token number">24</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">54</span><span class="token punctuation">:</span><span class="token number">20</span> <span class="token number">2031</span> GMT <span class="token punctuation">(</span><span class="token number">3650</span> days<span class="token punctuation">)</span>
Sign the certificate<span class="token punctuation">?</span> <span class="token punctuation">[</span>y<span class="token operator">/</span>n<span class="token punctuation">]</span><span class="token punctuation">:</span>y

<span class="token number">1</span> <span class="token keyword">out</span> of <span class="token number">1</span> certificate <span class="token class-name">requests</span> certified<span class="token punctuation">,</span> commit<span class="token punctuation">?</span> <span class="token punctuation">[</span>y<span class="token operator">/</span>n<span class="token punctuation">]</span>y
Write <span class="token keyword">out</span> database with <span class="token number">1</span> <span class="token keyword">new</span> entries
Data Base Updated

</code></pre> 
<p>表示生成成功，看下index.txt多一条记录</p> 
<pre><code class="prism language-csharp">V 311024085420Z <span class="token number">1000</span> unknown <span class="token operator">/</span>C<span class="token operator">=</span>CN<span class="token operator">/</span>ST<span class="token operator">=</span>Beijing<span class="token operator">/</span>O<span class="token operator">=</span>Leap<span class="token operator">/</span>OU<span class="token operator">=</span>LeapIntermediate<span class="token operator">/</span>CN<span class="token operator">=</span>leap<span class="token punctuation">.</span>sub<span class="token punctuation">.</span>cn

</code></pre> 
<p>再来验证下生成的证书：</p> 
<pre><code class="prism language-csharp">$ openssl verify <span class="token operator">-</span>CAfile certs<span class="token operator">/</span>leap_ca_cert<span class="token punctuation">.</span>pem \
     <span class="token range operator">..</span><span class="token operator">/</span>intermediate<span class="token operator">/</span>certs<span class="token operator">/</span>leap_intermediate_cert<span class="token punctuation">.</span>pem
<span class="token range operator">..</span><span class="token operator">/</span>intermediate<span class="token operator">/</span>certs<span class="token operator">/</span>leap_intermediate_cert<span class="token punctuation">.</span>pem<span class="token punctuation">:</span> OK

</code></pre> 
<p><strong>3.4 创建证书链:</strong><br> 浏览器在验证中间证书的时候，同时也会去验证它的上一级证书是否靠谱，创建证书链，将 root cert 和 intermediate cert 合并到一起，可以让浏览器一并验证：</p> 
<pre><code class="prism language-csharp">$ cat <span class="token range operator">..</span><span class="token operator">/</span>intermediate<span class="token operator">/</span>certs<span class="token operator">/</span>leap_intermediate_cert<span class="token punctuation">.</span>pem \
    certs<span class="token operator">/</span>leap_ca_cert<span class="token punctuation">.</span>pem <span class="token operator">&gt;</span> <span class="token range operator">..</span><span class="token operator">/</span>intermediate<span class="token operator">/</span>certs<span class="token operator">/</span>leap_ca_chain_cert<span class="token punctuation">.</span>pem
$ chmod <span class="token number">444</span> <span class="token range operator">..</span><span class="token operator">/</span>intermediate<span class="token operator">/</span>certs<span class="token operator">/</span>leap_ca_chain_cert<span class="token punctuation">.</span>pem

</code></pre> 
<p><strong>3.5 使用intermediate pair为客户端和服务器创建证书</strong><br> CA的角色既然已经创建完成了，下一步就是为通信的双方创建证书了，有一点要明确的是tls/ssl分为双向认证和单向认证。如果双向认证，客户端和服务端都要有自己的证书，如果单向认证，只需要服务端有自己的证书，平常浏览器访问就是单向认证，为什么单向认证？其实原因也很简单，总不能给每个人（浏览器端）都颁发一个证书吧，所以https这里采用的是单向认证。这里客户端和服务器都生成自己的证书。</p> 
<p>为客户端生成pair:</p> 
<pre><code class="prism language-csharp">$ cd <span class="token range operator">..</span>
$ pwd
<span class="token operator">/</span>etc<span class="token operator">/</span>pki<span class="token operator">/</span>leap<span class="token operator">/</span>ca
$ mkdir leap<span class="token punctuation">.</span>client<span class="token punctuation">.</span>cn

<span class="token preprocessor property"># 生成key</span>
$ openssl genrsa <span class="token operator">-</span>aes256 <span class="token operator">-</span><span class="token keyword">out</span> leap<span class="token punctuation">.</span>client<span class="token punctuation">.</span>cn<span class="token operator">/</span>leap_client_key<span class="token punctuation">.</span>pem <span class="token number">2048</span>

<span class="token preprocessor property"># 生成csr，Common Name设置为leap.client.cn</span>
$ openssl req <span class="token operator">-</span>config intermediate<span class="token operator">/</span>openssl<span class="token punctuation">.</span>cnf \
      <span class="token operator">-</span>key leap<span class="token punctuation">.</span>client<span class="token punctuation">.</span>cn<span class="token operator">/</span>leap_client_key<span class="token punctuation">.</span>pem \
      <span class="token operator">-</span><span class="token keyword">new</span> <span class="token operator">-</span>sha256 <span class="token operator">-</span><span class="token keyword">out</span> leap<span class="token punctuation">.</span>client<span class="token punctuation">.</span>cn<span class="token operator">/</span>leap_client_csr<span class="token punctuation">.</span>pem
      
<span class="token preprocessor property"># 使用intermediate pair为client生成cert</span>
$ cd intermediate
$ openssl ca <span class="token operator">-</span>config openssl<span class="token punctuation">.</span>cnf \
    <span class="token operator">-</span>extensions server_cert <span class="token operator">-</span>days <span class="token number">375</span> <span class="token operator">-</span>notext <span class="token operator">-</span>md sha256 \
    <span class="token operator">-</span>keyfile <span class="token keyword">private</span><span class="token operator">/</span>leap_intermediate_key<span class="token punctuation">.</span>pem \
    <span class="token operator">-</span>cert certs<span class="token operator">/</span>leap_intermediate_cert<span class="token punctuation">.</span>pem \
    <span class="token operator">-</span><span class="token keyword">in</span> <span class="token range operator">..</span><span class="token operator">/</span>leap<span class="token punctuation">.</span>client<span class="token punctuation">.</span>cn<span class="token operator">/</span>leap_client_csr<span class="token punctuation">.</span>pem \
    <span class="token operator">-</span><span class="token keyword">out</span> <span class="token range operator">..</span><span class="token operator">/</span>leap<span class="token punctuation">.</span>client<span class="token punctuation">.</span>cn<span class="token operator">/</span>leap_client_cert<span class="token punctuation">.</span>pem

</code></pre> 
<p>为服务端生成pair:</p> 
<pre><code class="prism language-csharp">$ cd <span class="token range operator">..</span>
$ pwd
<span class="token operator">/</span>etc<span class="token operator">/</span>pki<span class="token operator">/</span>leap<span class="token operator">/</span>ca
$ mkdir leap<span class="token punctuation">.</span>server<span class="token punctuation">.</span>cn

<span class="token preprocessor property"># 生成key</span>
$ openssl genrsa <span class="token operator">-</span>aes256 <span class="token operator">-</span><span class="token keyword">out</span> leap<span class="token punctuation">.</span>server<span class="token punctuation">.</span>cn<span class="token operator">/</span>leap_server_key<span class="token punctuation">.</span>pem <span class="token number">2048</span>

<span class="token preprocessor property"># 生成csr, Common Name设置为leap.server.cn</span>
$ openssl req <span class="token operator">-</span>config intermediate<span class="token operator">/</span>openssl<span class="token punctuation">.</span>cnf \
      <span class="token operator">-</span>key leap<span class="token punctuation">.</span>server<span class="token punctuation">.</span>cn<span class="token operator">/</span>leap_server_key<span class="token punctuation">.</span>pem \
      <span class="token operator">-</span><span class="token keyword">new</span> <span class="token operator">-</span>sha256 <span class="token operator">-</span><span class="token keyword">out</span> leap<span class="token punctuation">.</span>server<span class="token punctuation">.</span>cn<span class="token operator">/</span>leap_server_csr<span class="token punctuation">.</span>pem
      
<span class="token preprocessor property"># 使用intermediate pair为server生成cert</span>
$ cd intermediate
$ openssl ca <span class="token operator">-</span>config openssl<span class="token punctuation">.</span>cnf \
    <span class="token operator">-</span>extensions server_cert <span class="token operator">-</span>days <span class="token number">375</span> <span class="token operator">-</span>notext <span class="token operator">-</span>md sha256 \
    <span class="token operator">-</span>keyfile <span class="token keyword">private</span><span class="token operator">/</span>leap_intermediate_key<span class="token punctuation">.</span>pem \
    <span class="token operator">-</span>cert certs<span class="token operator">/</span>leap_intermediate_cert<span class="token punctuation">.</span>pem \
    <span class="token operator">-</span><span class="token keyword">in</span> <span class="token range operator">..</span><span class="token operator">/</span>leap<span class="token punctuation">.</span>server<span class="token punctuation">.</span>cn<span class="token operator">/</span>leap_server_csr<span class="token punctuation">.</span>pem \
    <span class="token operator">-</span><span class="token keyword">out</span> <span class="token range operator">..</span><span class="token operator">/</span>leap<span class="token punctuation">.</span>server<span class="token punctuation">.</span>cn<span class="token operator">/</span>leap_server_cert<span class="token punctuation">.</span>pem

</code></pre> 
<p>到这里我们就为server和client分别生成了pair，接下来我们就通过实例来验证下生成的证书是否正确。</p> 
<p><strong>4. 实例看双向认证</strong><br> 这里我们就使用上面生成的证书密钥等文件来通过实例来演示看下双向认证（go语言）：</p> 
<p><strong>4.1 准备</strong><br> 首先第一步将生成证书链文件，服务器的key和cert文件，客户端的key和cert文件拷贝到工程中以备使用，新建一个客户端程序文件和服务端程序文件，结构如图所示：<br> <img src="https://images2.imgbox.com/ff/3a/gWVg7hD0_o.png" alt="在这里插入图片描述"><br> 证书文件我给重命名了下（去掉leap_前缀）,这里使用因为我们private key都是加了密的（没有加密忽略此步骤），所以使用时候需要解密才能使用，指令为：</p> 
<pre><code class="prism language-csharp">openssl rsa <span class="token operator">-</span><span class="token keyword">in</span> leap_server_key<span class="token punctuation">.</span>pem <span class="token operator">-</span><span class="token keyword">out</span> server_key<span class="token punctuation">.</span>pem <span class="token operator">-</span><span class="token class-name">passin</span> pass<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token class-name">your</span> passwd<span class="token punctuation">]</span>
openssl rsa <span class="token operator">-</span><span class="token keyword">in</span> leap_client_key<span class="token punctuation">.</span>pem <span class="token operator">-</span><span class="token keyword">out</span> client_key<span class="token punctuation">.</span>pem <span class="token operator">-</span><span class="token class-name">passin</span> pass<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token class-name">your</span> passwd<span class="token punctuation">]</span>

</code></pre> 
<p><strong>4.2 服务端代码</strong></p> 
<pre><code class="prism language-csharp">package <span class="token return-type class-name">main</span>

import <span class="token punctuation">(</span>
  <span class="token comment">// ...(略)</span>
<span class="token punctuation">)</span>

<span class="token return-type class-name">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	pool <span class="token punctuation">:</span><span class="token operator">=</span> x509<span class="token punctuation">.</span><span class="token function">NewCertPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> ca<span class="token punctuation">,</span> <span class="token named-parameter punctuation">e</span> <span class="token punctuation">:</span><span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">"ca_chain_cert.pem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"ReadFile: "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		pool<span class="token punctuation">.</span><span class="token function">AppendCertsFromPEM</span><span class="token punctuation">(</span>ca<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	s <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{<!-- --></span>
		Addr<span class="token punctuation">:</span> <span class="token string">":443"</span><span class="token punctuation">,</span>
		<span class="token named-parameter punctuation">Handler</span><span class="token punctuation">:</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Hello World!\n"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token named-parameter punctuation">TLSConfig</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">{<!-- --></span>
			ClientCAs<span class="token punctuation">:</span>  pool<span class="token punctuation">,</span>
			<span class="token named-parameter punctuation">ClientAuth</span><span class="token punctuation">:</span> tls<span class="token punctuation">.</span>RequireAndVerifyClientCert<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	e <span class="token punctuation">:</span><span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">ListenAndServeTLS</span><span class="token punctuation">(</span><span class="token string">"server_cert.pem"</span><span class="token punctuation">,</span> <span class="token string">"server_key.pem"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> e <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"ListenAndServeTLS: "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>程序也比较简单，初始化一个http.Server，进行一些配置，里面初始化CA，然后设置cert和key并监听启动服务</p> 
<p><strong>4.3 客户端代码</strong></p> 
<pre><code class="prism language-csharp">package <span class="token return-type class-name">main</span>

import <span class="token punctuation">(</span>
  <span class="token comment">// ...(略)</span>
<span class="token punctuation">)</span>

<span class="token return-type class-name">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	pool <span class="token punctuation">:</span><span class="token operator">=</span> x509<span class="token punctuation">.</span><span class="token function">NewCertPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> ca<span class="token punctuation">,</span> <span class="token named-parameter punctuation">e</span> <span class="token punctuation">:</span><span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">"ca_chain_cert.pem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"ReadFile: "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		pool<span class="token punctuation">.</span><span class="token function">AppendCertsFromPEM</span><span class="token punctuation">(</span>ca<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	pair<span class="token punctuation">,</span> <span class="token named-parameter punctuation">e</span> <span class="token punctuation">:</span><span class="token operator">=</span> tls<span class="token punctuation">.</span><span class="token function">LoadX509KeyPair</span><span class="token punctuation">(</span><span class="token string">"client_cert.pem"</span><span class="token punctuation">,</span> <span class="token string">"client_key.pem"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> e <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"LoadX509KeyPair:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	client <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{<!-- --></span>
		Transport<span class="token punctuation">:</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">{<!-- --></span>
			TLSClientConfig<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">{<!-- --></span>
				RootCAs<span class="token punctuation">:</span>      pool<span class="token punctuation">,</span>
				<span class="token named-parameter punctuation">Certificates</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tls<span class="token punctuation">.</span>Certificate<span class="token punctuation">{<!-- --></span>pair<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">}</span>

	resp<span class="token punctuation">,</span> <span class="token named-parameter punctuation">e</span> <span class="token punctuation">:</span><span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"https://leap.server.cn"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> e <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"http.Client.Get: "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token return-type class-name">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>代码比较类似，新建client对象，将ca，cert，key等进行配置，不过要注意的一点是域名要使用服务端生成证书里面的域名： leap.server.cn，即我们在生成csr的时候Common Name。</p> 
<p>本例中跑在一台机器，所以需要设置hosts文件：</p> 
<pre><code class="prism language-csharp">$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>hosts
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span>   leap<span class="token punctuation">.</span>server<span class="token punctuation">.</span>cn

</code></pre> 
<p><strong>4.4 运行</strong><br> 然后我们来运行下：</p> 
<pre><code class="prism language-csharp"><span class="token preprocessor property"># 启动服务器</span>
$ go build tls_server<span class="token punctuation">.</span>go
$ <span class="token punctuation">.</span><span class="token operator">/</span>tls_server

<span class="token preprocessor property"># 启动客户端</span>
$ go build tls_client<span class="token punctuation">.</span>go 
$ <span class="token punctuation">.</span><span class="token operator">/</span>tls_client 
<span class="token number">2021</span><span class="token operator">/</span><span class="token number">10</span><span class="token operator">/</span><span class="token number">27</span> <span class="token number">19</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">45</span> http<span class="token punctuation">.</span>Client<span class="token punctuation">.</span>Get<span class="token punctuation">:</span> Get <span class="token string">"https://leap.server.cn"</span><span class="token punctuation">:</span> x509<span class="token punctuation">:</span> certificate relies <span class="token keyword">on</span> legacy Common <span class="token class-name">Name</span> field<span class="token punctuation">,</span> use SANs <span class="token keyword">or</span> temporarily enable Common Name matching <span class="token class-name">with</span> GODEBUG<span class="token operator">=</span>x509ignoreCN<span class="token operator">=</span><span class="token number">0</span>

</code></pre> 
<p>发现启动客户端时报错，原因是因为go 1.15 版本开始废弃 CommonName，推荐使用 SAN 证书。 如果想兼容之前的方式，需要设置环境变量 GODEBUG 为 x509ignoreCN=0。两种解决方案，要么重新生成SAN证书，要么就是设置环境变量 GODEBUG 为 x509ignoreCN=0，首先第二种解决方案如下：</p> 
<pre><code class="prism language-csharp">$ GODEBUG<span class="token operator">=</span>x509ignoreCN<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">.</span><span class="token operator">/</span>tls_client 
Hello World<span class="token operator">!</span>

</code></pre> 
<p>不过浏览器使用的话，也会验证服务端证书的这个字段，所以还是重新生成下服务端的证书，需要修改intermediate/openssl.conf下的[ server_cert ]下增加一个item并增加[alt_names]的group：</p> 
<pre><code class="prism language-csharp"><span class="token punctuation">[</span> <span class="token attribute"><span class="token class-name">server_cert</span></span> <span class="token punctuation">]</span>
subjectAltName <span class="token operator">=</span> @alt_names

<span class="token punctuation">[</span>alt_names<span class="token punctuation">]</span>
DNS<span class="token punctuation">.</span><span class="token number">1</span> <span class="token operator">=</span> leap<span class="token punctuation">.</span>server<span class="token punctuation">.</span>cn

</code></pre> 
<p>用这个cnf重新执行生成服务端证书的步骤，这样就不需要加GODEBUG了：</p> 
<pre><code class="prism language-csharp">$ <span class="token punctuation">.</span><span class="token operator">/</span>tls_client 
Hello World<span class="token operator">!</span>

</code></pre> 
<p>好的验证成功，已完成。</p> 
<p><strong>5. 抓包看单向认证</strong><br> 我们平时使用的https还是单向认证的，就是平常浏览器访问服务器这种情况，单向认证只是比双向认证少服务端验证客户端证书的步骤，借此来抓包，详细的分析下https的协议。</p> 
<p><strong>5.1 准备工作</strong><br> 首先我们先跑起来，然后再来观察现象，把之前生成证书链复制到系统中，这里使用windows系统，然后把他安装到计算机中。步骤如下：</p> 
<p>修改hosts，使得leap.server.cn的ip地址是运行服务端程序的机器<br> 重命名证书链后缀名为crt，这样windows系统可以识别此文件<br> 右键点击选择安装证书-&gt;本地计算机-&gt;将所有证书都放入下列存储-&gt;浏览选择”受信任的根证书颁发机构”-&gt;下一页-&gt;完成</p> 
<p>我们来检查下，打开浏览器(chrome为例)设置-&gt;隐私设置和安全性-&gt;安全-&gt;管理证书，就可以看到证书<br> <strong>5.2 服务器代码重写</strong><br> 服务端的程序还需要修改下，因为之前那个服务端程序是会去验证客户端的，需要写一个不验证客户端证书的服务端程序，代码超级简单：</p> 
<pre><code class="prism language-csharp"><span class="token return-type class-name">func</span> <span class="token function">handler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"https world!"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token return-type class-name">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token punctuation">:</span><span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServeTLS</span><span class="token punctuation">(</span><span class="token string">":443"</span><span class="token punctuation">,</span> <span class="token string">"server_cert.pem"</span><span class="token punctuation">,</span> <span class="token string">"server_key.pem"</span><span class="token punctuation">,</span> nil<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"ListenAndServe:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>最后使用浏览器访问下：<br> <img src="https://images2.imgbox.com/23/c9/XhcpHdYv_o.png" alt="在这里插入图片描述"><br> 访问成功，网址那里也有一个锁头表示此网站是安全的。</p> 
<p><strong>5.3 wireshark抓包看</strong><br> 接下来用wireshark抓包看下先：<br> <img src="https://images2.imgbox.com/8d/f5/1ytpPQ1o_o.png" alt="在这里插入图片描述"><br> 192.168.77.1是客户端浏览器，192.168.77.133是服务器， 简单过下流程：</p> 
<p>首先完成tcp握手后，client发起Client hello，这里会传送客户端支持的tls版本，一个随机数（后期生成密钥使用），支持的加密算法，支持的压缩算法等</p> 
<p>服务端收到请求后，发送Service Hello，这里包含选择的tls版本，服务器生成的随机数（后期生成密钥使用），选中的加密算法，选中的压缩算法。</p> 
<p>然后服务端会发送证书给客户端，发送使用证书签名的握手信息等</p> 
<p>客户端验证证书完成，发送使用加密信息发送的通知，并结束</p> 
<p>之后就是客户端请求服务端的消息了（黄色部分）</p> 
<p>这里抓包的tls是1.3版本，并未深入讲解，着重讲解两个点：</p> 
<ul><li> <p>a.<br> tls握手阶段，会根据随机值等协商一个对称加密的密钥，后面的通信都是使用这个密钥来加密。总结来说握手阶段会用到服务端的非对称密钥传输协商，协商出对称密钥用于后期的数据加密</p> </li><li> <p>b. 客户端验证证书环节，是怎样来验证呢？</p> <p>首先浏览器读取证书中的证书所有者、有效期等信息进行校验，校验证书的网站域名是否与证书颁发的域名一致，校验证书是否在有效期内等等</p> <p>然后查找操作系统中已内置的受信任的证书发布机构CA，与服务器发来的证书中的颁发者CA比对，用于校验证书是否为合法机构颁发</p> <p>最后就是验证证书的完整性和正确性了，我们前面介绍过：</p> </li></ul> 
<pre><code class="prism language-csharp">$ openssl verify <span class="token operator">-</span>CAfile certs<span class="token operator">/</span>leap_ca_cert<span class="token punctuation">.</span>pem \
     <span class="token range operator">..</span><span class="token operator">/</span>intermediate<span class="token operator">/</span>certs<span class="token operator">/</span>leap_intermediate_cert<span class="token punctuation">.</span>pem
<span class="token range operator">..</span><span class="token operator">/</span>intermediate<span class="token operator">/</span>certs<span class="token operator">/</span>leap_intermediate_cert<span class="token punctuation">.</span>pem<span class="token punctuation">:</span> OK

</code></pre> 
<p>不过这里做了什么呢？我们仔细看下证书的部分分为摘要信息和签名信息（Signature），当在签发的时候，CA会把持有者的公钥、用途、颁发者、有效时间等信息进行Hash计算，得到一个Hash值，Hash值使用CA的私钥加密，生成Certificate Signature，也就是签名信息。这样当客户端验证的时候使用CA的公钥解密，并将服务端的公钥的摘要信息使用Hash计算判断二者是否相等，从而能够验证证书的完整性和正确性</p> 
<p><strong>6. 总结</strong><br> 整体来说我们把https和证书颁发这块知识讲解了下，https使用tls/ssl来进行加密，其中https分为双向验证和单向验证，双向验证比如说银行的一些交易客户这边需要U盾或者其他就是验证客户端的证书，而我们平常浏览器访问不需要验证客户端就是单向认证。篇幅原因tls详细没有展开讲，感谢阅读</p> 
<p><strong>7.ref</strong><br> https://www.barretlee.com/blog/2016/04/24/detail-about-ca-and-certs/<br> https://zq99299.github.io/note-book2/http-protocol/</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e7c0a9a4cf1374017b0c86d478c33bee/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Eclipse Plug-in 向导页（八）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/888e71f1eac332bd6c552190b5b10b50/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue使用高德地图关键字搜索功能的实例代码(踩坑经验)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>