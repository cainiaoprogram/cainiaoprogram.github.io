<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CAN-位时间与同步-1 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CAN-位时间与同步-1" />
<meta property="og:description" content="参考链接：
CAN总线个人知识总结_哔哩哔哩_bilibili
CAN通讯之位定时与同步
目录
同步
CAN为什么需要同步？
同步方式
概念——位时间
概念——采样点
实现——硬同步
实现——再同步/重同步
调整同步的规则
编码
曼彻斯特编码
NRZ编码
同步 同步：通常依靠电平信号的边沿达到同步目的。
CAN为什么需要同步？ 因为CAN总线信号传输是异步串行方式，我们一般通过波特率的设置来使得各个节点发送的信号频率一致。
发送单元以与位时序同步的方式开始发送数据，接收单元根据总线上电平的变化进行同步并进行接收工作。
CAN报文在CAN总线上传输时，两个硬件部分存在相应延迟：
在CAN-BUS上传输造成的延迟——传输路径上的（电缆、驱动器等）相位延迟
在节点上传输造成延迟——发送单元和接收单元存在的时钟频率误差
另外，CAN采用NRZ编码，这种编码方式能充分利用带宽，减小电平跳变引起的干扰，但却不具备时钟功能。（关于NRZ的原理介绍在本文末尾）。上面两种延迟无法使用当前编码方式解决。
因此CAN需要采用额外的定时方法来达到收发信号的同步。
因此接收单元通过硬件同步或者再同步的方法调整时序进行接收。
同步方式 CAN有3种同步方式：位填充，硬同步，重同步。
位填充：就是在检测到总线上有连续5个相同电平时，CAN控制器自动插入一个相反电平。除了用来做同步定时，也可用于错误校验。
硬同步：接收节点检测出帧起始位（SOF）时，调整自己的SS同步段位置，使其与发送节点的帧起始位SS一致，调整宽度不限。
重同步/再同步：接收节点检测出除SOF位以外的其他位时进行的同步调整，接收端调整PBS相位缓冲段(PBS1,PBS2)。
下面通过对位时间、采样点的介绍，描述硬同步、重同步的实现方法。
概念——位时间 一个bit是信号的最小单位，但1bit也是持续了一段时间的。又称位时间。
一个位分为4段，每个段又由若干个Tq（Time Quantum）构成，这称为位时序。
概念——采样点 在位时间内是总线上的电平值是连续值，而我们读取的值只是某个时刻的离散数值。
那么将哪个时刻的电平值，作为我们最终的读取值，就是采样点的选取问题。
目前的采样点，设置在PBS1结束处。
实现——硬同步 硬同步是指在总线空闲状态，接收节点检测出帧起始位（SOF）时，会调整当前位的同步段（SS）与发送节点的帧起始位SS段一样，调整宽度不限。
实现的具体步骤: 1）发送节点Node_A在发送SOF位时，SOF位的下降沿在SS段； 2）这时接收节点Node_B发现自己当前位的SS段和发送节点SOF位的SS段不同步。也就是说当Node_A 产生SOF位SS段时，Node_B的当前位的SS段已经在5个Tq之前产生了； 3）这样接收节点Node_B硬将自己当前位的SS段拉到与SOF位的SS段同步。
实现——再同步/重同步 再同步是指接收节点检测出除SOF位以外的其他位时进行的同步调整。
再同步会通过加长PBS1段，或缩短PBS2段来调整同步，以保证采样点的准确。
对于PBS1，PBS2的调整长度是有限制的，即SJW。
概念——SJW
同步跳转宽度（SJW）是指PBS1和PBS2再同步时允许跳转的最大宽度，其必须满足以下2个条件：
SJW必须小于PBS1和PBS2的最小值；
SJW最大值不能超过4。
下面是重同步的两种情况：
情况1：PBS1段加长（发的晚，收的早）
步骤： 1）发送节点Node_A比接收节点Node_B的时间慢了，也就是说Node_A当前位的ss段产生的时候，Node_B 当前位的SS段已经在2个Tq之前产生了； 2）这时接收节点Node_B就将PBS1延长2个Tq的时间； 3）这样Node_A当前位的采样点就和Node_B的采样点同步了。 情况2：PBS2段缩短（发的早，收的晚）
1）发送节点Node_A当前位的SS段诞生2Tq时长之后，接收节点Node_B的当前位才产生SS段； 2）这时接收节点Node_B当前位的PBS2段缩短， 3）这样就导致接收节点Node_B的下一位能够提前2个Tq，从而Node_B的下一位采样点和Node_A下一位 的采样点能够同步。 调整同步的规则 硬同步和再同步遵从如下规则。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/506bcc16576f3057a4642acd65ccd4ec/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-13T18:12:47+08:00" />
<meta property="article:modified_time" content="2022-04-13T18:12:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CAN-位时间与同步-1</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>参考链接：</p> 
<p><a href="https://www.bilibili.com/video/BV1d7411i7Ey/?spm_id_from=autoNext" rel="nofollow" title="CAN总线个人知识总结_哔哩哔哩_bilibili">CAN总线个人知识总结_哔哩哔哩_bilibili</a></p> 
<p><a href="https://mp.weixin.qq.com/s/r6APB3OtJMLl-lzAoC4Veg" rel="nofollow" title="CAN通讯之位定时与同步">CAN通讯之位定时与同步</a></p> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="%E5%90%8C%E6%AD%A5-toc" style="margin-left:0px;"><a href="#%E5%90%8C%E6%AD%A5" rel="nofollow">同步</a></p> 
<p id="CAN%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%90%8C%E6%AD%A5%EF%BC%9F-toc" style="margin-left:40px;"><a href="#CAN%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%90%8C%E6%AD%A5%EF%BC%9F" rel="nofollow">CAN为什么需要同步？</a></p> 
<p id="%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F-toc" style="margin-left:40px;"><a href="#%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F" rel="nofollow">同步方式</a></p> 
<p id="%E6%A6%82%E5%BF%B5%E2%80%94%E2%80%94%E4%BD%8D%E6%97%B6%E9%97%B4-toc" style="margin-left:80px;"><a href="#%E6%A6%82%E5%BF%B5%E2%80%94%E2%80%94%E4%BD%8D%E6%97%B6%E9%97%B4" rel="nofollow">概念——位时间</a></p> 
<p id="%E6%A6%82%E5%BF%B5%E2%80%94%E2%80%94%E9%87%87%E6%A0%B7%E7%82%B9-toc" style="margin-left:80px;"><a href="#%E6%A6%82%E5%BF%B5%E2%80%94%E2%80%94%E9%87%87%E6%A0%B7%E7%82%B9" rel="nofollow">概念——采样点</a></p> 
<p id="%E5%AE%9E%E7%8E%B0%E2%80%94%E2%80%94%E7%A1%AC%E5%90%8C%E6%AD%A5-toc" style="margin-left:80px;"><a href="#%E5%AE%9E%E7%8E%B0%E2%80%94%E2%80%94%E7%A1%AC%E5%90%8C%E6%AD%A5" rel="nofollow">实现——硬同步</a></p> 
<p id="%E5%AE%9E%E7%8E%B0%E2%80%94%E2%80%94%E5%86%8D%E5%90%8C%E6%AD%A5%2F%E9%87%8D%E5%90%8C%E6%AD%A5-toc" style="margin-left:80px;"><a href="#%E5%AE%9E%E7%8E%B0%E2%80%94%E2%80%94%E5%86%8D%E5%90%8C%E6%AD%A5%2F%E9%87%8D%E5%90%8C%E6%AD%A5" rel="nofollow">实现——再同步/重同步</a></p> 
<p id="%E8%B0%83%E6%95%B4%E5%90%8C%E6%AD%A5%E7%9A%84%E8%A7%84%E5%88%99-toc" style="margin-left:40px;"><a href="#%E8%B0%83%E6%95%B4%E5%90%8C%E6%AD%A5%E7%9A%84%E8%A7%84%E5%88%99" rel="nofollow">调整同步的规则</a></p> 
<p id="%E7%BC%96%E7%A0%81-toc" style="margin-left:0px;"><a href="#%E7%BC%96%E7%A0%81" rel="nofollow">编码</a></p> 
<p id="%E6%9B%BC%E5%BD%BB%E6%96%AF%E7%89%B9%E7%BC%96%E7%A0%81-toc" style="margin-left:40px;"><a href="#%E6%9B%BC%E5%BD%BB%E6%96%AF%E7%89%B9%E7%BC%96%E7%A0%81" rel="nofollow">曼彻斯特编码</a></p> 
<p id="NRZ%E7%BC%96%E7%A0%81-toc" style="margin-left:40px;"><a href="#NRZ%E7%BC%96%E7%A0%81" rel="nofollow">NRZ编码</a></p> 
<hr id="hr-toc"> 
<h2 id="%E5%90%8C%E6%AD%A5">同步</h2> 
<p>同步：通常依靠电平信号的边沿达到同步目的。</p> 
<h3 id="CAN%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%90%8C%E6%AD%A5%EF%BC%9F"><strong>CAN为什么需要同步？</strong></h3> 
<p>因为CAN总线信号传输是异步串行方式，我们一般通过波特率的设置来使得各个节点发送的信号频率一致。</p> 
<p>发送单元以与位时序同步的方式开始发送数据，接收单元根据总线上电平的变化进行同步并进行接收工作。</p> 
<p>CAN报文在CAN总线上传输时，两个硬件部分存在相应延迟：</p> 
<ul><li> <p>在CAN-BUS上传输造成的延迟——传输路径上的（电缆、驱动器等）相位延迟</p> </li><li> <p>在节点上传输造成延迟——发送单元和接收单元存在的时钟频率误差</p> </li></ul> 
<p>另外，CAN采用NRZ编码，这种编码方式能充分利用带宽，减小电平跳变引起的干扰，但却不具备时钟功能。（关于NRZ的原理介绍在本文末尾）。上面两种延迟无法使用当前编码方式解决。</p> 
<p>因此CAN需要采用额外的定时方法来达到收发信号的同步。</p> 
<p>因此接收单元通过硬件同步或者再同步的方法调整时序进行接收。</p> 
<h3 id="%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F">同步方式</h3> 
<p>CAN有3种同步方式：位填充，硬同步，重同步。</p> 
<p>位填充：就是在检测到总线上有连续5个相同电平时，CAN控制器自动插入一个相反电平。除了用来做同步定时，也可用于错误校验。</p> 
<p>硬同步：接收节点检测出帧起始位（SOF）时，调整自己的<strong>SS同步段</strong>位置，使其与发送节点的帧起始位SS一致，调整宽度不限。</p> 
<p>重同步/再同步：接收节点检测出除SOF位以外的其他位时进行的同步调整，接收端调整<strong>PBS相位缓冲段</strong>(PBS1,PBS2)。</p> 
<p>下面通过对位时间、采样点的介绍，描述硬同步、重同步的实现方法。</p> 
<h4 id="%E6%A6%82%E5%BF%B5%E2%80%94%E2%80%94%E4%BD%8D%E6%97%B6%E9%97%B4">概念——位时间</h4> 
<p>一个bit是信号的最小单位，但1bit也是持续了一段时间的。又称位时间。</p> 
<p>一个位分为4段，每个段又由若干个Tq（Time Quantum）构成，这称为位时序。</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/24/6b/25FWgToH_o.png"></p> 
<p></p> 
<p></p> 
<h4 id="%E6%A6%82%E5%BF%B5%E2%80%94%E2%80%94%E9%87%87%E6%A0%B7%E7%82%B9">概念——采样点</h4> 
<p>在位时间内是总线上的电平值是连续值，而我们读取的值只是某个时刻的离散数值。</p> 
<p>那么将哪个时刻的电平值，作为我们最终的读取值，就是采样点的选取问题。</p> 
<p>目前的采样点，设置在PBS1结束处。</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/db/20/ZYyHPDMK_o.jpg"></p> 
<p></p> 
<h4 id="%E5%AE%9E%E7%8E%B0%E2%80%94%E2%80%94%E7%A1%AC%E5%90%8C%E6%AD%A5">实现——硬同步</h4> 
<p>硬同步是指在总线空闲状态，接收节点检测出帧起始位（SOF）时，会调整<strong>当前位的同步段（SS）与发送节点的帧起始位SS段一样</strong>，调整宽度不限。</p> 
<p>实现的具体步骤: 1）发送节点Node_A在发送SOF位时，SOF位的下降沿在SS段； 2）这时接收节点Node_B发现自己当前位的SS段和发送节点SOF位的SS段不同步。也就是说当Node_A 产生SOF位SS段时，Node_B的当前位的SS段已经在5个Tq之前产生了； 3）这样接收节点Node_B硬将自己当前位的SS段拉到与SOF位的SS段同步。</p> 
<p><img alt="" src="https://images2.imgbox.com/a6/2e/wTWbMyuo_o.jpg"></p> 
<p></p> 
<h4>实现——再同步/重同步</h4> 
<p>再同步是指接收节点检测出除SOF位以外的其他位时进行的同步调整。</p> 
<p>再同步会通过加长PBS1段，或缩短PBS2段来调整同步，<strong>以保证采样点的准确</strong>。</p> 
<p>对于PBS1，PBS2的调整长度是有限制的，即SJW。</p> 
<blockquote> 
 <p><strong>概念——SJW</strong></p> 
 <p>同步跳转宽度（SJW）是指PBS1和PBS2再同步时允许跳转的最大宽度，其必须满足以下2个条件：</p> 
 <ul><li> <p>SJW必须小于PBS1和PBS2的最小值；</p> </li><li> <p>SJW最大值不能超过4。</p> </li></ul> 
</blockquote> 
<p>下面是重同步的两种情况：</p> 
<p><strong>情况1：PBS1段加长（发的晚，收的早）</strong></p> 
<pre>步骤：
1）发送节点Node_A比接收节点Node_B的时间慢了，也就是说Node_A当前位的ss段产生的时候，Node_B 
当前位的SS段已经在2个Tq之前产生了；
2）这时接收节点Node_B就将PBS1延长2个Tq的时间；
3）这样Node_A当前位的采样点就和Node_B的采样点同步了。</pre> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/58/83/KT9smNjO_o.jpg"></p> 
<p></p> 
<p></p> 
<p><strong>情况2：PBS2段缩短（发的早，收的晚）</strong></p> 
<pre>1）发送节点Node_A当前位的SS段诞生2Tq时长之后，接收节点Node_B的当前位才产生SS段；
2）这时接收节点Node_B当前位的PBS2段缩短，
3）这样就导致接收节点Node_B的下一位能够提前2个Tq，从而Node_B的下一位采样点和Node_A下一位
的采样点能够同步。</pre> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/36/03/mMVImGtD_o.jpg"></p> 
<p></p> 
<p></p> 
<h3 id="%E8%B0%83%E6%95%B4%E5%90%8C%E6%AD%A5%E7%9A%84%E8%A7%84%E5%88%99">调整同步的规则</h3> 
<p>硬同步和再同步遵从如下规则。</p> 
<p>1）1 个位中只进行一次同步调整。</p> 
<p>2）只有当上次采样点的总线值和边沿后的总线值不同时，该边沿才能用于调整同步。</p> 
<p>3）在总线空闲且存在隐性电平到显性电平的边沿时，则一定要进行硬件同步。</p> 
<p>4）在总线非空闲时检测到的隐性电平到显性电平的边沿如果满足条件（1）和（2），将进行再同步。但还要满足下面条件。</p> 
<p>5）发送方观测到自身输出的显性电平有延迟时不进行再同步。</p> 
<p>6）发送方在帧起始到仲裁段有多个单元同时发送的情况下，对延迟边沿不进行再同步。</p> 
<p></p> 
<h2 id="%E7%BC%96%E7%A0%81">编码</h2> 
<h3 id="%E6%9B%BC%E5%BD%BB%E6%96%AF%E7%89%B9%E7%BC%96%E7%A0%81">曼彻斯特编码</h3> 
<p>曼彻斯特编码：自带，靠上升沿，下降沿表示0，1</p> 
<blockquote> 
 <p>曼彻斯特编码虽然传输了时钟信号，但也损失了一部分的带宽，主要表现在相邻相同数据上。</p> 
 <p>但对于高速数据来说，这种编码方式无疑是这几种编码方式中最优的，相比NRZI编码，曼彻斯特编码不存在长时间信号状态不变导致的时钟信号丢失的情况，</p> 
 <p>所以在这种编码方式在<strong>以太网通信</strong>中是十分常用的。</p> 
 <p><a href="http://blog.sina.com.cn/s/blog_78e87ba10102wj9g.html" rel="nofollow" title="RZ、NRZ、NRZI、曼彻斯特编码_opps_新浪博客">RZ、NRZ、NRZI、曼彻斯特编码_opps_新浪博客</a></p> 
</blockquote> 
<h3 id="NRZ%E7%BC%96%E7%A0%81">NRZ编码</h3> 
<p>NRZ编码：NRZ编码也成为不归零编码，也是我们最常见的一种编码，即正电平表示1，低电平表示0。也就是说，一个周期可以全部用来传输数据，这样传输的带宽就可以完全利用。一般常见的带有时钟线的传输协议都是使用NRZ编码或者差分的NRZ编码。因此，使用NRZ编码若想传输高速同步数据，基本上都要带有时钟线，因为本身NRZ编码无法传递时钟信号。但在低速异步传输下可以不存在时钟线，但在通信前，双方设备要约定好通信<a href="https://so.csdn.net/so/search?from=pc_blog_highlight&amp;q=%E6%B3%A2%E7%89%B9%E7%8E%87" title="波特率">波特率</a>，例如UART。</p> 
<blockquote> 
 <p>时钟信号，数据信号，联合编码进行传输：</p> 
 <p>两台设备要想进行有线通信，最终都是将想要传达的信息转变成一串比特流，进而在传输线上进行传输。</p> 
 <p>常规数字通信为数据线+时钟线的形式。</p> 
 <p>但对于高速信号而言，时钟线和数据线长度的稍稍偏差，就会造成接收端无法满足数据采样的建立时间，故会导致数据出错。</p> 
 <p>而最好的方式就是将时钟信号和数据信号用同一根线来传递，所以出现了一些比较特殊的编码，使得时钟和数据能够融合在一起。</p> 
 <p><a href="http://blog.sina.com.cn/s/blog_78e87ba10102wj9g.html" rel="nofollow" title="RZ、NRZ、NRZI、曼彻斯特编码_opps_新浪博客">RZ、NRZ、NRZI、曼彻斯特编码_opps_新浪博客</a></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5d1bf428477a41a117bd1ec23d967605/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vue项目修改第三方依赖中的方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/eec3f3eca0dab231aa7b58f307de0118/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">题目：javaWeb药房药品管理系统(附源码链接免费下载)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>