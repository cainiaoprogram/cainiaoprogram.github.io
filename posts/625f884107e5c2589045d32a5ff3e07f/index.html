<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Fullnat的环境搭建和负载均衡配置 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Fullnat的环境搭建和负载均衡配置" />
<meta property="og:description" content="FullNAT: 除了DR/NAT/TUNNEL之外IPVS下的新的包转发模式，解决了DR/NAT/TUNNEL中的一些缺点（如不能跨vlan或者跨vlan成本太高，服务搭建较复杂，不易运维等）。
Fullnat主要实现的功能：
1.数据包从外部进来的时候，目标ip更换为realserver ip，源ip更换为内网local ip；
2.数据包发送出去的时候，目标ip更换为client ip，源ip更换为vip；
Fullnat的转发模式：
Fullnat实现原理：
Fullnat虚拟服务的实现：
一 服务安装(为了解释说明，本文所有安装包和压缩包都放在了/mnt目录下）：
1. 首先将作为VS的server1端的ram改成2048或者更大，否则内存不够会报错。
2. 准备安装包：
3. 安装rpm-build服务用来编译内核的源码包，安装kernel包：
这两步完成之后，会在/root目录下生成一个rpmbuild的目录，进入这个目录中的子目录SPECS，里面有一个kernel.spec文件：
4. 执行指令rpmbuild -bp kernel.spec编译这个内核文件，执行时会有许多依赖性的包，将这些包全部安装：
对于asciidoc和newt-devel两个安装包需要另外自行下载，yum源里没有：
5 安装asciidoc,alang-devel,newt-devel ：
6. 安装之后重新编译内核文件：
这时会卡住，需要安装rng-tools来加快进度：yum install rng-tools -y,之后执行rngd -r /dev/urandom指令。
7. 打补丁：
准备Lvs-fullnat-synproxy.tar.gz包并解压将里面的lvs-2.6文件复制到指定目录，进入该指定目录执行56行指令打补丁。
8. 补丁完成之后直接make进行编译，编译过程比较久。
9. 编译完成之后，执行命令 make modules_install，然后make install
10.进入/boot/grub目录，编辑grub.conf文件，将文件中的default 1改为default 0，之后reboot重启。
11. yum remove ipvsadm删除原有的ipvsadm ，进入到/mnt/lvs-fullnat-synproxy/目录，将zxf lvs-tools.tar.gz安装包解压。
12. 进入/mnt/lvs-fullnat-synproxy/tools/keepalived目录，执行指令 ./configure --with-kernel-dir=&#34;/lib/modules/`uname -r`/build&#34; 进行编译。如果出现popt的依赖性问题，yum install popt-devel 解决依赖性问题之后，重新执行编译指令./configure --with-kernel-dir=&#34;/lib/modules/`uname -r`/build&#34;。没有报错的话，执行make之后make install
13. 进入/usr/local/sbin/lvs-fullnat-synproxy/tools/ipvsadm目录下，进行make和make install编译，这个过程中会安装ipvsadm。这样fullnat的环境就搭好了。ipvsadm -l会看到size=41944304即2的22次方：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/625f884107e5c2589045d32a5ff3e07f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-08-01T21:44:56+08:00" />
<meta property="article:modified_time" content="2018-08-01T21:44:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Fullnat的环境搭建和负载均衡配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>FullNAT: 除了DR/NAT/TUNNEL之外IPVS下的新的包转发模式，解决了DR/NAT/TUNNEL中的一些缺点（如不能跨vlan或者跨vlan成本太高，服务搭建较复杂，不易运维等）。</p> 
<p>Fullnat主要实现的功能：<br> 1.数据包从外部进来的时候，目标ip更换为realserver ip，源ip更换为内网local ip；<br> 2.数据包发送出去的时候，目标ip更换为client ip，源ip更换为vip；</p> 
<p>Fullnat的转发模式：</p> 
<p><img alt="" class="has" height="389" src="https://images2.imgbox.com/f7/3b/JI3SDI21_o.png" width="648"></p> 
<p>Fullnat实现原理：</p> 
<p><img alt="" class="has" height="420" src="https://images2.imgbox.com/d8/9f/YMhK5ERc_o.png" width="651"></p> 
<p>Fullnat虚拟服务的实现：</p> 
<p>一  服务安装(为了解释说明，本文所有安装包和压缩包都放在了/mnt目录下）：</p> 
<p>1.  首先将作为VS的server1端的ram改成2048或者更大，否则内存不够会报错。</p> 
<p><img alt="" class="has" src="https://images2.imgbox.com/cf/36/DrVVxBFZ_o.png"></p> 
<p>2.  准备安装包：</p> 
<p style="text-align:center;"><img alt="" class="has" height="125" src="https://images2.imgbox.com/20/20/nZbGurqn_o.png" width="320"></p> 
<p>3.  安装rpm-build服务用来编译内核的源码包，安装kernel包：</p> 
<p><img alt="" class="has" src="https://images2.imgbox.com/af/4d/2fU1p74L_o.png"></p> 
<p>这两步完成之后，会在/root目录下生成一个rpmbuild的目录，进入这个目录中的子目录SPECS，里面有一个kernel.spec文件：</p> 
<p><img alt="" class="has" height="226" src="https://images2.imgbox.com/a0/8a/RnEdE7iT_o.png" width="629"></p> 
<p>4.  执行指令rpmbuild -bp kernel.spec编译这个内核文件，执行时会有许多依赖性的包，将这些包全部安装：</p> 
<p><img alt="" class="has" src="https://images2.imgbox.com/d8/93/r1J0BRyS_o.png"></p> 
<p>对于asciidoc和newt-devel两个安装包需要另外自行下载，yum源里没有：</p> 
<p><img alt="" class="has" src="https://images2.imgbox.com/b7/2d/Pmwbq7G0_o.png"></p> 
<p>5  安装asciidoc,alang-devel,newt-devel  ：</p> 
<p><img alt="" class="has" src="https://images2.imgbox.com/17/8c/SXDIt9i8_o.png"></p> 
<p>6.  安装之后重新编译内核文件：</p> 
<p><img alt="" class="has" height="313" src="https://images2.imgbox.com/be/81/ACWDbCRc_o.png" width="726"></p> 
<p>这时会卡住，需要安装rng-tools来加快进度：yum install rng-tools -y,之后执行rngd -r /dev/urandom指令。</p> 
<p>7.  打补丁：</p> 
<p>准备Lvs-fullnat-synproxy.tar.gz包并解压将里面的lvs-2.6文件复制到指定目录，进入该指定目录执行56行指令打补丁。</p> 
<p><img alt="" class="has" height="127" src="https://images2.imgbox.com/aa/52/Tw64rfGk_o.png" width="853"></p> 
<p>8.  补丁完成之后直接make进行编译，编译过程比较久。</p> 
<p>9.  编译完成之后，执行命令 make modules_install，然后make install</p> 
<p>10.进入/boot/grub目录，编辑grub.conf文件，将文件中的default 1改为default 0，之后reboot重启。</p> 
<p><img alt="" class="has" src="https://images2.imgbox.com/f5/cc/VXhuqpeq_o.png"></p> 
<p>11.  yum remove ipvsadm删除原有的ipvsadm ，进入到/mnt/lvs-fullnat-synproxy/目录，将zxf lvs-tools.tar.gz安装包解压。</p> 
<p>12.  进入/mnt/lvs-fullnat-synproxy/tools/keepalived目录，执行指令 ./configure --with-kernel-dir="/lib/modules/`uname -r`/build" 进行编译。如果出现popt的依赖性问题，yum install popt-devel 解决依赖性问题之后，重新执行编译指令./configure --with-kernel-dir="/lib/modules/`uname -r`/build"。没有报错的话，执行make之后make install</p> 
<p>13. 进入/usr/local/sbin/lvs-fullnat-synproxy/tools/ipvsadm目录下，进行make和make install编译，这个过程中会安装ipvsadm。这样fullnat的环境就搭好了。ipvsadm  -l会看到size=41944304即2的22次方：</p> 
<p><img alt="" class="has" src="https://images2.imgbox.com/ad/92/rs0tCn1x_o.png"></p> 
<p>二   fullnat负载均衡的实现</p> 
<p>1.  在server1端（ip为172.25.17.1)新增一个网卡eth1,给eth1添加一个和eth0不在同一网段的ip地址：ip addr add 172.25.254.100 dev eth1</p> 
<p>2.  在server2（ip为172.25.17.2）和server3（ip为172.25.17.3）端，设定网关为server1的ip：route add default gw 172.25.17.1 。之后开启server2和server3的http服务，作为RS。</p> 
<p>3. 在server1端添加策略：</p> 
<p>      ipvsadm -A -t  172.25.254.100:80 -s rr</p> 
<p>      ipvsadm -a -t  172.25.254.100:80  -r 172.25.17.2 -b</p> 
<p>      ipvsadm -a -t  172.25.254.100:80  -r  172.25.17.3 -b</p> 
<p>      ipvsadm -P -t  172.25.254.100:80  -z  127.0.0.1:80</p> 
<p>      ipvsadm -G -t  172.25.254.100:80</p> 
<p>4.  在真机端解析：curl 172.25.254.100 </p> 
<p>    由于使用的是社区版本的fullnat，所以测试不出来。</p> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a4d0a6aa5178d1ffac86b58c5def4c32/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Deep Learning Object Detection</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a8f511f128b2f99665e8634a05c335e7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android问题集锦（十四）- The option &#39;android.enableAapt2&#39; is deprecated and should not be used anymore.</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>