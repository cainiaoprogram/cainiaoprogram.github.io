<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>一个简单JavaAgent的实现 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="一个简单JavaAgent的实现" />
<meta property="og:description" content="一、什么是javaagent javaagent是一个JVM“插件”，一种专门精心制作的.jar文件，它能够利用JVM提供的Instrumentation API。
1.1、概要 Java Agent由三部分组成：代理类、代理类元信息和JVM加载.jar和代理的机制，整体内容如下图所示：
1.2、javaagent的基石 java.lang.instrument 为javaagent 通过修改方法字节码的方式操作运行在JVM上的程序提供服务。javaagent以JAR包的形式部署，JAR文件清单中的属性指定要加载的代理类，以启动代理。
javaagent的启动方式有以下几种:
通过在命令行指定参数启动。
JVM启动后启动。例如，提供一种工具，该工具可以依附到已运行的应用，并允许在已运行的应用内加载代理。
与应用一起打包为可执行文件。
1.3、启动 javaagent 1.3.1、命令行启动 命令行启动参数如下:
-javaagent:&lt;jarpath&gt;[=&lt;options&gt;] &lt;jarpath&gt; ：javaagent的路径，比如 /opt/var/Agent-1.0.0.jar 。
&lt;options&gt; : javaagent参数，参数的解析由javaagent负责。
javaagent JAR文件清单必须包含 Premain-Class 属性，属性的值为agent class的全路径名（包名&#43;类名）。代理类必须实现 premain 方法，premain 方法和 main 方法一样分别是代理和应用的入口点。JVM初始化完成后首先调用代理的premain函数，然后调用应用的main函数，premain方法必须返回后进程才能启动。
premain 方法签名如下：
public static void premain(String agentArgs, Instrumentation inst) public static void premain(String agentArgs) JVM首先尝试在代理中调用签名为1的方法，如果代理类没有实现签名为1的方法，JVM尝试调用签名为2的方法：
代理类可以有一个 agentmain函数，函数会在JVM启动完成之后调用。如果，使用命令行启动代理，agentmain 方式不会被调用。
代理的所有参数被当作一个字符串通过 agentArgs 变量传递，代理负责解析参数字符串。
如果代理因为代理类无法被加载、代理类未实现 premain 方法或抛出了未被捕获的异常，JVM将会退出。
javaagent的启动不要求实现一定提供命令行的方式，如果，实现支持通过命令行启动，实现必须支持在命令行中通过指定 -javaagent 参数启动。 -javaagent 可以在命令行中使用多次，启动多个代理。premain 函数的调用顺序和命令行中指定的顺序一致，多个代理可以使用相同 &lt;jarpath&gt;。
没有一个严格模型来定义 premain 函数的工作范围，任何 main 函数可以做的工作，比如创建线程，在 premain 函数中都是合法的。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/360637416e96425f155c92e4a4c789e3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-09-02T21:49:27+08:00" />
<meta property="article:modified_time" content="2019-09-02T21:49:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">一个简单JavaAgent的实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="javaagent_0"></a>一、什么是javaagent</h2> 
<p>javaagent是一个JVM“插件”，一种专门精心制作的.jar文件，它能够利用JVM提供的Instrumentation API。</p> 
<h3><a id="11_4"></a>1.1、概要</h3> 
<p>Java Agent由三部分组成：代理类、代理类元信息和JVM加载.jar和代理的机制，整体内容如下图所示：<br> <img src="https://images2.imgbox.com/58/57/8Rl9yMoB_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="12javaagent_8"></a>1.2、javaagent的基石</h3> 
<p><strong><code>java.lang.instrument</code></strong> 为javaagent 通过修改方法字节码的方式操作运行在JVM上的程序提供服务。javaagent以JAR包的形式部署，JAR文件清单中的属性指定要加载的代理类，以启动代理。</p> 
<p>javaagent的启动方式有以下几种:</p> 
<ul><li> <p>通过在命令行指定参数启动。</p> </li><li> <p>JVM启动后启动。例如，提供一种工具，该工具可以依附到已运行的应用，并允许在已运行的应用内加载代理。</p> </li><li> <p>与应用一起打包为可执行文件。</p> </li></ul> 
<h3><a id="13_javaagent_19"></a>1.3、启动 javaagent</h3> 
<h4><a id="131_20"></a>1.3.1、命令行启动</h4> 
<p>命令行启动参数如下:</p> 
<pre><code class="prism language-java"><span class="token operator">-</span>javaagent<span class="token operator">:</span><span class="token generics function"><span class="token punctuation">&lt;</span>jarpath<span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token operator">=</span><span class="token generics function"><span class="token punctuation">&lt;</span>options<span class="token punctuation">&gt;</span></span><span class="token punctuation">]</span>
</code></pre> 
<p><strong><code>&lt;jarpath&gt;</code></strong> ：javaagent的路径，比如 <strong><code>/opt/var/Agent-1.0.0.jar</code></strong> 。<br> <strong><code>&lt;options&gt;</code></strong> : javaagent参数，参数的解析由javaagent负责。<br> javaagent JAR文件清单必须包含 <strong><code>Premain-Class</code></strong> 属性，属性的值为agent class的全路径名（包名+类名）。代理类必须实现 <strong><code>premain</code></strong> 方法，<strong><code>premain</code></strong> 方法和 <strong><code>main</code></strong> 方法一样分别是代理和应用的入口点。JVM初始化完成后首先调用代理的premain函数，然后调用应用的main函数，premain方法必须返回后进程才能启动。</p> 
<p><strong><code>premain</code></strong> 方法签名如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span>String agentArgs<span class="token punctuation">,</span> Instrumentation inst<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span>String agentArgs<span class="token punctuation">)</span>
</code></pre> 
<p>JVM首先尝试在代理中调用签名为1的方法，如果代理类没有实现签名为1的方法，JVM尝试调用签名为2的方法：</p> 
<p>代理类可以有一个 <strong><code>agentmain</code><strong>函数，函数会在JVM启动完成之后调用。如果，使用命令行启动代理，</strong><code>agentmain</code></strong> 方式不会被调用。</p> 
<p>代理的所有参数被当作一个字符串通过 <strong><code>agentArgs</code></strong> 变量传递，代理负责解析参数字符串。</p> 
<p>如果代理因为代理类无法被加载、代理类未实现 <strong><code>premain</code></strong> 方法或抛出了未被捕获的异常，JVM将会退出。</p> 
<p>javaagent的启动不要求实现一定提供命令行的方式，如果，实现支持通过命令行启动，实现必须支持在命令行中通过指定 <strong><code>-javaagent</code></strong> 参数启动。 <strong><code>-javaagent</code></strong> 可以在命令行中使用多次，启动多个代理。<strong><code>premain</code></strong> 函数的调用顺序和命令行中指定的顺序一致，多个代理可以使用相同 <strong><code>&lt;jarpath&gt;</code></strong>。</p> 
<p>没有一个严格模型来定义 <strong><code>premain</code></strong> 函数的工作范围，任何 <strong><code>main</code></strong> 函数可以做的工作，比如创建线程，在 <strong><code>premain</code></strong> 函数中都是合法的。</p> 
<h4><a id="132JVM_50"></a>1.3.2、JVM启动后启动</h4> 
<p>实现可以提供在JVM启动之后再启动代理的机制。代理如何启动的细节特定于实现，通常应用程序已经启动，并且它的 <strong><code>main</code></strong> 方法已经被调用。如果实现支持在JVM启动后启动代理，代理必须满足以下条件：</p> 
<ul><li> <p>清单文件包含 <strong><code>Agent-Class</code></strong> 属性，属性的值为代理类全名。</p> </li><li> <p>代理类必须实现 <strong><code>public static agentmain</code></strong> 方法。</p> </li></ul> 
<p>agentmain方法有以下两个函数签名：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span>String agentArgs<span class="token punctuation">,</span> Instrumentation inst<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span>String agentArgs<span class="token punctuation">)</span>
</code></pre> 
<p>JVM首先尝试调用具有签名1的方法，如果，代理类没有实现该方法，JVM尝试调用签名为2的方法。</p> 
<p>代理类可以同时实现 <strong><code>premain</code></strong> 和 <strong><code>agentmain</code></strong> 两个方法，当代理以命令行方式启动时，JVM调用 <strong><code>premain</code></strong> 函数，当代理在JVM启动之后启动时，JVM调用 <strong><code>agentmain</code></strong> 函数，而且JVM不会调用 <strong><code>premain</code></strong> 函数。</p> 
<p><strong><code>agentmain</code></strong> 函数参数的传递也是通过 <strong><code>agentArgs</code></strong>，所有参数组合为一个字符串，参数的解析由代理负责。</p> 
<p><strong><code>agentmain</code></strong> 函数必须完成启动代理所有必须的初始化动作，当启动完成后，<strong><code>agentmain</code></strong> 函数必须返回。如果，代理不能启动或抛出未捕获的异常，JVM都会退出。</p> 
<h4><a id="133_71"></a>1.3.3、打包为可执行文件</h4> 
<p>如果代理打包到可执行JAR文件中，可执行JAR文件的清单中必须包含 <strong><code>Launcher-Agent-Class</code></strong> 属性，指定一个在应用main函数调用之前代理启动的类。JVM尝试在代理上调用以下方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span>String agentArgs<span class="token punctuation">,</span> Instrumentation inst<span class="token punctuation">)</span>
</code></pre> 
<p>如果，代理类没有实现上述方法，JVM则调用下面的方法。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span>String agentArgs<span class="token punctuation">)</span>
</code></pre> 
<p><strong><code>agentArgs</code></strong> 参数的值必须为空字符串。</p> 
<p><strong><code>agentmain</code></strong> 函数必须完成代理启动必须的所有初始化动作并在启动后返回。如果，代理无法启动或抛出未捕获的异常，JVM会退出。</p> 
<h4><a id="134_88"></a>1.3.4、加载代理类以及代理类可用的模块/类</h4> 
<p>系统类加载器负责加载代理JAR文件中的所有类，并且成为系统类加载器的未命名模块的成员。 系统类加载器通常也定义包含应用程序 <strong><code>main</code></strong> 方法的类。对代理类可见的所有类都对系统类加载器可见，必须满足下面的最低要求：</p> 
<ul><li> <p>启动层中的模块导出的包中的类。 启动层是否包含所有平台模块取决于初始模块或应用程序的启动方式。</p> </li><li> <p>类可被系统类加载器定义。</p> </li><li> <p>启动类加载器定义的所有代理的类为其未命名模块的成员。</p> </li></ul> 
<p>如果代理类需要链接到不在启动层中的平台（或其他）模块中的类，则需要以确保这些模块位于启动层中的方式启动应用程序。 例如，在JDK实现中，<strong><code>--add-modules</code></strong> 命令行选项可用于将模块添加到要在启动时解析的根模块集中。</p> 
<p>启动类加载器可以加载代理支持的类（通过 <strong><code>appendToBootstrapClassLoaderSearch</code></strong> 或指定Boot-Class-Path属性）必须仅链接到定义启动类加载器的类。 无法保证启动类加载器可以在所有平台工作。</p> 
<p>如果配置了自定义系统类加载器（通过 <strong><code>getSystemClassLoader</code></strong> 方法中指定的系统属性 <strong><code>java.system.class.loader</code></strong> ），则必须定义 <strong><code>appendToSystemClassLoaderSearch</code></strong> 中指定的 <strong><code>appendToClassPathForInstrumentation</code></strong> 方法。 换句话说，自定义系统类加载器必须支持将代理JAR文件添加到系统类加载器搜索范围内的机制。</p> 
<h3><a id="14javaagent_103"></a>1.4、javaagent清单属性</h3> 
<table><thead><tr><th>属性</th><th>说明</th><th>是否必选</th><th>默认值</th></tr></thead><tbody><tr><td>Premain-Class</td><td>包含premain方法的类</td><td>依赖启动方式</td><td>无</td></tr><tr><td>Agent-Class</td><td>包含agentmain方法的类</td><td>依赖启动方式</td><td>无</td></tr><tr><td>Boot-Class-Path</td><td>启动类加载器搜索路径</td><td>否</td><td>无</td></tr><tr><td>Can-Redefine-Classis</td><td>是否可以重定义代理所需的类</td><td>否</td><td>false</td></tr><tr><td>Can-Retransform-Classis</td><td>是否能够重新转换此代理所需的类</td><td>否</td><td>false</td></tr><tr><td>Can-Set-Native-Method-Prefix</td><td>是否能够设置此代理所需的本机方法前缀</td><td>否</td><td>false</td></tr></tbody></table> 
<h2><a id="Java_Agent_113"></a>二、写一个Java Agent</h2> 
<p>基于上面的介绍，我们实现一个下载JVM中所有非系统类的javaagent。</p> 
<p>整个开发过程包括以下三步：</p> 
<ul><li> <p><strong>1）定义代理类，实现类下载功能；</strong></p> </li><li> <p><strong>2）配置、打包；</strong></p> </li><li> <p><strong>3）命令行启动测试。</strong></p> </li></ul> 
<h3><a id="21_124"></a>2.1、代理类实现</h3> 
<p>实现 <strong><code>premain</code></strong> 函数</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> io<span class="token punctuation">.</span>ct<span class="token punctuation">.</span>java<span class="token punctuation">.</span>agent<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>instrument<span class="token punctuation">.</span>Instrumentation<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span>String arg<span class="token punctuation">,</span> Instrumentation instrumentation<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"agent startup , args is "</span> <span class="token operator">+</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册我们的文件下载函数</span>
        instrumentation<span class="token punctuation">.</span><span class="token function">addTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DumpClassesService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>文件下载类实现 <strong><code>ClassFileTransformer</code></strong> 接口，在类被加载时下载类的字节码：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> io<span class="token punctuation">.</span>ct<span class="token punctuation">.</span>java<span class="token punctuation">.</span>agent<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileOutputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>instrument<span class="token punctuation">.</span>ClassFileTransformer<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>instrument<span class="token punctuation">.</span>IllegalClassFormatException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>ProtectionDomain<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token comment">/**
 * Copyright (C), 2018-2018, open source
 * FileName: DumpClassesService
 *
 * @author : 大哥
 * Date:     2018/12/8 21:01
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DumpClassesService</span> <span class="token keyword">implements</span> <span class="token class-name">ClassFileTransformer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> SYSTEM_CLASS_PREFIX <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"java"</span><span class="token punctuation">,</span> <span class="token string">"sum"</span><span class="token punctuation">,</span> <span class="token string">"jdk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transform</span><span class="token punctuation">(</span>ClassLoader loader<span class="token punctuation">,</span> String className<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> classBeingRedefined<span class="token punctuation">,</span> ProtectionDomain protectionDomain<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span> <span class="token keyword">throws</span> IllegalClassFormatException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSystemClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"load class "</span> <span class="token operator">+</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            FileOutputStream fos <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 将类名统一命名为classNamedump.class格式</span>
                fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>className <span class="token operator">+</span> <span class="token string">"dump.class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>classfileBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ioe<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 关闭文件输出流</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> fos<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> classfileBuffer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断一个类是否为系统类
     *
     * @param className 类名
     * @return System Class then return true,else return false
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isSystemClass</span><span class="token punctuation">(</span>String className<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 假设系统类的类名不为NULL而且不为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> className <span class="token operator">||</span> className<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>String prefix <span class="token operator">:</span> SYSTEM_CLASS_PREFIX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="22MANIFESTMF_212"></a>2.2、配置MANIFEST.MF</h3> 
<p><strong><code>MANIFEST.MF</code></strong> 文件两种方式生成：手动配置和自动生成，手动配置只需要在 <strong><code>resources</code></strong> 文件下创建 <strong><code>META-INF/MENIFEST.MF</code></strong> 文件即可。除去手动配置外，可以使用maven插件在打包阶段自动生成，maven的插件配置如下：</p> 
<pre><code class="prism language-xml">             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-jar-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>archive</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifestEntries</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Premain-Class</span><span class="token punctuation">&gt;</span></span>io.ct.java.agent.AgentApplication<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Premain-Class</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Agent-Class</span><span class="token punctuation">&gt;</span></span>io.ct.java.agent.AgentApplication<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Agent-Class</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Can-Redefine-Classes</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Can-Redefine-Classes</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Can-Retransform-Classes</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Can-Retransform-Classes</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifestEntries</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>archive</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>生成的jar包格式如下：<br> <img src="https://images2.imgbox.com/97/fd/pnFtdBPY_o.jpg" alt="在这里插入图片描述"><br> 其中MANIFEST.MF的文件内容如下（不同的配置生成的文件内容不完全一致）：</p> 
<pre><code class="prism language-java">Manifest<span class="token operator">-</span>Version<span class="token operator">:</span> <span class="token number">1.0</span>
Implementation<span class="token operator">-</span>Title<span class="token operator">:</span> agent
Premain<span class="token operator">-</span>Class<span class="token operator">:</span> io<span class="token punctuation">.</span>ct<span class="token punctuation">.</span>java<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>AgentApplication
Implementation<span class="token operator">-</span>Version<span class="token operator">:</span> <span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span>SNAPSHOT
Built<span class="token operator">-</span>By<span class="token operator">:</span> chentong
Agent<span class="token operator">-</span>Class<span class="token operator">:</span> io<span class="token punctuation">.</span>ct<span class="token punctuation">.</span>java<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>AgentApplication
Can<span class="token operator">-</span>Redefine<span class="token operator">-</span>Classes<span class="token operator">:</span> <span class="token boolean">true</span>
Implementation<span class="token operator">-</span>Vendor<span class="token operator">-</span>Id<span class="token operator">:</span> io<span class="token punctuation">.</span>ct<span class="token punctuation">.</span>java
Can<span class="token operator">-</span>Retransform<span class="token operator">-</span>Classes<span class="token operator">:</span> <span class="token boolean">true</span>
Created<span class="token operator">-</span>By<span class="token operator">:</span> Apache Maven <span class="token number">3.5</span><span class="token number">.4</span>
Build<span class="token operator">-</span>Jdk<span class="token operator">:</span> <span class="token number">1.8</span><span class="token number">.0</span>_171
Implementation<span class="token operator">-</span>URL<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>projects<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>io<span class="token operator">/</span>spring<span class="token operator">-</span>boot<span class="token operator">/</span>#<span class="token operator">/</span>spring<span class="token operator">-</span>bo
 ot<span class="token operator">-</span>starter<span class="token operator">-</span>parent<span class="token operator">/</span>agent
</code></pre> 
<h3><a id="23Java_Agent_251"></a>2.3、命令行启动Java Agent</h3> 
<p>执行下面的命令，运行已经编译好的类Hello，可以在同级目录下生成一个名为Hellodump.class的文件。</p> 
<pre><code class="prism language-java">java <span class="token operator">-</span>javaagent<span class="token operator">:</span>agent<span class="token operator">-</span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span>SNAPSHOT<span class="token punctuation">.</span>jar Hello
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ac19ec23bde019e909771e800e99f8f7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MySQL 查询练习 （含答案）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6bbc70a81dbfd880bbdab71d66f7fd99/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">图像变换</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>