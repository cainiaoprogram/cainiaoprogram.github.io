<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RK3566添加湿度传感器以及浅析hal层 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="RK3566添加湿度传感器以及浅析hal层" />
<meta property="og:description" content="RK3566添加一款温湿度传感器gxht3x.挂在i2c总线下。驱动部分就不多做解析。大致流程硬件接好i2c线以及vcc gnd。后看数据手册。初始化寄存器，然后要读数据的话读那个寄存器，读出来的数据要做一个转化,然后实现open read write ioctl函数就行了。本文主要讲解hal层 。直接贴驱动代码。
/* drivers/input/sensors/temperature/tmp_ms5607.c * * Copyright (C) 2012-2015 ROCKCHIP. * Author: luowei &lt;lw@rock-chips.com&gt; * * This software is licensed under the terms of the GNU General Public * License version 2, as published by the Free Software Foundation, and * may be copied, distributed, and modified under those terms. * * This program is distributed in the hope that it will be useful, * but WITHOUT ANY WARRANTY; without even the implied warranty of * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/afea89f4d86872ddf6f209a60998ccd7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-22T09:16:26+08:00" />
<meta property="article:modified_time" content="2023-02-22T09:16:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">RK3566添加湿度传感器以及浅析hal层</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>RK3566添加一款温湿度传感器gxht3x.挂在i2c总线下。驱动部分就不多做解析。大致流程硬件接好i2c线以及vcc gnd。后看数据手册。初始化寄存器，然后要读数据的话读那个寄存器，读出来的数据要做一个转化,然后实现open read write ioctl函数就行了。本文主要讲解hal层 。直接贴驱动代码。</p> 
<pre><code class="prism language-c"><span class="token comment">/* drivers/input/sensors/temperature/tmp_ms5607.c
 *
 * Copyright (C) 2012-2015 ROCKCHIP.
 * Author: luowei &lt;lw@rock-chips.com&gt;
 *
 * This software is licensed under the terms of the GNU General Public
 * License version 2, as published by the Free Software Foundation, and
 * may be copied, distributed, and modified under those terms.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/input.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_irq.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_gpio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/i2c.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/miscdevice.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/atomic.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/freezer.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_HAS_EARLYSUSPEND</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/earlysuspend.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sensor-dev.h&gt;</span></span>


<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">sensor_active</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">,</span> <span class="token keyword">int</span> enable<span class="token punctuation">,</span> <span class="token keyword">int</span> rate<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">sensor_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">sensor_i2c_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">,</span>
			    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">i2c_msg</span> msgs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> res<span class="token punctuation">;</span>

	msgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token number">0x44</span><span class="token punctuation">;</span>
	msgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">/* write */</span>
	msgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">;</span>
	msgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>

	res <span class="token operator">=</span> <span class="token function">i2c_transfer</span><span class="token punctuation">(</span>client<span class="token operator">-&gt;</span>adapter<span class="token punctuation">,</span> msgs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"wzf---i2c_transfer count = %d\n"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> res<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">senosr_i2c_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">,</span>
			   <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">i2c_msg</span> msgs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> res<span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"wzf:-----addr = %x-----\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>client<span class="token operator">-&gt;</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	msgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token number">0x44</span><span class="token punctuation">;</span>
	msgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> I2C_M_RD<span class="token punctuation">;</span>
	msgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf <span class="token operator">=</span> data<span class="token punctuation">;</span>
	msgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>

	res <span class="token operator">=</span> <span class="token function">i2c_transfer</span><span class="token punctuation">(</span>client<span class="token operator">-&gt;</span>adapter<span class="token punctuation">,</span> msgs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"wzf---i2c_transfer count = %d\n"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> res<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">humidity_report_value</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>input<span class="token punctuation">,</span> <span class="token keyword">int</span> data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//get temperature, high and temperature from register data</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ms5607-----hum report data= %d\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">input_report_abs</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> ABS_VOLUME<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">input_sync</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">msleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">sensor_report_value</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> tem <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>hum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> Temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>Humidity<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">char</span> recvbuffer<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> sendbuffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x2C</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">sensor_private_data</span> <span class="token operator">*</span>sensor <span class="token operator">=</span>
	    <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sensor_private_data</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">i2c_get_clientdata</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"wzf:--------%s---------\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">memset</span><span class="token punctuation">(</span>recvbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">sensor_i2c_write</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> sendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"sensor_i2c_read failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//return -1;</span>
	<span class="token punctuation">}</span>
	<span class="token function">msleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">senosr_i2c_read</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> recvbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"sensor_i2c_read failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//return -1;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"read recvbuffer= %s-----\n"</span><span class="token punctuation">,</span>recvbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	tem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>recvbuffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> recvbuffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//温度拼接</span>
	hum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>recvbuffer<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> recvbuffer<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//湿度拼接</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"wzf:ms5607 hum =%d\n"</span><span class="token punctuation">,</span>hum<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"wzf:ms5607 temp =%d\n"</span><span class="token punctuation">,</span>tem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*转换实际温度*/</span>
	Temperature<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">175</span><span class="token operator">*</span> tem<span class="token operator">/</span><span class="token number">65535</span><span class="token operator">-</span><span class="token number">45</span><span class="token punctuation">)</span> <span class="token punctuation">;</span><span class="token comment">// T = -45 + 175 * tem / (2^16-1)</span>
	<span class="token comment">//Temperature =(315*tem/65535-49);</span>
	Humidity<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span> hum<span class="token operator">/</span><span class="token number">65535</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// RH = hum*100 / (2^16-1)</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"---Temp : %d  Hum: %d ----\n"</span><span class="token punctuation">,</span>Temperature<span class="token punctuation">,</span>Humidity<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//Humidity=950;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Humidity<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">humidity_report_value</span><span class="token punctuation">(</span>sensor<span class="token operator">-&gt;</span>input_dev<span class="token punctuation">,</span> Humidity<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">struct</span> <span class="token class-name">sensor_operate</span> humidity_gxht3x_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>name				<span class="token operator">=</span> <span class="token string">"hum_gxht3x"</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>type				<span class="token operator">=</span> SENSOR_TYPE_HUMIDITY<span class="token punctuation">,</span>	<span class="token comment">//sensor type and it should be correct</span>
	<span class="token punctuation">.</span>id_i2c				<span class="token operator">=</span> HUMIDITY_ID_GXHT3X<span class="token punctuation">,</span>	<span class="token comment">//i2c id number</span>
	<span class="token punctuation">.</span>read_reg			<span class="token operator">=</span> SENSOR_UNKNOW_DATA<span class="token punctuation">,</span>	<span class="token comment">//read data</span>
	<span class="token punctuation">.</span>read_len			<span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>			<span class="token comment">//data length</span>
	<span class="token punctuation">.</span>id_reg				<span class="token operator">=</span> SENSOR_UNKNOW_DATA<span class="token punctuation">,</span>	<span class="token comment">//read device id from this register</span>
	<span class="token punctuation">.</span>id_data 			<span class="token operator">=</span> SENSOR_UNKNOW_DATA<span class="token punctuation">,</span>	<span class="token comment">//device id</span>
	<span class="token punctuation">.</span>precision			<span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>		<span class="token comment">//8 bits</span>
	<span class="token punctuation">.</span>ctrl_reg 			<span class="token operator">=</span> SENSOR_UNKNOW_DATA<span class="token punctuation">,</span>	<span class="token comment">//enable or disable</span>
	<span class="token punctuation">.</span>int_status_reg 		<span class="token operator">=</span> SENSOR_UNKNOW_DATA<span class="token punctuation">,</span>	<span class="token comment">//intterupt status register</span>
	<span class="token punctuation">.</span>range				<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">65535</span><span class="token punctuation">}</span><span class="token punctuation">,</span>		<span class="token comment">//range</span>
	<span class="token punctuation">.</span>trig				<span class="token operator">=</span> IRQF_TRIGGER_LOW <span class="token operator">|</span> IRQF_ONESHOT <span class="token operator">|</span> IRQF_SHARED<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>active				<span class="token operator">=</span> sensor_active<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>init				<span class="token operator">=</span> sensor_init<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>report				<span class="token operator">=</span> sensor_report_value<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/****************operate according to sensor chip:end************/</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">humidity_gxht3x_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_device_id</span> <span class="token operator">*</span>devid<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"wzf:----%s----\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">sensor_register_device</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> devid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>humidity_gxht3x_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">humidity_gxht3x_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">sensor_unregister_device</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>humidity_gxht3x_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_device_id</span> humidity_gxht3x_id<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">{<!-- --></span><span class="token string">"hum_gxht3x"</span><span class="token punctuation">,</span> HUMIDITY_ID_GXHT3X<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_driver</span> humidity_ms5607_driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>probe <span class="token operator">=</span> humidity_gxht3x_probe<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>remove <span class="token operator">=</span> humidity_gxht3x_remove<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>shutdown <span class="token operator">=</span> sensor_shutdown<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>id_table <span class="token operator">=</span> humidity_gxht3x_id<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"humidity_gxht3x"</span><span class="token punctuation">,</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PM</span></span>
		<span class="token punctuation">.</span>pm <span class="token operator">=</span> <span class="token operator">&amp;</span>sensor_pm_ops<span class="token punctuation">,</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">module_i2c_driver</span><span class="token punctuation">(</span>humidity_ms5607_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"luowei &lt;lw@rock-chips.com&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"ms5607 temperature driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>接下来对hal层进行浅析hal对于驱动来说还是要会的。我也不会，在网上找资料找出来的如有错误希望各位大佬能指出。<br> <img src="https://images2.imgbox.com/1a/03/KpiInHBG_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/64/4b/i7oMnNNZ_o.png" alt="在这里插入图片描述"><br> 以上资料来自博主~未来可期<a href="https://blog.csdn.net/soar999999/article/details/123536403">点击看大佬的文章</a><br> 总结一下：<br> 对于我们的湿度传感器来说：（kernel 层驱动通过i2c读取寄存器拿到湿度数据） —fileoperation----&gt;（hardware层通过open节点，以及ioctl获取到数据，填充这些结构体.hw_device_t 填充模块ID 名称 描述 版本等信息。hw_moule_ts实现功能函数。等jni层获取到该结构体指针的时候可以调用这些功能函数）------jni--------&gt;（framewark层注册java native interface.java本地接口，以便上层调用）-------&gt;apk.<br> 那我们看hal层代码就先从这三个结构体入手。</p> 
<pre><code class="prism language-c">hardware\libhardware\include\hardware\hardware<span class="token punctuation">.</span>h
<span class="token keyword">struct</span> <span class="token class-name">hw_module_t</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">hw_module_methods_t</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">hw_device_t</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Every hardware module must have a data structure named HAL_MODULE_INFO_SYM
 * and the fields of this data structure must begin with hw_module_t
 * followed by module specific information.
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">hw_module_t</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/** tag must be initialized to HARDWARE_MODULE_TAG */</span>
    <span class="token class-name">uint32_t</span> tag<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The API version of the implemented module. The module owner is
     * responsible for updating the version when a module interface has
     * changed.
     *
     * The derived modules such as gralloc and audio own and manage this field.
     * The module user must interpret the version field to decide whether or
     * not to inter-operate with the supplied module implementation.
     * For example, SurfaceFlinger is responsible for making sure that
     * it knows how to manage different versions of the gralloc-module API,
     * and AudioFlinger must know how to do the same for audio-module API.
     *
     * The module API version should include a major and a minor component.
     * For example, version 1.0 could be represented as 0x0100. This format
     * implies that versions 0x0100-0x01ff are all API-compatible.
     *
     * In the future, libhardware will expose a hw_get_module_version()
     * (or equivalent) function that will take minimum/maximum supported
     * versions as arguments and would be able to reject modules with
     * versions outside of the supplied range.
     */</span>
    <span class="token class-name">uint16_t</span> module_api_version<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">version_major</span> <span class="token expression">module_api_version</span></span>
    <span class="token comment">/**
     * version_major/version_minor defines are supplied here for temporary
     * source code compatibility. They will be removed in the next version.
     * ALL clients must convert to the new version format.
     */</span>

    <span class="token comment">/**
     * The API version of the HAL module interface. This is meant to
     * version the hw_module_t, hw_module_methods_t, and hw_device_t
     * structures and definitions.
     *
     * The HAL interface owns this field. Module users/implementations
     * must NOT rely on this value for version information.
     *
     * Presently, 0 is the only valid value.
     */</span>
    <span class="token class-name">uint16_t</span> hal_api_version<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">version_minor</span> <span class="token expression">hal_api_version</span></span>

    <span class="token comment">/** Identifier of module */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>id<span class="token punctuation">;</span>

    <span class="token comment">/** Name of this module */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>

    <span class="token comment">/** Author/owner/implementor of the module */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>author<span class="token punctuation">;</span>

    <span class="token comment">/** Modules methods */</span>
    <span class="token keyword">struct</span> <span class="token class-name">hw_module_methods_t</span><span class="token operator">*</span> methods<span class="token punctuation">;</span>

    <span class="token comment">/** module's dso */</span>
    <span class="token keyword">void</span><span class="token operator">*</span> dso<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__LP64__</span></span>
    <span class="token class-name">uint64_t</span> reserved<span class="token punctuation">[</span><span class="token number">32</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">/** padding to 128 bytes, reserved for future use */</span>
    <span class="token class-name">uint32_t</span> reserved<span class="token punctuation">[</span><span class="token number">32</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token punctuation">}</span> <span class="token class-name">hw_module_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">hw_module_methods_t</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/** Open a specific device */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>open<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">hw_module_t</span><span class="token operator">*</span> module<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> id<span class="token punctuation">,</span>
            <span class="token keyword">struct</span> <span class="token class-name">hw_device_t</span><span class="token operator">*</span><span class="token operator">*</span> device<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token class-name">hw_module_methods_t</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Every device data structure must begin with hw_device_t
 * followed by module specific public methods and attributes.
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">hw_device_t</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/** tag must be initialized to HARDWARE_DEVICE_TAG */</span>
    <span class="token class-name">uint32_t</span> tag<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Version of the module-specific device API. This value is used by
     * the derived-module user to manage different device implementations.
     *
     * The module user is responsible for checking the module_api_version
     * and device version fields to ensure that the user is capable of
     * communicating with the specific module implementation.
     *
     * One module can support multiple devices with different versions. This
     * can be useful when a device interface changes in an incompatible way
     * but it is still necessary to support older implementations at the same
     * time. One such example is the Camera 2.0 API.
     *
     * This field is interpreted by the module user and is ignored by the
     * HAL interface itself.
     */</span>
    <span class="token class-name">uint32_t</span> version<span class="token punctuation">;</span>

    <span class="token comment">/** reference to the module this device belongs to */</span>
    <span class="token keyword">struct</span> <span class="token class-name">hw_module_t</span><span class="token operator">*</span> module<span class="token punctuation">;</span>

    <span class="token comment">/** padding reserved for future use */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__LP64__</span></span>
    <span class="token class-name">uint64_t</span> reserved<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token class-name">uint32_t</span> reserved<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/** Close this device */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>close<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">hw_device_t</span><span class="token operator">*</span> device<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token class-name">hw_device_t</span><span class="token punctuation">;</span>

</code></pre> 
<p>然后我们在看sensor中定义的结构体</p> 
<pre><code class="prism language-c">\hardware\libhardware\include\hardware\sensors<span class="token punctuation">.</span>h
<span class="token comment">/**
 * Every hardware module must have a data structure named HAL_MODULE_INFO_SYM
 * and the fields of this data structure must begin with hw_module_t
 * followed by module specific information.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">sensors_module_t</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">hw_module_t</span> common<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Enumerate all available sensors. The list is returned in "list".
     * return number of sensors in the list
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_sensors_list<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sensors_module_t</span><span class="token operator">*</span> module<span class="token punctuation">,</span>
            <span class="token keyword">struct</span> <span class="token class-name">sensor_t</span> <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">*</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     *  Place the module in a specific mode. The following modes are defined
     *
     *  0 - Normal operation. Default state of the module.
     *  1 - Loopback mode. Data is injected for the supported
     *      sensors by the sensor service in this mode.
     * return 0 on success
     *         -EINVAL if requested mode is not supported
     *         -EPERM if operation is not allowed
     */</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>set_operation_mode<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * sensors_poll_device_t is used with SENSORS_DEVICE_API_VERSION_0_1
 * and is present for backward binary and source compatibility.
 * See the Sensors HAL interface section for complete descriptions of the
 * following functions:
 * http://source.android.com/devices/sensors/index.html#hal
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">sensors_poll_device_t</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">hw_device_t</span> common<span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>activate<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sensors_poll_device_t</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
            <span class="token keyword">int</span> sensor_handle<span class="token punctuation">,</span> <span class="token keyword">int</span> enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setDelay<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sensors_poll_device_t</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
            <span class="token keyword">int</span> sensor_handle<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> sampling_period_ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>poll<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sensors_poll_device_t</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
            <span class="token class-name">sensors_event_t</span><span class="token operator">*</span> data<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>这里主要定义了俩个结构体 :struct sensors_module_t , 里面包含了 hw_module_t ; 那hw_module_t我们之前说是填充模块信息的包括ID 名称等等。但是它里面还包含了俩个函数 get_sensors_list 这个函数将返回所有可以的传感器列表。set_operation_mode：将模块设置特定模式：0 正常模式 1回环模式。第二个结构体：struct sensors_poll_device_t ，里面包含了struct hw_device_t；struct hw_device_t里面是特定的实现函数，但是我们还要增加我们自己的功能函数activate ，setDelay ，poll。<br> ok，我查看在libhardware下的头文件定义。接下来看具体的实现。</p> 
<pre><code class="prism language-c">hardware\rockchip\sensor\st\sensors<span class="token punctuation">.</span>c
<span class="token comment">/*  sensors_module_t 填充hw_module_t的 模块描述 */</span>
 <span class="token keyword">struct</span> <span class="token class-name">sensors_module_t</span> HAL_MODULE_INFO_SYM <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>common <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>tag <span class="token operator">=</span> HARDWARE_MODULE_TAG<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>version_major <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>version_minor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>id <span class="token operator">=</span> SENSORS_HARDWARE_MODULE_ID<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"Rockchip Sensors Module"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>author <span class="token operator">=</span> <span class="token string">"The RKdroid Project"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>methods <span class="token operator">=</span> <span class="token operator">&amp;</span>sensors_module_methods<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>get_sensors_list <span class="token operator">=</span> sensors__get_sensors_list
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/* hw_module_methods_t 实现open函数  */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">hw_module_methods_t</span> sensors_module_methods <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> open_sensors
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/* 实现sensor.h中 sensors_module_t结构体中 get_sensors_list函数  */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">sensors__get_sensors_list</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sensors_module_t</span><span class="token operator">*</span> module<span class="token punctuation">,</span>
        <span class="token keyword">struct</span> <span class="token class-name">sensor_t</span> <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">*</span> list<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token operator">*</span>list <span class="token operator">=</span> sSensorList<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>sSensorList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>那么sensors_poll_device_t的几个函数的实现都没有写？？？这个要看具体设备再具体实现。<br> 直接看湿度传感器hal层结构体定义。</p> 
<pre><code class="prism language-c">hardware\rockchip\sensor\st\HumiditySensor<span class="token punctuation">.</span>h
class HumiditySensor <span class="token operator">:</span> public SensorBase <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> mEnabled<span class="token punctuation">;</span>
    InputEventCircularReader mInputReader<span class="token punctuation">;</span>
    <span class="token class-name">sensors_event_t</span> mPendingEvent<span class="token punctuation">;</span>  
    bool mHasPendingEvent<span class="token punctuation">;</span>

    
    <span class="token keyword">int</span> <span class="token function">setInitialState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

public<span class="token operator">:</span>
            <span class="token function">HumiditySensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    virtual <span class="token operator">~</span><span class="token function">HumiditySensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    virtual <span class="token keyword">int</span> <span class="token function">setDelay</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span> handle<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
    virtual <span class="token keyword">int</span> <span class="token function">enable</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    virtual <span class="token keyword">int</span> <span class="token function">readEvents</span><span class="token punctuation">(</span><span class="token class-name">sensors_event_t</span><span class="token operator">*</span> data<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    virtual bool <span class="token function">hasPendingEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
    virtual <span class="token keyword">int</span> <span class="token function">isActivated</span><span class="token punctuation">(</span><span class="token keyword">int</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">processEvent</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*****************************************************************************/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HUMIDITY_IOCTL_MAGIC</span>			<span class="token char">'h'</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HUMIDITY_IOCTL_GET_ENABLED</span>	<span class="token expression"><span class="token function">_IOR</span><span class="token punctuation">(</span>HUMIDITY_IOCTL_MAGIC<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HUMIDITY_IOCTL_ENABLE</span>			<span class="token expression"><span class="token function">_IOW</span><span class="token punctuation">(</span>HUMIDITY_IOCTL_MAGIC<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HUMIDITY_IOCTL_DISABLE</span>		<span class="token expression"><span class="token function">_IOW</span><span class="token punctuation">(</span>HUMIDITY_IOCTL_MAGIC<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HUMIDITY_IOCTL_SET_DELAY</span>		<span class="token expression"><span class="token function">_IOW</span><span class="token punctuation">(</span>HUMIDITY_IOCTL_MAGIC<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span></span></span>
</code></pre> 
<p>class HumiditySensor : public SensorBase ； 可以看出class HumiditySensor 继承了SensorBase，那我们看一下class SensorBase</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">sensors_event_t</span><span class="token punctuation">;</span>

class SensorBase <span class="token punctuation">{<!-- --></span>
protected<span class="token operator">:</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> dev_name<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> data_name<span class="token punctuation">;</span>
    <span class="token keyword">int</span>         dev_fd<span class="token punctuation">;</span>
    <span class="token keyword">int</span>         data_fd<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">openInput</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> inputName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">int64_t</span> <span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">int64_t</span> <span class="token function">timevalToNano</span><span class="token punctuation">(</span>timeval <span class="token keyword">const</span><span class="token operator">&amp;</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> t<span class="token punctuation">.</span>tv_sec<span class="token operator">*</span><span class="token number">1000000000LL</span> <span class="token operator">+</span> t<span class="token punctuation">.</span>tv_usec<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">open_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token function">close_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

public<span class="token operator">:</span>
            <span class="token function">SensorBase</span><span class="token punctuation">(</span>
                    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> dev_name<span class="token punctuation">,</span>
                    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> data_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    virtual <span class="token operator">~</span><span class="token function">SensorBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    virtual <span class="token keyword">int</span> <span class="token function">readEvents</span><span class="token punctuation">(</span><span class="token class-name">sensors_event_t</span><span class="token operator">*</span> data<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    virtual bool <span class="token function">hasPendingEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
    virtual <span class="token keyword">int</span> <span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
    virtual <span class="token keyword">int</span> <span class="token function">setDelay</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span> handle<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
    virtual <span class="token keyword">int</span> <span class="token function">enable</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> enabled<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    virtual <span class="token keyword">int</span> <span class="token function">isActivated</span><span class="token punctuation">(</span><span class="token keyword">int</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里的setdelay isActivated readEvents不就是sensors_poll_device_t里面的功能实现函数。同时在HumiditySensor类里面也实现了这几个函数。查看class HumiditySensor里面成员的实现。</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*
 * Copyright (C) 2010 Motorola, Inc.
 * Copyright (C) 2008 The Android Open Source Project
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"HumiditySensor.h"</span></span>

<span class="token comment">/*****************************************************************************/</span>

<span class="token class-name">HumiditySensor</span><span class="token double-colon punctuation">::</span><span class="token function">HumiditySensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">SensorBase</span><span class="token punctuation">(</span>HUM_DEVICE_NAME<span class="token punctuation">,</span> <span class="token string">"humidity"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mEnabled</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mInputReader</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mHasPendingEvent</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"new class humidity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mPendingEvent<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sensors_event_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mPendingEvent<span class="token punctuation">.</span>sensor <span class="token operator">=</span> ID_HUM<span class="token punctuation">;</span>
    mPendingEvent<span class="token punctuation">.</span>type <span class="token operator">=</span> SENSOR_TYPE_RELATIVE_HUMIDITY<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>mPendingEvent<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>mPendingEvent<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token function">open_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dev_fd <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ioctl</span><span class="token punctuation">(</span>dev_fd<span class="token punctuation">,</span> HUMIDITY_IOCTL_GET_ENABLED<span class="token punctuation">,</span> <span class="token operator">&amp;</span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mEnabled <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">setInitialState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">HumiditySensor</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">HumiditySensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"delete class humidity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev_fd <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">close</span><span class="token punctuation">(</span>dev_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dev_fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">HumiditySensor</span><span class="token double-colon punctuation">::</span><span class="token function">setInitialState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">input_absinfo</span> absinfo<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>data_fd <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">ioctl</span><span class="token punctuation">(</span>data_fd<span class="token punctuation">,</span> <span class="token function">EVIOCGABS</span><span class="token punctuation">(</span>EVENT_TYPE_HUMIDITY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>absinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mHasPendingEvent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        mPendingEvent<span class="token punctuation">.</span>relative_humidity <span class="token operator">=</span> CONVERT_B <span class="token operator">*</span> absinfo<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">HumiditySensor</span><span class="token double-colon punctuation">::</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token keyword">int32_t</span><span class="token punctuation">,</span> <span class="token keyword">int</span> en<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> flags <span class="token operator">=</span> en <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">!=</span> mEnabled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dev_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">open_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        err <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>dev_fd<span class="token punctuation">,</span> HUMIDITY_IOCTL_ENABLE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        err <span class="token operator">=</span> err<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">?</span> <span class="token operator">-</span>errno <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">LOGE_IF</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"HUMIDITY_IOCTL_ENABLE failed (%s)"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mEnabled <span class="token operator">=</span> en <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>en<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">setInitialState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">HumiditySensor</span><span class="token double-colon punctuation">::</span><span class="token function">hasPendingEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> mHasPendingEvent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token class-name">HumiditySensor</span><span class="token double-colon punctuation">::</span><span class="token function">setDelay</span><span class="token punctuation">(</span><span class="token keyword">int32_t</span> handle<span class="token punctuation">,</span> <span class="token keyword">int64_t</span> ns<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ns <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">open_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> delay <span class="token operator">=</span> ns <span class="token operator">/</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>dev_fd<span class="token punctuation">,</span> HUMIDITY_IOCTL_SET_DELAY<span class="token punctuation">,</span> <span class="token operator">&amp;</span>delay<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span>errno<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">HumiditySensor</span><span class="token double-colon punctuation">::</span><span class="token function">isActivated</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token comment">/* handle */</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> mEnabled<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">HumiditySensor</span><span class="token double-colon punctuation">::</span><span class="token function">readEvents</span><span class="token punctuation">(</span>sensors_event_t<span class="token operator">*</span> data<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mHasPendingEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mHasPendingEvent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        mPendingEvent<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> <span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>data <span class="token operator">=</span> mPendingEvent<span class="token punctuation">;</span>
        <span class="token keyword">return</span> mEnabled <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ssize_t n <span class="token operator">=</span> mInputReader<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>data_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> n<span class="token punctuation">;</span>
    <span class="token keyword">int</span> numEventReceived <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    input_event <span class="token keyword">const</span><span class="token operator">*</span> event<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&amp;&amp;</span> mInputReader<span class="token punctuation">.</span><span class="token function">readEvent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> type <span class="token operator">=</span> event<span class="token operator">-&gt;</span>type<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> EV_ABS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">processEvent</span><span class="token punctuation">(</span>event<span class="token operator">-&gt;</span>code<span class="token punctuation">,</span> event<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> EV_SYN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int64_t</span> time <span class="token operator">=</span> <span class="token function">timevalToNano</span><span class="token punctuation">(</span>event<span class="token operator">-&gt;</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPendingEvent<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> time<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mEnabled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>data<span class="token operator">++</span> <span class="token operator">=</span> mPendingEvent<span class="token punctuation">;</span>
                count<span class="token operator">--</span><span class="token punctuation">;</span>
                numEventReceived<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"HumiditySensor: unknown event (type=%d, code=%d)"</span><span class="token punctuation">,</span>
                    type<span class="token punctuation">,</span> event<span class="token operator">-&gt;</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mInputReader<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> numEventReceived<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">HumiditySensor</span><span class="token double-colon punctuation">::</span><span class="token function">processEvent</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> EVENT_TYPE_HUMIDITY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//mPendingEvent.relative_humidity = value * CONVERT_B ;</span>
			mPendingEvent<span class="token punctuation">.</span>relative_humidity <span class="token operator">=</span> value<span class="token punctuation">;</span>
			<span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"HUM---%s:value=%d\n"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"HUM---%s:value * CONVERT_B = %f\n"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span> mPendingEvent<span class="token punctuation">.</span>relative_humidity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>里面的核心函数就是open 然后ioctl发送不同的魔数去获取到数据。那么我们的hal层拿到数据只是完成了启下作用，即从内核驱动中获取数据。那么我们还要把数据给到JNI。由于hal层和farmware层都是运行在用户空间，jni也是由C/C++编写。并且hal层是以.so的动态库文件的形式存在。那么我们只要在jni包含该库文件就可以。调用到我们的功能函数。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/647f3f7955920e07e372e12b9d8989a8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">10个最常用的 VSCode 快捷键，提升你的编码速度</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/515e08acf90d2985c62ceb7e91a18129/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java之 类（内部类，抽象类，接口）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>