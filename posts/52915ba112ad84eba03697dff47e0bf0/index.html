<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>yii2框架的优缺点以及一些坑 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="yii2框架的优缺点以及一些坑" />
<meta property="og:description" content="标题ActiveRecord被莫名写入？ 准备知识
ActiveRecord的基本用法。
/** * @property integer $id * @property string $name * @property string $detail * @property double $price * @property integer $area **/ class OcRoom extends ActivieRecord { ... } $room = OcRoom::find() //先取出一个对象。 -&gt;select([&#39;id&#39;]) //只取出&#39;id&#39;列 -&gt;where([&#39;id&#39;=&gt;20]) -&gt;one(); $room-&gt;save(); //保存，会发现此行的其它字段都被写成默认值了。 总结问题
这个例子的问题在于：
我从数据库中取出了一行，也就是代码中的room，但是只取出了id字段，而其他字段自然就是默认值。
当我$room-&gt;save()的时候，那些是默认值的字段也被保存到数据库里去了。what!?
也就是说，当你想节约资源，不取出所有字段的时候，一定要注意不能保存，否则，很多数据会被莫名修改为默认值。
解决方法
然而，我们有什么解决办法呢？提供几种思路：
自己时刻注意，避免未完全取出的ActiveRecord的保存。
修改或继承ActiveRecord, 使得，当此对象由find()新建，且字段没有完全取出，调用save()方法，抛出异常。
修改或继承ActiveRecord，使得，当此对象由find()新建，且字段没有完全取出，调用save()方法时，只保存取出过的字段，其他字段被忽略。
标题你的Transaction生效了吗？ /** * @property integer $id * @property string $name **/ class OcRoom extends ActiveRecord { public function rules() { return [[&#39;name&#39;,&#39;string&#39;,&#39;min&#39;=&gt;2,&#39;max&#39;=&gt;10]]; } ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/52915ba112ad84eba03697dff47e0bf0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-18T17:32:19+08:00" />
<meta property="article:modified_time" content="2023-05-18T17:32:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">yii2框架的优缺点以及一些坑</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="ActiveRecord_1"></a>标题ActiveRecord被莫名写入？</h3> 
<p>准备知识<br> ActiveRecord的基本用法。</p> 
<pre><code class="prism language-php"><span class="token comment">/**
 * @property integer $id
 * @property string $name
 * @property string $detail
 * @property double $price
 * @property integer $area
 **/</span>
<span class="token keyword">class</span> <span class="token class-name">OcRoom</span> <span class="token keyword">extends</span> <span class="token class-name">ActivieRecord</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token variable">$room</span> <span class="token operator">=</span> <span class="token class-name static-context">OcRoom</span><span class="token operator">::</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment">//先取出一个对象。</span>
    <span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token comment">//只取出'id'列</span>
    <span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$room</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//保存，会发现此行的其它字段都被写成默认值了。</span>
</code></pre> 
<p>总结问题<br> 这个例子的问题在于：</p> 
<p>我从数据库中取出了一行，也就是代码中的room，但是只取出了id字段，而其他字段自然就是默认值。<br> 当我$room-&gt;save()的时候，那些是默认值的字段也被保存到数据库里去了。what!?<br> 也就是说，当你想节约资源，不取出所有字段的时候，一定要注意不能保存，否则，很多数据会被莫名修改为默认值。<br> 解决方法<br> 然而，我们有什么解决办法呢？提供几种思路：</p> 
<p>自己时刻注意，避免未完全取出的ActiveRecord的保存。<br> 修改或继承ActiveRecord, 使得，当此对象由find()新建，且字段没有完全取出，调用save()方法，抛出异常。<br> 修改或继承ActiveRecord，使得，当此对象由find()新建，且字段没有完全取出，调用save()方法时，只保存取出过的字段，其他字段被忽略。</p> 
<h3><a id="Transaction_38"></a>标题你的Transaction生效了吗？</h3> 
<pre><code class="prism language-php"><span class="token comment">/**
 * @property integer $id
 * @property string $name
 **/</span>
<span class="token keyword">class</span> <span class="token class-name">OcRoom</span> <span class="token keyword">extends</span> <span class="token class-name">ActiveRecord</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'string'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'min'</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'max'</span><span class="token operator">=&gt;</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">OcHouse</span> <span class="token package">extends</span> <span class="token class-name">ActiveRecord</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'string'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'max'</span><span class="token operator">=&gt;</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OcRoom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>                <span class="token comment">//name为空字符串，不满足rules()条件。</span>

<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OcHouse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'我的房间'</span><span class="token punctuation">;</span>         <span class="token comment">//name合法，可以保存。</span>

<span class="token variable">$transaction</span> <span class="token operator">=</span> <span class="token class-name static-context">Yii</span><span class="token operator">::</span><span class="token variable">$app</span><span class="token operator">-&gt;</span><span class="token property">db</span><span class="token operator">-&gt;</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$a</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//name字段不合法，无法验证通过，在validate()阶段已经返回false,不会进行数据库存储的步骤，所以也不会抛出异常。</span>
    <span class="token variable">$b</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//name字段合法，可以正常保存。</span>

    <span class="token variable">$transaction</span><span class="token operator">-&gt;</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//提交后，发现$a保存失败，而$b保存成功。</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name static-context">Yii</span><span class="token operator">::</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getTraceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">__METHOD__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$transaction</span><span class="token operator">-&gt;</span><span class="token function">rollBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这段代码的问题在于：</p> 
<p>大家知道transaction的存在意义是保证整段数据库存储代码要么全成功，要么全失败。<br> 显然，在这个例子中，transaction并没有达到我们想要的效果：a因为validate()都没过，所以transation-&gt;commit()的时候并不会报错。<br> 解决方法<br> 在$transation块内，所有的save()都要判断下返回值，如果为false，则直接抛出异常。</p> 
<h3><a id="Ymd_89"></a>标题’Y-m-d’不被识别？</h3> 
<pre><code class="prism language-php">OcRenterBill <span class="token keyword">extends</span> <span class="token class-name">ActiveRecord</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
            <span class="token punctuation">[</span><span class="token string single-quoted-string">'start_time'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'date'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'format'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'Y-m-d'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OcRenterBill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'2015-09-12'</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//会报错，说格式不对</span>
</code></pre> 
<p>问题总结<br> 如果一开始，Yii框架就报错，这个还不算坑。坑的是我在Mac上开发时，这个可以完全正常的工作，而发布到线上环境（Ubuntu）后，就弹出“属性start_time格式无效”的错误。而参考官方文档，发现这种格式是允许的官方文档。</p> 
<p>啊啊啊。各种试错，最后发现如果改成php:Y-m-d，世界就清净了。所以，如果你遇到这种问题，感激我吧。</p> 
<h3><a id="_112"></a>标题内存泄露</h3> 
<pre><code class="prism language-php"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">actionTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$total</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'开始内存'</span><span class="token operator">.</span><span class="token function">memory_get_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token variable">$total</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$ret</span><span class="token operator">=</span><span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">910002</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'end内存'</span><span class="token operator">.</span><span class="token function">memory_get_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$ret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$total</span><span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>上面代码的内存一直在增长， 按照原本想法来看， 变量被释放了，内存就算增长也不会一直增长。因为每循环一次内存都会被释放。</p> 
<p>分析问题 上面这段代码涉及到了数据库的操作，而我们知道，数据库的很多地方都能引起内存泄漏。 所以先屏蔽数据库相关操作， 我手写了一个原生的数据库查询操作， 发现内存正常，没有问题。</p> 
<pre><code class="prism language-php"><span class="token variable">$dsn</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"mysql:dbname=test;host=localhost"</span><span class="token punctuation">;</span>
<span class="token variable">$db_user</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">;</span>
<span class="token variable">$db_pass</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'admin'</span><span class="token punctuation">;</span>
<span class="token comment">//查询</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"select * from buyer"</span><span class="token punctuation">;</span>
<span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$pdo</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$res</span> <span class="token keyword">as</span> <span class="token variable">$row</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">echo</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'&lt;br/&gt;'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这时候答案呼之欲出— 是yii2框架搞了鬼</p> 
<p>定位问题 既然知道了是yii2 框架的问题那就可以进一步缩小问题。</p> 
<pre><code class="prism language-php"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">actionTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$total</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'开始内存'</span><span class="token operator">.</span><span class="token function">memory_get_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token variable">$total</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$ret</span><span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'end内存'</span><span class="token operator">.</span><span class="token function">memory_get_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$ret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$total</span><span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>内存还是一直增长。 这时候我测试了一个其他的yii2类 发觉内存不增长了。 这就可以联想到是在new 对象的时候yii2内部自己执行了什么操作，然后导致内存泄漏。 什么方法是new 的时候就执行的呢。。。 对的 构造方法 __construct 。 然后 我一步一步的从model 查到object 发觉都没有能引起泄漏的地方。</p> 
<p>这个时候我们不妨换个思路， 既然是yii2框架下出现的泄漏， 那肯定就是yii2独有的功能， 那什么功能是yii2独有的，又是在new 对象的时候就会执行的呢？</p> 
<p>行为（Behavior） 发觉我的模型类里面果然有用了行为</p> 
<pre><code class="prism language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">behaviors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
            <span class="token class-name static-context">TimestampBehavior</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>最普通不过的代码。 我们知道 行为最后调用的地方是 yii\base\Component-&gt;attachBehaviors 最后定位到</p> 
<pre><code class="prism language-php"><span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">attachBehaviorInternal</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$behavior</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$behavior</span> <span class="token keyword">instanceof</span> <span class="token class-name">Behavior</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$behavior</span> <span class="token operator">=</span> <span class="token class-name static-context">Yii</span><span class="token operator">::</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token variable">$behavior</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_int</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$behavior</span><span class="token operator">-&gt;</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_behaviors</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$behavior</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_behaviors</span><span class="token punctuation">[</span><span class="token variable">$name</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_behaviors</span><span class="token punctuation">[</span><span class="token variable">$name</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$behavior</span><span class="token operator">-&gt;</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_behaviors</span><span class="token punctuation">[</span><span class="token variable">$name</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$behavior</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">return</span> <span class="token variable">$behavior</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>我们观察这段代码，发觉他把自己传进去了behavior-&gt;attach($this); 最后调用的是 yii\base\Behavior-&gt;attach</p> 
<pre><code class="prism language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token variable">$owner</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">owner</span> <span class="token operator">=</span> <span class="token variable">$owner</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$event</span> <span class="token operator">=&gt;</span> <span class="token variable">$handler</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$owner</span><span class="token operator">-&gt;</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token variable">$event</span><span class="token punctuation">,</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$handler</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token variable">$handler</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token variable">$handler</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>问题总结<br> 这个时候答案已经呼之欲出， Yii2为了实现行为这一功能， 把自身this传进去，以便能注册事件、触发事件、解除事件。 这就导致了一个循环引用的问题。 所以导致对象refcount一直不为0 一直回收不了。</p> 
<p>接下来就好办了。将查询换成原始的连接试试。果然，内存上升的非常慢了，可以说这才是正常现象。现在的内存也就是50m左右，cpu也稳定在7%左右。</p> 
<p>代码优化后，再跑脚本，1分钟左右吧，脚本就跑完了。重点是不会再报出内存错误了。所以，以后考虑问题还是要深入。敢于质疑。以后如果遇到这种内存错误，一定要先检查自己的代码是不是有内存泄漏的地方。不要想着先设置php的内存。这样只会治标不治本。</p> 
<p>总结<br> 1、从开发速度方面，借助于gii脚手架，可以快速生成代码，也就是说搭建一个可以增删改查的系统可能一行代码都不用写，而且集成了jquery和bootstrap，特效和样式基本也不需要写了，这对于设计和审美能力普遍较差的后端程序员来说简直是一大福利。不过在前后端完全的分离的趋势下，Yii2前后端的耦合的还是有些重了。</p> 
<p>2、从代码的可读性方面，Yii不会为了刻板地遵照某种设计模式而对代码进行过度的设计。基本上类在IDE里不借助第三方组件是可以跳转阅读源码的。这点上Yii要比Laravel略胜一筹。</p> 
<p>3、从开源生态圈方面，Yii因为人少，稍微偏门一点的资料就很少，需要强大的谷歌能力和阅读英文文档的能力。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/330ef75f1400739387b86167c8d7a508/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">后台管理系统中数据库存储文章用什么类型，mysql数据库中怎么存储大段文字呢？(1000个中文字符以上）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9ce7a909d6aa3b9bed75166a08e564b2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java 字符串类型的JSON数组转List＜Object＞或 List＜实体类＞</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>