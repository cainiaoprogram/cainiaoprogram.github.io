<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Docker-Compose部署ELK - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Docker-Compose部署ELK" />
<meta property="og:description" content="Docker-Compose部署ELK(保姆级教程) 部署elk 创建目录 和文件配置docker-compose并启动打开kibana 1.创建docker-elk目录 （此目录任意 推荐使用此 否则需要更改compose配置） sudo mkdir /opt/docker_elk 2.创建logstash配置文件 sudo mkdir /opt/docker_elk/logstash sudo touch /opt/docker_elk/logstash/logstash.conf 3.配置logstash.conf，其内容如下 input { tcp { mode =&gt; &#34;server&#34; host =&gt; &#34;0.0.0.0&#34; port =&gt; 4560 codec =&gt; json } } output { elasticsearch { hosts =&gt; &#34;es:9200&#34; index =&gt; &#34;logstash-%{&#43;YYYY.MM.dd}&#34; } } 在这里指定了输入的日志的端口是4560，那么下面对外暴露的端口也必须是4560。 此端口为logStash 通信端口 可更改（更改同样修改 compose 配置）
4.创建docker-compose.yml文件 sudo touch /opt/docker_elk/docker-compose.yml 5.配置 docker-compose并启动 sudo cd /opt/docker_elk sudo vi docker-compose.yml 配置内容如下
version: &#39;3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c9ad87bc13b5daefe8bc268ec8baee41/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-25T17:29:57+08:00" />
<meta property="article:modified_time" content="2023-04-25T17:29:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Docker-Compose部署ELK</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="DockerComposeELK_0"></a>Docker-Compose部署ELK(保姆级教程)</h2> 
<ul><li>部署elk</li></ul> 
<ul><li>创建目录 和文件</li><li>配置docker-compose并启动</li><li>打开kibana</li></ul> 
<h4><a id="1dockerelk___compose_9"></a>1.创建docker-elk目录 （此目录任意 推荐使用此 否则需要更改compose配置）</h4> 
<pre><code class="prism language-javascript">sudo mkdir <span class="token operator">/</span>opt<span class="token operator">/</span>docker_elk
</code></pre> 
<h4><a id="2logstash_13"></a>2.创建logstash配置文件</h4> 
<pre><code class="prism language-javascript">sudo mkdir <span class="token operator">/</span>opt<span class="token operator">/</span>docker_elk<span class="token operator">/</span>logstash
sudo touch  <span class="token operator">/</span>opt<span class="token operator">/</span>docker_elk<span class="token operator">/</span>logstash<span class="token operator">/</span>logstash<span class="token punctuation">.</span>conf
</code></pre> 
<h4><a id="3logstashconf_18"></a>3.配置logstash.conf，其内容如下</h4> 
<pre><code class="prism language-javascript">input <span class="token punctuation">{<!-- --></span>
  tcp <span class="token punctuation">{<!-- --></span>
    <span class="token parameter">mode</span> <span class="token operator">=&gt;</span> <span class="token string">"server"</span>
    <span class="token parameter">host</span> <span class="token operator">=&gt;</span> <span class="token string">"0.0.0.0"</span>
    <span class="token parameter">port</span> <span class="token operator">=&gt;</span> <span class="token number">4560</span>
    <span class="token parameter">codec</span> <span class="token operator">=&gt;</span> json
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
output <span class="token punctuation">{<!-- --></span>
  elasticsearch <span class="token punctuation">{<!-- --></span>
    <span class="token parameter">hosts</span> <span class="token operator">=&gt;</span> <span class="token string">"es:9200"</span>
    <span class="token parameter">index</span> <span class="token operator">=&gt;</span> <span class="token string">"logstash-%{+YYYY.MM.dd}"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在这里指定了输入的日志的端口是4560，那么下面对外暴露的端口也必须是4560。 此端口为logStash 通信端口 可更改（更改同样修改 compose 配置）</p> 
<h4><a id="4dockercomposeyml_37"></a>4.创建docker-compose.yml文件</h4> 
<pre><code class="prism language-javascript">sudo touch <span class="token operator">/</span>opt<span class="token operator">/</span>docker_elk<span class="token operator">/</span>docker<span class="token operator">-</span>compose<span class="token punctuation">.</span>yml
</code></pre> 
<h4><a id="5_dockercompose_41"></a>5.配置 docker-compose并启动</h4> 
<pre><code class="prism language-javascript">sudo cd <span class="token operator">/</span>opt<span class="token operator">/</span>docker_elk
sudo vi docker<span class="token operator">-</span>compose<span class="token punctuation">.</span>yml
</code></pre> 
<p>配置内容如下</p> 
<pre><code class="prism language-javascript"><span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token string">'3.7'</span>
<span class="token literal-property property">services</span><span class="token operator">:</span>
  <span class="token literal-property property">elasticsearch</span><span class="token operator">:</span>
    <span class="token literal-property property">image</span><span class="token operator">:</span> elasticsearch<span class="token operator">:</span><span class="token number">7.6</span><span class="token number">.2</span>
    <span class="token literal-property property">container_name</span><span class="token operator">:</span> elasticsearch
    <span class="token literal-property property">privileged</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> root
    <span class="token literal-property property">environment</span><span class="token operator">:</span>
      #设置集群名称为elasticsearch
      <span class="token operator">-</span> cluster<span class="token punctuation">.</span>name<span class="token operator">=</span>elasticsearch 
      #以单一节点模式启动
      <span class="token operator">-</span> discovery<span class="token punctuation">.</span>type<span class="token operator">=</span>single<span class="token operator">-</span>node 
      #设置使用jvm内存大小
      <span class="token operator">-</span> <span class="token constant">ES_JAVA_OPTS</span><span class="token operator">=</span><span class="token operator">-</span>Xms512m <span class="token operator">-</span>Xmx512m 
    <span class="token literal-property property">volumes</span><span class="token operator">:</span>
      <span class="token operator">-</span> <span class="token operator">/</span>opt<span class="token operator">/</span>docker_elk<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>plugins<span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>plugins
      <span class="token operator">-</span> <span class="token operator">/</span>opt<span class="token operator">/</span>docker_elk<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>data<span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>data
    <span class="token literal-property property">ports</span><span class="token operator">:</span>
      <span class="token operator">-</span> <span class="token number">9200</span><span class="token operator">:</span><span class="token number">9200</span>
      <span class="token operator">-</span> <span class="token number">9300</span><span class="token operator">:</span><span class="token number">9300</span>

  <span class="token literal-property property">logstash</span><span class="token operator">:</span>
    <span class="token literal-property property">image</span><span class="token operator">:</span> logstash<span class="token operator">:</span><span class="token number">7.6</span><span class="token number">.2</span>
    <span class="token literal-property property">container_name</span><span class="token operator">:</span> logstash
    <span class="token literal-property property">ports</span><span class="token operator">:</span>
       <span class="token operator">-</span> <span class="token number">4560</span><span class="token operator">:</span><span class="token number">4560</span>
    <span class="token literal-property property">privileged</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token literal-property property">environment</span><span class="token operator">:</span>
      <span class="token operator">-</span> <span class="token constant">TZ</span><span class="token operator">=</span>Asia<span class="token operator">/</span>Shanghai
    <span class="token literal-property property">volumes</span><span class="token operator">:</span>
      #挂载logstash的配置文件
      <span class="token operator">-</span> <span class="token operator">/</span>opt<span class="token operator">/</span>docker_elk<span class="token operator">/</span>logstash<span class="token operator">/</span>logstash<span class="token punctuation">.</span>conf<span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>logstash<span class="token operator">/</span>pipeline<span class="token operator">/</span>logstash<span class="token punctuation">.</span>conf 
    <span class="token literal-property property">depends_on</span><span class="token operator">:</span>
      <span class="token operator">-</span> elasticsearch 
    <span class="token literal-property property">links</span><span class="token operator">:</span>
      #可以用es这个域名访问elasticsearch服务
      <span class="token operator">-</span> elasticsearch<span class="token operator">:</span>es 
    

  <span class="token literal-property property">kibana</span><span class="token operator">:</span>
    <span class="token literal-property property">image</span><span class="token operator">:</span> kibana<span class="token operator">:</span><span class="token number">7.6</span><span class="token number">.2</span>
    <span class="token literal-property property">container_name</span><span class="token operator">:</span> kibana
    <span class="token literal-property property">ports</span><span class="token operator">:</span>
        <span class="token operator">-</span> <span class="token number">5601</span><span class="token operator">:</span><span class="token number">5601</span>
    <span class="token literal-property property">privileged</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token literal-property property">links</span><span class="token operator">:</span>
      #可以用es这个域名访问elasticsearch服务
      <span class="token operator">-</span> elasticsearch<span class="token operator">:</span>es 
    <span class="token literal-property property">depends_on</span><span class="token operator">:</span>
      <span class="token operator">-</span> elasticsearch 
    <span class="token literal-property property">environment</span><span class="token operator">:</span>
      #设置访问elasticsearch的地址
      <span class="token operator">-</span> elasticsearch<span class="token punctuation">.</span>hosts<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>es<span class="token operator">:</span><span class="token number">9200</span> 
   
</code></pre> 
<p>这里使用privileged设置为true是赋予这个容器root权限。然后启动</p> 
<pre><code class="prism language-javascript">sudo docker<span class="token operator">-</span>compose up <span class="token operator">-</span>d
</code></pre> 
<p>在启动时，如果Elasticsearch启动报错，说/usr/share/elasticsearch/data下的文件无权限，那么需要给宿主机授予读写权限</p> 
<pre><code class="prism language-javascript">chmod <span class="token number">777</span> <span class="token operator">/</span>opt<span class="token operator">/</span>docker_elk<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>data
</code></pre> 
<p>在启动时，如果Elasticsearch启动报错，说/usr/share/elasticsearch/data下的文件无权限，那么需要给宿主机授予读写权限</p> 
<pre><code class="prism language-javascript">chmod <span class="token number">777</span> <span class="token operator">/</span>opt<span class="token operator">/</span>docker_elk<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>data
</code></pre> 
<h4><a id="6kibana_121"></a>6.打开kibana</h4> 
<p>输入http://xxx.xxx.x.xxx:5601，访问Kibana web界面。点击左侧设置，进入Management界面<br> <img src="https://images2.imgbox.com/f2/ae/q8eokxLB_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="7_125"></a>7.收集日志</h4> 
<p>新建一个springboot的项目，需要导入web的依赖</p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>web<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>除此之外，需要导入logstash的依赖：</p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>集成logstash<span class="token operator">--</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>net<span class="token punctuation">.</span>logstash<span class="token punctuation">.</span>logback<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>logstash<span class="token operator">-</span>logback<span class="token operator">-</span>encoder<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">6.6</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>logback是SpringBoot自带的日志，只要导入了web的依赖即可使用。</p> 
<p>1）在测试包下新建一个测试类和测试方法</p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>LogManager<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>Logger<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span>Test<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>SpringBootTest<span class="token punctuation">;</span>

@SpringBootTest
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppTest</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//创建日志对象</span>
    Logger logger <span class="token operator">=</span> LogManager<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    @Test
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"logback的日志信息过来了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"logback的错误信息过来了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2）在需要目录新建logback-spring.xml</p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> configuration<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>configuration<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>include resource<span class="token operator">=</span><span class="token string">"org/springframework/boot/logging/logback/defaults.xml"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>include resource<span class="token operator">=</span><span class="token string">"org/springframework/boot/logging/logback/console-appender.xml"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>应用名称<span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"APP_NAME"</span> value<span class="token operator">=</span><span class="token string">"springboot-logback-elk-demo"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>日志文件保存路径<span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"LOG_FILE_PATH"</span> value<span class="token operator">=</span><span class="token string">"${LOG_FILE:-${LOG_PATH:-${LOG_TEMP:-${java.io.tmpdir:-/tmp}}}/logs}"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>contextName<span class="token operator">&gt;</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">APP_NAME</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>contextName<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>每天记录日志到文件appender<span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>appender name<span class="token operator">=</span><span class="token string">"FILE"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"ch.qos.logback.core.rolling.RollingFileAppender"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>rollingPolicy <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>fileNamePattern<span class="token operator">&gt;</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">LOG_FILE_PATH</span><span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">APP_NAME</span><span class="token punctuation">}</span><span class="token operator">-</span><span class="token operator">%</span>d<span class="token punctuation">{<!-- --></span>yyyy<span class="token operator">-</span><span class="token constant">MM</span><span class="token operator">-</span>dd<span class="token punctuation">}</span><span class="token punctuation">.</span>log<span class="token operator">&lt;</span><span class="token operator">/</span>fileNamePattern<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>maxHistory<span class="token operator">&gt;</span><span class="token number">30</span><span class="token operator">&lt;</span><span class="token operator">/</span>maxHistory<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>rollingPolicy<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>encoder<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>pattern<span class="token operator">&gt;</span>$<span class="token punctuation">{<!-- --></span><span class="token constant">FILE_LOG_PATTERN</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>pattern<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>encoder<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>appender<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>输出到logstash的appender<span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>appender name<span class="token operator">=</span><span class="token string">"LOGSTASH"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"net.logstash.logback.appender.LogstashTcpSocketAppender"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>可以访问的logstash日志收集端口<span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>destination<span class="token operator">&gt;</span>xxx<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>xxx<span class="token operator">:</span><span class="token number">4560</span><span class="token operator">&lt;</span><span class="token operator">/</span>destination<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>encoder charset<span class="token operator">=</span><span class="token string">"UTF-8"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"net.logstash.logback.encoder.LogstashEncoder"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>appender<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>root level<span class="token operator">=</span><span class="token string">"INFO"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>appender<span class="token operator">-</span>ref ref<span class="token operator">=</span><span class="token string">"CONSOLE"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>appender<span class="token operator">-</span>ref ref<span class="token operator">=</span><span class="token string">"FILE"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>appender<span class="token operator">-</span>ref ref<span class="token operator">=</span><span class="token string">"LOGSTASH"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>root<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>configuration<span class="token operator">&gt;</span>
</code></pre> 
<p>3）启动测试方法，然后点击index Patterns后，点击创建索引<br> <img src="https://images2.imgbox.com/9c/88/oALpGW2r_o.png" alt="在这里插入图片描述"><br> 4）点击创建索引，<br> <img src="https://images2.imgbox.com/b1/3d/2jo6zyJi_o.png" alt="在这里插入图片描述"><br> 5）创建名称为logstash-<em>的index，此名字是在配置文件logstash.conf中配置的。上述配置的是logstash-%{+YYYY.MM.dd}，故这里使用</em>代替日期<br> <img src="https://images2.imgbox.com/8f/c9/Ea2Bl2ia_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b4/51/Pifj45x9_o.png" alt="在这里插入图片描述"><br> 6）然后在Next Step(下一步)中选择@timestamp的filter</p> 
<p><img src="https://images2.imgbox.com/cb/12/dMhYJZhR_o.png" alt="在这里插入图片描述"><br> 7）创建完成之后，点击Discover，并选择刚才创建的index</p> 
<p><img src="https://images2.imgbox.com/0d/87/Fw8pK8Q6_o.png" alt="在这里插入图片描述"><br> 8）查看kibana的日志信息<br> <img src="https://images2.imgbox.com/38/39/ODGKh8Ur_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_209"></a>到此已完成配置</h3> 
<h4><a id="8log4j2_210"></a>8.使用log4j2记录日志</h4> 
<p>1）排除logback并导入依赖</p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span>exclusions<span class="token operator">&gt;</span>        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 引入log4j日志时需去掉默认的logback <span class="token operator">--</span><span class="token operator">&gt;</span>        <span class="token operator">&lt;</span>exclusion<span class="token operator">&gt;</span>            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>logging<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>exclusion<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>exclusions<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 日志管理log4j2 <span class="token operator">--</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>log4j2<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.1</span><span class="token number">.0</span><span class="token punctuation">.</span><span class="token constant">RELEASE</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>2）在资源目录下新建log4j2.xml</p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">?</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>configuration status<span class="token operator">=</span><span class="token string">"info"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Properties<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 声明日志文件存储的目录 <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Property name<span class="token operator">=</span><span class="token string">"LOG_HOME"</span><span class="token operator">&gt;</span><span class="token constant">E</span><span class="token operator">:</span>\logs<span class="token operator">&lt;</span><span class="token operator">/</span>Property<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Property name<span class="token operator">=</span><span class="token string">"LOG_PATTERN"</span>
                  value<span class="token operator">=</span><span class="token string">"%date{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread][%class{36}:%line] - %msg%n"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Property<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Properties<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>Appenders<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>输出控制台的配置<span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Console name<span class="token operator">=</span><span class="token string">"Console"</span> target<span class="token operator">=</span><span class="token string">"SYSTEM_OUT"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>控制台只输出level及以上级别的信息（onMatch），其他的直接拒绝（onMismatch）<span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>ThresholdFilter level<span class="token operator">=</span><span class="token string">"info"</span> onMatch<span class="token operator">=</span><span class="token string">"ACCEPT"</span> onMismatch<span class="token operator">=</span><span class="token string">"DENY"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 输出日志的格式<span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>PatternLayout pattern<span class="token operator">=</span><span class="token string">"${LOG_PATTERN}"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Console<span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>这输出日志到文件的配置，每次大小超过size，则这size大小的日志会自动存入按年份<span class="token operator">-</span>月份建立的文件夹下面并进行压缩，作为存档<span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>RollingFile name<span class="token operator">=</span><span class="token string">"RollingFile"</span> fileName<span class="token operator">=</span><span class="token string">"${LOG_HOME}\app_${date:yyyy-MM-dd}.log"</span>
                     filePattern<span class="token operator">=</span><span class="token string">"${LOG_HOME}\${date:yyyy-MM}\app_%d{yyyy-MM-dd}_%i.log"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>ThresholdFilter level<span class="token operator">=</span><span class="token string">"info"</span> onMatch<span class="token operator">=</span><span class="token string">"ACCEPT"</span> onMismatch<span class="token operator">=</span><span class="token string">"DENY"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 输出日志的格式<span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>PatternLayout pattern<span class="token operator">=</span><span class="token string">"${LOG_PATTERN}"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 日志文件大小 <span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>SizeBasedTriggeringPolicy size<span class="token operator">=</span><span class="token string">"20MB"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 最多保留文件数 <span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>DefaultRolloverStrategy max<span class="token operator">=</span><span class="token string">"30"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>RollingFile<span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>输出到logstash的appender<span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Socket name<span class="token operator">=</span><span class="token string">"Socket"</span> host<span class="token operator">=</span><span class="token string">"xxx.xxx.xx.xxx"</span> port<span class="token operator">=</span><span class="token string">"4560"</span> protocol<span class="token operator">=</span><span class="token string">"TCP"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>输出到logstash的日志格式<span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>PatternLayout pattern<span class="token operator">=</span><span class="token string">"${LOG_PATTERN}"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Socket<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Appenders<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>然后定义Logger，只有定义了Logger并引入的Appender，Appender才会生效。Root中level配置了日志级别，可配置其他级别<span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Loggers<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Root level<span class="token operator">=</span><span class="token string">"info"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>AppenderRef ref<span class="token operator">=</span><span class="token string">"Console"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>AppenderRef ref<span class="token operator">=</span><span class="token string">"RollingFile"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>AppenderRef ref<span class="token operator">=</span><span class="token string">"Socket"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Root<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Loggers<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>configuration<span class="token operator">&gt;</span>
</code></pre> 
<p>logstash 指定host 与配置文件相同</p> 
<h4><a id="9_270"></a>9.功能提升</h4> 
<h5><a id="91_Kibana_271"></a>9.1 汉化Kibana</h5> 
<p>在使用Kibana界面时，发现都是英文的，实际上是可以配置中文版。方法如下：</p> 
<p>1）进入容器内部</p> 
<pre><code class="prism language-javascript">sudo docker exec <span class="token operator">-</span>it kibana bash
</code></pre> 
<p>2）打开配置文件</p> 
<pre><code class="prism language-javascript">vi <span class="token operator">/</span>opt<span class="token operator">/</span>kibana<span class="token operator">/</span>config<span class="token operator">/</span>kibana<span class="token punctuation">.</span>yml
</code></pre> 
<p>3）在配置文件最后添加一行，设置语言是中文</p> 
<pre><code class="prism language-javascript">i18n<span class="token punctuation">.</span>locale<span class="token operator">:</span> zh<span class="token operator">-</span><span class="token constant">CN</span>
</code></pre> 
<p>需要注意的是，zhe-CN和:号之间必须有个空格，否则kibana无法启动。</p> 
<h5><a id="92__290"></a>9.2 自定义日志过滤</h5> 
<p>对应logstash，默认是格式是使用的logback的默认格式，一旦使用log4j2或其他日志框架来指定日志的输出格式时，那么logstash便无法解析，需要进行自定义过滤。</p> 
<p>上述章节使用log4j2配置的输出格式进行日志收集时，定义的格式：<br> <img src="https://images2.imgbox.com/45/56/UzKJTzul_o.png" alt="在这里插入图片描述"></p> 
<p>它把所有的信息都记录在message上了如下图：<br> <img src="https://images2.imgbox.com/25/0a/O8w1gv1s_o.png" alt="在这里插入图片描述"></p> 
<p>但实际上并吧需要这么多的信息，只需具体的信息，因此需要手动对日志格式过滤。</p> 
<p>日志过滤<br> 1）修改日志输出的格式。紧接着时间的后面的一个参数必须使用中括号包裹，否则解析有问题</p> 
<p>将log4j2.xml的日志输出格式修改如下：</p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span>Property name<span class="token operator">=</span><span class="token string">"LOG_PATTERN"</span>
                  value<span class="token operator">=</span><span class="token string">"%date{yyyy-MM-dd HH:mm:ss.SSS} [%-5level] [%thread][%class{36}:%line] - %msg%n"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Property<span class="token operator">&gt;</span>
</code></pre> 
<p>2）在logstash.conf中添加过滤规则：</p> 
<pre><code class="prism language-javascript">filter <span class="token punctuation">{<!-- --></span>

    grok <span class="token punctuation">{<!-- --></span>
        <span class="token parameter">match</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token string">"%{DATA:datetime}\ \[%{DATA:level}\]\ \[%{DATA:class}\] - %{GREEDYDATA:logger}"</span>
            <span class="token parameter">remove_field</span> <span class="token operator">=&gt;</span><span class="token punctuation">[</span> <span class="token string">"message"</span> <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    date <span class="token punctuation">{<!-- --></span>
        <span class="token parameter">match</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string">"datetime"</span><span class="token punctuation">,</span> <span class="token string">"yyyy-MM-dd HH:mm:ss.SSS"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token string">"_grokparsefailure"</span> <span class="token keyword">in</span> <span class="token punctuation">[</span>tags<span class="token punctuation">]</span>    <span class="token punctuation">{<!-- --></span>
        drop <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中grok是根据正则来匹配日志的，data是指定上面时间的格式，if是用于将解析失败的信息删除。</p> 
<p>grok的正则语法在次略，其可以在kibana界面进行验证。打开在dev Tools，选择Grok Debugger，输入数据和规则点击模拟进行验证和解析<br> <img src="https://images2.imgbox.com/db/1c/cd5PtB3v_o.png" alt="在这里插入图片描述"><br> 3）重启logstash后，再打印日志，把日志推送到过去，在kibana中筛选level和logger进行查看（logger是具体的信息，在配置grok时指定的），看到信息已正常解析<br> <img src="https://images2.imgbox.com/13/e7/FuJoGmjY_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="multiline_333"></a>安装插件multiline</h5> 
<p>运行时会发生异常，把异常的错误信息通过日志推送到logstash<br> <img src="https://images2.imgbox.com/ff/30/B7tTS40A_o.png" alt="在这里插入图片描述"><br> 但在kibana中却看不到详细的信息<br> <img src="https://images2.imgbox.com/f2/7a/tnMjXVfK_o.png" alt="在这里插入图片描述"></p> 
<p>主要原因是错误信息换行输出的，对于上述配置的logstash会解析失败，故不会显示，因此需要安装插件multiline将多行合并为一行输出。</p> 
<p>2）安装multiline</p> 
<p>进入logstash容器内部，查看是否已安装multiline</p> 
<pre><code class="prism language-javascript">logstash<span class="token operator">-</span>plugin list
</code></pre> 
<p>若没有安装过，则进行安装</p> 
<pre><code class="prism language-javascript">logstash<span class="token operator">-</span>plugin install logstash<span class="token operator">-</span>filter<span class="token operator">-</span>multiline
</code></pre> 
<p>安装完成后在logstash.conf中的filter配置</p> 
<pre><code class="prism language-javascript">multiline <span class="token punctuation">{<!-- --></span>
        <span class="token parameter">pattern</span> <span class="token operator">=&gt;</span> <span class="token string">"^\d{4}-\d{1,2}-\d{1,2}\s\d{1,2}:\d{1,2}:\d{1,2}"</span>
        <span class="token parameter">negate</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
        <span class="token parameter">what</span> <span class="token operator">=&gt;</span> <span class="token string">"previous"</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7f/fe/rtO9EeF6_o.png" alt="在这里插入图片描述"></p> 
<p>配置后重启logstash，再次执行方法，会发现错误日志已正常记录<br> <img src="https://images2.imgbox.com/4d/7c/YbrXJ03y_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-javascript">需要注意的是，必须先安装multiline才能重启logstash，否则只配置logstash<span class="token punctuation">.</span>conf会导致logstash无法启动。
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/318f9dc208168d16f4f5519d76b01de4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python调用C语言接口</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/20d0cd6fd05153df9c485e615619db67/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vivado硬件调试</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>