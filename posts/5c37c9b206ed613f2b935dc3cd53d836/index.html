<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ActivityManagerService和ActivityTaskManagerService详解—Android 12（二） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ActivityManagerService和ActivityTaskManagerService详解—Android 12（二）" />
<meta property="og:description" content="接上一篇博客ActivityManagerService和ActivityTaskManagerService启动详解—Android 12（一），介绍了SystemServer.starBootstrapServices()中启动AMS和ATMS所做的工作，这一节介绍在SystemServer.startCoreServices()中关于AMS和ATMS设置UsageStateManagerInternal服务来跟踪application使用状态的业务。
目录
1. AMS和ATMS设置UsageStateManagerInternal服务
1.1 AMS.setUsageStatsManager() 1.2 ATMS.setUsageStatsManager() 1.3 UsageStatsManagerInternal 1.4 UsageStatsService
1.4.1 UsageStatsService.onStart()
1.4.2 UsageStatsService的内部类BinderService
1.4.3 UsageStatsService的内部类LocalServicce 2. 创建系统服务的步骤
1. AMS和ATMS设置UsageStateManagerInternal服务 // /frameworks/base/services/java/com/android/server/SystemServer.java public final class SystemServer implements Dumpable { private void startCoreServices(@NonNull TimingsTraceAndSlog t) { // Tracks application usage stats. t.traceBegin(&#34;StartUsageService&#34;); mSystemServiceManager.startService(UsageStatsService.class); mActivityManagerService.setUsageStatsManager( LocalServices.getService(UsageStatsManagerInternal.class)); t.traceEnd(); } } 1.1 AMS.setUsageStatsManager() // /frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java public class ActivityManagerService extends IActivityManager.Stub implements Watchdog.Monitor, BatteryStatsImpl.BatteryCallback, ActivityManagerGlobalLock { public void setUsageStatsManager(@NonNull UsageStatsManagerInternal usageStatsManager) { mUsageStatsService = usageStatsManager; mActivityTaskManager." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/5c37c9b206ed613f2b935dc3cd53d836/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-10T15:23:54+08:00" />
<meta property="article:modified_time" content="2023-05-10T15:23:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ActivityManagerService和ActivityTaskManagerService详解—Android 12（二）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>接上一篇博客<a href="https://blog.csdn.net/lvyaer_1122/article/details/130573451" title="ActivityManagerService和ActivityTaskManagerService启动详解—Android 12（一）">ActivityManagerService和ActivityTaskManagerService启动详解—Android 12（一）</a>，介绍了SystemServer.starBootstrapServices()中启动AMS和ATMS所做的工作，这一节介绍在SystemServer.startCoreServices()中关于AMS和ATMS设置UsageStateManagerInternal服务来跟踪application使用状态的业务。</p> 
<hr> 
<p id="main-toc"></p> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:0px;"></p> 
<p id="1.%20AMS%E5%92%8CATMS%E8%AE%BE%E7%BD%AEUsageStateManagerInternal%E6%9C%8D%E5%8A%A1-toc" style="margin-left:0px;"><a href="#1.%20AMS%E5%92%8CATMS%E8%AE%BE%E7%BD%AEUsageStateManagerInternal%E6%9C%8D%E5%8A%A1" rel="nofollow">1. AMS和ATMS设置UsageStateManagerInternal服务</a></p> 
<p id="1.1%20AMS.setUsageStatsManager()%C2%A0-toc" style="margin-left:40px;"><a href="#1.1%20AMS.setUsageStatsManager%28%29%C2%A0" rel="nofollow">1.1 AMS.setUsageStatsManager() </a></p> 
<p id="%C2%A01.2%20ATMS.setUsageStatsManager()%C2%A0-toc" style="margin-left:40px;"><a href="#%C2%A01.2%20ATMS.setUsageStatsManager%28%29%C2%A0" rel="nofollow">1.2 ATMS.setUsageStatsManager() </a></p> 
<p id="%C2%A01.3%20UsageStatsManagerInternal%C2%A0-toc" style="margin-left:40px;"><a href="#%C2%A01.3%20UsageStatsManagerInternal%C2%A0" rel="nofollow">1.3 UsageStatsManagerInternal </a></p> 
<p id="1.4%C2%A0UsageStatsService-toc" style="margin-left:40px;"><a href="#1.4%C2%A0UsageStatsService" rel="nofollow">1.4 UsageStatsService</a></p> 
<p id="1.4.1%C2%A0UsageStatsService.onStart()-toc" style="margin-left:80px;"><a href="#1.4.1%C2%A0UsageStatsService.onStart%28%29" rel="nofollow">1.4.1 UsageStatsService.onStart()</a></p> 
<p id="1.4.2%C2%A0UsageStatsService%E7%9A%84%E5%86%85%E9%83%A8%E7%B1%BBBinderService-toc" style="margin-left:80px;"><a href="#1.4.2%C2%A0UsageStatsService%E7%9A%84%E5%86%85%E9%83%A8%E7%B1%BBBinderService" rel="nofollow">1.4.2 UsageStatsService的内部类BinderService</a></p> 
<p id="1.4.3%C2%A0UsageStatsService%E7%9A%84%E5%86%85%E9%83%A8%E7%B1%BBLocalServicce%C2%A0-toc" style="margin-left:80px;"><a href="#1.4.3%C2%A0UsageStatsService%E7%9A%84%E5%86%85%E9%83%A8%E7%B1%BBLocalServicce%C2%A0" rel="nofollow">1.4.3 UsageStatsService的内部类LocalServicce </a></p> 
<p id="2.%20%E5%88%9B%E5%BB%BA%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%AD%A5%E9%AA%A4-toc" style="margin-left:0px;"><a href="#2.%20%E5%88%9B%E5%BB%BA%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%AD%A5%E9%AA%A4" rel="nofollow">2. 创建系统服务的步骤</a></p> 
<hr id="hr-toc"> 
<h2>1. AMS和ATMS设置UsageStateManagerInternal服务</h2> 
<pre><code class="language-java">// /frameworks/base/services/java/com/android/server/SystemServer.java
public final class SystemServer implements Dumpable {
    private void startCoreServices(@NonNull TimingsTraceAndSlog t) {
        // Tracks application usage stats.
        t.traceBegin("StartUsageService");
        mSystemServiceManager.startService(UsageStatsService.class);
        mActivityManagerService.setUsageStatsManager(
                LocalServices.getService(UsageStatsManagerInternal.class));
        t.traceEnd();
    }   
} </code></pre> 
<h3 id="1.1%20AMS.setUsageStatsManager()%C2%A0">1.1 AMS.setUsageStatsManager() </h3> 
<pre><code class="language-java">// /frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java
public class ActivityManagerService extends IActivityManager.Stub
        implements Watchdog.Monitor, BatteryStatsImpl.BatteryCallback, ActivityManagerGlobalLock {   
    public void setUsageStatsManager(@NonNull UsageStatsManagerInternal usageStatsManager)             {
        mUsageStatsService = usageStatsManager;
        mActivityTaskManager.setUsageStatsManager(usageStatsManager);
    }
}</code></pre> 
<h3 id="%C2%A01.2%20ATMS.setUsageStatsManager()%C2%A0">1.2 ATMS.setUsageStatsManager() </h3> 
<pre><code class="language-java">// /frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java
public class ActivityTaskManagerService extends IActivityTaskManager.Stub {
    public void setUsageStatsManager(UsageStatsManagerInternal usageStatsManager) {
        synchronized (mGlobalLock) {
            mUsageStatsInternal = usageStatsManager;
        }
    }
}</code></pre> 
<h3 id="%C2%A01.3%20UsageStatsManagerInternal%C2%A0">1.3 UsageStatsManagerInternal </h3> 
<p>它是UsageStatsService的本地系统服务接口，源码参考地址：<a href="http://aospxref.com/android-12.0.0_r3/xref/frameworks/base/services/core/java/android/app/usage/UsageStatsManagerInternal.java?fi=UsageStatsManagerInternal#UsageStatsManagerInternal" rel="nofollow" title="UsageStatsManagerInternal.java - OpenGrok cross reference for /frameworks/base/services/core/java/android/app/usage/UsageStatsManagerInternal.java">UsageStatsManagerInternal.java - OpenGrok cross reference for /frameworks/base/services/core/java/android/app/usage/UsageStatsManagerInternal.java</a></p> 
<pre><code class="language-java">// /frameworks/base/services/core/java/android/app/usage/UsageStatsManagerInternal.java
public abstract class UsageStatsManagerInternal {
    public abstract void reportEvent(ComponentName component, @UserIdInt int userId, int eventType,
            int instanceId, ComponentName taskRoot);
    public abstract void reportEvent(String packageName, @UserIdInt int userId, int eventType);
    public abstract void reportConfigurationChange(Configuration config, @UserIdInt int userId);
    public abstract void reportContentProviderUsage(String name, String pkgName,
            @UserIdInt int userId);
    public abstract void reportLocusUpdate(@NonNull ComponentName activity, @UserIdInt int userId,
            @Nullable LocusId locusId, @NonNull IBinder appToken);
    /**
     * Prepares the UsageStatsService for shutdown.
     */
    public abstract void prepareShutdown();
    /**
     * When the device power button is long pressed for 3.5 seconds, prepareForPossibleShutdown()
     * is called.
     */
    public abstract void prepareForPossibleShutdown();
    public abstract List&lt;UsageStats&gt; queryUsageStatsForUser(@UserIdInt int userId, int interval,
            long beginTime, long endTime, boolean obfuscateInstantApps);
    public abstract void reportAppJobState(String packageName, @UserIdInt int userId,
            int numDeferredJobs, long timeSinceLastJobRun);
    public abstract void reportSyncScheduled(String packageName, @UserIdInt int userId,
                                             boolean exempted);
    public abstract AppUsageLimitData getAppUsageLimit(String packageName, UserHandle user);
    public interface UsageEventListener {
        /** Callback to inform listeners of a new usage event. */
        void onUsageEvent(@UserIdInt int userId, @NonNull UsageEvents.Event event);
    }
    public abstract void registerListener(@NonNull UsageEventListener listener);
    public abstract void unregisterListener(@NonNull UsageEventListener listener);
}
</code></pre> 
<p>该本地服务是SSM.startService()时在UsageStatsService.onStart()中注册到LocalServices中的。</p> 
<h3 id="1.4%C2%A0UsageStatsService">1.4 UsageStatsService</h3> 
<p>该系统服务主要负责收集、聚合和持久化application使用数据。这些数据可以被AppOps授权的应用查询。它的持久化数据保存路径为data/system/usagestats。</p> 
<h4 id="1.4.1%C2%A0UsageStatsService.onStart()">1.4.1 UsageStatsService.onStart()</h4> 
<ul><li> 把UsageStatsManagerInternal服务和对应的实例注册LocalServices中；</li><li>把BinderServce以name=usagestats注册到servicemanager中。</li></ul> 
<pre><code class="language-java">// /frameworks/base/services/usage/java/com/android/server/usage/UsageStatsService.java
public class UsageStatsService extends SystemService implements
        UserUsageStatsService.StatsUpdatedListener {
    public UsageStatsService(Context context) {
        this(context, new Injector());
    }
    @Override
    public void onStart() {
        mAppOps = (AppOpsManager) getContext().getSystemService(Context.APP_OPS_SERVICE);
        mUserManager = (UserManager) getContext().getSystemService(Context.USER_SERVICE);
        mPackageManager = getContext().getPackageManager();
        mPackageManagerInternal = LocalServices.getService(PackageManagerInternal.class);
        mHandler = new H(BackgroundThread.get().getLooper());
        ...
        //把UsageStasManagerInternal服务注册到LocalServices中
        publishLocalService(UsageStatsManagerInternal.class, new LocalService());
        publishLocalService(AppStandbyInternal.class, mAppStandby);
        //把UsageStatsService以name=usagestats注册到servicemanager中
        publishBinderServices();
    }

    void publishBinderServices() {
        publishBinderService(Context.USAGE_STATS_SERVICE, new BinderService());
    }
}</code></pre> 
<h4 id="1.4.2%C2%A0UsageStatsService%E7%9A%84%E5%86%85%E9%83%A8%E7%B1%BBBinderService">1.4.2 UsageStatsService的内部类BinderService</h4> 
<pre><code class="language-java">// /frameworks/base/services/usage/java/com/android/server/usage/UsageStatsService.java
public class UsageStatsService extends SystemService implements
        UserUsageStatsService.StatsUpdatedListener {
    @Override
    public void onStart() {
       ...
        //把UsageStatsService以name=usagestats注册到servicemanager中
        publishBinderServices();
    }

    void publishBinderServices() {
        publishBinderService(Context.USAGE_STATS_SERVICE, new BinderService());
    }
    //由于UsageStatsService继承了SystemService, 所以内部类BinderService extends
    //IUsageStatsManager.Stub, 作为服务端，这样同样实现了使用AIDL与其他app交互。
    private final class BinderService extends IUsageStatsManager.Stub {
         private boolean hasPermissions(String callingPackage, String... permissions) {
            final int callingUid = Binder.getCallingUid();
            if (callingUid == Process.SYSTEM_UID) {
                // Caller is the system, so proceed.
                return true;
            }

            boolean hasPermissions = true;
            final Context context = getContext();
            for (int i = 0; i &lt; permissions.length; i++) {
                hasPermissions = hasPermissions &amp;&amp; (context.checkCallingPermission(permissions[i])
                        == PackageManager.PERMISSION_GRANTED);
            }
            return hasPermissions;
        }

        @Override
        public ParceledListSlice&lt;UsageStats&gt; queryUsageStats(int bucketType, long beginTime,
                long endTime, String callingPackage, int userId) {
            if (!hasPermission(callingPackage)) {
                return null;
            }    
            ...
        }
    }    
}</code></pre> 
<h4 id="1.4.3%C2%A0UsageStatsService%E7%9A%84%E5%86%85%E9%83%A8%E7%B1%BBLocalServicce%C2%A0">1.4.3 UsageStatsService的内部类LocalServicce </h4> 
<p>该LocalServicce继承了UsageStatsManagerInternal,该本地服务主要供AMS使用。AMS会持有am锁来调用LocalService中的方法，所以在这些方法中不应有IO操作或者其他耗时任务。</p> 
<pre><code class="language-java">// /frameworks/base/services/usage/java/com/android/server/usage/UsageStatsService.java
public class UsageStatsService extends SystemService implements
        UserUsageStatsService.StatsUpdatedListener {
    @Override
    public void onStart() {
        ...
        //把UsageStasManagerInternal服务注册到LocalServices中
        publishLocalService(UsageStatsManagerInternal.class, new LocalService());
    }
    //该LocalServicce继承了UsageStatsManagerInternal,该本地服务主要供AMS使用,
    //AMS会持有am锁来调用LocalService中的方法,所以在这些方法中不应有IO操作或者其他耗时任务
    private final class LocalService extends UsageStatsManagerInternal {
        @Override
        public void reportEvent(ComponentName component, int userId, int eventType,
                int instanceId, ComponentName taskRoot) {
            if (component == null) {
                Slog.w(TAG, "Event reported without a component name");
                return;
            }

            Event event = new Event(eventType, SystemClock.elapsedRealtime());
            event.mPackage = component.getPackageName();
            event.mClass = component.getClassName();
            event.mInstanceId = instanceId;
            if (taskRoot == null) {
                event.mTaskRootPackage = null;
                event.mTaskRootClass = null;
            } else {
                event.mTaskRootPackage = taskRoot.getPackageName();
                event.mTaskRootClass = taskRoot.getClassName();
            }
            reportEventOrAddToQueue(userId, event);
        }

        @Override
        public void reportEvent(String packageName, int userId, int eventType) {
            if (packageName == null) {
                Slog.w(TAG, "Event reported without a package name, eventType:" + eventType);
                return;
            }

            Event event = new Event(eventType, SystemClock.elapsedRealtime());
            event.mPackage = packageName;
            reportEventOrAddToQueue(userId, event);
        }
        ...
    }
}</code></pre> 
<hr> 
<h2 id="2.%20%E5%88%9B%E5%BB%BA%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%AD%A5%E9%AA%A4">2. 创建系统服务的步骤</h2> 
<p>UsageStatsService的代码让我发现创建系统服务的另一种形式，创建需要和application等其他进程通过AIDL通信的步骤：</p> 
<p><strong>(1). 创建新的系统服务类直接继承SystemService，重写onStart()。</strong></p> 
<p><strong>(2). 创建内部类，继承ICustomizeManager.stub</strong></p> 
<p><strong>(3). 在onStart()中调用publishBinderService(String name, IBinder service)注册到servicemanager中。</strong>      </p> 
<pre><code class="language-java">//第一步
public CustomizeSystemService extends SystemService {
    @Override
    public void onStart() {
        //第三步：把CustomizeBinderService注册到servicemanager中
        publishBinderService(Context.CUSTOMIZE_SERVICE, new CustomizeBinderService());        
    }
    //第二步
    private final class CustomizeBinderService extends ICustomizeManager.Stub {
        //重写AIDL文件中的方法
    }
}</code></pre> 
<p>使用最多的形式参考 请参考<a href="https://blog.csdn.net/lvyaer_1122/article/details/130139795" title="Framework层添加SystemService和Manager的超详细步骤">Framework层添加SystemService和Manager的超详细步骤</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/398dcbbee310ab38b9603953bf080f2d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">FFmpeg 解码 H264 格式的视频</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/841281b153dd6db84f1183e887095338/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">GraphHopper调研笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>