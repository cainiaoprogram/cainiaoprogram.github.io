<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mmdetection中faster_rcnn的实现 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mmdetection中faster_rcnn的实现" />
<meta property="og:description" content="mmdetection中faster_rcnn的实现 前置内容：
mmdetecion 中类注册的实现（@x.register_module()）
内容包括：
faster_rcnn
backbone
neck
rpn_head
faster_rcnn @DETECTORS.register_module() class FasterRCNN(TwoStageDetector): 在代码中，fasterRCNN继承了TwoStageDetector，TwoStageDetector继承了BaseDetector，在BaseDetector中实现了forward，其中判断训练和test调用了forward_train和forward_test，我们关注的也就是forward_train()
faster_rcnn依次调用了backbone，neck，rpn，roi，之后计算loss
def forward_train(self, img, img_metas, gt_bboxes, gt_labels, gt_bboxes_ignore=None, gt_masks=None, proposals=None, **kwargs): x = self.extract_feat(img) # 特征提取&#43;fpn losses = dict() # RPN 过程 if self.with_rpn: proposal_cfg = self.train_cfg.get(&#39;rpn_proposal&#39;, self.test_cfg.rpn) rpn_losses, proposal_list = self.rpn_head.forward_train( x, img_metas, gt_bboxes, gt_labels=None, gt_bboxes_ignore=gt_bboxes_ignore, proposal_cfg=proposal_cfg, **kwargs) losses.update(rpn_losses) else: proposal_list = proposals #roi过程 roi_losses = self.roi_head.forward_train(x, img_metas, proposal_list, gt_bboxes, gt_labels, gt_bboxes_ignore, gt_masks, **kwargs) losses." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/9aebb9c5f6283b50ef98e69403ca7550/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-06T23:04:09+08:00" />
<meta property="article:modified_time" content="2022-03-06T23:04:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mmdetection中faster_rcnn的实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="mmdetectionfaster_rcnn_0"></a>mmdetection中faster_rcnn的实现</h2> 
<p>前置内容：<br> <a href="https://blog.csdn.net/qq_39518314/article/details/123053614">mmdetecion 中类注册的实现（@x.register_module()）</a></p> 
<p>内容包括：<br> faster_rcnn<br> backbone<br> neck<br> rpn_head</p> 
<h3><a id="faster_rcnn_12"></a>faster_rcnn</h3> 
<pre><code class="prism language-python">@DETECTORS<span class="token punctuation">.</span>register_module<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">FasterRCNN</span><span class="token punctuation">(</span>TwoStageDetector<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre> 
<p>在代码中，fasterRCNN继承了TwoStageDetector，TwoStageDetector继承了BaseDetector，在BaseDetector中实现了forward，其中判断训练和test调用了forward_train和forward_test，我们关注的也就是forward_train()<br> faster_rcnn依次调用了backbone，neck，rpn，roi，之后计算loss</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">forward_train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                      img<span class="token punctuation">,</span>
                      img_metas<span class="token punctuation">,</span>
                      gt_bboxes<span class="token punctuation">,</span>
                      gt_labels<span class="token punctuation">,</span>
                      gt_bboxes_ignore<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                      gt_masks<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                      proposals<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                      <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>extract_feat<span class="token punctuation">(</span>img<span class="token punctuation">)</span>  <span class="token comment"># 特征提取+fpn</span>

        losses <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># RPN 过程</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>with_rpn<span class="token punctuation">:</span>
            proposal_cfg <span class="token operator">=</span> self<span class="token punctuation">.</span>train_cfg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'rpn_proposal'</span><span class="token punctuation">,</span>
                                              self<span class="token punctuation">.</span>test_cfg<span class="token punctuation">.</span>rpn<span class="token punctuation">)</span>
            rpn_losses<span class="token punctuation">,</span> proposal_list <span class="token operator">=</span> self<span class="token punctuation">.</span>rpn_head<span class="token punctuation">.</span>forward_train<span class="token punctuation">(</span>
                x<span class="token punctuation">,</span>
                img_metas<span class="token punctuation">,</span>
                gt_bboxes<span class="token punctuation">,</span>
                gt_labels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                gt_bboxes_ignore<span class="token operator">=</span>gt_bboxes_ignore<span class="token punctuation">,</span>
                proposal_cfg<span class="token operator">=</span>proposal_cfg<span class="token punctuation">,</span>
                <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
            losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>rpn_losses<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            proposal_list <span class="token operator">=</span> proposals
		<span class="token comment">#roi过程</span>
        roi_losses <span class="token operator">=</span> self<span class="token punctuation">.</span>roi_head<span class="token punctuation">.</span>forward_train<span class="token punctuation">(</span>x<span class="token punctuation">,</span> img_metas<span class="token punctuation">,</span> proposal_list<span class="token punctuation">,</span>
                                                 gt_bboxes<span class="token punctuation">,</span> gt_labels<span class="token punctuation">,</span>
                                                 gt_bboxes_ignore<span class="token punctuation">,</span> gt_masks<span class="token punctuation">,</span>
                                                 <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>roi_losses<span class="token punctuation">)</span>

        <span class="token keyword">return</span> losses
</code></pre> 
<h3><a id="backbone_61"></a>backbone</h3> 
<p>backbone的调用在</p> 
<pre><code class="prism language-python"> x <span class="token operator">=</span> self<span class="token punctuation">.</span>extract_feat<span class="token punctuation">(</span>img<span class="token punctuation">)</span>  <span class="token comment"># 特征提取+fpn</span>
</code></pre> 
<p>在传入backbone后直接传入neck（如果有）</p> 
<pre><code class="prism language-python"> <span class="token keyword">def</span> <span class="token function">extract_feat</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Directly extract features from the backbone+neck."""</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>with_neck<span class="token punctuation">:</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>neck<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x
</code></pre> 
<p>我们使用的backbone配置文件为：</p> 
<pre><code class="prism language-python">backbone<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'ResNet'</span><span class="token punctuation">,</span>
        depth<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token comment"># 使用res50</span>
        num_stages<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">#4层</span>
        out_indices<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">#输出前4层的特征，也就是C2,C3,C4,C5</span>
        frozen_stages<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment"># 冻结的stage数量，即该stage不更新参数，-1表示所有的stage都更新参数</span>
        norm_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'BN'</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">#使用bach_norm</span>
        norm_eval<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token comment">#在test时候使用norm</span>
        style<span class="token operator">=</span><span class="token string">'pytorch'</span><span class="token punctuation">,</span>
        init_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Pretrained'</span><span class="token punctuation">,</span> checkpoint<span class="token operator">=</span><span class="token string">'torchvision://resnet50'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> 
<p>配置文件到类的转换可以查看[mmdetecion 中类注册的实现（@x.register_module()）]<img src="https://images2.imgbox.com/d9/b0/MHc6a7Lk_o.png" alt="(https://blog.csdn.net/qq_39518314/article/details/123053614)在这里插入图片描述"></p> 
<p>由out_indices=4可以获得我们输出的层数为4，如果batch_size为16，图像大小为800*800，那么最终输出的4个特征分别为：<br> （16，256，200，200）（16，512，100，100）（16，1024，50，50）（16，2048，25，25）</p> 
<h3><a id="neck_95"></a>neck</h3> 
<p>neck之所以叫neck，他是用于处理特征提取和head之间的内容<br> 以fpn为例：</p> 
<pre><code class="prism language-python">neck<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'FPN'</span><span class="token punctuation">,</span>
        in_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
        num_outs<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> 
<p>in_channels表示输入的4层，通道数分别为256, 512, 1024, 2048，对应我们上面res50的输出层数和通道数<br> 具体的处理如下图：<br> <img src="https://images2.imgbox.com/33/92/l75i6LCw_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Forward function."""</span>
        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>in_channels<span class="token punctuation">)</span>

        <span class="token comment"># 使用1x1卷积的部分</span>
        laterals <span class="token operator">=</span> <span class="token punctuation">[</span>
            lateral_conv<span class="token punctuation">(</span>inputs<span class="token punctuation">[</span>i <span class="token operator">+</span> self<span class="token punctuation">.</span>start_level<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> lateral_conv <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>lateral_convs<span class="token punctuation">)</span>
        <span class="token punctuation">]</span>

        <span class="token comment"># 经过最近线性插值之后加上，得到m</span>
        used_backbone_levels <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>laterals<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>used_backbone_levels <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># In some cases, fixing `scale factor` (e.g. 2) is preferred, but</span>
            <span class="token comment">#  it cannot co-exist with `size` in `F.interpolate`.</span>
            <span class="token keyword">if</span> <span class="token string">'scale_factor'</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>upsample_cfg<span class="token punctuation">:</span>
                laterals<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>laterals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                                 <span class="token operator">**</span>self<span class="token punctuation">.</span>upsample_cfg<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                prev_shape <span class="token operator">=</span> laterals<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
                laterals<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>
                    laterals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> size<span class="token operator">=</span>prev_shape<span class="token punctuation">,</span> <span class="token operator">**</span>self<span class="token punctuation">.</span>upsample_cfg<span class="token punctuation">)</span>

        <span class="token comment"># build outputs</span>
        <span class="token comment"># part 1: from original levels</span>
        <span class="token comment"># 原来部分的输出</span>
        outs <span class="token operator">=</span> <span class="token punctuation">[</span>
            self<span class="token punctuation">.</span>fpn_convs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>laterals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>used_backbone_levels<span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
        <span class="token comment"># part 2: add extra levels</span>
        <span class="token comment">#补充输出，也就是图上的P6</span>
        <span class="token comment">#在配置中，我们的in_chennel是4，那么就有4个原始的输出，但是我们设置的out_num=5，这多余的部分全部使用补充输出</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>num_outs <span class="token operator">&gt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>outs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># use max pool to get more levels on top of outputs</span>
            <span class="token comment"># (e.g., Faster R-CNN, Mask R-CNN)</span>
            <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>add_extra_convs<span class="token punctuation">:</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_outs <span class="token operator">-</span> used_backbone_levels<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    outs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>F<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>outs<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># add conv layers on top of original feature maps (RetinaNet)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>add_extra_convs <span class="token operator">==</span> <span class="token string">'on_input'</span><span class="token punctuation">:</span>
                    extra_source <span class="token operator">=</span> inputs<span class="token punctuation">[</span>self<span class="token punctuation">.</span>backbone_end_level <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
                <span class="token keyword">elif</span> self<span class="token punctuation">.</span>add_extra_convs <span class="token operator">==</span> <span class="token string">'on_lateral'</span><span class="token punctuation">:</span>
                    extra_source <span class="token operator">=</span> laterals<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
                <span class="token keyword">elif</span> self<span class="token punctuation">.</span>add_extra_convs <span class="token operator">==</span> <span class="token string">'on_output'</span><span class="token punctuation">:</span>
                    extra_source <span class="token operator">=</span> outs<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> NotImplementedError
                outs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fpn_convs<span class="token punctuation">[</span>used_backbone_levels<span class="token punctuation">]</span><span class="token punctuation">(</span>extra_source<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>used_backbone_levels <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_outs<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> self<span class="token punctuation">.</span>relu_before_extra_convs<span class="token punctuation">:</span>
                        outs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fpn_convs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>outs<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        outs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fpn_convs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>outs<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>outs<span class="token punctuation">)</span>

</code></pre> 
<h3><a id="rpn_head_168"></a>rpn_head</h3> 
<p>在mmdetecion中rpn_head写得相当恼火，由于三重继承的关系，子类里又常常重写父类方法，使用配置文件又使得按住ctrl追踪不了，看代码相当折磨<br> RPNHead继承AnchorHead继承BaseDenseHead<br> 整个实现在这三个文件中交错分布，看代码的时候需要来回寻找，并且时刻关注子类中是不是重写了方法<br> rpn_head中执行的是forward_train，其中进行了前向传播之后计算了loss<br> 代码如下：</p> 
<pre><code class="prism language-python"><span class="token comment">#前向传播</span>
outs <span class="token operator">=</span> self<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token keyword">if</span> gt_labels <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
     loss_inputs <span class="token operator">=</span> outs <span class="token operator">+</span> <span class="token punctuation">(</span>gt_bboxes<span class="token punctuation">,</span> img_metas<span class="token punctuation">)</span>
 <span class="token keyword">else</span><span class="token punctuation">:</span>
     loss_inputs <span class="token operator">=</span> outs <span class="token operator">+</span> <span class="token punctuation">(</span>gt_bboxes<span class="token punctuation">,</span> gt_labels<span class="token punctuation">,</span> img_metas<span class="token punctuation">)</span>
 <span class="token comment">#获取loss</span>
 losses <span class="token operator">=</span> self<span class="token punctuation">.</span>loss<span class="token punctuation">(</span><span class="token operator">*</span>loss_inputs<span class="token punctuation">,</span> gt_bboxes_ignore<span class="token operator">=</span>gt_bboxes_ignore<span class="token punctuation">)</span>
 <span class="token keyword">if</span> proposal_cfg <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
     <span class="token keyword">return</span> losses
 <span class="token keyword">else</span><span class="token punctuation">:</span>
     proposal_list <span class="token operator">=</span> self<span class="token punctuation">.</span>get_bboxes<span class="token punctuation">(</span>
         <span class="token operator">*</span>outs<span class="token punctuation">,</span> img_metas<span class="token operator">=</span>img_metas<span class="token punctuation">,</span> cfg<span class="token operator">=</span>proposal_cfg<span class="token punctuation">)</span>
     <span class="token comment">#返回loss和推荐列表</span>
     <span class="token keyword">return</span> losses<span class="token punctuation">,</span> proposal_list
</code></pre> 
<h4><a id="rpn_191"></a>rpn的前向传播：</h4> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">forward_single</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Forward feature map of a single scale level."""</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>rpn_conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        rpn_cls_score <span class="token operator">=</span> self<span class="token punctuation">.</span>rpn_cls<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        rpn_bbox_pred <span class="token operator">=</span> self<span class="token punctuation">.</span>rpn_reg<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> rpn_cls_score<span class="token punctuation">,</span> rpn_bbox_pred
</code></pre> 
<p>一个3x3的卷积，之后接着两个1x1的卷积<br> <img src="https://images2.imgbox.com/d6/f7/ECjxmnQT_o.png" alt="在这里插入图片描述"><br> 卷积的channel在配置文件中有定义</p> 
<pre><code class="prism language-python">rpn_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RPNHead'</span><span class="token punctuation">,</span>
        <span class="token comment">#输入卷积的通道</span>
        in_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
        <span class="token comment">#3x3卷积的输出通道</span>
        feat_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
</code></pre> 
<p>那么最终1x1卷积的输出通道是多少？<br> 我们可以在代码中找到：</p> 
<pre><code class="prism language-python">self<span class="token punctuation">.</span>rpn_cls <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>self<span class="token punctuation">.</span>feat_channels<span class="token punctuation">,</span>
                        self<span class="token punctuation">.</span>num_base_priors <span class="token operator">*</span> self<span class="token punctuation">.</span>cls_out_channels<span class="token punctuation">,</span>
                                 <span class="token number">1</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>rpn_reg <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>self<span class="token punctuation">.</span>feat_channels<span class="token punctuation">,</span> 
						self<span class="token punctuation">.</span>num_base_priors <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span>
                                 <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p>num_base_priors = num(anchor_scales)*num(anchor_ratios)<br> 我们的anchor_scale为[8]，num(anchor_scale)=1，anchor_ratios我们使用三种比例，最终的num_base_priors = 3<br> cls_out_channels：分类的种类</p> 
<h4><a id="anchor_227"></a>anchor</h4> 
<p>接下来是anchor的表演时间了<br> anchor_generator的配置文件如下：</p> 
<pre><code class="prism language-python">anchor_generator<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'AnchorGenerator'</span><span class="token punctuation">,</span>
            scales<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            ratios<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

</code></pre> 
<p>strides就是传来的P2,P3,P4,P5,P6的感受野，也就是每一层特征图上的一个像素点对应原图上的像素个数，如果anchor的长宽没有定义，这个值也代表anchor的基础长宽，ratios表示是anchor的3种比例，scales对应anchor的长宽放大倍数</p> 
<p>在rpn_body执行结束之后，进入loss中</p> 
<pre><code class="prism language-python">anchor_list<span class="token punctuation">,</span> valid_flag_list <span class="token operator">=</span> self<span class="token punctuation">.</span>get_anchors<span class="token punctuation">(</span>
            featmap_sizes<span class="token punctuation">,</span> img_metas<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span> 
</code></pre> 
<p>首先获得所有的anchor，例如P2生成的anchor为（200<em>200</em>3，4），vaild表示这个anchor是否有效，超出图像范围即为无效</p> 
<pre><code class="prism language-python">cls_reg_targets <span class="token operator">=</span> self<span class="token punctuation">.</span>get_targets<span class="token punctuation">(</span>
            anchor_list<span class="token punctuation">,</span>
            valid_flag_list<span class="token punctuation">,</span>
            gt_bboxes<span class="token punctuation">,</span>
            img_metas<span class="token punctuation">,</span>
            gt_bboxes_ignore_list<span class="token operator">=</span>gt_bboxes_ignore<span class="token punctuation">,</span>
            gt_labels_list<span class="token operator">=</span>gt_labels<span class="token punctuation">,</span>
            label_channels<span class="token operator">=</span>label_channels<span class="token punctuation">)</span>
</code></pre> 
<p>将所有的anchor和ground_truth进行匹配<br> loss计算完成之后，获取bbox，得到rpn_proposal，配置文件为：</p> 
<pre><code class="prism language-python">rpn_proposal<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
			<span class="token comment">#每一层都取2000个proposol</span>
            nms_pre<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span>
            <span class="token comment"># 每张图最终的数量</span>
            max_per_img<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
            <span class="token comment">#使用的nms</span>
            nms<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'nms'</span><span class="token punctuation">,</span> iou_threshold<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            min_bbox_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> 
<p>代码解析：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">_get_bboxes_single</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                           cls_score_list<span class="token punctuation">,</span>
                           bbox_pred_list<span class="token punctuation">,</span>
                           score_factor_list<span class="token punctuation">,</span>
                           mlvl_anchors<span class="token punctuation">,</span>
                           img_meta<span class="token punctuation">,</span>
                           cfg<span class="token punctuation">,</span>
                           rescale<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                           with_nms<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                           <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>

        cfg <span class="token operator">=</span> self<span class="token punctuation">.</span>test_cfg <span class="token keyword">if</span> cfg <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> cfg
        cfg <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
        img_shape <span class="token operator">=</span> img_meta<span class="token punctuation">[</span><span class="token string">'img_shape'</span><span class="token punctuation">]</span>

 <span class="token comment">#不同层的bbox在nms的时候应该是区分开的</span>
        level_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        mlvl_scores <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        mlvl_bbox_preds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        mlvl_valid_anchors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        nms_pre <span class="token operator">=</span> cfg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'nms_pre'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment">#分别处理P2-P6层</span>
        <span class="token keyword">for</span> level_idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>cls_score_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            rpn_cls_score <span class="token operator">=</span> cls_score_list<span class="token punctuation">[</span>level_idx<span class="token punctuation">]</span>
            rpn_bbox_pred <span class="token operator">=</span> bbox_pred_list<span class="token punctuation">[</span>level_idx<span class="token punctuation">]</span>
            <span class="token keyword">assert</span> rpn_cls_score<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">==</span> rpn_bbox_pred<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            rpn_cls_score <span class="token operator">=</span> rpn_cls_score<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>use_sigmoid_cls<span class="token punctuation">:</span>
                rpn_cls_score <span class="token operator">=</span> rpn_cls_score<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                scores <span class="token operator">=</span> rpn_cls_score<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                rpn_cls_score <span class="token operator">=</span> rpn_cls_score<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
                scores <span class="token operator">=</span> rpn_cls_score<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
            rpn_bbox_pred <span class="token operator">=</span> rpn_bbox_pred<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

            anchors <span class="token operator">=</span> mlvl_anchors<span class="token punctuation">[</span>level_idx<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">&lt;</span> nms_pre <span class="token operator">&lt;</span> scores<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            	<span class="token comment">#将proposal按照分数排列</span>
                ranked_scores<span class="token punctuation">,</span> rank_inds <span class="token operator">=</span> scores<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>descending<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
                <span class="token comment">#提取出前{nms_pre}个proposal</span>
                topk_inds <span class="token operator">=</span> rank_inds<span class="token punctuation">[</span><span class="token punctuation">:</span>nms_pre<span class="token punctuation">]</span>
                scores <span class="token operator">=</span> ranked_scores<span class="token punctuation">[</span><span class="token punctuation">:</span>nms_pre<span class="token punctuation">]</span>
                rpn_bbox_pred <span class="token operator">=</span> rpn_bbox_pred<span class="token punctuation">[</span>topk_inds<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
                anchors <span class="token operator">=</span> anchors<span class="token punctuation">[</span>topk_inds<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>

            mlvl_scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>scores<span class="token punctuation">)</span>
            mlvl_bbox_preds<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rpn_bbox_pred<span class="token punctuation">)</span>
            mlvl_valid_anchors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anchors<span class="token punctuation">)</span>
            level_ids<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                scores<span class="token punctuation">.</span>new_full<span class="token punctuation">(</span><span class="token punctuation">(</span>scores<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
                                level_idx<span class="token punctuation">,</span>
                                dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token comment">#将所有的bbox缩放到图像大小，之后一起做nms，返回{max_per_img}个proposal</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_bbox_post_process<span class="token punctuation">(</span>mlvl_scores<span class="token punctuation">,</span> mlvl_bbox_preds<span class="token punctuation">,</span>
                                       mlvl_valid_anchors<span class="token punctuation">,</span> level_ids<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span>
                                       img_shape<span class="token punctuation">)</span>

</code></pre> 
<p>至此rpn结束</p> 
<h3><a id="roi_head_331"></a>roi_head</h3> 
<p>roi head 包含几步：<br> 1.对之前的proposal进行assigner操作和sample操作</p> 
<h4><a id="bbox_assigner_334"></a>bbox assigner</h4> 
<p>bbox assigner是Head模块中重要的组件，负责对bbox（为anchor或者为proposal）进行正负样本分配策略，即确定哪个bbox为正样本，哪个bbox为负样本。</p> 
<pre><code class="prism language-python">assigner<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
     <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'MaxIoUAssigner'</span><span class="token punctuation">,</span>
     <span class="token comment">#与所有gt最大的iou&gt;pos_iou_thr的是正样本</span>
     pos_iou_thr<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
     <span class="token comment">#与所有gt最大的iou&lt;neg_iou_thr的是负样本</span>
     neg_iou_thr<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
     min_pos_iou<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
     match_low_quality<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
     ignore_iof_thr<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 sampler<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
     <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RandomSampler'</span><span class="token punctuation">,</span>
     num<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
     <span class="token comment">#正样本比例，不足用负样本补齐</span>
     pos_fraction<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
     neg_pos_ub<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
     <span class="token comment">#添加gt到proposal与否</span>
     add_gt_as_proposals<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> 
<p>我们使用MaxIoUAssigner分类器，它是一个可以给gt分配多个bbox的分类器<br> MaxIoUAssigner一共有以下6个步骤：</p> 
<ol><li>计算所有bbox与所有gt的iou。</li><li>计算所有bbox与所有gt_ignore的iof，若某个bbox与所有gt_ignore的iof大于ignore_iof_thr ，则把该bbox与所有gt的iou都设为-1。</li><li>初始化，把所有bbox设置为ignore忽略样本，assigned_gt_inds赋值为-1。</li><li>获得每个bbox的最近的gt（即argmax gt），若某个bbox与最近的gt的iou（即max iou）都小于neg_iou_thr，那么设置为负样本，assigned_gt_inds赋值为0。</li><li>若某个bbox与最近的gt的iou（即max iou）大于pos_iou_thr，那么设置为正样本，assigned_gt_inds赋值为该bbox最近的gt（argmax gt）的下标+1，（范围为1~len(gts)）。</li><li>（可选步骤，match_low_quality为True），为什么要这步操作呢？因为可能存在某些gt没有被正样本匹配到，这时我们放宽限制。先对每个gt获得最近的bbox，若某个gt与最近bbox的iou大于min_pos_iou，那么该最近bbox（即argmax bbox）设置为gt的下标+1。若与该gt最近的bbox有多个时，我们可以根据gt_max_assign_all确定是否对所有最近bbox还是某个最近bbox赋值。</li></ol> 
<p>代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">assign</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> bboxes<span class="token punctuation">,</span> gt_bboxes<span class="token punctuation">,</span> gt_bboxes_ignore<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> gt_labels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment">#gt太大的时候，放在cpu中计算，节约现存</span>
    assign_on_cpu <span class="token operator">=</span> <span class="token boolean">True</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>gpu_assign_thr <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token punctuation">(</span>
        gt_bboxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>gpu_assign_thr<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">False</span>
    <span class="token keyword">if</span> assign_on_cpu<span class="token punctuation">:</span>
        device <span class="token operator">=</span> bboxes<span class="token punctuation">.</span>device
        bboxes <span class="token operator">=</span> bboxes<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>
        gt_bboxes <span class="token operator">=</span> gt_bboxes<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> gt_bboxes_ignore <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            gt_bboxes_ignore <span class="token operator">=</span> gt_bboxes_ignore<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> gt_labels <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            gt_labels <span class="token operator">=</span> gt_labels<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">#1.计算所有bbox与所有gt的iou</span>
    overlaps <span class="token operator">=</span> self<span class="token punctuation">.</span>iou_calculator<span class="token punctuation">(</span>gt_bboxes<span class="token punctuation">,</span> bboxes<span class="token punctuation">)</span>
	<span class="token comment">#2.计算所有bbox与所有gt_ignore的iof，将所有符合条件的bbox与所有gt的iou设为-1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>ignore_iof_thr <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">and</span> gt_bboxes_ignore <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span>
            <span class="token operator">and</span> gt_bboxes_ignore<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">and</span> bboxes<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#判断前后景是谁</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>ignore_wrt_candidates<span class="token punctuation">:</span>
            ignore_overlaps <span class="token operator">=</span> self<span class="token punctuation">.</span>iou_calculator<span class="token punctuation">(</span>
                bboxes<span class="token punctuation">,</span> gt_bboxes_ignore<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'iof'</span><span class="token punctuation">)</span>
            ignore_max_overlaps<span class="token punctuation">,</span> _ <span class="token operator">=</span> ignore_overlaps<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            ignore_overlaps <span class="token operator">=</span> self<span class="token punctuation">.</span>iou_calculator<span class="token punctuation">(</span>
                gt_bboxes_ignore<span class="token punctuation">,</span> bboxes<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'iof'</span><span class="token punctuation">)</span>
            ignore_max_overlaps<span class="token punctuation">,</span> _ <span class="token operator">=</span> ignore_overlaps<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        overlaps<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> ignore_max_overlaps <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>ignore_iof_thr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token comment">#剩下的几步</span>
    assign_result <span class="token operator">=</span> self<span class="token punctuation">.</span>assign_wrt_overlaps<span class="token punctuation">(</span>overlaps<span class="token punctuation">,</span> gt_labels<span class="token punctuation">)</span>
    <span class="token comment">#转移回cpu</span>
    <span class="token keyword">if</span> assign_on_cpu<span class="token punctuation">:</span>
        assign_result<span class="token punctuation">.</span>gt_inds <span class="token operator">=</span> assign_result<span class="token punctuation">.</span>gt_inds<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        assign_result<span class="token punctuation">.</span>max_overlaps <span class="token operator">=</span> assign_result<span class="token punctuation">.</span>max_overlaps<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        <span class="token keyword">if</span> assign_result<span class="token punctuation">.</span>labels <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            assign_result<span class="token punctuation">.</span>labels <span class="token operator">=</span> assign_result<span class="token punctuation">.</span>labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    <span class="token keyword">return</span> assign_result

<span class="token keyword">def</span> <span class="token function">assign_wrt_overlaps</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> overlaps<span class="token punctuation">,</span> gt_labels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    num_gts<span class="token punctuation">,</span> num_bboxes <span class="token operator">=</span> overlaps<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> overlaps<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># 3. 把所有bbox设置为ignore忽略样本（-1）</span>
    assigned_gt_inds <span class="token operator">=</span> overlaps<span class="token punctuation">.</span>new_full<span class="token punctuation">(</span><span class="token punctuation">(</span>num_bboxes<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
                                         <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                                         dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> num_gts <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">or</span> num_bboxes <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token comment"># No ground truth or boxes, return empty assignment</span>
        max_overlaps <span class="token operator">=</span> overlaps<span class="token punctuation">.</span>new_zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>num_bboxes<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> num_gts <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment"># No truth, assign everything to background</span>
            assigned_gt_inds<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">if</span> gt_labels <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            assigned_labels <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            assigned_labels <span class="token operator">=</span> overlaps<span class="token punctuation">.</span>new_full<span class="token punctuation">(</span><span class="token punctuation">(</span>num_bboxes<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                                                dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> AssignResult<span class="token punctuation">(</span>
            num_gts<span class="token punctuation">,</span>
            assigned_gt_inds<span class="token punctuation">,</span>
            max_overlaps<span class="token punctuation">,</span>
            labels<span class="token operator">=</span>assigned_labels<span class="token punctuation">)</span>

 
    <span class="token comment">#对于每一个bbox，根据iou取max得出最佳匹配的gt和下标</span>
    max_overlaps<span class="token punctuation">,</span> argmax_overlaps <span class="token operator">=</span> overlaps<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment">#对于每一个gt，根据iou取max选出最佳匹配的bbox和下标</span>
    gt_max_overlaps<span class="token punctuation">,</span> gt_argmax_overlaps <span class="token operator">=</span> overlaps<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

 
    <span class="token comment">#4.将所有和最佳匹配的0&lt;gt&lt;neg_iou_thr的设置为负样本</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>neg_iou_thr<span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        assigned_gt_inds<span class="token punctuation">[</span><span class="token punctuation">(</span>max_overlaps <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                         <span class="token operator">&amp;</span> <span class="token punctuation">(</span>max_overlaps <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>neg_iou_thr<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>neg_iou_thr<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>neg_iou_thr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span>
        assigned_gt_inds<span class="token punctuation">[</span><span class="token punctuation">(</span>max_overlaps <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>neg_iou_thr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                         <span class="token operator">&amp;</span> <span class="token punctuation">(</span>max_overlaps <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>neg_iou_thr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token comment">#5.分配正样本</span>
    pos_inds <span class="token operator">=</span> max_overlaps <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>pos_iou_thr
    assigned_gt_inds<span class="token punctuation">[</span>pos_inds<span class="token punctuation">]</span> <span class="token operator">=</span> argmax_overlaps<span class="token punctuation">[</span>pos_inds<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>

	<span class="token comment">#6.处理低匹配度</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>match_low_quality<span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_gts<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> gt_max_overlaps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>min_pos_iou<span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>gt_max_assign_all<span class="token punctuation">:</span>
                    max_iou_inds <span class="token operator">=</span> overlaps<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">==</span> gt_max_overlaps<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                    assigned_gt_inds<span class="token punctuation">[</span>max_iou_inds<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    assigned_gt_inds<span class="token punctuation">[</span>gt_argmax_overlaps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>

    <span class="token keyword">if</span> gt_labels <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        assigned_labels <span class="token operator">=</span> assigned_gt_inds<span class="token punctuation">.</span>new_full<span class="token punctuation">(</span><span class="token punctuation">(</span>num_bboxes<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        pos_inds <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>
            assigned_gt_inds <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> as_tuple<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> pos_inds<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            assigned_labels<span class="token punctuation">[</span>pos_inds<span class="token punctuation">]</span> <span class="token operator">=</span> gt_labels<span class="token punctuation">[</span>
                assigned_gt_inds<span class="token punctuation">[</span>pos_inds<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        assigned_labels <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">return</span> AssignResult<span class="token punctuation">(</span>
        num_gts<span class="token punctuation">,</span> assigned_gt_inds<span class="token punctuation">,</span> max_overlaps<span class="token punctuation">,</span> labels<span class="token operator">=</span>assigned_labels<span class="token punctuation">)</span>
</code></pre> 
<p>sampler就比较简单了，从之前的结果中随机选取512个，选择25%的正样本，剩下的是负样本</p> 
<h4><a id="roi_head_474"></a>roi_head</h4> 
<p>roi_head的配置如下：</p> 
<pre><code class="prism language-python">roi_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
     <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'StandardRoIHead'</span><span class="token punctuation">,</span>
     <span class="token comment"># 这个组件是用于bbox_head之前的特征提取器，这个提取器把bbox的特征从单张的特征图提取出来，fpn之类的多张特征图需要多次映射</span>
     bbox_roi_extractor<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
         <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'SingleRoIExtractor'</span><span class="token punctuation">,</span>
         roi_layer<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RoIAlign'</span><span class="token punctuation">,</span> output_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> sampling_ratio<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
         <span class="token comment"># 需要映射的featmap尺度， 这里取得是P2-P5层 这4层</span>
         featmap_strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token comment"># roi的后续卷积全连接和预测</span>
     bbox_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
         <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Shared2FCBBoxHead'</span><span class="token punctuation">,</span>
         in_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
         fc_out_channels<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>
         roi_feat_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span>
         num_classes<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span>
         bbox_coder<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
             <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'DeltaXYWHBBoxCoder'</span><span class="token punctuation">,</span>
             target_means<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
             target_stds<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         reg_class_agnostic<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
         loss_cls<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
             <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span><span class="token punctuation">,</span> use_sigmoid<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         loss_bbox<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'L1Loss'</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> 
<p>之后就是比较简单的全连接和卷积了，这里就只放一下别人画的图了<br> <img src="https://images2.imgbox.com/76/f7/SuI2qvwo_o.png" alt="在这里插入图片描述"></p> 
<p>完结撒花</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/018968b61ac33ab64f17430ec705e579/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">常用技术的原理简单介绍 kafka、docker、seata等</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3d0e2d7c97b843ee4dda6ed99025d8ec/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">部署WDS服务</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>