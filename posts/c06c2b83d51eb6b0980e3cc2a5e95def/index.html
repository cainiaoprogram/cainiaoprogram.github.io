<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>IOS：Safari无法播放MP4（H.264编码） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="IOS：Safari无法播放MP4（H.264编码）" />
<meta property="og:description" content="一、问题描述 MP4使用H.264编码通常具有良好的兼容性，因为H.264是一种广泛支持的视频编码标准。它可以在许多设备和平台上播放，包括电脑、移动设备和流媒体设备。
使用caniuse查询H.264兼容性，看似确实具有良好的兼容性：
然而，今天的前端小伙伴报告IOS上遇到MP4无法播放，而Android上能正常播放。
二、问题调查 考虑一下方面（相关信息可参阅Why and How to Solve MP4 not Playing on iPhone Error?）：
MP4 中的编解码器不兼容。MP4 是一种容器格式，可以包含各种视频和音频编解码器。如果 MP4 文件使用 iPhone 不支持的编码格式，iPhone 将无法播放该 MP4 文件。MP4 文件已损坏。在 MP4 视频录制、传输或下载过程中，文件可能会损坏或损坏。在这种情况下，MP4 文件将无法在 iPhone 以及其他媒体播放器上播放。MP4 视频分辨率、FPS 或比特率太高。有时，您可以在 iPhone 上播放 MP4，但播放时出现断断续续的情况。这是因为您的 MP4 视频为 4K/8K 分辨率，并且具有高 FPS 或比特率。
4.您使用的是旧iPhone。iPhone 7 之前的旧版 iPhone 手机无法播放使用 HEVC 编码的 MP4。本机视频或电视应用程序不支持 MP4。iPhone 上的本机视频或电视应用程序不支持 MP4 播放。在这种情况下，建议您下载第三方媒体播放器。 确定文件没问题，可以排除MP4文件损坏，那么可以排除以下几点：
1.MP4文件的编码 确认文件编码格式是否为H.264（目前H.265有比较大的兼容问题），那么如何确定文件的编码格式呢？
（1）mp4box.js查看MIME
测试网址：https://gpac.github.io/mp4box.js/test/filereader.html
如果一个MP4视频文件的编码格式为H.264，则其MIME是会包括avc这个字符串的，因此我们可以通过判断MIME中是否包含&#34;avc&#34;从而进行H.264视频编码格式的判断。例如：
不能在线播放的：audio/mp4; codecs=&#34;mp4v,mp4a.40.2,tmcd&#34;; profiles=&#34;isom,iso2,mp41&#34;
能在线播放的：video/mp4; codecs=&#34;avc1.640028,mp4a.40.2,tmcd&#34;; profiles=&#34;isom,iso2,avc1,mp41&#34;
（2）利用视频播放软件查看
①PotPlayer" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c06c2b83d51eb6b0980e3cc2a5e95def/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-05T12:45:22+08:00" />
<meta property="article:modified_time" content="2024-01-05T12:45:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">IOS：Safari无法播放MP4（H.264编码）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>一、问题描述</h3> 
<p>MP4使用H.264编码通常具有良好的兼容性，因为H.264是一种广泛支持的视频编码标准。它可以在许多设备和平台上播放，包括电脑、移动设备和流媒体设备。</p> 
<p>使用<a href="https://caniuse.com/?search=h264" rel="nofollow">caniuse</a>查询H.264兼容性，看似确实具有良好的兼容性：<br> <img src="https://images2.imgbox.com/2b/4d/7dqqMZiD_o.png" alt="在这里插入图片描述"></p> 
<p>然而，今天的前端小伙伴报告IOS上遇到MP4无法播放，而Android上能正常播放。</p> 
<p><img src="https://images2.imgbox.com/4f/29/vL9bHlB0_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_9"></a>二、问题调查</h3> 
<p>考虑一下方面（相关信息可参阅<a href="https://www.easefab.com/mp4-tips/iphone-wont-play-mp4-solved.html" rel="nofollow">Why and How to Solve MP4 not Playing on iPhone Error?</a>）：</p> 
<blockquote> 
 <ol><li>MP4 中的编解码器不兼容。MP4 是一种容器格式，可以包含各种视频和音频编解码器。如果 MP4 文件使用 iPhone 不支持的编码格式，iPhone 将无法播放该 MP4 文件。</li><li>MP4 文件已损坏。在 MP4 视频录制、传输或下载过程中，文件可能会损坏或损坏。在这种情况下，MP4 文件将无法在 iPhone 以及其他媒体播放器上播放。</li><li>MP4 视频分辨率、FPS 或比特率太高。有时，您可以在 iPhone 上播放 MP4，但播放时出现断断续续的情况。这是因为您的 MP4 视频为 4K/8K 分辨率，并且具有高 FPS 或比特率。<br> 4.您使用的是旧iPhone。iPhone 7 之前的旧版 iPhone 手机无法播放使用 HEVC 编码的 MP4。</li><li>本机视频或电视应用程序不支持 MP4。iPhone 上的本机视频或电视应用程序不支持 MP4 播放。在这种情况下，建议您下载第三方媒体播放器。</li></ol> 
</blockquote> 
<p>确定文件没问题，可以排除MP4文件损坏，那么可以排除以下几点：</p> 
<h4><a id="1MP4_20"></a>1.MP4文件的编码</h4> 
<p>确认文件编码格式是否为H.264（目前H.265有比较大的兼容问题），那么如何确定文件的编码格式呢？<br> （1）mp4box.js查看MIME<br> 测试网址：https://gpac.github.io/mp4box.js/test/filereader.html<br> <img src="https://images2.imgbox.com/b2/9d/LFjt6Yeo_o.png" alt="在这里插入图片描述"><br> 如果一个MP4视频文件的编码格式为H.264，则其MIME是会包括avc这个字符串的，因此我们可以通过判断MIME中是否包含"avc"从而进行H.264视频编码格式的判断。例如：</p> 
<p>不能在线播放的：<code>audio/mp4; codecs="mp4v,mp4a.40.2,tmcd"; profiles="isom,iso2,mp41"</code><br> 能在线播放的：<code>video/mp4; codecs="avc1.640028,mp4a.40.2,tmcd"; profiles="isom,iso2,avc1,mp41"</code></p> 
<p>（2）利用视频播放软件查看<br> ①PotPlayer<br> <img src="https://images2.imgbox.com/33/2e/rrBRrTWG_o.png" alt="在这里插入图片描述"><br> ②VLC media player<br> <img src="https://images2.imgbox.com/a1/73/SNL1oLJG_o.png" alt="在这里插入图片描述"><br> （3）利用ffprobe查看<br> 需要先下载安装ffmpeg后使用命令，FFmpeg安装可以参考《<a href="https://blog.csdn.net/q1003675852/article/details/135381431?spm=1001.2014.3001.5501">FFmpeg安装保姆级教程</a>》：</p> 
<pre><code>ffprobe -show_streams 20230901-112105.mp4
</code></pre> 
<p><img src="https://images2.imgbox.com/eb/88/gNOXtUfU_o.png" alt="在这里插入图片描述"></p> 
<p>更简洁的可以使用以下命令：</p> 
<pre><code>ffprobe -v error -select_streams v:0 -show_entries stream=profile,level -of default=noprint_wrappers=1 20230901-112105.mp4
</code></pre> 
<p><img src="https://images2.imgbox.com/10/fa/mhIXVa5w_o.png" alt="在这里插入图片描述"><br> 注：ffproble的level=52，应该是对应的H.264标准中Level 5.2。关于这一点，可以从<a href="https://ffmpeg.org/ffprobe-all.html" rel="nofollow">ffproble</a>的文档里得出：</p> 
<blockquote> 
 <p>13.11 h264_metadata： <img src="https://images2.imgbox.com/2f/15/qAQtKjRV_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<blockquote> 
 <p>13.14 hevc_metadata：(H.265 / HEVC (High Efficiency Video Coding)<img src="https://images2.imgbox.com/e1/8c/BjsY6oZm_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p>上述两个截图，提到了两个字段：<code>level_idc </code>和<code>general_level_idc </code>，这两个分别与H.264和H.265的Level对应，并且对应关系不一样。<code>general_level_idc </code>与H.265的Level对应关系如下：</p> 
<p><img src="https://images2.imgbox.com/62/eb/Yyg8Xe2g_o.png" alt="在这里插入图片描述"><br> codec标准要求level在存储的时候，会先乘以30。也就是<code>general_level_idc </code>=level*30，所以<code>general_level_idc </code>为153时，对应的H.265的Level为：<code>153/30=5.1</code>。</p> 
<h4><a id="2FPS_62"></a>2.分辨率、帧率FPS及码率</h4> 
<p>首先先了解一下三者的概念及关系：</p> 
<blockquote> 
 <p>分辨率、帧率和码率是视频质量和播放性能的三个重要参数。<br> <code>分辨率</code>：分辨率是指图像或视频中的像素数量。常见的分辨率有720p（1280×720）、1080p（1920×1080）和4K（3840×2160）等。分辨率越高，图像或视频的细节和清晰度就越高。<br> <code>帧率（FPS）</code>：帧率是指每秒显示的图像帧数。通常以“帧每秒”来表示。常见的帧率有24、30、60等。帧率越高，视频播放就越流畅，尤其在快速运动的场景中能够更好地展现细节。<br> <code>码率</code>：码率是指视频或音频数据传输速率，通常以每秒传输的比特数来表示，单位为kbps（千比特每秒）或Mbps（兆比特每秒）。码率越高，视频或音频的质量就越高，但同时占用的带宽也会更大。<br> 这三个参数之间存在着密切的关系。高分辨率和高帧率的视频需要更高的码率来保证播放质量（码率 = 分辨率 × 帧率 × 每像素比特数）。例如，一个高分辨率的视频如果帧率较低或者码率不足，可能会出现画面卡顿或者模糊不清的情况。<br> 在制作和传输视频时，需要根据具体情况综合考虑这三个因素，以达到最佳的观看效果和传输性能。</p> 
</blockquote> 
<p>接下来使用ffprobe命令查看文件的这三个率的值, 需要先安装FFmpeg，安装可以参考《<a href="https://blog.csdn.net/q1003675852/article/details/135381431?spm=1001.2014.3001.5501">FFmpeg安装保姆级教程</a>》：</p> 
<pre><code>ffprobe 112105.mp4
</code></pre> 
<p><img src="https://images2.imgbox.com/6e/1b/vTDmOlTj_o.png" alt="在这里插入图片描述"><br> 可以看到文件已经达到4K分辨率，码率51651kb/s， 帧率60fps应该也是过高了。</p> 
<p>这里还要提到与视频质量相关的两个参数<code>profile</code>和<code>level</code>（它们的设定也会影响带码率和帧率值）：</p> 
<p>当使用H.264编码时，profile和level是指视频编码的配置参数，它们决定了视频的质量、兼容性和性能。具体来说，这些参数包括：</p> 
<p><code>Profile（配置文件</code>）：指定了编码器可以使用的特定功能和算法，影响了视频的压缩效率和质量。常见的profile包括Baseline、Main和High。Baseline适用于较低质量的视频，Main适用于一般质量的视频，而High适用于高质量的视频。</p> 
<p><code>Level（级别）</code>：指定了视频的参数，如分辨率、帧率和比特率的限制。不同的level对应不同的视频参数限制，例如Level 3.0适用于标清视频，Level 4.1适用于高清视频，Level 5.1适用于超高清视频。</p> 
<p><code>选择合适的profile和level取决于视频的需求和目标平台的兼容性</code>。例如，对于移动设备和低带宽环境，可以选择Baseline profile和较低的level，而对于高清视频和蓝光光盘，则可以选择High profile和更高的level。因此，根据具体的应用场景来选择合适的profile和level组合是非常重要的。</p> 
<blockquote> 
 <p>简单来说：<br> H.264的Profile和level 可以理解为 gzip的level， 等级越高，文件压缩得越小，传输越快，但cpu消耗越多。<br> Profile和level越高越好吗？压缩级别越高不仅在压缩时cpu的消耗越高，视频在播放时也需要消耗更多的cpu进行解压，各类型手机的硬件条件不一样，所以支持的压缩级别也不同。</p> 
</blockquote> 
<p>通过<a href="https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/StreamingMediaGuide/FrequentlyAskedQuestions/FrequentlyAskedQuestions.html" rel="nofollow">苹果官方</a>文档中ios能支持的视频格式可知，并不是所有h264编码的mp4文件都能在ios中播放：</p> 
<p><img src="https://images2.imgbox.com/ac/58/y7gCH2E2_o.png" alt="在这里插入图片描述"><br> 从上可知，iphone4之后可以使用<code>High Profile Level 4.1</code>。</p> 
<h3><a id="_100"></a>三、解决方案</h3> 
<p>如果要保持MP4格式不变，针对IOS的兼容，需要将文件转换成<code>High Profile Level 4.1</code>。</p> 
<blockquote> 
 <p>很多压缩软件或视频转码软件是没有Profile和level选项的，主要原因也是考虑到视频的压缩级别过高，在某些环境下无法播放。现在市场上流行的转码软件，在转码或压缩时：<br> 1.有的不对Profile和level修改，直接进行有损压缩；<br> 2.有的是直接转码为Main Profile level 3.1，是因为iPhone 4 支持的最高就是这个档位。</p> 
</blockquote> 
<p>注：如果需要使用软件进行转换，可以使用<a href="https://www.videoproc.com/iphone-video-processing/iphone-4k-60fps-video-explained.htm" rel="nofollow">EaseFab Video Converter</a></p> 
<p>本文转换的方法使用ffmpeg，FFmpeg安装可以参考《<a href="https://blog.csdn.net/q1003675852/article/details/135381431?spm=1001.2014.3001.5501">FFmpeg安装保姆级教程</a>》：</p> 
<pre><code>ffmpeg -i 20230901-112105.mp4 -vcodec h264 -profile:v high -level 4.1 112105.mp4
</code></pre> 
<p><img src="https://images2.imgbox.com/7e/dc/yLPSnMXc_o.png" alt="在这里插入图片描述"></p> 
<p>最后使用<code>ffprobe</code>检查一下转换后的profile和level：</p> 
<pre><code>ffprobe -v error -select_streams v:0 -show_entries stream=profile,level -of default=noprint_wrappers=1 112105.mp4
</code></pre> 
<p><img src="https://images2.imgbox.com/27/43/XXMmBf8e_o.png" alt="在这里插入图片描述"><br> 此时，我们再查看一下前面提到的三率值：</p> 
<p><img src="https://images2.imgbox.com/05/36/W3qXzYLq_o.png" alt="在这里插入图片描述"><br> 顺便提一下，可能你也注意到上图中码率值有出现3个：<br> <img src="https://images2.imgbox.com/df/47/mYVtpFqk_o.png" alt="在这里插入图片描述"></p> 
<p>这里，整个是9215k，视频是9072k，音频是131k，视频和音频的码率加起来和整个的码率还差一点。其实这里有些封包数据也要算到整个文件的码率中的，所以有一些差异。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/46a0c4c66ad0df4a0416f5f53822e0ba/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【本科生通信原理】【实验报告】【北京航空航天大学】实验一：通信原理初步</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ab35777e2633543b280dfb47dc502a1d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">聊一聊 C# 线程切换后上下文都去了哪里</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>