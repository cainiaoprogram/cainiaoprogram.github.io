<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Zookeeper 集群搭建 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Zookeeper 集群搭建" />
<meta property="og:description" content="文章目录 Zookeeper 集群搭建一. 简介二. 环境准备三. 安装 zookeeper3.1 下载 zookeeper3.2 安装 jdk 解压 zookeeper 四. 配置集群4.1 配置 zookeeper 服务器文件4.2 修改配置文件4.3 创建配置文件 myid4.4 启动 zookeeper Zookeeper 集群搭建 一. 简介 本次搭建使用一台机器，区别不同的启动端口及启动文件路径搭建 zookeeper 集群（伪集群），正常是使用三台及以上的奇数台服务器搭建集群。
官网参考地址：https://zookeeper.apache.org/doc/current/zookeeperAdmin.html
这里就有一个问题，为什么是需要奇数个服务器。
注：为什么规则要求 可用节点数量 &gt; 集群总结点数量/2 ？
如果不这样限制，在集群出现脑裂的时候，可能会出现多个子集群同时服务的情况（即子集群各组选举出自己的 leader ）， 这样对整个 zookeeper 集群来说是紊乱的。换句话说，如果遵守上述规则进行选举，即使出现脑裂，集群最多也只能回出现一个子集群可以提供服务的情况（ 能满足节点数量&gt; 总结点数量/2 的子集群最多只会有一个）。所以要限制 可用节点数量 &gt; 集群总结点数量/2 。
注：这里有个疑问，为什么脑裂之后 能满足节点数量&gt; 总结点数量/2 这里为什么是集群总结点的数量，而不是脑裂之后小集群的数量？
采用奇数个的节点主要是出于两方面的考虑：
1️⃣ 防止由脑裂造成的集群不可用
可参考：HA高可用集群中&#34;脑裂&#34;问题解决
​ https://blog.csdn.net/u010476994/article/details/79806041
❓ 什么是脑裂？
集群的脑裂通常是发生在节点之间通信不可达的情况下，集群会分裂成不同的小集群，小集群各自选出自己的master节点，导致原有的集群出现多个master节点的情况，这就是脑裂。（几乎所有的集群都会出现脑裂的情况）
下面举例说一下为什么采用奇数台节点，就可以防止由于脑裂造成的服务不可用： (1) 假如zookeeper集群有 5 个节点，发生了脑裂，脑裂成了A、B两个小集群：
(a) A ： 1个节点 ，B ：4个节点 (b) A ： 2个节点， B ：3个节点 可以看出，上面这两种情况下，A、B中总会有一个小集群满足 可用节点数量 &gt; 总节点数量/2 。所以zookeeper集群仍然能够选举出leader ， 仍然能对外提供服务，只不过是有一部分节点失效了而已。 (2) 假如zookeeper集群有4个节点，同样发生脑裂，脑裂成了A、B两个小集群：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/bde3a2e908184f3d42ff59a6b985e875/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-12T17:42:48+08:00" />
<meta property="article:modified_time" content="2023-12-12T17:42:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Zookeeper 集群搭建</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Zookeeper__1" rel="nofollow">Zookeeper 集群搭建</a></li><li><ul><li><a href="#__3" rel="nofollow">一. 简介</a></li><li><a href="#__67" rel="nofollow">二. 环境准备</a></li><li><a href="#__zookeeper_77" rel="nofollow">三. 安装 zookeeper</a></li><li><ul><li><a href="#31__zookeeper_79" rel="nofollow">3.1 下载 zookeeper</a></li><li><a href="#32__jdk__zookeeper_83" rel="nofollow">3.2 安装 jdk 解压 zookeeper</a></li></ul> 
   </li><li><a href="#__153" rel="nofollow">四. 配置集群</a></li><li><ul><li><a href="#41__zookeeper__157" rel="nofollow">4.1 配置 zookeeper 服务器文件</a></li><li><a href="#42__167" rel="nofollow">4.2 修改配置文件</a></li><li><a href="#43__myid_195" rel="nofollow">4.3 创建配置文件 myid</a></li><li><a href="#44__zookeeper_212" rel="nofollow">4.4 启动 zookeeper</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Zookeeper__1"></a>Zookeeper 集群搭建</h2> 
<h3><a id="__3"></a>一. 简介</h3> 
<p>本次搭建使用一台机器，区别不同的启动端口及启动文件路径搭建 <code>zookeeper</code> 集群（伪集群），正常是使用三台及以上的奇数台服务器搭建集群。</p> 
<p><strong>官网参考地址：<a href="https://zookeeper.apache.org/doc/current/zookeeperAdmin.html" rel="nofollow">https://zookeeper.apache.org/doc/current/zookeeperAdmin.html</a></strong></p> 
<p>这里就有一个问题，为什么是需要奇数个服务器。</p> 
<ul><li> <p>注：为什么规则要求 可用节点数量 &gt; 集群总结点数量/2 ？</p> </li><li> <p>如果不这样限制，在集群出现脑裂的时候，可能会出现多个子集群同时服务的情况（即子集群各组选举出自己的 <code>leader</code> ）， 这样对整个 <code>zookeeper</code> 集群来说是紊乱的。换句话说，如果遵守上述规则进行选举，即使出现脑裂，集群最多也只能回出现一个子集群可以提供服务的情况（ <code>能满足节点数量&gt; 总结点数量/2</code> 的子集群最多只会有一个）。所以要限制 可用节点数量 &gt; 集群总结点数量/2 。</p> <p><mark>注：这里有个疑问，为什么脑裂之后 <code>能满足节点数量&gt; 总结点数量/2</code> 这里为什么是集群总结点的数量，而不是脑裂之后小集群的数量？</mark></p> </li></ul> 
<p><strong>采用奇数个的节点主要是出于两方面的考虑：</strong></p> 
<p><strong>1️⃣ 防止由脑裂造成的集群不可用</strong></p> 
<p><strong>可参考：</strong><a href="https://www.cnblogs.com/kevingrace/p/7205846.html" rel="nofollow">HA高可用集群中"脑裂"问题解决</a></p> 
<p>​ <a href="https://blog.csdn.net/u010476994/article/details/79806041">https://blog.csdn.net/u010476994/article/details/79806041</a></p> 
<p>❓ 什么是脑裂？</p> 
<p>集群的脑裂通常是发生在节点之间通信不可达的情况下，集群会分裂成不同的小集群，小集群各自选出自己的master节点，导致原有的集群出现多个master节点的情况，这就是脑裂。（几乎所有的集群都会出现脑裂的情况）</p> 
<ul><li>下面举例说一下为什么采用奇数台节点，就可以防止由于脑裂造成的服务不可用：</li></ul> 
<p>(1) 假如zookeeper集群有 5 个节点，发生了脑裂，脑裂成了A、B两个小集群：</p> 
<pre><code> (a) A ： 1个节点 ，B ：4个节点 

 (b) A ： 2个节点， B ：3个节点  

可以看出，上面这两种情况下，A、B中总会有一个小集群满足 可用节点数量 &gt; 总节点数量/2 。所以zookeeper集群仍然能够选举出leader ， 仍然能对外提供服务，只不过是有一部分节点失效了而已。
</code></pre> 
<p>(2) 假如zookeeper集群有4个节点，同样发生脑裂，脑裂成了A、B两个小集群：</p> 
<pre><code>(a) A：1个节点 ，  B：3个节点 

(b) A：2个节点 ， B：2个节点

可以看出，情况(a) 是满足选举条件的，与（1）中的例子相同。 但是情况(b) 就不同了，因为A和B都是2个节点，都不满足 可用节点数量 &gt; 总节点数量/2 的选举条件， 所以此时zookeeper就彻底不能提供服务了。
</code></pre> 
<p>综合上面两个例子可以看出： 在节点数量是奇数个的情况下， zookeeper集群总能对外提供服务（即使损失了一部分节点）；如果节点数量是偶数个，会存在zookeeper集群不能用的可能性（脑裂成两个均等的子集群的时候）。</p> 
<p>在生产环境中，如果zookeeper集群不能提供服务，那将是致命的 ， 所以zookeeper集群的节点数一般采用奇数个。</p> 
<p><strong>2️⃣ 在容错能力相同的情况下，奇数台更节省资源。</strong></p> 
<p>leader选举，要求 可用节点数量 &gt; 总节点数量/2 。注意 是 &gt; , 不是 ≥。</p> 
<p>举两个例子：</p> 
<p>(1) 假如zookeeper集群1 ，有3个节点，3/2=1.5 , 即zookeeper想要正常对外提供服务（即leader选举成功），至少需要2个节点是正常的。换句话说，3个节点的zookeeper集群，允许有一个节点宕机。</p> 
<p>(2) 假如zookeeper集群2，有4个节点，4/2=2 , 即zookeeper想要正常对外提供服务（即leader选举成功），至少需要3个节点是正常的。换句话说，4个节点的zookeeper集群，也允许有一个节点宕机。</p> 
<p>那么问题就来了， 集群1与集群2都有 允许1个节点宕机 的容错能力，但是集群2比集群1多了1个节点。在相同容错能力的情况下，本着节约资源的原则，zookeeper集群的节点数维持奇数个更好一些。</p> 
<h3><a id="__67"></a>二. 环境准备</h3> 
<table><thead><tr><th>主机</th><th>配置文件路径</th><th>端口</th></tr></thead><tbody><tr><td>172.26.235.140</td><td>/opt/zookeeper2181</td><td>2181</td></tr><tr><td>172.26.235.140</td><td>/opt/zookeeper2182</td><td>2182</td></tr><tr><td>172.26.235.140</td><td>/opt/zookeeper2183</td><td>2183</td></tr></tbody></table> 
<h3><a id="__zookeeper_77"></a>三. 安装 zookeeper</h3> 
<h4><a id="31__zookeeper_79"></a>3.1 下载 zookeeper</h4> 
<p>官网下载：<a href="https://zookeeper.apache.org/releases.html" rel="nofollow">https://zookeeper.apache.org/releases.html</a></p> 
<h4><a id="32__jdk__zookeeper_83"></a>3.2 安装 jdk 解压 zookeeper</h4> 
<p>因为 <code>zookeeper</code> 依赖于 <code>java</code> 环境，所以要提前配置好 <code>java</code> 环境</p> 
<ul><li>解压 <code>jdk</code></li></ul> 
<pre><code class="prism language-shell"><span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> jdk-8u161-linux-x64.tar.gz
</code></pre> 
<ul><li>修改 <code>/etc/profile</code> 文件</li></ul> 
<pre><code class="prism language-shell"><span class="token comment"># 在文件最后添加如下内容</span>
<span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/opt/jdk1.8     <span class="token comment"># 安装路径</span>
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token environment constant">$PATH</span>
<span class="token assign-left variable">CLASSPATH</span><span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/jre/lib/ext:<span class="token variable">$JAVA_HOME</span>/lib/tools.jar
<span class="token builtin class-name">export</span> <span class="token environment constant">PATH</span> JAVA_HOME CLASSPATH
</code></pre> 
<ul><li>解压 <code>zookeeper</code></li></ul> 
<pre><code class="prism language-shell"><span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> apache-zookeeper-3.8.0-bin.tar.gz <span class="token parameter variable">-C</span> /opt

<span class="token comment"># 解压完成查看常用目录结构</span>
bin		用来存放脚本
conf	用来存放配置文件
</code></pre> 
<ul><li>修改 <code>conf</code> 中的配置文件</li></ul> 
<p><strong>注：如果解压完成直接启动 <code>zookeeper</code> 那么则会提示如下内容，所以我们要去 <code>conf</code> 中修改配置文件</strong></p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master<span class="token punctuation">]</span><span class="token comment"># cd /opt/apache-zookeeper-3.8.0-bin</span>
<span class="token punctuation">[</span>root@master bin<span class="token punctuation">]</span><span class="token comment"># sh zkServer.sh start</span>
ZooKeeper JMX enabled by default
Using config: /opt/apache-zookeeper-3.8.0-bin/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
grep: /opt/apache-zookeeper-3.8.0-bin/bin/<span class="token punctuation">..</span>/conf/zoo.cfg: 没有那个文件或目录
grep: /opt/apache-zookeeper-3.8.0-bin/bin/<span class="token punctuation">..</span>/conf/zoo.cfg: 没有那个文件或目录
mkdir: 无法创建目录<span class="token string">""</span><span class="token builtin class-name">:</span> 没有那个文件或目录
Usage: zkServer.sh <span class="token punctuation">[</span>--config <span class="token operator">&lt;</span>conf-dir<span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>start<span class="token operator">|</span>start-foreground<span class="token operator">|</span>stop<span class="token operator">|</span>version<span class="token operator">|</span>restart<span class="token operator">|</span>status<span class="token operator">|</span>print-cmd<span class="token punctuation">}</span>
</code></pre> 
<p>进入 <code>conf</code> 文件中可以看到并没有 <code>zoo.cfg</code> 文件，但是有一个 <code>zoo_sample.cfg</code> 的模板文件</p> 
<pre><code class="prism language-shell"><span class="token function">cp</span> zoo_sample.cfg zoo.cfg
<span class="token function">vim</span> zoo.cfg
<span class="token comment"># zookeeper 时间配置中的基本单位（毫秒）</span>
<span class="token assign-left variable">tickTime</span><span class="token operator">=</span><span class="token number">2000</span>
<span class="token comment"># 允许 follower 初始化连接到 leader 最大时长（秒），他表示 tickTime 时间倍数，即：initLimit*tickTime</span>
<span class="token assign-left variable">initLimit</span><span class="token operator">=</span><span class="token number">10</span>
<span class="token comment"># 允许 follower 与 leader 数据同步最大时长（秒），他表示 tickTime 时间倍数</span>
<span class="token assign-left variable">syncLimit</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token comment"># zookeeper 数据存储目录及日志保存目录（如没有指明 dataLogDir，则日志也保存到这个文件中）</span>
<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/tmp/zookeeper
<span class="token comment"># 对客户端提供的端口</span>
<span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>
<span class="token comment"># 单个客户端与 zookeeper 最大并发连接数</span>
<span class="token assign-left variable">maxClientCnxns</span><span class="token operator">=</span><span class="token number">60</span>
<span class="token comment"># 保存的数据快照数量，之外的会被清除</span>
<span class="token assign-left variable">autopurge.snapRetainCount</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token comment"># 自动触发清除任务的时间间隔，小时为单位，默认为0，表示不清除</span>
<span class="token assign-left variable">autopurge.purgeInterval</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre> 
<h3><a id="__153"></a>四. 配置集群</h3> 
<blockquote> 
 <p>单机环境下，<code>jdk、zookeeper</code> 安装完毕，基于一台虚拟机，进行 <code>zookeeper</code> 伪集群搭建，<code>zookeeper</code> 集群中包含3个节点，节点对外提供服务端口号分别为 <code>2181,2182,2183</code></p> 
</blockquote> 
<h4><a id="41__zookeeper__157"></a>4.1 配置 zookeeper 服务器文件</h4> 
<blockquote> 
 <p>基于 <code>apache-zookeeper-3.8.0-bin</code> 复制三分 <code>zookeeper</code> 安装好的服务器文件，目录名称分别为 <code>zookeeper2181、zookeeper2182、zookeeper2183</code></p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">mv</span> /opt/apache-zookeeper-3.8.0-bin /opt/zookeeper2181
<span class="token function">cp</span> <span class="token parameter variable">-r</span> /opt/zookeeper2181 /opt/zookeeper2182
<span class="token function">cp</span> <span class="token parameter variable">-r</span> /opt/zookeeper2181 /opt/zookeeper2183
</code></pre> 
<h4><a id="42__167"></a>4.2 修改配置文件</h4> 
<p>修改 <code>/opt/zookeeper218*/conf</code> 配置文件</p> 
<pre><code class="prism language-shell"><span class="token comment"># zookeeper 数据存储目录及日志保存目录（如没有指明 dataLogDir，则日志也保存到这个文件中）</span>
<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/opt/zookeeper2181
<span class="token comment"># 对客户端提供的端口</span>
<span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>

<span class="token comment"># 集群配置信息</span>
	<span class="token comment"># server.A=B:C:D</span>
	<span class="token comment"># A:是一个数字，表示这个是服务器的编号</span>
	<span class="token comment"># B:是这个服务器的ip地址</span>
	<span class="token comment"># C:Zookeeper服务器之间的通信端口号</span>
	<span class="token comment"># D:Leader选举的端口</span>
	<span class="token comment"># 注：因为这里是伪集群（IP 地址是相同的），所以 C 和 D 是不同的，如果是不同的服务器，这里一般是相同的，示例：</span>
		<span class="token comment"># server.1=172.26.235.140:2288:3388</span>
		<span class="token comment"># server.2=172.26.235.141:2288:3388</span>
		<span class="token comment"># server.3=172.26.235.142:2288:3388</span>
	
<span class="token assign-left variable">server.1</span><span class="token operator">=</span><span class="token number">172.26</span>.235.140:2287:3387
<span class="token assign-left variable">server.2</span><span class="token operator">=</span><span class="token number">172.26</span>.235.140:2288:3388
<span class="token assign-left variable">server.3</span><span class="token operator">=</span><span class="token number">172.26</span>.235.140:2289:3389
</code></pre> 
<h4><a id="43__myid_195"></a>4.3 创建配置文件 myid</h4> 
<blockquote> 
 <p>在上一步dataDir指定的目录下，创建myid文件，然后在该文件添加上一步server配置对应A数字。</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># zookeeper2181对应的数字为1</span>
<span class="token builtin class-name">echo</span> <span class="token string">"1"</span> <span class="token operator">&gt;</span> /opt/zookeeper2181

<span class="token comment"># zookeeper2182对应的数字为2</span>
<span class="token builtin class-name">echo</span> <span class="token string">"2"</span> <span class="token operator">&gt;</span> /opt/zookeeper2182

<span class="token comment"># zookeeper2183对应的数字为3</span>
<span class="token builtin class-name">echo</span> <span class="token string">"3"</span> <span class="token operator">&gt;</span> /opt/zookeeper2183
</code></pre> 
<h4><a id="44__zookeeper_212"></a>4.4 启动 zookeeper</h4> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@aliyun ~<span class="token punctuation">]</span><span class="token comment"># cd /opt/zookeeper2181/bin</span>

<span class="token punctuation">[</span>root@aliyun bin<span class="token punctuation">]</span><span class="token comment"># ./zkServer.sh start</span>
或者指定启动配置文件
<span class="token punctuation">[</span>root@aliyun bin<span class="token punctuation">]</span><span class="token comment"># ./zkServer.sh start ../conf/zoo.cfg</span>


其他两台同样的启动方式

</code></pre> 
<p> <br>  <br>  <br>  <br>  </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d5a3eaba5a5a4979029bfc49656245d1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">获取致命错误LNK1107:文件无效或损坏:无法在0x31</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/963b4ae1cd14b9ccaa2eed1a9e6d0de8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C#学习相关系列之yield和return的区别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>