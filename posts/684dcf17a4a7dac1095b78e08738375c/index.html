<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL---脏页机制 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL---脏页机制" />
<meta property="og:description" content="文章目录 flush和脏页flush触发条件InnoDB刷脏页的控制策略 flush和脏页 InnoDB在处理更新语句的时候，磁盘操作仅写了redo log日志，同时并更新内存，之后当系统空闲时会把操作记录更新到磁盘里，MySQL把内存里的数据写入磁盘的过程我们称为flush。
当内存数据页跟磁盘数据页内容不一致的时候，我们称这个内存页为“脏页”。内存数据写入到磁盘后，内存和磁盘上的数据页的内容一致，称为“干净页”。
flush触发条件 InnoDB redo log日志写满。此时系统会停止所有更新操作，把checkpoint往前推进，为redo log留出空间。 MySQL日志—redo log和binlog系统内存不足。当需要新的内存页，而内存不够用的时候，就要淘汰一些数据页，空出内存给别的数据页使用。如果淘汰的是“脏页”，就要先将脏页写到磁盘。MySQL空闲。MySQL正常关闭。MySQL正常关闭前会把内存的脏页都flush到磁盘上，这样下次MySQL启动的时候，就可以直接从磁盘上读数据，启动速度会很快。 第一种情况InnoDB要尽量避免，因为出现这种情况整个系统就不能再接受更新了，所有的更新都必须堵住，这时候的更新数会跌为0。
第二种是“内存不够用了，要先将脏页写到磁盘”，这种情况很常见。但是出现以下这两种情况，都是会明显影响性能的：
一个查询要淘汰的脏页个数太多，会导致查询的响应时间明显变长。日志写满，更新全部堵住，写性能跌为0，对于某些业务无法接受。 InnoDB刷脏页的控制策略 首先需要正确地告诉InnoDB所在主机的IO能力，这样InnoDB才能知道需要全力刷脏页的时候可以刷多快。
MySQL5.5版本里，innodb_io_capacity参数可以动态调整刷新脏页的数量，innodb_io_capacity参数默认是200，单位是页。该参数设置的大小取决于硬盘的IOPS，即每秒的输入输出量（或读写次数）。
刷脏页的速度该如何设置呢？
InnoDB的刷盘速度需要参考两个因素：一个是脏页比例，另一个是redo log写盘速度。InnoDB会根据这两个因素先单独算出两个数字。
参数innodb_max_dirty_pages_pct是脏页比例上限，默认值是75%。InnoDB会根据当前的脏页比例（假设为M），算出一个范围在0到100之间的数字，这个计算公式可以记为F1(M)。
InnoDB每次写入的日志都有一个序号，当前写入的序号跟checkpoint对应的序号之间的差值，我们假设为N。InnoDB会根据这个N算出一个范围在0到100之间的数字，这个计算公式可以记为F2(N)（N越大，算出来的值越大）。
取F1(M)和F2(N)最大值R，按照R%的速度刷脏页。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/684dcf17a4a7dac1095b78e08738375c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-08T20:57:03+08:00" />
<meta property="article:modified_time" content="2021-07-08T20:57:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL---脏页机制</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#flush_2" rel="nofollow">flush和脏页</a></li><li><ul><li><a href="#flush_8" rel="nofollow">flush触发条件</a></li><li><a href="#InnoDB_22" rel="nofollow">InnoDB刷脏页的控制策略</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="flush_2"></a>flush和脏页</h2> 
<p>InnoDB在处理更新语句的时候，磁盘操作仅写了redo log日志，同时并更新内存，之后当系统空闲时会把操作记录更新到磁盘里，MySQL把内存里的数据写入磁盘的过程我们称为<strong>flush</strong>。</p> 
<p>当内存数据页跟磁盘数据页内容不一致的时候，我们称这个内存页为“<strong>脏页</strong>”。内存数据写入到磁盘后，内存和磁盘上的数据页的内容一致，称为“<strong>干净页</strong>”。</p> 
<h3><a id="flush_8"></a>flush触发条件</h3> 
<ol><li><strong>InnoDB redo log日志写满</strong>。此时系统会停止所有更新操作，把checkpoint往前推进，为redo log留出空间。 <a href="https://blog.csdn.net/MAKEJAVAMAN/article/details/118342518">MySQL日志—redo log和binlog</a></li><li><strong>系统内存不足</strong>。当需要新的内存页，而内存不够用的时候，就要淘汰一些数据页，空出内存给别的数据页使用。如果淘汰的是“脏页”，就要先将脏页写到磁盘。</li><li><strong>MySQL空闲</strong>。</li><li><strong>MySQL正常关闭</strong>。MySQL正常关闭前会把内存的脏页都flush到磁盘上，这样下次MySQL启动的时候，就可以直接从磁盘上读数据，启动速度会很快。</li></ol> 
<p>第一种情况InnoDB要尽量避免，因为出现这种情况整个系统就不能再接受更新了，所有的更新都必须堵住，这时候的更新数会跌为0。</p> 
<p>第二种是“内存不够用了，要先将脏页写到磁盘”，这种情况很常见。但是出现以下这两种情况，都是会明显影响性能的：</p> 
<ol><li>一个查询要淘汰的脏页个数太多，会导致查询的响应时间明显变长。</li><li>日志写满，更新全部堵住，写性能跌为0，对于某些业务无法接受。</li></ol> 
<h3><a id="InnoDB_22"></a>InnoDB刷脏页的控制策略</h3> 
<p>首先需要正确地告诉InnoDB所在主机的IO能力，这样InnoDB才能知道需要全力刷脏页的时候可以刷多快。</p> 
<p>MySQL5.5版本里，<code>innodb_io_capacity</code>参数可以动态调整刷新脏页的数量，<code>innodb_io_capacity</code>参数默认是<strong>200</strong>，单位是页。该参数设置的大小取决于硬盘的<strong>IOPS</strong>，即每秒的输入输出量（或读写次数）。</p> 
<p><strong>刷脏页的速度该如何设置呢？</strong></p> 
<p>InnoDB的刷盘速度需要参考两个因素：一个是脏页比例，另一个是redo log写盘速度。InnoDB会根据这两个因素先单独算出两个数字。</p> 
<p>参数<code>innodb_max_dirty_pages_pct</code>是脏页比例上限，默认值是75%。InnoDB会根据当前的脏页比例（假设为M），算出一个范围在0到100之间的数字，这个计算公式可以记为F1(M)。</p> 
<p>InnoDB每次写入的日志都有一个序号，当前写入的序号跟checkpoint对应的序号之间的差值，我们假设为N。InnoDB会根据这个N算出一个范围在0到100之间的数字，这个计算公式可以记为F2(N)（N越大，算出来的值越大）。</p> 
<p>取F1(M)和F2(N)最大值R，按照R%的速度刷脏页。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/194b5803485a99a85754e11d4ea718c8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ubuntu下使用yocto制作龙芯文件系统</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/72a3f72e41928994282208cb426f5d08/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">this.$router.options.routes</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>