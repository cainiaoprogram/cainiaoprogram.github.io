<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>最原始版匿名四轴无人机代码注释 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="最原始版匿名四轴无人机代码注释" />
<meta property="og:description" content="基于STM32平台
#include &#34;CONTROL.h&#34; #include &#34;BSP.H&#34; #include &#34;UART2.h&#34; #include &#34;IMU.h&#34; #include &#34;MPU6050.h&#34; #include &#34;MOTO.h&#34; PID PID_ROL,PID_PIT,PID_YAW; u8 ARMED = 0; u16 moto1=0,moto2=0,moto3=0,moto4=0; float Get_MxMi(float num,float max,float min)//将num限制在min与max之间 { if(num&gt;max) return max; else if(num&lt;min) return min; else return num; } //解算出来的自我姿态，根据此得出自稳所需改变角度 //遥控发来的所需要改变的角度以进行倾斜的飞行，进行前进后退或转向 //Q_ANGLE.X , Q_ANGLE.Y, Q_ANGLE.Z, //RC_Target_ROL, RC_Target_PIT, RC_Target_YAW void CONTROL(float rol_now, float pit_now, float yaw_now, float rol_tar, float pit_tar, float yaw_tar) { vs16 throttle; vs16 yaw_d; float rol = rol_tar &#43; rol_now;//将所有要改变的值加起来 float pit = pit_tar &#43; pit_now; float yaw = yaw_tar &#43; yaw_now; throttle = Rc_Get." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/501d6bc6452a15d20e97aad5a6f9f8a0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-29T17:55:28+08:00" />
<meta property="article:modified_time" content="2022-03-29T17:55:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">最原始版匿名四轴无人机代码注释</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>基于STM32平台</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"CONTROL.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"BSP.H"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UART2.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"IMU.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"MPU6050.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"MOTO.h"</span></span>
PID PID_ROL<span class="token punctuation">,</span>PID_PIT<span class="token punctuation">,</span>PID_YAW<span class="token punctuation">;</span>
u8 ARMED <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
u16 moto1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>moto2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>moto3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>moto4<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">float</span> <span class="token function">Get_MxMi</span><span class="token punctuation">(</span><span class="token keyword">float</span> num<span class="token punctuation">,</span><span class="token keyword">float</span> max<span class="token punctuation">,</span><span class="token keyword">float</span> min<span class="token punctuation">)</span><span class="token comment">//将num限制在min与max之间</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>num<span class="token operator">&gt;</span>max<span class="token punctuation">)</span>
        <span class="token keyword">return</span> max<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>num<span class="token operator">&lt;</span>min<span class="token punctuation">)</span>
        <span class="token keyword">return</span> min<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> num<span class="token punctuation">;</span>
<span class="token punctuation">}</span>         <span class="token comment">//解算出来的自我姿态，根据此得出自稳所需改变角度  //遥控发来的所需要改变的角度以进行倾斜的飞行，进行前进后退或转向 </span>
          <span class="token comment">//Q_ANGLE.X ,         Q_ANGLE.Y,     Q_ANGLE.Z, //RC_Target_ROL, RC_Target_PIT, RC_Target_YAW</span>
<span class="token keyword">void</span> <span class="token function">CONTROL</span><span class="token punctuation">(</span><span class="token keyword">float</span> rol_now<span class="token punctuation">,</span> <span class="token keyword">float</span> pit_now<span class="token punctuation">,</span> <span class="token keyword">float</span> yaw_now<span class="token punctuation">,</span>   <span class="token keyword">float</span> rol_tar<span class="token punctuation">,</span> <span class="token keyword">float</span> pit_tar<span class="token punctuation">,</span> <span class="token keyword">float</span> yaw_tar<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    vs16 throttle<span class="token punctuation">;</span>
    vs16 yaw_d<span class="token punctuation">;</span>
    <span class="token keyword">float</span> rol <span class="token operator">=</span> rol_tar <span class="token operator">+</span> rol_now<span class="token punctuation">;</span><span class="token comment">//将所有要改变的值加起来</span>
    <span class="token keyword">float</span> pit <span class="token operator">=</span> pit_tar <span class="token operator">+</span> pit_now<span class="token punctuation">;</span>
    <span class="token keyword">float</span> yaw <span class="token operator">=</span> yaw_tar <span class="token operator">+</span> yaw_now<span class="token punctuation">;</span>

    throttle <span class="token operator">=</span> Rc_Get<span class="token punctuation">.</span>THROTTLE <span class="token operator">-</span> <span class="token number">1000</span><span class="token punctuation">;</span><span class="token comment">//油门，代表电机的转速</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>throttle<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>  throttle<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//消除实际操作误差</span>

    PID_ROL<span class="token punctuation">.</span>IMAX <span class="token operator">=</span> throttle<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">//积分项限幅=throttle的1/2，为什么和throttle有关？</span>
    <span class="token function">Get_MxMi</span><span class="token punctuation">(</span>PID_ROL<span class="token punctuation">.</span>IMAX<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//并将积分项限幅限制在0-1000之间</span>
    PID_PIT<span class="token punctuation">.</span>IMAX <span class="token operator">=</span> PID_ROL<span class="token punctuation">.</span>IMAX<span class="token punctuation">;</span>


    <span class="token comment">/****************************  P比例调节   ***********************************/</span>

    PID_ROL<span class="token punctuation">.</span>pout <span class="token operator">=</span> PID_ROL<span class="token punctuation">.</span>P <span class="token operator">*</span> rol<span class="token punctuation">;</span>
    PID_PIT<span class="token punctuation">.</span>pout <span class="token operator">=</span> PID_PIT<span class="token punctuation">.</span>P <span class="token operator">*</span> pit<span class="token punctuation">;</span>
    PID_YAW<span class="token punctuation">.</span>pout <span class="token operator">=</span> PID_YAW<span class="token punctuation">.</span>P <span class="token operator">*</span> yaw<span class="token punctuation">;</span>

    <span class="token comment">/****************************  I积分调节   **********************************/</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>rol_tar<span class="token operator">*</span>rol_tar<span class="token operator">&lt;</span><span class="token number">0.1</span> <span class="token operator">&amp;&amp;</span> pit_tar<span class="token operator">*</span>pit_tar<span class="token operator">&lt;</span><span class="token number">0.1</span> <span class="token operator">&amp;&amp;</span> rol_now<span class="token operator">*</span>rol_now<span class="token operator">&lt;</span><span class="token number">30</span> <span class="token operator">&amp;&amp;</span> pit_now<span class="token operator">*</span>pit_now<span class="token operator">&lt;</span><span class="token number">30</span> <span class="token operator">&amp;&amp;</span> throttle<span class="token operator">&gt;</span><span class="token number">300</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span><span class="token comment">//target遥控几乎未动，now当前比较接近水平，油门很大</span>

        PID_ROL<span class="token punctuation">.</span>iout <span class="token operator">+=</span> PID_ROL<span class="token punctuation">.</span>I <span class="token operator">*</span> rol<span class="token punctuation">;</span>  
        PID_PIT<span class="token punctuation">.</span>iout <span class="token operator">+=</span> PID_PIT<span class="token punctuation">.</span>I <span class="token operator">*</span> pit<span class="token punctuation">;</span>                                 <span class="token comment">//积分项容易超调</span>
        PID_ROL<span class="token punctuation">.</span>iout <span class="token operator">=</span> <span class="token function">Get_MxMi</span><span class="token punctuation">(</span>PID_ROL<span class="token punctuation">.</span>iout<span class="token punctuation">,</span>PID_ROL<span class="token punctuation">.</span>IMAX<span class="token punctuation">,</span><span class="token operator">-</span>PID_ROL<span class="token punctuation">.</span>IMAX<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//积分项限制在积分项限幅内</span>
        PID_PIT<span class="token punctuation">.</span>iout <span class="token operator">=</span> <span class="token function">Get_MxMi</span><span class="token punctuation">(</span>PID_PIT<span class="token punctuation">.</span>iout<span class="token punctuation">,</span>PID_PIT<span class="token punctuation">.</span>IMAX<span class="token punctuation">,</span><span class="token operator">-</span>PID_PIT<span class="token punctuation">.</span>IMAX<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//防止大角度积累造成积分超调</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>throttle<span class="token operator">&lt;</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token comment">//油门很小不需要积分调节，为什么？</span>
    <span class="token punctuation">{<!-- --></span>
        PID_ROL<span class="token punctuation">.</span>iout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        PID_PIT<span class="token punctuation">.</span>iout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token comment">/***************************  D微分调节  ***********************************/</span> 

    PID_ROL<span class="token punctuation">.</span>dout <span class="token operator">=</span> PID_ROL<span class="token punctuation">.</span>D <span class="token operator">*</span> MPU6050_GYRO_LAST<span class="token punctuation">.</span>X<span class="token punctuation">;</span><span class="token comment">//，飞机头朝X正方向，ROL绕X轴转</span>
    PID_PIT<span class="token punctuation">.</span>dout <span class="token operator">=</span> PID_PIT<span class="token punctuation">.</span>D <span class="token operator">*</span> MPU6050_GYRO_LAST<span class="token punctuation">.</span>Y<span class="token punctuation">;</span><span class="token comment">//6050测得角速度，角度的微分就是角速度</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1480</span><span class="token operator">&gt;</span>Rc_Get<span class="token punctuation">.</span>YAW <span class="token operator">||</span> Rc_Get<span class="token punctuation">.</span>YAW<span class="token operator">&gt;</span><span class="token number">1520</span><span class="token punctuation">)</span><span class="token comment">//YAW的微分调节，1500是什么也不改变的零点值</span>
    <span class="token punctuation">{<!-- --></span>         <span class="token comment">//自己飘的YAW值       //遥控所需要的改变量，*10提高权重,加快响应</span>
        yaw_d <span class="token operator">=</span> MPU6050_GYRO_LAST<span class="token punctuation">.</span>Z <span class="token operator">+</span> <span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>YAW<span class="token operator">-</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">;</span>
        GYRO_I<span class="token punctuation">.</span>Z <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//假设遥控不动的情况下YAW不可能自己飘，没有地磁作参考直接置零算了              </span>
    <span class="token punctuation">}</span>   <span class="token comment">//在IMU的preparedata()中GYRO_I.Z += MPU6050_GYRO_LAST.Z*Gyro_G*0.001;//0.001为dt</span>
                              <span class="token comment">//GYRO_I.Z相当于绕Z轴（即yaw）旋转的总角度</span>
        <span class="token comment">//在IMU的 IMUupdata ()中Q_ANGLE.Z = GYRO_I.Z</span>
    <span class="token keyword">else</span> <span class="token comment">//为什么要分两种情况//遥控的左转右转功能不要了</span>
    yaw_d <span class="token operator">=</span> MPU6050_GYRO_LAST<span class="token punctuation">.</span>Z<span class="token punctuation">;</span><span class="token comment">//很小的遥控改变量就不要了</span>
    PID_YAW<span class="token punctuation">.</span>dout <span class="token operator">=</span> PID_YAW<span class="token punctuation">.</span>D <span class="token operator">*</span> yaw_d<span class="token punctuation">;</span>

    <span class="token comment">/**************************************************************************************/</span>


    PID_ROL<span class="token punctuation">.</span>OUT <span class="token operator">=</span> PID_ROL<span class="token punctuation">.</span>pout <span class="token operator">+</span> PID_ROL<span class="token punctuation">.</span>iout <span class="token operator">+</span> PID_ROL<span class="token punctuation">.</span>dout<span class="token punctuation">;</span><span class="token comment">//最终的输出量</span>
    PID_PIT<span class="token punctuation">.</span>OUT <span class="token operator">=</span> PID_PIT<span class="token punctuation">.</span>pout <span class="token operator">+</span> PID_PIT<span class="token punctuation">.</span>iout <span class="token operator">+</span> PID_PIT<span class="token punctuation">.</span>dout<span class="token punctuation">;</span>
    PID_YAW<span class="token punctuation">.</span>OUT <span class="token operator">=</span> PID_YAW<span class="token punctuation">.</span>pout <span class="token operator">+</span> PID_YAW<span class="token punctuation">.</span>iout <span class="token operator">+</span> PID_YAW<span class="token punctuation">.</span>dout<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>throttle<span class="token operator">&gt;</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token comment">//                                - +                           + +</span>
    <span class="token punctuation">{<!-- --></span>            <span class="token comment">//两正两负，调整roll的话PID_ROL.OUT要 - +,调整pit的话PID_PIT.OUT 要 - -</span>
        moto3<span class="token operator">=</span> throttle <span class="token operator">-</span> PID_ROL<span class="token punctuation">.</span>OUT <span class="token operator">-</span> PID_PIT<span class="token punctuation">.</span>OUT <span class="token operator">+</span> PID_YAW<span class="token punctuation">.</span>OUT<span class="token punctuation">;</span><span class="token comment">//赋给电机值</span>
        moto1<span class="token operator">=</span> throttle <span class="token operator">+</span> PID_ROL<span class="token punctuation">.</span>OUT <span class="token operator">-</span> PID_PIT<span class="token punctuation">.</span>OUT <span class="token operator">-</span> PID_YAW<span class="token punctuation">.</span>OUT<span class="token punctuation">;</span><span class="token comment">//加减号一定两正两负，电机对称</span>
        moto2 <span class="token operator">=</span> throttle <span class="token operator">+</span> PID_ROL<span class="token punctuation">.</span>OUT <span class="token operator">+</span> PID_PIT<span class="token punctuation">.</span>OUT <span class="token operator">+</span> PID_YAW<span class="token punctuation">.</span>OUT<span class="token punctuation">;</span><span class="token comment">//要改，先注释掉其他三个</span>
        moto4<span class="token operator">=</span> throttle <span class="token operator">-</span> PID_ROL<span class="token punctuation">.</span>OUT <span class="token operator">+</span> PID_PIT<span class="token punctuation">.</span>OUT <span class="token operator">-</span> PID_YAW<span class="token punctuation">.</span>OUT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token comment">//定义电机的死区，避免误操作</span>
    <span class="token punctuation">{<!-- --></span>
        moto1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        moto2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        moto3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        moto4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ARMED<span class="token punctuation">)</span>   <span class="token punctuation">{<!-- --></span><span class="token function">PCout</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token function">Moto_PwmRflash</span><span class="token punctuation">(</span>moto1<span class="token punctuation">,</span>moto2<span class="token punctuation">,</span>moto3<span class="token punctuation">,</span>moto4<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//使能电机</span>
    <span class="token keyword">else</span>            <span class="token punctuation">{<!-- --></span><span class="token function">PCout</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">Moto_PwmRflash</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"imu.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"MPU6050.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"math.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RtA</span>         <span class="token expression"><span class="token number">57.324841</span>               </span><span class="token comment">//弧度到角度</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AtR</span>     <span class="token expression"><span class="token number">0.0174533</span>               </span><span class="token comment">//度到角度</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Acc_G</span>   <span class="token expression"><span class="token number">0.0011963</span>               </span><span class="token comment">//加速度变成G</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Gyro_G</span>  <span class="token expression"><span class="token number">0.0610351</span>               </span><span class="token comment">//角速度变成度   此参数对应陀螺2000度每秒</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Gyro_Gr</span> <span class="token expression"><span class="token number">0.0010653</span>               </span><span class="token comment">//角速度变成弧度   此参数对应陀螺2000度每秒</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FILTER_NUM</span> <span class="token expression"><span class="token number">20</span></span></span>

S_INT16_XYZ ACC_AVG<span class="token punctuation">;</span>            <span class="token comment">//平均值滤波后的ACC</span>
S_FLOAT_XYZ GYRO_I<span class="token punctuation">;</span>             <span class="token comment">//陀螺仪积分</span>
S_FLOAT_XYZ EXP_ANGLE<span class="token punctuation">;</span>      <span class="token comment">//期望角度</span>
S_FLOAT_XYZ DIF_ANGLE<span class="token punctuation">;</span>      <span class="token comment">//期望角度与实际角度差</span>
S_FLOAT_XYZ Q_ANGLE<span class="token punctuation">;</span>            <span class="token comment">//四元数计算出的角度</span>

<span class="token class-name">int16_t</span> ACC_X_BUF<span class="token punctuation">[</span>FILTER_NUM<span class="token punctuation">]</span><span class="token punctuation">,</span>ACC_Y_BUF<span class="token punctuation">[</span>FILTER_NUM<span class="token punctuation">]</span><span class="token punctuation">,</span>ACC_Z_BUF<span class="token punctuation">[</span>FILTER_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//加速度滑动窗口滤波数组</span>
<span class="token comment">//filter是滤波的意思</span>
<span class="token keyword">void</span> <span class="token function">Prepare_Data</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> filter_cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">int32_t</span> temp1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>temp2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>temp3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> i<span class="token punctuation">;</span>

    <span class="token function">MPU6050_Read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPU6050_Dataanl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ACC_X_BUF<span class="token punctuation">[</span>filter_cnt<span class="token punctuation">]</span> <span class="token operator">=</span> MPU6050_ACC_LAST<span class="token punctuation">.</span>X<span class="token punctuation">;</span><span class="token comment">//更新滑动窗口数组</span>
    ACC_Y_BUF<span class="token punctuation">[</span>filter_cnt<span class="token punctuation">]</span> <span class="token operator">=</span> MPU6050_ACC_LAST<span class="token punctuation">.</span>Y<span class="token punctuation">;</span>
    ACC_Z_BUF<span class="token punctuation">[</span>filter_cnt<span class="token punctuation">]</span> <span class="token operator">=</span> MPU6050_ACC_LAST<span class="token punctuation">.</span>Z<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>FILTER_NUM<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        temp1 <span class="token operator">+=</span> ACC_X_BUF<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        temp2 <span class="token operator">+=</span> ACC_Y_BUF<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        temp3 <span class="token operator">+=</span> ACC_Z_BUF<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ACC_AVG<span class="token punctuation">.</span>X <span class="token operator">=</span> temp1 <span class="token operator">/</span> FILTER_NUM<span class="token punctuation">;</span>
    ACC_AVG<span class="token punctuation">.</span>Y <span class="token operator">=</span> temp2 <span class="token operator">/</span> FILTER_NUM<span class="token punctuation">;</span>
    ACC_AVG<span class="token punctuation">.</span>Z <span class="token operator">=</span> temp3 <span class="token operator">/</span> FILTER_NUM<span class="token punctuation">;</span>
    filter_cnt<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>filter_cnt<span class="token operator">==</span>FILTER_NUM<span class="token punctuation">)</span>  filter_cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">//GYRO_I.X += MPU6050_GYRO_LAST.X*Gyro_G*0.001;//0.001是时间间隔,两次prepare的执行周期</span>
    <span class="token comment">//GYRO_I.Y += MPU6050_GYRO_LAST.Y*Gyro_G*0.001;//这里已经使用四元数进行结算，因此不用直接累加</span>
    GYRO_I<span class="token punctuation">.</span>Z <span class="token operator">+=</span> MPU6050_GYRO_LAST<span class="token punctuation">.</span>Z<span class="token operator">*</span>Gyro_G<span class="token operator">*</span><span class="token number">0.001</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Get_Attitude</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">IMUupdate</span><span class="token punctuation">(</span>MPU6050_GYRO_LAST<span class="token punctuation">.</span>X<span class="token operator">*</span>Gyro_Gr<span class="token punctuation">,</span>
                        MPU6050_GYRO_LAST<span class="token punctuation">.</span>Y<span class="token operator">*</span>Gyro_Gr<span class="token punctuation">,</span>
                        MPU6050_GYRO_LAST<span class="token punctuation">.</span>Z<span class="token operator">*</span>Gyro_Gr<span class="token punctuation">,</span>
                        ACC_AVG<span class="token punctuation">.</span>X<span class="token punctuation">,</span>ACC_AVG<span class="token punctuation">.</span>Y<span class="token punctuation">,</span>ACC_AVG<span class="token punctuation">.</span>Z<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//*0.0174转成弧度=π%180</span>
<span class="token punctuation">}</span>
<span class="token comment"></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Kp</span> <span class="token expression"><span class="token number">10.0f</span>                        </span><span class="token comment">// proportional gain governs rate of convergence to accelerometer/magnetometer</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Ki</span> <span class="token expression"><span class="token number">0.008f</span>                          </span><span class="token comment">// integral gain governs rate of convergence of gyroscope biases</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">halfT</span> <span class="token expression"><span class="token number">0.001f</span>                   </span><span class="token comment">// half the sample period采样周期的一半</span></span>

<span class="token keyword">float</span> q0 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> q1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> q2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> q3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// quaternion elements representing the estimated orientation</span>
<span class="token keyword">float</span> exInt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> eyInt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ezInt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// scaled integral error</span>
<span class="token keyword">void</span> <span class="token function">IMUupdate</span><span class="token punctuation">(</span><span class="token keyword">float</span> gx<span class="token punctuation">,</span> <span class="token keyword">float</span> gy<span class="token punctuation">,</span> <span class="token keyword">float</span> gz<span class="token punctuation">,</span> <span class="token keyword">float</span> ax<span class="token punctuation">,</span> <span class="token keyword">float</span> ay<span class="token punctuation">,</span> <span class="token keyword">float</span> az<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">float</span> norm<span class="token punctuation">;</span>
<span class="token comment">//  float hx, hy, hz, bx, bz;</span>
  <span class="token keyword">float</span> vx<span class="token punctuation">,</span> vy<span class="token punctuation">,</span> vz<span class="token punctuation">;</span><span class="token comment">// wx, wy, wz;</span>
  <span class="token keyword">float</span> ex<span class="token punctuation">,</span> ey<span class="token punctuation">,</span> ez<span class="token punctuation">;</span>

  <span class="token comment">// 先把这些用得到的值算好</span>
  <span class="token keyword">float</span> q0q0 <span class="token operator">=</span> q0<span class="token operator">*</span>q0<span class="token punctuation">;</span>
  <span class="token keyword">float</span> q0q1 <span class="token operator">=</span> q0<span class="token operator">*</span>q1<span class="token punctuation">;</span>
  <span class="token keyword">float</span> q0q2 <span class="token operator">=</span> q0<span class="token operator">*</span>q2<span class="token punctuation">;</span>
<span class="token comment">//  float q0q3 = q0*q3;</span>
  <span class="token keyword">float</span> q1q1 <span class="token operator">=</span> q1<span class="token operator">*</span>q1<span class="token punctuation">;</span>
<span class="token comment">//  float q1q2 = q1*q2;</span>
  <span class="token keyword">float</span> q1q3 <span class="token operator">=</span> q1<span class="token operator">*</span>q3<span class="token punctuation">;</span>
  <span class="token keyword">float</span> q2q2 <span class="token operator">=</span> q2<span class="token operator">*</span>q2<span class="token punctuation">;</span>
  <span class="token keyword">float</span> q2q3 <span class="token operator">=</span> q2<span class="token operator">*</span>q3<span class="token punctuation">;</span>
  <span class="token keyword">float</span> q3q3 <span class="token operator">=</span> q3<span class="token operator">*</span>q3<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ax<span class="token operator">*</span>ay<span class="token operator">*</span>az<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

  norm <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>ax<span class="token operator">*</span>ax <span class="token operator">+</span> ay<span class="token operator">*</span>ay <span class="token operator">+</span> az<span class="token operator">*</span>az<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//acc数据归一化</span>
  ax <span class="token operator">=</span> ax <span class="token operator">/</span>norm<span class="token punctuation">;</span>
  ay <span class="token operator">=</span> ay <span class="token operator">/</span> norm<span class="token punctuation">;</span>
  az <span class="token operator">=</span> az <span class="token operator">/</span> norm<span class="token punctuation">;</span>

  <span class="token comment">// estimated direction of gravity and flux (v and w)              估计重力方向和流量/变迁</span>
  vx <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span><span class="token punctuation">(</span>q1q3 <span class="token operator">-</span> q0q2<span class="token punctuation">)</span><span class="token punctuation">;</span>                                             <span class="token comment">//四元素中xyz的表示</span>
  vy <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span><span class="token punctuation">(</span>q0q1 <span class="token operator">+</span> q2q3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  vz <span class="token operator">=</span> q0q0 <span class="token operator">-</span> q1q1 <span class="token operator">-</span> q2q2 <span class="token operator">+</span> q3q3 <span class="token punctuation">;</span>

  <span class="token comment">// error is sum of cross product between reference direction of fields and direction measured by sensors</span>
  ex <span class="token operator">=</span> <span class="token punctuation">(</span>ay<span class="token operator">*</span>vz <span class="token operator">-</span> az<span class="token operator">*</span>vy<span class="token punctuation">)</span> <span class="token punctuation">;</span>                                             <span class="token comment">//向量外积在相减得到差分就是误差</span>
  ey <span class="token operator">=</span> <span class="token punctuation">(</span>az<span class="token operator">*</span>vx <span class="token operator">-</span> ax<span class="token operator">*</span>vz<span class="token punctuation">)</span> <span class="token punctuation">;</span>
  ez <span class="token operator">=</span> <span class="token punctuation">(</span>ax<span class="token operator">*</span>vy <span class="token operator">-</span> ay<span class="token operator">*</span>vx<span class="token punctuation">)</span> <span class="token punctuation">;</span>

  exInt <span class="token operator">=</span> exInt <span class="token operator">+</span> ex <span class="token operator">*</span> Ki<span class="token punctuation">;</span>                                <span class="token comment">//对误差进行积分</span>
  eyInt <span class="token operator">=</span> eyInt <span class="token operator">+</span> ey <span class="token operator">*</span> Ki<span class="token punctuation">;</span>
  ezInt <span class="token operator">=</span> ezInt <span class="token operator">+</span> ez <span class="token operator">*</span> Ki<span class="token punctuation">;</span>

  <span class="token comment">// adjusted gyroscope measurements</span>
  gx <span class="token operator">=</span> gx <span class="token operator">+</span> Kp<span class="token operator">*</span>ex <span class="token operator">+</span> exInt<span class="token punctuation">;</span>                                              <span class="token comment">//将误差PI后补偿到陀螺仪，即补偿零点漂移</span>
  gy <span class="token operator">=</span> gy <span class="token operator">+</span> Kp<span class="token operator">*</span>ey <span class="token operator">+</span> eyInt<span class="token punctuation">;</span>
  gz <span class="token operator">=</span> gz <span class="token operator">+</span> Kp<span class="token operator">*</span>ez <span class="token operator">+</span> ezInt<span class="token punctuation">;</span>                                          <span class="token comment">//这里的gz由于没有观测者进行矫正会产生漂移，表现出来的就是积分自增或自减</span>

  <span class="token comment">// integrate quaternion rate and normalise                           //四元素的微分方程</span>
  q0 <span class="token operator">=</span> q0 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">-</span>q1<span class="token operator">*</span>gx <span class="token operator">-</span> q2<span class="token operator">*</span>gy <span class="token operator">-</span> q3<span class="token operator">*</span>gz<span class="token punctuation">)</span><span class="token operator">*</span>halfT<span class="token punctuation">;</span>
  q1 <span class="token operator">=</span> q1 <span class="token operator">+</span> <span class="token punctuation">(</span>q0<span class="token operator">*</span>gx <span class="token operator">+</span> q2<span class="token operator">*</span>gz <span class="token operator">-</span> q3<span class="token operator">*</span>gy<span class="token punctuation">)</span><span class="token operator">*</span>halfT<span class="token punctuation">;</span>
  q2 <span class="token operator">=</span> q2 <span class="token operator">+</span> <span class="token punctuation">(</span>q0<span class="token operator">*</span>gy <span class="token operator">-</span> q1<span class="token operator">*</span>gz <span class="token operator">+</span> q3<span class="token operator">*</span>gx<span class="token punctuation">)</span><span class="token operator">*</span>halfT<span class="token punctuation">;</span>
  q3 <span class="token operator">=</span> q3 <span class="token operator">+</span> <span class="token punctuation">(</span>q0<span class="token operator">*</span>gz <span class="token operator">+</span> q1<span class="token operator">*</span>gy <span class="token operator">-</span> q2<span class="token operator">*</span>gx<span class="token punctuation">)</span><span class="token operator">*</span>halfT<span class="token punctuation">;</span>

  <span class="token comment">// normalise quaternion</span>
  norm <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>q0<span class="token operator">*</span>q0 <span class="token operator">+</span> q1<span class="token operator">*</span>q1 <span class="token operator">+</span> q2<span class="token operator">*</span>q2 <span class="token operator">+</span> q3<span class="token operator">*</span>q3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  q0 <span class="token operator">=</span> q0 <span class="token operator">/</span> norm<span class="token punctuation">;</span>
  q1 <span class="token operator">=</span> q1 <span class="token operator">/</span> norm<span class="token punctuation">;</span>
  q2 <span class="token operator">=</span> q2 <span class="token operator">/</span> norm<span class="token punctuation">;</span>
  q3 <span class="token operator">=</span> q3 <span class="token operator">/</span> norm<span class="token punctuation">;</span>

  Q_ANGLE<span class="token punctuation">.</span>Z <span class="token operator">=</span> GYRO_I<span class="token punctuation">.</span>Z<span class="token punctuation">;</span><span class="token comment">//atan2(2 * q1 * q2 + 2 * q0 * q3, -2 * q2*q2 - 2 * q3* q3 + 1)* 57.3; // yaw</span>
  Q_ANGLE<span class="token punctuation">.</span>Y <span class="token operator">=</span> <span class="token function">asin</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span> <span class="token operator">*</span> q1 <span class="token operator">*</span> q3 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> q0<span class="token operator">*</span> q2<span class="token punctuation">)</span><span class="token operator">*</span> <span class="token number">57.3</span><span class="token punctuation">;</span> <span class="token comment">// pitch</span>
  Q_ANGLE<span class="token punctuation">.</span>X <span class="token operator">=</span> <span class="token function">atan2</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> q2 <span class="token operator">*</span> q3 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> q0 <span class="token operator">*</span> q1<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span> <span class="token operator">*</span> q1 <span class="token operator">*</span> q1 <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> q2<span class="token operator">*</span> q2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span> <span class="token number">57.3</span><span class="token punctuation">;</span> <span class="token comment">// roll</span>
<span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"MOTO.h"</span></span>

<span class="token class-name">int16_t</span> MOTO1_PWM <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name">int16_t</span> MOTO2_PWM <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name">int16_t</span> MOTO3_PWM <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name">int16_t</span> MOTO4_PWM <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Moto_PwmRflash</span><span class="token punctuation">(</span><span class="token class-name">int16_t</span> MOTO1_PWM<span class="token punctuation">,</span><span class="token class-name">int16_t</span> MOTO2_PWM<span class="token punctuation">,</span><span class="token class-name">int16_t</span> MOTO3_PWM<span class="token punctuation">,</span><span class="token class-name">int16_t</span> MOTO4_PWM<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>       
    <span class="token keyword">if</span><span class="token punctuation">(</span>MOTO1_PWM<span class="token operator">&gt;</span>Moto_PwmMax<span class="token punctuation">)</span>   MOTO1_PWM <span class="token operator">=</span> Moto_PwmMax<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>MOTO2_PWM<span class="token operator">&gt;</span>Moto_PwmMax<span class="token punctuation">)</span>   MOTO2_PWM <span class="token operator">=</span> Moto_PwmMax<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>MOTO3_PWM<span class="token operator">&gt;</span>Moto_PwmMax<span class="token punctuation">)</span>   MOTO3_PWM <span class="token operator">=</span> Moto_PwmMax<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>MOTO4_PWM<span class="token operator">&gt;</span>Moto_PwmMax<span class="token punctuation">)</span>   MOTO4_PWM <span class="token operator">=</span> Moto_PwmMax<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>MOTO1_PWM<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> MOTO1_PWM <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>MOTO2_PWM<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> MOTO2_PWM <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>MOTO3_PWM<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> MOTO3_PWM <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>MOTO4_PWM<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> MOTO4_PWM <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    TIM4<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span>MOTO1_PWM<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCR2 <span class="token operator">=</span> MOTO2_PWM<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCR3 <span class="token operator">=</span> MOTO3_PWM<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCR4 <span class="token operator">=</span> MOTO4_PWM<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Tim4_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    TIM_TimeBaseInitTypeDef     TIM_TimeBaseStructure<span class="token punctuation">;</span>
    TIM_OCInitTypeDef               TIM_OCInitStructure<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> PrescalerValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/* -----------------------------------------------------------------------
    TIM3 Configuration（配置）: generate 4 PWM signals with 4 different duty cycles（占空比）:
    The TIM3CLK frequency（频率） is set to SystemCoreClock (Hz), to get TIM3 counter
    clock at 24 MHz the Prescaler is computed(计算） as following:
    - Prescaler = (TIM3CLK / TIM3 counter clock) - 1
    SystemCoreClock is set to 72 MHz for Low-density（密度）, Medium-density, High-density
    and Connectivity（连通性） line devices and to 24 MHz for Low-Density Value line and
    Medium-Density Value line devices

    The TIM3 is running at 36 KHz: TIM3 Frequency = TIM3 counter clock/(ARR + 1)
    = 24 MHz / 1000 = 24 KHz
    TIM3 Channel1 duty cycle = (TIM3_CCR1/ TIM3_ARR)* 100 = 50%
    TIM3 Channel2 duty cycle = (TIM3_CCR2/ TIM3_ARR)* 100 = 37.5%
    TIM3 Channel3 duty cycle = (TIM3_CCR3/ TIM3_ARR)* 100 = 25%
    TIM3 Channel4 duty cycle = (TIM3_CCR4/ TIM3_ARR)* 100 = 12.5%
    ----------------------------------------------------------------------- */</span>
    <span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_TIM4<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//TIM3和TIM4同在APB1时钟下</span>
    <span class="token comment">/* Compute the prescaler value */</span>
    PrescalerValue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>SystemCoreClock <span class="token operator">/</span> <span class="token number">24000000</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">/* Time base configuration */</span>
    TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_Period <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span>     <span class="token comment">//计数上线  ，CNT=999时中断计数器并结束一个周期，进行下一个从零开始的周期</span>
    TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_Prescaler <span class="token operator">=</span> PrescalerValue<span class="token punctuation">;</span>   <span class="token comment">//pwm时钟分频 72MHz多大分频分成24MHz</span>
    TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_ClockDivision <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    
    TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_CounterMode <span class="token operator">=</span> TIM_CounterMode_Up<span class="token punctuation">;</span>     <span class="token comment">//向上计数</span>
    <span class="token function">TIM_TimeBaseInit</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_TimeBaseStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* PWM1 Mode configuration: Channel */</span>
    TIM_OCInitStructure<span class="token punctuation">.</span>TIM_OCMode <span class="token operator">=</span> TIM_OCMode_PWM1<span class="token punctuation">;</span><span class="token comment">//CNT&lt;CCR1时为有效电平</span>
    TIM_OCInitStructure<span class="token punctuation">.</span>TIM_OutputState <span class="token operator">=</span> TIM_OutputState_Enable<span class="token punctuation">;</span>
    TIM_OCInitStructure<span class="token punctuation">.</span>TIM_Pulse <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//初始占空比为0</span>
    TIM_OCInitStructure<span class="token punctuation">.</span>TIM_OCPolarity <span class="token operator">=</span> TIM_OCPolarity_High<span class="token punctuation">;</span><span class="token comment">//低电平有效</span>
    <span class="token function">TIM_OC1Init</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_OCInitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM_OC1PreloadConfig</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> TIM_OCPreload_Enable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM_OC2Init</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_OCInitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM_OC2PreloadConfig</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> TIM_OCPreload_Enable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM_OC3Init</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_OCInitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM_OC3PreloadConfig</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> TIM_OCPreload_Enable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM_OC4Init</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_OCInitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM_OC4PreloadConfig</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> TIM_OCPreload_Enable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM_ARRPreloadConfig</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">Moto_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
    <span class="token comment">//使能电机用的时钟</span>
    <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOB <span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">//设置电机使用到得管脚</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_9 <span class="token operator">|</span> GPIO_Pin_6 <span class="token operator">|</span> GPIO_Pin_7 <span class="token operator">|</span> GPIO_Pin_8 <span class="token punctuation">;</span> 
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span> 
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF_PP<span class="token punctuation">;</span> 
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Tim4_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"MPU6050.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Tim.h"</span></span>

u8                      mpu6050_buffer<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                 <span class="token comment">//iic读取后存放数据</span>
S_INT16_XYZ     GYRO_OFFSET<span class="token punctuation">,</span>ACC_OFFSET<span class="token punctuation">;</span>         <span class="token comment">//零漂</span>
u8                      GYRO_OFFSET_OK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
u8                      ACC_OFFSET_OK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
S_INT16_XYZ     MPU6050_ACC_LAST<span class="token punctuation">,</span>MPU6050_GYRO_LAST<span class="token punctuation">;</span>     <span class="token comment">//最新一次读取值</span>



<span class="token comment">/**************************实现函数*****************************************************

将iic读取到得数据分拆,放入相应寄存器

如果上位机要计算零漂，便发回OFFSET数据
****************************************************************************************/</span>

<span class="token keyword">void</span> <span class="token function">MPU6050_Dataanl</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>GYRO_OFFSET_OK<span class="token punctuation">)</span><span class="token comment">//没有计算零偏,一开始不会计算零漂，</span>
                       <span class="token comment">//只有上位机将GYRO_OFFSET_OK置零后才将其置零</span>
    <span class="token punctuation">{<!-- --></span>                   
        <span class="token keyword">static</span> <span class="token class-name">int32_t</span>  tempgx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>tempgy<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>tempgz<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> cnt_g<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//      LED1_ON;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_g<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            GYRO_OFFSET<span class="token punctuation">.</span>X<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            GYRO_OFFSET<span class="token punctuation">.</span>Y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            GYRO_OFFSET<span class="token punctuation">.</span>Z<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            tempgx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            tempgy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            tempgz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            cnt_g <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        tempgx<span class="token operator">+=</span> MPU6050_GYRO_LAST<span class="token punctuation">.</span>X<span class="token punctuation">;</span>
        tempgy<span class="token operator">+=</span> MPU6050_GYRO_LAST<span class="token punctuation">.</span>Y<span class="token punctuation">;</span>
        tempgz<span class="token operator">+=</span> MPU6050_GYRO_LAST<span class="token punctuation">.</span>Z<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_g<span class="token operator">==</span><span class="token number">200</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            GYRO_OFFSET<span class="token punctuation">.</span>X<span class="token operator">=</span>tempgx<span class="token operator">/</span>cnt_g<span class="token punctuation">;</span><span class="token comment">//累加200次取平均值</span>
            GYRO_OFFSET<span class="token punctuation">.</span>Y<span class="token operator">=</span>tempgy<span class="token operator">/</span>cnt_g<span class="token punctuation">;</span>
            GYRO_OFFSET<span class="token punctuation">.</span>Z<span class="token operator">=</span>tempgz<span class="token operator">/</span>cnt_g<span class="token punctuation">;</span>
            cnt_g <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            GYRO_OFFSET_OK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//          EE_SAVE_GYRO_OFFSET();//保存数据</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        cnt_g<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ACC_OFFSET_OK<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">static</span> <span class="token class-name">int32_t</span>  tempax<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>tempay<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>tempaz<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> cnt_a<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//      LED1_ON;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_a<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            ACC_OFFSET<span class="token punctuation">.</span>X <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            ACC_OFFSET<span class="token punctuation">.</span>Y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            ACC_OFFSET<span class="token punctuation">.</span>Z <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            tempax <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            tempay <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            tempaz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            cnt_a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        tempax<span class="token operator">+=</span> MPU6050_ACC_LAST<span class="token punctuation">.</span>X<span class="token punctuation">;</span>
        tempay<span class="token operator">+=</span> MPU6050_ACC_LAST<span class="token punctuation">.</span>Y<span class="token punctuation">;</span>
        <span class="token comment">//tempaz+= MPU6050_ACC_LAST.Z;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_a<span class="token operator">==</span><span class="token number">200</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            ACC_OFFSET<span class="token punctuation">.</span>X<span class="token operator">=</span>tempax<span class="token operator">/</span>cnt_a<span class="token punctuation">;</span>
            ACC_OFFSET<span class="token punctuation">.</span>Y<span class="token operator">=</span>tempay<span class="token operator">/</span>cnt_a<span class="token punctuation">;</span>
            ACC_OFFSET<span class="token punctuation">.</span>Z<span class="token operator">=</span>tempaz<span class="token operator">/</span>cnt_a<span class="token punctuation">;</span>
            cnt_a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            ACC_OFFSET_OK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//          EE_SAVE_ACC_OFFSET();//保存数据</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        cnt_a<span class="token operator">++</span><span class="token punctuation">;</span>        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*****************  底层的读取MPU6050_ACC_LAST,MPU6050_GYRO_LAST  数据  *****************/</span>
<span class="token keyword">void</span> <span class="token function">MPU6050_Read</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
      <span class="token function">MPU_Get_Accelerometer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>MPU6050_ACC_LAST<span class="token punctuation">.</span>X <span class="token punctuation">,</span><span class="token operator">&amp;</span>MPU6050_ACC_LAST<span class="token punctuation">.</span>Y <span class="token punctuation">,</span><span class="token operator">&amp;</span>MPU6050_ACC_LAST<span class="token punctuation">.</span>Z <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//得到加速度传感器数据</span>
            <span class="token function">MPU_Get_Gyroscope</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>MPU6050_GYRO_LAST<span class="token punctuation">.</span>X <span class="token punctuation">,</span><span class="token operator">&amp;</span>MPU6050_GYRO_LAST<span class="token punctuation">.</span>Y <span class="token punctuation">,</span><span class="token operator">&amp;</span>MPU6050_GYRO_LAST<span class="token punctuation">.</span>Z <span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//得到陀螺仪数据</span>
<span class="token punctuation">}</span>

<span class="token comment">/************************** 初始化     MPU6050 以进入可用状态  *****************************/</span>

u8 <span class="token function">MPU6050_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
    u8 res<span class="token punctuation">;</span> 
    <span class="token function">MPU_IIC_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化IIC总线</span>
    <span class="token function">MPU_Write_Byte</span><span class="token punctuation">(</span>MPU_PWR_MGMT1_REG<span class="token punctuation">,</span><span class="token number">0X80</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//复位MPU6050</span>
 <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPU_Write_Byte</span><span class="token punctuation">(</span>MPU_PWR_MGMT1_REG<span class="token punctuation">,</span><span class="token number">0X00</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//唤醒MPU6050 </span>
    <span class="token function">MPU_Set_Gyro_Fsr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//陀螺仪传感器,±2000dps</span>
    <span class="token function">MPU_Set_Accel_Fsr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">//加速度传感器,±2g</span>
    <span class="token function">MPU_Set_Rate</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">//设置采样率50Hz</span>
    <span class="token function">MPU_Write_Byte</span><span class="token punctuation">(</span>MPU_INT_EN_REG<span class="token punctuation">,</span><span class="token number">0X00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//关闭所有中断</span>
    <span class="token function">MPU_Write_Byte</span><span class="token punctuation">(</span>MPU_USER_CTRL_REG<span class="token punctuation">,</span><span class="token number">0X00</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//I2C主模式关闭</span>
    <span class="token function">MPU_Write_Byte</span><span class="token punctuation">(</span>MPU_FIFO_EN_REG<span class="token punctuation">,</span><span class="token number">0X00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//关闭FIFO</span>
    <span class="token function">MPU_Write_Byte</span><span class="token punctuation">(</span>MPU_INTBP_CFG_REG<span class="token punctuation">,</span><span class="token number">0X80</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//INT引脚低电平有效</span>


    res<span class="token operator">=</span><span class="token function">MPU_Read_Byte</span><span class="token punctuation">(</span>MPU_DEVICE_ID_REG<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">==</span>MPU_ADDR<span class="token punctuation">)</span><span class="token comment">//器件ID正确</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">MPU_Write_Byte</span><span class="token punctuation">(</span>MPU_PWR_MGMT1_REG<span class="token punctuation">,</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置CLKSEL,PLL X轴为参考</span>
        <span class="token function">MPU_Write_Byte</span><span class="token punctuation">(</span>MPU_PWR_MGMT2_REG<span class="token punctuation">,</span><span class="token number">0X00</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//加速度与陀螺仪都工作</span>
        <span class="token function">MPU_Set_Rate</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">//设置采样率为50Hz</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**********************   设置MPU6050的传感器   ********************************/</span>

<span class="token comment">//陀螺仪传感器满量程范围</span>
<span class="token comment">//fsr:0,±250dps;1,±500dps;2,±1000dps;3,±2000dps</span>
<span class="token comment">//返回值:0,设置成功</span>
<span class="token comment">//    其他,设置失败 </span>
u8 <span class="token function">MPU_Set_Gyro_Fsr</span><span class="token punctuation">(</span>u8 fsr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">MPU_Write_Byte</span><span class="token punctuation">(</span>MPU_GYRO_CFG_REG<span class="token punctuation">,</span>fsr<span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置陀螺仪满量程范围  </span>
<span class="token punctuation">}</span>
<span class="token comment">//设置MPU6050加速度传感器满量程范围</span>
<span class="token comment">//fsr:0,±2g;1,±4g;2,±8g;3,±16g</span>
<span class="token comment">//返回值:0,设置成功</span>
<span class="token comment">//    其他,设置失败 </span>
u8 <span class="token function">MPU_Set_Accel_Fsr</span><span class="token punctuation">(</span>u8 fsr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">MPU_Write_Byte</span><span class="token punctuation">(</span>MPU_ACCEL_CFG_REG<span class="token punctuation">,</span>fsr<span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置加速度传感器满量程范围  </span>
<span class="token punctuation">}</span>
<span class="token comment">//设置MPU6050的数字低通滤波器</span>
<span class="token comment">//lpf:数字低通滤波频率(Hz)</span>
<span class="token comment">//返回值:0,设置成功</span>
<span class="token comment">//    其他,设置失败 </span>
u8 <span class="token function">MPU_Set_LPF</span><span class="token punctuation">(</span>u16 lpf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 data<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>lpf<span class="token operator">&gt;=</span><span class="token number">188</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lpf<span class="token operator">&gt;=</span><span class="token number">98</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lpf<span class="token operator">&gt;=</span><span class="token number">42</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lpf<span class="token operator">&gt;=</span><span class="token number">20</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lpf<span class="token operator">&gt;=</span><span class="token number">10</span><span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> data<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">;</span> 
    <span class="token keyword">return</span> <span class="token function">MPU_Write_Byte</span><span class="token punctuation">(</span>MPU_CFG_REG<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置数字低通滤波器  </span>
<span class="token punctuation">}</span>
<span class="token comment">//设置MPU6050的采样率(假定Fs=1KHz)</span>
<span class="token comment">//rate:4~1000(Hz)</span>
<span class="token comment">//返回值:0,设置成功</span>
<span class="token comment">//    其他,设置失败 </span>
u8 <span class="token function">MPU_Set_Rate</span><span class="token punctuation">(</span>u16 rate<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 data<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rate<span class="token operator">&gt;</span><span class="token number">1000</span><span class="token punctuation">)</span>rate<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rate<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">)</span>rate<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
    data<span class="token operator">=</span><span class="token number">1000</span><span class="token operator">/</span>rate<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    data<span class="token operator">=</span><span class="token function">MPU_Write_Byte</span><span class="token punctuation">(</span>MPU_SAMPLE_RATE_REG<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//设置数字低通滤波器</span>
    <span class="token keyword">return</span> <span class="token function">MPU_Set_LPF</span><span class="token punctuation">(</span>rate<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//自动设置LPF为采样率的一半</span>
<span class="token punctuation">}</span>



<span class="token comment">/***********************  读取六轴以及温度原始数据,并减去零偏  **************************/</span>
<span class="token comment">//得到温度值</span>
<span class="token comment">//返回值:温度值(扩大了100倍)</span>
<span class="token keyword">short</span> <span class="token function">MPU_Get_Temperature</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
    <span class="token keyword">short</span> raw<span class="token punctuation">;</span>
    <span class="token keyword">float</span> temp<span class="token punctuation">;</span>
    <span class="token function">MPU_Read_Len</span><span class="token punctuation">(</span>MPU_ADDR<span class="token punctuation">,</span>MPU_TEMP_OUTH_REG<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    raw<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token punctuation">)</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
    temp<span class="token operator">=</span><span class="token number">36.53</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>raw<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">340</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> temp<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//得到陀螺仪值(原始值)</span>
<span class="token comment">//gx,gy,gz:陀螺仪x,y,z轴的原始读数(带符号)</span>
<span class="token comment">//返回值:0,成功</span>
<span class="token comment">//    其他,错误代码</span>
u8 <span class="token function">MPU_Get_Gyroscope</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span>gx<span class="token punctuation">,</span><span class="token keyword">short</span> <span class="token operator">*</span>gy<span class="token punctuation">,</span><span class="token keyword">short</span> <span class="token operator">*</span>gz<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>res<span class="token punctuation">;</span>  
    res<span class="token operator">=</span><span class="token function">MPU_Read_Len</span><span class="token punctuation">(</span>MPU_ADDR<span class="token punctuation">,</span>MPU_GYRO_XOUTH_REG<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>gx<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token punctuation">)</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span>GYRO_OFFSET<span class="token punctuation">.</span>X<span class="token punctuation">;</span>  
        <span class="token operator">*</span>gy<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token punctuation">)</span>buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span>GYRO_OFFSET<span class="token punctuation">.</span>Y<span class="token punctuation">;</span>  
        <span class="token operator">*</span>gz<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token punctuation">)</span>buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span>GYRO_OFFSET<span class="token punctuation">.</span>Z<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   
    <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//得到加速度值(原始值)</span>
<span class="token comment">//gx,gy,gz:陀螺仪x,y,z轴的原始读数(带符号)</span>
<span class="token comment">//返回值:0,成功</span>
<span class="token comment">//    其他,错误代码</span>
u8 <span class="token function">MPU_Get_Accelerometer</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span>ax<span class="token punctuation">,</span><span class="token keyword">short</span> <span class="token operator">*</span>ay<span class="token punctuation">,</span><span class="token keyword">short</span> <span class="token operator">*</span>az<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>res<span class="token punctuation">;</span>  
    res<span class="token operator">=</span><span class="token function">MPU_Read_Len</span><span class="token punctuation">(</span>MPU_ADDR<span class="token punctuation">,</span>MPU_ACCEL_XOUTH_REG<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>ax<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token punctuation">)</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span>ACC_OFFSET<span class="token punctuation">.</span>X<span class="token punctuation">;</span>  
        <span class="token operator">*</span>ay<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token punctuation">)</span>buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span>ACC_OFFSET<span class="token punctuation">.</span>Y<span class="token punctuation">;</span>  
        <span class="token operator">*</span>az<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token punctuation">)</span>buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span>ACC_OFFSET<span class="token punctuation">.</span>Z<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   
    <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/***************************  IIC读写器件寄存器函数  ******************************************/</span>
<span class="token comment">//IIC连续写</span>
<span class="token comment">//addr:器件地址 </span>
<span class="token comment">//reg:寄存器地址</span>
<span class="token comment">//len:写入长度</span>
<span class="token comment">//buf:数据区</span>
<span class="token comment">//返回值:0,正常</span>
<span class="token comment">//    其他,错误代码</span>
u8 <span class="token function">MPU_Write_Len</span><span class="token punctuation">(</span>u8 addr<span class="token punctuation">,</span>u8 reg<span class="token punctuation">,</span>u8 len<span class="token punctuation">,</span>u8 <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 i<span class="token punctuation">;</span> 
    <span class="token function">MPU_IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">MPU_IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送器件地址+写命令 </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">MPU_IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//等待应答</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">MPU_IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>       
    <span class="token punctuation">}</span>
    <span class="token function">MPU_IIC_Send_Byte</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//写寄存器地址</span>
    <span class="token function">MPU_IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//等待应答</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">MPU_IIC_Send_Byte</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//发送数据</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">MPU_IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment">//等待ACK</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">MPU_IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>       
    <span class="token punctuation">}</span>    
    <span class="token function">MPU_IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span> 
<span class="token comment">//IIC连续读</span>
<span class="token comment">//addr:器件地址</span>
<span class="token comment">//reg:要读取的寄存器地址</span>
<span class="token comment">//len:要读取的长度</span>
<span class="token comment">//buf:读取到的数据存储区</span>
<span class="token comment">//返回值:0,正常</span>
<span class="token comment">//    其他,错误代码</span>
u8 <span class="token function">MPU_Read_Len</span><span class="token punctuation">(</span>u8 addr<span class="token punctuation">,</span>u8 reg<span class="token punctuation">,</span>u8 len<span class="token punctuation">,</span>u8 <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token function">MPU_IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">MPU_IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送器件地址+写命令 </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">MPU_IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//等待应答</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">MPU_IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>       
    <span class="token punctuation">}</span>
    <span class="token function">MPU_IIC_Send_Byte</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//写寄存器地址</span>
    <span class="token function">MPU_IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//等待应答</span>
    <span class="token function">MPU_IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPU_IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送器件地址+读命令 </span>
    <span class="token function">MPU_IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//等待应答 </span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>                                     <span class="token comment">//可以连续读取6各数据，而不用写6个寄存器地址</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>buf<span class="token operator">=</span><span class="token function">MPU_IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读数据,发送nACK,直到此时读取完毕 </span>
        <span class="token keyword">else</span> <span class="token operator">*</span>buf<span class="token operator">=</span><span class="token function">MPU_IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//读数据,发送ACK,接着读取下一个地址的寄存器中的数据  </span>
        len<span class="token operator">--</span><span class="token punctuation">;</span>
        buf<span class="token operator">++</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>    
    <span class="token function">MPU_IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//产生一个停止条件 </span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
<span class="token comment">//IIC写一个字节 </span>
<span class="token comment">//reg:寄存器地址</span>
<span class="token comment">//data:数据</span>
<span class="token comment">//返回值:0,正常</span>
<span class="token comment">//    其他,错误代码</span>
u8 <span class="token function">MPU_Write_Byte</span><span class="token punctuation">(</span>u8 reg<span class="token punctuation">,</span>u8 data<span class="token punctuation">)</span>                
<span class="token punctuation">{<!-- --></span> 
    <span class="token function">MPU_IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">MPU_IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>MPU_ADDR<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送器件地址+写命令 </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">MPU_IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//等待应答</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">MPU_IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>       
    <span class="token punctuation">}</span>
    <span class="token function">MPU_IIC_Send_Byte</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//写寄存器地址</span>
    <span class="token function">MPU_IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//等待应答 </span>
    <span class="token function">MPU_IIC_Send_Byte</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送数据</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">MPU_IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//等待ACK</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">MPU_IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>        
    <span class="token punctuation">}</span>        
    <span class="token function">MPU_IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//IIC读一个字节 </span>
<span class="token comment">//reg:寄存器地址 </span>
<span class="token comment">//返回值:读到的数据</span>
u8 <span class="token function">MPU_Read_Byte</span><span class="token punctuation">(</span>u8 reg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 res<span class="token punctuation">;</span>
    <span class="token function">MPU_IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">MPU_IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>MPU_ADDR<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送器件地址+写命令 </span>
    <span class="token function">MPU_IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//等待应答 </span>
    <span class="token function">MPU_IIC_Send_Byte</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//写寄存器地址</span>
    <span class="token function">MPU_IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//等待应答</span>
    <span class="token function">MPU_IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPU_IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>MPU_ADDR<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送器件地址+读命令 </span>
    <span class="token function">MPU_IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//等待应答 </span>
    res<span class="token operator">=</span><span class="token function">MPU_IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取数据,发送nACK </span>
    <span class="token function">MPU_IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//产生一个停止条件 </span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>     
<span class="token punctuation">}</span>




</code></pre> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"MPU6050iic.h"</span></span>

<span class="token comment">/*******************************   延时函数   *************************************/</span>

<span class="token keyword">static</span> u8  fac_us<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//us延时倍乘数</span>
<span class="token keyword">static</span> u16 fac_ms<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//ms延时倍乘数</span>
<span class="token keyword">void</span> <span class="token function">delay_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    
<span class="token punctuation">{<!-- --></span>
    <span class="token function">SysTick_CLKSourceConfig</span><span class="token punctuation">(</span>SysTick_CLKSource_HCLK_Div8<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//选择外部时钟  HCLK/8</span>
    fac_us<span class="token operator">=</span>SystemCoreClock<span class="token operator">/</span><span class="token number">8000000</span><span class="token punctuation">;</span> <span class="token comment">//为系统时钟的1/8  </span>
        fac_ms<span class="token operator">=</span><span class="token punctuation">(</span>u16<span class="token punctuation">)</span>fac_us<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span><span class="token comment">//非ucos下,代表每个ms需要的systick时钟数 </span>
<span class="token punctuation">}</span>                                   
<span class="token keyword">void</span> <span class="token function">delay_ms</span><span class="token punctuation">(</span>u16 nms<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>                 
    u32 temp<span class="token punctuation">;</span>          
    SysTick<span class="token operator">-&gt;</span>LOAD<span class="token operator">=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>nms<span class="token operator">*</span>fac_ms<span class="token punctuation">;</span><span class="token comment">//时间加载(SysTick-&gt;LOAD为24bit)</span>
    SysTick<span class="token operator">-&gt;</span>VAL <span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span>           <span class="token comment">//清空计数器</span>
    SysTick<span class="token operator">-&gt;</span>CTRL<span class="token operator">|=</span>SysTick_CTRL_ENABLE_Msk <span class="token punctuation">;</span>          <span class="token comment">//开始倒数  </span>
    <span class="token keyword">do</span>
    <span class="token punctuation">{<!-- --></span>
        temp<span class="token operator">=</span>SysTick<span class="token operator">-&gt;</span>CTRL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>temp<span class="token operator">&amp;</span><span class="token number">0x01</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token punctuation">(</span>temp<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待时间到达   </span>
    SysTick<span class="token operator">-&gt;</span>CTRL<span class="token operator">&amp;=</span><span class="token operator">~</span>SysTick_CTRL_ENABLE_Msk<span class="token punctuation">;</span>       <span class="token comment">//关闭计数器</span>
    SysTick<span class="token operator">-&gt;</span>VAL <span class="token operator">=</span><span class="token number">0X00</span><span class="token punctuation">;</span>       <span class="token comment">//清空计数器           </span>
<span class="token punctuation">}</span> 

<span class="token comment">//MPU IIC 延时函数</span>
<span class="token keyword">void</span> <span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token comment">//2us</span>
<span class="token punctuation">{<!-- --></span>
    u32 temp<span class="token punctuation">;</span>
  <span class="token function">SysTick_CLKSourceConfig</span><span class="token punctuation">(</span>SysTick_CLKSource_HCLK_Div8<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//选择外部时钟  HCLK/8</span>
    SysTick<span class="token operator">-&gt;</span>LOAD<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>fac_us<span class="token punctuation">;</span> <span class="token comment">//时间加载,2us           </span>
    SysTick<span class="token operator">-&gt;</span>VAL<span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span>        <span class="token comment">//清空计数器</span>
    SysTick<span class="token operator">-&gt;</span>CTRL<span class="token operator">|=</span>SysTick_CTRL_ENABLE_Msk <span class="token punctuation">;</span>          <span class="token comment">//开始倒数     </span>
    <span class="token keyword">do</span>
    <span class="token punctuation">{<!-- --></span>
        temp<span class="token operator">=</span>SysTick<span class="token operator">-&gt;</span>CTRL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>temp<span class="token operator">&amp;</span><span class="token number">0x01</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token punctuation">(</span>temp<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待时间到达   </span>
    SysTick<span class="token operator">-&gt;</span>CTRL<span class="token operator">&amp;=</span><span class="token operator">~</span>SysTick_CTRL_ENABLE_Msk<span class="token punctuation">;</span>       <span class="token comment">//关闭计数器</span>
    SysTick<span class="token operator">-&gt;</span>VAL <span class="token operator">=</span><span class="token number">0X00</span><span class="token punctuation">;</span>       <span class="token comment">//清空计数器    </span>
<span class="token punctuation">}</span>

<span class="token comment">/*******************************   初始化IIC的IO口   ***************************************/</span>

<span class="token keyword">void</span> <span class="token function">MPU_IIC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>                        
  GPIO_InitTypeDef  GPIO_InitStructure<span class="token punctuation">;</span>

    <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOB<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先使能外设IO PORTC时钟 </span>

  GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_10<span class="token operator">|</span>GPIO_Pin_11<span class="token punctuation">;</span>     <span class="token comment">// 端口配置</span>
  GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span>       <span class="token comment">//推挽输出，可输出高低电平，连接数字器件</span>
  GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>      <span class="token comment">//IO口速度为50MHz</span>
  <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//根据设定参数初始化GPIO </span>

  <span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span>GPIO_Pin_10<span class="token operator">|</span>GPIO_Pin_11<span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">//PB10,PB11 输出高    </span>

<span class="token punctuation">}</span>

<span class="token comment">/***************************  IIC底层读写的时序函数  **************************************/</span>

<span class="token comment">//产生IIC起始信号</span>
<span class="token keyword">void</span> <span class="token function">MPU_IIC_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">MPU_SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//sda线输出</span>
    MPU_IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        
    MPU_IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MPU_IIC_SDA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//START:when CLK is high,DATA change form high to low </span>
    <span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MPU_IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//钳住I2C总线，准备发送或接收数据 </span>
<span class="token punctuation">}</span>     
<span class="token comment">//产生IIC停止信号</span>
<span class="token keyword">void</span> <span class="token function">MPU_IIC_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">MPU_SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//sda线输出</span>
    MPU_IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    MPU_IIC_SDA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//STOP:when CLK is high DATA change form low to high</span>
    <span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MPU_IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>  
    MPU_IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//发送I2C总线结束信号</span>
    <span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                
<span class="token punctuation">}</span>
<span class="token comment">//等待应答信号到来</span>
<span class="token comment">//返回值：1，接收应答失败</span>
<span class="token comment">//        0，接收应答成功</span>
u8 <span class="token function">MPU_IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 ucErrTime<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">MPU_SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//SDA设置为输入  </span>
    MPU_IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
    MPU_IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token keyword">while</span><span class="token punctuation">(</span>MPU_READ_SDA<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ucErrTime<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ucErrTime<span class="token operator">&gt;</span><span class="token number">250</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">MPU_IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    MPU_IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//时钟输出0      </span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span> 
<span class="token comment">//产生ACK应答</span>
<span class="token keyword">void</span> <span class="token function">MPU_IIC_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    MPU_IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">MPU_SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MPU_IIC_SDA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MPU_IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MPU_IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//不产生ACK应答          </span>
<span class="token keyword">void</span> <span class="token function">MPU_IIC_NAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    MPU_IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">MPU_SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MPU_IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MPU_IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MPU_IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>                                        
<span class="token comment">//IIC发送一个字节</span>
<span class="token comment">//返回从机有无应答</span>
<span class="token comment">//1，有应答</span>
<span class="token comment">//0，无应答           </span>
<span class="token keyword">void</span> <span class="token function">MPU_IIC_Send_Byte</span><span class="token punctuation">(</span>u8 txd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>                        
    u8 t<span class="token punctuation">;</span>   
    <span class="token function">MPU_SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
    MPU_IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//拉低时钟开始数据传输</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>              
        MPU_IIC_SDA<span class="token operator">=</span><span class="token punctuation">(</span>txd<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span>
        txd<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>      
        MPU_IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        MPU_IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>  
        <span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>       
<span class="token comment">//读1个字节，ack=1时，发送ACK，ack=0，发送nACK   </span>
u8 <span class="token function">MPU_IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> ack<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span>receive<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">MPU_SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SDA设置为输入</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        MPU_IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MPU_IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        receive<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>MPU_READ_SDA<span class="token punctuation">)</span>receive<span class="token operator">++</span><span class="token punctuation">;</span>   
        <span class="token function">MPU_IIC_Delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>                    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ack<span class="token punctuation">)</span>
        <span class="token function">MPU_IIC_NAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送nACK</span>
    <span class="token keyword">else</span>
        <span class="token function">MPU_IIC_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//发送ACK   </span>
    <span class="token keyword">return</span> receive<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"BSP.h"</span></span>
<span class="token comment">//#include "app/uart/uart1.h"</span>
<span class="token comment">//#include "app/imu/imu.h"</span>
<span class="token comment">//#include "app/control/control.h"</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BYTE0</span><span class="token expression"><span class="token punctuation">(</span>dwTemp<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dwTemp<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BYTE1</span><span class="token expression"><span class="token punctuation">(</span>dwTemp<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dwTemp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BYTE2</span><span class="token expression"><span class="token punctuation">(</span>dwTemp<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dwTemp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BYTE3</span><span class="token expression"><span class="token punctuation">(</span>dwTemp<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dwTemp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RX_DR</span>           <span class="token expression"><span class="token number">6</span>       </span><span class="token comment">//中断标志</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TX_DS</span>           <span class="token expression"><span class="token number">5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_RT</span>      <span class="token expression"><span class="token number">4</span></span></span>

RC_GETDATA Rc_Get<span class="token punctuation">;</span><span class="token comment">//接收到的RC数据,1000~2000</span>
<span class="token keyword">float</span> RC_Target_ROL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>RC_Target_PIT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>RC_Target_YAW<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">RC_FUN</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">//判断解锁</span>
    <span class="token keyword">static</span> u16 _armed_cnt1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>_armed_cnt2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ARMED<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> Rc_Get<span class="token punctuation">.</span>THROTTLE <span class="token operator">&lt;</span> <span class="token number">1100</span> <span class="token operator">&amp;&amp;</span> Rc_Get<span class="token punctuation">.</span>YAW <span class="token operator">&lt;</span><span class="token number">1100</span><span class="token punctuation">)</span>
        _armed_cnt1<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        _armed_cnt1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>_armed_cnt1<span class="token operator">&gt;</span><span class="token number">100</span><span class="token punctuation">)</span> ARMED <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>          <span class="token comment">//解锁</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ARMED<span class="token operator">==</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> Rc_Get<span class="token punctuation">.</span>THROTTLE <span class="token operator">&lt;</span><span class="token number">1100</span> <span class="token operator">&amp;&amp;</span> Rc_Get<span class="token punctuation">.</span>YAW <span class="token operator">&gt;</span><span class="token number">1900</span><span class="token punctuation">)</span>
        _armed_cnt2<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        _armed_cnt2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>_armed_cnt2<span class="token operator">&gt;</span><span class="token number">100</span><span class="token punctuation">)</span> ARMED <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">HC05_DataAnl</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">31</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        sum <span class="token operator">+=</span> NRF24L01_RXDATA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>sum<span class="token operator">==</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token keyword">return</span><span class="token punctuation">;</span>     <span class="token comment">//判断sum，校验和</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0x8A</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token keyword">return</span><span class="token punctuation">;</span>     <span class="token comment">//判断帧头</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0x8A</span><span class="token punctuation">)</span>                                <span class="token comment">//判断功能字,=0x8a,为遥控数据</span>
    <span class="token punctuation">{<!-- --></span>
        Rc_Get<span class="token punctuation">.</span>THROTTLE <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//数据合并,一次接受八位数据，</span>
        Rc_Get<span class="token punctuation">.</span>YAW          <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//但是需要合成16位</span>
        Rc_Get<span class="token punctuation">.</span>ROLL         <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        Rc_Get<span class="token punctuation">.</span>PITCH        <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        Rc_Get<span class="token punctuation">.</span>AUX1         <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        Rc_Get<span class="token punctuation">.</span>AUX2         <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        Rc_Get<span class="token punctuation">.</span>AUX3         <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        Rc_Get<span class="token punctuation">.</span>AUX4         <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        Rc_Get<span class="token punctuation">.</span>AUX5         <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">RC_FUN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        RC_Target_ROL <span class="token operator">=</span> <span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>ROLL<span class="token operator">-</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">30</span><span class="token punctuation">;</span>     <span class="token comment">//一打摇杆偏得很可以将30改大</span>
        RC_Target_PIT <span class="token operator">=</span> <span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>PITCH<span class="token operator">-</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">30</span><span class="token punctuation">;</span>
        RC_Target_YAW <span class="token operator">=</span> <span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>YAW<span class="token operator">-</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">30</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0X8B</span><span class="token punctuation">)</span>                                <span class="token comment">//判断功能字,=0x8B,为控制数据</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xAA</span><span class="token punctuation">)</span>    <span class="token comment">//校准传感器</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xA2</span><span class="token punctuation">)</span>    GYRO_OFFSET_OK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xA1</span><span class="token punctuation">)</span>    ACC_OFFSET_OK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xA3</span><span class="token punctuation">)</span>    <span class="token punctuation">{<!-- --></span>GYRO_OFFSET_OK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>ACC_OFFSET_OK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xA0</span><span class="token punctuation">)</span>    <span class="token punctuation">{<!-- --></span>ARMED <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token function">NRF_Send_ARMED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xA1</span><span class="token punctuation">)</span>    <span class="token punctuation">{<!-- --></span>ARMED <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token function">NRF_Send_ARMED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xAB</span><span class="token punctuation">)</span>    <span class="token comment">//接收OFFSET</span>
        <span class="token punctuation">{<!-- --></span>
            ACC_OFFSET<span class="token punctuation">.</span>X <span class="token operator">=</span> <span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            ACC_OFFSET<span class="token punctuation">.</span>Y <span class="token operator">=</span> <span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">EE_SAVE_ACC_OFFSET</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//EE_SAVE_GYRO_OFFSET();</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xAC</span><span class="token punctuation">)</span>    <span class="token function">NRF_Send_OFFSET</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xAD</span><span class="token punctuation">)</span>    <span class="token function">NRF_Send_PID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xAE</span><span class="token punctuation">)</span>    <span class="token comment">//接收PID</span>
        <span class="token punctuation">{<!-- --></span>
            PID_ROL<span class="token punctuation">.</span>P <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>
            PID_ROL<span class="token punctuation">.</span>I <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>
            PID_ROL<span class="token punctuation">.</span>D <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>
            PID_PIT<span class="token punctuation">.</span>P <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>
            PID_PIT<span class="token punctuation">.</span>I <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>
            PID_PIT<span class="token punctuation">.</span>D <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>
            PID_YAW<span class="token punctuation">.</span>P <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>
            PID_YAW<span class="token punctuation">.</span>I <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>
            PID_YAW<span class="token punctuation">.</span>D <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>NRF24L01_RXDATA<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>
            <span class="token function">EE_SAVE_PID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Nrf_Check_Event</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 sta <span class="token operator">=</span> <span class="token function">NRF_Read_Reg</span><span class="token punctuation">(</span>NRF_READ_REG <span class="token operator">+</span> NRFRegSTATUS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取状态寄存器</span>
    <span class="token comment"></span>
    <span class="token comment"></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sta <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>RX_DR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//检验sta是不是接收中断</span>
    <span class="token punctuation">{<!-- --></span>
        u8 rx_len <span class="token operator">=</span> <span class="token function">NRF_Read_Reg</span><span class="token punctuation">(</span>R_RX_PL_WID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>rx_len<span class="token operator">&lt;</span><span class="token number">33</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">NRF_Read_Buf</span><span class="token punctuation">(</span>RD_RX_PLOAD<span class="token punctuation">,</span>NRF24L01_RXDATA<span class="token punctuation">,</span>RX_PLOAD_WIDTH<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// read receive payload from RX_FIFO buffer</span>
            <span class="token function">NRF_DataAnl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//进行数据分析</span>
            <span class="token function">LED1_ONOFF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token comment">//当前数据有误 </span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">NRF_Write_Reg</span><span class="token punctuation">(</span>FLUSH_RX<span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清空缓冲区</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment"></span>
    <span class="token comment"></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sta <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>TX_DS<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LED1_ONOFF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment"></span>
    <span class="token comment"></span>
    <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> led2_state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sta <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>MAX_RT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//??????????</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>led2_state<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            LED2_OFF<span class="token punctuation">;</span>
            led2_state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            LED2_ON<span class="token punctuation">;</span>
            led2_state <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>sta <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span>  <span class="token comment">//TX FIFO FULL</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">NRF_Write_Reg</span><span class="token punctuation">(</span>FLUSH_TX<span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment"></span>
    <span class="token comment"></span>
    <span class="token function">NRF_Write_Reg</span><span class="token punctuation">(</span>NRF_WRITE_REG <span class="token operator">+</span> NRFRegSTATUS<span class="token punctuation">,</span> sta<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">NRF_Send_AF</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> i<span class="token punctuation">,</span>sum<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> _temp<span class="token punctuation">;</span>

    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x88</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xAF</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x1C</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>MPU6050_ACC_LAST<span class="token punctuation">.</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>MPU6050_ACC_LAST<span class="token punctuation">.</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>MPU6050_ACC_LAST<span class="token punctuation">.</span>Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>MPU6050_ACC_LAST<span class="token punctuation">.</span>Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>MPU6050_ACC_LAST<span class="token punctuation">.</span>Z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>MPU6050_ACC_LAST<span class="token punctuation">.</span>Z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>MPU6050_GYRO_LAST<span class="token punctuation">.</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>MPU6050_GYRO_LAST<span class="token punctuation">.</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>MPU6050_GYRO_LAST<span class="token punctuation">.</span>Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>MPU6050_GYRO_LAST<span class="token punctuation">.</span>Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>MPU6050_GYRO_LAST<span class="token punctuation">.</span>Z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>MPU6050_GYRO_LAST<span class="token punctuation">.</span>Z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    _temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Q_ANGLE<span class="token punctuation">.</span>X<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Q_ANGLE<span class="token punctuation">.</span>Y<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Q_ANGLE<span class="token punctuation">.</span>Z<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ARMED<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>                NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xA0</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ARMED<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>       NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xA1</span><span class="token punctuation">;</span>

    sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">31</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        sum <span class="token operator">+=</span> NRF24L01_TXDATA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token operator">=</span>sum<span class="token punctuation">;</span>

    <span class="token function">NRF_TxPacket</span><span class="token punctuation">(</span>NRF24L01_TXDATA<span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">NRF_Send_AE</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> i<span class="token punctuation">,</span>sum<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> _temp<span class="token punctuation">;</span>

    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x88</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xAE</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x1C</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>THROTTLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>THROTTLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>YAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>YAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>ROLL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>ROLL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>PITCH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>PITCH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>AUX1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>AUX1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>AUX2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>AUX2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>AUX3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>AUX3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>AUX4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>AUX4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>AUX5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>AUX5<span class="token punctuation">)</span><span class="token punctuation">;</span>

    _temp <span class="token operator">=</span> TIM2<span class="token operator">-&gt;</span>CCR1<span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _temp <span class="token operator">=</span> TIM2<span class="token operator">-&gt;</span>CCR2<span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _temp <span class="token operator">=</span> TIM2<span class="token operator">-&gt;</span>CCR3<span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _temp <span class="token operator">=</span> TIM2<span class="token operator">-&gt;</span>CCR4<span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    _temp <span class="token operator">=</span> ADC_ConvertedValue<span class="token operator">/</span><span class="token number">6</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">31</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        sum <span class="token operator">+=</span> NRF24L01_TXDATA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token operator">=</span>sum<span class="token punctuation">;</span>

    <span class="token function">NRF_TxPacket</span><span class="token punctuation">(</span>NRF24L01_TXDATA<span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">NRF_Send_OFFSET</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> i<span class="token punctuation">,</span>sum<span class="token punctuation">;</span>

    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x88</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xAC</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x1C</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xAC</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>ACC_OFFSET<span class="token punctuation">.</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>ACC_OFFSET<span class="token punctuation">.</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>ACC_OFFSET<span class="token punctuation">.</span>Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>ACC_OFFSET<span class="token punctuation">.</span>Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>ACC_OFFSET<span class="token punctuation">.</span>Z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>ACC_OFFSET<span class="token punctuation">.</span>Z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>GYRO_OFFSET<span class="token punctuation">.</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>GYRO_OFFSET<span class="token punctuation">.</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>GYRO_OFFSET<span class="token punctuation">.</span>Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>GYRO_OFFSET<span class="token punctuation">.</span>Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>GYRO_OFFSET<span class="token punctuation">.</span>Z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>GYRO_OFFSET<span class="token punctuation">.</span>Z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">31</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        sum <span class="token operator">+=</span> NRF24L01_TXDATA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token operator">=</span>sum<span class="token punctuation">;</span>

    <span class="token function">NRF_TxPacket</span><span class="token punctuation">(</span>NRF24L01_TXDATA<span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">NRF_Send_PID</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> i<span class="token punctuation">,</span>sum<span class="token punctuation">;</span>
    u16 _temp<span class="token punctuation">;</span>

    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x88</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xAC</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x1C</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xAD</span><span class="token punctuation">;</span>

    _temp <span class="token operator">=</span> PID_ROL<span class="token punctuation">.</span>P <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _temp <span class="token operator">=</span> PID_ROL<span class="token punctuation">.</span>I <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _temp <span class="token operator">=</span> PID_ROL<span class="token punctuation">.</span>D <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _temp <span class="token operator">=</span> PID_PIT<span class="token punctuation">.</span>P <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _temp <span class="token operator">=</span> PID_PIT<span class="token punctuation">.</span>I <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _temp <span class="token operator">=</span> PID_PIT<span class="token punctuation">.</span>D <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _temp <span class="token operator">=</span> PID_YAW<span class="token punctuation">.</span>P <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _temp <span class="token operator">=</span> PID_YAW<span class="token punctuation">.</span>I <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _temp <span class="token operator">=</span> PID_YAW<span class="token punctuation">.</span>D <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">31</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        sum <span class="token operator">+=</span> NRF24L01_TXDATA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token operator">=</span>sum<span class="token punctuation">;</span>

    <span class="token function">NRF_TxPacket</span><span class="token punctuation">(</span>NRF24L01_TXDATA<span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">NRF_Send_ARMED</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token comment">//解锁信息</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> i<span class="token punctuation">,</span>sum<span class="token punctuation">;</span>

    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x88</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xAC</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x1C</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ARMED<span class="token punctuation">)</span>   NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xA1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>            NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xA0</span><span class="token punctuation">;</span>
    sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">31</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        sum <span class="token operator">+=</span> NRF24L01_TXDATA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token operator">=</span>sum<span class="token punctuation">;</span>

    <span class="token function">NRF_TxPacket</span><span class="token punctuation">(</span>NRF24L01_TXDATA<span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">NRF_SEND_test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 sum<span class="token punctuation">;</span>

    <span class="token keyword">static</span> u8 temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    temp<span class="token operator">++</span><span class="token punctuation">;</span>

    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x88</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xA1</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">28</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE3</span><span class="token punctuation">(</span>Q_ANGLE<span class="token punctuation">.</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE2</span><span class="token punctuation">(</span>Q_ANGLE<span class="token punctuation">.</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE1</span><span class="token punctuation">(</span>Q_ANGLE<span class="token punctuation">.</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">BYTE0</span><span class="token punctuation">(</span>Q_ANGLE<span class="token punctuation">.</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>

    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span>temp<span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span>u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">31</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        sum <span class="token operator">+=</span> NRF24L01_TXDATA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    NRF24L01_TXDATA<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token operator">=</span>sum<span class="token punctuation">;</span>

    <span class="token function">NRF_TxPacket</span><span class="token punctuation">(</span>NRF24L01_TXDATA<span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UART2.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"CONTROL.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Uart1.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"MPU6050iic.h"</span></span>

RC_GETDATA Rc_Get<span class="token punctuation">;</span><span class="token comment">//接收到的RC数据,1000~2000</span>
<span class="token keyword">float</span> RC_Target_ROL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>RC_Target_PIT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>RC_Target_YAW<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> arm<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">/************************* 飞控与手机APP的通讯 **************************************/</span>

                      <span class="token comment">/*********串口2的初始化函数***********/</span>

<span class="token keyword">void</span> <span class="token function">Uart2_Init</span><span class="token punctuation">(</span>u32 br_num<span class="token punctuation">)</span><span class="token comment">//时钟低电平活动，禁用了同步通讯,因此只有Uart，即只是异步通讯</span>
<span class="token punctuation">{<!-- --></span>
    USART_InitTypeDef USART_InitStructure<span class="token punctuation">;</span>
    USART_ClockInitTypeDef USART_ClockInitStruct<span class="token punctuation">;</span>
    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>

    <span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_USART2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开启USART1时钟</span>
    <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOA<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>    

    <span class="token comment">//配置PA2作为USART1　Tx</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span>  GPIO_Pin_2<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF_PP<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA <span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//配置PA3作为USART1　Rx</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span>  GPIO_Pin_3<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_IN_FLOATING<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA <span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//配置USART1</span>
    <span class="token comment">//中断被屏蔽了</span>
    USART_InitStructure<span class="token punctuation">.</span>USART_BaudRate <span class="token operator">=</span> br_num<span class="token punctuation">;</span>       <span class="token comment">//波特率可以通过地面站配置</span>
    USART_InitStructure<span class="token punctuation">.</span>USART_WordLength <span class="token operator">=</span> USART_WordLength_8b<span class="token punctuation">;</span>  <span class="token comment">//8位数据</span>
    USART_InitStructure<span class="token punctuation">.</span>USART_StopBits <span class="token operator">=</span> USART_StopBits_1<span class="token punctuation">;</span>   <span class="token comment">//在帧结尾传输1个停止位</span>
    USART_InitStructure<span class="token punctuation">.</span>USART_Parity <span class="token operator">=</span> USART_Parity_No<span class="token punctuation">;</span>    <span class="token comment">//禁用奇偶校验</span>
    USART_InitStructure<span class="token punctuation">.</span>USART_HardwareFlowControl <span class="token operator">=</span> USART_HardwareFlowControl_None<span class="token punctuation">;</span> <span class="token comment">//硬件流控制失能</span>
    USART_InitStructure<span class="token punctuation">.</span>USART_Mode <span class="token operator">=</span> USART_Mode_Tx <span class="token operator">|</span> USART_Mode_Rx<span class="token punctuation">;</span>  <span class="token comment">//发送、接收使能</span>
    <span class="token comment">//配置USART1时钟</span>
    USART_ClockInitStruct<span class="token punctuation">.</span>USART_Clock <span class="token operator">=</span> USART_Clock_Disable<span class="token punctuation">;</span>  <span class="token comment">//时钟低电平活动</span>
    USART_ClockInitStruct<span class="token punctuation">.</span>USART_CPOL <span class="token operator">=</span> USART_CPOL_Low<span class="token punctuation">;</span>  <span class="token comment">//SLCK引脚上时钟输出的极性-&gt;低电平</span>
    USART_ClockInitStruct<span class="token punctuation">.</span>USART_CPHA <span class="token operator">=</span> USART_CPHA_2Edge<span class="token punctuation">;</span>  <span class="token comment">//时钟第二个边沿进行数据捕获</span>
    USART_ClockInitStruct<span class="token punctuation">.</span>USART_LastBit <span class="token operator">=</span> USART_LastBit_Disable<span class="token punctuation">;</span> <span class="token comment">//最后一位数据的时钟脉冲不从SCLK输出</span>

    <span class="token function">USART_Init</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>USART_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">USART_ClockInit</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>USART_ClockInitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//使能USART1接收中断</span>
    <span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//使能USART1</span>
    <span class="token function">USART_Cmd</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>                    



<span class="token class-name">uint8_t</span> Tx2Buffer<span class="token punctuation">[</span><span class="token number">0xff</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
u8 Tx2Counter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
u8 count2<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">;</span> 
u8 Rx2_Buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//两个32字节的串口接收缓存</span>
u8 Rx2_Act<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>       <span class="token comment">//正在使用的buf号</span>
u8 Rx2_Adr<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>       <span class="token comment">//正在接收第几字节</span>
u8 Rx2_Ok0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
u8 Rx2_Ok1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>


<span class="token comment">/**************************串口1的收发中断********************************************/</span>

<span class="token keyword">void</span> <span class="token function">Uart2_IRQ</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token comment">//与PC上位机的通讯</span>
<span class="token punctuation">{<!-- --></span> 
    u8 com_data<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>USART2<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_IT_ORE<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
         com_data<span class="token operator">=</span>USART2<span class="token operator">-&gt;</span>SR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
               <span class="token comment">/****************接收中断 (接收寄存器非空)************/</span> 

    <span class="token comment">//接收中断 (接收寄存器非空) </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">USART_GetITStatus</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>    
    <span class="token punctuation">{<!-- --></span>   
        arm<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">//别忘了，只要接收到数据就是解锁（即APP连接了蓝牙）</span>
         com_data <span class="token operator">=</span> USART2<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Rx2_Adr<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>      <span class="token comment">//寻找帧头0X8A</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>com_data<span class="token operator">==</span><span class="token number">0xAA</span><span class="token punctuation">)</span>  <span class="token comment">//接收数据如果是0X8A,则写入缓存</span>
            <span class="token punctuation">{<!-- --></span>

                Rx2_Buf<span class="token punctuation">[</span>Rx2_Act<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> com_data<span class="token punctuation">;</span>
                Rx2_Adr <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>        <span class="token comment">//正在接收数据</span>
        <span class="token punctuation">{<!-- --></span>
            Rx2_Buf<span class="token punctuation">[</span>Rx2_Act<span class="token punctuation">]</span><span class="token punctuation">[</span>Rx2_Adr<span class="token punctuation">]</span> <span class="token operator">=</span> com_data<span class="token punctuation">;</span>
            Rx2_Adr <span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">if</span><span class="token punctuation">(</span>Rx2_Adr<span class="token operator">==</span><span class="token number">25</span><span class="token punctuation">)</span>     <span class="token comment">//数据接收完毕//如果adr等于了32,</span>
                                         <span class="token comment">//那么这次act=0的数据接收完成，切换缓存到act=1；</span>
        <span class="token punctuation">{<!-- --></span>

            Rx2_Adr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>Rx2_Act<span class="token punctuation">)</span> 
            <span class="token punctuation">{<!-- --></span> 
                Rx2_Ok1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment">//标志act=1的数组接收完成</span>
                Rx2_Act <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token comment">//切换缓存，去接收act=0的数组</span>

            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>                
            <span class="token punctuation">{<!-- --></span>
                Rx2_Act <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                Rx2_Ok0 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

        <span class="token function">USART_ClearITPendingBit</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span>USART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清除接收中断标志位</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>


<span class="token comment">/**********************************串口接收的缓存数据de分析*********************************/</span>
<span class="token keyword">void</span> <span class="token function">Uart2_DataAnl</span><span class="token punctuation">(</span>u8 buf_num<span class="token punctuation">)</span>      <span class="token comment">//</span>
<span class="token punctuation">{<!-- --></span>

    u8 sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0xAF</span><span class="token punctuation">)</span>       <span class="token keyword">return</span><span class="token punctuation">;</span>     <span class="token comment">//检验第二位是不是AF</span>




    <span class="token keyword">if</span><span class="token punctuation">(</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token comment">//下面进行对遥控数据的处理,应该在Uart2蓝牙  //判断功能字,=0x,为遥控数据</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">24</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token comment">//判断校验字节是否正确</span>
      sum <span class="token operator">+=</span> Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//sum是8位，自动截取最后8位</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>sum<span class="token operator">==</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>     <span class="token comment">//判断sum</span>

        Rc_Get<span class="token punctuation">.</span>THROTTLE <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//首先进行8位数据的合并成16位赋值给遥控变量</span>
        Rc_Get<span class="token punctuation">.</span>YAW          <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        Rc_Get<span class="token punctuation">.</span>ROLL         <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        Rc_Get<span class="token punctuation">.</span>PITCH        <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        Rc_Get<span class="token punctuation">.</span>AUX1         <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        Rc_Get<span class="token punctuation">.</span>AUX2         <span class="token operator">=</span> <span class="token punctuation">(</span>vs16<span class="token punctuation">)</span><span class="token punctuation">(</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        RC_Target_ROL <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1500</span><span class="token operator">-</span>Rc_Get<span class="token punctuation">.</span>ROLL<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">30</span><span class="token punctuation">;</span>    <span class="token comment">//可以调遥控的灵敏度，一打杆偏大了，把30改大</span>
        RC_Target_PIT <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1500</span><span class="token operator">-</span>Rc_Get<span class="token punctuation">.</span>PITCH<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">30</span><span class="token punctuation">;</span>   <span class="token comment">//要改变的RC_Target就变小了</span>
        RC_Target_YAW <span class="token operator">=</span> <span class="token punctuation">(</span>Rc_Get<span class="token punctuation">.</span>YAW<span class="token operator">-</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">30</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0x01</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>


        <span class="token keyword">if</span><span class="token punctuation">(</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xA0</span><span class="token punctuation">)</span>   <span class="token punctuation">{<!-- --></span>ARMED <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>TxCounter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token function">Uart1_Send_ARMED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Rx2_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xA1</span><span class="token punctuation">)</span>   <span class="token punctuation">{<!-- --></span>ARMED <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>TxCounter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token function">Uart1_Send_ARMED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>     
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Uart2_RXCheckEvent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token comment">//USART_ITConfig(USART2, USART_IT_RXNE, DISABLE);//处理某一组数据时不能被UART2的接收中断打断</span>
    <span class="token comment">//因为UART2的中断优先级低于定时器中断，所以在执行定时器中断的程序（即Uart2_RXCheckEvent（））时，</span>
    <span class="token comment">//不可能被UART2的接收中断所打断</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>Rx2_Ok0<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Rx2_Ok0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">Uart2_DataAnl</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>Rx2_Ok1<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Rx2_Ok1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">Uart2_DataAnl</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//USART_ITConfig(USART2, USART_IT_RXNE, ENABLE); //重新打开接收中断</span>
<span class="token punctuation">}</span>
<span class="token comment">/******************************************************************************************/</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token comment">/*此文件由HC05和Uart1调用*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span>    </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BYTE0</span><span class="token expression"><span class="token punctuation">(</span>dwTemp<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dwTemp<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BYTE1</span><span class="token expression"><span class="token punctuation">(</span>dwTemp<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dwTemp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BYTE2</span><span class="token expression"><span class="token punctuation">(</span>dwTemp<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dwTemp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BYTE3</span><span class="token expression"><span class="token punctuation">(</span>dwTemp<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dwTemp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> byte<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">float</span> num<span class="token punctuation">;</span><span class="token punctuation">}</span>t_floattobyte<span class="token punctuation">;</span>
t_floattobyte floattobyte<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Uart1_Init</span><span class="token punctuation">(</span>u32 br_num<span class="token punctuation">)</span><span class="token comment">//时钟低电平活动，禁用了同步通讯,因此只有Uart</span>
<span class="token punctuation">{<!-- --></span>
	USART_InitTypeDef USART_InitStructure<span class="token punctuation">;</span>
	USART_ClockInitTypeDef USART_ClockInitStruct<span class="token punctuation">;</span>
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
	
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_USART1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开启USART1时钟</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOA<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	
	<span class="token comment">//配置PA9作为USART1　Tx</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span>  GPIO_Pin_9<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF_PP<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA <span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//配置PA10作为USART1　Rx</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span>  GPIO_Pin_10<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_IN_FLOATING<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA <span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//配置USART1</span>
	<span class="token comment">//中断被屏蔽了</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_BaudRate <span class="token operator">=</span> br_num<span class="token punctuation">;</span>       <span class="token comment">//波特率可以通过地面站配置</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_WordLength <span class="token operator">=</span> USART_WordLength_8b<span class="token punctuation">;</span>  <span class="token comment">//8位数据</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_StopBits <span class="token operator">=</span> USART_StopBits_1<span class="token punctuation">;</span>   <span class="token comment">//在帧结尾传输1个停止位</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_Parity <span class="token operator">=</span> USART_Parity_No<span class="token punctuation">;</span>    <span class="token comment">//禁用奇偶校验</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_HardwareFlowControl <span class="token operator">=</span> USART_HardwareFlowControl_None<span class="token punctuation">;</span> <span class="token comment">//硬件流控制失能</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_Mode <span class="token operator">=</span> USART_Mode_Tx <span class="token operator">|</span> USART_Mode_Rx<span class="token punctuation">;</span>  <span class="token comment">//发送、接收使能</span>
	<span class="token comment">//配置USART1时钟</span>
	USART_ClockInitStruct<span class="token punctuation">.</span>USART_Clock <span class="token operator">=</span> USART_Clock_Disable<span class="token punctuation">;</span>  <span class="token comment">//时钟低电平活动</span>
	USART_ClockInitStruct<span class="token punctuation">.</span>USART_CPOL <span class="token operator">=</span> USART_CPOL_Low<span class="token punctuation">;</span>  <span class="token comment">//SLCK引脚上时钟输出的极性-&gt;低电平</span>
	USART_ClockInitStruct<span class="token punctuation">.</span>USART_CPHA <span class="token operator">=</span> USART_CPHA_2Edge<span class="token punctuation">;</span>  <span class="token comment">//时钟第二个边沿进行数据捕获</span>
	USART_ClockInitStruct<span class="token punctuation">.</span>USART_LastBit <span class="token operator">=</span> USART_LastBit_Disable<span class="token punctuation">;</span> <span class="token comment">//最后一位数据的时钟脉冲不从SCLK输出</span>
	
	<span class="token function">USART_Init</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>USART_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">USART_ClockInit</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>USART_ClockInitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//使能USART1接收中断</span>
	<span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//使能USART1</span>
	<span class="token function">USART_Cmd</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>




<span class="token class-name">uint8_t</span> TxBuffer<span class="token punctuation">[</span><span class="token number">0xff</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
u8 TxCounter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
u8 count<span class="token operator">=</span><span class="token punctuation">;</span> 
u8 Rx_Buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">//两个32字节的串口接收缓存</span>
u8 Rx_Act<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//正在使用的buf号</span>
u8 Rx_Adr<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//正在接收第几字节</span>
u8 Rx_Ok0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
u8 Rx_Ok1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>



<span class="token keyword">void</span> <span class="token function">Uart1_IRQ</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token comment">//与PC上位机的通讯</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_IT_ORE<span class="token punctuation">)</span><span class="token comment">//有数据过载了，赶进读</span>
	<span class="token punctuation">{<!-- --></span>
		USART1<span class="token operator">-&gt;</span>SR<span class="token punctuation">;</span><span class="token comment">//没什么用</span>
	<span class="token punctuation">}</span>
	
	
               <span class="token comment">/*******************发送中断***********************/</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;</span> USART_CR1_TXEIE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//if(USART_GetITStatus(USART1,USART_IT_TXE)!=RESET)</span>
	<span class="token punctuation">{<!-- --></span>                                                          <span class="token comment">//如果打开了写中断使能</span>
		USART1<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> TxBuffer<span class="token punctuation">[</span>TxCounter<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//写数据到DR          </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>TxCounter <span class="token operator">==</span> count<span class="token punctuation">)</span><span class="token comment">//如果TxCounter达到了最大量count</span>
		<span class="token punctuation">{<!-- --></span>
			USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR1_TXEIE<span class="token punctuation">;</span>		<span class="token comment">//关闭TXE写入中断</span>
			<span class="token comment">//USART_ITConfig(USART1,USART_IT_TXE,DISABLE);</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	
              <span class="token comment">/****************接收中断 (接收寄存器非空)************/</span> 
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//if(USART_GetITStatus(USART1, USART_IT_RXNE) != RESET)    </span>
	<span class="token punctuation">{<!-- --></span>                       <span class="token comment">//接收中断为1代表接收数据寄存器已满</span>
		u8 com_data <span class="token operator">=</span> USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span><span class="token comment">//赶进读</span>
		  
		<span class="token comment">//寻找接收的数据中帧头0XAAAF</span>
		
			<span class="token keyword">if</span><span class="token punctuation">(</span>Rx_Adr<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//检验Rx_Buf[Rx_Act][0,1,2,3]            </span>
			<span class="token punctuation">{<!-- --></span>            <span class="token comment">//对应0xＡＡ，ＡＦ，FUN，LEN	</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>com_data<span class="token operator">==</span><span class="token number">0xAA</span><span class="token punctuation">)</span>	
				<span class="token punctuation">{<!-- --></span>
					Rx_Buf<span class="token punctuation">[</span>Rx_Act<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> com_data<span class="token punctuation">;</span>
					Rx_Adr <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>Rx_Adr<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>com_data<span class="token operator">==</span><span class="token number">0xAF</span><span class="token punctuation">)</span>	
				<span class="token punctuation">{<!-- --></span>
					Rx_Buf<span class="token punctuation">[</span>Rx_Act<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> com_data<span class="token punctuation">;</span>
					Rx_Adr <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span>
					Rx_Adr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>Rx_Adr<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>		<span class="token comment">//FUN</span>
			<span class="token punctuation">{<!-- --></span>
				Rx_Buf<span class="token punctuation">[</span>Rx_Act<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> com_data<span class="token punctuation">;</span>
				Rx_Adr <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>Rx_Adr<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span>		<span class="token comment">//LEN</span>
			<span class="token punctuation">{<!-- --></span>
				Rx_Buf<span class="token punctuation">[</span>Rx_Act<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> com_data<span class="token punctuation">;</span>
				Rx_Adr <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{<!-- --></span>
				Rx_Buf<span class="token punctuation">[</span>Rx_Act<span class="token punctuation">]</span><span class="token punctuation">[</span>Rx_Adr<span class="token punctuation">]</span> <span class="token operator">=</span> com_data<span class="token punctuation">;</span>
				Rx_Adr <span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>                              
			<span class="token keyword">if</span><span class="token punctuation">(</span>Rx_Adr<span class="token operator">==</span>Rx_Buf<span class="token punctuation">[</span>Rx_Act<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token comment">//如果adr等于了前面接收到的LEN</span>
			<span class="token punctuation">{<!-- --></span>                              <span class="token comment">//那么这次act=0的数据接收完成，切换缓存到act=1；</span>
				Rx_Adr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>Rx_Act<span class="token punctuation">)</span>	
				<span class="token punctuation">{<!-- --></span> 
					Rx_Act <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 			<span class="token comment">//切换缓存</span>
					Rx_Ok1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span> 				
				<span class="token punctuation">{<!-- --></span>
					Rx_Act <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
					Rx_Ok0 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/**********************************串口接收的缓存数据分析*********************************/</span>
<span class="token keyword">void</span> <span class="token function">Uart_DataAnl</span><span class="token punctuation">(</span>u8 buf_num<span class="token punctuation">)</span>		<span class="token comment">//</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Rx_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xAA</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>Rx_Buf<span class="token punctuation">[</span>buf_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xAF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//如果串口收到的是AA，AF</span>
		                                                         <span class="token comment">//是PC上位机发送给飞控的数据</span>
	<span class="token punctuation">{<!-- --></span>
	
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token keyword">void</span> <span class="token function">Uart_CheckEvent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>Rx_Ok0<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		Rx_Ok0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">Uart_DataAnl</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>Rx_Ok1<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		Rx_Ok1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">Uart_DataAnl</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/******************************************************************************************/</span>

<span class="token comment">/**************************实现函数********************************************
*******************************************************************************/</span>
<span class="token class-name">uint8_t</span> <span class="token function">Uart1_Put_Char</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> DataToSend<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TxBuffer<span class="token punctuation">[</span>count<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> DataToSend<span class="token punctuation">;</span>  
  <span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_IT_TXE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token keyword">return</span> DataToSend<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">uint8_t</span> <span class="token function">Uart1_Put_Int16</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> DataToSend<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">uint8_t</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	TxBuffer<span class="token punctuation">[</span>count<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>DataToSend<span class="token punctuation">)</span><span class="token punctuation">;</span>
	TxBuffer<span class="token punctuation">[</span>count<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>DataToSend<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_IT_TXE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	sum <span class="token operator">+=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>DataToSend<span class="token punctuation">)</span><span class="token punctuation">;</span>
	sum <span class="token operator">+=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>DataToSend<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> sum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">uint8_t</span> <span class="token function">Uart1_Put_Float</span><span class="token punctuation">(</span><span class="token keyword">float</span> DataToSend<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">uint8_t</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	floattobyte<span class="token punctuation">.</span>num<span class="token operator">=</span>DataToSend<span class="token punctuation">;</span>
	TxBuffer<span class="token punctuation">[</span>count<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> floattobyte<span class="token punctuation">.</span>byte<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
	TxBuffer<span class="token punctuation">[</span>count<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> floattobyte<span class="token punctuation">.</span>byte<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
	TxBuffer<span class="token punctuation">[</span>count<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> floattobyte<span class="token punctuation">.</span>byte<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
	TxBuffer<span class="token punctuation">[</span>count<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> floattobyte<span class="token punctuation">.</span>byte<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
	<span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_IT_TXE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	sum <span class="token operator">+=</span> <span class="token function">BYTE3</span><span class="token punctuation">(</span>DataToSend<span class="token punctuation">)</span><span class="token punctuation">;</span>
	sum <span class="token operator">+=</span> <span class="token function">BYTE2</span><span class="token punctuation">(</span>DataToSend<span class="token punctuation">)</span><span class="token punctuation">;</span>
	sum <span class="token operator">+=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>DataToSend<span class="token punctuation">)</span><span class="token punctuation">;</span>
	sum <span class="token operator">+=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>DataToSend<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> sum<span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Uart1_Put_String</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//判断Str指向的数据是否有效.</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>Str<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//是否是回车字符 如果是,则发送相应的回车 0x0d 0x0a</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>Str<span class="token operator">==</span><span class="token string">'\r'</span><span class="token punctuation">)</span><span class="token function">Uart1_Put_Char</span><span class="token punctuation">(</span><span class="token number">0x0d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>Str<span class="token operator">==</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token function">Uart1_Put_Char</span><span class="token punctuation">(</span><span class="token number">0x0a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span> <span class="token function">Uart1_Put_Char</span><span class="token punctuation">(</span><span class="token operator">*</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//指针++ 指向下一个字节.</span>
	Str<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre> 
<pre><code>/*此文件由HC05和Uart1调用*/

#include "stm32f10x.h"    
#include "usart.h"

#define BYTE0(dwTemp)       (*(char *)(&amp;dwTemp))
#define BYTE1(dwTemp)       (*((char *)(&amp;dwTemp) + 1))
#define BYTE2(dwTemp)       (*((char *)(&amp;dwTemp) + 2))
#define BYTE3(dwTemp)       (*((char *)(&amp;dwTemp) + 3))

typedef union {unsigned char byte[4];float num;}t_floattobyte;
t_floattobyte floattobyte;

void Uart1_Init(u32 br_num)//时钟低电平活动，禁用了同步通讯,因此只有Uart
{
	USART_InitTypeDef USART_InitStructure;
	USART_ClockInitTypeDef USART_ClockInitStruct;
	GPIO_InitTypeDef GPIO_InitStructure;
	
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1, ENABLE); //开启USART1时钟
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA,ENABLE);	
	
	//配置PA9作为USART1　Tx
	GPIO_InitStructure.GPIO_Pin =  GPIO_Pin_9;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;
	GPIO_Init(GPIOA , &amp;GPIO_InitStructure);
	//配置PA10作为USART1　Rx
	GPIO_InitStructure.GPIO_Pin =  GPIO_Pin_10;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;
	GPIO_Init(GPIOA , &amp;GPIO_InitStructure);
	
	//配置USART1
	//中断被屏蔽了
	USART_InitStructure.USART_BaudRate = br_num;       //波特率可以通过地面站配置
	USART_InitStructure.USART_WordLength = USART_WordLength_8b;  //8位数据
	USART_InitStructure.USART_StopBits = USART_StopBits_1;   //在帧结尾传输1个停止位
	USART_InitStructure.USART_Parity = USART_Parity_No;    //禁用奇偶校验
	USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None; //硬件流控制失能
	USART_InitStructure.USART_Mode = USART_Mode_Tx | USART_Mode_Rx;  //发送、接收使能
	//配置USART1时钟
	USART_ClockInitStruct.USART_Clock = USART_Clock_Disable;  //时钟低电平活动
	USART_ClockInitStruct.USART_CPOL = USART_CPOL_Low;  //SLCK引脚上时钟输出的极性-&gt;低电平
	USART_ClockInitStruct.USART_CPHA = USART_CPHA_2Edge;  //时钟第二个边沿进行数据捕获
	USART_ClockInitStruct.USART_LastBit = USART_LastBit_Disable; //最后一位数据的时钟脉冲不从SCLK输出
	
	USART_Init(USART1, &amp;USART_InitStructure);
	USART_ClockInit(USART1, &amp;USART_ClockInitStruct);

	//使能USART1接收中断
	USART_ITConfig(USART1, USART_IT_RXNE, ENABLE);
	//使能USART1
	USART_Cmd(USART1, ENABLE); 
}




uint8_t TxBuffer[0xff];
u8 TxCounter=0;
u8 count=; 
u8 Rx_Buf[2][32];	//两个32字节的串口接收缓存
u8 Rx_Act=0;		//正在使用的buf号
u8 Rx_Adr=0;		//正在接收第几字节
u8 Rx_Ok0 = 0;
u8 Rx_Ok1 = 0;



void Uart1_IRQ(void)//与PC上位机的通讯
{
	if(USART1-&gt;SR &amp; USART_IT_ORE)//有数据过载了，赶进读
	{
		USART1-&gt;SR;//没什么用
	}
	
	
               /*******************发送中断***********************/
	
	if((USART1-&gt;SR &amp; (1&lt;&lt;7))&amp;&amp;(USART1-&gt;CR1 &amp; USART_CR1_TXEIE))//if(USART_GetITStatus(USART1,USART_IT_TXE)!=RESET)
	{                                                          //如果打开了写中断使能
		USART1-&gt;DR = TxBuffer[TxCounter++]; //写数据到DR          
		if(TxCounter == count)//如果TxCounter达到了最大量count
		{
			USART1-&gt;CR1 &amp;= ~USART_CR1_TXEIE;		//关闭TXE写入中断
			//USART_ITConfig(USART1,USART_IT_TXE,DISABLE);
		}
	}
	
	
              /****************接收中断 (接收寄存器非空)************/ 
	
	if(USART1-&gt;SR &amp; (1&lt;&lt;5))//if(USART_GetITStatus(USART1, USART_IT_RXNE) != RESET)    
	{                       //接收中断为1代表接收数据寄存器已满
		u8 com_data = USART1-&gt;DR;//赶进读
		  
		//寻找接收的数据中帧头0XAAAF
		
			if(Rx_Adr==0)//检验Rx_Buf[Rx_Act][0,1,2,3]            
			{            //对应0xＡＡ，ＡＦ，FUN，LEN	
				if(com_data==0xAA)	
				{
					Rx_Buf[Rx_Act][0] = com_data;
					Rx_Adr = 1;
				}
			}
			else if(Rx_Adr==1)
			{
				if(com_data==0xAF)	
				{
					Rx_Buf[Rx_Act][1] = com_data;
					Rx_Adr = 2;
				}
				else
					Rx_Adr = 0;
			}
			else if(Rx_Adr==2)		//FUN
			{
				Rx_Buf[Rx_Act][2] = com_data;
				Rx_Adr = 3;
			}
			else if(Rx_Adr==3)		//LEN
			{
				Rx_Buf[Rx_Act][3] = com_data;
				Rx_Adr = 4;
			}
			else
			{
				Rx_Buf[Rx_Act][Rx_Adr] = com_data;
				Rx_Adr ++;
			}                              
			if(Rx_Adr==Rx_Buf[Rx_Act][3]+5)//如果adr等于了前面接收到的LEN
			{                              //那么这次act=0的数据接收完成，切换缓存到act=1；
				Rx_Adr = 0;
				if(Rx_Act)	
				{ 
					Rx_Act = 0; 			//切换缓存
					Rx_Ok1 = 1;
				}
				else 				
				{
					Rx_Act = 1;
					Rx_Ok0 = 1;
				}
		}
	}
}


/**********************************串口接收的缓存数据分析*********************************/
void Uart_DataAnl(u8 buf_num)		//
{
	if((Rx_Buf[buf_num][1]==0xAA)&amp;&amp;(Rx_Buf[buf_num][2]==0xAF))//如果串口收到的是AA，AF
		                                                         //是PC上位机发送给飞控的数据
	{
	
	}
}



void Uart_CheckEvent(void)
{
	if(Rx_Ok0)
	{
		Rx_Ok0 = 0;
		Uart_DataAnl(0);
	}
	if(Rx_Ok1)
	{
		Rx_Ok1 = 0;
		Uart_DataAnl(1);
	}
}
/******************************************************************************************/

/**************************实现函数********************************************
*******************************************************************************/
uint8_t Uart1_Put_Char(unsigned char DataToSend)
{
	TxBuffer[count++] = DataToSend;  
  USART_ITConfig(USART1, USART_IT_TXE, ENABLE); 
	return DataToSend;
}
uint8_t Uart1_Put_Int16(uint16_t DataToSend)
{
	uint8_t sum = 0;
	TxBuffer[count++] = BYTE1(DataToSend);
	TxBuffer[count++] = BYTE0(DataToSend);
  USART_ITConfig(USART1, USART_IT_TXE, ENABLE);
	sum += BYTE1(DataToSend);
	sum += BYTE0(DataToSend);
	return sum;
}
uint8_t Uart1_Put_Float(float DataToSend)
{
	uint8_t sum = 0;
	floattobyte.num=DataToSend;
	TxBuffer[count++] = floattobyte.byte[3];  
	TxBuffer[count++] = floattobyte.byte[2];  
	TxBuffer[count++] = floattobyte.byte[1];  
	TxBuffer[count++] = floattobyte.byte[0];  
	USART_ITConfig(USART1, USART_IT_TXE, ENABLE);
	sum += BYTE3(DataToSend);
	sum += BYTE2(DataToSend);
	sum += BYTE1(DataToSend);
	sum += BYTE0(DataToSend);
	return sum;	
}
void Uart1_Put_String(unsigned char *Str)
{
	//判断Str指向的数据是否有效.
	while(*Str)
	{
	//是否是回车字符 如果是,则发送相应的回车 0x0d 0x0a
	if(*Str=='\r')Uart1_Put_Char(0x0d);
		else if(*Str=='\n')Uart1_Put_Char(0x0a);
			else Uart1_Put_Char(*Str);
	//指针++ 指向下一个字节.
	Str++;
	}
}


</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9533b225bea157fcf70eb86d3fd0bc41/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vscode运行打包vue项目内存溢出的报错和解决办法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8f0f55ae6f32b39f2fe991b703dc2379/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【用Python对全职高手小说分析分词词频词性，小说人物出场次数排序，小说中食物排序，小说人物关系等等】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>