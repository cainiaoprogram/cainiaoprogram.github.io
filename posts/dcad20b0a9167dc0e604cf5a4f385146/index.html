<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>非极大值抑制(Non-Maximum Suppression) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="非极大值抑制(Non-Maximum Suppression)" />
<meta property="og:description" content="文章作者：Tyan 博客：noahsnail.com | CSDN | 简书
1. 什么是非极大值抑制 非极大值抑制，简称为NMS算法，英文为Non-Maximum Suppression。其思想是搜素局部最大值，抑制极大值。NMS算法在不同应用中的具体实现不太一样，但思想是一样的。非极大值抑制，在计算机视觉任务中得到了广泛的应用，例如边缘检测、人脸检测、目标检测（DPM，YOLO，SSD，Faster R-CNN）等。
2. 为什么要用非极大值抑制 以目标检测为例：目标检测的过程中在同一目标的位置上会产生大量的候选框，这些候选框相互之间可能会有重叠，此时我们需要利用非极大值抑制找到最佳的目标边界框，消除冗余的边界框。Demo如下图：
左图是人脸检测的候选框结果，每个边界框有一个置信度得分(confidence score)，如果不使用非极大值抑制，就会有多个候选框出现。右图是使用非极大值抑制之后的结果，符合我们人脸检测的预期结果。
3. 如何使用非极大值抑制 前提：目标边界框列表及其对应的置信度得分列表，设定阈值，阈值用来删除重叠较大的边界框。 IoU：intersection-over-union，即两个边界框的交集部分除以它们的并集。
非极大值抑制的流程如下：
根据置信度得分进行排序
选择置信度最高的比边界框添加到最终输出列表中，将其从边界框列表中删除
计算所有边界框的面积
计算置信度最高的边界框与其它候选框的IoU。
删除IoU大于阈值的边界框
重复上述过程，直至边界框列表为空。
Python代码如下：
#!/usr/bin/env python # _*_ coding: utf-8 _*_ import cv2 import numpy as np &#34;&#34;&#34; Non-max Suppression Algorithm @param list Object candidate bounding boxes @param list Confidence score of bounding boxes @param float IoU threshold @return Rest boxes after nms operation &#34;&#34;&#34; def nms(bounding_boxes, confidence_score, threshold): # If no bounding boxes, return empty list if len(bounding_boxes) == 0: return [], [] # Bounding boxes boxes = np." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/dcad20b0a9167dc0e604cf5a4f385146/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-12-15T17:24:43+08:00" />
<meta property="article:modified_time" content="2017-12-15T17:24:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">非极大值抑制(Non-Maximum Suppression)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>文章作者：Tyan <br> 博客：<a href="http://noahsnail.com" rel="nofollow noopener noreferrer" target="_blank">noahsnail.com</a>  |  <a href="http://blog.csdn.net/quincuntial" target="_blank" rel="noopener noreferrer">CSDN</a>  |  <a href="http://www.jianshu.com/users/7731e83f3a4e/latest_articles" rel="nofollow noopener noreferrer" target="_blank">简书</a></p> 
<h3 id="1-什么是非极大值抑制">1. 什么是非极大值抑制</h3> 
<p>非极大值抑制，简称为NMS算法，英文为Non-Maximum Suppression。其思想是搜素局部最大值，抑制极大值。NMS算法在不同应用中的具体实现不太一样，但思想是一样的。非极大值抑制，在计算机视觉任务中得到了广泛的应用，例如边缘检测、人脸检测、目标检测（DPM，YOLO，SSD，Faster R-CNN）等。</p> 
<h3 id="2-为什么要用非极大值抑制">2. 为什么要用非极大值抑制</h3> 
<p>以目标检测为例：目标检测的过程中在同一目标的位置上会产生大量的候选框，这些候选框相互之间可能会有重叠，此时我们需要利用非极大值抑制找到最佳的目标边界框，消除冗余的边界框。Demo如下图：</p> 
<p><img src="https://images2.imgbox.com/75/a6/P5RAJLpX_o.png" alt="Object Detection" title=""> <br> 左图是人脸检测的候选框结果，每个边界框有一个置信度得分(confidence score)，如果不使用非极大值抑制，就会有多个候选框出现。右图是使用非极大值抑制之后的结果，符合我们人脸检测的预期结果。</p> 
<h3 id="3-如何使用非极大值抑制">3. 如何使用非极大值抑制</h3> 
<p><strong>前提：</strong>目标边界框列表及其对应的置信度得分列表，设定阈值，阈值用来删除重叠较大的边界框。 <br> <strong>IoU</strong>：intersection-over-union，即两个边界框的交集部分除以它们的并集。</p> 
<p>非极大值抑制的流程如下：</p> 
<ul><li><p>根据置信度得分进行排序</p></li><li><p>选择置信度最高的比边界框添加到最终输出列表中，将其从边界框列表中删除</p></li><li><p>计算所有边界框的面积</p></li><li><p>计算置信度最高的边界框与其它候选框的IoU。</p></li><li><p>删除IoU大于阈值的边界框</p></li><li><p>重复上述过程，直至边界框列表为空。</p></li></ul> 
<p>Python代码如下：</p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># _*_ coding: utf-8 _*_</span>


<span class="hljs-keyword">import</span> cv2
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np


<span class="hljs-string">"""
    Non-max Suppression Algorithm

    @param list  Object candidate bounding boxes
    @param list  Confidence score of bounding boxes
    @param float IoU threshold

    @return Rest boxes after nms operation
"""</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">nms</span><span class="hljs-params">(bounding_boxes, confidence_score, threshold)</span>:</span>
    <span class="hljs-comment"># If no bounding boxes, return empty list</span>
    <span class="hljs-keyword">if</span> len(bounding_boxes) == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> [], []

    <span class="hljs-comment"># Bounding boxes</span>
    boxes = np.array(bounding_boxes)

    <span class="hljs-comment"># coordinates of bounding boxes</span>
    start_x = boxes[:, <span class="hljs-number">0</span>]
    start_y = boxes[:, <span class="hljs-number">1</span>]
    end_x = boxes[:, <span class="hljs-number">2</span>]
    end_y = boxes[:, <span class="hljs-number">3</span>]

    <span class="hljs-comment"># Confidence scores of bounding boxes</span>
    score = np.array(confidence_score)

    <span class="hljs-comment"># Picked bounding boxes</span>
    picked_boxes = []
    picked_score = []

    <span class="hljs-comment"># Compute areas of bounding boxes</span>
    areas = (end_x - start_x + <span class="hljs-number">1</span>) * (end_y - start_y + <span class="hljs-number">1</span>)

    <span class="hljs-comment"># Sort by confidence score of bounding boxes</span>
    order = np.argsort(score)

    <span class="hljs-comment"># Iterate bounding boxes</span>
    <span class="hljs-keyword">while</span> order.size &gt; <span class="hljs-number">0</span>:
        <span class="hljs-comment"># The index of largest confidence score</span>
        index = order[-<span class="hljs-number">1</span>]

        <span class="hljs-comment"># Pick the bounding box with largest confidence score</span>
        picked_boxes.append(bounding_boxes[index])
        picked_score.append(confidence_score[index])

        <span class="hljs-comment"># Compute ordinates of intersection-over-union(IOU)</span>
        x1 = np.maximum(start_x[index], start_x[order[:-<span class="hljs-number">1</span>]])
        x2 = np.minimum(end_x[index], end_x[order[:-<span class="hljs-number">1</span>]])
        y1 = np.maximum(start_y[index], start_y[order[:-<span class="hljs-number">1</span>]])
        y2 = np.minimum(end_y[index], end_y[order[:-<span class="hljs-number">1</span>]])

        <span class="hljs-comment"># Compute areas of intersection-over-union</span>
        w = np.maximum(<span class="hljs-number">0.0</span>, x2 - x1 + <span class="hljs-number">1</span>)
        h = np.maximum(<span class="hljs-number">0.0</span>, y2 - y1 + <span class="hljs-number">1</span>)
        intersection = w * h

        <span class="hljs-comment"># Compute the ratio between intersection and union</span>
        ratio = intersection / (areas[index] + areas[order[:-<span class="hljs-number">1</span>]] - intersection)

        left = np.where(ratio &lt; threshold)
        order = order[left]

    <span class="hljs-keyword">return</span> picked_boxes, picked_score


<span class="hljs-comment"># Image name</span>
image_name = <span class="hljs-string">'nms.jpg'</span>

<span class="hljs-comment"># Bounding boxes</span>
bounding_boxes = [(<span class="hljs-number">187</span>, <span class="hljs-number">82</span>, <span class="hljs-number">337</span>, <span class="hljs-number">317</span>), (<span class="hljs-number">150</span>, <span class="hljs-number">67</span>, <span class="hljs-number">305</span>, <span class="hljs-number">282</span>), (<span class="hljs-number">246</span>, <span class="hljs-number">121</span>, <span class="hljs-number">368</span>, <span class="hljs-number">304</span>)]
confidence_score = [<span class="hljs-number">0.9</span>, <span class="hljs-number">0.75</span>, <span class="hljs-number">0.8</span>]

<span class="hljs-comment"># Read image</span>
image = cv2.imread(image_name)

<span class="hljs-comment"># Copy image as original</span>
org = image.copy()

<span class="hljs-comment"># Draw parameters</span>
font = cv2.FONT_HERSHEY_SIMPLEX
font_scale = <span class="hljs-number">1</span>
thickness = <span class="hljs-number">2</span>

<span class="hljs-comment"># IoU threshold</span>
threshold = <span class="hljs-number">0.4</span>

<span class="hljs-comment"># Draw bounding boxes and confidence score</span>
<span class="hljs-keyword">for</span> (start_x, start_y, end_x, end_y), confidence <span class="hljs-keyword">in</span> zip(bounding_boxes, confidence_score):
    (w, h), baseline = cv2.getTextSize(str(confidence), font, font_scale, thickness)
    cv2.rectangle(org, (start_x, start_y - (<span class="hljs-number">2</span> * baseline + <span class="hljs-number">5</span>)), (start_x + w, start_y), (<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>), -<span class="hljs-number">1</span>)
    cv2.rectangle(org, (start_x, start_y), (end_x, end_y), (<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>), <span class="hljs-number">2</span>)
    cv2.putText(org, str(confidence), (start_x, start_y), font, font_scale, (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), thickness)

<span class="hljs-comment"># Run non-max suppression algorithm</span>
picked_boxes, picked_score = nms(bounding_boxes, confidence_score, threshold)

<span class="hljs-comment"># Draw bounding boxes and confidence score after non-maximum supression</span>
<span class="hljs-keyword">for</span> (start_x, start_y, end_x, end_y), confidence <span class="hljs-keyword">in</span> zip(picked_boxes, picked_score):
    (w, h), baseline = cv2.getTextSize(str(confidence), font, font_scale, thickness)
    cv2.rectangle(image, (start_x, start_y - (<span class="hljs-number">2</span> * baseline + <span class="hljs-number">5</span>)), (start_x + w, start_y), (<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>), -<span class="hljs-number">1</span>)
    cv2.rectangle(image, (start_x, start_y), (end_x, end_y), (<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>), <span class="hljs-number">2</span>)
    cv2.putText(image, str(confidence), (start_x, start_y), font, font_scale, (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), thickness)

<span class="hljs-comment"># Show image</span>
cv2.imshow(<span class="hljs-string">'Original'</span>, org)
cv2.imshow(<span class="hljs-string">'NMS'</span>, image)
cv2.waitKey(<span class="hljs-number">0</span>)</code></pre> 
<p>源码下载地址：<a href="https://github.com/SnailTyan/deep-learning-tools/blob/master/nms.py" target="_blank" rel="noopener noreferrer">https://github.com/SnailTyan/deep-learning-tools/blob/master/nms.py</a> <br> 记得给个Star。Demo原图在<code>README.md</code>里。</p> 
<p>实验结果：</p> 
<ul><li>阈值为0.6</li></ul> 
<p><img src="https://images2.imgbox.com/df/fb/JcR34ZUQ_o.png" alt="threshold = 0.6" title=""></p> 
<ul><li><p>阈值为0.5 <br> <img src="https://images2.imgbox.com/e8/fd/tANigyIZ_o.png" alt="threshold = 0.5" title=""></p></li><li><p>阈值为0.4 <br> <img src="https://images2.imgbox.com/33/4c/k7bM2pcz_o.png" alt="threshold = 0.4" title=""></p></li></ul> 
<h3 id="4-参考资料">4. 参考资料</h3> 
<ol><li><p><a href="https://www.pyimagesearch.com/2014/11/17/non-maximum-suppression-object-detection-python/" rel="nofollow noopener noreferrer" target="_blank">https://www.pyimagesearch.com/2014/11/17/non-maximum-suppression-object-detection-python/</a></p></li><li><p><a href="http://cs.brown.edu/~pff/papers/lsvm-pami.pdf" rel="nofollow noopener noreferrer" target="_blank">http://cs.brown.edu/~pff/papers/lsvm-pami.pdf</a></p></li><li><p><a href="http://blog.csdn.net/shuzfan/article/details/52711706" target="_blank" rel="noopener noreferrer">http://blog.csdn.net/shuzfan/article/details/52711706</a></p></li><li><p><a href="http://www.cnblogs.com/liekkas0626/p/5219244.html" rel="nofollow noopener noreferrer" target="_blank">http://www.cnblogs.com/liekkas0626/p/5219244.html</a></p></li><li><p><a href="http://www.tk4479.net/yzhang6_10/article/details/50886747" rel="nofollow noopener noreferrer" target="_blank">http://www.tk4479.net/yzhang6_10/article/details/50886747</a></p></li><li><p><a href="http://blog.csdn.net/qq_14845119/article/details/52064928" target="_blank" rel="noopener noreferrer">http://blog.csdn.net/qq_14845119/article/details/52064928</a></p></li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/31a680713b48e153bfbb7edc4fc5fe31/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PostgreSQL 日志文件位置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a92ad69e52d5acae29a454796c0ee796/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JavaWeb常用异常总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>