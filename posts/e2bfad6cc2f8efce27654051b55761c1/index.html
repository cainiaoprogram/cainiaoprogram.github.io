<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MongoDB之Change Stream实战 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MongoDB之Change Stream实战" />
<meta property="og:description" content="什么是 Chang Streams Change Stream 指数据的变化事件流，MongoDB 从 3.6 版本开始提供订阅数据变更的功能。
Change Stream 是 MongoDB 用于实现变更追踪的解决方案，类似于关系数据库的触发器，但原理不完全相同：
Change Stream触发器触发方式异步同步（事务保证）触发位置应用回调事件数据库触发器触发次数每个订阅事件的客户端1次（触发器)故障恢复从上次断点重新触发事务回滚 Change Stream 的实现原理 Change Stream 是基于 oplog 实现的，提供推送实时增量的推送功能。它在 oplog 上开启一个 tailable cursor 来追踪所有复制集上的变更操作，最终调用应用中定义的回调函数。
被追踪的变更事件主要包括：
insert/update/delete：插入、更新、删除；drop：集合被删除；rename：集合被重命名；dropDatabase：数据库被删除；invalidate：drop/rename/dropDatabase 将导致 invalidate 被触发， 并关闭 change stream； 如果只对某些类型的变更事件感兴趣，可以使用使用聚合管道的过滤步骤过滤事件：
var cs = db.user.watch([{ $match:{operationType:{$in:[&#34;insert&#34;,&#34;delete&#34;]}} }]) Change Stream会采用 &#34;readConcern：majority&#34;这样的一致性级别，保证写入的变更不会被回滚。
因此：
未开启 majority readConcern 的集群无法使用 Change Stream；当集群无法满足 {w: “majority”} 时，不会触发 Change Stream（例如 PSA 架构 中的 S 因故障宕）。 MongoShell 测试
窗口 1：
db.user.watch([],{maxAwaitTimeMS:1000000}).pretty() 窗口 2：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e2bfad6cc2f8efce27654051b55761c1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-11T20:29:22+08:00" />
<meta property="article:modified_time" content="2024-01-11T20:29:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MongoDB之Change Stream实战</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_Chang_Streams_0"></a>什么是 Chang Streams</h3> 
<p>Change Stream 指数据的变化事件流，MongoDB 从 3.6 版本开始提供订阅数据变更的功能。<br>Change Stream 是 MongoDB 用于实现变更追踪的解决方案，类似于关系数据库的触发器，但原理不完全相同：</p> 
<table><thead><tr><th><br></th><th><strong>Change Stream</strong></th><th><strong>触发器</strong></th></tr></thead><tbody><tr><td>触发方式</td><td>异步</td><td>同步（事务保证）</td></tr><tr><td>触发位置</td><td>应用回调事件</td><td>数据库触发器</td></tr><tr><td>触发次数</td><td>每个订阅事件的客户端</td><td>1次（触发器)</td></tr><tr><td>故障恢复</td><td>从上次断点重新触发</td><td>事务回滚</td></tr></tbody></table> 
<h3><a id="Change_Stream__10"></a>Change Stream 的实现原理</h3> 
<p>Change Stream 是基于 oplog 实现的，提供推送实时增量的推送功能。它在 oplog 上开启一个 tailable cursor 来追踪所有复制集上的变更操作，最终调用应用中定义的回调函数。<br>被追踪的变更事件主要包括：</p> 
<ul><li>insert/update/delete：插入、更新、删除；</li><li>drop：集合被删除；</li><li>rename：集合被重命名；</li><li>dropDatabase：数据库被删除；</li><li>invalidate：drop/rename/dropDatabase 将导致 invalidate 被触发， 并关闭 change stream；</li></ul> 
<p><img src="https://images2.imgbox.com/ce/eb/EBhuhCMg_o.png" alt="666.png"><br>如果只对某些类型的变更事件感兴趣，可以使用使用聚合管道的过滤步骤过滤事件：</p> 
<pre><code class="prism language-bash">var cs <span class="token operator">=</span> db.user.watch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
	<span class="token variable">$match</span>:<span class="token punctuation">{<!-- --></span>operationType:<span class="token punctuation">{<!-- --></span><span class="token variable">$in</span>:<span class="token punctuation">[</span><span class="token string">"insert"</span>,<span class="token string">"delete"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>Change Stream会采用 "readConcern：majority"这样的一致性级别，保证写入的变更不会被回滚。<br>因此：</p> 
<ul><li>未开启 majority readConcern 的集群无法使用 Change Stream；</li><li>当集群无法满足 <code>{w: “majority”}</code> 时，不会触发 Change Stream（例如 PSA 架构 中的 S 因故障宕）。</li></ul> 
<p>MongoShell 测试<br>窗口 1：</p> 
<pre><code class="prism language-bash">db.user.watch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>,<span class="token punctuation">{<!-- --></span>maxAwaitTimeMS:1000000<span class="token punctuation">}</span><span class="token punctuation">)</span>.pretty<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>窗口 2：</p> 
<pre><code class="prism language-bash">db.user.insert<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>name:<span class="token string">"xxxx"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>变更事件字段说明：</p> 
<table><thead><tr><th><strong>名称</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>_id</td><td>变更事件的 Token 对象</td></tr><tr><td>operationType</td><td>变更类型</td></tr><tr><td>fullDocument</td><td>文档完整内容</td></tr><tr><td>ns</td><td>监听的目标</td></tr><tr><td>ns.db</td><td>变更的数据库</td></tr><tr><td>ns.coll</td><td>变更的集合</td></tr><tr><td>to</td><td>对于 rename 操作变更后的目标</td></tr><tr><td>ns.db</td><td>rename 操作后的数据库</td></tr><tr><td>documentKey</td><td>变更文档的键值，含 _id 字段</td></tr><tr><td>updateDescription</td><td>变更描述</td></tr><tr><td>updateDescription.updatedFields</td><td>变更中更新的字段</td></tr><tr><td>updateDescription.removedFields</td><td>变更中删除的字段</td></tr><tr><td>clusterTime</td><td>对应oplog关联的时间戳</td></tr><tr><td>txnNumber</td><td>事务编号，仅在多文档事务中出现，MongoDB4.0 版本支持</td></tr><tr><td>lsid</td><td>事务关联的会话号，仅在多文档事务中出现，MongoDB4.0 版本支持</td></tr></tbody></table> 
<h3><a id="Change_Stream__58"></a>Change Stream 故障恢复</h3> 
<p>假设在一系列写入操作的过程中，订阅 Change Stream 的应用在接收到“写3”之后 于 t0 时刻崩溃，重启后后续的变更怎么办？<br><img src="https://images2.imgbox.com/3c/c5/1okPEk88_o.png" alt="image.png"><br>想要从上次中断的地方继续获取变更流，只需要保留上次变更通知中的 _id 即可。 Change Stream 回调所返回的的数据带有 _id，这个 _id 可以用于断点恢复。例如：</p> 
<pre><code class="prism language-bash">var cs <span class="token operator">=</span> db.collection.watch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token punctuation">{<!-- --></span>resumeAfter: <span class="token operator">&lt;</span>_id<span class="token operator">&gt;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>即可从上一条通知中断处继续获取后续的变更通知。</p> 
<h3><a id="_64"></a>使用场景</h3> 
<ul><li>监控</li></ul> 
<p>用户需要及时获取变更信息（例如账户相关的表），ChangeStreams 可以提供监控功能，一旦相关的表信息发生变更，就会将变更的消息实时推送出去。</p> 
<ul><li>分析平台</li></ul> 
<p>例如需要基于增量去分析用户的一些行为，可以基于 ChangeStreams 把数据拉出来，推到下游的计算平台， 比如类似 Flink、Spark 等计算平台等等。</p> 
<ul><li>数据同步</li></ul> 
<p>基于 ChangeStreams，用户可以搭建额外的 MongoDB 集群，这个集群是从原端的 MongoDB 拉取过来的， 那么这个集群可以做一个热备份，假如源端集群发生网络不通等等之类的变故，备集群就可以接管服务。 还可以做一个冷备份，如用户基于 ChangeStreams 把数据同步到文件，万一源端数据库发生不可服务， 就可以从文件里恢复出完整的 MongoDB 数据库， 继续提供服务。（当然，此处还需要借助定期全量备份来一同完成恢复） 另外数据同步它不仅仅局限于同一地域，可以跨地域，从北京到上海甚至从中国到美国等等。</p> 
<ul><li>消息推送</li></ul> 
<p>假如用户想实时了解公交车的信息，那么公交车的位置每次变动，都实时推送变更的信息给想了解的用户，用户能够实时收到公交车变更的数据，非常便捷实用。</p> 
<p>注意事项</p> 
<ul><li>Change Stream 依赖于 oplog，因此中断时间不可超过 oplog 回收的最大时间窗；</li><li>在执行 update 操作时，如果只更新了部分数据，那么 Change Stream 通知的也是增量部分；</li><li>删除数据时通知的仅是删除数据的 _id。</li></ul> 
<h3><a id="Spring_Boot_Chang_Stream_87"></a>Spring Boot 整合Chang Stream</h3> 
<p>（1）引入依赖</p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span><span class="token operator">!</span>--spring data mongodb--<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.springframework.boot<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring-boot-starter-data-mongodb<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>（2）配置 yml</p> 
<pre><code class="prism language-bash">spring:
	data:
		mongodb:
			uri: mongodb://firechou:firechou@192.168.65.174:28017,192.168.65.174:28018,192.168.65.174:28019/test?authSource<span class="token operator">=</span>admin<span class="token operator">&amp;</span><span class="token assign-left variable">replicaSet</span><span class="token operator">=</span>rs0
</code></pre> 
<p>（3）配置 mongo 监听器的容器 MessageListenerContainer，spring 启动时会自动启动监听的任务用于接收 changestream</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MongodbConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">MessageListenerContainer</span> <span class="token function">messageListenerContainer</span><span class="token punctuation">(</span><span class="token class-name">MongoTemplate</span> template<span class="token punctuation">,</span> <span class="token class-name">DocumentMessageListener</span> documentMessageListener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">Executor</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">MessageListenerContainer</span> messageListenerContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMessageListenerContainer</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> executor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAutoStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token class-name">ChangeStreamRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">&gt;</span></span> request <span class="token operator">=</span> <span class="token class-name">ChangeStreamRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>documentMessageListener<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span> <span class="token comment">// 需要监听的集合名</span>
        <span class="token comment">// 过滤需要监听的操作类型，可以根据需求指定过滤条件</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Aggregation</span><span class="token punctuation">.</span><span class="token function">newAggregation</span><span class="token punctuation">(</span><span class="token class-name">Aggregation</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>
            <span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"operationType"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">"insert"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span>
                                               <span class="token string">"delete"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// 不设置时，文档更新时，只会发送变更字段的信息，设置UPDATE_LOOKUP会返回文档的全部信息</span>
        <span class="token punctuation">.</span><span class="token function">fullDocumentLookup</span><span class="token punctuation">(</span><span class="token class-name">FullDocument</span><span class="token punctuation">.</span><span class="token constant">UPDATE_LOOKUP</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageListenerContainer<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">Document</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> messageListenerContainer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（4）配置 mongo 监听器，用于接收数据库的变更信息</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DocumentMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">MessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Received Message in collection                                         %s.\n\trawsource: %s\n\tconverted: %s"</span><span class="token punctuation">,</span>
             message<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCollectionName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
             message<span class="token punctuation">.</span><span class="token function">getRaw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
             message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3bb724be11e14abe0e6be17777258476/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">模型评估：A/B测试的陷阱</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2dd1ffbee40518819b5948902f0e342e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">跳跃游戏，经典算法实战。</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>