<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>forkjoinpool源码分析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="forkjoinpool源码分析" />
<meta property="og:description" content="ForkJoinPool是用于执行ForkJoinTask任务的ExecutorService。 ForkJoinPool不仅提供了来自非ForkJoinTask任务提交的入口，另外还提供相关的管理和监控。
ForkJoinPool与其他类型的ExecutorService的不同之处主要在于，它采用了工作窃取算法：池中的所有线程都会尝试查找并执行池中的任务或由其他活动任务所创建的任务（如果不存在，则需要阻塞等待） 。当大量任务产生其他子任务时（大多数ForkJoinTask就是如此）及外部提交者向池中提交大量小任务时，这可以实现高效处理。特别是在构造函数中将asyncMode设置为true时，ForkJoinPools可能更适用于未汇总的event-style任务。
静态方法commonPool()返回一个通用的ForkJoinPool对象common，它适用于大多数情况。任何未显式提交到指定pool池的ForkJoinTask任务都将使用此方法返回的common 池，使用common池通常会减少资源使用(它在不使用期间缓慢回收线程，并在后续使用时将这些线程恢复)。
对于需要单独或自定义pool池的程序，可以使用构造方法的parallelism参数设定并行度，默认情况下，并行度等于可用的处理器数。ForkJoinPool通过动态添加、挂起、恢复内部的工作线程来维护足够数量的活动（可用）线程，即使某些任务因等待其他任务的join汇总而停滞拖延。但是，面对阻塞的I / O或其他非托管的同步，无法保证此类的自适应调整。内部类接口ForkJoinPool.ManagedBlocker扩展了可容纳的同步类型。
除了执行任务和对生命周期控制的方法之外，此类还提供状态监控方法（例如getStealCount），旨在帮助开发，调整和监视fork / join应用程序。同样，方法toString以一种方便的形式返回池状态的指示，以进行非正式监视。
与其他ExecutorService一样，下表总结了三种主要的任务执行方法。这些方法的主要形式接受ForkJoinTask的实例，但是重载形式还允许执行基于普通的Runnable或Callable任务。
非fork/join端调用（Call from non-fork/join clients）fork/join内部调用(Call from within fork/join computations)安排异步执行(Arrange async execution)ForkJoinPool.execute(ForkJoinTask)ForkJoinTask.fork()等待并获取结果(Arrange async execution)ForkJoinPool.invoke(ForkJoinTask)ForkJoinTask.invoke()安排执行并获取Future(Arrange exec and obtain Future)ForkJoinPool.submit(ForkJoinTask)ForkJoinTask.fork() (ForkJoinTasks are Futures) 字段 FokJoinPool的字段 常量 // Bounds 控制线程池相关边界的常量 // 二进制形式0b00000000_00000000_11111111_11111111 线程池索引掩码 static final int SMASK = 0xffff; // short bits == max index // 二进制形式0b00000000_000000000_1111111_11111111 工作者线程数的最大值 static final int MAX_CAP = 0x7fff; // max #workers - 1 //二进制形式0b00000000_00000000_11111111_11111110 // 用来取workQueues偶数槽下标,(二进制最低位强置为0,当最低位为0时，表示偶数) static final int EVENMASK = 0xfffe; // even short bits //二进制形式0b00000000_00000000_00000000_01111110 最大的槽位值（限制最多只有64们偶数槽位） static final int SQMASK = 0x007e; // max 64 (even) slots // Masks and units for WorkQueue." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/98a99093ddf335b6dd8ca2ad6569351c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-10T11:46:37+08:00" />
<meta property="article:modified_time" content="2022-01-10T11:46:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">forkjoinpool源码分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>ForkJoinPool是用于执行ForkJoinTask任务的ExecutorService。 ForkJoinPool不仅提供了来自非ForkJoinTask任务提交的入口，另外还提供相关的管理和监控。<br> ForkJoinPool与其他类型的ExecutorService的不同之处主要在于，它采用了工作窃取算法：池中的所有线程都会尝试查找并执行池中的任务或由其他活动任务所创建的任务（如果不存在，则需要阻塞等待） 。当大量任务产生其他子任务时（大多数ForkJoinTask就是如此）及外部提交者向池中提交大量小任务时，这可以实现高效处理。特别是在构造函数中将asyncMode设置为true时，ForkJoinPools可能更适用于未汇总的event-style任务。</p> 
<img src="https://images2.imgbox.com/bd/5b/iGaQWnPu_o.png" title="工作窃取算法"> 
<img src="https://images2.imgbox.com/d6/63/68GFZXpM_o.png"> 
<p>静态方法<code>commonPool()</code>返回一个通用的ForkJoinPool对象common，它适用于大多数情况。任何未显式提交到指定pool池的ForkJoinTask任务都将使用此方法返回的common 池，使用common池通常会减少资源使用(它在不使用期间缓慢回收线程，并在后续使用时将这些线程恢复)。<br> 对于需要单独或自定义pool池的程序，可以使用构造方法的parallelism参数设定并行度，默认情况下，并行度等于可用的处理器数。ForkJoinPool通过动态<strong>添加</strong>、<strong>挂起</strong>、<strong>恢复</strong>内部的<strong>工作线程</strong>来维护足够数量的活动（可用）线程，即使某些任务因等待其他任务的join汇总而停滞拖延。但是，面对阻塞的I / O或其他非托管的同步，无法保证此类的自适应调整。内部类接口<code>ForkJoinPool.ManagedBlocker</code>扩展了可容纳的同步类型。<br> 除了执行任务和对生命周期控制的方法之外，此类还提供状态监控方法（例如getStealCount），旨在帮助开发，调整和监视fork / join应用程序。同样，方法toString以一种方便的形式返回池状态的指示，以进行非正式监视。<br> 与其他ExecutorService一样，下表总结了三种主要的任务执行方法。这些方法的主要形式接受ForkJoinTask的实例，但是重载形式还允许执行基于普通的Runnable或Callable任务。<br> <img src="https://images2.imgbox.com/97/a0/jrUxTXeA_o.png"></p> 
<img src="https://images2.imgbox.com/6d/31/B0F2g2NH_o.png"> 
<table><thead><tr><th></th><th>非fork/join端调用<font size="1">（Call from non-fork/join clients）</font></th><th>fork/join内部调用<font size="1">(Call from within fork/join computations)</font></th></tr></thead><tbody><tr><td>安排异步执行<font size="1">(Arrange async execution)</font></td><td>ForkJoinPool.execute(ForkJoinTask)</td><td>ForkJoinTask.fork()</td></tr><tr><td>等待并获取结果<font size="1">(Arrange async execution)</font></td><td>ForkJoinPool.invoke(ForkJoinTask)</td><td>ForkJoinTask.invoke()</td></tr><tr><td>安排执行并获取Future<font size="1">(Arrange exec and obtain Future)</font></td><td>ForkJoinPool.submit(ForkJoinTask)</td><td>ForkJoinTask.fork() <font size="1">(ForkJoinTasks are Futures)</font></td></tr></tbody></table> 
<h2><a id="_28"></a>字段</h2> 
<h3><a id="FokJoinPool_30"></a>FokJoinPool的字段</h3> 
<h4><a id="_32"></a>常量</h4> 
<pre><code class="prism language-java">    <span class="token comment">// Bounds 控制线程池相关边界的常量</span>
    <span class="token comment">// 二进制形式0b00000000_00000000_11111111_11111111  线程池索引掩码</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SMASK <span class="token operator">=</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>        <span class="token comment">// short bits == max index</span>
    <span class="token comment">// 二进制形式0b00000000_000000000_1111111_11111111   工作者线程数的最大值</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_CAP <span class="token operator">=</span> <span class="token number">0x7fff</span><span class="token punctuation">;</span>        <span class="token comment">// max #workers - 1</span>
    <span class="token comment">//二进制形式0b00000000_00000000_11111111_11111110</span>
<span class="token comment">//   用来取workQueues偶数槽下标,(二进制最低位强置为0,当最低位为0时，表示偶数)</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> EVENMASK <span class="token operator">=</span> <span class="token number">0xfffe</span><span class="token punctuation">;</span>        <span class="token comment">// even short bits</span>
    <span class="token comment">//二进制形式0b00000000_00000000_00000000_01111110  最大的槽位值（限制最多只有64们偶数槽位）</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SQMASK <span class="token operator">=</span> <span class="token number">0x007e</span><span class="token punctuation">;</span>        <span class="token comment">// max 64 (even) slots</span>


    <span class="token comment">// Masks and units for WorkQueue.scanState and ctl sp subfield  </span>
<span class="token comment">//控制WorkQueue的scanState属性 、及ForkJoinPool的ctl属性的低32位sp子属性</span>
    <span class="token comment">//二进制形式0b00000000_00000000_00000000_00000001  ，runState的最低位，1表示正在扫描，0表示正在执行任务</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SCANNING <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>             <span class="token comment">// false when running tasks</span>
   <span class="token comment">//  二进制形式0b10000000_00000000_00000000_00000000    runState最高位为1，表示此线程是INACTIVE空闲的</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> INACTIVE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">;</span>       <span class="token comment">// must be negative</span>
   <span class="token comment">// 0b00000000_00000001_00000000_00000000  版本号，让线程池索引加1，取下一个线程</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SS_SEQ <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>       <span class="token comment">// version count</span>

    <span class="token comment">// Mode bits for ForkJoinPool.config and WorkQueue.config 控制ForkJoinPool.config和WorkQueue.config属性的常量</span>

   <span class="token comment">// 二进制形式0b11111111_11111111_00000000_00000000  获取当前队列mode的掩码，只取config的高16位</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MODE_MASK <span class="token operator">=</span> <span class="token number">0xffff</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>  <span class="token comment">// top half of int</span>
    <span class="token comment">// 二进制形式0b00000000_00000000_00000000_00000000 先进先出模式(异步模式)，将WorkQueue看作(内部任务)队列</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> LIFO_QUEUE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token comment">// 二进制形式0b00000000_00000001_00000000_00000000 后时先出模式(非异步模式)，将WorkQueue看作(内部任务)栈</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> FIFO_QUEUE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
    <span class="token comment">//  二进制形式0b10000000_00000000_00000000_00000000  共离模式，提交外部任务放入的队列</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SHARED_QUEUE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">;</span>       <span class="token comment">// must be negative</span>

     
    <span class="token comment">// Lower and upper word masks  分别取ctl的高32位和低32位的掩码</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> SP_MASK    <span class="token operator">=</span> <span class="token number">0</span>xffffffffL<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> UC_MASK    <span class="token operator">=</span> <span class="token operator">~</span>SP_MASK<span class="token punctuation">;</span>

    <span class="token comment">// Active counts  获取活动线程数的相关掩码</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span>  AC_SHIFT   <span class="token operator">=</span> <span class="token number">48</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> AC_UNIT    <span class="token operator">=</span> <span class="token number">0</span>x0001L <span class="token operator">&lt;&lt;</span> AC_SHIFT<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> AC_MASK    <span class="token operator">=</span> <span class="token number">0</span>xffffL <span class="token operator">&lt;&lt;</span> AC_SHIFT<span class="token punctuation">;</span>

    <span class="token comment">// Total counts 获取部线程数的相关掩码</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span>  TC_SHIFT   <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> TC_UNIT    <span class="token operator">=</span> <span class="token number">0</span>x0001L <span class="token operator">&lt;&lt;</span> TC_SHIFT<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> TC_MASK    <span class="token operator">=</span> <span class="token number">0</span>xffffL <span class="token operator">&lt;&lt;</span> TC_SHIFT<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> ADD_WORKER <span class="token operator">=</span> <span class="token number">0</span>x0001L <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>TC_SHIFT <span class="token operator">+</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// sign</span>

    <span class="token comment">// runState bits: SHUTDOWN must be negative, others arbitrary powers of two</span>
   <span class="token comment">//执行器运行状态的掩码。</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span>  RSLOCK     <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span>  RSIGNAL    <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span>  STARTED    <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span>  STOP       <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">29</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span>  TERMINATED <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span>  SHUTDOWN   <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">;</span>
</code></pre> 
<p>上面这些常量，大多都是获取相关属性的各分割位的掩码。SMASK 、SQMASK是获取线程池中线程数相关边界的掩码，SCANNING 、INACTIVE等又是设置获取runState及 ctl的sp子属性相关分割位含义的掩码。</p> 
<h4><a id="_95"></a>成员变量</h4> 
<pre><code class="prism language-java"><span class="token comment">// Instance fields</span>
<span class="token keyword">volatile</span> <span class="token keyword">long</span> ctl<span class="token punctuation">;</span>                   <span class="token comment">// main pool control  </span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> runState<span class="token punctuation">;</span>               <span class="token comment">// lockable status</span>
<span class="token comment">// config二进制形式的低16位表示parallelism，</span>
<span class="token comment">//config二进制形式的第高16位表示mode,1表示异步模式，使用先进先出队列，0表示同步模式，使用先进后出栈</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> config<span class="token punctuation">;</span>  <span class="token comment">// parallelism, mode   低16位表示workerQueue在pool中的索引，高16位表示mode, 有FIFI LIFL   </span>
<span class="token keyword">int</span> indexSeed<span class="token punctuation">;</span>         <span class="token comment">// to generate worker index  生成workerQueue索引的重要依据</span>
<span class="token comment">//工作者队列数组，内部线程ForkJoinWorkerThread启动时会注册一个WorkerQueue对象到这个数组中</span>
<span class="token keyword">volatile</span> <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> workQueues<span class="token punctuation">;</span>     <span class="token comment">// main registry </span>
<span class="token comment">//工作者线程线程工厂，创建ForkJoinWorkerThread的策略</span>
<span class="token keyword">final</span> <span class="token class-name">ForkJoinWorkerThreadFactory</span> factory<span class="token punctuation">;</span>  
<span class="token keyword">final</span> <span class="token class-name">UncaughtExceptionHandler</span> ueh<span class="token punctuation">;</span>  <span class="token comment">// per-worker UEH 在线程因未捕异常而退出时，java虚拟机将回调的异常处理策略</span>
<span class="token keyword">final</span> <span class="token class-name">String</span> workerNamePrefix<span class="token punctuation">;</span>       <span class="token comment">// to create worker name string  工作者线程名的前缀</span>
<span class="token keyword">volatile</span> <span class="token class-name">AtomicLong</span> stealCounter <span class="token comment">//执行器所有线程窃取的任务总数，也作为监视runState的锁。</span>
<span class="token comment">//通用的执行器，它在静态块中初始化</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ForkJoinPool</span> common<span class="token punctuation">;</span> 
</code></pre> 
<p><code>ctl</code>：执行器的主要控制属性。它可以可以分割为4个子字段。</p> 
<pre><code> AC：ctl最高的16位，它表示"active  workers — parallelism"（活动线程数减去预设的并行度），因此它为负数时表明活动线程不够。

TC: ctl的33位至47位，它表示“total workers — parallelism” (部线程数送去预设的并行度)，因此它为负数时表明总线程数太少。

SS：ctl的低32位，ctl的16位至1位表示版本号，ctl的32-17位表示处于栈顶(此时将WorkQueue看作栈)的空闲线程的状态

ID : ctl的低32位， 表示下次使用的线程池索引
</code></pre> 
<p>可见ctl的低32位同时表示SS和ID,因此将ctl的低32位可统称为sp，sp非零表示当前池中没有空闲线程。</p> 
<p><code>runState</code>: 表示线程池的运行状态，它有RSLOCK、 RSIGNAL 、STOP 、 TERMINATED 、SHUTDOWN这几种状态</p> 
<p><code>config</code>: 执行器的配置信息，包括并行度、模式。此属性在构造方法中初始化后就不再变化。并行度即预先估计的线程数，而模式表示是否为异步模式。若是异步模式就将WorkQueue当作队列，反之将WorkQueue当作栈。</p> 
<p><code>indexSeed</code>：生成工作者的随机索引(workQueues的槽位索引)的重要依据</p> 
<p><code>factory</code>：线程工厂，创建ForkJoinWorkerThread的策略</p> 
<p><code>ueh</code> ：在线程因未捕异常而退出时，java虚拟机将回调的异常处理策略</p> 
<p><code>workerNamePrefix</code>：工作者线程名的前缀</p> 
<p><code>stealCounter</code>：当前执行器所有线程所窃取的任务总数，也作为监视runState的锁</p> 
<p><code>common</code>：通用的执行器，它在静态块中初始化。当workQueue未指定执行器时就使用这个执行器。</p> 
<h3><a id="WorkerQueue_145"></a>WorkerQueue的字段</h3> 
<pre><code class="prism language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> INITIAL_QUEUE_CAPACITY <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">;</span><span class="token comment">//队列的初始容量</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAXIMUM_QUEUE_CAPACITY <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">;</span> <span class="token comment">// 64M 队列的最大容量</span>

<span class="token comment">// Instance fields</span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> scanState<span class="token punctuation">;</span>    <span class="token comment">// versioned, &lt;0: inactive; odd:scanning</span>
<span class="token keyword">int</span> stackPred<span class="token punctuation">;</span>             <span class="token comment">// pool stack (ctl) predecessor</span>
<span class="token keyword">int</span> nsteals<span class="token punctuation">;</span>               <span class="token comment">// number of steals</span>
<span class="token keyword">int</span> hint<span class="token punctuation">;</span>                  <span class="token comment">// randomization and stealer index hint</span>
<span class="token keyword">int</span> config<span class="token punctuation">;</span>                <span class="token comment">// pool index and mode  </span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> qlock<span class="token punctuation">;</span>        <span class="token comment">// 1: locked, &lt; 0: terminate; else 0   </span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> base<span class="token punctuation">;</span>         <span class="token comment">// index of next slot for poll</span>
<span class="token keyword">int</span> top<span class="token punctuation">;</span>                   <span class="token comment">// index of next slot for push</span>
<span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">;</span>   <span class="token comment">// the elements (initially unallocated)</span>
<span class="token keyword">final</span> <span class="token class-name">ForkJoinPool</span> pool<span class="token punctuation">;</span>   <span class="token comment">// the containing pool (may be null)</span>
<span class="token keyword">final</span> <span class="token class-name">ForkJoinWorkerThread</span> owner<span class="token punctuation">;</span> <span class="token comment">// owning thread or null if shared</span>
<span class="token keyword">volatile</span> <span class="token class-name">Thread</span> parker<span class="token punctuation">;</span>    <span class="token comment">// == owner during call to park; else null</span>
<span class="token keyword">volatile</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> currentJoin<span class="token punctuation">;</span>  <span class="token comment">// task being joined in awaitJoin</span>
<span class="token keyword">volatile</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> currentSteal<span class="token punctuation">;</span> <span class="token comment">// mainly used by helpStealer</span>
</code></pre> 
<ul><li> <p><code>scanState</code>: 它可以看作是乐观锁的版本号，另外它还有此其他功能，它为负数时，表示工作者线程非活动，它为奇数是表示，正在扫描（准备窃取）任务，它为偶数是表示正在执行任务。</p> </li><li> <p><code>stackPred</code>: 表示在线程池栈当前工作线程的前驱线程的索引。在唤醒线程时常用到此属性。</p> </li><li> <p><code>nsteals</code>: 表示owner线程窃取的任务数</p> </li><li> <p><code>hint</code>：任务窃取时的随机定位种子</p> </li><li> <p><code>config</code>：低16位表示，当前WorkerQueue对象在外部类的数组属性workQueues中的索引(下标) 。高16位表示当前WorkerQueue对象的模式。对于内部任务，若构造方法配置为异步模式就将WorkQueue当作先进先出的队列，反之将WorkQueue当作后进先出的栈。对于外部任务，将WorkQueue视为共享队列。</p> </li><li> <p><code>qlock</code>：初始值为0，”=1“时表示当前WorkerQueue对象被锁住，” &lt; 0“时 表示当前WorkerQueue对象已终止，队列中的其他未完成任务将不再被执行。</p> </li><li> <p><code>base</code>：表示下次对任务数组array进行poll出队操作(窃取任务)的槽位索引(队尾)</p> </li><li> <p><code>top</code>：表示下次任务数组array进行push入栈操作(添加任务)的槽位索引(栈顶)</p> </li><li> <p><code>array</code>：非学重要的属性，这用是保存任务的数组(容器)</p> </li><li> <p><code>pool</code>：与之关联的ForkJoinPool执行器,它可能为空。若为空，就使用静态变量common作为执行器</p> </li><li> <p><code>owner</code>：当前队列对应的工作者线程，它一般不为空。若从外部提交任务时，当前WorkerQueue对象表示共享队列，owner为空。</p> </li><li> <p><code>parker</code>：阻塞的线程。在被阻塞的时候，它等于owner，其他时候它为空。</p> </li><li> <p><code>currentJoin</code>：表示当前正在join的任务，主要在awaitJoin方法使用</p> </li><li> <p><code>currentSteal</code>：表示当前被窃取的任务，主要在helpStealer方法中使用。</p> </li></ul> 
<h2><a id="runState_191"></a>runState锁的获取与释放</h2> 
<p>lockRunState</p> 
<p>获取runState锁：</p> 
<p>(当前锁已被持有)或（当前未被持有且再获取锁状态还失败）时，等待awaitRunStateLock方法(自旋或阻塞)完成后返回，</p> 
<p>当前锁未被持有且获取锁状态成功，就直接返回。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">lockRunState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> rs<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">=</span> runState<span class="token punctuation">)</span> <span class="token operator">&amp;</span> RSLOCK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token comment">//当前runState锁未被持有</span>
             <span class="token operator">!</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> RUNSTATE<span class="token punctuation">,</span> rs<span class="token punctuation">,</span> rs <span class="token operator">|=</span> RSLOCK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token comment">//不是锁状态再去获取锁状态失败</span>
            <span class="token function">awaitRunStateLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> rs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>awaitRunStateLock()</p> 
<p>的核心逻辑：</p> 
<p>当前锁未被持有，就CAS自旋获取锁状态(CAS更新为锁定状态)，</p> 
<p>已获取到锁状态，尝试CAS将runState更新为等待信号RSIGNAL的状态 , CAS更新成功，就让当前线程阻塞等待 ，CAS更新失败，就重新自旋。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">awaitRunStateLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Object</span> lock<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> wasInterrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> spins <span class="token operator">=</span> SPINS<span class="token punctuation">,</span> r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> rs<span class="token punctuation">,</span> ns<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">=</span> runState<span class="token punctuation">)</span> <span class="token operator">&amp;</span> RSLOCK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//runState锁未被持有，尝试CAS获取锁状态(CAS更新为锁定状态)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> RUNSTATE<span class="token punctuation">,</span> rs<span class="token punctuation">,</span> ns <span class="token operator">=</span> rs <span class="token operator">|</span> RSLOCK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>wasInterrupted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> ns<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">//随机种子为0，需要重新获随机种子</span>
            r <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">nextSecondarySeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            
            r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> r <span class="token operator">^=</span> r <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">21</span><span class="token punctuation">;</span> r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">// xorshift 异或运算将随机种子更随机</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token operator">--</span>spins<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">&amp;</span> STARTED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>lock <span class="token operator">=</span> stealCounter<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">//执行服务还启动、 未初始化,存在线程竞争，当前线程礼让等待它的初始化</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// initialization race</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> RUNSTATE<span class="token punctuation">,</span> rs<span class="token punctuation">,</span> rs <span class="token operator">|</span> RSIGNAL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//cas更runState新为等待通知RSIGNAL的状态</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>runState <span class="token operator">&amp;</span> RSIGNAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//即(runState &amp; RSIGNAL) ==1 ，如果已是等待通知RSIGNAL的状态。让当前线程阻塞等待</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        lock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span>
                              <span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            wasInterrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>  <span class="token comment">//RSIGNAL状态已解除，就唤醒所有等待通知的线程。</span>
                    lock<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>unlockRunState</code>方法释放锁并重设runState. 其方法逻辑简单</p> 
<p>先使用CAS更新runState为SINGAL，即CAS释放锁状态；若CAS失败，就使用java原生的“等待/通知”模型唤醒线程。这里刚好与上面的awaitRunStateLock对应上。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unlockRunState</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldRunState<span class="token punctuation">,</span> <span class="token keyword">int</span> newRunState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> RUNSTATE<span class="token punctuation">,</span> oldRunState<span class="token punctuation">,</span> newRunState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Object</span> lock <span class="token operator">=</span> stealCounter<span class="token punctuation">;</span>
        runState <span class="token operator">=</span> newRunState<span class="token punctuation">;</span>             <span class="token comment">// clears RSIGNAL bit</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> lock<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="Worker_286"></a>创建、注册、注销Worker</h2> 
<h4><a id="tryAddWorkerlong_288"></a><code>tryAddWorker(long)</code></h4> 
<p><code>tryAddWorker(long)</code>尝试创建一个ForkJoinWorkerThread线程：</p> 
<p>主要逻辑：如果可用线程太少、执行器未终止且线程数预更新成功，就创建并启动一个ForkJoinWorkerThread线程</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">tryAddWorker</span><span class="token punctuation">(</span><span class="token keyword">long</span> c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">boolean</span> add <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//AC(活动线程数)和TC(总线程数)均加1</span>
        <span class="token keyword">long</span> nc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>AC_MASK <span class="token operator">&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> AC_UNIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                   <span class="token punctuation">(</span>TC_MASK <span class="token operator">&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> TC_UNIT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctl <span class="token operator">==</span> c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> rs<span class="token punctuation">,</span> stop<span class="token punctuation">;</span>                 <span class="token comment">// check if terminating</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>stop <span class="token operator">=</span> <span class="token punctuation">(</span>rs <span class="token operator">=</span> <span class="token function">lockRunState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> STOP<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//获取runState锁后检查执行器是否停止</span>
                <span class="token comment">//更新AC 与TC</span>
                add <span class="token operator">=</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> CTL<span class="token punctuation">,</span> c<span class="token punctuation">,</span> nc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">unlockRunState</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> rs <span class="token operator">&amp;</span> <span class="token operator">~</span>RSLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stop <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>add<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">createWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//创建ForkJoinWorkerThread工作者，并启动(Thread.start())</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//"((c = ctl) &amp; ADD_WORKER) != 0L" ADD_WORKER取TC的最高位，即符号数，</span>
        <span class="token comment">//符号位非零说明TC为负数，即池中的线程总数小于配置的并行度，线程数太少</span>
        <span class="token comment">//(c只取ctl的低32位)c == 0表示池中没有空闲线程</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> ctl<span class="token punctuation">)</span> <span class="token operator">&amp;</span> ADD_WORKER<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0L</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//可用线程数不够就自旋，直到启动一个ForkJoinWorkerThread</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="createWorker_323"></a><code>createWorker()</code></h4> 
<p>createWorker()用来创建一个工作者线程，其核心逻辑是：构建并启动一个ForkJoinWorkerThread，若失败就回滚注销这个线程。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">createWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ForkJoinWorkerThreadFactory</span> fac <span class="token operator">=</span> factory<span class="token punctuation">;</span>
    <span class="token class-name">Throwable</span> ex <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinWorkerThread</span> wt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//构建并启动一个Worker线程，</span>
        <span class="token comment">//构建线程时构造方法ForkJoinWorkerThread()会执行registerWorker()注册工作者线程</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fac <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>wt <span class="token operator">=</span> fac<span class="token punctuation">.</span><span class="token function">newThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            wt<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> rex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ex <span class="token operator">=</span> rex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">deregisterWorker</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注销这个Worker线程</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="registerWorker_349"></a><code>registerWorker</code></h4> 
<p><code>registerWorker</code> 用来注册一个工作者线程。其核心逻辑是：</p> 
<p>将工作者线程wt放入workQueues中，并初始化wt的其他相关属性。而要将wt放入workQueues，就必须先计算wt的槽位索引，如果对应的槽位已被占用(索引碰撞)，就要重新计算索引(碰撞特别严重时需要对workQueues扩容)，</p> 
<pre><code class="prism language-java">    <span class="token keyword">final</span> <span class="token class-name">WorkQueue</span> <span class="token function">registerWorker</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span> wt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">UncaughtExceptionHandler</span> handler<span class="token punctuation">;</span>
        wt<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//设为守护线程         // configure thread</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>handler <span class="token operator">=</span> ueh<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            wt<span class="token punctuation">.</span><span class="token function">setUncaughtExceptionHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置未捕获异常处理策略</span>
        <span class="token class-name">WorkQueue</span> w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WorkQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> wt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                    <span class="token comment">// assign a pool index</span>
        <span class="token keyword">int</span> mode <span class="token operator">=</span> config <span class="token operator">&amp;</span> MODE_MASK<span class="token punctuation">;</span><span class="token comment">//获取mode,可能是LIFO_QUEUE或FIFO_QUEUE但不会是Shared_QUEUE</span>
        <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">lockRunState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取runState锁，</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">;</span>                    <span class="token comment">// skip if no array</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> ws<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//获得w的索引种子</span>
                <span class="token keyword">int</span> s <span class="token operator">=</span> indexSeed <span class="token operator">+=</span> SEED_INCREMENT<span class="token punctuation">;</span>  <span class="token comment">// unlikely to collide</span>
                <span class="token keyword">int</span> m <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//因为n是2的幂次方，所以m二进制形式的所有有效位均为1</span>
                <span class="token comment">//类似HashMap以取余来获取哈希桶的索引。这里“｜1”二进制最低位强制置为1，即i为奇数</span>
                i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> m<span class="token punctuation">;</span>               <span class="token comment">// odd-numbered indices</span>
                <span class="token comment">//算出的索引位已经有WorkerQueue，出现索引碰撞了，需要重新设计索引</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ws<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>                  <span class="token comment">// collision</span>
                    <span class="token keyword">int</span> probes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                   <span class="token comment">// step by approx half n</span>
                    <span class="token comment">//EVENMASK的最低位为0，"&amp; EVENMASK"使step为奇数，</span>
                    <span class="token comment">//那么"i+step"为奇数，所以也能保证"(i + step) &amp; m"为奇数</span>
                    <span class="token keyword">int</span> step <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> EVENMASK<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//取n的一半的最近偶数</span>
                    <span class="token comment">//重新计算槽位</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>ws<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> step<span class="token punctuation">)</span> <span class="token operator">&amp;</span> m<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>probes <span class="token operator">&gt;=</span> n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//碰撞非常严重，扩容后再定位</span>
                            workQueues <span class="token operator">=</span> ws <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> n <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            m <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                            probes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//初始化w的属性</span>
                w<span class="token punctuation">.</span>hint <span class="token operator">=</span> s<span class="token punctuation">;</span> <span class="token comment">//记录此workerqueue的索引种子      // use as random seed</span>
                w<span class="token punctuation">.</span>config <span class="token operator">=</span> i <span class="token operator">|</span> mode<span class="token punctuation">;</span> <span class="token comment">//记录此workerqueue的槽位和模式mode</span>
                w<span class="token punctuation">.</span>scanState <span class="token operator">=</span> i<span class="token punctuation">;</span>                      <span class="token comment">// publication fence</span>
                ws<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> w<span class="token punctuation">;</span><span class="token comment">//将queue放入对应的槽位</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">unlockRunState</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> rs <span class="token operator">&amp;</span> <span class="token operator">~</span>RSLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//设置线程名</span>
        wt<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>workerNamePrefix<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> w<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="deregisterWorker_406"></a>deregisterWorker</h4> 
<p>deregisterWorker</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">deregisterWorker</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span> wt<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">WorkQueue</span> w <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wt <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>w <span class="token operator">=</span> wt<span class="token punctuation">.</span>workQueue<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span>                           <span class="token comment">// remove index from array</span>
        <span class="token keyword">int</span> idx <span class="token operator">=</span> w<span class="token punctuation">.</span>config <span class="token operator">&amp;</span> SMASK<span class="token punctuation">;</span><span class="token comment">//获取queue在workQueues中的索引</span>
        <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">lockRunState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> ws<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> idx <span class="token operator">&amp;&amp;</span> ws<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> w<span class="token punctuation">)</span>
            <span class="token comment">//workQueues中存在这个workerQueue,</span>
            <span class="token comment">// 就将wt对应的workerQueue从workQueues中移除</span>
            ws<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token function">unlockRunState</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> rs <span class="token operator">&amp;</span> <span class="token operator">~</span>RSLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> c<span class="token punctuation">;</span>                                       <span class="token comment">// decrement counts</span>
    <span class="token comment">//将AC TC均减1(线程数少1)，ctl的低32位不变</span>
    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">U</span><span class="token punctuation">.</span>compareAndSwapLong
            <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> CTL<span class="token punctuation">,</span> c <span class="token operator">=</span> ctl<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>AC_MASK <span class="token operator">&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">-</span> AC_UNIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                    <span class="token punctuation">(</span>TC_MASK <span class="token operator">&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">-</span> TC_UNIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                    <span class="token punctuation">(</span>SP_MASK <span class="token operator">&amp;</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        w<span class="token punctuation">.</span>qlock <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//qlock&lt;0 表示此workerqueue已terminated    ensure set</span>
        w<span class="token punctuation">.</span><span class="token function">transferStealCount</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将此workerQueue的stealCount转移同步到外部类对应的属性上</span>
        w<span class="token punctuation">.</span><span class="token function">cancelAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取消此workerQueue上所有(未完成）任务  cancel remaining tasks</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//如果有需要，就用一个线程来替补这个即将终止的线程</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>                                    <span class="token comment">// possibly replace</span>
        <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span> <span class="token keyword">int</span> m<span class="token punctuation">,</span> sp<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">||</span> w <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> w<span class="token punctuation">.</span>array <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
                <span class="token punctuation">(</span>runState <span class="token operator">&amp;</span> STOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
                <span class="token punctuation">(</span>m <span class="token operator">=</span> ws<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>              <span class="token comment">// already terminating</span>
            <span class="token comment">//如果执行器已(正)终止或没有可执行的任务，就不需要替补</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>c <span class="token operator">=</span> ctl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//还有空闲线程就唤醒一个线程来替补 wake up replacement</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> ws<span class="token punctuation">[</span>sp <span class="token operator">&amp;</span> m<span class="token punctuation">]</span><span class="token punctuation">,</span> AC_UNIT<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//若池中没有空闲线程、线程数少(不足以支持配置的并行度)且这个线程是因异常而终止的，</span>
        <span class="token comment">//就创建一个线程</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">&amp;</span> ADD_WORKER<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">tryAddWorker</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// create replacement</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token comment">//其他情况不需要替代终止的线程  don't need replacement</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//处理异常</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                               <span class="token comment">// help clean on way out</span>
        <span class="token class-name">ForkJoinTask</span><span class="token punctuation">.</span><span class="token function">helpExpungeStaleExceptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>                                          <span class="token comment">// rethrow</span>
        <span class="token class-name">ForkJoinTask</span><span class="token punctuation">.</span><span class="token function">rethrow</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="Scanning_for_tasks_467"></a>Scanning for tasks</h2> 
<p>runWorker：此方法是worker线程执行任务的最上层循环，此方法直接被ForkJoinWorkerThread.run调用</p> 
<p>runWorker的主要逻辑：先到其他队列中窃取任务，如能窃取到任务，就先执行窃取的任务，然后执行自己本地的任务。若无法窃取到阻塞等待被窃取的任务</p> 
<h4><a id="runWorker_473"></a>runWorker</h4> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">WorkQueue</span> w<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    w<span class="token punctuation">.</span><span class="token function">growArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// allocate queue</span>
    <span class="token keyword">int</span> seed <span class="token operator">=</span> w<span class="token punctuation">.</span>hint<span class="token punctuation">;</span>               <span class="token comment">// initially holds randomization hint</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token punctuation">(</span>seed <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> seed<span class="token punctuation">;</span>  <span class="token comment">// avoid 0 for xorShift</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> t<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token function">scan</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">//随机窃取任务</span>
            w<span class="token punctuation">.</span><span class="token function">runTask</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先执行窃取来的任务t,然后执行w.array中的本地任务</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">awaitWork</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//阻塞等待被窃取的任务</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">;</span> r <span class="token operator">^=</span> r <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">17</span><span class="token punctuation">;</span> r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// xorshift 异或计算，使随机数更随机</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="scan_492"></a>scan</h4> 
<p>scan()扫描并尝试窃取任务。</p> 
<p>从一个随机的槽位开始扫描，然后此槽位对应的任务队列尾部窃取任务。若此槽位上没有任务或线程竞争激烈就再次随机方式移动槽位，反之以线性方式移动槽位，直到在两轮遍历中有相同的校验和就退出自旋（队尾索引连续为空时，对每个队列的队尾索引进行累加的结果称为校验和checkSum）返回null。 若扫描到的队列是活动的，将尾部任务返回，任务窃取成功。若扫描到的队列是非活动的，就尝试激活它，重新自旋。</p> 
<pre><code class="prism language-java">   <span class="token keyword">private</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">scan</span><span class="token punctuation">(</span><span class="token class-name">WorkQueue</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span> <span class="token keyword">int</span> m<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> ws<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> w <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> ss <span class="token operator">=</span> w<span class="token punctuation">.</span>scanState<span class="token punctuation">;</span>                     <span class="token comment">// initially non-negative</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> origin <span class="token operator">=</span> r <span class="token operator">&amp;</span> m<span class="token punctuation">,</span> k <span class="token operator">=</span> origin<span class="token punctuation">,</span> oldSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> checkSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">WorkQueue</span> q<span class="token punctuation">;</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">;</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> t<span class="token punctuation">;</span>
                <span class="token keyword">int</span> b<span class="token punctuation">,</span> n<span class="token punctuation">;</span> <span class="token keyword">long</span> c<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>q <span class="token operator">=</span> ws<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//随机获取一个workerqueue</span>
                    <span class="token comment">//保证随机的q中含有任务</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> q<span class="token punctuation">.</span>base<span class="token punctuation">)</span> <span class="token operator">-</span> q<span class="token punctuation">.</span>top<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                            <span class="token punctuation">(</span>a <span class="token operator">=</span> q<span class="token punctuation">.</span>array<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>      <span class="token comment">// non-empty</span>
                        <span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> b<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> ASHIFT<span class="token punctuation">)</span> <span class="token operator">+</span> ABASE<span class="token punctuation">;</span>
                        <span class="token comment">//在队列的尾部获取一个任务（此时array看作”队列“，只能从尾部窃取任务，）</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
                                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">getObjectVolatile</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                                q<span class="token punctuation">.</span>base <span class="token operator">==</span> b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//保证队列尾部索引未被其他线程修改</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>ss <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//w.owner线程是活动的（scanState是负数表示INACTIVE）</span>
                                <span class="token comment">//将q.array队列队尾的任务清空，并通知工作者线程</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> i<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    q<span class="token punctuation">.</span>base <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>       <span class="token comment">// signal others</span>
                                        <span class="token function">signalWork</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">return</span> t<span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment">//w.owner线程是INACTIVE,就激活线程w.owner线程</span>
                            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldSum <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>   <span class="token comment">// try to activate</span>
                                    w<span class="token punctuation">.</span>scanState <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                                <span class="token comment">//唤醒w.owner线程，并将AC(活动线程数)加1</span>
                                <span class="token function">tryRelease</span><span class="token punctuation">(</span>c <span class="token operator">=</span> ctl<span class="token punctuation">,</span> ws<span class="token punctuation">[</span>m <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>c<span class="token punctuation">]</span><span class="token punctuation">,</span> AC_UNIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">//队列q.array中没有任务或线程竞争激烈CAS更新失败，</span>
                        <span class="token comment">//或w.owner是INACTIVE,就重新获取scanState、随机移动到一个槽位</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ss <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                   <span class="token comment">// refresh</span>
                            ss <span class="token operator">=</span> w<span class="token punctuation">.</span>scanState<span class="token punctuation">;</span>
                        r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> r <span class="token operator">^=</span> r <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">;</span> r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span>
                        <span class="token comment">//随机获取workerQueue的槽位(r是随机的)</span>
                        origin <span class="token operator">=</span> k <span class="token operator">=</span> r <span class="token operator">&amp;</span> m<span class="token punctuation">;</span>           <span class="token comment">// move and rescan</span>
                        oldSum <span class="token operator">=</span> checkSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//重置为0</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    checkSum <span class="token operator">+=</span> b<span class="token punctuation">;</span><span class="token comment">//队列连续为空时，将队尾索引累加</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//q是空或q.array中没有任务时，无法窃取任务，重新计算索引</span>

                <span class="token comment">//"(k + 1) &amp; m”让索引位置线性移动，上次索引加1后用作除数再取余</span>
                <span class="token comment">//“(k + 1) &amp; m) == origin”表明经过索引若干次移动后跳回了最初始的索引位置</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> m<span class="token punctuation">)</span> <span class="token operator">==</span> origin<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    <span class="token comment">// continue until stable</span>
                    <span class="token comment">//ss &gt;= 0 表明w.owner线程之前是活动的(局部变量保存它之前的状态，后来其他线程可能已经将之修改，它可能不是最新的状态)，</span>
                    <span class="token comment">// "(ss == (ss = w.scanState)"w.owner线程之前是inactivate时就重新获取scanState</span>
                    <span class="token comment">//"oldSum == (oldSum = checkSum)"本轮与上轮的“队列连续为空时队尾索引累加值"相等</span>
                    <span class="token comment">//(每一轮的定义是：索引经若干次移动后第一次跳回最初始的索引位置)</span>
                    <span class="token comment">//若两者相等，可能就要出退出自旋，窃取任务失败</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ss <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>ss <span class="token operator">==</span> <span class="token punctuation">(</span>ss <span class="token operator">=</span> w<span class="token punctuation">.</span>scanState<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                            oldSum <span class="token operator">==</span> <span class="token punctuation">(</span>oldSum <span class="token operator">=</span> checkSum<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//更新上次的检验和oldSum</span>
                        <span class="token comment">//此w.owner是inactive，或此队列w已经terminated（终止），退出自旋，任务窃取失败</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ss <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> w<span class="token punctuation">.</span>qlock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment">// already inactive</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token comment">//w.owner是活动的,就将其设为inactivate</span>
                        <span class="token keyword">int</span> ns <span class="token operator">=</span> ss <span class="token operator">|</span> INACTIVE<span class="token punctuation">;</span>       <span class="token comment">// try to inactivate</span>
                        <span class="token keyword">long</span> nc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>SP_MASK <span class="token operator">&amp;</span> ns<span class="token punctuation">)</span> <span class="token operator">|</span>
                                <span class="token punctuation">(</span>UC_MASK <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> ctl<span class="token punctuation">)</span> <span class="token operator">-</span> AC_UNIT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//保存前一个栈顶</span>
                        w<span class="token punctuation">.</span>stackPred <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>c<span class="token punctuation">;</span>         <span class="token comment">// hold prev stack top</span>
                        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> QSCANSTATE<span class="token punctuation">,</span> ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//尝试更新ctl,并将更新runSate</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> CTL<span class="token punctuation">,</span> c<span class="token punctuation">,</span> nc<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            ss <span class="token operator">=</span> ns<span class="token punctuation">;</span><span class="token comment">//CAS更新成功，使用最新scanState</span>
                        <span class="token keyword">else</span>
                            w<span class="token punctuation">.</span>scanState <span class="token operator">=</span> ss<span class="token punctuation">;</span>  <span class="token comment">//CAS更新失败，使用之前的scanState back out</span>
                    <span class="token punctuation">}</span>
                    checkSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//将下次校验和初始化置为零</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="awaitWork_582"></a>awaitWork</h4> 
<p>awaitWork 方法为任务的窃取而阻塞工作者w(若w应终止返回false)。</p> 
<p>主要逻辑：若w应终止返回false ；若w状态是ACTIVE的就返回true.</p> 
<p>而若w状态是INACTIVE则要进行进一步的处理。 如果当前执行器停滞(没有活动线程)，就检查执行器是否终止，给当前线程设置给定的超时时间(若还有活动线程就不限时等待)。 在超时后，若w状态是INACTIVE的就返回true, 若ctl尚未被更改，就重置ctl，返回false.</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">awaitWork</span><span class="token punctuation">(</span><span class="token class-name">WorkQueue</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> w<span class="token punctuation">.</span>qlock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                 <span class="token comment">// w is terminating</span>
        <span class="token comment">//w.qlock&lt;0表示，此WorkQueue已经终止</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> pred <span class="token operator">=</span> w<span class="token punctuation">.</span>stackPred<span class="token punctuation">,</span> spins <span class="token operator">=</span> SPINS<span class="token punctuation">,</span> ss<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ss <span class="token operator">=</span> w<span class="token punctuation">.</span>scanState<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">//此w.owner线程是活动的active,当前方法返回true。而 runWorker方法会自旋重新窃取任务</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> r <span class="token operator">^=</span> r <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">21</span><span class="token punctuation">;</span> r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">--</span>spins <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token class-name">WorkQueue</span> v<span class="token punctuation">;</span> <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span> <span class="token keyword">int</span> s<span class="token punctuation">,</span> j<span class="token punctuation">;</span> <span class="token class-name">AtomicLong</span> sc<span class="token punctuation">;</span>
                <span class="token comment">//若w前驱对应线程没有被阻塞或是active的（active状态能确定它不可能被阻塞)，就继续自旋</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                        <span class="token punctuation">(</span>j <span class="token operator">=</span> pred <span class="token operator">&amp;</span> SMASK<span class="token punctuation">)</span> <span class="token operator">&lt;</span> ws<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span>
                        <span class="token punctuation">(</span>v <span class="token operator">=</span> ws<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>        <span class="token comment">// see if pred parking</span>
                        <span class="token punctuation">(</span>v<span class="token punctuation">.</span>parker <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> v<span class="token punctuation">.</span>scanState <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    spins <span class="token operator">=</span> SPINS<span class="token punctuation">;</span>                <span class="token comment">// continue spinning</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token punctuation">.</span>qlock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                     <span class="token comment">// recheck after spins</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">//此WorkQueue已经终止</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//当前线程未中断(若中断了就清除中断标志)</span>
            <span class="token keyword">long</span> c<span class="token punctuation">,</span> prevctl<span class="token punctuation">,</span> parkTime<span class="token punctuation">,</span> deadline<span class="token punctuation">;</span>
            <span class="token keyword">int</span> ac <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> ctl<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> AC_SHIFT<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>config <span class="token operator">&amp;</span> SMASK<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ac <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span><span class="token comment">//活动线程不够且执行器（已经或正在）终止</span>
                    <span class="token punctuation">(</span>runState <span class="token operator">&amp;</span> STOP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>           <span class="token comment">//执行器正在终止 pool terminating</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">//没有空闲的工作者线程</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ac <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ss <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>        <span class="token comment">// is last waiter</span>
                prevctl <span class="token operator">=</span> <span class="token punctuation">(</span>UC_MASK <span class="token operator">&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> AC_UNIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>SP_MASK <span class="token operator">&amp;</span> pred<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">(</span>c <span class="token operator">&gt;&gt;&gt;</span> TC_SHIFT<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// shrink excess spares</span>
                <span class="token comment">//增加一个活动线程、并记录w前驱的索引（空闲线程过多，减少空闲线程）</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> CTL<span class="token punctuation">,</span> c<span class="token punctuation">,</span> prevctl<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                 <span class="token comment">// else use timed wait</span>
                <span class="token comment">//cas失败，将执行下面的超时等待</span>
                parkTime <span class="token operator">=</span> IDLE_TIMEOUT <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                deadline <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> parkTime <span class="token operator">-</span> TIMEOUT_SLOP<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span><span class="token comment">//有其他的空闲线程，可能要不限时的休眠等待</span>
                prevctl <span class="token operator">=</span> parkTime <span class="token operator">=</span> deadline <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span> <span class="token comment">//</span>
            <span class="token class-name">Thread</span> wt <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//wt线程记录阻塞对象</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> PARKBLOCKER<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// emulate LockSupport</span>
            w<span class="token punctuation">.</span>parker <span class="token operator">=</span> wt<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token punctuation">.</span>scanState <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ctl <span class="token operator">==</span> c<span class="token punctuation">)</span>      <span class="token comment">// recheck before park</span>
                <span class="token comment">//wt是INACTIVE就休眠等待</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> parkTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//超时或被唤醒，将相关的parker清空</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> QPARKER<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> PARKBLOCKER<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token punctuation">.</span>scanState <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//wt是ACTIVE的，返回true</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parkTime <span class="token operator">!=</span> <span class="token number">0L</span> <span class="token operator">&amp;&amp;</span> ctl <span class="token operator">==</span> c <span class="token operator">&amp;&amp;</span>
                    deadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0L</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> CTL<span class="token punctuation">,</span> c<span class="token punctuation">,</span> prevctl<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">//减少空闲线程成功,执行器将终止,返回false</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                     <span class="token comment">// shrink pool</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="Joining_tasks_661"></a>Joining tasks</h2> 
<p>helpComplete 尝试窃取并执行指定的任务task。helpComplete 只能窃取CountedCompleter类型任务，CountedCompleter是ForJoinTask的子类。maxTasks参数表示从(除w之外)其他队列中窃取任务task的总数.</p> 
<p>helpComplete 的主要逻辑：</p> 
<p>先从w的本地队列中出队并执行（<code>popCC</code>方法）任务task，然后到其他队列中(队尾)窃取任务task执行。若在其他队列中窃取任务成功但还达到指定的窃取数目，就随机移动槽位，继续自旋；若在其他队列中没有窃取到任务，就线性移动槽位，直到两轮校验和相等就退出自旋</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">helpComplete</span><span class="token punctuation">(</span><span class="token class-name">WorkQueue</span> w<span class="token punctuation">,</span> <span class="token class-name">CountedCompleter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">,</span>
                       <span class="token keyword">int</span> maxTasks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span> <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> m<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> ws<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
            task <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> w <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> mode <span class="token operator">=</span> w<span class="token punctuation">.</span>config<span class="token punctuation">;</span>                 <span class="token comment">// for popCC</span>
        <span class="token keyword">int</span> r <span class="token operator">=</span> w<span class="token punctuation">.</span>hint <span class="token operator">^</span> w<span class="token punctuation">.</span>top<span class="token punctuation">;</span>              <span class="token comment">// arbitrary seed for origin</span>
        <span class="token keyword">int</span> origin <span class="token operator">=</span> r <span class="token operator">&amp;</span> m<span class="token punctuation">;</span>                  <span class="token comment">// first queue to scan</span>
       <span class="token comment">//h=1,表示窃取任务并执行成功，h&gt;1表示多线程竞争，h&lt;0表示队列队尾上不存在此任务 </span>
        <span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//1:ran, &gt;1:contended, &lt;0:hash</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> origin<span class="token punctuation">,</span> oldSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> checkSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">CountedCompleter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> p<span class="token punctuation">;</span> <span class="token class-name">WorkQueue</span> q<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> task<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment">//任务完成，直接返回</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">popCC</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//上次窃取任务成功，并在w的栈顶中成功出队,执行此任务</span>
                p<span class="token punctuation">.</span><span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// run local task</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>maxTasks <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">--</span>maxTasks <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token comment">//完成了给定数目的任务窃取工作，退出自旋</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment">//重置初始槽位、校验和()</span>
                origin <span class="token operator">=</span> k<span class="token punctuation">;</span>                  <span class="token comment">// reset</span>
                oldSum <span class="token operator">=</span> checkSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//上次任务窃取失败或w中不存在task,继续到其他队列中窃取任务</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//  poll other queues</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>q <span class="token operator">=</span> ws<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token comment">//队列不存在</span>
                    h <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">pollAndExecCC</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//队列的尾部没这个任务</span>
                    checkSum <span class="token operator">+=</span> h<span class="token punctuation">;</span><span class="token comment">//校验和累加</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//任务被成功窃取或存在多线程竞争需要重试</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> maxTasks <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">--</span>maxTasks <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token comment">//本次成功窃取任务且已完成给定数目的任务窃取工作，退出自旋</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token comment">//随机移动槽位</span>
                    r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">;</span> r <span class="token operator">^=</span> r <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">17</span><span class="token punctuation">;</span> r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// xorshift</span>
                    origin <span class="token operator">=</span> k <span class="token operator">=</span> r <span class="token operator">&amp;</span> m<span class="token punctuation">;</span>      <span class="token comment">// move and restart</span>
                    oldSum <span class="token operator">=</span> checkSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//队列q的尾部上没有指定任务，窃取失败，“(k + 1) &amp; m”表示需要线性移动槽位</span>
                <span class="token comment">//两轮连续窃取任务失败的校验和相等，就退出自旋</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> m<span class="token punctuation">)</span> <span class="token operator">==</span> origin<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//“k=origin”表示遍历一轮workerQueues</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldSum <span class="token operator">==</span> <span class="token punctuation">(</span>oldSum <span class="token operator">=</span> checkSum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//两轮校验和相等</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    checkSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="external_726"></a>external</h2> 
<h3><a id="externalPush_728"></a>externalPush</h3> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">externalPush</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span> <span class="token class-name">WorkQueue</span> q<span class="token punctuation">;</span> <span class="token keyword">int</span> m<span class="token punctuation">;</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//探针值，用于计算q在workQueues中的索引槽位</span>
    <span class="token keyword">int</span> rs <span class="token operator">=</span> runState<span class="token punctuation">;</span> <span class="token comment">//运行状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token punctuation">(</span>ws<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>  <span class="token comment">//workQueues非空，且workQueues可放入任务(长度大于1)</span>
        <span class="token comment">//与HashMap类似，m&amp;r是用来确定数组的索引（取余,这里的r相当于HashMap中Node的hash属性），</span>
        <span class="token comment">//SQMASK=Ob1111110,（SQMASK十进制为126，）它限制了槽位索引只能是0-126</span>
        <span class="token comment">//而SQMASK的二进制最低位为0，又相当于强制将"m &amp; r'的最低位设为0（二进制最低位为零时表示偶数），</span>
        <span class="token comment">//因此"m &amp; r &amp; SQMASK"的结果取0-126之间的偶数(共有64个偶数)。</span>
        <span class="token punctuation">(</span>q <span class="token operator">=</span> ws<span class="token punctuation">[</span>m <span class="token operator">&amp;</span> r <span class="token operator">&amp;</span> SQMASK<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> r <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> rs <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> QLOCK<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//锁定q，这里CAS更新成功后q.qlock为1，其他线程就不能CAS更新q.qlock了</span>
        <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">;</span> <span class="token keyword">int</span> am<span class="token punctuation">,</span> n<span class="token punctuation">,</span> s<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">=</span> q<span class="token punctuation">.</span>array<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>      
            <span class="token punctuation">(</span>am <span class="token operator">=</span> a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> q<span class="token punctuation">.</span>top<span class="token punctuation">)</span> <span class="token operator">-</span> q<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//q.array还可以放入新任务</span>
            <span class="token comment">//am二进制位全是1，所以am&amp;s ==s</span>
            <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>am <span class="token operator">&amp;</span> s<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> ASHIFT<span class="token punctuation">)</span> <span class="token operator">+</span> ABASE<span class="token punctuation">;</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> j<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将task放入到成员变量ForkJoinTask类型数组array中</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> QTOP<span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新下次入队位置的索引</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putIntVolatile</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> QLOCK<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//无条件更新q.qlock，解除对q的锁定</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">//队列中最多只有一个任务了，可以唤醒一个线程或创建一个新线程来执行任务</span>
                <span class="token function">signalWork</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> QLOCK<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//q.array无法容纳新任务时，也要解除对q的锁定，因数之前CAS成功将q.qlock更新为1</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//完整版本的externalPush</span>
    <span class="token comment">// workQueues 或workQueues[m &amp; r &amp; SQMASK]是空的，需要初始化相关属性，并提交任务</span>
    <span class="token function">externalSubmit</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="externalSubmit_762"></a>externalSubmit</h4> 
<p>externalSubmit 是完整版的externalPush，核心逻辑是：</p> 
<p>若执行器还未开始、workQueues未被初始化时，将执行器状态更新、并初始化相关属性</p> 
<p>若workQueues相应槽位的queue不为空，就将任务添加到这个queue中。</p> 
<p>若workQueues相应槽位的queue为空，创建一个新的共享队列放入workQueues中。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">externalSubmit</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> r<span class="token punctuation">;</span>                                    <span class="token comment">// initialize caller's probe</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//初始化线程的随机探针r</span>
            <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">localInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span> <span class="token class-name">WorkQueue</span> q<span class="token punctuation">;</span> <span class="token keyword">int</span> rs<span class="token punctuation">,</span> m<span class="token punctuation">,</span> k<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> move <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">=</span> runState<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//SHUTDOWN</span>
                <span class="token comment">//SHUTDOWN时尝试终止执行器</span>
                <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// help terminate</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//执行器还未开始、workQueues未被初始化时，初始化相关属性</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">&amp;</span> STARTED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>     <span class="token comment">// initialize</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> ws<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                rs <span class="token operator">=</span> <span class="token function">lockRunState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//锁住runState</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">&amp;</span> STARTED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//若执行器尚未开始，就被初始化workQueues、并更新执行器状态为STARTED(开始)</span>

                        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> STEALCOUNTER<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// create workQueues array with size a power of two</span>
                        <span class="token keyword">int</span> p <span class="token operator">=</span> config <span class="token operator">&amp;</span> SMASK<span class="token punctuation">;</span> <span class="token comment">// ensure at least 2 slots</span>
                        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> p <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span> n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">;</span>  n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
                        n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span> n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">;</span> n <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        workQueues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        ns <span class="token operator">=</span> STARTED<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//(rs &amp; ~RSLOCK)将释放锁状态（置为0） ，"|ns"将执行器状态置为STARTED</span>
                    <span class="token function">unlockRunState</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> <span class="token punctuation">(</span>rs <span class="token operator">&amp;</span> <span class="token operator">~</span>RSLOCK<span class="token punctuation">)</span> <span class="token operator">|</span> ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//执行器初始化、启动了，且workQueues中对应的槽位上存在WorkerQueue不空</span>
            <span class="token comment">// 就将当前任务添加到这个WorkerQueue的任务数组array中</span>
             <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>q <span class="token operator">=</span> ws<span class="token punctuation">[</span>k <span class="token operator">=</span> r <span class="token operator">&amp;</span> m <span class="token operator">&amp;</span> SQMASK<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//workerQueue锁未被持有时尝试抢锁成功</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span>qlock <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> QLOCK<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> q<span class="token punctuation">.</span>array<span class="token punctuation">;</span>
                    <span class="token keyword">int</span> s <span class="token operator">=</span> q<span class="token punctuation">.</span>top<span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> submitted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// initial submission or resizing</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>                      <span class="token comment">// locked version of push</span>
                        <span class="token comment">//workerQueue中“任务数组长度够用”或“长度不够用但扩容成功”</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> s <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">-</span> q<span class="token punctuation">.</span>base<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token comment">//array数组可容纳新任务</span>
                                <span class="token punctuation">(</span>a <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">growArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//扩容成功</span>
                            <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> s<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> ASHIFT<span class="token punctuation">)</span> <span class="token operator">+</span> ABASE<span class="token punctuation">;</span>
                            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> j<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在array数组中插入新任务</span>
                            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> QTOP<span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新栈顶索引</span>
                            submitted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//提交任务成功</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> QLOCK<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//workerQueue锁状态释放</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>submitted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//任务提交后，唤醒或创建一个工作者线程来执行任务</span>
                        <span class="token function">signalWork</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                move <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                   <span class="token comment">// move on failure</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//执行器初始化、启动了，且workQueues中对应的槽位为空，则创建一个queue放入这个槽位</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">=</span> runState<span class="token punctuation">)</span> <span class="token operator">&amp;</span> RSLOCK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// create new queue</span>
                q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WorkQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//此处是外部提交的任务，所以q.owner为空</span>
                q<span class="token punctuation">.</span>hint <span class="token operator">=</span> r<span class="token punctuation">;</span>
                <span class="token comment">//记录q在workQueues的槽位索引和q的mode模式SHARED_QUEUE</span>
                q<span class="token punctuation">.</span>config <span class="token operator">=</span> k <span class="token operator">|</span> SHARED_QUEUE<span class="token punctuation">;</span>
                q<span class="token punctuation">.</span>scanState <span class="token operator">=</span> INACTIVE<span class="token punctuation">;</span><span class="token comment">//queue刚初始化，工作者未激活，处于空闲状态</span>
                rs <span class="token operator">=</span> <span class="token function">lockRunState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// publish index</span>
                <span class="token comment">//再次检查workQueues中对应的槽位为空，将新创建的queue放入workQueues数组中</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>  <span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                        k <span class="token operator">&lt;</span> ws<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> ws<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    ws<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">;</span>                 <span class="token comment">// else terminated</span>
                <span class="token function">unlockRunState</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> rs <span class="token operator">&amp;</span> <span class="token operator">~</span>RSLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
                move <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                   <span class="token comment">// move if busy</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>move<span class="token punctuation">)</span>
                <span class="token comment">//重设线程探针</span>
                r <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">advanceProbe</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="externalInterruptibleAwaitDone_871"></a>externalInterruptibleAwaitDone</h4> 
<pre><code class="prism language-java"><span class="token comment">//origin</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">externalInterruptibleAwaitDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">CountedCompleter</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">externalHelpComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CountedCompleter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                    <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">tryExternalUnpush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> STATUS<span class="token punctuation">,</span> s<span class="token punctuation">,</span> s <span class="token operator">|</span> SIGNAL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span>
                        <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//翻译后的方法</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">externalInterruptibleAwaitDone1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">CountedCompleter</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            s<span class="token operator">=</span>  <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">externalHelpComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CountedCompleter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            s<span class="token operator">=</span><span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">tryExternalUnpush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">?</span>  <span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>s<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> STATUS<span class="token punctuation">,</span> s<span class="token punctuation">,</span> s <span class="token operator">|</span> SIGNAL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span>
                        <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2><a id="WorkerQueue_930"></a>WorkerQueue</h2> 
<p>工作人员队列处在奇数索引处。共享（提交）队列的索引为偶数，最多64个插槽，以限制增长</p> 
<p>“ ctl”字段原子地维护活动和总工作人员计数，以及用于放置等待线程的队列，以便可以定位它们以发出信号。主动计数也起着静态指标的作用，因此当工作人员认为没有更多要执行的任务时，主动计数就会减少。 “队列”实际上是Treiber堆栈的一种形式。堆栈是按最近使用的顺序激活线程的理想选择。这改善了性能和局部性，克服了易于争用和无法释放工作程序（除非其位于堆栈的最顶部）的缺点。当工人找不到工作时，他们推入闲置的工人堆栈（由ctl的较低的32bit子字段表示）后，我们将工人停放。最高堆栈状态保存工作程序的“ scanState”字段的值：其索引和状态，以及一个版本计数器，该计数器添加</p> 
<p>WorkQueue也以类似的方式用于提交给池的任务。我们不能将这些任务混合在工人使用的相同队列中。相反，我们使用哈希形式将提交队列与提交线程随机关联。 ThreadLocalRandom探针值用作选择现有队列的哈希码，并且在与其他提交者竞争时可以随机重新放置。从本质上讲，提交者的行为类似于工作人员，只是他们只能执行提交的本地任务（或者在CountedCompleters的情况下，其他任务具有相同的根任务）。在共享模式下插入任务需要一个锁（主要是在调整大小的情况下进行保护），但是我们仅使用简单的自旋锁（使用字段qlock），因为遇到繁忙队列的提交者会继续尝试或创建其他队列-它们阻止了仅在创建和注册新队列时。此外，“ qlock”在关闭时会饱和到可解锁的值（-1）。在成功的情况下，仍可以通过更便宜的有序写入“ qlock”来执行解锁，但是在不成功的情况下使用CAS。</p> 
<p>工作者和池都使用字段scanState来管理和跟踪工作者是不活动的（可能是阻塞的，等待信号），还是对任务进行扫描（当两个都不持有它正在忙于运行任务时）。禁用工作程序后，将设置其scanState字段，并阻止其执行任务，即使它必须对其进行扫描一次也可以避免排队。请注意，scanState更新延迟队列CAS释放，因此使用时需要注意。排队时，scanState的低16位必须保留其池索引。因此，我们在初始化时将索引放置在此处（请参见registerWorker），否则将其保留在该索引中或在必要时将其还原</p> 
<p>Worker queues are at odd indices. Shared (submission) queues</p> 
<pre><code class="prism language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> INITIAL_QUEUE_CAPACITY <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">;</span><span class="token comment">//队列的初始容量</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAXIMUM_QUEUE_CAPACITY <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">;</span> <span class="token comment">// 64M 队列的最大容量</span>

<span class="token comment">// Instance fields</span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> scanState<span class="token punctuation">;</span>    <span class="token comment">// versioned, &lt;0: inactive; odd:scanning</span>
<span class="token keyword">int</span> stackPred<span class="token punctuation">;</span>             <span class="token comment">// pool stack (ctl) predecessor</span>
<span class="token keyword">int</span> nsteals<span class="token punctuation">;</span>               <span class="token comment">// number of steals</span>
<span class="token keyword">int</span> hint<span class="token punctuation">;</span>                  <span class="token comment">// randomization and stealer index hint</span>
<span class="token keyword">int</span> config<span class="token punctuation">;</span>                <span class="token comment">// pool index and mode  低位2-16位是pool index ,奇数是共享队列(Shared queues)、偶数是工作者队列(Worker queues)</span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> qlock<span class="token punctuation">;</span>        <span class="token comment">// 1: locked, &lt; 0: terminate; else 0   </span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> base<span class="token punctuation">;</span>         <span class="token comment">// index of next slot for poll</span>
<span class="token keyword">int</span> top<span class="token punctuation">;</span>                   <span class="token comment">// index of next slot for push</span>
<span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">;</span>   <span class="token comment">// the elements (initially unallocated)</span>
<span class="token keyword">final</span> <span class="token class-name">ForkJoinPool</span> pool<span class="token punctuation">;</span>   <span class="token comment">// the containing pool (may be null)</span>
<span class="token keyword">final</span> <span class="token class-name">ForkJoinWorkerThread</span> owner<span class="token punctuation">;</span> <span class="token comment">// owning thread or null if shared</span>
<span class="token keyword">volatile</span> <span class="token class-name">Thread</span> parker<span class="token punctuation">;</span>    <span class="token comment">// == owner during call to park; else null</span>
<span class="token keyword">volatile</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> currentJoin<span class="token punctuation">;</span>  <span class="token comment">// task being joined in awaitJoin</span>
<span class="token keyword">volatile</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> currentSteal<span class="token punctuation">;</span> <span class="token comment">// mainly used by helpStealer</span>
</code></pre> 
<p>scanState: 这是一个乐观锁的版本号，另外它还有此其他功能，它为负数时，表示工作者线程非活动，它为奇数是表示，正在扫描任务，它为偶数是表示正在执行任务</p> 
<p>stackPred: 表示在线程池栈当前工作线程的前驱线程的索引</p> 
<p>nsteals: 表示当前队列窃取的任务数</p> 
<p>hint：</p> 
<p>config:线程池的索引 ， 第16位是1,表示为先进先出的队列，第16位为1，表示后进先出的栈。</p> 
<p>获取线程池索引，实际上是取config的二进制的2-16位。</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getPoolIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//先取低16位，但最低位是表示mode,将奇偶标志去掉。</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>config <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// ignore odd/even tag bit</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>获取队列中的任务数。</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">queueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//栈底-栈顶，正常情况下为负。</span>
    <span class="token keyword">int</span> n <span class="token operator">=</span> base <span class="token operator">-</span> top<span class="token punctuation">;</span>       <span class="token comment">// non-owner callers must read base first</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token operator">-</span>n<span class="token punctuation">;</span> <span class="token comment">// ignore transient negative</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>runTask(ForkJoinTask) 先执行指定的从外部窃取的任务，然后执行当前队列中的所有本地任务。</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">runTask</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token comment">//scanState&amp;=0b11111111_11111111_11111111_11111110</span>
        scanState <span class="token operator">&amp;=</span> <span class="token operator">~</span>SCANNING<span class="token punctuation">;</span> <span class="token comment">// mark as busy 将scanState的二进制最低位强制置为0，位运算后scanState为偶数,表示工作者线程正执行任务</span>
        <span class="token punctuation">(</span>currentSteal <span class="token operator">=</span> task<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//更新‘窃取任务’属性currentSteal</span>
        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> QCURRENTSTEAL<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// release for GC  ‘窃取任务’完成后，将currentSteal清空</span>
        <span class="token function">execLocalTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ForkJoinWorkerThread</span> thread <span class="token operator">=</span> owner<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>nsteals <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>      <span class="token comment">// collect on overflow  正数在超出最大可表示范围后，将变成负数，</span>
            <span class="token comment">//将nsteals同步到外部类ForkJoinPool的stealCounter属性上，并将nsteals重置为0.</span>
            <span class="token function">transferStealCount</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将scanState的二进制最低位强制置为，位运算后scanState为奇数,表示工作者线程处于空闲状态</span>
        scanState <span class="token operator">|=</span> SCANNING<span class="token punctuation">;</span> <span class="token comment">//scanState|=0b00000000_00000000_00000000_00000001 ,</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">//thread若是InnocuousForkJoinWorkerThread类型，就清空父类Thread的threadLocals 、inheritableThreadLocals这两个属性。</span>
            <span class="token comment">//thread若是ForkJoinWorkerThread，则啥也不做</span>
            thread<span class="token punctuation">.</span><span class="token function">afterTopLevelExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>tryRemoveAndExec移除并执行指定的任务。只有当队列为空或给定任务完成状态未知时返回true，在队列中没有此任务和此任务已经完成返回false.</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryRemoveAndExec</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">;</span> <span class="token keyword">int</span> m<span class="token punctuation">,</span> s<span class="token punctuation">,</span> b<span class="token punctuation">,</span> n<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">=</span> array<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//任务队列已经初始化 且 给定的任务也非空</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> top<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> base<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//  任务队列非空</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> t<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>      <span class="token comment">// traverse from s to b</span>
                <span class="token keyword">long</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">--</span>s <span class="token operator">&amp;</span> m<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> ASHIFT<span class="token punctuation">)</span> <span class="token operator">+</span> ABASE<span class="token punctuation">;</span>  
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token comment">//当前遍历到的任务为null</span>
                   <span class="token comment">//若栈顶为null，返回true </span>
                    <span class="token keyword">return</span> s <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> top<span class="token punctuation">;</span>     <span class="token comment">// shorter than expected</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> task<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//在栈(队列)中找到了这个任务</span>
                    <span class="token keyword">boolean</span> removed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> top<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// pop //若待移除任务在栈顶,将队列中的对应任务引用清空，并更新栈顶</span>
                        
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> j<span class="token punctuation">,</span> task<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> QTOP<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            removed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// //若待移除任务在栈底,则用EmptyTask代替原任务</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">==</span> b<span class="token punctuation">)</span>      <span class="token comment">// replace with proxy</span>
                        removed <span class="token operator">=</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>
                            a<span class="token punctuation">,</span> j<span class="token punctuation">,</span> task<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EmptyTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>removed<span class="token punctuation">)</span><span class="token comment">//移除后，执行此任务</span>
                        task<span class="token punctuation">.</span><span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//当前遍历到的任务不是给定的任务</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> s <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> top<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//当前遍历到的任务已完成且处于栈顶，将此任务从队列中移除，并更新栈顶</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> j<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> QTOP<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>                  <span class="token comment">// was cancelled</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//遍历过程中队列变为空，返回false</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//指定任务已经完成返回false</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5855d0e98505f06a6ffadc31b076f54d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C&#43;&#43;学习总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f591698f8e0d86c78bb58313aa6d6272/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ELK（入门篇）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>