<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Flink】DataStream API使用之输出算子（Sink） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Flink】DataStream API使用之输出算子（Sink）" />
<meta property="og:description" content="输出算子（Sink） Flink作为数据处理框架，最终还是需要把计算处理的结果写入到外部存储，为外部应用提供支持。Flink提供了很多方式输出到外部系统。
1. 连接外部系统 在Flink中我们可以在各种Fuction中处理输出到外部系统，但是Flink作为一个快速的分布式实时流处理系统，对稳定性和容错性要求极高。一旦出现故障，我们应该有能力恢复之前的状态，保障处理结果的正确性。这种性质一般被称为&#34;状态一致性&#34;。Flink内部提供了一致性检查点checkpoint来保障我们可以回滚到正确的状态，但是我们在处理过程中任意读写外部系统，发生故障后就很难回退到从前了。
所以Flink的DataStream API提供了专门向外部写入数据的方法，通过addSink实现，与addSource类似，addSink方法对应着一个Sink算子，主要就是来实现与外部系统连接，并将数据提交写入；Flink程序中所有对外的输出操作一般都是利用Sink算子完成的。比如我们经常使用的print 方法返回的就是一个 DataStreamSink。
Sink算子的创建主要是通过DataSream的.addSink()实现的,并且需要重写default void invoke(IN value, Context context) throws Exception 方法
Flink提供的连接器，这个是1.17版本的，比1.13版本的多很多
除了官方的，Flink也可以使用Apache Bahir的扩展连接器
2. 输出到文件 输出文件Flink有writeAsText()、writeAsCsv()可以直接输出到文件，但是这种不支持同时写一份文件，必须设定为并行度为1，所以Flink又提供了一个专门的流式文件系统的连接器StreamingFileSink。
SreamingFileSink继承自抽象类RichSinkFunction，而且集成Flink的检查点机制(checkpoint)用来保证精确一次的一致性语义。 StreamingFileSInk主要操作是将数据写入桶，每个桶中的数据都可以分割成一个个大小有限的分区文件，并且也可以通过各种配置来控制分桶的操作；默认的分桶方式是基于时间的。
StreamingFileSink（Row-encoded）支持行编码和批量编码（Bulk-encoded，比如 Parquet）格式，这两种不同的方式都有各自的构建器：
行编码：StreamingFileSink.forRowFormat（basePath，rowEncoder）批量编码：StreamingFileSink.forBulkFormat（basePath，bulkWriterFactory） 代码实例:
public static void main(String[] args) throws Exception { // 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境 StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); env.setParallelism(2); // 2. 从集合中读取数据 ArrayList&lt;Event&gt; list = new ArrayList&lt;&gt;(); list.add(new Event(&#34;ming&#34;,&#34;www.baidu1.com&#34;,1200L)); list.add(new Event(&#34;xiaohu&#34;,&#34;www.baidu2.com&#34;,1200L)); list.add(new Event(&#34;xiaohu&#34;,&#34;www.baidu5.com&#34;,1267L)); list.add(new Event(&#34;gala&#34;,&#34;www.baidu6.com&#34;,1200L)); list.add(new Event(&#34;ming&#34;,&#34;www.baidu7.com&#34;,4200L)); list.add(new Event(&#34;xiaohu&#34;,&#34;www.baidu8.com&#34;,5500L)); // 3. 读取数据 DataStreamSource&lt;Event&gt; eventDataStreamSource = env." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e587212ea996c21715852263bd9acd7f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-06T22:11:07+08:00" />
<meta property="article:modified_time" content="2023-06-06T22:11:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Flink】DataStream API使用之输出算子（Sink）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Sink_0"></a>输出算子（Sink）</h2> 
<p><img src="https://images2.imgbox.com/55/9d/cMuG8Ff3_o.png" alt="在这里插入图片描述"><br> Flink作为数据处理框架，最终还是需要把计算处理的结果写入到外部存储，为外部应用提供支持。Flink提供了很多方式输出到外部系统。</p> 
<h3><a id="1__4"></a>1. 连接外部系统</h3> 
<p>在<code>Flink</code>中我们可以在各种<code>Fuction</code>中处理输出到外部系统，但是<code>Flink</code>作为一个快速的分布式实时流处理系统，对稳定性和容错性要求极高。一旦出现故障，我们应该有能力恢复之前的状态，保障处理结果的正确性。这种性质一般被称为"<code>状态一致性</code>"。<code>Flink</code>内部提供了一致性检查点<code>checkpoint</code>来保障我们可以回滚到正确的状态，但是我们在处理过程中任意读写外部系统，发生故障后就很难回退到从前了。</p> 
<p>所以<code>Flink</code>的<code>DataStream API</code>提供了专门向外部写入数据的方法，通过<code>addSink</code>实现，与<code>addSource</code>类似，<code>addSink</code>方法对应着一个<code>Sink</code>算子，主要就是来实现与外部系统连接，并将数据提交写入；<code>Flink</code>程序中所有对外的输出操作一般都是利用<code>Sink算子</code>完成的。比如我们经常使用的<code>print </code>方法返回的就是一个<code> DataStreamSink</code>。</p> 
<p>Sink算子的创建主要是通过DataSream的<code>.addSink()</code>实现的,并且需要重写<code>default void invoke(IN value, Context context) throws Exception</code> 方法</p> 
<p>Flink提供的连接器，这个是1.17版本的，比1.13版本的多很多<br> <img src="https://images2.imgbox.com/90/7d/dAgVIESj_o.png" alt="在这里插入图片描述"><br> 除了官方的，Flink也可以使用Apache Bahir的扩展连接器</p> 
<p><img src="https://images2.imgbox.com/45/87/lv70WuWJ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2__16"></a>2. 输出到文件</h3> 
<p>输出文件Flink有<code>writeAsText()</code>、<code>writeAsCsv()</code>可以直接输出到文件，但是这种不支持同时写一份文件，必须设定为<code>并行度</code>为<code>1</code>，所以<code>Flink</code>又提供了一个专门的流式文件系统的连接器<code>StreamingFileSink</code>。</p> 
<p><code>SreamingFileSink</code>继承自抽象类<code>RichSinkFunction</code>，而且集成<code>Flink</code>的<code>检查点机制(checkpoint)</code>用来保证<code>精确一次的一致性语义</code>。 <code>StreamingFileSInk</code>主要操作是将数据写入桶，每个桶中的数据都可以分割成一个个大小有限的分区文件，并且也可以通过各种配置来控制分桶的操作；默认的分桶方式是<code>基于时间</code>的。</p> 
<p><code>StreamingFileSink（Row-encoded）</code>支持<code>行编码</code>和<code>批量编码（Bulk-encoded，比如 Parquet）</code>格式，这两种不同的方式都有各自的构建器：</p> 
<ul><li>行编码：<code>StreamingFileSink.forRowFormat（basePath，rowEncoder）</code></li><li>批量编码：<code>StreamingFileSink.forBulkFormat（basePath，bulkWriterFactory）</code></li></ul> 
<p><code>代码实例</code>:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 从集合中读取数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu1.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu2.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu5.com"</span><span class="token punctuation">,</span><span class="token number">1267L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"gala"</span><span class="token punctuation">,</span><span class="token string">"www.baidu6.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu7.com"</span><span class="token punctuation">,</span><span class="token number">4200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">5500L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> eventDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">BasicTypeInfo</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 构建File Sink</span>
        <span class="token class-name">StreamingFileSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> streamingFileSink <span class="token operator">=</span> <span class="token class-name">StreamingFileSink</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">forRowFormat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">"./out"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringEncoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withRollingPolicy</span><span class="token punctuation">(</span>
                        <span class="token class-name">DefaultRollingPolicy</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">withInactivityInterval</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">withRolloverInterval</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">withMaxPartSize</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        eventDataStreamSource<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token operator">::</span><span class="token function">toString</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>streamingFileSink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里设置了并行度是2，所以是两个桶文件。通过<code>.withRollingPolicy()</code>方法指定滚动策略，策略配置说明：</p> 
<ul><li><code>withInactivityInterval </code>: 最近 5 分钟没有收到新的数据</li><li><code>withRolloverInterval</code> : 至少包含 15 分钟的数据</li><li><code>withMaxPartSize</code> : 文件大小已达到 1 GB<br> <img src="https://images2.imgbox.com/ea/31/vLaTajeo_o.png" alt="在这里插入图片描述"></li></ul> 
<h3><a id="3_Kafka_62"></a>3. 输出到Kafka</h3> 
<p>Flink 与 Kafka 的连接器提供了端到端的精确一次（exactly once）语义保证，这在实际项目中是最高级别的一致性保证。<br> 代码实例：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 设置属性</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span><span class="token string">"hadoop102:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"input/clicks.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 构建File Sink</span>
        <span class="token class-name">FlinkKafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlinkKafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"clicks"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. addSink</span>
        stringDataStreamSource<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>kafkaProducer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><code>addSink </code>传入的参数是一个<code> FlinkKafkaProducer</code>。<code>FlinkKafkaProducer</code>继承了抽象类<code>TwoPhaseCommitSinkFunction</code>，这是一个实现了两阶段提交的<code>RichSinkFuction</code>，两阶段提交提供了<code>Flink</code>向<code>Kafka</code>写入数据的事务性保证，能够真正做到精确一次的<code>状态一致性</code>。</p> 
<h3><a id="4_Sink_85"></a>4. 自定义Sink输出</h3> 
<p>如果<code>Flink</code>提供的<code>Sink</code>不满足自己的要求，也可以通过<code>自定义Sink</code>来满足自己的要求，通过<code>Flink</code>提供的<code>SinkFuction</code>接口和对应的<code>RichSinkFuction</code>抽象类重写<code>invoke()</code>就可以<code>自定义Sink</code>。</p> 
<p>这里以<code>Hbase</code>为例，使用<code>RichSinkFuction</code>，创建<code>Hbase</code>的连接以及关闭<code>Hbase</code>的连接分别放到<code>open</code>和<code>close</code>方法中。</p> 
<p>代码实例：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 设置属性</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span><span class="token string">"hadoop102:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"input/clicks.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 构建File Sink</span>
        stringDataStreamSource<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RichSinkFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token keyword">public</span> <span class="token class-name">Configuration</span> configuration<span class="token punctuation">;</span> <span class="token comment">// 管理 Hbase 的配置信息,这里因为 Configuration 的重名问题，将类以完整路径</span>
            <span class="token keyword">public</span> <span class="token class-name">Connection</span> connection<span class="token punctuation">;</span> <span class="token comment">// 管理 Hbase 连接</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
                configuration <span class="token operator">=</span> <span class="token class-name">HBaseConfiguration</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                configuration<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"hbase.zookeeper.quorum"</span><span class="token punctuation">,</span> <span class="token string">"hadoop102:2181"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                connection <span class="token operator">=</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭连接</span>

            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Table</span> table <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getTable</span><span class="token punctuation">(</span><span class="token class-name">TableName</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 表名为 test</span>
                <span class="token class-name">Put</span> put <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Put</span><span class="token punctuation">(</span><span class="token string">"rowkey"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定 rowkey</span>
                put<span class="token punctuation">.</span><span class="token function">addColumn</span><span class="token punctuation">(</span><span class="token string">"info"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span> <span class="token comment">// 指定列名</span>
                        <span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span> <span class="token comment">// 写入的数据</span>
                        <span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入的数据</span>
                table<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>put<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行 put 操作</span>
                table<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将表关闭</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c9c741af3eba85e50d63b4e5e0ca0751/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">轻松搞懂Java类加载与SPI机制</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/396aefd4af98a54ecb5c1ef5fee6a321/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">华为OD机试真题 Java 实现【跳房子II】【2023 B卷 100分】，附详细解题思路</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>