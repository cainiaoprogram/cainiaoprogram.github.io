<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>深入理解vue3 响应式数据 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="深入理解vue3 响应式数据" />
<meta property="og:description" content="之前研究了vue的reactive方法，简写了vue3的响应式的核心原理，然后萌生了编写简易版vue3实现的想法。查阅相关资料后，来使用原生js环境模vue3的响应式数据的核心api实现。
// 响应式代码 const reative = (target) =&gt; { return new Proxy(target, { get: function (obj, key, ctx) { console.log(&#39;我被获取了&#39;) // 收集依赖 return obj[key]; }, set: function (obj, key, value) { console.log(&#39;我被设置了&#39;, key) // 执行回调 obj[key] = value; return true; } }) } const obj = reative({ name: &#39;张三&#39; }) console.log(obj.name, &#39;----&#39;) obj.name = &#39;张三子&#39; console.log(obj.name, &#39;------&#39;) // 我被获取了 // 张三 ---- // 我被设置了 name // 我被获取了 // 张三子 ------ 这个例子很好理解，reative 这个方法创建对象后，能去监听数据的get/set。 不管是vue2还是vue3, 最核心的还是 依赖收集 &#43; 执行回调 ，而effect函数可以说是它的核心实现了。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/df99e7b6e523dc75946254c4c327eb53/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-17T08:49:26+08:00" />
<meta property="article:modified_time" content="2023-11-17T08:49:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">深入理解vue3 响应式数据</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>之前研究了vue的reactive方法，简写了vue3的响应式的核心原理，然后萌生了编写简易版vue3实现的想法。查阅相关资料后，来使用原生js环境模vue3的响应式数据的核心api实现。</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 响应式代码</span>
<span class="token keyword">const</span> <span class="token function-variable function">reative</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我被获取了'</span><span class="token punctuation">)</span>
            <span class="token comment">// 收集依赖</span>
            <span class="token keyword">return</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我被设置了'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            <span class="token comment">// 执行回调</span>
            obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reative</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'张三'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">'----'</span><span class="token punctuation">)</span>
obj<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'张三子'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">'------'</span><span class="token punctuation">)</span>

<span class="token comment">// 我被获取了</span>
<span class="token comment">// 张三 ----</span>
<span class="token comment">// 我被设置了 name</span>
<span class="token comment">// 我被获取了</span>
<span class="token comment">// 张三子 ------</span>

</code></pre> 
<p>这个例子很好理解，reative 这个方法创建对象后，能去监听数据的get/set。 不管是vue2还是vue3, 最核心的还是 <mark><strong>依赖收集 + 执行回调</strong></mark> ，而effect函数可以说是它的核心实现了。</p> 
<h5><a id="reactiveeffect__40"></a>一、简易版的reactive、effect 实现</h5> 
<p>我们先看一段代码：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>effect<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
a<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">10</span>

<span class="token comment">// 1</span>
<span class="token comment">// 10</span>
</code></pre> 
<p>那么这个effect函数是什么呢？简单来说vue中的响应式数据的回调方法。此方法内所用使用到的响应式数据只要发生变化，effect方法就会重新执行， computed、watch等api 就是基于effect的二次封装。接下来我们分析下effect在这个例子中做了什么事。</p> 
<h6><a id="effect_58"></a>猜测effect做了三件事：</h6> 
<ol><li>执行回调方法</li><li>监测回调中用到了哪些响应式数据，并把回调加入到相对应的响应式数据的副作用队列中；</li><li>触发a的set方法时执行相应的副作用方法；</li></ol> 
<p>动手实践：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">reative</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 收集依赖</span>
            <span class="token function">track</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token comment">// 调用副作用方法</span>
            <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义一个副作用集合 set 数据集不会出现重复</span>
<span class="token keyword">let</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 定义响应式对象</span>
<span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token function">reative</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">5</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 定义获取/设置响应式数据的effect</span>
<span class="token keyword">let</span> <span class="token function-variable function">effect1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span>age<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 收集依赖</span>
<span class="token keyword">const</span> <span class="token function-variable function">track</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect1<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 调用副作用方法</span>
<span class="token keyword">const</span> <span class="token function-variable function">trigger</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    dep<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// effect 方法要先执行一次</span>
<span class="token function">effect1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
p1<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">10</span>

<span class="token comment">// 5</span>
<span class="token comment">// 10</span>

</code></pre> 
<blockquote> 
 <p>effect1 先执行一次，当age属性发生变化后，在次执行effect1方法。</p> 
</blockquote> 
<p>这里我们实现了和vue3 一样的运行逻辑。和vue3区别在于关键的几个步骤我们都是通过<mark>手动</mark>去关联和触发对应的方法，接下来我们梳理下缺少的部分并逐个实现。</p> 
<ol><li>track方法和effect关联，只收集当前数据相关的副作用；</li><li>trigger方法和dep、数据源关联，执行的副作用队列应该都和数据源相关。</li></ol> 
<h5><a id="trackeffect_123"></a><mark>关联track方法和effect(重点)</mark></h5> 
<p>关联他俩之前我们再梳理下整个流程的执行循序：</p> 
<p><strong>执行effect1、effect2、… =&gt; 收集依赖</strong></p> 
<p>我们再更细致的拆解下执行顺序</p> 
<p>==<strong>执行effect1 &amp;&amp; 收集effect1的依赖 =&gt; 执行effect2 &amp;&amp; 收集effect2的依赖</strong>==</p> 
<p>思路好像清晰了，effect执行的时候进行的依赖收集。那增加一个currentEffectfun（<strong><mark>重点</mark></strong>）数据，当响应式数据触发get方法，说明currentEffectfun 的effect 内使用了触发的这个响应式数据，那么直接就给当前响应式数据添加一个dep方法，然后就完成关联了。</p> 
<h6><a id="1get_135"></a>1、改造响应式数据的get方法，</h6> 
<p>增加key参数，从而能在副作用池找到相对应的方法</p> 
<pre><code class="prism language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">reative</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">track</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token keyword">return</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2effect_155"></a>2、记录当前执行的effect方法</h6> 
<p>使用一个currentEffect 字段来记录当前正在实行的effect 方法，他是一个时间段。而在这个时间段内执行的proxy set方法都需要添加到当前数据的dep 池中， 当当前数据改变，再去执行dep池内的所有方法。</p> 
<pre><code class="prism language-javascript"><span class="token keyword">let</span> currentEffect <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">const</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fun</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    currentEffect <span class="token operator">=</span> fun
    <span class="token function">currentEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    currentEffect <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="3track_169"></a>3、改造track方法</h6> 
<p>改造track 之前我们先改造下dep, 符合以下两点：</p> 
<ol><li>支持多个响应式数据；</li><li>每个响应式数据的副作用方法有多个；</li></ol> 
<p>根据需求设计这样一个数据结构</p> 
<pre><code class="prism language-javascript"><span class="token keyword">const</span> deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        fun1<span class="token punctuation">,</span> fun2<span class="token punctuation">,</span> fun3<span class="token operator">...</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>改造track，用传入的key值去确定需要执行的effect方法的位置</p> 
<pre><code class="prism language-javascript"><span class="token keyword">let</span> deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">track</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        deps<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    deps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>currentEffect<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="4_199"></a>4、改造下执行依赖的方法</h6> 
<pre><code class="prism language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">trigger</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
   deps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> effect <span class="token operator">&amp;&amp;</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>完整实现</p> 
<pre><code class="prism language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">reative</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">track</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token keyword">return</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token function">trigger</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> currentEffect <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">const</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fun</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    currentEffect <span class="token operator">=</span> fun
    <span class="token function">currentEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    currentEffect <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
<span class="token comment">//收集依赖</span>
<span class="token keyword">const</span> <span class="token function-variable function">track</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        deps<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    deps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>currentEffect<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 执行依赖</span>
<span class="token keyword">const</span> <span class="token function-variable function">trigger</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    deps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> effect <span class="token operator">&amp;&amp;</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token function">reative</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">5</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span>age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p1<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">10</span>
</code></pre> 
<p>执行结果</p> 
<img src="https://images2.imgbox.com/27/f6/WlZVuXVn_o.png"> 
<h5><a id="_260"></a>二、小结</h5> 
<p>根据effect 函数的种种表现，成功复刻了effect 方法执行的整个流程。但是vue3远不止如此， 虽然表面上看起来执行结果一致，但是其中很多地方经不起推敲，比如多层嵌套的对象如何监听数据变化，如何储存依赖项，还有著名的‘set陷阱’我们还没有推导到。再比如基础数据类型如何监听数据变化，作者为什么要使用Reflect，等等诸多问题我们先梳理，接下来再去逐个解决。</p> 
<p>梳理的问题点：</p> 
<ol><li>在reactive函数的set方法中，官方使用的是Reflect，而我们使用的obj[key]；</li><li>复杂/深层次的响应式数据如何监听和存储依赖项；</li><li>官方的依赖项是存储在各自的proxy对象的dep 属性上，而我们是全部放在一个单独的deps对象内；</li></ol> 
<blockquote> 
 <p>ps: 一定要学习ts的语法，因为vue源码还有各种相关文章的示例代码全都是ts, 不懂ts语法看起来那是相当的头疼。之前维护过ts的项目，使用了一段时间ts，觉得那个写起来麻烦，想着以后项目断然也不会去使用它，所以就一直拖着没学，但是现在想法转变了： 你可以不用 但是不能不会。（前端码农看不懂ts 说出去也被人笑话！！！）</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4ea4d4b110c216ab4b7399f9aea55700/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">科研学习|科研软件——SPSS统计的单因素方差分析与单变量方差分析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/32d9eb5d33a72f550132ea5cb8cb34c5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">单点登录和Auth2.0</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>