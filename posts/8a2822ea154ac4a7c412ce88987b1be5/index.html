<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>springboot&#43;flowable工作流三三来迟 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="springboot&#43;flowable工作流三三来迟" />
<meta property="og:description" content="springboot集成flowable工作流之梅开三度，常言道温故而知新，咱也回故一下。
1、使用flowable-ui制作流程图
运行flowable-6.6.0官方demo，打开网址：http://localhost:8080/flowable-ui，输入账号admin/test登录即可，如下
进入APP.MODELER.TITLE创建流程，之后可以导出流程到项目中直接使用。
流程图如下
导出的工作流文件如下
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt; &lt;definitions xmlns=&#34;http://www.omg.org/spec/BPMN/20100524/MODEL&#34; xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34; xmlns:xsd=&#34;http://www.w3.org/2001/XMLSchema&#34; xmlns:flowable=&#34;http://flowable.org/bpmn&#34; xmlns:bpmndi=&#34;http://www.omg.org/spec/BPMN/20100524/DI&#34; xmlns:omgdc=&#34;http://www.omg.org/spec/DD/20100524/DC&#34; xmlns:omgdi=&#34;http://www.omg.org/spec/DD/20100524/DI&#34; typeLanguage=&#34;http://www.w3.org/2001/XMLSchema&#34; expressionLanguage=&#34;http://www.w3.org/1999/XPath&#34; targetNamespace=&#34;http://www.flowable.org/processdef&#34;&gt; &lt;process id=&#34;leave4&#34; name=&#34;请假审批&#34; isExecutable=&#34;true&#34;&gt; &lt;startEvent id=&#34;start&#34; name=&#34;开始&#34; flowable:formFieldValidation=&#34;true&#34;&gt;&lt;/startEvent&gt; &lt;userTask id=&#34;student&#34; name=&#34;学生&#34; flowable:assignee=&#34;${studentId}&#34; flowable:formFieldValidation=&#34;true&#34;&gt; &lt;extensionElements&gt; &lt;modeler:initiator-can-complete xmlns:modeler=&#34;http://flowable.org/modeler&#34;&gt;&lt;![CDATA[false]]&gt;&lt;/modeler:initiator-can-complete&gt; &lt;/extensionElements&gt; &lt;/userTask&gt; &lt;userTask id=&#34;teacher&#34; name=&#34;老师&#34; flowable:assignee=&#34;${teacherId}&#34; flowable:formFieldValidation=&#34;true&#34;&gt; &lt;extensionElements&gt; &lt;modeler:initiator-can-complete xmlns:modeler=&#34;http://flowable.org/modeler&#34;&gt;&lt;![CDATA[false]]&gt;&lt;/modeler:initiator-can-complete&gt; &lt;/extensionElements&gt; &lt;/userTask&gt; &lt;exclusiveGateway id=&#34;gate1&#34;&gt;&lt;/exclusiveGateway&gt; &lt;userTask id=&#34;header&#34; name=&#34;校长&#34; flowable:assignee=&#34;${headerId}&#34; flowable:formFieldValidation=&#34;true&#34;&gt; &lt;extensionElements&gt; &lt;modeler:initiator-can-complete xmlns:modeler=&#34;http://flowable.org/modeler&#34;&gt;&lt;![CDATA[false]]&gt;&lt;/modeler:initiator-can-complete&gt; &lt;/extensionElements&gt; &lt;/userTask&gt; &lt;exclusiveGateway id=&#34;gate2&#34;&gt;&lt;/exclusiveGateway&gt; &lt;endEvent id=&#34;end&#34; name=&#34;结束&#34;&gt;&lt;/endEvent&gt; &lt;sequenceFlow id=&#34;flow1&#34; sourceRef=&#34;start&#34; targetRef=&#34;student&#34;&gt;&lt;/sequenceFlow&gt; &lt;sequenceFlow id=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/8a2822ea154ac4a7c412ce88987b1be5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-21T22:30:00+08:00" />
<meta property="article:modified_time" content="2022-06-21T22:30:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">springboot&#43;flowable工作流三三来迟</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>springboot集成flowable工作流之梅开三度，常言道温故而知新，咱也回故一下。<br> 1、使用flowable-ui制作流程图<br> 运行flowable-6.6.0官方demo，打开网址：http://localhost:8080/flowable-ui，输入账号admin/test登录即可，如下<br> <img src="https://images2.imgbox.com/83/02/4u5dL1l8_o.png" alt="在这里插入图片描述"><br> 进入APP.MODELER.TITLE创建流程，之后可以导出流程到项目中直接使用。<br> 流程图如下<br> <img src="https://images2.imgbox.com/4a/a1/rMiq0NHK_o.png" alt="在这里插入图片描述"><br> 导出的工作流文件如下</p> 
<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:flowable="http://flowable.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.flowable.org/processdef"&gt;
  &lt;process id="leave4" name="请假审批" isExecutable="true"&gt;
    &lt;startEvent id="start" name="开始" flowable:formFieldValidation="true"&gt;&lt;/startEvent&gt;
    &lt;userTask id="student" name="学生" flowable:assignee="${studentId}" flowable:formFieldValidation="true"&gt;
      &lt;extensionElements&gt;
        &lt;modeler:initiator-can-complete xmlns:modeler="http://flowable.org/modeler"&gt;&lt;![CDATA[false]]&gt;&lt;/modeler:initiator-can-complete&gt;
      &lt;/extensionElements&gt;
    &lt;/userTask&gt;
    &lt;userTask id="teacher" name="老师" flowable:assignee="${teacherId}" flowable:formFieldValidation="true"&gt;
      &lt;extensionElements&gt;
        &lt;modeler:initiator-can-complete xmlns:modeler="http://flowable.org/modeler"&gt;&lt;![CDATA[false]]&gt;&lt;/modeler:initiator-can-complete&gt;
      &lt;/extensionElements&gt;
    &lt;/userTask&gt;
    &lt;exclusiveGateway id="gate1"&gt;&lt;/exclusiveGateway&gt;
    &lt;userTask id="header" name="校长" flowable:assignee="${headerId}" flowable:formFieldValidation="true"&gt;
      &lt;extensionElements&gt;
        &lt;modeler:initiator-can-complete xmlns:modeler="http://flowable.org/modeler"&gt;&lt;![CDATA[false]]&gt;&lt;/modeler:initiator-can-complete&gt;
      &lt;/extensionElements&gt;
    &lt;/userTask&gt;
    &lt;exclusiveGateway id="gate2"&gt;&lt;/exclusiveGateway&gt;
    &lt;endEvent id="end" name="结束"&gt;&lt;/endEvent&gt;
    &lt;sequenceFlow id="flow1" sourceRef="start" targetRef="student"&gt;&lt;/sequenceFlow&gt;
    &lt;sequenceFlow id="flow2" name="请假" sourceRef="student" targetRef="teacher"&gt;&lt;/sequenceFlow&gt;
    &lt;sequenceFlow id="flow3" name="审批" sourceRef="teacher" targetRef="gate1"&gt;&lt;/sequenceFlow&gt;
    &lt;sequenceFlow id="flow4" name="拒绝" sourceRef="gate1" targetRef="student"&gt;
      &lt;conditionExpression xsi:type="tFormalExpression"&gt;&lt;![CDATA[${command=='refuse'}]]&gt;&lt;/conditionExpression&gt;
    &lt;/sequenceFlow&gt;
    &lt;sequenceFlow id="flow5" name="同意" sourceRef="gate1" targetRef="header"&gt;
      &lt;conditionExpression xsi:type="tFormalExpression"&gt;&lt;![CDATA[${command=='agree'}]]&gt;&lt;/conditionExpression&gt;
    &lt;/sequenceFlow&gt;
    &lt;sequenceFlow id="flow6" name="审批" sourceRef="header" targetRef="gate2"&gt;&lt;/sequenceFlow&gt;
    &lt;sequenceFlow id="flow7" name="同意" sourceRef="gate2" targetRef="end"&gt;
      &lt;conditionExpression xsi:type="tFormalExpression"&gt;&lt;![CDATA[${command=='agree'}]]&gt;&lt;/conditionExpression&gt;
    &lt;/sequenceFlow&gt;
    &lt;sequenceFlow id="flow8" name="拒绝" sourceRef="gate2" targetRef="student"&gt;
      &lt;conditionExpression xsi:type="tFormalExpression"&gt;&lt;![CDATA[${command=='refuse'}]]&gt;&lt;/conditionExpression&gt;
    &lt;/sequenceFlow&gt;
  &lt;/process&gt;
  &lt;bpmndi:BPMNDiagram id="BPMNDiagram_leave4"&gt;
    &lt;bpmndi:BPMNPlane bpmnElement="leave4" id="BPMNPlane_leave4"&gt;
      &lt;bpmndi:BPMNShape bpmnElement="start" id="BPMNShape_start"&gt;
        &lt;omgdc:Bounds height="30.0" width="30.0" x="100.0" y="163.0"&gt;&lt;/omgdc:Bounds&gt;
      &lt;/bpmndi:BPMNShape&gt;
      &lt;bpmndi:BPMNShape bpmnElement="student" id="BPMNShape_student"&gt;
        &lt;omgdc:Bounds height="80.0" width="100.0" x="165.0" y="138.0"&gt;&lt;/omgdc:Bounds&gt;
      &lt;/bpmndi:BPMNShape&gt;
      &lt;bpmndi:BPMNShape bpmnElement="teacher" id="BPMNShape_teacher"&gt;
        &lt;omgdc:Bounds height="80.0" width="100.0" x="320.0" y="138.0"&gt;&lt;/omgdc:Bounds&gt;
      &lt;/bpmndi:BPMNShape&gt;
      &lt;bpmndi:BPMNShape bpmnElement="gate1" id="BPMNShape_gate1"&gt;
        &lt;omgdc:Bounds height="40.0" width="40.0" x="465.0" y="158.0"&gt;&lt;/omgdc:Bounds&gt;
      &lt;/bpmndi:BPMNShape&gt;
      &lt;bpmndi:BPMNShape bpmnElement="header" id="BPMNShape_header"&gt;
        &lt;omgdc:Bounds height="80.0" width="100.0" x="550.0" y="138.0"&gt;&lt;/omgdc:Bounds&gt;
      &lt;/bpmndi:BPMNShape&gt;
      &lt;bpmndi:BPMNShape bpmnElement="gate2" id="BPMNShape_gate2"&gt;
        &lt;omgdc:Bounds height="40.0" width="40.0" x="695.0" y="158.0"&gt;&lt;/omgdc:Bounds&gt;
      &lt;/bpmndi:BPMNShape&gt;
      &lt;bpmndi:BPMNShape bpmnElement="end" id="BPMNShape_end"&gt;
        &lt;omgdc:Bounds height="28.0" width="28.0" x="780.0" y="164.0"&gt;&lt;/omgdc:Bounds&gt;
      &lt;/bpmndi:BPMNShape&gt;
      &lt;bpmndi:BPMNEdge bpmnElement="flow1" id="BPMNEdge_flow1"&gt;
        &lt;omgdi:waypoint x="129.94999817301806" y="178.0"&gt;&lt;/omgdi:waypoint&gt;
        &lt;omgdi:waypoint x="164.999999999925" y="178.0"&gt;&lt;/omgdi:waypoint&gt;
      &lt;/bpmndi:BPMNEdge&gt;
      &lt;bpmndi:BPMNEdge bpmnElement="flow2" id="BPMNEdge_flow2"&gt;
        &lt;omgdi:waypoint x="264.9499999998879" y="178.0"&gt;&lt;/omgdi:waypoint&gt;
        &lt;omgdi:waypoint x="319.9999999999684" y="178.0"&gt;&lt;/omgdi:waypoint&gt;
      &lt;/bpmndi:BPMNEdge&gt;
      &lt;bpmndi:BPMNEdge bpmnElement="flow3" id="BPMNEdge_flow3"&gt;
        &lt;omgdi:waypoint x="419.94999999999806" y="178.21623376623378"&gt;&lt;/omgdi:waypoint&gt;
        &lt;omgdi:waypoint x="465.4130434782609" y="178.4130434782609"&gt;&lt;/omgdi:waypoint&gt;
      &lt;/bpmndi:BPMNEdge&gt;
      &lt;bpmndi:BPMNEdge bpmnElement="flow4" id="BPMNEdge_flow4"&gt;
        &lt;omgdi:waypoint x="485.5" y="197.4379452926209"&gt;&lt;/omgdi:waypoint&gt;
        &lt;omgdi:waypoint x="485.5" y="257.0"&gt;&lt;/omgdi:waypoint&gt;
        &lt;omgdi:waypoint x="215.0" y="257.0"&gt;&lt;/omgdi:waypoint&gt;
        &lt;omgdi:waypoint x="215.0" y="217.95000000000002"&gt;&lt;/omgdi:waypoint&gt;
      &lt;/bpmndi:BPMNEdge&gt;
      &lt;bpmndi:BPMNEdge bpmnElement="flow5" id="BPMNEdge_flow5"&gt;
        &lt;omgdi:waypoint x="504.5247370727428" y="178.41666666666663"&gt;&lt;/omgdi:waypoint&gt;
        &lt;omgdi:waypoint x="549.9999999999953" y="178.21812227074236"&gt;&lt;/omgdi:waypoint&gt;
      &lt;/bpmndi:BPMNEdge&gt;
      &lt;bpmndi:BPMNEdge bpmnElement="flow6" id="BPMNEdge_flow6"&gt;
        &lt;omgdi:waypoint x="649.9499999999977" y="178.21623376623376"&gt;&lt;/omgdi:waypoint&gt;
        &lt;omgdi:waypoint x="695.4130434782554" y="178.41304347826085"&gt;&lt;/omgdi:waypoint&gt;
      &lt;/bpmndi:BPMNEdge&gt;
      &lt;bpmndi:BPMNEdge bpmnElement="flow7" id="BPMNEdge_flow7"&gt;
        &lt;omgdi:waypoint x="734.5591869398207" y="178.3782051282051"&gt;&lt;/omgdi:waypoint&gt;
        &lt;omgdi:waypoint x="780.0002755524838" y="178.08885188426407"&gt;&lt;/omgdi:waypoint&gt;
      &lt;/bpmndi:BPMNEdge&gt;
      &lt;bpmndi:BPMNEdge bpmnElement="flow8" id="BPMNEdge_flow8"&gt;
        &lt;omgdi:waypoint x="715.5" y="158.5"&gt;&lt;/omgdi:waypoint&gt;
        &lt;omgdi:waypoint x="715.5" y="98.0"&gt;&lt;/omgdi:waypoint&gt;
        &lt;omgdi:waypoint x="215.0" y="98.0"&gt;&lt;/omgdi:waypoint&gt;
        &lt;omgdi:waypoint x="215.0" y="138.0"&gt;&lt;/omgdi:waypoint&gt;
      &lt;/bpmndi:BPMNEdge&gt;
    &lt;/bpmndi:BPMNPlane&gt;
  &lt;/bpmndi:BPMNDiagram&gt;
&lt;/definitions&gt;
</code></pre> 
<p>其中学生、教师、校长节点需指定固定值，如${studentId}，后面在流程操作中输入指定的id即可。<br> 2、创建springboot工程<br> pom依赖</p> 
<pre><code>	&lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.6.2&lt;/version&gt;
        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
    &lt;/parent&gt;
    ...
		&lt;dependency&gt;
            &lt;groupId&gt;org.flowable&lt;/groupId&gt;
            &lt;artifactId&gt;flowable-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;6.6.0&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre> 
<p>application.yml文件</p> 
<pre><code>spring:
  datasource:
    url: jdbc:mysql://localhost:3306/flowable?useSSL=false&amp;characterEncoding=UTF-8
    driver-class-name: com.mysql.jdbc.Driver
    username: 
    password: 
</code></pre> 
<p>接口</p> 
<pre><code>	@Autowired
    private RuntimeService runtimeService;

    @Autowired
    private HistoryService historyService;

    @Autowired
    private TaskService taskService;

    @Autowired
    private RepositoryService repositoryService;

    @Resource
    private ProcessEngine processEngine;

    /**
     * @description: 发起请假流程(请假)
     * @author: ldc
     * @date: 2022/1/24 15:13
     */
    @RequestMapping(value = "startLeave4")
    public String startLeave4(String userId) {
        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
        map.put("studentId", userId);
        map.put("leaveDays",2);
        map.put("leaveReason","生病");
        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey("leave4", map);
        return "请假流程processInstanceId：" + processInstance.getId();
    }

    /**
     * @description: 获取用户的任务（可以是学生、教师、校长）
     * @author: ldc
     * @date: 2022/1/24 15:27
     */
    @RequestMapping(value = "getTasks4")
    public String getTasks4(String userId) {
        StringBuilder sb = new StringBuilder();
        List&lt;Task&gt; tasks = taskService.createTaskQuery().taskAssignee(userId).orderByTaskCreateTime().desc().list();
        for (Task task : tasks) {
            sb.append("任务taskId: " + task.getId() + ";");
        }
        return sb.toString();
    }

    /**
     * @description: 审批(同意)
     * @author: ldc
     * @date: 2022/1/24 15:52
     */
    @RequestMapping(value = "agree4")
    public String agree4(String user,String userId,String taskId) {
        Task task = taskService.createTaskQuery().taskId(taskId).singleResult();
        if (task == null) {
            System.out.println("该任务对应的流程不存在");
            return "该任务对应的流程不存在";
        }
        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
        map.put(user, userId);
        map.put("command", "agree");
        taskService.complete(taskId, map);
        return "审核通过";
    }

    /**
     * @description: 审批(拒绝)
     * @author: ldc
     * @date: 2022/1/24 15:53
     */
    @RequestMapping(value = "refuse4")
    public String refuse4(String user,String userId,String taskId) {
        Task task = taskService.createTaskQuery().taskId(taskId).singleResult();
        if (task == null) {
            System.out.println("该任务对应的流程不存在");
            return "该任务对应的流程不存在";
        }
        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
        map.put(user, userId);
        map.put("command", "refuse");
        taskService.complete(taskId, map);
        return "审核驳回";
    }

    /**
     * @description: 查看流程图，待执行的标红
     * @author: ldc
     * @date: 2022/1/24 17:11
     */ 
    @RequestMapping(value = "processDiagram4")
    public void genProcessDiagram4(HttpServletResponse httpServletResponse, String processInstanceId) throws Exception {
        // 根据流程实例Id查询该流程实例的具体信息
        ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstanceId).singleResult();
        // 获得流程定义Id
        String processDefinitionId;
        // 流程走完的从历史中获取
        if (processInstance == null) {
            //return;
            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery().processInstanceId(processInstanceId).singleResult();
            processDefinitionId = historicProcessInstance.getProcessDefinitionId();
        } else {
            processDefinitionId = processInstance.getProcessDefinitionId();
        }
        Task task = taskService.createTaskQuery().processInstanceId(processInstanceId).singleResult();
        if (task == null) {
            //return;
        }
        // 根据流程实例Id查询该流程实例正在执行的活动
        List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().processInstanceId(processInstanceId).list();
        // 得到正在执行的活动Id
        List&lt;String&gt; activityIds = new ArrayList&lt;&gt;();
        List&lt;String&gt; flows = new ArrayList&lt;&gt;();
        for (Execution execution : executions) {
            List&lt;String&gt; ids = runtimeService.getActiveActivityIds(execution.getId());
            activityIds.addAll(ids);
        }
        // 获取流程图
        BpmnModel bpmnModel = repositoryService.getBpmnModel(processDefinitionId);
        ProcessEngineConfiguration engineConfiguration = processEngine.getProcessEngineConfiguration();
        ProcessDiagramGenerator diagramGenerator = engineConfiguration.getProcessDiagramGenerator();
        InputStream in = diagramGenerator.generateDiagram(bpmnModel,
                "png",
                activityIds,
                flows,
                engineConfiguration.getActivityFontName(),
                engineConfiguration.getLabelFontName(),
                engineConfiguration.getAnnotationFontName(),
                engineConfiguration.getClassLoader(),
                1.0,
                true);
        OutputStream out = null;
        byte[] buf = new byte[1024];
        int length = 0;
        try {
            out = httpServletResponse.getOutputStream();
            while ((length = in.read(buf)) != -1) {
                out.write(buf, 0, length);
            }
        } finally {
            if (in != null) {
                in.close();
            }
            if (out != null) {
                out.close();
            }
        }
    }

    /**
     * @description: 查看流程图，完成的标红
     * @author: ldc
     * @date: 2022/1/26 11:07
     */
    @RequestMapping(value = "processDiagram44")
    public void genProcessDiagram44(HttpServletResponse httpServletResponse, String processInstanceId) {
        // 获得流程定义Id
        String processDefinitionId;
        if (this.isFinished(processInstanceId)) {
            // 如果流程已经结束
            // 根据流程实例Id查询该流程实例的具体信息
            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery().processInstanceId(processInstanceId).singleResult();
            String id = historicProcessInstance.getId();
            processDefinitionId = historicProcessInstance.getProcessDefinitionId();
            String startActivityId = historicProcessInstance.getStartActivityId();
            String endActivityId = historicProcessInstance.getEndActivityId();
            System.out.println("id:" + id + ",processDefinitionId:" + processDefinitionId + ",startActivityId:" + startActivityId + ",endActivityId:" + endActivityId);
        } else {
            // 如果流程没有结束
            // 根据流程实例Id查询该流程实例的具体信息
            ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstanceId).singleResult();
            processDefinitionId = processInstance.getProcessDefinitionId();
            String id = processInstance.getId();
            String activityId = processInstance.getActivityId();
            System.out.println("id:" + id + ",processDefinitionId:" + processDefinitionId + ",activityId:" + activityId);
        }

        List&lt;String&gt; highLightedActivityIds = new ArrayList&lt;&gt;();
        List&lt;String&gt; highLightedFlows = new ArrayList&lt;&gt;();
        // 根据流程实例Id查询该流程实例下所有历史活动实例或查询正在执行的活动实例
        List&lt;HistoricActivityInstance&gt; historicActivityInstanceList =  historyService.createHistoricActivityInstanceQuery().processInstanceId(processInstanceId).orderByHistoricActivityInstanceStartTime().asc().list();
        for(HistoricActivityInstance historicActivityInstance : historicActivityInstanceList){
            String activityId = historicActivityInstance.getActivityId();
            highLightedActivityIds.add(activityId);
            if ("startEvent".equals(historicActivityInstance.getActivityType())) {
                System.out.println("startEvent" + historicActivityInstance.getActivityName());
                //highLightedActivityIds.add(activityId);
            }
            if ("userTask".equals(historicActivityInstance.getActivityType())) {
                System.out.println("userTask" + historicActivityInstance.getActivityName());
                //highLightedActivityIds.add(activityId);
            }
            if ("sequenceFlow".equals(historicActivityInstance.getActivityType())) {
                System.out.println("sequenceFlow" + historicActivityInstance.getActivityName());
                highLightedFlows.add(historicActivityInstance.getActivityId());
            }
            if ("endEvent".equals(historicActivityInstance.getActivityType())) {
                System.out.println("endEvent" + historicActivityInstance.getActivityName());
                //highLightedActivityIds.add(activityId);
            }
        }

        // 根据流程定义Id获取bpmn模型
        // 获取流程图
        BpmnModel bpmnModel = repositoryService.getBpmnModel(processDefinitionId);
        ProcessEngineConfiguration engineConfiguration = processEngine.getProcessEngineConfiguration();
        ProcessDiagramGenerator diagramGenerator = engineConfiguration.getProcessDiagramGenerator();
        InputStream in = diagramGenerator.generateDiagram(bpmnModel,
                "png",
                highLightedActivityIds,
                highLightedFlows,
                engineConfiguration.getActivityFontName(),
                engineConfiguration.getLabelFontName(),
                engineConfiguration.getAnnotationFontName(),
                engineConfiguration.getClassLoader(),
                1.0,
                true);
        OutputStream out = null;
        byte[] buf = new byte[1024];
        int legth = 0;
        try {
            out = httpServletResponse.getOutputStream();
            while ((legth = in.read(buf)) != -1) {
                out.write(buf, 0, legth);
            }
        } catch (IOException e) {
        } finally {
            IOUtils.closeQuietly(out);
            IOUtils.closeQuietly(in);
        }
    }
</code></pre> 
<p>测试<br> 学生发起请假<br> <img src="https://images2.imgbox.com/03/ee/yjvU3uT9_o.png" alt="在这里插入图片描述"><br> 查看用户的任务<br> <img src="https://images2.imgbox.com/e8/c5/PabzGOu5_o.png" alt="在这里插入图片描述"><br> 查看当前状态的流程图<br> <img src="https://images2.imgbox.com/f5/5b/2wbuZ8ht_o.png" alt="在这里插入图片描述"><br> 其中红框表示最新的已经执行完成的节点。<br> 或<br> <img src="https://images2.imgbox.com/8f/cc/2L6Xy6Qg_o.png" alt="在这里插入图片描述"><br> 其中红框表示所有的已经执行完成的节点。<br> 教师审批同意<br> <img src="https://images2.imgbox.com/9b/4b/7EneoCrN_o.png" alt="在这里插入图片描述"><br> 查看流程图<br> <img src="https://images2.imgbox.com/e3/0e/7rf0dF6Q_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2c/bb/iA59CTOl_o.png" alt="在这里插入图片描述"><br> 校长审批同意<br> <img src="https://images2.imgbox.com/26/f9/hlgzmT8v_o.png" alt="在这里插入图片描述"><br> 查看流程图<br> <img src="https://images2.imgbox.com/85/4c/9IoudntF_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/68/ff/hujuezVe_o.png" alt="在这里插入图片描述"><br> 结束审批同意<br> <img src="https://images2.imgbox.com/da/85/w4qxN91Z_o.png" alt="在这里插入图片描述"><br> 查看流程图<br> <img src="https://images2.imgbox.com/a5/61/kJQo9mn3_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/54/39/w3ZehbBw_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f601bf1fc7739dc927f7f98de953d89e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">dim层-商品表设计</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a0f7243ae90751b8fc4f5dabe6e4ae33/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Excel-VBA 快速上手（一、宏、VBA、过程、类型与变量、函数）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>