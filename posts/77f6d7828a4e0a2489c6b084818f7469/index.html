<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>快速解决Android中的selinux权限问题 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="快速解决Android中的selinux权限问题" />
<meta property="og:description" content="关于selinux的详细资料，请查阅http://blog.csdn.net/innost/article/details/19299937
在Android开发的过程中,遇到关于selinux相关的东西，当时还一下子看不懂，现在好像有点眉目了。
比如，内核打印这个提示
type=1400 audit(32.939:25): avc: denied { open } for pid=2592 comm=&#34;chmod&#34; path=&#34;/dev/block/mmcblk0p25&#34; dev=&#34;tmpfs&#34; ino=6494 scontext=u:r:init_shell:s0 tcontext=u:object_r:block_device:s0 tclass=blk_file permissive=1
我们可以遵循这个方法，从头开始寻找关键对象，然后调整一下顺序，生成一条语句,最后将该语句填写到.te文件中即可。
denied { open } u:r:init_shell:s0 u:object_r:block_device:s0 tclass=blk_file A B C D
B C D A
allow init_shell block_device:blk_file open;
这条语句表示允许init_shell域中的block_device进程打开block_device类型的块设备文件。
或者直接使用工具生成external/selinux/prebuilts/bin/audit2allow
有时候会遇到编译该规则失败,这也许就是neverallow语句做怪了。
neverallow用来检查安全策略文件中是否有违反该项规则的allow语句(不可修改newerallow的定义)
如external/sepolicy/netd.te文件中，语句
neverallow netd dev_type:blk_file { read write };
表示永远不允许netd域中的进程读写dev_type类型的块设备文件，这时只需屏蔽该语句即可。
当然,在调试阶段，可在终端上运行如下命令获取SELinux的状态和临时关闭SELinux
setenforce 0 ##设置SELinux 成为permissive模式（SELinux开启，但对违反selinux规则的行为只记录，不会阻止）
setenforce 1 ##设置SELinux 成为enforcing模式 (SELinux开启)
getenforce ##获取SELinux状态(permissive,enforcing,disabled)
当然，如果要验证某些selinux问题，可以在cmdline中加入androidboot.selinux=0来关闭selinux
或者到Android源码的根目录下，直接修改system/core/init/init.c文件。
static void selinux_initialize(void) { if (selinux_is_disabled()) { return; } INFO(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/77f6d7828a4e0a2489c6b084818f7469/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-04-01T13:53:25+08:00" />
<meta property="article:modified_time" content="2017-04-01T13:53:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">快速解决Android中的selinux权限问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>关于selinux的详细资料，请查阅<a href="http://blog.csdn.net/innost/article/details/19299937">http://blog.csdn.net/innost/article/details/19299937</a></p> 
<p>在Android开发的过程中,遇到关于selinux相关的东西，当时还一下子看不懂，现在好像有点眉目了。</p> 
<p> </p> 
<p>比如，内核打印这个提示</p> 
<p>type=1400 audit(32.939:25): avc: denied { <u>open</u> } for pid=2592 comm="chmod" path="/dev/block/mmcblk0p25" dev="tmpfs" ino=6494 scontext=u:r:<u>init_shell</u>:s0 tcontext=u:object_r:<u>block_device</u>:s0 tclass=<u>blk_file</u> permissive=1</p> 
<p> </p> 
<p>我们可以遵循这个方法，从头开始寻找关键对象，然后调整一下顺序，生成一条语句,最后将该语句填写到.te文件中即可。</p> 
<p><span style="color:#3333ff;">denied { open }             u:r:init_shell:s0            u:object_r:block_device:s0       tclass=blk_file                  </span></p> 
<p><span style="color:#3333ff;">             A                               B                                              C                                       D<br>  <br>              B                               C                                              D                                       A</span></p> 
<p> </p> 
<p><strong>allow init_shell  block_device<strong>:</strong>blk_file open;</strong></p> 
<p> </p> 
<p>这条语句表示允许init_shell域中的block_device进程打开block_device类型的块设备文件。</p> 
<p>或者直接使用工具生成external/selinux/prebuilts/bin/audit2allow</p> 
<p>有时候会遇到编译该规则失败,这也许就是neverallow语句做怪了。</p> 
<p>neverallow用来检查安全策略文件中是否有违反该项规则的allow语句(不可修改newerallow的定义)</p> 
<p> </p> 
<p><span style="color:#333333;">如external/sepolicy/netd.te文件中，<span style="color:#333333;">语句</span></span></p> 
<p><span style="color:#333333;"><span style="color:#333333;"><span style="color:#000000;"><strong>neverallow netd dev_type:blk_file { read write };</strong></span></span></span></p> 
<p><span style="color:#333333;">表示永远不允许netd域中的进程读写dev_type类型的块设备文件，这时只需屏蔽该语句即可。</span></p> 
<p> </p> 
<p>当然,在调试阶段，可在终端上运行如下命令获取SELinux的状态和临时关闭SELinux</p> 
<p>setenforce 0                  ##设置SELinux 成为permissive模式（SELinux开启，但对违反selinux规则的行为只记录，不会阻止）</p> 
<p>setenforce 1                  ##设置SELinux 成为enforcing模式 (SELinux开启)</p> 
<p>getenforce                     ##获取SELinux状态(permissive,enforcing,disabled)</p> 
<p> </p> 
<p>当然，如果要验证某些selinux问题，可以在cmdline中加入androidboot.selinux=0来关闭selinux</p> 
<p>或者到Android源码的根目录下，直接修改system/core/init/init.c文件。</p> 
<pre class="has"><code class="language-cpp">static void selinux_initialize(void)
{
    if (selinux_is_disabled()) {
        return;
    }

    INFO("loading selinux policy\n");
    if (selinux_android_load_policy() &lt; 0) {
        ERROR("SELinux: Failed to load policy; rebooting into recovery mode\n");
        android_reboot(ANDROID_RB_RESTART2, 0, "recovery");
        while (1) { pause(); }  // never reached
    }

    selinux_init_all_handles();
    bool is_enforcing = selinux_is_enforcing();
    INFO("SELinux: security_setenforce(%d)\n", is_enforcing);
    security_setenforce(is_enforcing);
}</code></pre> 
<p>修改is_enforcing的值为0。</p> 
<p>当然，最好的修改方法可参考<a href="http://blog.csdn.net/u013983194/article/details/50462694">http://blog.csdn.net/u013983194/article/details/50462694</a></p> 
<p>基本思路就是:默认A不许对B和C干什么，但没定义A对D的行为，那可以建一个D的对象，让A对D为所欲为。</p> 
<p>修改后，然后编译ｍｍｍ system/sepolicy -j30，会将devices下的selinux文件包含进去，生成的文件在system/etc/selinux/或vendor/etc/selinux/下，然后用grep进行字符串进行检索，确保修改成功，最后把相应的文件push到机器上验证(高版本的Android手机需要解锁后，push后才能生效)。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0ffb093612f34b81da7aa5fe8b28ea8e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ios 强制横屏大总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cc409e6c25be1e085624d1ade15f76e6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">jquery后台日期价格输入</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>