<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PLG | Prometheus &#43; Loki &#43; Grafana 是时候把你的ELK扔掉了 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="PLG | Prometheus &#43; Loki &#43; Grafana 是时候把你的ELK扔掉了" />
<meta property="og:description" content="目录
零、瞎BB
一、Pomtail
二、Loki
三、对接Grafana
Prometheus和Grafana默认你懂，本篇直接上 promtail 组件和 loki 。本文采用二进制安装部署 零、瞎BB PLG 通常指的是 Prometheus ， Loki ， Grafana 的日志和监控栈，这是一个常见的开源解决方案组合，用于收集、存储和可视化日志和度量数据。
Prometheus 主要用于收集和存储指标数据。 Loki 专注于日志聚合和管理。 Grafana 是用于数据的可视化和监控的工具。 在这个组合中， Promtail 是 Loki 的一个代理，负责收集日志并发送给 Loki 。 Loki 则负责存储和查询这些日志数据。日志文件本身通常存储在你的系统中的某个地方， Promtail 会监视这些日志文件，并将新的日志条目推送到 Loki 。
例如，如果你有一个应用程序，它的日志被写入到 /var/log/myapp 目录中，你会在 Promtail 的配置文件中指定这个目录。 Promtail 会监视目录中的变化，并将日志数据发送到Loki 。 Loki 则接收这些数据并将其存储在其数据库中，通常是结合使用本地存储和/或对象存储（如Amazon S3、Google Cloud Storage等）。这意味着，日志数据的生命周期如下：
1.应用程序生成日志，写入到它的日志文件中 2.Promtail 被配置为监视这些日志文件，捕获其内容 3.Promtail 将日志数据发送到 Loki 4.Loki 接收日志数据并将其存储在后端存储中 在 Grafana 中，你可以配置 Loki 数据源，然后创建仪表板来查询和可视化 Loki 中的日志数据。总的来说，PLG 栈的组件都有各自的职责，Promtail 不存储日志文件，它仅仅是作为一个中介，将日志数据从你的系统发送到 Loki 服务。Loki 是负责存储和查询日志数据的组件。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/56e7f3dddc7a97e4dc6ae4e0b9a2fe08/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-12T10:12:22+08:00" />
<meta property="article:modified_time" content="2023-12-12T10:12:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PLG | Prometheus &#43; Loki &#43; Grafana 是时候把你的ELK扔掉了</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E9%9B%B6%E3%80%81%E7%9E%8EBB-toc" style="margin-left:0px;"><a href="#%E9%9B%B6%E3%80%81%E7%9E%8EBB" rel="nofollow">零、瞎BB</a></p> 
<p id="%E4%B8%80%E3%80%81Pomtail-toc" style="margin-left:0px;"><a href="#%E4%B8%80%E3%80%81Pomtail" rel="nofollow">一、Pomtail</a></p> 
<p id="%E4%BA%8C%E3%80%81Loki-toc" style="margin-left:0px;"><a href="#%E4%BA%8C%E3%80%81Loki" rel="nofollow">二、Loki</a></p> 
<p id="%E4%B8%89%E3%80%81%E5%AF%B9%E6%8E%A5Grafana-toc" style="margin-left:0px;"><a href="#%E4%B8%89%E3%80%81%E5%AF%B9%E6%8E%A5Grafana" rel="nofollow">三、对接Grafana</a></p> 
<hr id="hr-toc"> 
<p></p> 
<p><span style="color:#f3f3f4;"><span style="background-color:#0d0016;"> Prometheus和Grafana默认你懂，本篇直接上 promtail 组件和 loki 。本文采用二进制安装部署 </span></span></p> 
<h2 id="%E9%9B%B6%E3%80%81%E7%9E%8EBB"><span style="color:#333333;">零、瞎BB</span></h2> 
<p><span style="color:#1a439c;"><span style="background-color:#e7fafa;"> PLG </span></span>通常指的是<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> Prometheus ， Loki ， Grafana </span></span>的日志和监控栈，这是一个常见的开源解决方案组合，用于收集、存储和可视化日志和度量数据。</p> 
<blockquote> 
 <ul><li><span style="color:#1a439c;"><strong><span style="background-color:#e7fafa;"> Prometheus</span></strong><span style="background-color:#e7fafa;"> </span></span>主要用于收集和存储指标数据。</li><li><span style="color:#1a439c;"><strong><span style="background-color:#e7fafa;"> Loki</span></strong><span style="background-color:#e7fafa;"> </span></span>专注于日志聚合和管理。</li><li><span style="color:#1a439c;"><strong><span style="background-color:#e7fafa;"> Grafana</span></strong><span style="background-color:#e7fafa;"> </span></span>是用于数据的可视化和监控的工具。</li></ul> 
</blockquote> 
<p>在这个组合中，<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> Promtail </span></span>是<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> Loki </span></span>的一个代理，负责收集日志并发送给<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> Loki </span></span><span style="color:#0d0016;">。</span><span style="color:#1a439c;"><span style="background-color:#e7fafa;"> Loki </span></span>则负责存储和查询这些日志数据。日志文件本身通常存储在你的系统中的某个地方，<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> Promtail </span></span>会监视这些日志文件，并将新的日志条目推送到<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> Loki </span></span>。</p> 
<p>例如，如果你有一个应用程序，它的日志被写入到<strong><span style="color:#1a439c;"><span style="background-color:#e7fafa;"> </span><code><span style="background-color:#e7fafa;">/var/log/myapp</span></code><span style="background-color:#e7fafa;"> </span></span></strong>目录中，你会在<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> Promtail </span></span>的配置文件中指定这个目录。<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> Promtail </span></span>会监视目录中的变化，并将日志数据发送到<span style="color:#1a439c;"><span style="background-color:#e7fafa;">Loki </span></span><span style="color:#0d0016;">。</span><span style="color:#1a439c;"><span style="background-color:#e7fafa;"> Loki </span></span>则接收这些数据并将其存储在其数据库中，通常是结合使用本地存储和/或对象存储（如Amazon S3、Google Cloud Storage等）。这意味着，日志数据的生命周期如下：</p> 
<pre><code>1.应用程序生成日志，写入到它的日志文件中</code></pre> 
<pre><code>2.Promtail 被配置为监视这些日志文件，捕获其内容</code></pre> 
<pre><code>3.Promtail 将日志数据发送到 Loki</code></pre> 
<pre><code>4.Loki 接收日志数据并将其存储在后端存储中</code></pre> 
<p>在 Grafana 中，你可以配置 Loki 数据源，然后创建仪表板来查询和可视化 Loki 中的日志数据。总的来说，PLG 栈的组件都有各自的职责，Promtail 不存储日志文件，它仅仅是作为一个中介，将日志数据从你的系统发送到 Loki 服务。Loki 是负责存储和查询日志数据的组件。</p> 
<hr> 
<p></p> 
<h2 id="%E4%B8%80%E3%80%81Pomtail">一、Pomtail</h2> 
<p>下载promtail：</p> 
<pre><code class="language-bash">curl -O -L "https://github.com/grafana/loki/releases/download/v2.9.3/promtail-linux-amd64.zip"</code></pre> 
<p>解压：</p> 
<pre><code class="language-bash">unzip promtail-linux-amd64.zip
</code></pre> 
<p>移下位置，方便后面加入systemd：</p> 
<pre><code class="language-bash">sudo mv promtail-linux-amd64 /usr/local/bin/</code></pre> 
<p>下载配置文件，或者直接复制下文：</p> 
<pre><code class="language-bash">#下载
wget  --no-check-certificate https://raw.githubusercontent.com/grafana/loki/master/clients/cmd/promtail/promtail-local-config.yaml</code></pre> 
<pre><code class="language-bash">#配置文件原文
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://localhost:3100/loki/api/v1/push

scrape_configs:
- job_name: system
  static_configs:
  - targets:
      - localhost
    labels:
      job: varlogs
      __path__: /var/log/*log</code></pre> 
<p>根据需求将<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> clients </span></span>下的地址修改为<span style="color:#1a439c;"><span style="background-color:#e7fafa;">Loki </span></span>所在地址。以及<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> labels </span></span>下日志文件的存放路径。若需要同时监听多个目录下的日志文件，写法如下：</p> 
<pre><code class="language-bash">#按需修改
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://localhost:3100/loki/api/v1/push

scrape_configs:
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: varlogs
          __path__: /var/log/*.log

  - job_name: application
    static_configs:
      - targets:
          - localhost
        labels:
          job: applogs
          __path__: /path/to/your/application/logs/*.log

  - job_name: another_application
    static_configs:
      - targets:
          - localhost
        labels:
          job: anotherapplogs
          __path__: /another/path/to/logs/**/*.log  # 支持glob模式</code></pre> 
<p>这个配置定义了三个<strong><span style="color:#1a439c;"><span style="background-color:#e7fafa;"> </span><code><span style="background-color:#e7fafa;">scrape_configs </span></code></span></strong>，分别用于从不同的目录收集日志： </p> 
<blockquote> 
 <ol><li><span style="color:#1a439c;"><span style="background-color:#e7fafa;"> system </span></span>作业从 /var/log 目录下收集所有 .log 文件。</li><li><span style="color:#1a439c;"><span style="background-color:#e7fafa;"> application </span></span>作业从特定应用程序的日志目录收集日志。</li><li><span style="color:#1a439c;"><span style="background-color:#e7fafa;"> another_application </span></span>作业从另一个应用程序的日志目录收集日志，并且使用了 glob 模式来匹配更深层次的目录结构中的日志文件。</li></ol> 
</blockquote> 
<p>在<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> __path__ </span></span>标签中指定的路径支持使用通配符<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> * </span></span>来匹配文件名或目录名的一部分。<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> ** </span></span>模式可以匹配任意中间目录，这在指定具有多级子目录的日志路径时非常有用。</p> 
<p>确保配置文件中的<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> positions </span></span>文件的路径对你的系统来说是可写的，因为<span style="color:#1a439c;"><span style="background-color:#e7fafa;"> Promtail </span></span>会使用这个文件来记录哪些日志内容已被读取和发送。</p> 
<p>移动一下：</p> 
<pre><code class="language-bash">sudo mkdir /etc/promtail &amp;&amp; sudo mv promtail-local-config.yaml /etc/promtail/</code></pre> 
<p>加入系统服务：</p> 
<pre><code class="language-bash">sudo vim /etc/systemd/system/promtail.service</code></pre> 
<p>确认下地址是否一致：</p> 
<pre><code class="language-bash">[Unit]
Description=Promtail service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/promtail-linux-amd64 -config.file=/etc/promtail/promtail-local-config.yaml
Restart=on-failure

[Install]
WantedBy=multi-user.target
</code></pre> 
<pre><code class="language-bash">sudo systemctl daemon-reload</code></pre> 
<pre><code class="language-bash">sudo systemctl enable promtail.service --now</code></pre> 
<hr> 
<p></p> 
<p></p> 
<h2 id="%E4%BA%8C%E3%80%81Loki">二、Loki</h2> 
<p>下载Loki：</p> 
<pre><code class="language-bash">curl -O -L "https://github.com/grafana/loki/releases/download/v2.9.3/loki-linux-amd64.zip"</code></pre> 
<p>解压：</p> 
<pre><code class="language-bash">unzip loki-linux-amd64.zip</code></pre> 
<pre><code class="language-bash">sudo mv loki-linux-amd64 /usr/local/bin/</code></pre> 
<p>下载配置文件：</p> 
<pre><code class="language-bash">wget  --no-check-certificate https://raw.githubusercontent.com/grafana/loki/master/cmd/loki/loki-local-config.yaml</code></pre> 
<p><span style="color:#1a439c;"><span style="background-color:#e7fafa;">注意一下文件内容，如果不对就复制以下内容（按需修改）</span></span>：</p> 
<pre><code class="language-bash">sudo mkdir /etc/loki &amp;&amp; sudo vim /etc/loki/loki-local-config.yaml</code></pre> 
<pre><code class="language-bash">auth_enabled: false

server:
  http_listen_port: 3100
  grpc_listen_port: 9096

common:
  instance_addr: 127.0.0.1
  path_prefix: /tmp/loki
  storage:
    filesystem:
      chunks_directory: /tmp/loki/chunks
      rules_directory: /tmp/loki/rules
  replication_factor: 1
  ring:
    kvstore:
      store: inmemory

query_range:
  results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 100

schema_config:
  configs:
    - from: 2020-10-24
      store: tsdb
      object_store: filesystem
      schema: v12
      index:
        prefix: index_
        period: 24h

ruler:
  alertmanager_url: http://localhost:9093

# By default, Loki will send anonymous, but uniquely-identifiable usage and configuration
# analytics to Grafana Labs. These statistics are sent to https://stats.grafana.org/
#
# Statistics help us better understand how Loki is used, and they show us performance
# levels for most users. This helps us prioritize features and documentation.
# For more information on what's sent, look at
# https://github.com/grafana/loki/blob/main/pkg/analytics/stats.go
# Refer to the buildReport method to see what goes into a report.
#
# If you would like to disable reporting, uncomment the following lines:
#analytics:
#  reporting_enabled: false</code></pre> 
<p>加入系统服务：</p> 
<pre><code class="language-bash">sudo vim /etc/systemd/system/loki.service</code></pre> 
<pre><code class="language-bash">[Unit]
Description=Loki log aggregation system
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/loki-linux-amd64 -config.file /etc/loki/loki-local-config.yaml

[Install]
WantedBy=multi-user.target</code></pre> 
<pre><code class="language-bash">sudo systemctl daemon-reload</code></pre> 
<pre><code class="language-bash">sudo systemctl enable loki.service --now</code></pre> 
<hr> 
<p></p> 
<p></p> 
<h2 id="%E4%B8%89%E3%80%81%E5%AF%B9%E6%8E%A5Grafana">三、对接Grafana</h2> 
<p>点击添加数据源：</p> 
<p class="img-center"><img alt="" height="299" src="https://images2.imgbox.com/90/ca/H1vjMDUH_o.png" width="1000"></p> 
<p>选择Loki：</p> 
<p class="img-center"><img alt="" height="214" src="https://images2.imgbox.com/f0/5a/dd1Fcjst_o.png" width="1000"></p> 
<p>输入IP端口并保存：</p> 
<p class="img-center"><img alt="" height="225" src="https://images2.imgbox.com/76/6e/9El3FQit_o.png" width="1000"></p> 
<p>左侧点击Explore，上方选择Loki： </p> 
<p class="img-center"><img alt="" height="194" src="https://images2.imgbox.com/40/91/16imtTTk_o.png" width="1000"></p> 
<p>选择好后点击Show Logs：</p> 
<p class="img-center"><img alt="" height="431" src="https://images2.imgbox.com/76/3d/aEW8OkGU_o.png" width="1000"></p> 
<p>效果（码一下）（有点恶心：</p> 
<p class="img-center"><img alt="" height="482" src="https://images2.imgbox.com/35/48/RIDHBk8p_o.png" width="1000"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/da7643a7f795034fd40d38ed5a7d6717/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux和Mac中不能使用ll命令查看文件解决方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/27a879d690c8adf1c0806d986f8dbe31/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">2023年度盘点：智能汽车、自动驾驶、车联网必读清单</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>