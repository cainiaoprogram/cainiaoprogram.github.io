<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>zookeeperã€å°ç¥å½•ã€‘ä¸‹ç¯‡ - èœé¸Ÿç¨‹åºå‘˜åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="zookeeperã€å°ç¥å½•ã€‘ä¸‹ç¯‡" />
<meta property="og:description" content="ç›®å½•
ğŸ¥1.å®¢æˆ·ç«¯APIÂ ğŸŒ­2.æœåŠ¡å™¨åŠ¨æ€ä¸Šä¸‹çº¿Â ğŸ§‚3.åˆ†å¸ƒå¼é”Â 1.å®¢æˆ·ç«¯APIÂ 1.1å¯¼å…¥ä¾èµ– &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.13.2&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt; &lt;artifactId&gt;log4j-api&lt;/artifactId&gt; &lt;version&gt;2.14.1&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt; &lt;artifactId&gt;zookeeper&lt;/artifactId&gt; &lt;version&gt;3.5.7&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; 1.2ä»£ç å®ç° public class zkClient { //ä¸€å®šä¸è¦æœ‰ç©ºæ ¼ private String connectString = &#34;192.168.20.129:2181,192.168.20.130:2181,192.168.20.131:2181&#34;; private int sessionTimeOut = 2000; private ZooKeeper zkClient; /** * åˆå§‹è¯zookeeper * å‚æ•°1ï¼šè¿æ¥åœ°å€ * å‚æ•°2ï¼šè¶…æ—¶æ—¶é—´ * å‚æ•°3ï¼šç›‘å¬å™¨ */ @Before public void init() throws IOException { zkClient = new ZooKeeper(connectString, sessionTimeOut, new Watcher() { @Override public void process(WatchedEvent watchedEvent) { List&lt;String&gt; children = null; try { children = zkClient." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/fef89e2527b6699e103c1e409d7d31be/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-04T19:30:16+08:00" />
<meta property="article:modified_time" content="2024-01-04T19:30:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="èœé¸Ÿç¨‹åºå‘˜åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">èœé¸Ÿç¨‹åºå‘˜åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">zookeeperã€å°ç¥å½•ã€‘ä¸‹ç¯‡</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><img alt="" class="left" height="626" src="https://images2.imgbox.com/8b/4f/TpVJFFit_o.png" width="1121"></p> 
<p id="main-toc"><strong>ç›®å½•</strong></p> 
<p id="1.%E5%AE%A2%E6%88%B7%E7%AB%AFAPI%C2%A0-toc" style="margin-left:0px;">ğŸ¥<a href="#1.%E5%AE%A2%E6%88%B7%E7%AB%AFAPI%C2%A0" rel="nofollow">1.å®¢æˆ·ç«¯APIÂ </a></p> 
<p id="2.%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8A%A8%E6%80%81%E4%B8%8A%E4%B8%8B%E7%BA%BF%C2%A0-toc" style="margin-left:0px;">ğŸŒ­<a href="#2.%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8A%A8%E6%80%81%E4%B8%8A%E4%B8%8B%E7%BA%BF%C2%A0" rel="nofollow">2.æœåŠ¡å™¨åŠ¨æ€ä¸Šä¸‹çº¿Â </a><a href="#2.2%E6%9C%8D%E5%8A%A1%E7%AB%AF%C2%A0" rel="nofollow">Â </a></p> 
<p id="3.%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%C2%A0-toc" style="margin-left:0px;">ğŸ§‚<a href="#3.%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%C2%A0" rel="nofollow">3.åˆ†å¸ƒå¼é”Â </a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="1.%E5%AE%A2%E6%88%B7%E7%AB%AFAPI%C2%A0" style="background-color:transparent;">1.å®¢æˆ·ç«¯APIÂ </h2> 
<h3 id="1.1%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96">1.1å¯¼å…¥ä¾èµ–</h3> 
<pre><code class="language-java">    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;junit&lt;/groupId&gt;
            &lt;artifactId&gt;junit&lt;/artifactId&gt;
            &lt;version&gt;4.13.2&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
            &lt;artifactId&gt;log4j-api&lt;/artifactId&gt;
            &lt;version&gt;2.14.1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt;
            &lt;artifactId&gt;zookeeper&lt;/artifactId&gt;
            &lt;version&gt;3.5.7&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;</code></pre> 
<h3 id="1.2%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">1.2ä»£ç å®ç°</h3> 
<pre><code class="language-java">public class zkClient {
    //ä¸€å®šä¸è¦æœ‰ç©ºæ ¼
    private String connectString = "192.168.20.129:2181,192.168.20.130:2181,192.168.20.131:2181";
    private int sessionTimeOut = 2000;
    private ZooKeeper zkClient;

    /**
     * åˆå§‹è¯zookeeper
     * å‚æ•°1ï¼šè¿æ¥åœ°å€
     * å‚æ•°2ï¼šè¶…æ—¶æ—¶é—´
     * å‚æ•°3ï¼šç›‘å¬å™¨
     */
    @Before
    public void init() throws IOException {
        zkClient = new ZooKeeper(connectString, sessionTimeOut, new Watcher() {
            @Override
            public void process(WatchedEvent watchedEvent) {
                List&lt;String&gt; children = null;
                try {
                    children = zkClient.getChildren("/", true);
                } catch (Exception e) {
                    e.printStackTrace();
                }
                System.out.println("========================");
                for (String child : children) {
                    System.out.println(child);
                }
                System.out.println("========================");
            }
        });
    }

    /**
     * åˆ›å»ºå­èŠ‚ç‚¹
     * å‚æ•°1ï¼šåˆ›å»ºèŠ‚ç‚¹çš„è·¯å¾„
     * å‚æ•°2ï¼šèŠ‚ç‚¹çš„æ•°æ®ï¼ˆè½¬åŒ–ä¸ºå­—èŠ‚ï¼‰
     * å‚æ•°3ï¼šèŠ‚ç‚¹çš„æƒé™
     * å‚æ•°4ï¼šèŠ‚ç‚¹çš„ç±»å‹ï¼ˆä¸´æ—¶/æ°¸ä¹…ï¼‰
     **/
    @Test
    public void create() throws InterruptedException, KeeperException {
        String nodeCreate = zkClient.create("/class", "s1".getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
    }

    /**
     * ç›‘æ§å­èŠ‚ç‚¹å˜åŒ–
     * å‚æ•°1ï¼šè¦ç›‘æ§çš„èŠ‚ç‚¹ç›®å½•
     * å‚æ•°2ï¼šç›‘å¬å™¨ï¼ˆtrue:ä½¿ç”¨åˆå§‹åŒ–æ˜¯çš„ç›‘å¬å™¨ï¼‰
     */
    @Test
    public void getChildren() throws InterruptedException, KeeperException {
        List&lt;String&gt; children = zkClient.getChildren("/", true);
        for (String child : children) {
            System.out.println(child);
        }
        //å»¶æ—¶
        Thread.sleep(Long.MAX_VALUE);
    }

    /**
     * åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨
     * å‚æ•°1ï¼šåˆ¤æ–­çš„èŠ‚ç‚¹è·¯å¾„
     * å‚æ•°ï¼šæ˜¯å¦ä½¿ç”¨ç›‘å¬å™¨
     */
    @Test
    public void isExist() throws InterruptedException, KeeperException {
        Stat stat = zkClient.exists("/class", false);
        System.out.println(stat == null ? "ä¸å­˜åœ¨" : "å­˜åœ¨");
    }
}</code></pre> 
<h3 id="%C2%A01.3%E5%86%99%E6%95%B0%E6%8D%AE%E5%8E%9F%E7%90%86">Â 1.3å†™æ•°æ®åŸç†</h3> 
<h4 id="1.%E5%86%99%E5%85%A5%E8%AF%B7%E6%B1%82%E7%9B%B4%E6%8E%A5%E5%8F%91%E9%80%81%E7%BB%99Leader">1.å†™å…¥è¯·æ±‚ç›´æ¥å‘é€ç»™Leader</h4> 
<blockquote> 
 <ul><li><strong>1.å®¢æˆ·ç«¯å‘è¯·æ±‚ç»™Leader</strong></li><li><strong>2.leaderæ‰§è¡Œè¯·æ±‚å¹¶åº”ç­”ï¼Œç„¶åæŠŠè¯·æ±‚åˆ†å‘ç»™ä¸‹ä¸€ä¸ªfollower</strong></li><li><strong>3.followerä¼šæ‰§è¡Œè¯·æ±‚å¹¶åº”ç­”ã€‚</strong></li><li><strong>4.å½“åº”ç­”æ•°è¶…è¿‡åŠæ•°ï¼ŒLeaderå°±ä¼šå›å¤å®¢æˆ·ç«¯ï¼Œå®Œæˆäº†å†™è¯·æ±‚</strong></li><li><strong>5.leaderä¼šç»§ç»­å‘é€å†™è¯·æ±‚ç»™å‰©ä¸‹çš„follower</strong></li></ul> 
</blockquote> 
<p><img alt="" class="left" height="557" src="https://images2.imgbox.com/0b/ae/XGApwTlO_o.png" width="1052"></p> 
<h4 id="2.%E5%86%99%E5%85%A5%E8%AF%B7%E6%B1%82%E5%8F%91%E9%80%81%E7%BB%99Follower">2.å†™å…¥è¯·æ±‚å‘é€ç»™Follower</h4> 
<blockquote> 
 <ul><li><strong>1.å®¢æˆ·ç«¯å‘è¯·æ±‚ç»™followerï¼Œfolloweræ²¡æœ‰å†™æƒé™ï¼Œç«‹å³æŠŠå†™è¯·æ±‚å‘ç»™leader</strong></li><li><strong>2.leaderæ‰§è¡Œå†™è¯·æ±‚å¹¶åº”ç­”ï¼Œç„¶åæŠŠå†™è¯·æ±‚åˆ†å‘ç»™follower</strong></li><li><strong>3.followerä¼šæ‰§è¡Œè¯·æ±‚å¹¶åº”ç­”ã€‚</strong></li><li><strong>4.å½“åº”ç­”æ•°è¶…è¿‡åŠæ•°ï¼ŒLeaderå›å¤followerï¼Œç”±followerå›å¤å®¢æˆ·ç«¯ï¼Œå®Œæˆäº†å†™è¯·æ±‚</strong></li><li><strong>5.leaderä¼šç»§ç»­å‘é€å†™è¯·æ±‚ç»™å‰©ä¸‹çš„follower</strong></li></ul> 
</blockquote> 
<h2 id="2.%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8A%A8%E6%80%81%E4%B8%8A%E4%B8%8B%E7%BA%BF%C2%A0">2.æœåŠ¡å™¨åŠ¨æ€ä¸Šä¸‹çº¿Â </h2> 
<h3 id="2.1%E5%AE%A2%E6%88%B7%E7%AB%AF">2.1å®¢æˆ·ç«¯</h3> 
<blockquote> 
 <ul><li><strong>1.è·å–zookeeperè¿æ¥</strong></li><li><strong>2.ç›‘å¬èŠ‚ç‚¹çš„å˜åŒ–</strong></li><li><strong>3.ä¸šåŠ¡é€»è¾‘ï¼ˆç¡çœ ï¼‰</strong></li></ul> 
</blockquote> 
<pre><code class="language-java">public class DisClient {
    private String connectString = "192.168.20.129:2181,192.168.20.130:2181,192.168.20.131:2181";
    private int sessionTimeOut = 2000;
    private ZooKeeper zooKeeper;

    public static void main(String[] args) throws IOException, InterruptedException, KeeperException {
        DisClient client = new DisClient();
        //1.è·å–zkè¿æ¥
        client.getConnect();
        //2.ç›‘å¬/serversä¸‹é¢çš„èŠ‚ç‚¹å˜åŒ–
        client.getServerList();
        //3.ä¸šåŠ¡é€»è¾‘
        client.business();

    }

    private void business() throws InterruptedException {
        Thread.sleep(Long.MAX_VALUE);
    }

    /**
     * ç›‘å¬æœåŠ¡ç«¯ï¼ˆè·å–èŠ‚ç‚¹ä¿¡æ¯ï¼‰
     * @throws InterruptedException
     * @throws KeeperException
     */
    private void getServerList() throws InterruptedException, KeeperException {
        List&lt;String&gt; children = zooKeeper.getChildren("/servers", true);
        //æœåŠ¡å™¨åœ°å€å­˜æ”¾åˆ°é›†åˆä¸­
        ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();
        for (String child : children) {
            byte[] data = zooKeeper.getData("/servers/" + child, false, null);
            list.add(new String(data));
        }
        System.out.println(list);

    }

    /**
     * åˆå§‹è¯zookeeper
     * @throws IOException
     */
    private void getConnect() throws IOException {
        zooKeeper = new ZooKeeper(connectString, sessionTimeOut, new Watcher() {
            @Override
            public void process(WatchedEvent watchedEvent) {

                try {
                    getServerList();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } catch (KeeperException e) {
                    e.printStackTrace();
                }
            }
        });
    }
}</code></pre> 
<h3 id="2.2%E6%9C%8D%E5%8A%A1%E7%AB%AF%C2%A0">2.2æœåŠ¡ç«¯Â </h3> 
<blockquote> 
 <ul><li><strong>1.è·å–zookeeperè¿æ¥</strong></li><li><strong>2.åˆ›å»ºèŠ‚ç‚¹ï¼ˆæœåŠ¡ç«¯æ³¨å†Œåˆ°zookeeperï¼‰</strong></li><li><strong>3.ä¸šåŠ¡é€»è¾‘ï¼ˆç¡çœ ï¼‰</strong></li></ul> 
</blockquote> 
<pre><code class="language-java">/**
 * æœåŠ¡ç«¯æ³¨å†Œzookeeper
 */
public class DisServer {
    private String connectString = "192.168.20.129:2181,192.168.20.130:2181,192.168.20.131:2181";
    private int sessionTimeOut = 2000;
    private ZooKeeper zooKeeper;

    public static void main(String[] args) throws Exception {
        DisServer dIsServer = new DisServer();
        //1.è·å–zkè¿æ¥
        dIsServer.getConnect();
        //2.æ³¨å†ŒæœåŠ¡å™¨åˆ°zkèŠ‚ç‚¹ï¼ˆåˆ›å»ºèŠ‚ç‚¹ï¼‰
        dIsServer.register(args[0]);
        //3.å¯åŠ¨ä¸šåŠ¡é€»è¾‘
        dIsServer.business();
    }

    private void business() throws InterruptedException {
        Thread.sleep(Long.MAX_VALUE);
    }

    /**
     * æ³¨å†ŒæœåŠ¡å™¨ï¼ˆåˆ›å»ºèŠ‚ç‚¹ï¼‰
     * @param hostname
     * @throws InterruptedException
     * @throws KeeperException
     */
    private void register(String hostname) throws InterruptedException, KeeperException {
        String create = zooKeeper.create("/servers/"+hostname, hostname.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);
        System.out.println(hostname + "å·²ç»ä¸Šçº¿");
    }


    /**
     * åˆå§‹åŒ–zookeeper
     * @throws IOException
     */
    private void getConnect() throws IOException {
        zooKeeper = new ZooKeeper(connectString, sessionTimeOut, new Watcher() {
            @Override
            public void process(WatchedEvent watchedEvent) {

            }
        });
    }
}</code></pre> 
<h2 id="3.%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%C2%A0">3.åˆ†å¸ƒå¼é”Â </h2> 
<blockquote> 
 <p><span style="color:#0d0016;"><strong>Zookeeperçš„åˆ†å¸ƒå¼é”å®ç°åŸºäºå…¶znodeï¼ˆzkèŠ‚ç‚¹ï¼‰åŠŸèƒ½ã€‚æ¯ä¸ªznodeéƒ½å¯ä»¥æœ‰æ•°æ®å’Œå­èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¯ä¸ªznodeéƒ½æœ‰ä¸€ä¸ªç‰ˆæœ¬å·ã€‚Zookeeperçš„åˆ†å¸ƒå¼é”åˆ©ç”¨äº†znodeçš„ç‰ˆæœ¬å·ç‰¹æ€§ï¼ŒåŒæ—¶ä½¿ç”¨watcheræœºåˆ¶å®ç°åˆ†å¸ƒå¼é”çš„äº’æ–¥</strong></span></p> 
</blockquote> 
<h3 id="3.1%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B">3.1æ‰§è¡Œæµç¨‹</h3> 
<blockquote> 
 <ol><li><span style="color:#0d0016;"><strong>å½“ä¸€ä¸ªå®¢æˆ·ç«¯éœ€è¦è·å–é”æ—¶ï¼Œå®ƒä¼šåœ¨Zookeeperä¸Šåˆ›å»ºä¸€ä¸ª</strong></span><span style="color:#fe2c24;"><strong>ä¸´æ—¶ä¸”æœ‰åº</strong></span><span style="color:#0d0016;"><strong>çš„znodeèŠ‚ç‚¹ã€‚</strong></span></li><li><span style="color:#0d0016;"><strong>å®¢æˆ·ç«¯é€šè¿‡è·å–Zookeeperä¸Šçš„znodeåˆ—è¡¨ï¼Œå¹¶åˆ¤æ–­è‡ªå·±åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯å¦æ˜¯æ‰€æœ‰èŠ‚ç‚¹ä¸­æœ€å°çš„é‚£ä¸ªï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¡¨ç¤ºå®¢æˆ·ç«¯è·å¾—äº†é”ã€‚</strong></span></li><li><span style="color:#0d0016;"><strong>å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰è·å¾—é”ï¼Œåˆ™ç›‘å¬å®ƒå‰é¢ï¼ˆæ¯”å®ƒåºå·å°çš„ï¼‰çš„èŠ‚ç‚¹ï¼Œç­‰å¾…é”çš„é‡Šæ”¾ã€‚</strong></span></li><li><span style="color:#0d0016;"><strong>å½“å®¢æˆ·ç«¯é‡Šæ”¾é”æ—¶ï¼Œå®ƒä¼šåˆ é™¤è‡ªå·±åˆ›å»ºçš„znodeèŠ‚ç‚¹ï¼Œæ­¤æ—¶ï¼ŒZookeeperä¼šé€šçŸ¥æ­£åœ¨ç­‰å¾…å‰é¢çš„èŠ‚ç‚¹ä¸Šçš„watcheræœºåˆ¶ï¼Œè®©ç­‰å¾…é”çš„å®¢æˆ·ç«¯å°è¯•é‡æ–°è·å–é”</strong></span></li></ol> 
</blockquote> 
<h3 id="3.2%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">3.2ä»£ç å®ç°</h3> 
<pre><code class="language-java">/**
 * åˆ†å¸ƒå¼é”
 */
public class ZkLock {
    private final String connectString = "192.168.20.129:2181,192.168.20.130:2181,192.168.20.131:2181";
    private final int sessionTimeOut = 2000;
    private final ZooKeeper zooKeeper;
    private String path;

    private CountDownLatch countDownLatch = new CountDownLatch(1);
    private CountDownLatch countPathLatch = new CountDownLatch(1);
    private String currentNode;

    //æ„é€ å™¨åˆå§‹åŒ–
    public ZkLock() throws IOException, InterruptedException, KeeperException {
        //1.è·å–é“¾æ¥
        zooKeeper = new ZooKeeper(connectString, sessionTimeOut, new Watcher() {
            @Override
            public void process(WatchedEvent watchedEvent) {
                //countDownLatch è¿æ¥ä¸Šzookeeperï¼Œé‡Šæ”¾
                if (watchedEvent.getState() == Event.KeeperState.SyncConnected) {
                    countDownLatch.countDown();
                }
                //countPathLatch é‡Šæ”¾
                if (watchedEvent.getType() == Event.EventType.NodeDeleted &amp;&amp; watchedEvent.getPath().equals(path)) {
                    countPathLatch.countDown();

                }
            }
        });
        //ç­‰å¾…zookeeperæ­£å¸¸è¿æ¥åï¼Œå¾€ä¸‹æ‰§è¡Œç¨‹åº
        countDownLatch.await();

        //2.åˆ¤æ–­æ ¹èŠ‚ç‚¹locksæ˜¯å¦å­˜åœ¨
        Stat stat = zooKeeper.exists("/locks", false);
        if (stat == null) {
            //è¯´æ˜ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ ¹èŠ‚ç‚¹
            zooKeeper.create("/locks", "locks".getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        }

    }


    //3.åŠ é”
    public void zkLock() {
        //åˆ›å»ºå¯¹åº”çš„ä¸´æ—¶å¸¦åºå·çš„èŠ‚ç‚¹
        try {
            currentNode = zooKeeper.create("/locks/" + "seq-", null, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);

            //åˆ¤æ–­åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯å¦æ˜¯æœ€å°çš„åºå·èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯ï¼Œè·å–åˆ°é”ï¼Œå¦‚æœä¸æ˜¯ï¼Œç›‘å¬ä»–å‰ä¸€ä¸ªç»“ç‚¹
            List&lt;String&gt; children = zooKeeper.getChildren("/locks", false);

            //å¦‚æœåªæœ‰ä¸€ä¸ªå€¼ï¼Œç›´æ¥è·å–é”ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™åˆ¤æ–­
            if (children.size() == 1) {
                //ç›´æ¥æ·é”
                return;
            } else {
                //å¯¹èŠ‚ç‚¹è¿›è¡Œæ’åº
                Collections.sort(children);
                //è·å–èŠ‚ç‚¹åç§°
                String thisNode = currentNode.substring("/locks/".length());
                //é€šè¿‡ç•ŒèŠ‚ç‚¹åç§°ï¼Œè·å–åœ¨é›†åˆä¸­çš„ä¸‹æ ‡
                int index = children.indexOf(thisNode);

                //åˆ¤æ–­ä¸‹æ ‡
                if (index == -1) {
                    System.out.println("æ•°æ®å¼‚å¸¸");
                } else if (index == 0) {//ç¬¬ä¸€ä¸ªæ•°æ®
                    //ç›´æ¥æ·é”
                    return;
                } else {//è¯´æ˜å¤šä¸ªèŠ‚ç‚¹ï¼Œè¿›è¡Œç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹
                    path = "/locks/" + children.get(index - 1);
                    zooKeeper.getData(path, true, new Stat());
                    //ç­‰å¾…ç›‘å¬
                    countPathLatch.await();
                    return;
                }
            }
        } catch (KeeperException e) {
            e.printStackTrace();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    //4.è§£é”
    public void unZkLock() {
        //åˆ é™¤èŠ‚ç‚¹
        try {
            zooKeeper.delete(currentNode, -1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        } catch (KeeperException e) {
            e.printStackTrace();
        }
    }
}</code></pre> 
<h3 id="3.3%E7%BA%BF%E7%A8%8B%E6%B5%8B%E8%AF%95%C2%A0">3.3çº¿ç¨‹æµ‹è¯•Â </h3> 
<pre><code class="language-java">public class ZkLockTest {
    public static void main(String[] args) throws IOException, InterruptedException, KeeperException {
        ZkLock zkLock1 = new ZkLock();
        ZkLock zkLock2 = new ZkLock();
        ZkLock zkLock3 = new ZkLock();

        new Thread(new Runnable() {
            @Override
            public void run() {
                try {
                    zkLock1.zkLock();
                    System.out.println("çº¿ç¨‹1ï¼Œè·å–åˆ°é”");
                    Thread.sleep(3 * 1000);
                    zkLock1.unZkLock();
                    System.out.println("çº¿ç¨‹1ï¼Œé‡Šæ”¾é”");
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }).start();
        new Thread(new Runnable() {
            @Override
            public void run() {
                try {
                    zkLock2.zkLock();
                    System.out.println("çº¿ç¨‹2ï¼Œè·å–åˆ°é”");
                    Thread.sleep(3 * 1000);
                    zkLock2.unZkLock();
                    System.out.println("çº¿ç¨‹2ï¼Œé‡Šæ”¾é”");
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }).start();
        new Thread(new Runnable() {
            @Override
            public void run() {
                try {
                    zkLock3.zkLock();
                    System.out.println("çº¿ç¨‹3ï¼Œè·å–åˆ°é”");
                    Thread.sleep(3 * 1000);
                    zkLock3.unZkLock();
                    System.out.println("çº¿ç¨‹3ï¼Œé‡Šæ”¾é”");
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }).start();
    }
}</code></pre> 
<h2>4.Curatoræ¡†æ¶Â </h2> 
<blockquote> 
 <p><strong><span style="color:#0d0016;">Curatoræ˜¯Apache ZooKeeperçš„ä¸€ä¸ª</span><span style="color:#fe2c24;">é«˜çº§å®¢æˆ·ç«¯åº“</span><span style="color:#0d0016;">ï¼Œæ—¨åœ¨ä½¿å¼€å‘äººå‘˜æ›´å®¹æ˜“ç¼–å†™å¯é çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚å®ƒä¸ºZooKeeperæä¾›äº†è®¸å¤šæœ‰ç”¨çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬</span><span style="color:#4da8ee;">è¿æ¥ç®¡ç†</span><span style="color:#0d0016;">ï¼Œ</span><span style="color:#4da8ee;">åˆ†å¸ƒå¼é”</span><span style="color:#0d0016;">å’Œ</span><span style="color:#4da8ee;">é€‰ä¸¾</span><span style="color:#0d0016;">ï¼Œ</span><span style="color:#4da8ee;">ç¼“å­˜</span><span style="color:#0d0016;">å’Œ</span><span style="color:#4da8ee;">è§‚å¯Ÿ</span><span style="color:#0d0016;">ã€‚Curatorè¿˜æä¾›äº†ä¸€ç»„æ˜“äºä½¿ç”¨çš„APIï¼Œå¯ä»¥è½»æ¾ç®¡ç†ZooKeeperçš„èŠ‚ç‚¹å’Œæ•°æ®ã€‚</span></strong></p> 
</blockquote> 
<h3>4.1æ·»åŠ ä¾èµ–</h3> 
<pre><code class="language-java">        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;
            &lt;artifactId&gt;curator-framework&lt;/artifactId&gt;
            &lt;version&gt;5.5.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;
            &lt;artifactId&gt;curator-client&lt;/artifactId&gt;
            &lt;version&gt;5.5.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;
            &lt;artifactId&gt;curator-recipes&lt;/artifactId&gt;
            &lt;version&gt;5.5.0&lt;/version&gt;
        &lt;/dependency&gt;</code></pre> 
<h3>4.2ä»£ç å®ç°</h3> 
<pre><code class="language-java">    /**
     * å®¢æˆ·ç«¯è¿æ¥
     * @return
     */
    private static CuratorFramework getCuratorFramework() {

        //åˆ›å»ºzookeeperçš„å®¢æˆ·ç«¯:é‡è¯•ç­–ç•¥ï¼Œåˆå§‹åŒ–æ¯æ¬¡é‡è¯•ä¹‹é—´éœ€è¦ç­‰å¾…çš„æ—¶é—´ï¼ŒåŸºå‡†ç­‰å¾…æ—¶é—´ä¸º3ç§’
        ExponentialBackoffRetry policy = new ExponentialBackoffRetry(3000, 3);

        CuratorFramework client = CuratorFrameworkFactory.builder().connectString("192.168.20.129:2181,192.168.20.131:2181,192.168.20.130:2181")
                .connectionTimeoutMs(2000)
                .sessionTimeoutMs(2000)
                .retryPolicy(policy).build();
        client.start();
        System.out.println("zookeeperå¯åŠ¨~");
        return client;
    }</code></pre> 
<h3 style="background-color:transparent;">4.3åˆ›å»ºçº¿ç¨‹æµ‹è¯•</h3> 
<pre><code class="language-java">InterProcessMutex lock1 = new InterProcessMutex(getCuratorFramework(), "/locks");
        InterProcessMutex lock2 = new InterProcessMutex(getCuratorFramework(), "/locks");
        new Thread(new Runnable() {
            @Override
            public void run() {
                try {
                    lock1.acquire();
                    System.out.println("çº¿ç¨‹ä¸€è·å–åˆ°é”");
                    Thread.sleep(3000);
                    lock1.release();
                    System.out.println("çº¿ç¨‹ä¸€é‡Šæ”¾é”");
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }).start();
        new Thread(new Runnable() {
            @Override
            public void run() {
                try {
                    lock2.acquire();
                    System.out.println("çº¿ç¨‹äºŒè·å–åˆ°é”");
                    Thread.sleep(3000);
                    lock2.release();
                    System.out.println("çº¿ç¨‹äºŒé‡Šæ”¾é”");
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }).start();
    }</code></pre> 
<p><img alt="" class="left" height="300" src="https://images2.imgbox.com/37/0d/kvzAlZ3X_o.gif" width="300"><img alt="" class="left" height="300" src="https://images2.imgbox.com/51/25/5pkgowN7_o.gif" width="300"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e98aade5d86a970b1720f022dc66e72e/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">9.javaâ€”â€”ï¼ˆæ‚ä¾‹ï¼‰ç»„åˆï¼Œä»£ç†ï¼Œå‘ä¸Šè½¬å‹static,fianl,å…³é”®å­—ï¼ˆæœ‰é“äº‘ç¬”è®°å¤åˆ¶ç²˜è´´ï¼Œå¤§å®¶æ•´ä½“æ€§çš„æŠŠæ¡ï¼‰</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fc56406c1f4aa40b865fe604084ad67b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">Everythingç»“åˆå†…ç½‘ç©¿é€æ­å»ºåœ¨çº¿èµ„æ–™åº“å¹¶å®ç°éšæ—¶éšåœ°è¿œç¨‹è®¿é—®</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 èœé¸Ÿç¨‹åºå‘˜åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>