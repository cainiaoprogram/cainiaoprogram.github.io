<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>搭建RabbitMQ Server高可用集群 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="搭建RabbitMQ Server高可用集群" />
<meta property="og:description" content="搭建RabbitMQ Server高可用集群 目录 文章目录 搭建RabbitMQ Server高可用集群目录1.背景介绍2.环境介绍3 架构视图4 RabbitMQ和Erlang的版本5 准备工作6 搭建RabbitMQ Server单机版7 RabbitMQ Server高可用集群的相关概念7.1 设置集群目的7.2 集群配置方式7.3节点类型7.4 Erlang Cookie7.5镜像队列 8 搭建RabbitMQ Server高可用集群9 搭建HAproxy负载均衡（可选）10 RabbmitMQ搭建踩坑 1.背景介绍 由于客户的成本预算不足，不想在华为云购买单独的MQ的产品，只能在华为云购买云服务器，然后自己搭建RabbitMQ Server集群。但也是预算不足，仅有两台服务器，还是要集群。
2.环境介绍 RabbitMQ-nodeIP地址工作模式操作系统EIPhy-mq-0001172.16.1.244（内网）DISKCentOS7.9116.205.189.205hy-mq-0002172.16.1.86DISKCentOS7.9 3 架构视图 这个网络上找的一个高可用集群架构，仅供参考，在云上的负载可以使用LB来代替，但必然会造成成本的增加，最后还是需要以客户的意愿会导向。
4 RabbitMQ和Erlang的版本 由于客户所需要的版本是指定的，又是在rhel系列上，所以从官网直接找出对应的版本进行下载下来，有各种不同的方式下载，下面是下载的地址，本实验采用的rabbitmq-server-3.8.5，erlang-23.2.7-2。
下面是下载的官网。
rabbitmq官网 https://www.rabbitmq.com/ rabbitmq-下载的地址 https://github.com/rabbitmq/signing-keys/releases/ erlang官网 https://www.erlang.org/ erlang下载地址 https://www.erlang.org/downloads 5 准备工作 首先将两台的服务器的hostname的名字设置，你需要的nodename，命令如下：
hostnamectl set-hostname NAME 接着将修改两台的/etc/hosts文件
[root@hy-mq-0001 ~]# cat /etc/hosts ::1	localhost	localhost.localdomain	localhost6	localhost6.localdomain6 127.0.0.1	localhost	localhost.localdomain	localhost4	localhost4.localdomain4 127.0.0.1	hy-mq-0001	hy-mq-0001 172.16.1.244 hy-mq-0001 172.16.1.86 hy-mq-0002 6 搭建RabbitMQ Server单机版 以下使用mq-0001服务作为单机版的演示实例。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/58eb8ac2cd04b4cd2dc12c8b3a54a2fd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-23T13:20:48+08:00" />
<meta property="article:modified_time" content="2023-11-23T13:20:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">搭建RabbitMQ Server高可用集群</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="RabbitMQ_Server_0"></a>搭建RabbitMQ Server高可用集群</h3> 
<h4><a id="_2"></a>目录</h4> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#RabbitMQ_Server_0" rel="nofollow">搭建RabbitMQ Server高可用集群</a></li><li><ul><li><a href="#_2" rel="nofollow">目录</a></li><li><a href="#1_5" rel="nofollow">1.背景介绍</a></li><li><a href="#2_9" rel="nofollow">2.环境介绍</a></li><li><a href="#3__16" rel="nofollow">3 架构视图</a></li><li><a href="#4_RabbitMQErlang_22" rel="nofollow">4 RabbitMQ和Erlang的版本</a></li><li><a href="#5__42" rel="nofollow">5 准备工作</a></li><li><a href="#6_RabbitMQ_Server_62" rel="nofollow">6 搭建RabbitMQ Server单机版</a></li><li><a href="#7_RabbitMQ_Server_226" rel="nofollow">7 RabbitMQ Server高可用集群的相关概念</a></li><li><ul><li><a href="#71__230" rel="nofollow">7.1 设置集群目的</a></li><li><a href="#72__235" rel="nofollow">7.2 集群配置方式</a></li><li><a href="#73_241" rel="nofollow">7.3节点类型</a></li><li><a href="#74_Erlang_Cookie_250" rel="nofollow">7.4 Erlang Cookie</a></li><li><a href="#75_259" rel="nofollow">7.5镜像队列</a></li></ul> 
    </li><li><a href="#8_RabbitMQ_Server_300" rel="nofollow">8 搭建RabbitMQ Server高可用集群</a></li><li><a href="#9_HAproxy_511" rel="nofollow">9 搭建HAproxy负载均衡（可选）</a></li><li><a href="#10_RabbmitMQ_678" rel="nofollow">10 RabbmitMQ搭建踩坑</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h4><a id="1_5"></a>1.背景介绍</h4> 
<p>由于客户的成本预算不足，不想在华为云购买单独的MQ的产品，只能在华为云购买云服务器，然后自己搭建RabbitMQ Server集群。但也是预算不足，仅有两台服务器，还是要集群。</p> 
<h4><a id="2_9"></a>2.环境介绍</h4> 
<table><thead><tr><th>RabbitMQ-node</th><th>IP地址</th><th>工作模式</th><th>操作系统</th><th>EIP</th></tr></thead><tbody><tr><td>hy-mq-0001</td><td>172.16.1.244（内网）</td><td>DISK</td><td>CentOS7.9</td><td>116.205.189.205</td></tr><tr><td>hy-mq-0002</td><td>172.16.1.86</td><td>DISK</td><td>CentOS7.9</td><td></td></tr></tbody></table> 
<h4><a id="3__16"></a>3 架构视图</h4> 
<p>这个网络上找的一个高可用集群架构，仅供参考，在云上的负载可以使用LB来代替，但必然会造成成本的增加，最后还是需要以客户的意愿会导向。</p> 
<p><img src="https://images2.imgbox.com/9b/eb/NI7OUCUu_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="4_RabbitMQErlang_22"></a>4 RabbitMQ和Erlang的版本</h4> 
<p>由于客户所需要的版本是指定的，又是在rhel系列上，所以从官网直接找出对应的版本进行下载下来，有各种不同的方式下载，下面是下载的地址，本实验采用的rabbitmq-server-3.8.5，erlang-23.2.7-2。</p> 
<p>下面是下载的官网。</p> 
<pre><code>rabbitmq官网
https://www.rabbitmq.com/

rabbitmq-下载的地址
https://github.com/rabbitmq/signing-keys/releases/

erlang官网
https://www.erlang.org/

erlang下载地址
https://www.erlang.org/downloads
</code></pre> 
<h4><a id="5__42"></a>5 准备工作</h4> 
<p>首先将两台的服务器的hostname的名字设置，你需要的nodename，命令如下：</p> 
<pre><code class="prism language-shell">hostnamectl set-hostname NAME
</code></pre> 
<p>接着将修改两台的/etc/hosts文件</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/hosts</span>
::1	localhost	localhost.localdomain	localhost6	localhost6.localdomain6
<span class="token number">127.0</span>.0.1	localhost	localhost.localdomain	localhost4	localhost4.localdomain4
<span class="token number">127.0</span>.0.1	hy-mq-0001	hy-mq-0001

<span class="token number">172.16</span>.1.244 hy-mq-0001
<span class="token number">172.16</span>.1.86  hy-mq-0002
</code></pre> 
<h4><a id="6_RabbitMQ_Server_62"></a>6 搭建RabbitMQ Server单机版</h4> 
<p>以下使用mq-0001服务作为单机版的演示实例。</p> 
<p>如果你采用的是源安装的话，就需要更新软件包和存储库。</p> 
<pre><code class="prism language-shell">yum <span class="token parameter variable">-y</span> update
</code></pre> 
<p>接着安装Erlang（RabbitMQ运行需要Erlang和socat）</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># rpm -ivh erlang-23.2.7-2.el7.x86_64.rpm </span>
warning: erlang-23.2.7-2.el7.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 6026dfca: NOKEY
Preparing<span class="token punctuation">..</span>.                          <span class="token comment">################################# [100%]</span>
Updating / installing<span class="token punctuation">..</span>.
   <span class="token number">1</span>:erlang-23.2.7-2.el7              <span class="token comment">################################# [100%]</span>
<span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install socat</span>
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
Resolving Dependencies
--<span class="token operator">&gt;</span> Running transaction check
---<span class="token operator">&gt;</span> Package socat.x86_64 <span class="token number">0</span>:1.7.3.2-2.el7 will be installed
--<span class="token operator">&gt;</span> Finished Dependency Resolution

Dependencies Resolved

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
 Package                               Arch                                   Version                                          Repository                            Size
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
Installing:
 socat                                 x86_64                                 <span class="token number">1.7</span>.3.2-2.el7                                    base                                 <span class="token number">290</span> k

Transaction Summary
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
Install  <span class="token number">1</span> Package

Total download size: <span class="token number">290</span> k
Installed size: <span class="token number">1.1</span> M
Downloading packages:
socat-1.7.3.2-2.el7.x86_64.rpm                                                                                                                     <span class="token operator">|</span> <span class="token number">290</span> kB  00:00:00     
Running transaction check
Running transaction <span class="token builtin class-name">test</span>
Transaction <span class="token builtin class-name">test</span> succeeded
Running transaction
Warning: RPMDB altered outside of yum.
  Installing <span class="token builtin class-name">:</span> socat-1.7.3.2-2.el7.x86_64                                                                                                                             <span class="token number">1</span>/1 
  Verifying  <span class="token builtin class-name">:</span> socat-1.7.3.2-2.el7.x86_64                                                                                                                             <span class="token number">1</span>/1 

Installed:
  socat.x86_64 <span class="token number">0</span>:1.7.3.2-2.el7                                                                                                                                            

Complete<span class="token operator">!</span>
</code></pre> 
<p>安装 RabbitMQ Server：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># rpm -ivh rabbitmq-server-3.8.5-1.el7.noarch.rpm </span>
warning: rabbitmq-server-3.8.5-1.el7.noarch.rpm: Header V4 RSA/SHA256 Signature, key ID 6026dfca: NOKEY
Preparing<span class="token punctuation">..</span>.                          <span class="token comment">################################# [100%]</span>
Updating / installing<span class="token punctuation">..</span>.
   <span class="token number">1</span>:rabbitmq-server-3.8.5-1.el7      <span class="token comment">################################# [100%]</span>
</code></pre> 
<p>安装好之后，就可以启动 RabbitMQ Server 了：</p> 
<pre><code>[root@hy-mq-0001 ~]# systemctl start rabbitmq-server
</code></pre> 
<p>启动成功之后，查看RabbitMQ Server的状态。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># systemctl status rabbitmq-server</span>
● rabbitmq-server.service - RabbitMQ broker
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/rabbitmq-server.service<span class="token punctuation">;</span> disabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Thu <span class="token number">2023</span>-11-23 09:59:45 CST<span class="token punctuation">;</span> 16s ago
 Main PID: <span class="token number">8971</span> <span class="token punctuation">(</span>beam.smp<span class="token punctuation">)</span>
   Status: <span class="token string">"Initialized"</span>
   CGroup: /system.slice/rabbitmq-server.service
           ├─8971 /usr/lib64/erlang/erts-11.1.8/bin/beam.smp <span class="token parameter variable">-W</span> w <span class="token parameter variable">-K</span> <span class="token boolean">true</span> <span class="token parameter variable">-A</span> <span class="token number">64</span> <span class="token parameter variable">-MBas</span> ageffcbf <span class="token parameter variable">-MHas</span> ageffcbf <span class="token parameter variable">-MBlmbcs</span> <span class="token number">512</span> <span class="token parameter variable">-MHlmbcs</span> <span class="token number">512</span> <span class="token parameter variable">-MMmcs</span> <span class="token number">30</span> <span class="token parameter variable">-P</span> <span class="token number">1048576</span> <span class="token parameter variable">-t</span> <span class="token number">5000000</span><span class="token punctuation">..</span>.
           ├─9076 erl_child_setup <span class="token number">32768</span>
           ├─9101 /usr/lib64/erlang/erts-11.1.8/bin/epmd <span class="token parameter variable">-daemon</span>
           ├─9124 inet_gethost <span class="token number">4</span>
           └─9125 inet_gethost <span class="token number">4</span>

Nov <span class="token number">23</span> 09:59:44 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">8971</span><span class="token punctuation">]</span>: <span class="token comment">##########  Licensed under the MPL 1.1. Website: https://rabbitmq.com</span>
Nov <span class="token number">23</span> 09:59:44 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">8971</span><span class="token punctuation">]</span>: Doc guides: https://rabbitmq.com/documentation.html
Nov <span class="token number">23</span> 09:59:44 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">8971</span><span class="token punctuation">]</span>: Support:    https://rabbitmq.com/contact.html
Nov <span class="token number">23</span> 09:59:44 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">8971</span><span class="token punctuation">]</span>: Tutorials:  https://rabbitmq.com/getstarted.html
Nov <span class="token number">23</span> 09:59:44 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">8971</span><span class="token punctuation">]</span>: Monitoring: https://rabbitmq.com/monitoring.html
Nov <span class="token number">23</span> 09:59:44 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">8971</span><span class="token punctuation">]</span>: Logs: /var/log/rabbitmq/rabbit@hy-mq-0001.log
Nov <span class="token number">23</span> 09:59:44 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">8971</span><span class="token punctuation">]</span>: /var/log/rabbitmq/rabbit@hy-mq-0001_upgrade.log
Nov <span class="token number">23</span> 09:59:44 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">8971</span><span class="token punctuation">]</span>: Config file<span class="token punctuation">(</span>s<span class="token punctuation">)</span>: <span class="token punctuation">(</span>none<span class="token punctuation">)</span>
Nov <span class="token number">23</span> 09:59:45 hy-mq-0001 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started RabbitMQ broker.
Nov <span class="token number">23</span> 09:59:46 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">8971</span><span class="token punctuation">]</span>: Starting broker<span class="token punctuation">..</span>. completed with <span class="token number">0</span> plugins.
</code></pre> 
<p>将MQ-server设置会开启自启</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable rabbitmq-server</span>
Created symlink from /etc/systemd/system/multi-user.target.wants/rabbitmq-server.service to /usr/lib/systemd/system/rabbitmq-server.service.
<span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<p>启动 RabbitMQ Web 管理控制台：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># rabbitmq-plugins enable rabbitmq_management</span>
Enabling plugins on <span class="token function">node</span> rabbit@hy-mq-0001:
rabbitmq_management
The following plugins have been configured:
  rabbitmq_management
  rabbitmq_management_agent
  rabbitmq_web_dispatch
Applying plugin configuration to rabbit@hy-mq-0001<span class="token punctuation">..</span>.
The following plugins have been enabled:
  rabbitmq_management
  rabbitmq_management_agent
  rabbitmq_web_dispatch

started <span class="token number">3</span> plugins.
</code></pre> 
<p>RabbitMQ Server 默认<code>guest</code>用户，只能<code>localhost</code>地址访问，我们还需要创建管理用户：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl add_user admin admin123 &amp;&amp; </span>
<span class="token operator">&gt;</span> rabbitmqctl set_user_tags admin administrator <span class="token operator">&amp;&amp;</span> 
<span class="token operator">&gt;</span> rabbitmqctl set_permissions <span class="token parameter variable">-p</span> / admin <span class="token string">".*"</span> <span class="token string">".*"</span> <span class="token string">".*"</span>
Adding user <span class="token string">"admin"</span> <span class="token punctuation">..</span>.
Setting tags <span class="token keyword">for</span> user <span class="token string">"admin"</span> to <span class="token punctuation">[</span>administrator<span class="token punctuation">]</span> <span class="token punctuation">..</span>.
Setting permissions <span class="token keyword">for</span> user <span class="token string">"admin"</span> <span class="token keyword">in</span> vhost <span class="token string">"/"</span> <span class="token punctuation">..</span>.
</code></pre> 
<p>查看开启的端口和服务</p> 
<pre><code>[root@hy-mq-0001 ~]# ss -ntlp
State      Recv-Q Send-Q                                        Local Address:Port                                                       Peer Address:Port              
LISTEN     0      128                                                       *:25672                                                                 *:*                   users:(("beam.smp",pid=8971,fd=81))
LISTEN     0      10                                                127.0.0.1:39338                                                                 *:*                   users:(("uniagentd",pid=2067,fd=4))
LISTEN     0      10                                                127.0.0.1:39339                                                                 *:*                   users:(("uniagentd",pid=2068,fd=4))
LISTEN     0      128                                                       *:4369                                                                  *:*                   users:(("epmd",pid=9101,fd=3))
LISTEN     0      128                                                       *:22                                                                    *:*                   users:(("sshd",pid=2084,fd=3))
LISTEN     0      1024                                                      *:15672                                                                 *:*                   users:(("beam.smp",pid=8971,fd=96))
LISTEN     0      100                                               127.0.0.1:25                                                                    *:*                   users:(("master",pid=932,fd=13))
LISTEN     0      128                                                    [::]:5672                                                               [::]:*                   users:(("beam.smp",pid=8971,fd=94))
LISTEN     0      128                                                    [::]:4369                                                               [::]:*                   users:(("epmd",pid=9101,fd=4))
LISTEN     0      128                                                    [::]:22                                                                 [::]:*                   users:(("sshd",pid=2084,fd=4))
LISTEN     0      100                                                   [::1]:25                                                                 [::]:*                   users:(("master",pid=932,fd=14))
[root@hy-mq-0001 ~]#
</code></pre> 
<p>如果在云上需要开启安全组，将15672的端口开启。，如果是防火墙需要开启运行的端口。</p> 
<p>上面这些做完了，RabbitMQ 单机版的部署也完成了，我们可以浏览器访问``：<br> <img src="https://images2.imgbox.com/1f/a7/vJmKO3YG_o.png" alt="1700705209516.png"></p> 
<p>此时单机版已完成部署。</p> 
<h4><a id="7_RabbitMQ_Server_226"></a>7 RabbitMQ Server高可用集群的相关概念</h4> 
<p>在安装集群之前，首先要简单了解下集群的相关信息，才能更加了解RabbitMQ集群。</p> 
<h5><a id="71__230"></a>7.1 设置集群目的</h5> 
<ul><li>允许消费者和生产者在 RabbitMQ 节点崩溃的情况下继续运行。</li><li>通过增加更多的节点来扩展消息通信的吞吐量。</li></ul> 
<h5><a id="72__235"></a>7.2 集群配置方式</h5> 
<ul><li><strong>cluster</strong>：不支持跨网段，用于同一个网段内的局域网；可以随意的动态增加或者减少；节点之间需要运行相同版本的 RabbitMQ 和 Erlang。</li><li><strong>federation</strong>：应用于广域网，允许单台服务器上的交换机或队列接收发布到另一台服务器上交换机或队列的消息，可以是单独机器或集群。federation 队列类似于单向点对点连接，消息会在联盟队列之间转发任意次，直到被消费者接受。通常使用 federation 来连接 internet 上的中间服务器，用作订阅分发消息或工作队列。</li><li><strong>shovel</strong>：连接方式与 federation 的连接方式类似，但它工作在更低层次。可以应用于广域网。</li></ul> 
<h5><a id="73_241"></a>7.3节点类型</h5> 
<ul><li><strong>RAM node</strong>：内存节点将所有的队列、交换机、绑定、用户、权限和 vhost 的元数据定义存储在内存中，好处是可以使得像交换机和队列声明等操作更加的快速。</li><li><strong>Disk node</strong>：将元数据存储在磁盘中，单节点系统只允许磁盘类型的节点，防止重启 RabbitMQ 的时候，丢失系统的配置信息。</li></ul> 
<blockquote> 
 <p>问题说明：RabbitMQ 要求在集群中至少有一个磁盘节点，所有其他节点可以是内存节点，当节点加入或者离开集群时，必须要将该变更通知到至少一个磁盘节点。如果集群中唯一的一个磁盘节点崩溃的话，集群仍然可以保持运行，但是无法进行其他操作（增删改查），直到节点恢复。<br> 解决方案：设置两个磁盘节点，至少有一个是可用的，可以保存元数据的更改。</p> 
</blockquote> 
<h5><a id="74_Erlang_Cookie_250"></a>7.4 Erlang Cookie</h5> 
<p>Erlang Cookie 是保证不同节点可以相互通信的密钥，要保证集群中的不同节点相互通信必须共享相同的 Erlang Cookie。具体的目录存放在<code>/var/lib/rabbitmq/.erlang.cookie</code></p> 
<p>这个非常重要，要在rabbitmq启动之前拷贝进去，还要注意权限，这个我们在搭建的集群的时候会说明。</p> 
<blockquote> 
 <p>说明：这就要从 rabbitmqctl 命令的工作原理说起，RabbitMQ 底层是通过 Erlang 架构来实现的，所以 rabbitmqctl 会启动 Erlang 节点，并基于 Erlang 节点来使用 Erlang 系统连接 RabbitMQ 节点，在连接过程中需要正确的 Erlang Cookie 和节点名称，Erlang 节点通过交换 Erlang Cookie 以获得认证。</p> 
</blockquote> 
<h5><a id="75_259"></a>7.5镜像队列</h5> 
<p>RabbitMQ 的 Cluster 集群模式一般分为两种，普通模式和镜像模式。</p> 
<ul><li><strong>普通模式</strong>：默认的集群模式，以两个节点（rabbit01、rabbit02）为例来进行说明。对于 Queue 来说，消息实体只存在于其中一个节点 rabbit01（或者 rabbit02），rabbit01 和 rabbit02 两个节点仅有相同的元数据，即队列的结构。当消息进入 rabbit01 节点的 Queue 后，consumer 从 rabbit02 节点消费时，RabbitMQ 会临时在 rabbit01、rabbit02 间进行消息传输，把 A 中的消息实体取出并经过 B 发送给 consumer。所以 consumer 应尽量连接每一个节点，从中取消息。即对于同一个逻辑队列，要在多个节点建立物理 Queue。否则无论 consumer 连 rabbit01 或 rabbit02，出口总在 rabbit01，会产生瓶颈。当 rabbit01 节点故障后，rabbit02 节点无法取到 rabbit01 节点中还未消费的消息实体。如果做了消息持久化，那么得等 rabbit01 节点恢复，然后才可被消费；如果没有持久化的话，就会产生消息丢失的现象。</li><li><strong>镜像模式</strong>：将需要消费的队列变为镜像队列，存在于多个节点，这样就可以实现 RabbitMQ 的 HA 高可用性。作用就是消息实体会主动在镜像节点之间实现同步，而不是像普通模式那样，在 consumer 消费数据时临时读取。缺点就是，集群内部的同步通讯会占用大量的网络带宽。</li></ul> 
<p>镜像队列实现了 RabbitMQ 的高可用性（HA），具体的实现策略如下所示：</p> 
<table><thead><tr><th>ha-mode</th><th>ha-params</th><th>功能</th></tr></thead><tbody><tr><td>all</td><td>空</td><td>镜像队列将会在整个集群中复制。当一个新的节点加入后，也会在这 个节点上复制一份。</td></tr><tr><td>exactly</td><td>count</td><td>镜像队列将会在集群上复制 count 份。如果集群数量少于 count 时候，队列会复制到所有节点上。如果大于 Count 集群，有一个节点 crash 后，新进入节点也不会做新的镜像。</td></tr><tr><td>nodes</td><td>node name</td><td>镜像队列会在 node name 中复制。如果这个名称不是集群中的一个，这不会触发错误。如果在这个 node list 中没有一个节点在线，那么这个 queue 会被声明在 client 连接的节点。</td></tr></tbody></table> 
<p>实例列举：</p> 
<pre><code class="prism language-python">queue_args<span class="token punctuation">(</span><span class="token string">"x-ha-policy"</span><span class="token punctuation">:</span><span class="token string">"all"</span><span class="token punctuation">)</span> <span class="token operator">//</span>定义字典来设置额外的队列声明参数
channel<span class="token punctuation">.</span>queue_declare<span class="token punctuation">(</span>queue<span class="token operator">=</span><span class="token string">"hello-queue"</span><span class="token punctuation">,</span>argument<span class="token operator">=</span>queue_args<span class="token punctuation">)</span>
</code></pre> 
<p>如果需要设定特定的节点（以<code>rabbit@localhost</code>为例），再添加一个参数：</p> 
<pre><code class="prism language-python">queue_args<span class="token punctuation">(</span><span class="token string">"x-ha-policy"</span><span class="token punctuation">:</span><span class="token string">"nodes"</span><span class="token punctuation">,</span>
           <span class="token string">"x-ha-policy-params"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"rabbit@localhost"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
channel<span class="token punctuation">.</span>queue_declare<span class="token punctuation">(</span>queue<span class="token operator">=</span><span class="token string">"hello-queue"</span><span class="token punctuation">,</span>argument<span class="token operator">=</span>queue_args<span class="token punctuation">)</span>
</code></pre> 
<p>可以通过命令行查看那个主节点进行了同步：</p> 
<pre><code class="prism language-bash">$ rabbitmqctl list_queue name slave_pids synchronised_slave_pids
</code></pre> 
<p>以上内容主要参考：<a href="https://blog.csdn.net/WoogeYu/article/details/51119101">RabbitMQ 分布式集群架构</a></p> 
<p>参考链接：<a href="https://www.cnblogs.com/xishuai/p/centos-rabbitmq-cluster-and-haproxy.html" rel="nofollow">https://www.cnblogs.com/xishuai/p/centos-rabbitmq-cluster-and-haproxy.html</a></p> 
<h4><a id="8_RabbitMQ_Server_300"></a>8 搭建RabbitMQ Server高可用集群</h4> 
<p>默认<code>.erlang.cookie</code>文件是隐藏的，<code>ls</code>命令并不能查看，你也可以手动搜索下文件：</p> 
<pre><code>[root@hy-mq-0001 ~]# find / -name ".erlang.cookie"
/var/lib/rabbitmq/.erlang.cookie
[root@hy-mq-0001 ~]# cat /var/lib/rabbitmq/.erlang.cookie
DEJFRXXRTEGNMAHDKCNL[root@hy-mq-0001 ~]#
</code></pre> 
<p>将mq-0001服务器中的cookie文件，拷贝到mq-0002上；（注意权限问题）</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># scp /var/lib/rabbitmq/.erlang.cookie root@172.16.1.86:/var/lib/rabbitmq/</span>
The authenticity of <span class="token function">host</span> <span class="token string">'172.16.1.86 (172.16.1.86)'</span> can<span class="token string">'t be established.
ECDSA key fingerprint is SHA256:IA6D6+rvZUn5GyIUY/FdmiEb4twKmEY032GYiBBCVyo.
ECDSA key fingerprint is MD5:2b:b5:d8:d8:e0:25:ca:b3:88:1c:e9:6e:4e:53:de:03.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '</span><span class="token number">172.16</span>.1.86<span class="token string">' (ECDSA) to the list of known hosts.
root@172.16.1.86'</span>s password: 
.erlang.cookie                                                                                                                          <span class="token number">100</span>%   <span class="token number">20</span>    <span class="token number">74</span>.5KB/s   00:00    
<span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># </span>

<span class="token comment">#修改下面的权限要不然会出去问题</span>
<span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment"># ll /var/lib/rabbitmq/.erlang.cookie</span>
-r-------- <span class="token number">1</span> root root <span class="token number">20</span> Nov <span class="token number">23</span> <span class="token number">10</span>:28 /var/lib/rabbitmq/.erlang.cookie
<span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment"># chown rabbitmq:rabbitmq /var/lib/rabbitmq/.erlang.cookie</span>
<span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment"># ll /var/lib/rabbitmq/.erlang.cookie</span>
-r-------- <span class="token number">1</span> rabbitmq rabbitmq <span class="token number">20</span> Nov <span class="token number">23</span> <span class="token number">10</span>:28 /var/lib/rabbitmq/.erlang.cookie
</code></pre> 
<p>修改这个rabbitmq-env.conf文件（若不存在，需要手动添加）</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/rabbitmq/rabbitmq-env.conf</span>
<span class="token assign-left variable">RABBITMQ_NAME</span><span class="token operator">=</span>rabbit@hy-mq-0002
</code></pre> 
<p>同理也需要在mq-0001上面添加，然后需要重新启动。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/rabbitmq/rabbitmq-env.conf</span>
<span class="token assign-left variable">RABBITMQ_NAME</span><span class="token operator">=</span>rabbit@hy-mq-0001
<span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/rabbitmq/rabbitmq-env.conf</span>
<span class="token assign-left variable">RABBITMQ_NAME</span><span class="token operator">=</span>rabbit@hy-mq-0001
<span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart rabbitmq-server</span>
<span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># systemctl status rabbitmq-server</span>
● rabbitmq-server.service - RabbitMQ broker
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/rabbitmq-server.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Thu <span class="token number">2023</span>-11-23 <span class="token number">10</span>:33:51 CST<span class="token punctuation">;</span> 8s ago
  Process: <span class="token number">22209</span> <span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/usr/sbin/rabbitmqctl <span class="token function">shutdown</span> <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">0</span>/SUCCESS<span class="token punctuation">)</span>
 Main PID: <span class="token number">22263</span> <span class="token punctuation">(</span>beam.smp<span class="token punctuation">)</span>
   Status: <span class="token string">"Initialized"</span>
   CGroup: /system.slice/rabbitmq-server.service
           ├─22263 /usr/lib64/erlang/erts-11.1.8/bin/beam.smp <span class="token parameter variable">-W</span> w <span class="token parameter variable">-K</span> <span class="token boolean">true</span> <span class="token parameter variable">-A</span> <span class="token number">64</span> <span class="token parameter variable">-MBas</span> ageffcbf <span class="token parameter variable">-MHas</span> ageffcbf <span class="token parameter variable">-MBlmbcs</span> <span class="token number">512</span> <span class="token parameter variable">-MHlmbcs</span> <span class="token number">512</span> <span class="token parameter variable">-MMmcs</span> <span class="token number">30</span> <span class="token parameter variable">-P</span> <span class="token number">1048576</span> <span class="token parameter variable">-t</span> <span class="token number">500000</span><span class="token punctuation">..</span>.
           ├─22369 erl_child_setup <span class="token number">32768</span>
           ├─22396 /usr/lib64/erlang/erts-11.1.8/bin/epmd <span class="token parameter variable">-daemon</span>
           ├─22419 inet_gethost <span class="token number">4</span>
           └─22420 inet_gethost <span class="token number">4</span>

Nov <span class="token number">23</span> <span class="token number">10</span>:33:51 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">22263</span><span class="token punctuation">]</span>: <span class="token comment">##########  Licensed under the MPL 1.1. Website: https://rabbitmq.com</span>
Nov <span class="token number">23</span> <span class="token number">10</span>:33:51 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">22263</span><span class="token punctuation">]</span>: Doc guides: https://rabbitmq.com/documentation.html
Nov <span class="token number">23</span> <span class="token number">10</span>:33:51 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">22263</span><span class="token punctuation">]</span>: Support:    https://rabbitmq.com/contact.html
Nov <span class="token number">23</span> <span class="token number">10</span>:33:51 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">22263</span><span class="token punctuation">]</span>: Tutorials:  https://rabbitmq.com/getstarted.html
Nov <span class="token number">23</span> <span class="token number">10</span>:33:51 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">22263</span><span class="token punctuation">]</span>: Monitoring: https://rabbitmq.com/monitoring.html
Nov <span class="token number">23</span> <span class="token number">10</span>:33:51 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">22263</span><span class="token punctuation">]</span>: Logs: /var/log/rabbitmq/rabbit@hy-mq-0001.log
Nov <span class="token number">23</span> <span class="token number">10</span>:33:51 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">22263</span><span class="token punctuation">]</span>: /var/log/rabbitmq/rabbit@hy-mq-0001_upgrade.log
Nov <span class="token number">23</span> <span class="token number">10</span>:33:51 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">22263</span><span class="token punctuation">]</span>: Config file<span class="token punctuation">(</span>s<span class="token punctuation">)</span>: <span class="token punctuation">(</span>none<span class="token punctuation">)</span>
Nov <span class="token number">23</span> <span class="token number">10</span>:33:51 hy-mq-0001 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started RabbitMQ broker.
Nov <span class="token number">23</span> <span class="token number">10</span>:33:51 hy-mq-0001 rabbitmq-server<span class="token punctuation">[</span><span class="token number">22263</span><span class="token punctuation">]</span>: Starting broker<span class="token punctuation">..</span>. completed with <span class="token number">3</span> plugins.
<span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<p>将·mq-0002·上完成安装，启动并设置开机自启</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start rabbitmq-server</span>
<span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment"># systemctl status rabbitmq-server</span>
● rabbitmq-server.service - RabbitMQ broker
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/rabbitmq-server.service<span class="token punctuation">;</span> disabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Thu <span class="token number">2023</span>-11-23 <span class="token number">10</span>:35:47 CST<span class="token punctuation">;</span> 12s ago
 Main PID: <span class="token number">19770</span> <span class="token punctuation">(</span>beam.smp<span class="token punctuation">)</span>
   Status: <span class="token string">"Initialized"</span>
   CGroup: /system.slice/rabbitmq-server.service
           ├─19770 /usr/lib64/erlang/erts-11.1.8/bin/beam.smp <span class="token parameter variable">-W</span> w <span class="token parameter variable">-K</span> <span class="token boolean">true</span> <span class="token parameter variable">-A</span> <span class="token number">64</span> <span class="token parameter variable">-MBas</span> ageffcbf <span class="token parameter variable">-MHas</span> ageffcbf <span class="token parameter variable">-MBlmbcs</span> <span class="token number">512</span> <span class="token parameter variable">-MHlmbcs</span> <span class="token number">512</span> <span class="token parameter variable">-MMmcs</span> <span class="token number">30</span> <span class="token parameter variable">-P</span> <span class="token number">1048576</span> <span class="token parameter variable">-t</span> <span class="token number">500000</span><span class="token punctuation">..</span>.
           ├─19875 erl_child_setup <span class="token number">32768</span>
           ├─19901 /usr/lib64/erlang/erts-11.1.8/bin/epmd <span class="token parameter variable">-daemon</span>
           ├─19924 inet_gethost <span class="token number">4</span>
           └─19925 inet_gethost <span class="token number">4</span>

Nov <span class="token number">23</span> <span class="token number">10</span>:35:46 hy-mq-0002 rabbitmq-server<span class="token punctuation">[</span><span class="token number">19770</span><span class="token punctuation">]</span>: <span class="token comment">##########  Licensed under the MPL 1.1. Website: https://rabbitmq.com</span>
Nov <span class="token number">23</span> <span class="token number">10</span>:35:46 hy-mq-0002 rabbitmq-server<span class="token punctuation">[</span><span class="token number">19770</span><span class="token punctuation">]</span>: Doc guides: https://rabbitmq.com/documentation.html
Nov <span class="token number">23</span> <span class="token number">10</span>:35:46 hy-mq-0002 rabbitmq-server<span class="token punctuation">[</span><span class="token number">19770</span><span class="token punctuation">]</span>: Support:    https://rabbitmq.com/contact.html
Nov <span class="token number">23</span> <span class="token number">10</span>:35:46 hy-mq-0002 rabbitmq-server<span class="token punctuation">[</span><span class="token number">19770</span><span class="token punctuation">]</span>: Tutorials:  https://rabbitmq.com/getstarted.html
Nov <span class="token number">23</span> <span class="token number">10</span>:35:46 hy-mq-0002 rabbitmq-server<span class="token punctuation">[</span><span class="token number">19770</span><span class="token punctuation">]</span>: Monitoring: https://rabbitmq.com/monitoring.html
Nov <span class="token number">23</span> <span class="token number">10</span>:35:46 hy-mq-0002 rabbitmq-server<span class="token punctuation">[</span><span class="token number">19770</span><span class="token punctuation">]</span>: Logs: /var/log/rabbitmq/rabbit@hy-mq-0002.log
Nov <span class="token number">23</span> <span class="token number">10</span>:35:46 hy-mq-0002 rabbitmq-server<span class="token punctuation">[</span><span class="token number">19770</span><span class="token punctuation">]</span>: /var/log/rabbitmq/rabbit@hy-mq-0002_upgrade.log
Nov <span class="token number">23</span> <span class="token number">10</span>:35:46 hy-mq-0002 rabbitmq-server<span class="token punctuation">[</span><span class="token number">19770</span><span class="token punctuation">]</span>: Config file<span class="token punctuation">(</span>s<span class="token punctuation">)</span>: <span class="token punctuation">(</span>none<span class="token punctuation">)</span>
Nov <span class="token number">23</span> <span class="token number">10</span>:35:47 hy-mq-0002 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started RabbitMQ broker.
Nov <span class="token number">23</span> <span class="token number">10</span>:35:47 hy-mq-0002 rabbitmq-server<span class="token punctuation">[</span><span class="token number">19770</span><span class="token punctuation">]</span>: Starting broker<span class="token punctuation">..</span>. completed with <span class="token number">0</span> plugins.
<span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable rabbitmq-server</span>
Created symlink from /etc/systemd/system/multi-user.target.wants/rabbitmq-server.service to /usr/lib/systemd/system/rabbitmq-server.service.
</code></pre> 
<p>先停止运行节点，然后以后台方式启动 RabbitMQ Server（<code>mq-0001</code>和<code>mq-0002</code>分别执行）：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl stop</span>
Stopping and halting <span class="token function">node</span> rabbit@hy-mq-0001 <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># rabbitmq-server -detached</span>

<span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl stop</span>
Stopping and halting <span class="token function">node</span> rabbit@hy-mq-0002 <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment"># rabbitmq-server -detached</span>
<span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<p>我们以<code>mq-0001</code>作为集群中心，在<code>mq-0002</code>上执行加入集群中心命令（节点类型为磁盘节点）：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment">#  rabbitmqctl stop_app</span>
Stopping rabbit application on <span class="token function">node</span> rabbit@hy-mq-0002 <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl reset </span>
Resetting <span class="token function">node</span> rabbit@hy-mq-0002 <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl join_cluster rabbit@hy-mq-0001</span>
Clustering <span class="token function">node</span> rabbit@hy-mq-0002 with rabbit@hy-mq-0001

<span class="token comment">#默认是磁盘节点，如果是内存节点的话，需要加--ram参数</span>

<span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment">#  rabbitmqctl start_app</span>
Starting <span class="token function">node</span> rabbit@hy-mq-0002 <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<p>查看集群的状态（包含<code>mq-0001</code>和<code>mq-0002</code>节点）：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl cluster_status</span>
Cluster status of <span class="token function">node</span> rabbit@hy-mq-0002 <span class="token punctuation">..</span>.
Basics

Cluster name: rabbit@hy-mq-0001

Disk Nodes

rabbit@hy-mq-0001
rabbit@hy-mq-0002

Running Nodes

rabbit@hy-mq-0001
rabbit@hy-mq-0002

Versions

rabbit@hy-mq-0001: RabbitMQ <span class="token number">3.8</span>.5 on Erlang <span class="token number">23.2</span>.7
rabbit@hy-mq-0002: RabbitMQ <span class="token number">3.8</span>.5 on Erlang <span class="token number">23.2</span>.7

Alarms

<span class="token punctuation">(</span>none<span class="token punctuation">)</span>

Network Partitions

<span class="token punctuation">(</span>none<span class="token punctuation">)</span>

Listeners

Node: rabbit@hy-mq-0001, interface: <span class="token punctuation">[</span>::<span class="token punctuation">]</span>, port: <span class="token number">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@hy-mq-0001, interface: <span class="token punctuation">[</span>::<span class="token punctuation">]</span>, port: <span class="token number">5672</span>, protocol: amqp, purpose: AMQP <span class="token number">0</span>-9-1 and AMQP <span class="token number">1.0</span>
Node: rabbit@hy-mq-0001, interface: <span class="token punctuation">[</span>::<span class="token punctuation">]</span>, port: <span class="token number">15672</span>, protocol: http, purpose: HTTP API
Node: rabbit@hy-mq-0002, interface: <span class="token punctuation">[</span>::<span class="token punctuation">]</span>, port: <span class="token number">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@hy-mq-0002, interface: <span class="token punctuation">[</span>::<span class="token punctuation">]</span>, port: <span class="token number">5672</span>, protocol: amqp, purpose: AMQP <span class="token number">0</span>-9-1 and AMQP <span class="token number">1.0</span>

Feature flags

Flag: drop_unroutable_metric, state: enabled
Flag: empty_basic_get_metric, state: enabled
Flag: implicit_default_bindings, state: enabled
Flag: quorum_queue, state: enabled
Flag: virtual_host_metadata, state: enabled
<span class="token punctuation">[</span>root@hy-mq-0002 ~<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<p>我们可以从 RabbitMQ Web 管理界面，看到集群的信息：</p> 
<p><img src="https://images2.imgbox.com/aa/a8/pwcrL1q1_o.png" alt="1700707252196.png"></p> 
<p>这里mq-0002上面少个插件，安装即可。</p> 
<pre><code>[root@hy-mq-0002 ~]# rabbitmq-plugins enable rabbitmq_management
Enabling plugins on node rabbit@hy-mq-0002:
rabbitmq_management
The following plugins have been configured:
  rabbitmq_management
  rabbitmq_management_agent
  rabbitmq_web_dispatch
Applying plugin configuration to rabbit@hy-mq-0002...
The following plugins have been enabled:
  rabbitmq_management
  rabbitmq_management_agent
  rabbitmq_web_dispatch

started 3 plugins.
</code></pre> 
<p><img src="https://images2.imgbox.com/e6/ed/7wUqyWvx_o.png" alt="1700707358843.png"><br> 此刻已完成搭建。</p> 
<h4><a id="9_HAproxy_511"></a>9 搭建HAproxy负载均衡（可选）</h4> 
<p>HAProxy 是一个免费的负载均衡软件，可以运行于大部分主流的 Linux 操作系统上。</p> 
<p>但如果在公有云上，可以有相关的LB供选择，有的服务商还不支持在云上负载，请注意！</p> 
<p>HAProxy 提供了 L4(TCP) 和 L7(HTTP) 两种负载均衡能力，具备丰富的功能。HAProxy 的社区非常活跃，版本更新快速（最新稳定版 1.7.2 于 2017/01/13 推出）。最关键的是，HAProxy 具备媲美商用负载均衡器的性能和稳定性。它当前不仅仅是免费负载均衡软件的首选，更几乎成为了唯一选择。</p> 
<p>因为 RabbitMQ 本身不提供负载均衡，下面我们就搭建 HAProxy，用作 RabbitMQ 集群的负载均衡。</p> 
<p>HAproxy在mq-0001默认安装，版本有点，可以配置eprl源，或者自己二进制安装。</p> 
<pre><code>[root@hy-mq-0001 ~]# yum install haproxy
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package haproxy.x86_64 0:1.5.18-9.el7_9.1 will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

==========================================================================================================================================================================
 Package                               Arch                                 Version                                           Repository                             Size
==========================================================================================================================================================================
Installing:
 haproxy                               x86_64                               1.5.18-9.el7_9.1                                  updates                               835 k

Transaction Summary
==========================================================================================================================================================================
Install  1 Package

Total download size: 835 k
Installed size: 2.6 M
Is this ok [y/d/N]: y
Downloading packages:
haproxy-1.5.18-9.el7_9.1.x86_64.rpm                                                                                                                | 835 kB  00:00:00     
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : haproxy-1.5.18-9.el7_9.1.x86_64                                                                                                                        1/1 
  Verifying  : haproxy-1.5.18-9.el7_9.1.x86_64                                                                                                                        1/1 

Installed:
  haproxy.x86_64 0:1.5.18-9.el7_9.1                                                                                                                                       

Complete!
[root@hy-mq-0001 ~]#
</code></pre> 
<p>配置HAproxy</p> 
<pre><code class="prism language-shell">
<span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment">#  cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</span>
<span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment">#  vi /etc/haproxy/haproxy.cfg</span>
<span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/haproxy/haproxy.cfg</span>
<span class="token comment">#---------------------------------------------------------------------</span>
<span class="token comment"># Example configuration for a possible web application.  See the</span>
<span class="token comment"># full configuration options online.</span>
<span class="token comment">#</span>
<span class="token comment">#   http://haproxy.1wt.eu/download/1.4/doc/configuration.txt</span>
<span class="token comment">#</span>
<span class="token comment">#---------------------------------------------------------------------</span>

<span class="token comment">#---------------------------------------------------------------------</span>
<span class="token comment"># Global settings</span>
<span class="token comment">#---------------------------------------------------------------------</span>
global
    <span class="token comment"># to have these messages end up in /var/log/haproxy.log you will</span>
    <span class="token comment"># need to:</span>
    <span class="token comment">#</span>
    <span class="token comment"># 1) configure syslog to accept network log events.  This is done</span>
    <span class="token comment">#    by adding the '-r' option to the SYSLOGD_OPTIONS in</span>
    <span class="token comment">#    /etc/sysconfig/syslog</span>
    <span class="token comment">#</span>
    <span class="token comment"># 2) configure local2 events to go to the /var/log/haproxy.log</span>
    <span class="token comment">#   file. A line like the following can be added to</span>
    <span class="token comment">#   /etc/sysconfig/syslog</span>
    <span class="token comment">#</span>
    <span class="token comment">#    local2.*                       /var/log/haproxy.log</span>
    <span class="token comment">#</span>
    log         <span class="token number">127.0</span>.0.1 local2

    <span class="token function">chroot</span>      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     <span class="token number">4000</span>
    user        haproxy
    group       haproxy
    daemon

    <span class="token comment"># turn on stats unix socket</span>
    stats socket /var/lib/haproxy/stats

<span class="token comment">#---------------------------------------------------------------------</span>
<span class="token comment"># common defaults that all the 'listen' and 'backend' sections will</span>
<span class="token comment"># use if not designated in their block</span>
<span class="token comment">#---------------------------------------------------------------------</span>
defaults
    <span class="token comment">#mode                    http</span>
    log                     global
   <span class="token comment"># option                  httplog</span>
    mode    tcp
    option  tcplog
    option                  dontlognull
    option http-server-close
   <span class="token comment"># option forwardfor       except 127.0.0.0/8</span>
    option                  redispatch
    retries                 <span class="token number">3</span>
    <span class="token function">timeout</span> http-request    10s
    <span class="token function">timeout</span> queue           1m
    <span class="token function">timeout</span> connect         10s
    <span class="token function">timeout</span> client          1m
    <span class="token function">timeout</span> server          1m
    <span class="token function">timeout</span> http-keep-alive 10s
    <span class="token function">timeout</span> check           10s
    maxconn                 <span class="token number">3000</span>

listen rabbitmq_admin
    <span class="token builtin class-name">bind</span>    <span class="token number">0.0</span>.0.0:8102
    server   hy-mq-0001 <span class="token number">172.16</span>.1.244:15672
    server   hy-mq-0002 <span class="token number">172.16</span>.1.8:15672


listen rabbitmq_cluster
    <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:5679
    mode tcp
    balance roundrobin
    server hy-mq-0001 <span class="token number">172.16</span>.1.244:5672 check inter <span class="token number">5000</span> rise <span class="token number">2</span> fall <span class="token number">3</span> weight <span class="token number">1</span>
    server hy-mq-0002 <span class="token number">172.16</span>.1.86:5672  check inter <span class="token number">5000</span> rise <span class="token number">2</span> fall <span class="token number">3</span> weight <span class="token number">1</span>

listen monitor
        <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:8100
        mode http
        option httplog
        stats <span class="token builtin class-name">enable</span>
        stats uri /stats
        stats refresh 5s



<span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start haproxy</span>
<span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable haproxy</span>
Created symlink from /etc/systemd/system/multi-user.target.wants/haproxy.service to /usr/lib/systemd/system/haproxy.service.
<span class="token punctuation">[</span>root@hy-mq-0001 ~<span class="token punctuation">]</span><span class="token comment"># systemctl status haproxy</span>
● haproxy.service - HAProxy Load Balancer
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/haproxy.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Thu <span class="token number">2023</span>-11-23 <span class="token number">12</span>:28:11 CST<span class="token punctuation">;</span> 5min ago
 Main PID: <span class="token number">25890</span> <span class="token punctuation">(</span>haproxy-systemd<span class="token punctuation">)</span>
   CGroup: /system.slice/haproxy.service
           ├─25890 /usr/sbin/haproxy-systemd-wrapper <span class="token parameter variable">-f</span> /etc/haproxy/haproxy.cfg <span class="token parameter variable">-p</span> /run/haproxy.pid
           ├─25891 /usr/sbin/haproxy <span class="token parameter variable">-f</span> /etc/haproxy/haproxy.cfg <span class="token parameter variable">-p</span> /run/haproxy.pid <span class="token parameter variable">-Ds</span>
           └─25892 /usr/sbin/haproxy <span class="token parameter variable">-f</span> /etc/haproxy/haproxy.cfg <span class="token parameter variable">-p</span> /run/haproxy.pid <span class="token parameter variable">-Ds</span>

Nov <span class="token number">23</span> <span class="token number">12</span>:28:11 hy-mq-0001 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started HAProxy Load Balancer.
Nov <span class="token number">23</span> <span class="token number">12</span>:28:11 hy-mq-0001 haproxy-systemd-wrapper<span class="token punctuation">[</span><span class="token number">25890</span><span class="token punctuation">]</span>: haproxy-systemd-wrapper: executing /usr/sbin/haproxy <span class="token parameter variable">-f</span> /etc/haproxy/haproxy.cfg <span class="token parameter variable">-p</span> /run/haproxy.pid <span class="token parameter variable">-Ds</span>
</code></pre> 
<p>注意：</p> 
<p>在公有云上，要记得配置安全组，放通相应的端口。</p> 
<p>通过访问<code>http://mq-0001:8100/stats</code>，查看 HAProxy 负载均衡信息：<br> <img src="https://images2.imgbox.com/63/b2/fADfjWuw_o.png" alt="1700714170572.png"></p> 
<h4><a id="10_RabbmitMQ_678"></a>10 RabbmitMQ搭建踩坑</h4> 
<p>1.当从mq-0001上面拷贝.erlang.cookie文件到mq-0002时，没有修改对应的文件。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0002 rabbitmq<span class="token punctuation">]</span><span class="token comment"># ll .erlang.cookie </span>
-r-------- <span class="token number">1</span> root root <span class="token number">20</span> Nov <span class="token number">23</span> <span class="token number">10</span>:28 .erlang.cookie
<span class="token punctuation">[</span>root@hy-mq-0002 rabbitmq<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<p>集群会错误<br> <img src="https://images2.imgbox.com/25/d4/hVBiF78M_o.png" alt="1700714490036.png"></p> 
<p>当然只是加入集群之后的错误，还有一种另外的显示。</p> 
<p>2.还有一个缺少配置文件/etc/rabbitmq/rabbitmq-env.conf</p> 
<p>目前的实验环境是没有的，需要自己创建，并添加。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@hy-mq-0002 rabbitmq<span class="token punctuation">]</span><span class="token comment"># cat rabbitmq-env.conf </span>
<span class="token assign-left variable">RABBITMQ_NAME</span><span class="token operator">=</span>rabbit@hy-mq-0002
</code></pre> 
<p>这个报错也非常的经典，就是缺少这个配置文件，前提确保你前面的环境没有问题。<br> <img src="https://images2.imgbox.com/e2/d6/sUc9XuP0_o.png" alt="1700715121438.png"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/69129624b939bb36ceeb30b4caa859cf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">一篇搞定Java注解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3ed8d8e958dbdd06f44082efd13045c4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">nginx梳理脚本</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>