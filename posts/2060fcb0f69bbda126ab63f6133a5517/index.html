<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Flink】DataStream API使用之转换算子（Transformation） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Flink】DataStream API使用之转换算子（Transformation）" />
<meta property="og:description" content="转换算子（Transformation） 数据源读入数据之后，就是各种转换算子的操作，将一个或者多个DataSream转换为新的DataSteam，并且Flink可以针对一条流进行转换处理，也可以进行分流或者河流等多流转换操作，从而组成复杂的数据流拓扑。
1. 基本转换算子 这里介绍的都是最基本的转换算子，在官方文档会有更多的算子介绍
1.1 Map(映射) -------内容描述：在 DataStream 上应用映射转换。转换为DataStream的每个元素调用一个 MapFunction。每个 MapFunction 调用只返回一个元素。用户还可以扩展 RichMapFunction 以访问org.apache.flink.api.common.functions.RichFunction 接口提供的其他功能。参数：DataStream 的每个元素调用的 MapFunction。返回值：SingleOutputStreamOperator转换后的数据流总结：数据转换，一一映射 图示：
源码：
public &lt;R&gt; SingleOutputStreamOperator&lt;R&gt; map(MapFunction&lt;T, R&gt; mapper) { TypeInformation&lt;R&gt; outType = TypeExtractor.getMapReturnTypes( clean(mapper), getType(), Utils.getCallLocationName(), true); return map(mapper, outType); } public &lt;R&gt; SingleOutputStreamOperator&lt;R&gt; map( MapFunction&lt;T, R&gt; mapper, TypeInformation&lt;R&gt; outputType) { return transform(&#34;Map&#34;, outputType, new StreamMap&lt;&gt;(clean(mapper))); } 可以看到参数是一个MapFunction，然后通过实现的map方法去一一返回对应的元素。
实例：
public static void main(String[] args) throws Exception { // 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境 StreamExecutionEnvironment env = StreamExecutionEnvironment." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2060fcb0f69bbda126ab63f6133a5517/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-26T23:53:56+08:00" />
<meta property="article:modified_time" content="2023-06-26T23:53:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Flink】DataStream API使用之转换算子（Transformation）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Transformation_0"></a>转换算子（Transformation）</h2> 
<p><img src="https://images2.imgbox.com/42/b1/eFIf9Mcl_o.png" alt="在这里插入图片描述"><br> 数据源读入数据之后，就是各种转换算子的操作，将一个或者多个DataSream转换为新的DataSteam，并且Flink可以针对一条流进行转换处理，也可以进行分流或者河流等多流转换操作，从而组成复杂的数据流拓扑。</p> 
<h3><a id="1__4"></a>1. 基本转换算子</h3> 
<p>这里介绍的都是最基本的转换算子，在官方文档会有更多的算子介绍</p> 
<h4><a id="11_Map_6"></a>1.1 Map(映射)</h4> 
<table><thead><tr><th align="center">-------</th><th align="left">内容</th></tr></thead><tbody><tr><td align="center">描述：</td><td align="left">在 <code>DataStream</code> 上应用映射转换。转换为<code>DataStream</code>的每个元素调用一个<code> MapFunction</code>。每个 <code>MapFunction</code> 调用只返回一个元素。用户还可以扩展 <code>RichMapFunction</code> 以访问<code>org.apache.flink.api.common.functions.RichFunction </code>接口提供的其他功能。</td></tr><tr><td align="center">参数：</td><td align="left"><code>DataStream</code> 的每个元素调用的<code> MapFunction</code>。</td></tr><tr><td align="center">返回值：</td><td align="left"><code>SingleOutputStreamOperator</code>转换后的数据流</td></tr><tr><td align="center">总结：</td><td align="left">数据转换，一一映射</td></tr></tbody></table> 
<p>图示：<br> <img src="https://images2.imgbox.com/c2/d7/9jIFPuoV_o.png" alt="在这里插入图片描述"><br> 源码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> mapper<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> outType <span class="token operator">=</span>
                <span class="token class-name">TypeExtractor</span><span class="token punctuation">.</span><span class="token function">getMapReturnTypes</span><span class="token punctuation">(</span>
                        <span class="token function">clean</span><span class="token punctuation">(</span>mapper<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">getCallLocationName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">map</span><span class="token punctuation">(</span>mapper<span class="token punctuation">,</span> outType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span>
            <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> mapper<span class="token punctuation">,</span> <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> outputType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token string">"Map"</span><span class="token punctuation">,</span> outputType<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StreamMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token function">clean</span><span class="token punctuation">(</span>mapper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>可以看到参数是一个<code>MapFunction</code>，然后通过实现的map方法去一一返回对应的元素。</p> 
<p>实例：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 从集合中读取数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">BasicTypeInfo</span><span class="token punctuation">.</span>STRING_TYPE_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. map操作</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mapStreamOperator <span class="token operator">=</span> stringDataStreamSource<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>string <span class="token operator">-&gt;</span> string <span class="token operator">+</span> <span class="token string">" yes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mapStreamOperator<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里的<code>public class SingleOutputStreamOperator&lt;T&gt; extends DataStream&lt;T&gt; {}</code> 可以看出map 是将一个 DataStream 转换成另一个 DataStream 是完全正确的。</p> 
<h4><a id="12_filter_54"></a>1.2 filter(过滤)</h4> 
<table><thead><tr><th align="center">-------</th><th align="left">内容</th></tr></thead><tbody><tr><td align="center">描述：</td><td align="left">对 <code>DataStream</code> 应用过滤器转换。转换为 <code>DataStream</code> 的每个元素调用 <code>FilterFunction</code>，并仅保留函数返回 <code>true </code>的那些元素。过滤函数返回 <code>false</code> 的元素。用户还可以扩展 <code>RichFilterFunction</code> 以访问 <code>org.apache.flink.api.common.functions.RichFunction</code> 接口提供的其他功能。</td></tr><tr><td align="center">参数：</td><td align="left">为<code> DataStream</code> 的每个元素调用的<code> FilterFunction</code></td></tr><tr><td align="center">返回值：</td><td align="left"><code>SingleOutputStreamOperator</code>转换后的数据流</td></tr><tr><td align="center">总结：</td><td align="left">筛选数据</td></tr></tbody></table> 
<p>图示：<br> <img src="https://images2.imgbox.com/91/43/sMNnhKHg_o.png" alt="在这里插入图片描述"><br> 源码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">FilterFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> filter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token string">"Filter"</span><span class="token punctuation">,</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StreamFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token function">clean</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里的参数是一个<code>FilterFunction</code>，然后通过实现的<code>filter</code>方法判断是否返回改元素。</p> 
<p>实例：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 从集合中读取数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">BasicTypeInfo</span><span class="token punctuation">.</span>STRING_TYPE_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. filter操作</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> filterStreamOperator <span class="token operator">=</span> stringDataStreamSource<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>string <span class="token operator">-&gt;</span> string<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"o"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filterStreamOperator<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>进行 filter 转换之后的新数据流的数据类型与原数据流是相同的。</p> 
<h4><a id="13_FlatMap_94"></a>1.3 FlatMap(扁平映射)</h4> 
<table><thead><tr><th align="center">-------</th><th align="left">内容</th></tr></thead><tbody><tr><td align="center">描述：</td><td align="left">在 <code>DataStream</code> 上应用 `FlatMap 转换。转换为 DataStream 的每个元素调用 FlatMapFunction。每个 FlatMapFunction 调用都可以返回任意数量的元素，包括无元素。用户还可以扩展 RichFlatMapFunction 以访问 org.apache.flink.api.common.functions.RichFunction 接口提供的其他功能。</td></tr><tr><td align="center">参数：</td><td align="left">为 <code>DataStream</code> 的每个元素调用的 <code>FlatMapFunction</code></td></tr><tr><td align="center">返回值：</td><td align="left"><code>SingleOutputStreamOperator</code>转换后的数据流</td></tr><tr><td align="center">总结：</td><td align="left">是将数据流中的整体（一般是集合类型）拆分成一个一个的个体使用。消费一个元素，可以产生 0 到多个元素</td></tr></tbody></table> 
<p>图示：<br> <img src="https://images2.imgbox.com/3a/05/Zb5SI4jl_o.png" alt="在这里插入图片描述"></p> 
<p>源码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">FlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> flatMapper<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> outType <span class="token operator">=</span>
            <span class="token class-name">TypeExtractor</span><span class="token punctuation">.</span><span class="token function">getFlatMapReturnTypes</span><span class="token punctuation">(</span>
                    <span class="token function">clean</span><span class="token punctuation">(</span>flatMapper<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">getCallLocationName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">flatMap</span><span class="token punctuation">(</span>flatMapper<span class="token punctuation">,</span> outType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">flatMap</span><span class="token punctuation">(</span>
        <span class="token class-name">FlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> flatMapper<span class="token punctuation">,</span> <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> outputType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token string">"Flat Map"</span><span class="token punctuation">,</span> outputType<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StreamFlatMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token function">clean</span><span class="token punctuation">(</span>flatMapper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里的参数是一个<code>FlatMapFunction</code>，然后通过实现的<code>flatMap</code>方法来处理返回 0 个、1 个或多个结果数据。因此 flatMap 并没有直接定义返回值类型，而是通过一个“收集器”（Collector）来指定输出。希望输出结果时，只要调用收集器的.collect()方法就可以了；这个方法可以多次调用，也可以不调用。</p> 
<p>实例：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 从集合中读取数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"one,yes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"two,no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">BasicTypeInfo</span><span class="token punctuation">.</span>STRING_TYPE_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. flatMap操作</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flatMapStreamOperator <span class="token operator">=</span> stringDataStreamSource<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">FlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> collector<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> str <span class="token operator">:</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>s <span class="token operator">+</span> <span class="token string">", go"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span><span class="token class-name">BasicTypeInfo</span><span class="token punctuation">.</span>STRING_TYPE_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里的returns要指定返回类型 因为类型擦出不知道Collector返回的泛型是什么类型</span>
        flatMapStreamOperator<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>要注意要指定返回类型<code>.returns(BasicTypeInfo.STRING_TYPE_INFO);</code></p> 
<h3><a id="2Aggregation_154"></a>2.聚合算子（Aggregation）</h3> 
<p>基本转换算子确实是在“转换”——因为它们都是基于当前数据，去做了处理和输出。而在实际应用中，我们往往需要对大量的数据进行统计或整合，从而提炼出更有用的信息。比如之前 word count 程序中，要对每个词出现的频次进行叠加统计。这种操作，计算的结果不仅依赖当前数据，还跟之前的数据有关，相当于要把所有数据聚在一起进行汇总合并——这就是所谓的“聚合”（Aggregation），也对应着 MapReduce 中的 reduce 操作。</p> 
<h4><a id="21_KeyBy_157"></a>2.1 KeyBy(按键分区)</h4> 
<p>对于Flink而言，DataStream是没有直接进行聚合的API的，因此对海量数据处理做聚合一定要先做分区处理，这样才能提高效率。而分区就是通过<code>KeyBy</code>来完成的。</p> 
<table><thead><tr><th align="center">标题</th><th align="left">内容</th></tr></thead><tbody><tr><td align="center">描述：</td><td align="left">它创建一个新的 <code>KeyedStream</code>，它使用提供的<code>Key</code>来划分其操作员状态。</td></tr><tr><td align="center">参数：</td><td align="left">用于提取分区键的 <code>KeySelector</code></td></tr><tr><td align="center">返回值：</td><td align="left">具有分区状态的 <code>DataStream</code>（即 <code>KeyedStream</code>）</td></tr><tr><td align="center">总结：</td><td align="left">根据<code>Key</code>的<code>hashCode</code>方法进行分区</td></tr><tr><td align="center">注意：</td><td align="left">以下情况，一个类不能作为 key：1.它是一种 POJO 类，但没有重写 hashCode() 方法而是依赖于Object.hashCode() 实现。2.它是任意类的数组。</td></tr></tbody></table> 
<p>图示：<br> <img src="https://images2.imgbox.com/76/77/eKIYu2Wc_o.png" alt="在这里插入图片描述"><br> 基于不同的 <code>key</code>，流中的数据将被分配到不同的分区中去，如图 5-8 所示；这样一来，所<br> 有具有相同的 <code>key</code> 的数据，都将被发往同一个分区，那么下一步算子操作就将会在同一个 <code>slot</code><br> 中进行处理了。在内部，是通过计算<code>key</code>的哈希值（hash code），对分区数进行取模运算来实现的。所以这里<code> key</code> 如果是 <code>POJO</code> 的话，必须要重写<code> hashCode()</code>方法。</p> 
<p>源码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> <span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">KeySelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">clean</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> <span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">KeySelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">,</span> <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> keyType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>keyType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">clean</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> keyType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里的参数是一个<code>KeySelector</code>，然后通过实现的<code>getKey</code>方法返回指定的<code>Key</code>值来分区。需要注意的是<code>KeyBy</code>的结果不在是<code>DataStream</code>，而是将<code>DataStream</code> 转换为<code>KeyedStream</code>。<code>KeyedStream</code> 可以认为是<code>“分区流”</code>或者<code>“键控流”</code>，它是对 <code>DataStream </code>按照<code>key</code> 的一个逻辑分区，所以泛型有两个类型：除去当前流中的元素类型外，还需要指定<code>key</code>的类型。</p> 
<p>实例：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 从集合中读取数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu1.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu2.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu5.com"</span><span class="token punctuation">,</span><span class="token number">1267L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"gala"</span><span class="token punctuation">,</span><span class="token string">"www.baidu6.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu7.com"</span><span class="token punctuation">,</span><span class="token number">4200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">5500L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> eventDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">BasicTypeInfo</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. keyBy操作</span>
        <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyedStream <span class="token operator">=</span> eventDataStreamSource<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> event<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        keyedStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><code>KeyedStream</code> 也继承自 <code>DataStream</code>，所以基于它的操作也都归属于 <code>DataStream API</code>。但它跟之前的转换操作得到的<code>SingleOutputStreamOperator</code>不同，只是一个流的分区操作，并不是一个转换算子。<code>KeyedStream</code> 是一个非常重要的数据结构，只有基于它才可以做后续的聚合操作（比如<code> sum</code>，<code>reduce</code>）；而且它可以将当前算子任务的状态（<code>state</code>）也按照 <code>key </code>进行划分、限定为仅对当前<code>key</code>有效。</p> 
<h4><a id="22__215"></a>2.2 简单聚合操作</h4> 
<p><code>KeyedStream</code>提供了很多种简单的聚合操作，比如求和，求最大值等，主要有以下几种：</p> 
<table><thead><tr><th align="center">聚合操作名称</th><th align="left">简介</th></tr></thead><tbody><tr><td align="center"><code>sum() </code></td><td align="left">在输入流上，对指定的字段做叠加求和的操作。</td></tr><tr><td align="center"><code>min()</code></td><td align="left">在输入流上，对指定的字段求最小值。</td></tr><tr><td align="center"><code>max()</code></td><td align="left">在输入流上，对指定的字段求最大值。</td></tr><tr><td align="center"><code>minBy()</code></td><td align="left">与 <code>min()</code>类似，在输入流上针对指定字段求最小值。不同的是，<code>min()</code>只计算指定字段的最小值，其他字段会保留最初第一个数据的值；而 <code>minBy()</code>则会返回包含字段最小值的整条数据。</td></tr><tr><td align="center"><code>maxBy()</code></td><td align="left">与 <code>max()</code>类似，在输入流上针对指定字段求最大值。两者区别与<code>min()</code>/<code>minBy()</code>完全一致。</td></tr></tbody></table> 
<p>这些简单聚合函数的参数很简单，不需要自定义函数，只需要说明聚合指定的字段就可以，指定字段的方式有两种，<code>指定位置</code>和<code>指定名称</code></p> 
<p>对于元祖类型，如果指定字段名，需要这样写字段名<code>f0，f1</code>，类似于这种<code>stream.keyBy(r -&gt; r.f0).max("f1").print();</code></p> 
<p>对于POJO类，只能通过通过字段名称来指定，不能通过位置来指定，类似这种<code>stream.keyBy(e -&gt; e.user).max("timestamp")</code></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">maxBy</span><span class="token punctuation">(</span><span class="token class-name">String</span> positionToMaxBy<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">maxBy</span><span class="token punctuation">(</span>positionToMaxBy<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
<span class="token keyword">public</span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">maxBy</span><span class="token punctuation">(</span><span class="token keyword">int</span> positionToMaxBy<span class="token punctuation">,</span> <span class="token keyword">boolean</span> first<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">aggregate</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">ComparableAggregator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                        positionToMaxBy<span class="token punctuation">,</span>
                        <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">AggregationFunction<span class="token punctuation">.</span>AggregationType</span><span class="token punctuation">.</span>MAXBY<span class="token punctuation">,</span>
                        first<span class="token punctuation">,</span>
                        <span class="token function">getExecutionConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>简单聚合算子返回的是<code>SingleOutputStreamOperator</code>，从<code>KeyStream</code>又转换成了常规的<code>DataStream</code>，所以可以理解为<code>KeyBy</code>和聚合是成对出现的，先分区后聚合，得到的依然是一个<code>DataStream</code>。经过简单聚合之后的数据流，元素的类型是保持不变的。</p> 
<p>一个聚合算子，会为每一个<code>Key</code>保存一个聚合的值，在Flink中这称为<code>状态(state)</code>，每当有一个新的数据输入，算子就会更新保存聚合结果，并发送一个更新后的聚合值的事件到下游算子。</p> 
<p>对于无界流来说，这个状态是永远不会被清除的，所以使用聚合算子应该只用在有限个Key的数据流上。</p> 
<p>实例：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 从集合中读取数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu1.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu2.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu5.com"</span><span class="token punctuation">,</span><span class="token number">1267L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"gala"</span><span class="token punctuation">,</span><span class="token string">"www.baidu6.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu7.com"</span><span class="token punctuation">,</span><span class="token number">4200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">5500L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> eventDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">BasicTypeInfo</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. keyBy操作</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> timestamp1 <span class="token operator">=</span> eventDataStreamSource<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> event<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> timestamp2 <span class="token operator">=</span> eventDataStreamSource<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> event<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">maxBy</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里的returns要指定返回类型 因为类型擦出不知道Collector返回的泛型是什么类型</span>
        timestamp1<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"max:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        timestamp2<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"maxBy:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>注意这里的Max和MaxBy Max只返回指定的字段取最大值，MaxBy返回指定字段的最大的整条记录。</p> 
<h4><a id="23_Reduce_281"></a>2.3 Reduce(归约聚合)</h4> 
<p>简单聚合是对一些特定需求的实现，呢么<code>reduce</code>算子就是一个一般化的聚合统计操作，<code>reduce</code>是对已有的数据进行归约处理，把每一个新输入的数据和当前已经归约出来的值再做一个聚合计算</p> 
<p>与简单聚合类似，<code>reduce</code>也是将<code>KeyStream</code>转换为<code>DataStream</code>，不会改变流的元素数据，所以输入输出都是一样的</p> 
<table><thead><tr><th align="center">标题</th><th align="left">内容</th></tr></thead><tbody><tr><td align="center">描述：</td><td align="left">对按给定键位置分组的分组数据流应用减少转换。 <code>ReduceFunction</code> 将根据键值接收输入值。只有具有相同键的输入值才会进入相同的 <code>reducer</code>。</td></tr><tr><td align="center">参数：</td><td align="left">将为具有相同键的输入值的每个元素调用的 <code>ReduceFunction</code>。</td></tr><tr><td align="center">返回值：</td><td align="left">转换后的数据流</td></tr><tr><td align="center">总结：</td><td align="left">对已有数据进行归约处理，把每一个新输入的数据和当前已经归约的值在做一次聚合运算</td></tr></tbody></table> 
<p>与简单聚合类似，<code>reduce</code>操作也是将<code>KeyedStream</code>转换为<code>DataStream</code>，<code>reduce</code>不会改变流的元素数据类型，所以输出类型和输入类型是一样的。</p> 
<p><code>源码</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">ReduceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> reducer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ReduceTransformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> KEY<span class="token punctuation">&gt;</span></span> reduce <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">ReduceTransformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                        <span class="token string">"Keyed Reduce"</span><span class="token punctuation">,</span>
                        environment<span class="token punctuation">.</span><span class="token function">getParallelism</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        transformation<span class="token punctuation">,</span>
                        <span class="token function">clean</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        keySelector<span class="token punctuation">,</span>
                        <span class="token function">getKeyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addOperator</span><span class="token punctuation">(</span>reduce<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reduce<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>调用<code>KeyedStream</code>的<code>reduce</code>方法时，需要传入一个参数，实现<code>ReduceFunction</code>接口的<code>reduce</code>方法，接口源码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token annotation punctuation">@Public</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ReduceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Function</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">T</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">T</span> var1<span class="token punctuation">,</span> <span class="token class-name">T</span> var2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>处理过程类似下图，这个方法接收两个参数，经过转换处理之后输出同一个相同类型的事件；所以，对于一组数据，我们可以先取两个进行合并，然后在将合并的结果看做一个数据，在跟后面的数据合并，最终简化成唯一的一个数据。</p> 
<p><code>ReduceFunction</code>内部会维护一个初始值为空的累加器，累加器的类型和输入数据的类型一致，当第一条数据到来时，累加器更新为第一条数据的值，当新数据到来时，新元素就和累加器进行累加操作，然后将更新后的累加器的值向下游输出。<br> <img src="https://images2.imgbox.com/60/bb/LHnXVuva_o.png" alt="在这里插入图片描述"><br> <code>实例</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 从集合中读取数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu1.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu2.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu5.com"</span><span class="token punctuation">,</span><span class="token number">1267L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"gala"</span><span class="token punctuation">,</span><span class="token string">"www.baidu6.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu7.com"</span><span class="token punctuation">,</span><span class="token number">4200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">5500L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> eventDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">BasicTypeInfo</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 统计访问频率</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> clickDataStreamSource <span class="token operator">=</span> eventDataStreamSource<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>user<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> data<span class="token punctuation">.</span>f0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReduceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> t1<span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> t2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span>f0<span class="token punctuation">,</span> t1<span class="token punctuation">.</span>f1 <span class="token operator">+</span> t2<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 找到最大的频率</span>

        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> maxClickStreamSource <span class="token operator">=</span> clickDataStreamSource<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReduceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> t1<span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> t2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> t1<span class="token punctuation">.</span>f1 <span class="token operator">&gt;</span> t2<span class="token punctuation">.</span>f1 <span class="token operator">?</span> t1 <span class="token operator">:</span> t2<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 6. 输出数据</span>
        maxClickStreamSource<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 7. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3_UDF_370"></a>3. 用户自定义函数UDF</h3> 
<p>大多数操作都需要用户自定义 function，至于什么是自定义函数？我们可以通过自定义函数类或者匿名类来实现接口，也可以直接传入 Lambda 表达式。这就是谓的用户自定义函数（user-defined function，UDF）</p> 
<h4><a id="31__Function_Classes_372"></a>3.1 Function Classes（函数类）</h4> 
<p>Flink暴露了所有的UDF函数的接口，具体实现方式为接口或者抽象类，例如 MapFunction、FilterFunction、ReduceFunction 等。<code>所以最简单的方式就是自定义一个函数类，实现对应的接口即可。</code></p> 
<p><code>示例</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">MyMapFunction</span> <span class="token keyword">implements</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"https"</span><span class="token punctuation">)</span> <span class="token operator">?</span> value<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">"_https"</span><span class="token punctuation">)</span> <span class="token operator">:</span> value<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">"_http"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyMapFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>更丰富一点的方式，也可以参加一点构造函数</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">MyMapFunction</span> <span class="token keyword">implements</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> defaultStr<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyMapFunction</span><span class="token punctuation">(</span><span class="token class-name">String</span> defaultStr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultStr <span class="token operator">=</span> defaultStr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>defaultStr<span class="token punctuation">)</span> <span class="token operator">?</span> value<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">"_https"</span><span class="token punctuation">)</span> <span class="token operator">:</span> value<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">"_http"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyMapFunction</span><span class="token punctuation">(</span><span class="token string">"https"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="32_Lambda_395"></a>3.2 Lambda（匿名函数）</h4> 
<p>Java8就已经支持Lambda表达式了，Flink的所有算子都支持Lambda表达式来编码，但是当Lambda表达式使用Java泛型的时候，需要显式声明类型信息。</p> 
<p><code>示例</code>：</p> 
<pre><code class="prism language-java"><span class="token comment">// 匿名类</span>
data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Lambda碰到泛型擦除的时候，需要指定returns</span>
data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> event<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>如果碰到<code>flatmap</code>则必须指定<code>returns</code>，<code>map</code>操作如果是简单类型就可以不用指定，但是碰到复杂数据类型或者POJO就需要指定<code>returns</code></p> 
<h4><a id="33_Rich_Function_Classes_408"></a>3.3 Rich Function Classes（富函数类）</h4> 
<p>富函数类也是DataStreamAPI提供的一个函数类接口，所有的Flink函数类都有Rich版本。例如：RichMapFunction、RichFilterFunction、RichReduceFunction 等。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Public</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">RichMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRichFunction</span> <span class="token keyword">implements</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RichMapFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">OUT</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">IN</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>富函数类会比常规函数类提供更多的功能，</p> 
<ol><li>富函数类可以获取运行环境的上下文getRuntimeContext 和setRuntimeContext。</li><li>富函数类拥有生命周期方法，提供了open、close方法</li></ol> 
<p>对于富函数类有生命周期的概念。典型的生命周期方法有：</p> 
<ol><li>open()方法，是 Rich Function 的初始化方法，也就是会开启一个算子的生命周期。当<br> 一个算子的实际工作方法例如 map()或者 filter()方法被调用之前，open()会首先被调<br> 用。所以像文件 IO 的创建，数据库连接的创建，配置文件的读取等等这样一次性的<br> 工作，都适合在 open()方法中完成。。</li><li>close()方法，是生命周期中的最后一个调用的方法，类似于解构方法。一般用来做一<br> 些清理工作。</li></ol> 
<p>需要注意的是，这里的生命周期方法，对于一个并行子任务来说只会调用一次；而对应的，<br> 实际工作方法，例如 RichMapFunction 中的 map()，在每条数据到来后都会触发一次调用。</p> 
<p><code>示例</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 从集合中读取数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu1.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu2.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu5.com"</span><span class="token punctuation">,</span><span class="token number">1267L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"gala"</span><span class="token punctuation">,</span><span class="token string">"www.baidu6.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu7.com"</span><span class="token punctuation">,</span><span class="token number">4200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">5500L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> eventDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">BasicTypeInfo</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. map操作</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> userSingleOutputStream <span class="token operator">=</span> eventDataStreamSource<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RichMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"这是 open方法, 索引为 "</span> <span class="token operator">+</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndexOfThisSubtask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"的任务开始了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"这是 close, 索引为 "</span> <span class="token operator">+</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndexOfThisSubtask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"的任务结束了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> event<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 打印</span>
        userSingleOutputStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><code>打印结果</code>：</p> 
<pre><code class="prism language-java">这是 <span class="token keyword">open</span>方法<span class="token punctuation">,</span> 索引为 <span class="token number">0</span>的任务开始了
ming
xiaohu
xiaohu
gala
ming
xiaohu
这是 close<span class="token punctuation">,</span> 索引为 <span class="token number">0</span>的任务结束了
</code></pre> 
<h3><a id="4__492"></a>4. 物理分区</h3> 
<p><code>分区</code>操作就是要将数据进行重新分布，传递到不同的流分区去进行下一步处理。</p> 
<p>之前使用的<code>keyBy</code>是一种按照键的哈希值来重新分区的操作，只不过这种分区操作只能保证把数据按<code>Key</code>分开，至于分得均不均匀，每个key的数据具体分到哪一个区，这些都是无从控制的，所以<code>KeyBy</code>是一种<code>逻辑分区</code>操作。</p> 
<p><code>KeyBy</code>是一种<code>软分区</code>，Flink还有一种<code>物理分区</code>，是真正控制分区策略，精准地调整数据，告诉每个数据到底去哪。在Flink任务过程中，当我们设置多个处理任务并设置了不同的并行度，当数据执行的上下游任务并行度发生变化时，系统会自动地将数据均匀的发往下游的所有并行任务，保证各个分区的负载均衡。</p> 
<p>但是有些时候需要我们手动控制数据分区分配策略。比如当数据发生数据倾斜的时候，系统无法调整，就需要我们进行干预重新进行负载均衡，将数据流较为平均的发送到下游任务中去。Flink为提供了多种操作接口帮助我们实现数据流的手动重分区。这种操作叫做<code>物理分区操作</code></p> 
<p>物理分区和<code>keyBy</code>的一大区别在于keyBy得到的是一个<code>KeyedStream</code>，而物理分区结果之后还是<code>DataStream</code>，并且流中元素数据类型保持不变。分区算子并不对数据进行转换处理，只是定义了数据的传输方式。</p> 
<p>常见的物理分区策略有有<code>随机分配（shuffle）</code>、<code>轮询分配（Round-Robin）</code>、<code>重缩放（Rescale）</code>和<code>广播（Broadcast）</code>，</p> 
<h4><a id="41_shuffle_505"></a>4.1 随机分区（shuffle）</h4> 
<table><thead><tr><th align="left">标题</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">简介：</td><td align="left">随机分区就是洗牌，将数据随机地分到下游算子的并行任务中去，随机分区服从均匀分布，会把数据流中的数据随机打乱，均匀地传递到下游任务分区</td></tr><tr><td align="left">特点 ：</td><td align="left">完全随机，均分分布; 经过随机分区之后，得到的依然是一个 DataStream。</td></tr><tr><td align="left">调用方法：</td><td align="left"><code>DataStream.shuffle()</code>方法</td></tr></tbody></table> 
<p><code>图解</code>：<br> <img src="https://images2.imgbox.com/3f/63/6bbQHhzz_o.png" alt="在这里插入图片描述"><br> <code>示例代码</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 从集合中读取数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu1.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu2.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu5.com"</span><span class="token punctuation">,</span><span class="token number">1267L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"gala"</span><span class="token punctuation">,</span><span class="token string">"www.baidu6.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu7.com"</span><span class="token punctuation">,</span><span class="token number">4200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">5500L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu2"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">5500L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu3"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">5500L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> eventDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">BasicTypeInfo</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. map操作</span>
       eventDataStreamSource<span class="token punctuation">.</span><span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"shuffle"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>多执行几次，结果看起来是没有规律的，并且也不是均匀处理相同个数的，其实数据量多起来的话，结果就近似于每个下游算子处理的任务数相同了。</p> 
<h4><a id="42_RoundRobin_541"></a>4.2 轮询分配（Round-Robin）</h4> 
<table><thead><tr><th align="left">标题</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">简介：</td><td align="left">轮询分区是常见的一种重分区方式，可以看做是<code>发牌</code>，按照先后顺序将数据一次分发。</td></tr><tr><td align="left">特点 ：</td><td align="left">按照顺序，均分分布; 经过轮询分区之后，得到的依然是一个 DataStream。</td></tr><tr><td align="left">调用方法：</td><td align="left"><code>DataStream.rebalance()</code>方法 ，rebalance使用的是 <code>Round-Robin</code> 负载均衡算法</td></tr></tbody></table> 
<p>注：Round-Robin 算法用在了很多地方，例如 Kafka 和 Nginx。<br> <code>图解</code>：<br> <img src="https://images2.imgbox.com/9a/c8/Exje4a40_o.png" alt="在这里插入图片描述"><br> <code>示例代码</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 从集合中读取数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu1.com"</span><span class="token punctuation">,</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu2.com"</span><span class="token punctuation">,</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu5.com"</span><span class="token punctuation">,</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"gala"</span><span class="token punctuation">,</span><span class="token string">"www.baidu6.com"</span><span class="token punctuation">,</span><span class="token number">3L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu7.com"</span><span class="token punctuation">,</span><span class="token number">4L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu2"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">6L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu3"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">7L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> eventDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">BasicTypeInfo</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. map操作</span>
       eventDataStreamSource<span class="token punctuation">.</span><span class="token function">rebalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"shuffle"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><code>打印结果</code>：</p> 
<pre><code class="prism language-java">shuffle<span class="token operator">:</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token class-name">Event</span><span class="token punctuation">{<!-- --></span>user<span class="token operator">=</span><span class="token char">'gala'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'www<span class="token punctuation">.</span>baidu6<span class="token punctuation">.</span>com'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1970</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00.003</span><span class="token punctuation">}</span>
shuffle<span class="token operator">:</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">Event</span><span class="token punctuation">{<!-- --></span>user<span class="token operator">=</span><span class="token char">'ming'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'www<span class="token punctuation">.</span>baidu1<span class="token punctuation">.</span>com'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1970</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00.0</span><span class="token punctuation">}</span>
shuffle<span class="token operator">:</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token class-name">Event</span><span class="token punctuation">{<!-- --></span>user<span class="token operator">=</span>'xiaohu3<span class="token char">', url='</span>www<span class="token punctuation">.</span>baidu8<span class="token punctuation">.</span>com'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1970</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00.007</span><span class="token punctuation">}</span>
shuffle<span class="token operator">:</span><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token class-name">Event</span><span class="token punctuation">{<!-- --></span>user<span class="token operator">=</span><span class="token char">'xiaohu'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'www<span class="token punctuation">.</span>baidu2<span class="token punctuation">.</span>com'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1970</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00.001</span><span class="token punctuation">}</span>
shuffle<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token class-name">Event</span><span class="token punctuation">{<!-- --></span>user<span class="token operator">=</span><span class="token char">'xiaohu'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'www<span class="token punctuation">.</span>baidu5<span class="token punctuation">.</span>com'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1970</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00.002</span><span class="token punctuation">}</span>
shuffle<span class="token operator">:</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">Event</span><span class="token punctuation">{<!-- --></span>user<span class="token operator">=</span><span class="token char">'ming'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'www<span class="token punctuation">.</span>baidu7<span class="token punctuation">.</span>com'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1970</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00.004</span><span class="token punctuation">}</span>
shuffle<span class="token operator">:</span><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token class-name">Event</span><span class="token punctuation">{<!-- --></span>user<span class="token operator">=</span><span class="token char">'xiaohu'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'www<span class="token punctuation">.</span>baidu8<span class="token punctuation">.</span>com'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1970</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00.005</span><span class="token punctuation">}</span>
shuffle<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token class-name">Event</span><span class="token punctuation">{<!-- --></span>user<span class="token operator">=</span>'xiaohu2<span class="token char">', url='</span>www<span class="token punctuation">.</span>baidu8<span class="token punctuation">.</span>com'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1970</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00.006</span><span class="token punctuation">}</span>
</code></pre> 
<p>看着好像不是按照顺序，其实按照时间排序之后再看，顺序是3412</p> 
<h4><a id="43_rescale_589"></a>4.3 重缩放分区（rescale）</h4> 
<table><thead><tr><th align="left">标题</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">简介：</td><td align="left">重缩放分区和轮询分区很相似，重缩放也是使用的Round-Robin算法轮询，只不过是将数据轮询发送到下游算子并行任务的一部分中，也就是类似于只会在自己的小团体中进行轮询。</td></tr><tr><td align="left">特点 ：</td><td align="left">团体内部，轮询分区</td></tr><tr><td align="left">调用方法：</td><td align="left"><code>DataStream.rescale()</code>方法 ，rescale使用的是 <code>Round-Robin</code> 负载均衡算法</td></tr></tbody></table> 
<p><code>图解</code>：<br> <img src="https://images2.imgbox.com/81/a9/6MOVg3s4_o.png" alt="在这里插入图片描述"><br> 这里说一下当下游任务的数量是上游任务数量的整数倍时，rescale的效率会更高一些。rescale和rebalance的区别在于：</p> 
<ol><li><code>rebalance</code>是所有分区数据的重新平衡，当<code>TaskManger</code>数据量较多时，这种跨节点的网络传输必然影响效率，如果配置的<code>task slot</code>数量合适，<code>rescale</code>方式进行局部重缩放，就可以让数据只在当前<code>TaskManger</code>的多个<code>slot</code>之间重新分配，从而避免网络传输带来的损耗。</li><li>底层区别是<code>rescale</code>和<code>rebalance</code>在于任务之间的连接机制不同，<code>rebalance</code>会针对所有上游任务和所有下游任务之间建立通信通道，呈现笛卡尔积的关系，而<code>rescale</code>仅仅针对每一个任务以及通过某种方式得到的分组内的任务之间建立通信，节省很多资源。</li></ol> 
<p><code>示例代码</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 从集合中读取数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu1.com"</span><span class="token punctuation">,</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu2.com"</span><span class="token punctuation">,</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu5.com"</span><span class="token punctuation">,</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"gala"</span><span class="token punctuation">,</span><span class="token string">"www.baidu6.com"</span><span class="token punctuation">,</span><span class="token number">3L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu7.com"</span><span class="token punctuation">,</span><span class="token number">4L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu2"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">6L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu3"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">7L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> eventDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">BasicTypeInfo</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. map操作</span>
       eventDataStreamSource<span class="token punctuation">.</span><span class="token function">rescale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"shuffle"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里的打印结果其实是1234，为什么？ 因为我的数据输入使用的fromCollection 本身就是只有一个任务，所以下游任务的4个 都是一组，如果换成addSource效果会好一些。</p> 
<p>示例：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> integerDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RichParallelSourceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SourceContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token punctuation">;</span>i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 将奇数发送到索引为 1 的并行子任务</span>
                    <span class="token comment">// 将偶数发送到索引为 0 的并行子任务</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndexOfThisSubtask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        ctx<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. map操作</span>
        integerDataStreamSource<span class="token punctuation">.</span><span class="token function">rescale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"shuffle"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><code>输出结果</code>：</p> 
<pre><code class="prism language-java"><span class="token comment">// 手动排序后的</span>
shuffle<span class="token operator">:</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token number">1</span>
shuffle<span class="token operator">:</span><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token number">3</span>
shuffle<span class="token operator">:</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token number">5</span>
shuffle<span class="token operator">:</span><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token number">7</span>
shuffle<span class="token operator">:</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token number">9</span>

shuffle<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token number">2</span>
shuffle<span class="token operator">:</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token number">4</span>
shuffle<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token number">6</span>
shuffle<span class="token operator">:</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token number">8</span>
shuffle<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token number">10</span>
</code></pre> 
<p>可以看出来，1和2是一组，3和4是一组</p> 
<h4><a id="44_Broadcast_676"></a>4.4 广播（Broadcast）</h4> 
<table><thead><tr><th align="left">标题</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">简介：</td><td align="left">广播方式不算重分区，使用广播方式后，数据会在不同的分区都保留一份，可能进行重复处理。</td></tr><tr><td align="left">特点 ：</td><td align="left">所有分区都保留一份</td></tr><tr><td align="left">调用方法：</td><td align="left"><code>DataStream.broadcast()</code>方法</td></tr></tbody></table> 
<p><code>示例代码</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 从集合中读取数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu1.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu2.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu5.com"</span><span class="token punctuation">,</span><span class="token number">1267L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"gala"</span><span class="token punctuation">,</span><span class="token string">"www.baidu6.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"ming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu7.com"</span><span class="token punctuation">,</span><span class="token number">4200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">5500L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> eventDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">BasicTypeInfo</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. map操作</span>
        eventDataStreamSource<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"shuffle"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里设置了2个并行度，所以最后会有16条数据输出。</p> 
<h4><a id="45_global_709"></a>4.5 全局分区（global）</h4> 
<p>全局分区是一种特殊分区，这种分区非常极端，会将所有的输入流数据都发送到下游算子的第一个并行子任务中去。等于强行让下游任务并行度变为1，所以使用这个需谨慎。使用方式<br> <code>eventDataStreamSource.global().print("shuffle").setParallelism(2);</code></p> 
<h4><a id="46_Custom_713"></a>4.6 自定义分区（Custom）</h4> 
<p>当Flink提供的分区策略不能满足我们的要求时，还可以通过使用partitionCustom()方法来自定义分区策略</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">partitionCustom</span><span class="token punctuation">(</span>
            <span class="token class-name">Partitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> partitioner<span class="token punctuation">,</span> <span class="token class-name">KeySelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> keySelector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">setConnectionType</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">CustomPartitionerWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token function">clean</span><span class="token punctuation">(</span>partitioner<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">clean</span><span class="token punctuation">(</span>keySelector<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>参数说明：</p> 
<ul><li><code>partitioner</code>：自定义分区器（Partitioner）对象</li><li><code>keySelector</code>：对 <code>DataStream</code> 进行分区的 <code>KeySelector</code>。应用分区器的字段，指定方式与<code>KeyBy</code>指定<code>key</code>基本一样，可以通过<code>字段名</code>指定也可以通过<code>字段位置索引</code>来指定。</li></ul> 
<p><code>示例</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 直接调用getExecutionEnvironment 方法，底层源码可以自由判断是本地执行环境还是集群的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 从集合中读取数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaoming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu1.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu2.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu5.com"</span><span class="token punctuation">,</span><span class="token number">1267L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"gala"</span><span class="token punctuation">,</span><span class="token string">"www.baidu6.com"</span><span class="token punctuation">,</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaoming"</span><span class="token punctuation">,</span><span class="token string">"www.baidu7.com"</span><span class="token punctuation">,</span><span class="token number">4200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">,</span><span class="token string">"www.baidu8.com"</span><span class="token punctuation">,</span><span class="token number">5500L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> eventDataStreamSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">BasicTypeInfo</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        eventDataStreamSource<span class="token punctuation">.</span><span class="token function">partitionCustom</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Partitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">,</span> <span class="token keyword">int</span> numPartitions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"xiaohu"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">KeySelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Event</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> event<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 执行程序</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>结果就是只有 0 输出xiaohu<img src="https://images2.imgbox.com/81/7f/1yBp1Idu_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c23dd31b9030444beac9a3a1b6c30314/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Flink】Flink 中的时间和窗口之水位线(Watermark)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/620cbc4062921d13d8c436c40dd2378a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python 如何用pandas合并相同数据？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>