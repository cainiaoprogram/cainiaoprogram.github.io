<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>NORDIC nrf52833使用笔记 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="NORDIC nrf52833使用笔记" />
<meta property="og:description" content="文章目录 一、SoftDevice命名规则（一）、通用规则（二）、特定规则 二、nRF52833关键特性三、SoftDevice目录框架四、代码目录框架五、应用代码结构六、内存分配表（一）、不带bootloader时的内存分配（二）、带bootloader时的内存分配 七、外设举例说明（一）、GPIO（二）、TWI(I2C/UART) 八、移植不同型号DK九、参考文档 刚开始可以先看这两篇文档，看懂了就不用看我写的了 😃 nRF5 SDK软件架构及softdevice工作原理 Nordic nRF5 SDK和softdevice介绍 一、SoftDevice命名规则 以Sxyz为例，其中S表示Software，各字母的含义如下所示。不同的协议栈的具体描述可见此处。
（一）、通用规则 x - 协议栈类型
1：BLE stack2：ANT stack3：BLE&amp;ANT stack y - BLE角色
1：peripheral role2：central role3：all roles（central/peripheral/advertiser/observer） z - 系列芯片
0：nRF51 series2：nRF52 series3：misc series 例如S113代表的是 低功耗BLE协议栈，从设备，针对nRF52805, nRF52810, nRF52811, nRF52820, nRF52832, nRF52833 and nRF52840系列的SoC。
（二）、特定规则 x - 协议栈类型
同上
yz - 芯片型号
40：针对芯片52840 tips: S140是一个大而全的协议栈，包含蓝牙所有功能。
注意不同的softdevice所占用的ROM和RAM是不一样的，具体看其手册S112、S113、S122、S130、S132、S140、S212、S312、S332、S340…
图1-1 s113属性图 图1-2 s140属性图 二、nRF52833关键特性 该SoC主频为64MHz、内核为Arm Cortex-M4且带FPU。Flash大小为512KB，RAM大小为128KB。支持PHY为2 Mbps,1 Mbps, Long Range。支持蓝牙定位功能。支持低功耗蓝牙BLE、蓝牙Mesh组网、ANT、NFC、Thread和Zigbee协议。发射功率最大为&#43;8dBm。支持CCM（CTR加密模式和CMAC认证算法的混合）模式的128-bit AES加密。支持的外设有UART, SPI, TWI（Two Wire Interface）, PDM, HS-SPI, I2S, PWM, 12-bit ADC, USB 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/beab07fcff5e97b3ddfb74a633f33ebc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-27T22:32:19+08:00" />
<meta property="article:modified_time" content="2020-11-27T22:32:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">NORDIC nrf52833使用笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#SoftDevice_6" rel="nofollow">一、SoftDevice命名规则</a></li><li><ul><li><a href="#_10" rel="nofollow">（一）、通用规则</a></li><li><a href="#_32" rel="nofollow">（二）、特定规则</a></li></ul> 
   </li><li><a href="#nRF52833_54" rel="nofollow">二、nRF52833关键特性</a></li><li><a href="#SoftDevice_67" rel="nofollow">三、SoftDevice目录框架</a></li><li><a href="#_83" rel="nofollow">四、代码目录框架</a></li><li><a href="#_169" rel="nofollow">五、应用代码结构</a></li><li><a href="#_250" rel="nofollow">六、内存分配表</a></li><li><ul><li><a href="#bootloader_259" rel="nofollow">（一）、不带bootloader时的内存分配</a></li><li><a href="#bootloader_272" rel="nofollow">（二）、带bootloader时的内存分配</a></li></ul> 
   </li><li><a href="#_285" rel="nofollow">七、外设举例说明</a></li><li><ul><li><a href="#GPIO_296" rel="nofollow">（一）、GPIO</a></li><li><a href="#TWII2CUART_332" rel="nofollow">（二）、TWI(I2C/UART)</a></li></ul> 
   </li><li><a href="#DK_369" rel="nofollow">八、移植不同型号DK</a></li><li><a href="#_377" rel="nofollow">九、参考文档</a></li></ul> 
 </li></ul> 
</div> 
<br> 刚开始可以先看这两篇文档，看懂了就不用看我写的了 😃 
<br> 
<a href="https://www.cnblogs.com/iini/p/9332463.html" rel="nofollow">nRF5 SDK软件架构及softdevice工作原理</a> 
<br> 
<a href="https://www.cnblogs.com/iini/p/9095551.html" rel="nofollow">Nordic nRF5 SDK和softdevice介绍</a> 
<p></p> 
<h3><a id="SoftDevice_6"></a>一、SoftDevice命名规则</h3> 
<p>以<strong>Sxyz</strong>为例，其中S表示Software，各字母的含义如下所示。不同的协议栈的具体描述可见<a href="https://www.nordicsemi.com/Software-and-tools/Software" rel="nofollow">此处</a>。</p> 
<h4><a id="_10"></a>（一）、通用规则</h4> 
<p><strong>x - 协议栈类型</strong></p> 
<ul><li>1：BLE stack</li><li>2：ANT stack</li><li>3：BLE&amp;ANT stack</li></ul> 
<p><strong>y - BLE角色</strong></p> 
<ul><li>1：peripheral role</li><li>2：central role</li><li>3：all roles（central/peripheral/advertiser/observer）</li></ul> 
<p><strong>z - 系列芯片</strong></p> 
<ul><li>0：nRF51 series</li><li>2：nRF52 series</li><li>3：misc series</li></ul> 
<p>例如S113代表的是 低功耗BLE协议栈，从设备，针对nRF52805, nRF52810, nRF52811, nRF52820, nRF52832, <strong>nRF52833</strong> and nRF52840系列的SoC。</p> 
<h4><a id="_32"></a>（二）、特定规则</h4> 
<p><strong>x - 协议栈类型</strong></p> 
<p>同上</p> 
<p><strong>yz - 芯片型号</strong></p> 
<ul><li>40：针对芯片52840</li></ul> 
<p>tips: S140是一个大而全的协议栈，包含蓝牙所有功能。</p> 
<p>注意不同的softdevice所占用的ROM和RAM是不一样的，具体看其手册<a href="https://www.nordicsemi.com/Software-and-Tools/Software/S112/Download#infotabs" rel="nofollow">S112</a>、<a href="https://www.nordicsemi.com/Software-and-Tools/Software/S113/Download#infotabs" rel="nofollow">S113</a>、<a href="https://www.nordicsemi.com/Software-and-Tools/Software/S122/Download#infotabs" rel="nofollow">S122</a>、<a href="https://www.nordicsemi.com/Software-and-Tools/Software/S130/Download#infotabs" rel="nofollow">S130</a>、<a href="https://www.nordicsemi.com/Software-and-Tools/Software/S132/Download#infotabs" rel="nofollow">S132</a>、<a href="https://www.nordicsemi.com/Software-and-Tools/Software/S140/Download#infotabs" rel="nofollow">S140</a>、<a href="https://www.nordicsemi.com/Software-and-Tools/Software/S212/Download#infotabs" rel="nofollow">S212</a>、<a href="https://www.nordicsemi.com/Software-and-Tools/Software/S312/Download#infotabs" rel="nofollow">S312</a>、<a href="https://www.nordicsemi.com/Software-and-Tools/Software/S332/Download#infotabs" rel="nofollow">S332</a>、<a href="https://www.nordicsemi.com/Software-and-Tools/Software/S340/Download#infotabs" rel="nofollow">S340</a>…</p> 
<p><img src="https://images2.imgbox.com/97/76/QVZHbf1N_o.png" alt="在这里插入图片描述"></p> 
<center>
  图1-1 s113属性图 
</center> 
<p></p> 
<p><img src="https://images2.imgbox.com/a7/53/bD49sLd1_o.png" alt="在这里插入图片描述"></p> 
<center>
  图1-2 s140属性图 
</center> 
<p></p> 
<h3><a id="nRF52833_54"></a>二、nRF52833关键特性</h3> 
<ul><li>该SoC主频为64MHz、内核为Arm Cortex-M4且带FPU。</li><li>Flash大小为512KB，RAM大小为128KB。</li><li>支持PHY为2 Mbps,1 Mbps, Long Range。</li><li>支持蓝牙定位功能。</li><li>支持低功耗蓝牙BLE、蓝牙Mesh组网、ANT、NFC、Thread和Zigbee协议。</li><li>发射功率最大为+8dBm。</li><li>支持CCM（CTR加密模式和CMAC认证算法的混合）模式的128-bit AES加密。</li><li>支持的外设有UART, SPI, TWI（Two Wire Interface）, PDM, HS-SPI, I2S, PWM, 12-bit ADC, USB 2.0。</li></ul> 
<p>TWI就是双线接口，支持类似I2C这种只有时钟线/数据线的协议。</p> 
<h3><a id="SoftDevice_67"></a>三、SoftDevice目录框架</h3> 
<p>当前最新的nRF5 SDK版本为17.02</p> 
<p><img src="https://images2.imgbox.com/d2/eb/l6n97Anc_o.png" alt="在这里插入图片描述"></p> 
<center>
  图3-1 nRF5 SDK17目录框架 
</center> 
<p></p> 
<ul><li>components：Nordic开发的各种SDK，只包含头文件、源文件以及库文件，<strong>切勿修改</strong>！</li><li>config：不同类型芯片的配置文件。</li><li>documentation：SDK和不同softdeviceAPI的参考文档。</li><li>examples：根据不同传输协议/BLE角色/外设等应用场景所设计的例程。<strong>此目录很常用</strong>。</li><li>external：第三方库或源码。</li><li>external_tools：第三方工具。</li><li>integration：集成旧版本SDK（≤SDK14）的驱动（又称legacy）。</li><li>modules：新版本SDK（&gt;SDK14）驱动nrfx，同时支持nRF5 SDK（用于nRF51/52芯片）以及nRF Connect SDK（支持nRF91/53芯片）。</li></ul> 
<h3><a id="_83"></a>四、代码目录框架</h3> 
<p>以usbd_ble_uart为例，具体代码位置在./examples/peripheral/usbd_ble_uart/s113。<br> NORDIC在此支持三种IDE，分别是Keil、IAR和SES（SEGGER Embedded Studio），我们用SES进行开发。注意SES一定要使用最新版，因为新版本的IDE是完全免费的，相关license到官网申请注册即可。</p> 
<p><img src="https://images2.imgbox.com/20/78/roRE7bS7_o.png" alt="在这里插入图片描述"></p> 
<center>
  图4-1 代码目录图 
</center> 
<p></p> 
<ul><li>Application<br> 存放应用程序文件，主要有main.c和sdk_config.h文件。<br> <img src="https://images2.imgbox.com/00/9f/of2X4rhz_o.png" alt="在这里插入图片描述"></li></ul> 
<center>
  图4-2 Application目录图 
</center> 
<ul><li>Board Definition<br> 此处主要包含开发板相关硬件的定义，主要涉及的是各种板载相关的外设。</li></ul> 
<p><img src="https://images2.imgbox.com/83/4f/XHVJgvHz_o.png" alt="在这里插入图片描述"></p> 
<center>
  图4-3 Board Definition目录图 
</center> 
<ul><li>Board Support<br> 此处主要是提供<strong>系统状态指示</strong>（扫描、广播、绑定、连接成功等）功能，根据系统状态控制LED。以及提供通过按键控制系统状态的功能（配对、断开连接、唤醒等）。<br> <img src="https://images2.imgbox.com/af/d1/u18rzCiB_o.png" alt="在这里插入图片描述"></li></ul> 
<center>
  图4-4 Board Support目录图 
</center> 
<ul><li>None<br> 存放与芯片相关的启动文件、系统时钟配置文件，此处在修改芯片的时候需要替换对应文件。<br> <img src="https://images2.imgbox.com/d6/16/zL7ptA0y_o.png" alt="在这里插入图片描述"></li></ul> 
<center>
  图4-5 None目录图 
</center> 
<ul><li>nRF_BLE<br> 存放低功耗蓝牙相关的广播、建立连接、服务、连接上下文管理器和GATT等文件。<br> <img src="https://images2.imgbox.com/ce/7e/33utf8PD_o.png" alt="在这里插入图片描述"></li></ul> 
<center>
  图4-6 nRF_BLE目录图 
</center> 
<ul><li>nRF_BLE_Services<br> 存放NUS串口服务的文件。<br> <img src="https://images2.imgbox.com/c0/45/7cAZcD77_o.png" alt="在这里插入图片描述"></li></ul> 
<center>
  图4-7 nRF_BLE_Services目录图 
</center> 
<ul><li>nRF_Drivers<br> 存放外设驱动文件。<br> <img src="https://images2.imgbox.com/5b/32/jXHChnt9_o.png" alt="在这里插入图片描述"></li></ul> 
<center>
  图4-8 nRF_Drivers目录图 
</center> 
<ul><li>nRF_Libraries<br> 存放库文件，用于实现多种功能。<br> <img src="https://images2.imgbox.com/c9/c1/JRS5ELei_o.png" alt="在这里插入图片描述"></li></ul> 
<center>
  图4-9 nRF_Libraries目录图 
</center> 
<ul><li>nRF_Log<br> 存放日志输出相关的文件。<br> <img src="https://images2.imgbox.com/3d/97/EmHj1rBw_o.png" alt="在这里插入图片描述"></li></ul> 
<center>
  图4-10 nRF_Log目录图 
</center> 
<ul><li>nRF_Segger_RTT<br> 存放<a href="https://www.segger.com/products/debug-probes/j-link/technology/about-real-time-transfer/" rel="nofollow">SEGGER RTT</a>相关（Teal Time Transfer）文件，和printf类似（但占用时间极短 us级），可多通道双向传输调试信息，需要使用软件“J-Link RTT Viewer”。<br> <img src="https://images2.imgbox.com/19/e3/cMFTNOl3_o.png" alt="在这里插入图片描述"></li></ul> 
<center>
  图4-11 nRF_Segger_RTT目录图 
</center> 
<ul><li>nRF_SoftDevice<br> 存放协议栈相关的文件。<br> <img src="https://images2.imgbox.com/07/59/mR6MRuA4_o.png" alt="在这里插入图片描述"></li></ul> 
<center>
  图4-12 nRF_SoftDevice目录图 
</center> 
<ul><li>Segger Startup Files<br> 存放SEGGER启动文件。<br> <img src="https://images2.imgbox.com/4b/a9/EEsYeakN_o.png" alt="在这里插入图片描述"></li></ul> 
<center>
  图4-13 Segger Startup Files目录图 
</center> 
<ul><li>UTF/UTF16 converter<br> 存放UTF编码转换文件。<br> <img src="https://images2.imgbox.com/d6/79/JP6FNg05_o.png" alt="在这里插入图片描述"></li></ul> 
<center>
  图4-14 UTF/UTF16 converter目录图 
</center> 
<ul><li>Output Files<br> 存放编译输出文件。<br> <img src="https://images2.imgbox.com/69/7b/rmRCjUwt_o.png" alt="在这里插入图片描述"></li></ul> 
<center>
  图4-15 Output Files目录图 
</center> 
<h3><a id="_169"></a>五、应用代码结构</h3> 
<p>主函数如下所示。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ret_code_t ret<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> app_usbd_config_t usbd_config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* USB设备配置结构体 */</span>
        <span class="token punctuation">.</span>ev_state_proc <span class="token operator">=</span> usbd_user_ev_handler <span class="token comment">/* 注册usb设备用户事件函数 */</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// Initialize.</span>
    <span class="token function">log_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 初始化信息输出接口 */</span>
    <span class="token function">timers_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 初始化定时器，此处使用LED标识BLE和CDC状态 */</span>

    <span class="token function">buttons_leds_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 初始化按键和LED */</span>

    <span class="token function">app_usbd_serial_num_generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 生成usb设备序列号 */</span>

    ret <span class="token operator">=</span> <span class="token function">nrf_drv_clock_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 初始化设备时钟 */</span>
    <span class="token function">APP_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 检测返回值是否正常 */</span>

    <span class="token function">NRF_LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"USBD BLE UART example started."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">app_usbd_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>usbd_config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 传入usb配置结构体初始化usb设备 */</span>
    <span class="token function">APP_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

    app_usbd_class_inst_t <span class="token keyword">const</span> <span class="token operator">*</span> class_cdc_acm <span class="token operator">=</span> <span class="token function">app_usbd_cdc_acm_class_inst_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_app_cdc_acm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 获取USB CDC-ACM实例  */</span>
    ret <span class="token operator">=</span> <span class="token function">app_usbd_class_append</span><span class="token punctuation">(</span>class_cdc_acm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* USB设备追加注册CDC ACM类 */</span>
    <span class="token function">APP_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ble_stack_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 初始化协议栈 */</span>
    <span class="token function">gap_params_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 初始化GAP参数 */</span>
    <span class="token function">gatt_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 初始化GATT */</span>
    <span class="token function">services_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 初始化服务 */</span>
    <span class="token function">advertising_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 初始化广播 */</span>
    <span class="token function">conn_params_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 初始化连接参数 */</span>

    <span class="token comment">// Start execution.</span>
    <span class="token function">advertising_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 开始广播 */</span>

    ret <span class="token operator">=</span> <span class="token function">app_usbd_power_events_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 使能usb设备插入检测 */</span>
    <span class="token function">APP_ERROR_CHECK</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Enter main loop.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">app_usbd_event_queue_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">/* 处理队列事件 */</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* Nothing to do */</span>
        <span class="token punctuation">}</span>
        <span class="token function">idle_state_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 进入空闲模式，节省电量 */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在应用中，我们主要修改的是传输速率相关的宏定义以及各种回调函数，其他大部分功能已经封装好。</p> 
<center>
  表5-1 与传输速度相关的宏定义表 
</center> 
<table><thead><tr><th>parameter</th><th>range</th><th>default</th><th>description</th></tr></thead><tbody><tr><td>MTU(Maximun Transmission Unit)</td><td>23~247</td><td>23</td><td>最大传输单元</td></tr><tr><td>Data Length</td><td>27~251</td><td>251</td><td>最大数据长度</td></tr><tr><td>Connect Event Length</td><td>-</td><td>400（*1.25 = 500ms）</td><td>连接事件长度</td></tr><tr><td>Connection Event Extension</td><td>True/False</td><td>True</td><td>连接时间拓展功能（延长）</td></tr><tr><td>PHY(physical layer)</td><td>1Mbps/2Mbps/Coded</td><td>1Mbps</td><td>物理层协议，其中coded protocol仅限于nRF52840</td></tr></tbody></table> 
<center>
  表5-2 各回调函数表 
</center> 
<table><thead><tr><th>函数名</th><th>函数说明</th><th>函数作用</th></tr></thead><tbody><tr><td>cdc_acm_user_ev_handler</td><td>CDC ACM回调函数</td><td>处理USB串口端口开启/关闭/发送/接收等事件</td></tr><tr><td>nus_data_handler</td><td>BLE串口服务回调函数</td><td>处理BLE串口服务发送/接收/notification开启或停止等事件</td></tr><tr><td>on_adv_evt</td><td>广播事件回调函数</td><td>处理广播事件</td></tr><tr><td>ble_evt_handler</td><td>ble事件回调函数</td><td>处理GAP连接/断开/请求/超时等事件</td></tr><tr><td>gatt_evt_handler</td><td>gatt事件回调函数</td><td>处理GATT MTU和数据长度更新请求完毕等事件</td></tr><tr><td>bsp_event_handler</td><td>底层事件回调函数</td><td>处理系统休眠/GAP断开连接/关闭白名单/绑定/复位等事件</td></tr><tr><td>usbd_user_ev_handler</td><td>usb用户事件回调函数</td><td>处理USB设备端点挂起/恢复/开启/停止和插入检测等事件</td></tr></tbody></table> 
<h3><a id="_250"></a>六、内存分配表</h3> 
<blockquote> 
 <p>Nordic nRF5系列芯片使用的flash存储器是<strong>NOR flash</strong>，程序代码无须加载到RAM就可直接在flash上执行。Nordic Flash是带cache机制的，以保证大部分代码执行速度可以达到64MHz，在cache失败的时候，等待周期也只有1个cycle。另外，Nordic芯片是纯Flash产品，里面没有其他NVM（Non-Volatile Memory），所有非易失性数据都放在Flash中，包括蓝牙协议栈，这也是为什么Nordic蓝牙协议栈也可以OTA的根本原因所在。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/3f/96/d9RmqYIu_o.png" alt="在这里插入图片描述"></p> 
<center>
  图6-1 nRF52833芯片内存分布图 
</center> 
<h4><a id="bootloader_259"></a>（一）、不带bootloader时的内存分配</h4> 
<center>
  表6-1 不带bootloader时内存分配表 
</center> 
<table><thead><tr><th>内存地址</th><th>区块</th></tr></thead><tbody><tr><td>Application_size + SoftDevice_size</td><td>—</td></tr><tr><td></td><td>Application</td></tr><tr><td>SoftDevice_size</td><td>—</td></tr><tr><td></td><td>SoftDevice</td></tr><tr><td>0x00000000</td><td>—</td></tr></tbody></table> 
<p>SoftDevice_size根据不同的Softdevice进行配置</p> 
<h4><a id="bootloader_272"></a>（二）、带bootloader时的内存分配</h4> 
<p>此图详见官网<a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fcom.nordic.infocenter.sdk5.v13.0.0%2Flib_bootloader.html" rel="nofollow">bootloader memory map</a></p> 
<p><img src="https://images2.imgbox.com/39/6f/69lJJY9d_o.png" alt="在这里插入图片描述"></p> 
<center>
  图6-2 带bootloader时不同芯片不同softdevice的内存分配图 
</center> 
<p></p> 
<p><img src="https://images2.imgbox.com/d1/87/Mdhr6D5h_o.png" alt="在这里插入图片描述"></p> 
<center>
  图6-3 内存划分配置图 
</center> 
<p>注意，S140的大小为0x1C000，表格上面SoftDevice的地址范围是错误的（应该为0x0000 1000-0x0001 D000）。</p> 
<h3><a id="_285"></a>七、外设举例说明</h3> 
<p>各外设的API说明请看<a href="https://developer.nordicsemi.com/nRF5_SDK/nRF5_SDK_v17.x.x/nRF5_SDK_17.0.2_offline_doc.zip" rel="nofollow">SDK离线文档</a></p> 
<pre><code class="prism language-c"><span class="token comment">//IO映射，如P1.12 --&gt; NRF_GPIO_PIN_MAP(1, 12)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> NRF_GPIO_PIN_MAP(port, pin) (((port) &lt;&lt; 5) | ((pin) &amp; 0x1F))</span>
</code></pre> 
<p>下面举例说明GPIO和TIMER如何使用，在哪找相关API。其实最好的方法就是看examples/peripheral里面相关外设的demo，简单快速上手。</p> 
<h4><a id="GPIO_296"></a>（一）、GPIO</h4> 
<p>打开examples/peripheral/blinky/pca10040/s132/ses目录下的emProject项目。</p> 
<p>1、配置为输出模式</p> 
<ul><li>初始化函数</li></ul> 
<p><img src="https://images2.imgbox.com/ca/54/G0Wx4Dhv_o.png" alt="在这里插入图片描述"></p> 
<center>
  图7-1 GPIO输出模式下初始化函数 
</center> 
<ul><li>GPIO操作函数</li></ul> 
<p><img src="https://images2.imgbox.com/4a/7e/peMKtWui_o.png" alt="在这里插入图片描述"></p> 
<center>
  图7-2 GPIO控制函数 
</center> 
<p></p> 
<p>2、配置为输入模式</p> 
<ul><li>初始化函数</li></ul> 
<p><img src="https://images2.imgbox.com/af/2b/6rVHai4i_o.png" alt="在这里插入图片描述"></p> 
<center>
  图7-3 GPIO输入模式下初始化函数 
</center> 
<p>其中，BUTTON_PULL可选项如下</p> 
<p><img src="https://images2.imgbox.com/2a/67/mG11TXvj_o.png" alt="在这里插入图片描述"></p> 
<center>
  图7-4 GPIO输入模式下上下拉的可选配置 
</center> 
<ul><li>GPIO操作函数</li></ul> 
<p><img src="https://images2.imgbox.com/98/f4/6ac9blfX_o.png" alt="在这里插入图片描述"></p> 
<center>
  图7-5 GPIO输入模式下操作函数 
</center> 
<p>另外Nordic已集成好按键事件处理的代码，详见nRF_Libraries下的app_buttons.c和bsp.c</p> 
<h4><a id="TWII2CUART_332"></a>（二）、TWI(I2C/UART)</h4> 
<p>打开examples\peripheral\twi_sensor\pca10040\blank\ses目录下的emProject项目。</p> 
<p>1、TWI初始化函数</p> 
<p><img src="https://images2.imgbox.com/f0/01/KErPk9bX_o.png" alt="在这里插入图片描述"></p> 
<center>
  图7-6 TWI（I2C）初始化函数 
</center> 
<p></p> 
<p>2、TWI操作函数</p> 
<ul><li>TWI写操作函数</li></ul> 
<p><img src="https://images2.imgbox.com/2b/97/tbSzTYpZ_o.png" alt="在这里插入图片描述"></p> 
<center>
  图7-7 TWI（I2C）写操作函数 
</center> 
<p></p> 
<p><img src="https://images2.imgbox.com/0a/4f/Qe4XZTz9_o.png" alt="在这里插入图片描述"></p> 
<center>
  图7-8 TWI（I2C）写操作函数API各参数的详细说明 
</center> 
<p>各参数的含义如下所示：</p> 
<ul><li> <p>p_instance：初始化时的实例</p> </li><li> <p>address：I2C设备的地址</p> </li><li> <p>p_data：发送的数据buffer，传入的数据为数组{reg_addr, reg_val（有的话）,…}</p> </li><li> <p>length：传入数据的长度</p> </li><li> <p>no_stop：是否发送停止信号</p> </li><li> <p>TWI读操作函数<br> <img src="https://images2.imgbox.com/ce/b6/kdwHuBGF_o.png" alt="在这里插入图片描述"></p> 
  <center>
    图7-9 TWI（I2C）读操作函数 
  </center><p></p> </li></ul> 
<p><img src="https://images2.imgbox.com/13/a6/0ITk5HVL_o.png" alt="在这里插入图片描述"></p> 
<center>
  图7-10 TWI（I2C）读函数API各参数的详细说明 
</center> 
<p>各参数的含义如下所示：</p> 
<ul><li>p_instance：初始化时的实例</li><li>address：I2C设备的地址</li><li>p_data：存放接收数据的buffer</li><li>length：接收数据的长度</li></ul> 
<h3><a id="DK_369"></a>八、移植不同型号DK</h3> 
<p>最直接的方法就是参照其他pca10100的项目文件，直接修改<strong>emProject</strong>文件内部与芯片相关的参数</p> 
<ul><li>开发板相关的配置（如开发板pca10040-&gt;pca10100）</li><li>适配RAM和Flash地址和大小（如RAM和Flash大小，以及带softdevice时剩余的flash大小）</li><li>芯片相关的启动文件（如52832-&gt;52833）</li></ul> 
<h3><a id="_377"></a>九、参考文档</h3> 
<ul><li> <p>芯片手册<br> <a href="https://www.nordicsemi.com/Products/Low-power-short-range-wireless/nRF52833" rel="nofollow">nRF52833芯片说明</a><br> <a href="https://www.nordicsemi.com/Products/Low-power-short-range-wireless/nRF52833/Downloads" rel="nofollow">nRF58233芯片手册</a></p> </li><li> <p>SES相关<br> <a href="https://www.segger.com/downloads/embedded-studio" rel="nofollow">SEGGER Embedded Studio IDE下载链接</a><br> <a href="https://license.segger.com/Nordic.cgi" rel="nofollow">SES激活</a></p> </li><li> <p>SDK开发相关<br> <a href="https://www.nordicsemi.com/Software-and-Tools/Software/nRF5-SDK/Download#infotabs" rel="nofollow">nRF5 nRF5-SDK下载</a><br> <a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fcom.nordic.infocenter.sdk5.v15.3.0%2Fexamples.html&amp;cp=5_1_4" rel="nofollow">nRF5 SDK （离线）文档</a><br> <a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fsdk_nrf5_v16.0.0%2Fnrf51_getting_started.html" rel="nofollow">Getting Started</a><br> <a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fug_nrf52833_dk%2FUG%2Fnrf52833_DK%2Fstart_developing.html" rel="nofollow">start developing</a><br> <a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fsdk_nrf5_v17.0.2%2Fexamples_usb.html" rel="nofollow">USB examples</a></p> </li><li> <p>开发工具<br> <a href="https://www.wireshark.org/#download" rel="nofollow">wireshark 网络分析工具</a><br> <a href="https://devzone.nordicsemi.com/f/nordic-q-a" rel="nofollow">Nordic E2E Forum</a><br> <a href="https://www.nordicsemi.com/Software-and-tools/Development-Tools" rel="nofollow">Nordic 开发工具（nRF Sniffer、nRF Connect…）</a></p> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0044f16961566e8f18308cc7407e49b9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于SSM框架实现的项目——绿色蔬果商城</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0c07016e0809c61cd51292472c4619cb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python抢红包程序算法_python实现简单抢红包算法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>