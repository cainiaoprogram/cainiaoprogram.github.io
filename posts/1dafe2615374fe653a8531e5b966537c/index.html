<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux下编写C&#43;&#43;服务器(HTTP服务器) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux下编写C&#43;&#43;服务器(HTTP服务器)" />
<meta property="og:description" content="今天使用Makefile写一个HTTP的服务器，之前没有接触过Makefile，需要探索一下。
VS2015下测试Makefile 新建一个Makefile Project(Linux)，这里名为HTTPTest；
添加新建项， 添加C &#43;&#43;文件（.cpp）,名为main.cpp，
内容如下： #pragma once #pragma execution_character_set(&#34;utf-8&#34;) #include &lt;stdio.h&gt; int main() { printf(&#34;HttpServer启动\n&#34;); int count = 0; while (count&lt;3) { count&#43;&#43;; printf(&#34;hello %d\n&#34;,count); } printf(&#34;HttpServer关闭\n&#34;); return 0; } 在main.cpp的同级目录下创建一个Makefile的空文件，注意文件名的大小写，并添加到HTTPTest项目中，
写入如下内容： build: gcc -gdwarf-2 -o HTTPTest main.cpp clean: rm -rf HTTPTest 右键项目，选择属性，在General的Remote Build Root Directory中写入Linux上的项目目录，
在Remote Build四项中分别写入 cd $(RemoteRootDir)/$(ProjectName); make build cd $(RemoteRootDir)/$(ProjectName); make clean build cd $(RemoteRootDir)/$(ProjectName); make clean $(RemoteRootDir)/$(ProjectName)/HTTPTest 如图：
在main.cpp的其中一行打上断点，按F5调试，测试成功了。 安装libevent HTTP服务器我们选择libevent库实现。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1dafe2615374fe653a8531e5b966537c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-08-14T18:18:09+08:00" />
<meta property="article:modified_time" content="2019-08-14T18:18:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux下编写C&#43;&#43;服务器(HTTP服务器)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>今天使用Makefile写一个HTTP的服务器，之前没有接触过Makefile，需要探索一下。</p> 
<h4><a id="VS2015Makefile_1"></a>VS2015下测试Makefile</h4> 
<ol><li>新建一个<strong>Makefile Project(Linux)</strong>，这里名为HTTPTest；<br> <img src="https://images2.imgbox.com/94/42/6msooP8F_o.png" alt="在这里插入图片描述"></li><li>添加新建项， 添加C ++文件（.cpp）,名为<strong>main.cpp</strong>，<br> <img src="https://images2.imgbox.com/57/d2/NkepY9Yf_o.png" alt="在这里插入图片描述"><br> 内容如下：</li></ol> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">pragma</span> once</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> execution_character_set("utf-8")</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HttpServer启动\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		count<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello %d\n"</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HttpServer关闭\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>在main.cpp的同级目录下创建一个<strong>Makefile</strong>的空文件，注意文件名的大小写，并添加到HTTPTest项目中，<br> <img src="https://images2.imgbox.com/8a/6f/vsRceFcT_o.png" alt="在这里插入图片描述"><br> 写入如下内容：</li></ol> 
<pre><code class="prism language-shell">build:
	gcc -gdwarf-2 -o HTTPTest main.cpp

clean:
	<span class="token function">rm</span> -rf HTTPTest
</code></pre> 
<ol start="4"><li>右键项目，选择<strong>属性</strong>，在<strong>General</strong>的<strong>Remote Build Root Directory</strong>中写入Linux上的项目目录，<br> <img src="https://images2.imgbox.com/65/d0/e6cliiyL_o.png" alt="在这里插入图片描述"><br> 在<strong>Remote Build</strong>四项中分别写入</li></ol> 
<pre><code class="prism language-shell"><span class="token function">cd</span> <span class="token variable"><span class="token variable">$(</span>RemoteRootDir<span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>ProjectName<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token function">make</span> build
<span class="token function">cd</span> <span class="token variable"><span class="token variable">$(</span>RemoteRootDir<span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>ProjectName<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token function">make</span> clean build
<span class="token function">cd</span> <span class="token variable"><span class="token variable">$(</span>RemoteRootDir<span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>ProjectName<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token function">make</span> clean
<span class="token variable"><span class="token variable">$(</span>RemoteRootDir<span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>ProjectName<span class="token variable">)</span></span>/HTTPTest
</code></pre> 
<p>如图：<br> <img src="https://images2.imgbox.com/30/7f/Imqtj3Hz_o.png" alt="在这里插入图片描述"></p> 
<ol start="5"><li>在<strong>main.cpp</strong>的其中一行打上断点，按F5调试，测试成功了。<img src="https://images2.imgbox.com/86/fb/wVa7w2n2_o.png" alt="在这里插入图片描述"></li></ol> 
<h4><a id="libevent_50"></a>安装libevent</h4> 
<p>HTTP服务器我们选择<strong>libevent</strong>库实现。</p> 
<ol><li>把<a href="http://libevent.org" rel="nofollow">libevent下载</a>到Linux虚拟机中，这里选择2.1.10版本，下载完成后对压缩包进行解压<br> <img src="https://images2.imgbox.com/35/03/RXlEEGEI_o.png" alt="在这里插入图片描述"></li></ol> 
<pre><code class="prism language-shell"><span class="token function">tar</span> xvf libevent-2.1.10-stable.tar.gz
</code></pre> 
<p><img src="https://images2.imgbox.com/14/9e/9g02TduA_o.png" alt="在这里插入图片描述"></p> 
<ol start="2"><li>输入如下命令，用于进入解压后的文件夹，并生成makefile，–prefix用来指定libevent的安装目录；</li></ol> 
<pre><code class="prism language-shell"><span class="token function">cd</span> libevent-2.1.10-stable/
./configure --prefix<span class="token operator">=</span>/usr/libevent
</code></pre> 
<p><img src="https://images2.imgbox.com/d8/80/6DDdW8TY_o.png" alt="在这里插入图片描述"></p> 
<ol start="3"><li>输入<strong>make</strong>编译；<br> <img src="https://images2.imgbox.com/ef/76/btZRDpCd_o.png" alt="在这里插入图片描述"></li><li>输入<strong>make install</strong>开始安装，安装成功后，/usr/libevent生成了<strong>bin</strong>，<strong>include</strong>，<strong>lib</strong>文件夹。<img src="https://images2.imgbox.com/8b/50/cyw1wqZb_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/99/cb/2IbIlc8g_o.png" alt="在这里插入图片描述"></li></ol> 
<h4><a id="_69"></a>配置环境</h4> 
<ol><li>我们需要把上面生成的/usr/libevent/include复制一份到windows中，这里用到共享文件夹，</li></ol> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> /mnt/hgfs/LinuxShare/libevent
<span class="token function">cp</span> -r /usr/libevent/include /mnt/hgfs/LinuxShare/libevent
</code></pre> 
<p>windows出现了E:\LinuxShare\libevent\include目录，是我们需要的头文件；</p> 
<ol start="2"><li>右键项目-&gt;<strong>属性</strong>-&gt;<strong>C++</strong>-&gt;<strong>Include Search Path</strong>，输入<br> <strong>E:\LinuxShare\include;E:\LinuxShare\include\c++\4.8.2;E:\LinuxShare\libevent\include;</strong>，前两个是上一编配置的Linux头文件，最后一个是libevent头文件；<br> <img src="https://images2.imgbox.com/30/40/PPCNk5Fw_o.png" alt="在这里插入图片描述"></li></ol> 
<p>Makefile文件的build需要修改</p> 
<pre><code class="prism language-shell">gcc -gdwarf-2 -o HTTPTest main.cpp  -I /usr/libevent/include/ -L /usr/libevent/lib/ -levent
</code></pre> 
<p><img src="https://images2.imgbox.com/80/8c/qe6U28LD_o.png" alt="在这里插入图片描述"><br> 按F5后编译通过，但无法运行，报错如下：<br> error while loading shared libraries: libevent-2.1.so.6: cannot open shared object file: No such file or directory，提示没有找到这个库，解决方法为在linux终端输入</p> 
<pre><code class="prism language-shell"><span class="token function">ln</span>  -s /usr/libevent/lib/libevent-2.1.so.6 /usr/lib64/libevent-2.1.so.6
</code></pre> 
<p>这样运行时就可以链接库。</p> 
<h4><a id="HTTP_92"></a>封装HTTP</h4> 
<p>创建<strong>myhttpserver.h</strong>和<strong>myhttpserver.cpp</strong>，参考<a href="https://blog.csdn.net/qq_29996285/article/details/86771619">libevent实现http server</a>，经历了不少bug后，实现了get和post方法。</p> 
<p><strong>myhttpserver.h</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">pragma</span> once</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;event2/event.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;evhttp.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>

<span class="token keyword">static</span> <span class="token keyword">bool</span> closesign <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">//获取Content-Type</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">get_file_type</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//发送目录html</span>
<span class="token keyword">int</span> <span class="token function">send_dir</span><span class="token punctuation">(</span><span class="token keyword">struct</span> evbuffer<span class="token operator">*</span> bev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//http头</span>
<span class="token keyword">int</span> <span class="token function">send_header</span><span class="token punctuation">(</span><span class="token keyword">struct</span> evhttp_request<span class="token operator">*</span> request<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">long</span> filelen<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> connest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//传送文件</span>
<span class="token keyword">int</span> <span class="token function">send_file_to_http</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">struct</span> evbuffer<span class="token operator">*</span> bev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//回调函数</span>
<span class="token keyword">void</span> <span class="token function">HttpGenericCallback</span><span class="token punctuation">(</span><span class="token keyword">struct</span> evhttp_request<span class="token operator">*</span> request<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Myhttpserver</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">Myhttpserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">~</span><span class="token function">Myhttpserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	<span class="token keyword">struct</span> event_base<span class="token operator">*</span> base<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> evhttp<span class="token operator">*</span> http<span class="token punctuation">;</span>
	<span class="token keyword">char</span> errmsg<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token comment">//初始化</span>
	<span class="token keyword">bool</span> <span class="token function">inithttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//打开服务器</span>
	<span class="token keyword">bool</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//调用回调</span>
	<span class="token keyword">void</span> <span class="token function">set_gencb</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>cb<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> evhttp_request <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//循环处理</span>
	<span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token keyword">struct</span> event_base<span class="token operator">*</span> base<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">geterrmsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>myhttpserver.cpp</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;ctype.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"myhttpserver.h"</span></span>

<span class="token comment">/*
charset=iso-8859-1	西欧的编码，说明网站采用的编码是英文；
charset=gb2312		说明网站采用的编码是简体中文；
charset=utf-8			代表世界通用的语言编码；
						可以用到中文、韩文、日文等世界上所有语言编码上
charset=euc-kr		说明网站采用的编码是韩文；
charset=big5			说明网站采用的编码是繁体中文；

以下是依据传递进来的文件名，使用后缀判断是何种文件类型
将对应的文件类型按照http定义的关键字发送回去
*/</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">get_file_type</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span><span class="token operator">*</span> dot<span class="token punctuation">;</span>
	<span class="token keyword">char</span> tmpname<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token function">strncpy</span><span class="token punctuation">(</span>tmpname<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	dot <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>tmpname<span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//自右向左查找‘.’字符;如不存在返回NULL</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>dot <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"text/plain; charset=utf-8"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".html"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".htm"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"text/html; charset=utf-8"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".jpg"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".jpeg"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"image/jpeg"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".gif"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"image/gif"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".png"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"image/png"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".css"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"text/css"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".au"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"audio/basic"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".wav"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"audio/wav"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".avi"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"video/x-msvideo"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".mov"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".qt"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"video/quicktime"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".mpeg"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".mpe"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"video/mpeg"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".vrml"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".wrl"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"model/vrml"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".midi"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".mid"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"audio/midi"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".mp3"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"audio/mpeg"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".ogg"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"application/ogg"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token string">".pac"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">"application/x-ns-proxy-autoconfig"</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token string">"text/plain; charset=utf-8"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">send_header</span><span class="token punctuation">(</span><span class="token keyword">struct</span> evhttp_request<span class="token operator">*</span> request<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">long</span> filelen<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> connest<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">// 文件类型</span>
	<span class="token function">evhttp_add_header</span><span class="token punctuation">(</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>output_headers<span class="token punctuation">,</span> <span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token function">get_file_type</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 文件大小</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>filelen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">char</span> charsize<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span>charsize<span class="token punctuation">,</span> <span class="token string">"%ld"</span><span class="token punctuation">,</span> filelen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">evhttp_add_header</span><span class="token punctuation">(</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>output_headers<span class="token punctuation">,</span> <span class="token string">"Content-Length"</span><span class="token punctuation">,</span> charsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Connection: close/keep-alive</span>
	<span class="token function">evhttp_add_header</span><span class="token punctuation">(</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>output_headers<span class="token punctuation">,</span> <span class="token string">"Connection"</span><span class="token punctuation">,</span> connest<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">send_dir</span><span class="token punctuation">(</span><span class="token keyword">struct</span> evbuffer<span class="token operator">*</span> bev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dirname<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> encoded_name<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> path<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> timestr<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> stat sb<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> dirent <span class="token operator">*</span><span class="token operator">*</span>dirinfo<span class="token punctuation">;</span>

	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"&lt;html&gt;&lt;head&gt;&lt;meta charset=\"utf-8\"&gt;&lt;title&gt;%s&lt;/title&gt;&lt;/head&gt;"</span><span class="token punctuation">,</span> dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"&lt;body&gt;&lt;h1&gt;当前目录：%s&lt;/h1&gt;&lt;table&gt;"</span><span class="token punctuation">,</span> dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//添加目录内容</span>
	<span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token function">scandir</span><span class="token punctuation">(</span>dirname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dirinfo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> alphasort<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>num<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 编码</span>
		<span class="token function">strcpy</span><span class="token punctuation">(</span>encoded_name<span class="token punctuation">,</span> dirinfo<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">sprintf</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"%s%s"</span><span class="token punctuation">,</span> dirname<span class="token punctuation">,</span> dirinfo<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"############# path = %s\n"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">lstat</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sb<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token string">"&lt;tr&gt;&lt;td&gt;&lt;a href=\"%s\"&gt;%s&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;\n"</span><span class="token punctuation">,</span>
				encoded_name<span class="token punctuation">,</span> dirinfo<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">strftime</span><span class="token punctuation">(</span>timestr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>timestr<span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token string">"  %d  %b   %Y  %H:%M"</span><span class="token punctuation">,</span> <span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sb<span class="token punctuation">.</span>st_mtime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISDIR</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">sprintf</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token string">"&lt;tr&gt;&lt;td&gt;&lt;a href=\"%s/\"&gt;%s/&lt;/a&gt;&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;%ld&lt;/td&gt;&lt;/tr&gt;\n"</span><span class="token punctuation">,</span>
					encoded_name<span class="token punctuation">,</span> dirinfo<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>d_name<span class="token punctuation">,</span> timestr<span class="token punctuation">,</span> sb<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">sprintf</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token string">"&lt;tr&gt;&lt;td&gt;&lt;a href=\"%s\"&gt;%s&lt;/a&gt;&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;%ld&lt;/td&gt;&lt;/tr&gt;\n"</span><span class="token punctuation">,</span>
					encoded_name<span class="token punctuation">,</span> dirinfo<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>d_name<span class="token punctuation">,</span> timestr<span class="token punctuation">,</span> sb<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//bufferevent_write(bev, buf, strlen(buf));</span>
		<span class="token function">evbuffer_add_printf</span><span class="token punctuation">(</span>bev<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//bufferevent_write(bev, buf, strlen(buf));</span>
	<span class="token function">evbuffer_add_printf</span><span class="token punctuation">(</span>bev<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"################# Dir Read OK !!!!!!!!!!!!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">send_file_to_http</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">struct</span> evbuffer<span class="token operator">*</span> bev<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">//单次上限4096</span>
	<span class="token comment">//evbuffer_read(bev, fd, 30556);</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token comment">//不能传\0</span>
		<span class="token comment">//evbuffer_add_printf(bev, buf);</span>
		<span class="token comment">//可以传\0</span>
		<span class="token function">evbuffer_add</span><span class="token punctuation">(</span>bev<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//回调函数</span>
<span class="token keyword">void</span> <span class="token function">HttpGenericCallback</span><span class="token punctuation">(</span><span class="token keyword">struct</span> evhttp_request<span class="token operator">*</span> request<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> evhttp_uri<span class="token operator">*</span> evhttp_uri <span class="token operator">=</span> <span class="token function">evhttp_request_get_evhttp_uri</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> url<span class="token punctuation">[</span><span class="token number">8192</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">evhttp_uri_join</span><span class="token punctuation">(</span><span class="token keyword">const_cast</span><span class="token operator">&lt;</span><span class="token keyword">struct</span> evhttp_uri<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>evhttp_uri<span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"accept request url:%s\n"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>kind <span class="token operator">==</span> EVHTTP_REQUEST<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//get</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>type <span class="token operator">==</span> EVHTTP_REQ_GET<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">/*
			http://foo.com/?q=test&amp;s=some+thing
			evhttp_request_uri: 解析HTTP请求中的ur，得到/?q=test&amp;s=some+thing
			evhttp_parse_query: 解析名值对，得到一个evkeyvalq结构，里面包含了key/value的数组.
			*/</span>
			<span class="token keyword">char</span><span class="token operator">*</span> decode_uri <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">evhttp_request_uri</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">struct</span> evkeyvalq http_query<span class="token punctuation">;</span>
			<span class="token function">evhttp_parse_query</span><span class="token punctuation">(</span>decode_uri<span class="token punctuation">,</span> <span class="token operator">&amp;</span>http_query<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">free</span><span class="token punctuation">(</span>decode_uri<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">//const char *request_value = evhttp_find_header(&amp;http_query, "data");</span>
			<span class="token comment">//解码</span>
			<span class="token comment">//strcpy(url, evhttp_decode_uri(url));</span>
			<span class="token keyword">char</span> <span class="token operator">*</span>pf <span class="token operator">=</span> <span class="token operator">&amp;</span>url<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">"/."</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				pf <span class="token operator">=</span> <span class="token string">"./"</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"***** http Request Resource Path =  %s, pf = %s\n"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> pf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//退出服务器</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">"/bye"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				closesign <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token keyword">struct</span> event_base<span class="token operator">*</span> base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> event_base<span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
				Myhttpserver<span class="token operator">::</span><span class="token function">stop</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">struct</span> stat sb<span class="token punctuation">;</span>
			<span class="token keyword">struct</span> evbuffer<span class="token operator">*</span> evbuf <span class="token operator">=</span> <span class="token function">evbuffer_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>evbuf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"create evbuffer failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">char</span> dir<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> filename<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token function">snprintf</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"/home/aubin/projects/HTTPTest/%s"</span><span class="token punctuation">,</span> pf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//打开文件</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sb<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> S_IFREG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">send_header</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> pf<span class="token punctuation">,</span> sb<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> <span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">send_file_to_http</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> evbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">evhttp_send_reply</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> HTTP_OK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> evbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token function">evbuffer_free</span><span class="token punctuation">(</span>evbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>

			<span class="token punctuation">}</span>
			<span class="token comment">//打开子文件夹</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sb<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> __S_IFDIR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">send_header</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">".html"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">send_dir</span><span class="token punctuation">(</span>evbuf<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">evhttp_send_reply</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> HTTP_OK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> evbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">evhttp_clear_headers</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>http_query<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">evbuffer_free</span><span class="token punctuation">(</span>evbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">//打开主文件夹</span>
			<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">send_header</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">".html"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">send_dir</span><span class="token punctuation">(</span>evbuf<span class="token punctuation">,</span> <span class="token string">"/home/aubin/projects/HTTPTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">evhttp_send_reply</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> HTTP_OK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> evbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">evhttp_clear_headers</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>http_query<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">evbuffer_free</span><span class="token punctuation">(</span>evbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>

			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//post</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>type <span class="token operator">==</span> EVHTTP_REQ_POST<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">char</span> charadd1<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> charadd2<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword">struct</span> evkeyvalq http_query_post<span class="token punctuation">;</span>
			<span class="token keyword">char</span> decode_post_uri<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> buffer_data_len <span class="token operator">=</span> <span class="token function">EVBUFFER_LENGTH</span><span class="token punctuation">(</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">char</span> <span class="token operator">*</span>post_data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>buffer_data_len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>post_data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buffer_data_len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">memcpy</span><span class="token punctuation">(</span>post_data<span class="token punctuation">,</span> <span class="token function">EVBUFFER_DATA</span><span class="token punctuation">(</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> buffer_data_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span>decode_post_uri<span class="token punctuation">,</span> <span class="token string">"/?%s"</span><span class="token punctuation">,</span> post_data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//处理数据格式</span>
			<span class="token function">evhttp_parse_query</span><span class="token punctuation">(</span>decode_post_uri<span class="token punctuation">,</span> <span class="token operator">&amp;</span>http_query_post<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">strcpy</span><span class="token punctuation">(</span>charadd1<span class="token punctuation">,</span> <span class="token function">evhttp_find_header</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>http_query_post<span class="token punctuation">,</span> <span class="token string">"add1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">strcpy</span><span class="token punctuation">(</span>charadd2<span class="token punctuation">,</span> <span class="token function">evhttp_find_header</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>http_query_post<span class="token punctuation">,</span> <span class="token string">"add2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>charadd1<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">atoi</span><span class="token punctuation">(</span>charadd2<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">struct</span> evbuffer<span class="token operator">*</span> evbuf <span class="token operator">=</span> <span class="token function">evbuffer_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>evbuf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"create evbuffer failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token function">evbuffer_add_printf</span><span class="token punctuation">(</span>evbuf<span class="token punctuation">,</span> <span class="token string">"&lt;!DOCTYPE html&gt;\
							&lt;html&gt;\
							&lt;head&gt;\
							&lt;meta charset = \"utf-8\"&gt;\
							&lt;title&gt;(runoob.com)&lt;/title&gt;\
							&lt;/head&gt;\
							&lt;body&gt;\
							&lt;p&gt;%d&lt;/p&gt;\
							&lt;/body&gt;\
							&lt;/html&gt;"</span><span class="token punctuation">,</span> sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">evhttp_send_reply</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> HTTP_OK<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> evbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">evbuffer_free</span><span class="token punctuation">(</span>evbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>


<span class="token punctuation">}</span>


Myhttpserver<span class="token operator">::</span><span class="token function">Myhttpserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

Myhttpserver<span class="token operator">::</span><span class="token operator">~</span><span class="token function">Myhttpserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> Myhttpserver<span class="token operator">::</span><span class="token function">inithttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">event_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	base <span class="token operator">=</span> <span class="token function">event_base_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>base<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span>errmsg<span class="token punctuation">,</span> <span class="token string">"create event_base failed,error: %s(errno: %d)\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	http <span class="token operator">=</span> <span class="token function">evhttp_new</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>http<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span>errmsg<span class="token punctuation">,</span> <span class="token string">"create evhttp failed,error: %s(errno: %d)\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> Myhttpserver<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">evhttp_bind_socket</span><span class="token punctuation">(</span>http<span class="token punctuation">,</span> <span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span>errmsg<span class="token punctuation">,</span> <span class="token string">"start evhttp failed,error: %s(errno: %d)\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">evhttp_set_timeout</span><span class="token punctuation">(</span>http<span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Myhttpserver<span class="token operator">::</span><span class="token function">set_gencb</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>cb<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> evhttp_request <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">evhttp_set_gencb</span><span class="token punctuation">(</span>http<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Myhttpserver<span class="token operator">::</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">event_base_dispatch</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Myhttpserver<span class="token operator">::</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token keyword">struct</span> event_base<span class="token operator">*</span> base<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">event_base_loopbreak</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">event_base_loopexit</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Myhttpserver<span class="token operator">::</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">evhttp_free</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">event_base_free</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">char</span> <span class="token operator">*</span> Myhttpserver<span class="token operator">::</span><span class="token function">geterrmsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> errmsg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>main.cpp</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">pragma</span> once</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> execution_character_set("utf-8")</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"myhttpserver.h"</span></span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	Myhttpserver httpserver<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>httpserver<span class="token punctuation">.</span><span class="token function">inithttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span>httpserver<span class="token punctuation">.</span><span class="token function">geterrmsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
		
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>httpserver<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span>httpserver<span class="token punctuation">.</span><span class="token function">geterrmsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	httpserver<span class="token punctuation">.</span><span class="token function">set_gencb</span><span class="token punctuation">(</span>HttpGenericCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
	httpserver<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	httpserver<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>Makefile的gcc需要改成g++，否则会出现下面的问题，include和lib就可以编译运行了。<br> <img src="https://images2.imgbox.com/af/16/1Cggri81_o.png" alt="在这里插入图片描述"><br> <strong>Makefile</strong></p> 
<pre><code class="prism language-shell">INCLUDEPATH<span class="token operator">=</span>/usr/libevent/include
LIBPATH<span class="token operator">=</span>/usr/libevent/lib
CC1<span class="token operator">=</span>g++

build:main.o myhttpserver.o
	<span class="token variable"><span class="token variable">$(</span>CC1<span class="token variable">)</span></span> -gdwarf-2 -o HTTPTest main.o myhttpserver.o -I <span class="token variable"><span class="token variable">$(</span>INCLUDEPATH<span class="token variable">)</span></span> -L <span class="token variable"><span class="token variable">$(</span>LIBPATH<span class="token variable">)</span></span> -levent

main.o:main.cpp myhttpserver.h
	<span class="token variable"><span class="token variable">$(</span>CC1<span class="token variable">)</span></span> -gdwarf-2 -c main.cpp -I <span class="token variable"><span class="token variable">$(</span>INCLUDEPATH<span class="token variable">)</span></span> -L <span class="token variable"><span class="token variable">$(</span>LIBPATH<span class="token variable">)</span></span> -levent

myhttpserver.o:myhttpserver.cpp myhttpserver.h
	<span class="token variable"><span class="token variable">$(</span>CC1<span class="token variable">)</span></span> -gdwarf-2 -c myhttpserver.cpp -I <span class="token variable"><span class="token variable">$(</span>INCLUDEPATH<span class="token variable">)</span></span> -L <span class="token variable"><span class="token variable">$(</span>LIBPATH<span class="token variable">)</span></span> -levent

clean:
	<span class="token function">rm</span> *.o HTTPTest
</code></pre> 
<h4><a id="_539"></a>运行展示</h4> 
<p>服务端的<strong>HTTPTest</strong>有这些文件。<br> <img src="https://images2.imgbox.com/c3/4a/HxLcQ8Zz_o.png" alt="在这里插入图片描述"><br> <strong>index.html</strong>内容如下</p> 
<pre><code class="prism language-html"><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>菜鸟教程(runoob.com)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>input<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/add<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
add1: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>add1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
add2: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>add2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>注意：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span> 表单本身是不可见的。并且注意一个文本字段的默认宽度是20个字符。<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><strong>首页</strong><br> <img src="https://images2.imgbox.com/b6/bf/pGyjDVNY_o.png" alt="在这里插入图片描述"><br> <strong>普通文件</strong>展示<br> 打开获取影音需要在html写入连接，不能像图片、gif一样直接打开，否则会跳出下载界面。<br> <img src="https://images2.imgbox.com/26/6e/f0tdbpbA_o.png" alt="在这里插入图片描述"><br> <strong>index</strong>页面<br> <img src="https://images2.imgbox.com/9d/b1/dPM12rfm_o.png" alt="在这里插入图片描述"><br> 点击提交按钮<br> <img src="https://images2.imgbox.com/3b/45/495zl4N1_o.png" alt="在这里插入图片描述"><br> <strong>bye</strong>关闭服务器<br> <img src="https://images2.imgbox.com/65/d5/lqCcW4a2_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/630fd614edd5901a5b12b1c4932e50e7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于LQR的一阶倒立摆控制仿真</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e272bd22fbc773c3a22e4e3eda02f251/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">4、H3C交换机AAA本地用户</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>