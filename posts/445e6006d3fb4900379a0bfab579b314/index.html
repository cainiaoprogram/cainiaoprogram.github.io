<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux下获取时间的方法对比 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux下获取时间的方法对比" />
<meta property="og:description" content="目录 概述Linux下获取时间的方法背景内核函数time&#43; localtime特点范例 gettimeofday &#43; localtime特点范例 clock_gettime &#43; localtime特点范例 rdtsctsc介绍使用rstsc获取代码段的执行时间rdtsc获取时间的优点优点 rdtsc的缺陷rdtsc的进化CPU降频问题 不同Core的TSC同步问题程序乱序执行的问题TSC计数器溢出可能rdtsc 获取程序运行时间的范例 性能对比 linux下配置各个节点的的时间一致性date 命令调整系统时间ntp 调整系统时间ntp 工作原理ntp 报文ntp使用检测 ntp 是否已安装用ntpdate自动更新系统时间用 ntp 搭建自己的时间服务器 参考 概述 linux系统中的时间机制
在linux系统中有两种时钟，一种是硬件时钟，一种是系统时钟。
1.1 The Hardware Clock 硬件时钟跟运行在cpu上的程序是独立不相关的，甚至在服务器关机之后仍然可以正常运行，这就保证了服务器时间的正常运行，硬件时间也有着各种各样的称呼，例如：hardware clock, real time clock, RTC, BIOS clock以及CMOS clock等，在目前主流的服务器都采用RTC芯片实现：
该芯片采用32768HZ的晶振来满足计时的需求，同时拥有独立的电源可以保证断电之后依然可以正常计时，在系统中可以看到硬件时钟的值：
1.2 The System Clock
在linux 内核中还有一个称为系统时钟或者系统时间的概念，这就是我们平时在系统中经常接触到时间，也是应用程序在执行与时间相关的操作会用到的时间，它只是在系统运行时存在，其记录形式为UTC时间（the number of seconds since 00:00:00 January 1, 1970 UTC）。
硬件时钟和系统时间的关系应该如何定义呢？
硬件时钟是用来保证在操作系统关机之后仍然可以正常计时必要硬件，而系统时间是我们在日常操作中才会经常使用到的时间，仅仅在操作系统初始化时，操作系统才会去RTC芯片中拿到硬件时钟的值，之后便是独立运行和独立计时。
由上面的分析，我们可以知道在正常应用中是不会去使用硬件时间，一般都会考虑用系统时间
Linux系统时间分类： （1）日历时间。该值是自协调世界时(UTC)1970年1月1日00:00:00这个特定时间以来所经过的秒数累计值。基本数据类型用time_t保存。最后通过转换才能得到我们平时所看到的24小时制或者12小时间制的时间。
（2）进程时间。也被称为CPU时间，用以度量进程使用的中央处理器资源。进程时间以时钟滴答计算。
进程时间是进程被创建后使用CPU的时间 ，进程时间被分为以下两个部分：
用户CPU时间：在用户态模式下使用CPU的时间
内核CPU时间：在内核态模式下使用CPU的时间。这是执行内核调用或其他特殊任务所需要的时间。
Linux下获取时间的方法 背景 用户空间获取代码段的执行时间。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/445e6006d3fb4900379a0bfab579b314/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-17T10:21:44+08:00" />
<meta property="article:modified_time" content="2023-04-17T10:21:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux下获取时间的方法对比</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">概述</a></li><li><a href="#Linux_33" rel="nofollow">Linux下获取时间的方法</a></li><li><ul><li><a href="#_34" rel="nofollow">背景</a></li><li><a href="#_41" rel="nofollow">内核函数</a></li><li><a href="#time_localtime_124" rel="nofollow">time+ localtime</a></li><li><ul><li><a href="#_125" rel="nofollow">特点</a></li><li><a href="#_129" rel="nofollow">范例</a></li></ul> 
   </li><li><a href="#gettimeofday__localtime_162" rel="nofollow">gettimeofday + localtime</a></li><li><ul><li><a href="#_163" rel="nofollow">特点</a></li><li><a href="#_165" rel="nofollow">范例</a></li></ul> 
   </li><li><a href="#clock_gettime__localtime_197" rel="nofollow">clock_gettime + localtime</a></li><li><ul><li><a href="#_198" rel="nofollow">特点</a></li><li><a href="#_210" rel="nofollow">范例</a></li></ul> 
   </li><li><a href="#rdtsc_278" rel="nofollow">rdtsc</a></li><li><ul><li><a href="#tsc_282" rel="nofollow">tsc介绍</a></li><li><a href="#rstsc_292" rel="nofollow">使用rstsc获取代码段的执行时间</a></li><li><a href="#rdtsc_336" rel="nofollow">rdtsc获取时间的优点</a></li><li><ul><li><a href="#_337" rel="nofollow">优点</a></li></ul> 
    </li><li><a href="#rdtsc_341" rel="nofollow">rdtsc的缺陷</a></li><li><a href="#rdtsc_355" rel="nofollow">rdtsc的进化</a></li><li><ul><li><a href="#CPU_360" rel="nofollow">CPU降频问题</a></li></ul> 
    </li><li><a href="#CoreTSC_372" rel="nofollow">不同Core的TSC同步问题</a></li><li><a href="#_419" rel="nofollow">程序乱序执行的问题</a></li><li><a href="#TSC_485" rel="nofollow">TSC计数器溢出可能</a></li><li><a href="#rdtsc__489" rel="nofollow">rdtsc 获取程序运行时间的范例</a></li></ul> 
   </li><li><a href="#_549" rel="nofollow">性能对比</a></li></ul> 
  </li><li><a href="#linux_663" rel="nofollow">linux下配置各个节点的的时间一致性</a></li><li><ul><li><a href="#date__664" rel="nofollow">date 命令调整系统时间</a></li><li><a href="#ntp__671" rel="nofollow">ntp 调整系统时间</a></li><li><ul><li><a href="#ntp__676" rel="nofollow">ntp 工作原理</a></li><li><a href="#ntp__687" rel="nofollow">ntp 报文</a></li><li><a href="#ntp_715" rel="nofollow">ntp使用</a></li><li><ul><li><a href="#_ntp__716" rel="nofollow">检测 ntp 是否已安装</a></li><li><a href="#ntpdate_724" rel="nofollow">用ntpdate自动更新系统时间</a></li><li><a href="#_ntp__738" rel="nofollow">用 ntp 搭建自己的时间服务器</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#_792" rel="nofollow">参考</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>概述</h2> 
<ul><li>linux系统中的时间机制<br> 在linux系统中有两种时钟，一种是硬件时钟，一种是系统时钟。<br> 1.1 The Hardware Clock</li></ul> 
<p>硬件时钟跟运行在cpu上的程序是独立不相关的，甚至在服务器关机之后仍然可以正常运行，这就保证了服务器时间的正常运行，硬件时间也有着各种各样的称呼，例如：hardware clock, real time clock, RTC, BIOS clock以及CMOS clock等，在目前主流的服务器都采用RTC芯片实现：<br> <img src="https://images2.imgbox.com/6f/e2/JuaCEXOU_o.png" alt="在这里插入图片描述"><br> 该芯片采用32768HZ的晶振来满足计时的需求，同时拥有独立的电源可以保证断电之后依然可以正常计时，在系统中可以看到硬件时钟的值：<br> <img src="https://images2.imgbox.com/99/88/B7Nahc7K_o.png" alt="在这里插入图片描述"></p> 
<p>1.2 The System Clock<br> 在linux 内核中还有一个称为系统时钟或者系统时间的概念，这就是我们平时在系统中经常接触到时间，也是应用程序在执行与时间相关的操作会用到的时间，它只是在系统运行时存在，其记录形式为UTC时间（the number of seconds since 00:00:00 January 1, 1970 UTC）。</p> 
<p>硬件时钟和系统时间的关系应该如何定义呢？</p> 
<p>硬件时钟是用来保证在操作系统关机之后仍然可以正常计时必要硬件，而系统时间是我们在日常操作中才会经常使用到的时间，仅仅在操作系统初始化时，操作系统才会去RTC芯片中拿到硬件时钟的值，之后便是独立运行和独立计时。</p> 
<blockquote> 
 <p>由上面的分析，我们可以知道在正常应用中是不会去使用硬件时间，一般都会考虑用系统时间</p> 
</blockquote> 
<ul><li>Linux系统时间分类：</li></ul> 
<p>（1）日历时间。该值是自协调世界时(UTC)1970年1月1日00:00:00这个特定时间以来所经过的秒数累计值。基本数据类型用time_t保存。最后通过转换才能得到我们平时所看到的24小时制或者12小时间制的时间。</p> 
<p>（2）进程时间。也被称为CPU时间，用以度量进程使用的中央处理器资源。进程时间以时钟滴答计算。<br> 进程时间是进程被创建后使用CPU的时间 ，进程时间被分为以下两个部分：<br> 用户CPU时间：在用户态模式下使用CPU的时间<br> 内核CPU时间：在内核态模式下使用CPU的时间。这是执行内核调用或其他特殊任务所需要的时间。</p> 
<h2><a id="Linux_33"></a>Linux下获取时间的方法</h2> 
<h3><a id="_34"></a>背景</h3> 
<p>用户空间获取代码段的执行时间。</p> 
<blockquote> 
 <p>While user application developers are working on performance sensitive code, one common requirement is do latency/time measurement in their code. This kind of code could be temporary code for debug, test or profiling purpose, or permanent code that could provide performance tracing data in software production mode.</p> 
</blockquote> 
<blockquote> 
 <p>Linux kernel provides gettimeofday() and clock_gettime() system calls for user application high resolution time measurement. The gettimeofday() is us level, and clock_gettime is ns level. However, the major concerns of these system calls usage are the additional performance cost caused by calling themselves.</p> 
</blockquote> 
<blockquote> 
 <p>In order to minimize the perf cost of gettimeofday() and clock_gettime() system calls, Linux kernel uses the vsyscalls(virtual system calls) and VDSOs (Virtual Dynamically linked Shared Objects) mechanisms to avoid the cost of switching from user to kernel. On x86, gettimeofday() and clock_gettime() could get better performance due to vsyscalls kernel patch, by avoiding context switch from user to kernel space. But some other arch still need follow the regular system call code path. This is really hardware dependent optimization.</p> 
</blockquote> 
<h3><a id="_41"></a>内核函数</h3> 
<pre><code class="prism language-c"><span class="token number">1</span><span class="token operator">&gt;</span> 获取时间戳
<span class="token class-name">time_t</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token class-name">time_t</span> <span class="token operator">*</span>calptr<span class="token punctuation">)</span>

<span class="token keyword">int</span> <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token operator">*</span>tp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>tzp<span class="token punctuation">)</span><span class="token punctuation">;</span>
因为历史原因tzp的唯一合法值是<span class="token constant">NULL</span>，因此调用时写入<span class="token constant">NULL</span>即可。

<span class="token keyword">int</span> <span class="token function">clock_gettime</span><span class="token punctuation">(</span><span class="token class-name">clockid_t</span> clock_id<span class="token punctuation">,</span> strcut timespec <span class="token operator">*</span>tsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
clock_id有多个选择，当选择为CLOCK_REALTIME时与time的功能相似，但是时间精度更高。

<span class="token keyword">struct</span> <span class="token class-name">timeval</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">long</span> tv_sec<span class="token punctuation">;</span> <span class="token comment">/*秒*/</span>
	<span class="token keyword">long</span> tv_usec<span class="token punctuation">;</span> <span class="token comment">/*微秒*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">timespec</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">time_t</span> tv_sec<span class="token punctuation">;</span> <span class="token comment">//秒</span>
	<span class="token keyword">long</span> tv_nsec<span class="token punctuation">;</span> <span class="token comment">//纳秒</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token number">2</span><span class="token operator">&gt;</span> 可视化时间
tm结构体
<span class="token keyword">struct</span> <span class="token class-name">tm</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> tm_sec<span class="token punctuation">;</span> <span class="token comment">/*秒，正常范围0-59， 但允许至61*/</span>
	<span class="token keyword">int</span> tm_min<span class="token punctuation">;</span> <span class="token comment">/*分钟，0-59*/</span>
	<span class="token keyword">int</span> tm_hour<span class="token punctuation">;</span> <span class="token comment">/*小时， 0-23*/</span>
	<span class="token keyword">int</span> tm_mday<span class="token punctuation">;</span> <span class="token comment">/*日，即一个月中的第几天，1-31*/</span>
	<span class="token keyword">int</span> tm_mon<span class="token punctuation">;</span> <span class="token comment">/*月， 从一月算起，0-11*/</span> <span class="token number">1</span><span class="token operator">+</span>p<span class="token operator">-</span> tm_mon<span class="token punctuation">;</span>
	<span class="token keyword">int</span> tm_year<span class="token punctuation">;</span> <span class="token comment">/*年， 从1900至今已经多少年*/</span> <span class="token number">1900</span>＋ p<span class="token operator">-</span> tm_year<span class="token punctuation">;</span>
	<span class="token keyword">int</span> tm_wday<span class="token punctuation">;</span> <span class="token comment">/*星期，一周中的第几天， 从星期日算起，0-6*/</span>
	<span class="token keyword">int</span> tm_yday<span class="token punctuation">;</span> <span class="token comment">/*从今年1月1日到目前的天数，范围0-365*/</span>
	<span class="token keyword">int</span> tm_isdst<span class="token punctuation">;</span> <span class="token comment">/*日光节约时间的旗标*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">time_t</span>转成tm<span class="token operator">:</span>
gmtime 和localtime可以将<span class="token class-name">time_t</span>类型的时间戳转为tm结构体，用法如下：
<span class="token keyword">struct</span> <span class="token class-name">tm</span><span class="token operator">*</span> <span class="token function">gmtime</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">time_t</span> <span class="token operator">*</span>timep<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//将time_t表示的时间转换为没有经过时区转换的UTC时间，是一个struct tm结构指针</span>

stuct tm<span class="token operator">*</span> <span class="token function">localtime</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">time_t</span> <span class="token operator">*</span>timep<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//和gmtime功能类似，但是它是经过时区转换的时间，也就是可以转化为北京时间。</span>


<span class="token number">4</span><span class="token operator">&gt;</span>固定格式打印时间
得到tm结构体后，可以将其转为字符串格式的日常使用的时间，或者直接从<span class="token class-name">time_t</span>进行转换，分别可以使用以下两个函数达到目的。不过这两个函数只能打印固定格式的时间。

<span class="token comment">//这两个函数已经被标记为弃用，尽量使用后面将要介绍的函数</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">asctime</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">tm</span><span class="token operator">*</span> timeptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">ctime</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">time_t</span> <span class="token operator">*</span>timep<span class="token punctuation">)</span><span class="token punctuation">;</span>

上述两个函数因为可能出现缓冲区溢出的问题而被标记为弃用，因此更加安全的办法是采用strftime办法。

<span class="token comment">/*
** @buf：存储输出的时间
** @maxsize：缓存区的最大字节长度
** @format：指定输出时间的格式
** @tmptr：指向结构体tm的指针
*/</span>
<span class="token class-name">size_t</span> <span class="token function">strftime</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> maxsize<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">tm</span> <span class="token operator">*</span>tmptr<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token number">6</span><span class="token operator">&gt;</span>进程时间
进程时间是进程被创建后使用CPU的时间 ，进程时间被分为以下两个部分：

用户CPU时间：在用户态模式下使用CPU的时间
内核CPU时间：在内核态模式下使用CPU的时间。这是执行内核调用或其他特殊任务所需要的时间。

clock函数提供了一个简单的接口用于取得进程时间，它返回一个值描述进程使用的总的CPU时间（包括用户时间和内核时间），该函数定义如下：
<span class="token class-name">clock_t</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>；

<span class="token keyword">struct</span> <span class="token class-name">tms</span><span class="token punctuation">{<!-- --></span>
	<span class="token class-name">clock_t</span> tms_utime<span class="token punctuation">;</span>
	<span class="token class-name">clock_t</span> tms_stime<span class="token punctuation">;</span>
	<span class="token class-name">clock_t</span> tms_cutime<span class="token punctuation">;</span>
	<span class="token class-name">clock_t</span> tms_cstime<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d5/00/ZTipX4FF_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="time_localtime_124"></a>time+ localtime</h3> 
<h4><a id="_125"></a>特点</h4> 
<p>time函数返回的是1970年到现在的秒数，精确到秒。<br> localtime函数是根据这个秒数和本机的时区，解析出当期的年月日时分秒等信息。</p> 
<blockquote> 
 <p>注：localtime函数不是多线程安全的，localtime_r才是。</p> 
</blockquote> 
<h4><a id="_129"></a>范例</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>

<span class="token comment">// gcc -o time_1 time_1.c</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">time_t</span> tm_now<span class="token punctuation">;</span>

    <span class="token function">time</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tm_now<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 或者写成 tm_now = time(NULL);</span>

    <span class="token comment">//1.直接打印：1970-1-1,00:00:00到现在的秒数</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"now time is %ld second\n"</span><span class="token punctuation">,</span> tm_now<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2.转换成本地时间，精确到秒</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span> <span class="token operator">*</span>p_local_tm <span class="token punctuation">;</span>
    p_local_tm <span class="token operator">=</span> <span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tm_now<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"now datetime: %04d-%02d-%02d %02d:%02d:%02d\n"</span><span class="token punctuation">,</span>
        p_local_tm<span class="token operator">-&gt;</span>tm_year<span class="token operator">+</span><span class="token number">1900</span><span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_mon<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_mday<span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_hour<span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_min<span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/79/8f/pZBoGLCQ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="gettimeofday__localtime_162"></a>gettimeofday + localtime</h3> 
<h4><a id="_163"></a>特点</h4> 
<p>gettimeofday可以精确到微秒（us），还可以指定时区，性能也还可以，可以满足绝大多数场景，因此叫傻瓜版。</p> 
<h4><a id="_165"></a>范例</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>

<span class="token comment">// gcc -o time_2 time_2.c</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> tm_now<span class="token punctuation">;</span>

    <span class="token comment">//1.获取当前时间戳(tv_sec, tv_usec)</span>
    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tm_now<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第二个参数是时区</span>

    <span class="token comment">//2.转换成本地时间，精确到秒</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span> <span class="token operator">*</span>p_local_tm<span class="token punctuation">;</span>
    p_local_tm <span class="token operator">=</span> <span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tm_now<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"now datetime: %04d-%02d-%02d %02d:%02d:%02d.%06ld\n"</span><span class="token punctuation">,</span>
        p_local_tm<span class="token operator">-&gt;</span>tm_year<span class="token operator">+</span><span class="token number">1900</span><span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_mon<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_mday<span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_hour<span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_min<span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_sec<span class="token punctuation">,</span>
        tm_now<span class="token punctuation">.</span>tv_usec<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 有微秒时间戳了</span>
 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/59/db/5Evi4LVl_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="clock_gettime__localtime_197"></a>clock_gettime + localtime</h3> 
<h4><a id="_198"></a>特点</h4> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">clock_gettime</span><span class="token punctuation">(</span><span class="token class-name">clockid_t</span> clk_id<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timespec</span> <span class="token operator">*</span>tp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>clock_gettime 可以精确到纳秒（ns）函数精度不错，功能完备，但却存在一个突出缺点–慢。</p> 
<p>clock_gettime的第一个参数可以指定一个clock_id参数:<br> 常见的有两个：</p> 
<ol><li>CLOCK_REALTIME<br> 即普通的时间，跟其他时间函数取出来的时间并无区别。</li><li>CLOCK_MONOTONIC<br> 即单调时间，跟系统的启动时间有关，不受手动修改系统时间的影响。</li></ol> 
<h4><a id="_210"></a>范例</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>

<span class="token comment">// gcc -o time_3 time_3.c</span>

<span class="token keyword">void</span> <span class="token function">print_timestamp</span><span class="token punctuation">(</span><span class="token keyword">int</span> use_monotonic<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">timespec</span> tm_now<span class="token punctuation">;</span>

    <span class="token comment">//1.获取当前时间戳(tv_sec, tv_usec)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>use_monotonic<span class="token punctuation">)</span>
        <span class="token function">clock_gettime</span><span class="token punctuation">(</span>CLOCK_MONOTONIC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm_now<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 单调时间，屏蔽手动修改时间</span>
    <span class="token keyword">else</span>
        <span class="token function">clock_gettime</span><span class="token punctuation">(</span>CLOCK_REALTIME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm_now<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 机器时间</span>

    <span class="token comment">//2.转换成本地时间，精确到秒</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span> <span class="token operator">*</span>p_local_tm<span class="token punctuation">;</span>
    p_local_tm <span class="token operator">=</span> <span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tm_now<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"now datetime: %04d-%02d-%02d %02d:%02d:%02d.%09ld\n"</span><span class="token punctuation">,</span>
        p_local_tm<span class="token operator">-&gt;</span>tm_year<span class="token operator">+</span><span class="token number">1900</span><span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_mon<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_mday<span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_hour<span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_min<span class="token punctuation">,</span> 
        p_local_tm<span class="token operator">-&gt;</span>tm_sec<span class="token punctuation">,</span>
        tm_now<span class="token punctuation">.</span>tv_nsec<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 有纳秒时间戳了</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> use_monotonic <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> optval  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>optval <span class="token operator">=</span> <span class="token function">getopt</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"Mm"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>optval<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> <span class="token char">'M'</span><span class="token operator">:</span>
			<span class="token keyword">case</span> <span class="token char">'m'</span><span class="token operator">:</span>
                use_monotonic <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">print_timestamp</span><span class="token punctuation">(</span>use_monotonic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果分析：<br> <img src="https://images2.imgbox.com/04/fd/LMp4vCfM_o.png" alt="在这里插入图片描述"><br> 如上图，表示系统已经启动了24:09（8点是因为我们在东8区）。</p> 
<p><img src="https://images2.imgbox.com/c7/8a/e5WVFs45_o.png" alt="在这里插入图片描述"><br> 我们用date命令将时间往回修改，观察两者的输出结果：<br> <img src="https://images2.imgbox.com/ae/a5/GjOxA1YP_o.png" alt="在这里插入图片描述"><br> 可以看到，指定为REAL_TIME的函数出现了时间回退（上图），指定为CLOCK_MONOTONIC的函数一直在单调流逝（下图）：<br> <img src="https://images2.imgbox.com/a8/1c/UNAt1XfM_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="rdtsc_278"></a>rdtsc</h3> 
<p>Although vsyscalls implementation of gettimeofday() and clock_gettime() is faster than regular system calls, the perf cost of them is still too high to meet the latency measurement requirements for some perf sensitive application.</p> 
<p>The TSC (time stamp counter) provided by x86 processors is a high-resolution counter that can be read with a single instruction (RDTSC). On Linux this instruction could be executed from user space directly, that means user applications could use one single instruction to get a fine-grained timestamp (nanosecond level) with a much faster way than vsyscalls.</p> 
<h4><a id="tsc_282"></a>tsc介绍</h4> 
<p>TSC的全称是Time Stamp Counter，它是一个64位的寄存器，每个Core有一个这样的寄存器，保存着CPU自开机启动以来的运转时钟周期数，在X86等平台下均有提供。通过专门的rdtsc汇编指令，即通过rdtsc指令，可绕过操作系统内核直接从寄存器中读取将TSC的数值存放在EDX:EAX中，示例代码如下：</p> 
<pre><code class="prism language-c"><span class="token class-name">uint64_t</span> <span class="token function">get_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint64_t</span> a<span class="token punctuation">,</span> d<span class="token punctuation">;</span>
    __asm__ <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"rdtsc"</span> <span class="token operator">:</span> <span class="token string">"=a"</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=d"</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>d <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="rstsc_292"></a>使用rstsc获取代码段的执行时间</h4> 
<p>The result of rdtsc is CPU cycle, that could be converted to nanoseconds by a simple calculation.</p> 
<blockquote> 
 <p>ns = CPU cycles * (ns_per_sec / CPU freq)</p> 
</blockquote> 
<p>In Linux kernel, it uses more complex way to get a better results,</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * Accelerators for sched_clock()
 * convert from cycles(64bits) =&gt; nanoseconds (64bits)
 *  basic equation:
 *              ns = cycles / (freq / ns_per_sec)
 *              ns = cycles * (ns_per_sec / freq)
 *              ns = cycles * (10^9 / (cpu_khz * 10^3))
 *              ns = cycles * (10^6 / cpu_khz)
 *
 *      Then we use scaling math (suggested by george@mvista.com) to get:
 *              ns = cycles * (10^6 * SC / cpu_khz) / SC
 *              ns = cycles * cyc2ns_scale / SC
 *
 *      And since SC is a constant power of two, we can convert the div
 *  into a shift.
 *
 *  We can use khz divisor instead of mhz to keep a better precision, since
 *  cyc2ns_scale is limited to 10^6 * 2^10, which fits in 32 bits.
 *  (mathieu.desnoyers@polymtl.ca)
 *
 *                      -johnstul@us.ibm.com "math is hard, lets go shopping!"
 */</span>
</code></pre> 
<p>Finally, the code of latency measurement could be,</p> 
<pre><code class="prism language-c">start <span class="token operator">=</span> <span class="token function">rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* put code you want to measure here */</span>

end <span class="token operator">=</span> <span class="token function">rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cycle <span class="token operator">=</span> end <span class="token operator">-</span> start<span class="token punctuation">;</span>

latency <span class="token operator">=</span> <span class="token function">cycle_2_ns</span><span class="token punctuation">(</span>cycle<span class="token punctuation">)</span>
</code></pre> 
<p>In fact, above rdtsc implementation are problematic, and not encouraged by Linux kernel. The major reason is, TSC mechanism is rather unreliable, and even Linux kernel had the hard time to handle it.</p> 
<p>That is why Linux kernel does not provide the rdtsc api to user application. However, Linux kernel does not limit the rdtsc instruction to be executed at privilege level, although x86 support the setup. That means, there is nothing stopping Linux application read TSC directly by above implementation, but these applications have to prepare to handle some strange TSC behaviors due to some known pitfalls.</p> 
<h4><a id="rdtsc_336"></a>rdtsc获取时间的优点</h4> 
<h5><a id="_337"></a>优点</h5> 
<p>性能高：绕过内核直接读寄存器，开销很小<br> 精度高：时间测量的最小单位是1/CPU频率秒，可达0.3纳秒（假设CPU频率为3GHz）</p> 
<h4><a id="rdtsc_341"></a>rdtsc的缺陷</h4> 
<p>RDTSC 一般的用法是，先后执行两次，记下两个 64-bit 整数 start 和 end，那么 end-start 代表了这期间 CPU 的时钟周期数。这其中涉及到3个问题：</p> 
<ul><li>在多核下，这两次执行可能会在两个 CPU 上发生，而这两个 CPU 的计数器的初值不一定相同（由于完成上电复位的准确时机不同）。</li><li>对于计时这个用途，时间 = 周期数 / 频率，由于频率可能会变（比如我的笔记本的 CPU 通常半速运行在 800MHz，繁忙的时候全速运行在 1.6GHz），那么测得的时间也就不准确了。还有一个可能是掉电之后恢复（比如休眠），那么 TSC 会清零。 总之，用 RDTSC 来计时是不灵的。</li><li>Intel的处理器自Pentium Pro开始，引入了乱序执行的功能，导致程序读取的TSC结果可能不准。如果编写测试程序的时候没有主动回避，也可能会掉到坑里。</li></ul> 
<p>总结起来，rdtsc的可能问题有：</p> 
<ul><li>不同core上TSC同步问题<br> 不能保证同一块主板上每个核的 TSC 是同步的；</li><li>CPU降频问题<br> CPU 的时钟频率可能变化，例如笔记本电脑的节能功能；</li><li>程序乱序执行问题<br> 乱序执行导致 RDTSC 测得的周期数不准，这个问题从 Pentium Pro 时代就存在。</li></ul> 
<h4><a id="rdtsc_355"></a>rdtsc的进化</h4> 
<p><img src="https://images2.imgbox.com/21/00/x7MP0oVI_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/48/fb/8R2UX6m2_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e9/04/8CJEXHxv_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="CPU_360"></a>CPU降频问题</h5> 
<p>第一代TSC的实现是Varient TSC，没有考虑到降频的问题，故在低功耗TSC计数会变慢，甚至停止；后来又有了Constant TSC，解决了降频的问题，但在DEEP-C状态下依然会发生停止计数的情况，所以又有了最新的Invariant TSC的特性。</p> 
<ul><li>常量速率TSC（constant-tsc）<br> 支持该特性的CPU，其TSC是按照其标称频率流逝的，与CPU的实际工作频率与状态无关。如果你的CPU也是支持constant_tsc特性的, 可以解决CPU 的时钟频率可能变化导致计时不准的问题。</li></ul> 
<p>可以通过如下命令查看你的CPU是否支持(我的机器有四个核，因此输出了四条)：<br> <img src="https://images2.imgbox.com/ca/bd/zDGPXCfm_o.png" alt="在这里插入图片描述"></p> 
<ul><li>Invariant TSC</li></ul> 
<blockquote> 
 <p>The time stamp counter in newer processors may support an enhancement, referred to as invariant TSC. Processor’s support for invariant TSC is indicated by CPUID.80000007H:EDX[8]. The invariant TSC will run at a constant rate in all ACPI P-, C-. and T-states. This is the architectural behavior moving forward. On processors with invariant TSC support, the OS may use the TSC for wall clock timer services (instead of ACPI or HPET timers). TSC reads are much more efficient and do not incur the overhead associated with a ring transition or access to a platform resource.</p> 
</blockquote> 
<h4><a id="CoreTSC_372"></a>不同Core的TSC同步问题</h4> 
<p>在Linux内核源码（Linux Source）linux/arch/x86/kernel/tsc_sync.c中,有一个unsynchronized_tsc()函数，用于判断系统的TSC是不是同步的，代码实现如下：</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * Make an educated guess if the TSC is trustworthy and synchronized
 * over all CPUs.
 */</span>
<span class="token keyword">int</span> <span class="token function">unsynchronized_tsc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">boot_cpu_has</span><span class="token punctuation">(</span>X86_FEATURE_TSC<span class="token punctuation">)</span> <span class="token operator">||</span> tsc_unstable<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_SMP</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">apic_is_clustered_box</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">boot_cpu_has</span><span class="token punctuation">(</span>X86_FEATURE_CONSTANT_TSC<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>tsc_clocksource_reliable<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	 * Intel systems are normally all synchronized.
	 * Exceptions must mark TSC as unstable:
	 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>boot_cpu_data<span class="token punctuation">.</span>x86_vendor <span class="token operator">!=</span> X86_VENDOR_INTEL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">/* assume multi socket systems are not synchronized: */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">num_possible_cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里有几个有意思的点：</p> 
<ul><li>开头的注释说，“make an educated guess”，即有根据的猜测，即这里是不是TSC同步的判断依然是一个猜测</li><li>中间的代码判断了是否开启了CONSTANT TSC特性，如果开启就直接返回0，即TSC是同步的，也就是说，只要我们在cpuinfo里看到constant_tsc的flag，就证明我们的机器的TSC是同步的</li><li>后面还有一句注释“Intel systems are normally all synchronized.Exceptions must mark TSC as unstable:”，即Intel的系统，只要用户没有手动禁用TSC同步，一般都是同步的。</li><li>在Intel CPU下还有一个注释“assume multi socket systems are not synchronized”，即在多处理器系统上，不同CPU（处理器、socket、NUMA节点）之间的TSC是不同步的。</li></ul> 
<p>看到这里，我们基本上可以确定了，即：</p> 
<ul><li>如果你的cpuinfo里有constant_tsc的flag，那么无论在同一CPU不同核心之间，还是在不同CPU的不同核心之间，TSC都是同步的，可以随便用</li><li>如果你用的是Intel的CPU，但是cpuinfo里没有constant_tsc的flag，那么在同一处理器的不同核心之间，TSC仍然是同步的，但是不同CPU的不同核心之间不同步，尽量不要用.</li></ul> 
<h4><a id="_419"></a>程序乱序执行的问题</h4> 
<p>乱序执行问题，可以使用RDTSCP命令来代替RDTSC，前者开销虽然略高，但胜在稳定好用。另外，如果不想用这个指令，还可以用memory barrier技术或者CPUID指令来实现。<br> 下面这个程序可以用来测试RDTSC和RDTSCP指令的性能：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>

<span class="token comment">// gcc -o time_6 time_6.c</span>

<span class="token class-name">uint64_t</span> <span class="token function">get_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint64_t</span> a<span class="token punctuation">,</span> d<span class="token punctuation">;</span>
    __asm__ <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"rdtsc"</span> <span class="token operator">:</span> <span class="token string">"=a"</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=d"</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>d <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint64_t</span> <span class="token function">get_tscp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint64_t</span> a<span class="token punctuation">,</span> d<span class="token punctuation">;</span>
    __asm__ <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"rdtscp"</span> <span class="token operator">:</span> <span class="token string">"=a"</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=d"</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>d <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOOP_TIMES</span> <span class="token expression"><span class="token number">1000000000</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint64_t</span> beg_tsc<span class="token punctuation">,</span> end_tsc<span class="token punctuation">;</span>
    <span class="token keyword">long</span> loop<span class="token punctuation">;</span>
    <span class="token keyword">long</span> sum<span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------------rdtsc-------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loop <span class="token operator">=</span> LOOP_TIMES<span class="token punctuation">;</span>
    sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>loop<span class="token operator">--</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        beg_tsc <span class="token operator">=</span> <span class="token function">get_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        end_tsc <span class="token operator">=</span> <span class="token function">get_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sum <span class="token operator">+=</span> <span class="token punctuation">(</span>end_tsc <span class="token operator">-</span> beg_tsc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"AVG_CYCLE : %ld\n"</span><span class="token punctuation">,</span> sum <span class="token operator">/</span> LOOP_TIMES<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------------rdtscp-------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loop <span class="token operator">=</span> LOOP_TIMES<span class="token punctuation">;</span>
    sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>loop<span class="token operator">--</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        beg_tsc <span class="token operator">=</span> <span class="token function">get_tscp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        end_tsc <span class="token operator">=</span> <span class="token function">get_tscp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sum <span class="token operator">+=</span> <span class="token punctuation">(</span>end_tsc <span class="token operator">-</span> beg_tsc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"AVG_CYCLE : %ld\n"</span><span class="token punctuation">,</span> sum <span class="token operator">/</span> LOOP_TIMES<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/69/39/ujuh7OXY_o.png" alt="在这里插入图片描述"><br> 我一共跑了三次，每次差别都不大，RDTSCP指令比RDTSC多耗费10个指令周期左右，慢不到1倍。如果你能接受这点差别，建议还是用RDTSCP命令吧。</p> 
<p>另外，RDTSCP指令也是需要平台支持的，是否支持可以使用cat /proc/cpuinfo | grep rdtscp命令查看。</p> 
<h4><a id="TSC_485"></a>TSC计数器溢出可能</h4> 
<p>计算器本身是64位的，即使是主频4G的CPU，也要100多年才会溢出，对于我们的测量来说可以不用考虑。</p> 
<h4><a id="rdtsc__489"></a>rdtsc 获取程序运行时间的范例</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span> <span class="token comment">// for atof</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span> <span class="token comment">// for uint64_t</span></span>

<span class="token comment">// gcc -o time_4 time_4.c</span>

<span class="token comment">//获取CPU频率</span>
<span class="token class-name">uint64_t</span> <span class="token function">get_cpu_freq</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FILE <span class="token operator">*</span>fp<span class="token operator">=</span><span class="token function">popen</span><span class="token punctuation">(</span><span class="token string">"lscpu | grep CPU | grep MHz | awk  {'print $3'}"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> cpu_mhz_str<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span>cpu_mhz_str<span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">atof</span><span class="token punctuation">(</span>cpu_mhz_str<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//读取时间戳寄存器</span>
<span class="token class-name">uint64_t</span> <span class="token function">get_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// TSC == Time Stamp Counter寄存器</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__i386__</span></span>
    <span class="token class-name">uint64_t</span> x<span class="token punctuation">;</span>
    __asm__ <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"rdtsc"</span> <span class="token operator">:</span> <span class="token string">"=A"</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> x<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__amd64__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span></span></span>
    <span class="token class-name">uint64_t</span> a<span class="token punctuation">,</span> d<span class="token punctuation">;</span>
    __asm__ <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"rdtsc"</span> <span class="token operator">:</span> <span class="token string">"=a"</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=d"</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>d <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> a<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">// ARM架构CPU</span></span>
    <span class="token class-name">uint32_t</span> cc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    __asm__ <span class="token keyword">volatile</span> <span class="token punctuation">(</span><span class="token string">"mrc p15, 0, %0, c9, c13, 0"</span><span class="token operator">:</span><span class="token string">"=r"</span> <span class="token punctuation">(</span>cc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span>cc<span class="token punctuation">;</span> 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint64_t</span> cpu_freq <span class="token operator">=</span> <span class="token function">get_cpu_freq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"cpu_freq is %lu\n"</span><span class="token punctuation">,</span> cpu_freq<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">uint64_t</span> last_tsc <span class="token operator">=</span> <span class="token function">get_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">uint64_t</span> cur_tsc <span class="token operator">=</span> <span class="token function">get_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TICK(s)   : %lu\n"</span><span class="token punctuation">,</span> cur_tsc <span class="token operator">-</span> last_tsc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Second(s) : %.02lf\n"</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">*</span> <span class="token punctuation">(</span>cur_tsc <span class="token operator">-</span> last_tsc<span class="token punctuation">)</span> <span class="token operator">/</span> cpu_freq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        last_tsc <span class="token operator">=</span> cur_tsc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="_549"></a>性能对比</h3> 
<p>写了一个测试程序，跑10亿次，取平均时间，分别测试几个函数的性能：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>

<span class="token comment">// gcc -o time_5 time_5.c</span>

<span class="token class-name">uint64_t</span> <span class="token function">get_by_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">time_t</span> tm_now<span class="token punctuation">;</span>
    <span class="token function">time</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tm_now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> tm_now<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint64_t</span> <span class="token function">get_by_gettimeofday</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> tm_now<span class="token punctuation">;</span>
    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tm_now<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> tm_now<span class="token punctuation">.</span>tv_sec<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint64_t</span> <span class="token function">get_by_clock_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">timespec</span> tm_now<span class="token punctuation">;</span>
    <span class="token function">clock_gettime</span><span class="token punctuation">(</span>CLOCK_REALTIME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm_now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> tm_now<span class="token punctuation">.</span>tv_sec<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint64_t</span> <span class="token function">get_cpu_freq</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FILE <span class="token operator">*</span>fp<span class="token operator">=</span><span class="token function">popen</span><span class="token punctuation">(</span><span class="token string">"lscpu | grep CPU | grep MHz | awk  {'print $3'}"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> cpu_mhz_str<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span>cpu_mhz_str<span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">atof</span><span class="token punctuation">(</span>cpu_mhz_str<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint64_t</span> <span class="token function">get_by_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint64_t</span> a<span class="token punctuation">,</span> d<span class="token punctuation">;</span>
    __asm__ <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"rdtsc"</span> <span class="token operator">:</span> <span class="token string">"=a"</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=d"</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>d <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">print_diff</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span> loop_times<span class="token punctuation">,</span> <span class="token class-name">uint64_t</span> beg_tsc<span class="token punctuation">,</span> <span class="token class-name">uint64_t</span> end_tsc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>   
    <span class="token keyword">double</span> tt_ns <span class="token operator">=</span> <span class="token punctuation">(</span>end_tsc <span class="token operator">-</span> beg_tsc<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token function">get_cpu_freq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Number Loop :   %lu\n"</span><span class="token punctuation">,</span> loop_times<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Total Time  :   %.02lf ns\n"</span><span class="token punctuation">,</span> tt_ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Avg Time    :   %.02lf ns\n"</span><span class="token punctuation">,</span> tt_ns <span class="token operator">/</span> loop_times<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOOP_TIMES</span> <span class="token expression"><span class="token number">1000000000</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint64_t</span> beg_tsc<span class="token punctuation">,</span> end_tsc<span class="token punctuation">;</span>
    <span class="token keyword">long</span> loop<span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------------time()-------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loop <span class="token operator">=</span> LOOP_TIMES<span class="token punctuation">;</span>
    beg_tsc <span class="token operator">=</span> <span class="token function">get_by_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">while</span><span class="token punctuation">(</span>loop<span class="token operator">--</span><span class="token punctuation">)</span>
        <span class="token function">get_by_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    end_tsc <span class="token operator">=</span> <span class="token function">get_by_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print_diff</span><span class="token punctuation">(</span>LOOP_TIMES<span class="token punctuation">,</span> beg_tsc<span class="token punctuation">,</span> end_tsc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------------gettimeofday()-------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loop <span class="token operator">=</span> LOOP_TIMES<span class="token punctuation">;</span>
    beg_tsc <span class="token operator">=</span> <span class="token function">get_by_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">while</span><span class="token punctuation">(</span>loop<span class="token operator">--</span><span class="token punctuation">)</span>
        <span class="token function">get_by_gettimeofday</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    end_tsc <span class="token operator">=</span> <span class="token function">get_by_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print_diff</span><span class="token punctuation">(</span>LOOP_TIMES<span class="token punctuation">,</span> beg_tsc<span class="token punctuation">,</span> end_tsc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------------clock_gettime()-------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loop <span class="token operator">=</span> LOOP_TIMES<span class="token punctuation">;</span>
    beg_tsc <span class="token operator">=</span> <span class="token function">get_by_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">while</span><span class="token punctuation">(</span>loop<span class="token operator">--</span><span class="token punctuation">)</span>
        <span class="token function">get_by_clock_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    end_tsc <span class="token operator">=</span> <span class="token function">get_by_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print_diff</span><span class="token punctuation">(</span>LOOP_TIMES<span class="token punctuation">,</span> beg_tsc<span class="token punctuation">,</span> end_tsc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------------rdtsc-------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loop <span class="token operator">=</span> LOOP_TIMES<span class="token punctuation">;</span>
    beg_tsc <span class="token operator">=</span> <span class="token function">get_by_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">while</span><span class="token punctuation">(</span>loop<span class="token operator">--</span><span class="token punctuation">)</span>
        <span class="token function">get_by_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    end_tsc <span class="token operator">=</span> <span class="token function">get_by_tsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print_diff</span><span class="token punctuation">(</span>LOOP_TIMES<span class="token punctuation">,</span> beg_tsc<span class="token punctuation">,</span> end_tsc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/23/e6/DTDfwPHT_o.png" alt="在这里插入图片描述"><br> 可以看到：</p> 
<ul><li>time函数最快，但是精度太低</li><li>gettimeofday和clock_gettime虽然精度高，但是都比较慢</li><li>rdtsc精度和速度都十分优秀</li></ul> 
<p>另外需要注意一点的是，上述测试结果跟机器配置有很大关系，我测试所用的机器是一台ubuntu虚拟机，CPU只有1.8GHz。</p> 
<p>关于这个测试结果，还有很多内容未明确，比如time为什么这么快，gettimeofday不是有缓存么？为啥还这么慢？clock_gettime按说应该比gettimeofday慢的，怎么测试结果并非如此呢？rdtsc在各个出错场景下究竟是怎样具体的现象？上述的测试方法是否科学等。这些问题留待后续补全。</p> 
<h2><a id="linux_663"></a>linux下配置各个节点的的时间一致性</h2> 
<h3><a id="date__664"></a>date 命令调整系统时间</h3> 
<pre><code class="prism language-c">date #查看当前系统时间和日期
date <span class="token operator">-</span>s <span class="token number">02</span><span class="token operator">/</span><span class="token number">21</span><span class="token operator">/</span><span class="token number">2019</span> #设置日期<span class="token punctuation">,</span>例如将系统日期设定成 <span class="token number">2019</span> 年 <span class="token number">02</span> 月 <span class="token number">21</span> 日
date <span class="token operator">-</span>s <span class="token number">19</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">45</span> #设置时分秒，例如将系统时间设定成 <span class="token number">19</span> 点 <span class="token number">21</span> 分 <span class="token number">45</span> 秒
hwclock <span class="token operator">-</span>w #将当前时间和日期写入 BIOS，即设置为硬件时间，避免重启后失效
</code></pre> 
<h3><a id="ntp__671"></a>ntp 调整系统时间</h3> 
<p>NTP（Network Time Protocol，网络时间协议），用来在分布式时间服务器和客户端之间进行时间同步。NTP基于UDP报文进行传输，使用的UDP端口号为123。它提供高精准度的时间校正（LAN 上与标准间差小于1毫秒，WAN 上几十毫秒），且可通过加密确认的方式来防止恶毒的协议攻击。</p> 
<p>使用NTP的目的是对网络内所有具有时钟的设备进行时钟同步，使网络内所有设备的时钟保持一致，从而使设备能够提供基于统一时间的多种应用。对于运行NTP的本地系统，既可以接收来自其他时钟源的同步，又可以作为时钟源同步其他的时钟，并且可以和其他设备互相同步。</p> 
<h4><a id="ntp__676"></a>ntp 工作原理</h4> 
<p>NTP的基本工作原理如图所示。Device A和Device B通过网络相连，它们都有自己独立的系统时钟，需要通过NTP实现各自系统时钟的自动同步。为便于理解，作如下假设：<br> 　　在Device A和Device B的系统时钟同步之前，Device A的时钟设定为10:00:00am，Device B的时钟设定为11:00:00am。NTP报文在Device A和Device B之间单向传输所需要的时间为1秒。<br> <img src="https://images2.imgbox.com/e3/ca/lwCLvTE0_o.png" alt="在这里插入图片描述"></p> 
<ul><li>Device A发送一个NTP报文给Device B，该报文带有它离开Device A时的时间戳，该时间戳为10:00:00am（T1）。</li><li>当此NTP报文到达Device B时，Device B加上自己的时间戳，该时间戳为11:00:01am（T2）。</li><li>当此NTP报文离开Device B时，Device B再加上自己的时间戳，该时间戳为11:00:02am（T3）。</li><li>当Device A接收到该响应报文时，Device A的本地时间为10:00:03am（T4）。</li><li>至此，Device A已经拥有足够的信息来计算两个重要的参数：<br> NTP报文的往返时延Delay=（T4-T1）-（T3-T2）=2秒。<br> Device A相对Device B的时间差offset=（（T2-T1）+（T3-T4））/2=1小时。</li></ul> 
<h4><a id="ntp__687"></a>ntp 报文</h4> 
<p><img src="https://images2.imgbox.com/7f/20/gXGqYDGs_o.png" alt="在这里插入图片描述"><br> 其中192.10.10.189为NTP的server端，192.10.10.32为client端。<br> <img src="https://images2.imgbox.com/40/05/afwB3Ks4_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bb/cf/7Ul5nC0e_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/25/d2/poMBFNCl_o.png" alt="在这里插入图片描述"><br> 客户端和服务端都有一个时间轴，分别代表着各自系统的时间，当客户端想要同步服务端的时间时，客户端会构造一个NTP协议包发送到NTP服务端，客户端会记下此时发送的时间t0，经过一段网络延时传输后，服务器在t1时刻收到数据包，经过一段时间处理后在t2时刻向客户端返回数据包，再经过一段网络延时传输后客户端在t3时刻收到NTP服务器数据包。t0和t3是客户端时间系统的时间、t1和t2是NTP服务端时间系统的时间，它们是有区别的。</p> 
<p>t0、t1、t2分别对应着server-&gt;cient NTP报文中的三个参数：<br> t0：origin timestamp<br> t1: receive timestamp<br> t2: transmit timestamp<br> t3为client收到回复报文时本地的时间。</p> 
<ul><li> <p>延时和时间偏差计算<br> 假设：客户端与服务端的时间系统的偏差定义为θ、网络的往/返延迟(单程延时)定义为δ。<br> 推导过程：<br> 1）根据交互原理，可以列出方程组：<br> t0+θ+δ=t1<br> t2-θ+δ=t3<br> 2）求解方程组，得到以下结果：<br> θ=(t1-t0+t2-t3)/2<br> δ=(t1-t0+t3-t2)/2<br> 记忆时可以采用极限法，分别假设延时和偏差为0.</p> </li><li> <p>client时间校准：<br> 对于时间要求不那么精准设备，client端可把server端的返回时间t2固化为本地时间。但是作为一个标准的通信协议，必须计算上网络的传输延时，需要把t2+δ 固化为本地时间。</p> </li></ul> 
<h4><a id="ntp_715"></a>ntp使用</h4> 
<h5><a id="_ntp__716"></a>检测 ntp 是否已安装</h5> 
<pre><code class="prism language-c">rpm <span class="token operator">-</span>qa <span class="token operator">|</span> grep ntp #检查命令

若只有 ntpdate 而未见 ntp，则需删除原有 ntpdate：
rpm <span class="token operator">-</span>e ntpdate<span class="token operator">-</span><span class="token number">4.2</span><span class="token number">.6</span>p5<span class="token operator">-</span><span class="token number">22.</span>el7<span class="token punctuation">.</span>x86_64 #删除 ntpdate
</code></pre> 
<h5><a id="ntpdate_724"></a>用ntpdate自动更新系统时间</h5> 
<ul><li>采用微软的校时服务器调整系统时间</li></ul> 
<pre><code class="prism language-c">yum install <span class="token operator">-</span>y ntp #安装 ntp 服务器
ntpdate time<span class="token punctuation">.</span>windows<span class="token punctuation">.</span>com #采用微软的校时服务器调整系统时间
</code></pre> 
<p>出现如下图所示内容，说明已经同步成功了。<br> <img src="https://images2.imgbox.com/b2/85/mvGfDKuL_o.png" alt="在这里插入图片描述"></p> 
<ul><li>设置自动同步，同步频率：每十分钟同步一次</li></ul> 
<pre><code class="prism language-c">crontab <span class="token operator">-</span>e #编辑crontab
<span class="token operator">*</span><span class="token operator">/</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>ntpdate time<span class="token punctuation">.</span>windows<span class="token punctuation">.</span>com <span class="token operator">&gt;&gt;</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>crontab<span class="token punctuation">.</span>log
</code></pre> 
<h5><a id="_ntp__738"></a>用 ntp 搭建自己的时间服务器</h5> 
<p>示例环境：主节点 IP-192.168.61.250，子节点 IP-192.168.61.251。</p> 
<ul><li>安装ntp</li></ul> 
<pre><code class="prism language-c">yum install <span class="token operator">-</span>y ntp ntpdate
</code></pre> 
<ul><li>配置 ntp 服务器</li></ul> 
<pre><code class="prism language-c">vi <span class="token operator">/</span>etc<span class="token operator">/</span>ntp<span class="token punctuation">.</span>conf
#注释掉 server <span class="token number">0</span> <span class="token operator">~</span> n，并在 server 部分添加 server 和 fudge行
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">server</span> <span class="token expression"><span class="token number">0.</span>centos<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>ntp<span class="token punctuation">.</span>org iburst </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">server</span> <span class="token expression"><span class="token number">1.</span>centos<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>ntp<span class="token punctuation">.</span>org iburst </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">server</span> <span class="token expression"><span class="token number">2.</span>centos<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>ntp<span class="token punctuation">.</span>org iburst </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">server</span> <span class="token expression"><span class="token number">3.</span>centos<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>ntp<span class="token punctuation">.</span>org iburst </span></span>
server <span class="token number">127.127</span><span class="token number">.1</span><span class="token number">.0</span> #使用本地时钟作为ntp服务器时间，这里的 <span class="token number">127.127</span><span class="token number">.1</span><span class="token number">.0</span> 在 ntp 中代表本机 
fudge <span class="token number">127.127</span><span class="token number">.1</span><span class="token number">.0</span> stratum <span class="token number">10</span> #<span class="token number">127.127</span><span class="token number">.1</span><span class="token number">.0</span> 为第<span class="token number">10</span>层，ntp 和<span class="token number">127.127</span><span class="token number">.1</span><span class="token number">.0</span>同步完后，就变成了 <span class="token number">11</span> 层
</code></pre> 
<ul><li>配置ntp客户端</li></ul> 
<pre><code class="prism language-c">vi <span class="token operator">/</span>etc<span class="token operator">/</span>ntp<span class="token punctuation">.</span>conf
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">server</span> <span class="token expression"><span class="token number">0.</span>centos<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>ntp<span class="token punctuation">.</span>org iburst </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">server</span> <span class="token expression"><span class="token number">1.</span>centos<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>ntp<span class="token punctuation">.</span>org iburst </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">server</span> <span class="token expression"><span class="token number">2.</span>centos<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>ntp<span class="token punctuation">.</span>org iburst </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">server</span> <span class="token expression"><span class="token number">3.</span>centos<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>ntp<span class="token punctuation">.</span>org iburst </span></span>
server <span class="token number">192.168</span><span class="token number">.61</span><span class="token number">.250</span> #使用主节点 <span class="token number">192.169</span><span class="token number">.61</span><span class="token number">.250</span> 的时间作为基准更新时间
</code></pre> 
<ul><li>ntp 启动命令<br> 1）主节点启动命令</li></ul> 
<pre><code class="prism language-c">service ntpd start #打开 ntpd 服务 
chkconfig ntpd on #设置开机启动
</code></pre> 
<p>2）子节点启动命令</p> 
<pre><code class="prism language-c">ntpdate <span class="token number">192.168</span><span class="token number">.61</span><span class="token number">.250</span> #向主节点发送请求，同步时间 
service ntpd start #打开 ntpd 服务 
chkconfig ntpd on #设置开机启动
</code></pre> 
<p>3）查看 ntp 服务器有无和上层 ntp 连通<br> 使用 ntpstat 行查询，结果一般如下：<br> <img src="https://images2.imgbox.com/e5/73/JmIDVZPv_o.png" alt="在这里插入图片描述"><br> 4）查看 ntp 服务器与上层 ntp 的状态<br> 使用 ntpq -p 进行查询，结果一般如下：<br> <img src="https://images2.imgbox.com/9f/7d/hm1yIDtK_o.png" alt="在这里插入图片描述"></p> 
<ul><li>检查同步是否成功<br> 查看与时间同步服务器的时间偏差，offset 偏差小，同步成功。<br> <img src="https://images2.imgbox.com/79/d0/RXjwvHjp_o.png" alt="在这里插入图片描述"></li></ul> 
<h2><a id="_792"></a>参考</h2> 
<pre><code>https://www.cnblogs.com/ainima/p/6330783.html
http://www.wangkaixuan.tech/?p=840
http://www.wangkaixuan.tech/?p=901
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3b080f1e1d2ff46da0d446ae4352c3be/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">人工智能中的顶级会议</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/35f0eb289b93440bf84a1ffc1a819c5e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43;设计模式——桥模式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>