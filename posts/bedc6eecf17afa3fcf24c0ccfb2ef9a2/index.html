<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>AndroidT(13) init 进程 -- first stage init 的初始化 （二） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="AndroidT(13) init 进程 -- first stage init 的初始化 （二）" />
<meta property="og:description" content="1.概览 第一阶段的 init 工作主要用于读取系统启动阶段需要的配置信息(例如 linux的bootconfig，cmdline等配置信息）、挂载文件系统、安装 kernel 中的模块驱动，最后就是启动第二阶段的 init 来进行 Android 系统相关的组件。第一阶段的 init 被编译为静态的可执行程序，位于 ramdisk 中。在 kernel 启动后该 init 应用程序则会被运行。
2.构建必要的目录及设备 这个步骤用于环境的初始化，大概分为下面几类
a)环境变量的设置
b)必要文件及设备的创建
c)对文件及设备的访问权限配置，这里只有传统的 DAC(Discretionary Access Control) 还没启动DAC(Mandatory Access Control).对 DAC 和 MAC 有疑问的可以参考之前的博客《Android R(11)HIDL服务的sepolicy(五)》。
3.设置 log 的输出位置 我们知道 Android 有自己的 log 系统，但此时它还是不可用的。所以需要将 log 导入到 kernel log 中去，方便调试。
//system\core\init\first_stage_init.cpp FirstStageMain ... SetStdioToDevNull(argv); // Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually // talk to the outside world." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/bedc6eecf17afa3fcf24c0ccfb2ef9a2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-11T10:28:38+08:00" />
<meta property="article:modified_time" content="2023-06-11T10:28:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">AndroidT(13) init 进程 -- first stage init 的初始化 （二）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1_0"></a>1.概览</h3> 
<p>  第一阶段的 init 工作主要用于读取系统启动阶段需要的配置信息(例如 linux的bootconfig，cmdline等配置信息）、挂载文件系统、安装 kernel 中的模块驱动，最后就是启动第二阶段的 init 来进行 Android 系统相关的组件。第一阶段的 init 被编译为静态的可执行程序，位于 ramdisk 中。在 kernel 启动后该 init 应用程序则会被运行。</p> 
<h3><a id="2_2"></a>2.构建必要的目录及设备</h3> 
<p>  这个步骤用于环境的初始化，大概分为下面几类<br>     a)环境变量的设置<br>     b)必要文件及设备的创建<br>     c)对文件及设备的访问权限配置，这里只有传统的 DAC(Discretionary Access Control) 还没启动DAC(Mandatory Access Control).对 DAC 和 MAC 有疑问的可以参考之前的博客《Android R(11)HIDL服务的sepolicy(五)》。</p> 
<h3><a id="3_log__7"></a>3.设置 log 的输出位置</h3> 
<p>  我们知道 Android 有自己的 log 系统，但此时它还是不可用的。所以需要将 log 导入到 kernel log 中去，方便调试。</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\init\first_stage_init.cpp</span>
FirstStageMain
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">SetStdioToDevNull</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually</span>
    <span class="token comment">// talk to the outside world...</span>
    <span class="token function">InitKernelLogging</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="4kernel__18"></a>4.kernel 驱动模块加载</h3> 
<h4><a id="41__19"></a>4.1 所在位置</h4> 
<p>  走到 kernel 启动 init 进程这一阶段时，内存中的 ramdisk 内容则是由 vendor_boot ramdik 和 init_boot ramdisk 组成的，下面是官网给出的示意图，这部分工作则是在 bootloader 阶段完成的，在此不做赘述<br> <img src="https://images2.imgbox.com/ee/86/DmwZJOhZ_o.png" alt="在这里插入图片描述"></p> 
<p>  kernel 模块是位于 vendor_boot ramdik 的，所以有必要展示下 vendor_boot 的目录结构</p> 
<pre><code class="prism language-cpp">├── bootconfig
├── dtb
├── vendor_ramdisk
<span class="token operator">|</span>__ vendor<span class="token operator">-</span>ramdisk<span class="token operator">-</span>by<span class="token operator">-</span>name
</code></pre> 
<p>  vendor_ramdisk 的展开结构如下</p> 
<pre><code class="prism language-cpp">├── acct
├── apex
├── config
├── data
├── data_mirror
├── debug_ramdisk
├── <span class="token keyword">default</span><span class="token punctuation">.</span>prop
├── dev
├── first_stage_ramdisk
│   └── fstab<span class="token punctuation">.</span>s5e8835
├── init<span class="token punctuation">.</span>recovery<span class="token punctuation">.</span>s5e8835<span class="token punctuation">.</span>rc
├── lib
│   └── modules
│       ├── first_module<span class="token punctuation">.</span>ko
│       ├<span class="token operator">--</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
│       ├── modules<span class="token punctuation">.</span>alias
│       ├── modules<span class="token punctuation">.</span>dep
│       ├── modules<span class="token punctuation">.</span>load<span class="token punctuation">.</span>recovery
│       ├── modules<span class="token punctuation">.</span>softdep
│       └── last_module<span class="token punctuation">.</span>ko
├── linkerconfig
├── metadata
├── mnt
├── odm
├── odm_dlkm
├── odm_file_contexts
├── odm_property_contexts
├── oem
├── plat_file_contexts
├── plat_property_contexts
├── plat_service_contexts
├── postinstall
├── proc
├── product_file_contexts
├── product_property_contexts
├── product_service_contexts
├── prop<span class="token punctuation">.</span><span class="token keyword">default</span>
├── res
│   └── images
│       ├── <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
│       └── stage_fill<span class="token punctuation">.</span>png
├── sdcard
├── second_stage_resources
├── sepolicy
├── storage
├── sys
├── system
│   ├── bin
│   ├── ├── <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
│   │   └── ziptool
│   ├── etc
│   │   ├── cgroups<span class="token punctuation">.</span>json
│   │   ├── init
│   │   │   ├── hw
│   │   │   │   └── init<span class="token punctuation">.</span>rc
│   │   │   └── servicemanager<span class="token punctuation">.</span>recovery<span class="token punctuation">.</span>rc
│   │   ├── ld<span class="token punctuation">.</span>config<span class="token punctuation">.</span>txt
│   │   ├── mke2fs<span class="token punctuation">.</span>conf
│   │   ├── recovery<span class="token punctuation">.</span>fstab
│   │   ├── security
│   │   │   └── otacerts<span class="token punctuation">.</span>zip
│   │   └── ueventd<span class="token punctuation">.</span>rc
│   └── lib64
│       ├── <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
│       ├── android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span>health<span class="token operator">-</span>V1<span class="token operator">-</span>ndk<span class="token punctuation">.</span>so
│       ├── hw
│       │   ├── <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
│       │   └── android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span>health@<span class="token number">2.0</span><span class="token operator">-</span>impl<span class="token operator">-</span><span class="token keyword">default</span><span class="token punctuation">.</span>so
│       ├── <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
│       └── libz<span class="token punctuation">.</span>so
├── system_dlkm
├── system_ext_file_contexts
├── system_ext_property_contexts
├── system_ext_service_contexts
├── tmp
├── vendor
├── vendor_dlkm
├── vendor_file_contexts
├── vendor_property_contexts
└── vendor_service_contexts
</code></pre> 
<h4><a id="42__113"></a>4.2 模块目录统计策略</h4> 
<p>  kernel 中的模块加载则是在这一阶段进行的，下面是对应的代码</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\init\first_stage_init.cpp</span>
FirstStageMain
    <span class="token comment">//code 1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LoadKernelModules</span><span class="token punctuation">(</span><span class="token function">IsRecoveryMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">ForceNormalBoot</span><span class="token punctuation">(</span>cmdline<span class="token punctuation">,</span> bootconfig<span class="token punctuation">)</span><span class="token punctuation">,</span> want_console<span class="token punctuation">,</span> want_parallel<span class="token punctuation">,</span> module_count<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//code 2</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>module_count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span> module_elapse_time <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">duration_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>milliseconds<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
                boot_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> module_start_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setenv</span><span class="token punctuation">(</span>kEnvInitModuleDurationMs<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>module_elapse_time<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Loaded "</span> <span class="token operator">&lt;&lt;</span> module_count <span class="token operator">&lt;&lt;</span> <span class="token string">" kernel modules took "</span>
                  <span class="token operator">&lt;&lt;</span> module_elapse_time<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" ms"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  code 1 中，LoadKernelModules 只支持对目录 /lib/modules 深度为 1 的模块的加载</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\init\first_stage_init.cpp</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_BASE_DIR</span> <span class="token string">"/lib/modules"</span></span>
<span class="token keyword">bool</span> <span class="token function">LoadKernelModules</span><span class="token punctuation">(</span><span class="token keyword">bool</span> recovery<span class="token punctuation">,</span> <span class="token keyword">bool</span> want_console<span class="token punctuation">,</span> <span class="token keyword">bool</span> want_parallel<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&amp;</span> modules_loaded<span class="token punctuation">)</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>DIR<span class="token punctuation">,</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>closedir<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">base_dir</span><span class="token punctuation">(</span><span class="token function">opendir</span><span class="token punctuation">(</span>MODULE_BASE_DIR<span class="token punctuation">)</span><span class="token punctuation">,</span> closedir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> module_dirs<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>entry <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>base_dir<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token operator">-&gt;</span>d_type <span class="token operator">!=</span> DT_DIR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>entry<span class="token operator">-&gt;</span>d_name<span class="token punctuation">,</span> <span class="token string">"%d.%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dir_major<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dir_minor<span class="token punctuation">)</span>
        module_dirs<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>entry<span class="token operator">-&gt;</span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  可以看到，它只统计 /lib/modules 目录下的第一级目录，并记录在 module_dirs vector 中，不会递归的查找。</p> 
<h4><a id="43__145"></a>4.3 模块的加载策略</h4> 
<p>  先看下整体的代码逻辑</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\init\first_stage_init.cpp</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_BASE_DIR</span> <span class="token string">"/lib/modules"</span></span>
FirstStageMain
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> module_dir <span class="token operator">:</span> module_dirs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//code 1</span>
        std<span class="token double-colon punctuation">::</span>string dir_path <span class="token operator">=</span> MODULE_BASE_DIR <span class="token string">"/"</span><span class="token punctuation">;</span>
        dir_path<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>module_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//code 2</span>
        Modprobe <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>dir_path<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">GetModuleLoadList</span><span class="token punctuation">(</span>recovery<span class="token punctuation">,</span> dir_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//code 3</span>
        <span class="token keyword">bool</span> retval <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">LoadListedModules</span><span class="token punctuation">(</span><span class="token operator">!</span>want_console<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//code 4</span>
        modules_loaded <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">GetModuleCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  可见整体的代码逻辑还是相当清晰的，遍历 module_dirs 中所有的目录，对每一个目录调用 Modprobe 工具类来加载。<br>   下面先看看工具类 Modprobe，它是独立的一个库 libmodprobe</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\libmodprobe\Android.bp</span>
cc_library_static <span class="token punctuation">{<!-- --></span>
    name<span class="token operator">:</span> <span class="token string">"libmodprobe"</span><span class="token punctuation">,</span>
    vendor_available<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    ramdisk_available<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    recovery_available<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    srcs<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"libmodprobe.cpp"</span><span class="token punctuation">,</span>
        <span class="token string">"libmodprobe_ext.cpp"</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    shared_libs<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"libbase"</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    export_include_dirs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"include/"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  code 2 中 GetModuleLoadList 的定义如下</p> 
<pre><code class="prism language-cpp">std<span class="token double-colon punctuation">::</span>string <span class="token function">GetModuleLoadList</span><span class="token punctuation">(</span><span class="token keyword">bool</span> recovery<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> dir_path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> module_load_file <span class="token operator">=</span> <span class="token string">"modules.load"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>recovery<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> <span class="token class-name">stat</span> fileStat<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string recovery_load_path <span class="token operator">=</span> dir_path <span class="token operator">+</span> <span class="token string">"/modules.load.recovery"</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">stat</span><span class="token punctuation">(</span>recovery_load_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fileStat<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            module_load_file <span class="token operator">=</span> <span class="token string">"modules.load.recovery"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> module_load_file<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  如果是 recovery 模式那么就使用 modules.load.recovery 反之则是modules.load。所以对于正常启动此处会返回 modules.load。下面来看看它的构造过程</p> 
<pre><code class="prism language-cpp">Modprobe <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>dir_path<span class="token punctuation">}</span><span class="token comment">/*base_paths*/</span><span class="token punctuation">,</span> <span class="token string">"modules.load"</span><span class="token comment">/*load_file*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Modprobe</span><span class="token double-colon punctuation">::</span><span class="token function">Modprobe</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span><span class="token operator">&amp;</span> base_paths<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string load_file<span class="token punctuation">,</span> <span class="token keyword">bool</span> use_blocklist<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> base_path <span class="token operator">:</span> base_paths<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//code 2-1</span>
        <span class="token keyword">auto</span> alias_callback <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Modprobe<span class="token double-colon punctuation">::</span>ParseAliasCallback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> _1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ParseCfg</span><span class="token punctuation">(</span>base_path <span class="token operator">+</span> <span class="token string">"/modules.alias"</span><span class="token punctuation">,</span> alias_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//code 2-2</span>
        <span class="token keyword">auto</span> dep_callback <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Modprobe<span class="token double-colon punctuation">::</span>ParseDepCallback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> base_path<span class="token punctuation">,</span> _1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ParseCfg</span><span class="token punctuation">(</span>base_path <span class="token operator">+</span> <span class="token string">"/modules.dep"</span><span class="token punctuation">,</span> dep_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//code 2-3</span>
        <span class="token keyword">auto</span> softdep_callback <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Modprobe<span class="token double-colon punctuation">::</span>ParseSoftdepCallback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> _1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ParseCfg</span><span class="token punctuation">(</span>base_path <span class="token operator">+</span> <span class="token string">"/modules.softdep"</span><span class="token punctuation">,</span> softdep_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//code 2-4</span>
        <span class="token keyword">auto</span> load_callback <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Modprobe<span class="token double-colon punctuation">::</span>ParseLoadCallback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> _1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ParseCfg</span><span class="token punctuation">(</span>base_path <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> load_file<span class="token punctuation">,</span> load_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//code 2-5</span>
        <span class="token keyword">auto</span> options_callback <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Modprobe<span class="token double-colon punctuation">::</span>ParseOptionsCallback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> _1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ParseCfg</span><span class="token punctuation">(</span>base_path <span class="token operator">+</span> <span class="token string">"/modules.options"</span><span class="token punctuation">,</span> options_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//code 2-6</span>
        <span class="token keyword">auto</span> blocklist_callback <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Modprobe<span class="token double-colon punctuation">::</span>ParseBlocklistCallback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> _1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ParseCfg</span><span class="token punctuation">(</span>base_path <span class="token operator">+</span> <span class="token string">"/modules.blocklist"</span><span class="token punctuation">,</span> blocklist_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  Modprobe 构造方法中仅仅只是将各个文件的内容进行解析并存入对于的变量中去，供后续使用。下面则列出他们最终被存入的变量<br>   code 2-1</p> 
<pre><code class="prism language-cpp"><span class="token comment">//\system\core\libmodprobe\libmodprobe.cpp</span>
ParseAliasCallback
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>module_aliases_<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>alias<span class="token punctuation">,</span> module_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  code 2-2</p> 
<pre><code class="prism language-cpp">ParseDepCallback
    deps<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>module_deps_<span class="token punctuation">[</span>canonical_name<span class="token punctuation">]</span> <span class="token operator">=</span> deps<span class="token punctuation">;</span>
</code></pre> 
<p>  code 2-3</p> 
<pre><code class="prism language-cpp">ParseSoftdepCallback
    <span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> args<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token string">"pre:"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token operator">-&gt;</span>module_pre_softdep_<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token operator">-&gt;</span>module_post_softdep_<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  code 2-4</p> 
<pre><code class="prism language-cpp">ParseLoadCallback
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>module_load_<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>canonical_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  code 2-5</p> 
<pre><code class="prism language-cpp">ParseOptionsCallback
    <span class="token keyword">auto</span> <span class="token punctuation">[</span>unused<span class="token punctuation">,</span> inserted<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>module_options_<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>canonical_name<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  code 2-6</p> 
<pre><code class="prism language-cpp">ParseBlocklistCallback
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>module_blocklist_<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>canonical_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  code 3 中，就会根据上面初始化的值进行 kernel 模块的加载了，其实现如下</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\libmodprobe\libmodprobe.cpp</span>
<span class="token keyword">bool</span> retval <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">LoadListedModules</span><span class="token punctuation">(</span><span class="token operator">!</span>want_console<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> ret <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token keyword">module</span> <span class="token module"><span class="token operator">:</span> module_load_</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LoadWithAliases</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsBlocklisted</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>strict<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
</code></pre> 
<p>  LoadWithAliases 里面涉及的模块则是来自于文件 /lib/modules/modules.alias。</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\libmodprobe\libmodprobe.cpp</span>
<span class="token class-name">Modprobe</span><span class="token double-colon punctuation">::</span><span class="token function">LoadWithAliases</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> module_name<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> modules_to_load <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>canonical_name<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token punctuation">[</span>alias<span class="token punctuation">,</span> aliased_module<span class="token punctuation">]</span> <span class="token operator">:</span> module_aliases_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        modules_to_load<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>aliased_module<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token keyword">module</span> <span class="token module"><span class="token operator">:</span> modules_to_load</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">InsmodWithDeps</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">,</span> parameters<span class="token punctuation">)</span><span class="token punctuation">)</span>
            module_loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  将事先准备好的 module_aliases_ 内容过滤下再调用 InsmodWithDeps 进行安装。</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\libmodprobe\libmodprobe.cpp</span>
InsmodWithDeps
    <span class="token keyword">auto</span> dependencies <span class="token operator">=</span> <span class="token function">GetDependencies</span><span class="token punctuation">(</span>module_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> dep <span class="token operator">=</span> dependencies<span class="token punctuation">.</span><span class="token function">rbegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> dep <span class="token operator">!=</span> dependencies<span class="token punctuation">.</span><span class="token function">rend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>dep<span class="token punctuation">)</span>
        <span class="token function">LoadWithAliases</span><span class="token punctuation">(</span><span class="token operator">*</span>dep<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// load target module itself with args</span>
    <span class="token function">Insmod</span><span class="token punctuation">(</span>dependencies<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parameters<span class="token punctuation">)</span>
</code></pre> 
<p>  从上面代码也可以看出来，在安装模块前，则会先安装他们的依赖。最后再安装 当前 kernel 模块。</p> 
<h4><a id="44__306"></a>4.4 加载时间的统计</h4> 
<p>  加载时间在优化系统启动时间时还是很重要的，kernle 模块的加载可以通过搜索 如下 log 查看</p> 
<pre><code class="prism language-cpp">kernel modules took
</code></pre> 
<p>  它的实现如下</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">if</span> <span class="token punctuation">(</span>module_count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span> module_elapse_time <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">duration_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>milliseconds<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
                boot_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> module_start_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setenv</span><span class="token punctuation">(</span>kEnvInitModuleDurationMs<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>module_elapse_time<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Loaded "</span> <span class="token operator">&lt;&lt;</span> module_count <span class="token operator">&lt;&lt;</span> <span class="token string">" kernel modules took "</span>
                  <span class="token operator">&lt;&lt;</span> module_elapse_time<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" ms"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  可以看到，此时间还被记录到环境变量中去了 kEnvInitModuleDurationMs</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\init\first_stage_init.h</span>
<span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">char</span> kEnvInitModuleDurationMs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"INIT_MODULE_DURATION_MS"</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="5_326"></a>5.属性文件的处理</h3> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\init\second_stage_resources.h</span>
<span class="token keyword">constexpr</span> <span class="token keyword">const</span> <span class="token keyword">char</span> kSecondStageRes<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/second_stage_resources"</span><span class="token punctuation">;</span>
<span class="token keyword">constexpr</span> <span class="token keyword">const</span> <span class="token keyword">char</span> kBootImageRamdiskProp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/system/etc/ramdisk/build.prop"</span><span class="token punctuation">;</span>
<span class="token comment">//system\core\init\first_stage_init.cpp</span>
FirstStageMain
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>kBootImageRamdiskProp<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//system\core\init\second_stage_resources.h</span>
        std<span class="token double-colon punctuation">::</span>string dest <span class="token operator">=</span> <span class="token function">GetRamdiskPropForSecondStage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//return /second_stage_resources/system/etc/ramdisk/build.prop</span>
            <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span>kSecondStageRes<span class="token punctuation">)</span> <span class="token operator">+</span> kBootImageRamdiskProp<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string dir <span class="token operator">=</span> android<span class="token double-colon punctuation">::</span>base<span class="token double-colon punctuation">::</span><span class="token function">Dirname</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fs<span class="token double-colon punctuation">::</span><span class="token function">copy_file</span><span class="token punctuation">(</span>kBootImageRamdiskProp<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> ec<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  对于 ramdisk 中的属性文件，最终也会反应到 Android 的属性服务中去的。但是 ramdisk 在 Android 启动后会被卸载掉，所以这里需要做下拷贝操作。<br>   它的路径如下</p> 
<pre><code class="prism language-cpp"><span class="token operator">/</span>second_stage_resources<span class="token operator">/</span>system<span class="token operator">/</span>etc<span class="token operator">/</span>ramdisk<span class="token operator">/</span>build<span class="token punctuation">.</span>prop
</code></pre> 
<h3><a id="6root_347"></a>6.是否允许root</h3> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\init\second_stage_resources.h</span>
<span class="token keyword">constexpr</span> <span class="token keyword">const</span> <span class="token keyword">char</span> kDebugRamdiskProp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/debug_ramdisk/adb_debug.prop"</span><span class="token punctuation">;</span>
<span class="token comment">//system\core\init\first_stage_init.cpp</span>
FirstStageMain
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"/force_debuggable"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">constexpr</span> <span class="token keyword">const</span> <span class="token keyword">char</span> adb_debug_prop_src<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/adb_debug.prop"</span><span class="token punctuation">;</span>
        <span class="token keyword">constexpr</span> <span class="token keyword">const</span> <span class="token keyword">char</span> userdebug_plat_sepolicy_cil_src<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/userdebug_plat_sepolicy.cil"</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>adb_debug_prop_src<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span>fs<span class="token double-colon punctuation">::</span><span class="token function">copy_file</span><span class="token punctuation">(</span>adb_debug_prop_src<span class="token punctuation">,</span> kDebugRamdiskProp<span class="token punctuation">,</span> ec<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>userdebug_plat_sepolicy_cil_src<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span>fs<span class="token double-colon punctuation">::</span><span class="token function">copy_file</span><span class="token punctuation">(</span>userdebug_plat_sepolicy_cil_src<span class="token punctuation">,</span> kDebugRamdiskSEPolicy<span class="token punctuation">,</span> ec<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// setenv for second-stage init to read above kDebugRamdisk* files.</span>
        <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"INIT_FORCE_DEBUGGABLE"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  所以只要 ramdisk 中存在 /force_debuggable 就代表着要开启调试模式，这也意味着adb是可用的，并且是支持 root 的。</p> 
<h3><a id="7_365"></a>7.切换根目录</h3> 
<pre><code class="prism language-cpp">FirstStageMain
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ForceNormalBoot</span><span class="token punctuation">(</span>cmdline<span class="token punctuation">,</span> bootconfig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">"/first_stage_ramdisk"</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PrepareSwitchRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// SwitchRoot() must be called with a mount point as the target, so we bind mount the</span>
        <span class="token comment">// target directory to itself here.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"/first_stage_ramdisk"</span><span class="token punctuation">,</span> <span class="token string">"/first_stage_ramdisk"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> MS_BIND<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">PLOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not bind mount /first_stage_ramdisk to itself"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">SwitchRoot</span><span class="token punctuation">(</span><span class="token string">"/first_stage_ramdisk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  代码很简单，提出来是为了提示接下去根目录就变化了。</p> 
<h3><a id="8_380"></a>8.根据配置挂在第一阶段的文件系统</h3> 
<pre><code class="prism language-cpp">FirstStageMain
    <span class="token comment">//system\core\init\first_stage_mount.cpp</span>
    <span class="token function">DoFirstStageMount</span><span class="token punctuation">(</span><span class="token operator">!</span>created_devices<span class="token punctuation">)</span>
        <span class="token comment">//code 1</span>
        <span class="token keyword">auto</span> fsm <span class="token operator">=</span> <span class="token class-name">FirstStageMount</span><span class="token double-colon punctuation">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//code 2</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>fsm<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">DoCreateDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//code 3</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>fsm<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">DoFirstStageMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  可以看到流程很清晰，下面来看看他们的具体实现。</p> 
<h4><a id="81_code_1_393"></a>8.1 code 1</h4> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\init\first_stage_mount.cpp</span>
<span class="token keyword">auto</span> fsm <span class="token operator">=</span> <span class="token class-name">FirstStageMount</span><span class="token double-colon punctuation">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> fstab <span class="token operator">=</span> <span class="token function">ReadFirstStageFstab</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//Fstab fstab;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ReadFstabFromDt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fstab<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadDefaultFstab</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fstab<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                fstab<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">remove_if</span><span class="token punctuation">(</span>fstab<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fstab<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> entry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                            <span class="token keyword">return</span> <span class="token operator">!</span>entry<span class="token punctuation">.</span>fs_mgr_flags<span class="token punctuation">.</span>first_stage_mount<span class="token punctuation">;</span>
                                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            fstab<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> fstab<span class="token punctuation">;</span>
    <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>FirstStageMountVBootV2<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token operator">*</span>fstab<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  可以看出，挂在表如果在 Deivce tree 中获取到了，那么就不再调用 ReadDefaultFstab，两者是互斥的。我们使用 ReadDefaultFstab 来获取，所以下面来看看他的实现</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\fs_mgr\fs_mgr_fstab.cpp</span>
<span class="token function">ReadDefaultFstab</span><span class="token punctuation">(</span>Fstab<span class="token operator">*</span> fstab<span class="token punctuation">)</span>
    <span class="token function">ReadFstabFromDt</span><span class="token punctuation">(</span>fstab<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* verbose */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    default_fstab_path <span class="token operator">=</span> <span class="token function">GetFstabPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Fstab default_fstab<span class="token punctuation">;</span>
    <span class="token function">ReadFstabFromFile</span><span class="token punctuation">(</span>default_fstab_path<span class="token punctuation">,</span> <span class="token operator">&amp;</span>default_fstab<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> entry <span class="token operator">:</span> default_fstab<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        fstab<span class="token operator">-&gt;</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre> 
<p>  我们依然忽略掉从 Device tree 中获取的部分，看下查找 fs 文件的顺序</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\fs_mgr\fs_mgr_fstab.cpp</span>
GetFstabPath
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> prop <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"fstab_suffix"</span><span class="token punctuation">,</span> <span class="token string">"hardware"</span><span class="token punctuation">,</span> <span class="token string">"hardware.platform"</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>string suffix<span class="token punctuation">;</span>
        <span class="token comment">//a</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fs_mgr_get_boot_config</span><span class="token punctuation">(</span>prop<span class="token comment">/*key*/</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>suffix<span class="token comment">/*out_val*/</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token comment">//b</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> prefix <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// late-boot/post-boot locations</span>
                                   <span class="token string">"/odm/etc/fstab."</span><span class="token punctuation">,</span> <span class="token string">"/vendor/etc/fstab."</span><span class="token punctuation">,</span>
                                   <span class="token comment">// early boot locations</span>
                                   <span class="token string">"/system/etc/fstab."</span><span class="token punctuation">,</span> <span class="token string">"/first_stage_ramdisk/system/etc/fstab."</span><span class="token punctuation">,</span>
                                   <span class="token string">"/fstab."</span><span class="token punctuation">,</span> <span class="token string">"/first_stage_ramdisk/fstab."</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//c</span>
            std<span class="token double-colon punctuation">::</span>string fstab_path <span class="token operator">=</span> prefix <span class="token operator">+</span> suffix<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>fstab_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> fstab_path<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  从上面的代码 c 处可以看到，路径由前缀和后缀构成。<br>   前缀的实现代码如下</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\fs_mgr\fs_mgr_boot_config.cpp</span>
<span class="token function">fs_mgr_get_boot_config</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> out_val<span class="token punctuation">)</span>
    <span class="token comment">// next, check if we have "ro.boot" property already</span>
    <span class="token operator">*</span>out_val <span class="token operator">=</span> android<span class="token double-colon punctuation">::</span>base<span class="token double-colon punctuation">::</span><span class="token function">GetProperty</span><span class="token punctuation">(</span><span class="token string">"ro.boot."</span> <span class="token operator">+</span> key<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out_val<span class="token operator">-&gt;</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// next, check if we have the property in bootconfig</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fs_mgr_get_boot_config_from_bootconfig_source</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> out_val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// finally, fallback to kernel cmdline, properties may not be ready yet</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fs_mgr_get_boot_config_from_kernel_cmdline</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> out_val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  可以看出，在每一个key中获取后缀的顺序如下并且任何一个获取到后就立即返回，以该值为准，属性值-&gt;bootconfig-&gt;kernel cmdline。<br>   一般来说，到 ro.boot.hardware 属性的获取就可以确定了，如下</p> 
<pre><code class="prism language-cpp">flg1080<span class="token operator">:</span><span class="token operator">/</span> # getprop ro<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>hardware
staf1080
</code></pre> 
<p>  那么此时的后缀就为 staf1080。<br>   后缀确定后，也就很好确定获取文件系统挂在顺序了<br>     1) /odm/etc/fstab.staf1080<br>     2) /vendor/etc/fstab.staf1080<br>     3) /system/etc/fstab.staf1080<br>     4) /first_stage_ramdisk/system/etc/fstab.staf1080<br>     5) /fstab.staf1080<br>     6) /first_stage_ramdisk/fstab.staf1080<br>   注意了，上面的路径是按先后顺序只取一例，不做糅合的。<br>   最后 Create 返回的是 FirstStageMountVBootV2 数据结构,看看它的类图<br> <img src="https://images2.imgbox.com/0c/2d/sdLpISZV_o.png" alt="在这里插入图片描述"></p> 
<p>  再看看它的构造</p> 
<pre><code class="prism language-cpp"><span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>FirstStageMountVBootV2<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token operator">*</span>fstab<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//system\core\init\first_stage_mount.cpp</span>
    <span class="token function">FirstStageMountVBootV2</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Fstab fstab<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> entry <span class="token operator">:</span> fstab_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">.</span>vbmeta_partition<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                vbmeta_partitions_<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>vbmeta_partition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>  构造方法中都是 vbmeta 的内容，这部分属于安全的内容，在此则不做赘述。</p> 
<h4><a id="82_code_2_498"></a>8.2 code 2</h4> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\init\first_stage_mount.cpp</span>
<span class="token punctuation">(</span><span class="token operator">*</span>fsm<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">DoCreateDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">||</span>
<span class="token class-name">FirstStageMount</span><span class="token double-colon punctuation">::</span><span class="token function">DoCreateDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">InitDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">GetSuperDeviceName</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>devices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">GetDmVerityDevices</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>devices<span class="token punctuation">)</span>
        <span class="token function">InitRequiredDevices</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>devices<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">//system\core\init\block_dev_initializer.cpp</span>
            <span class="token keyword">return</span> block_dev_init_<span class="token punctuation">.</span><span class="token function">InitDevices</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>devices<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CreateLogicalPartitions
</code></pre> 
<p>  其中 InitDevices 做的也很简单，从 fstab 中获取到各个分区的设备信息，然后 polling 等待 uevnet信息，如果是对应的block设备事件则调用它的处理方法进行处理</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\init\devices.cpp</span>
HandleDevice
    <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token string">"add"</span> <span class="token operator">||</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token string">"change"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">StartsWith</span><span class="token punctuation">(</span>devpath<span class="token punctuation">,</span> <span class="token string">"/dev/block/dm-"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token string">"remove"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  CreateLogicalPartitions最终调用 android::fs_mgr::CreateLogicalPartitions 进行处理</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system\core\fs_mgr\fs_mgr_dm_linear.cpp</span>
<span class="token function">CreateLogicalPartitions</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> block_device<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">CreateLogicalPartitions</span><span class="token punctuation">(</span><span class="token operator">*</span>metadata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> block_device<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h4><a id="83_code_3_530"></a>8.3 code 3</h4> 
<p>  最后开始工具 fs配置文件进行文件系统挂载了</p> 
<pre><code class="prism language-cpp"><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>fsm<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">DoFirstStageMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//system\core\init\first_stage_mount.cpp</span>
    <span class="token keyword">return</span> <span class="token function">MountPartitions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        TrySwitchSystemAsRoot
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> current <span class="token operator">=</span> fstab_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> current <span class="token operator">!=</span> fstab_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">MountPartition</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* erase_same_mounts */</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>end<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> entry <span class="token operator">:</span> fstab_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>fs_type <span class="token operator">==</span> <span class="token string">"overlay"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">fs_mgr_mount_overlayfs_fstab_entry</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If we don't see /system or / in the fstab, then we need to create an root entry for</span>
        <span class="token comment">// overlayfs.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetEntryForMountPoint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fstab_<span class="token punctuation">,</span> <span class="token string">"/system"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">GetEntryForMountPoint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fstab_<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            FstabEntry root_entry<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetRootEntry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>root_entry<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                fstab_<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>root_entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">MapScratchPartitionIfNeeded</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fstab_<span class="token punctuation">,</span> init_devices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fs_mgr_overlayfs_mount_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fstab_<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="9_init_559"></a>9.启动下一阶段的 init</h3> 
<p>  在完成这一次的使命后，first init 也到了该退出的时候了。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path <span class="token operator">=</span> <span class="token string">"/system/bin/init"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>path<span class="token punctuation">,</span> <span class="token string">"selinux_setup"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">execv</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  execv的关键点则是会使用 path 指向的可执行程序替换当前进程已在执行的程序，用人话讲就是 first init 被 /system/bin/init 替换了，下面就会执行 /system/bin/init 中的 main 入口方法了。<br>   所以上面代码等价于在 shell 中执行如下命令，并且它的 pid 保持不变及为 1</p> 
<pre><code class="prism language-cpp"><span class="token operator">/</span>system<span class="token operator">/</span>bin<span class="token operator">/</span>init selinux_setup
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4f8aac1ad564c18683437625b0646d91/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Jmeter</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/654afaeda6d603827a81ac771d47f90f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AndroidT(13) init 进程 -- second stage init 中的 Epoll （三）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>