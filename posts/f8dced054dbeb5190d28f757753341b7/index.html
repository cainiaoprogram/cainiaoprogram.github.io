<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>进一步的认识服务注册中心--Nacos - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="进一步的认识服务注册中心--Nacos" />
<meta property="og:description" content="文章目录 什么是 NacosNacos 架构用户层业务层内核层插件 Nacos能做什么。注册中心原理构建应用接入Nacos注册中心服务提供者服务消费者 数据模型Namespace 命名空间Group 服务分组Service 服务 服务领域模型Instance 实例Cluster 集群Metadata 元数据Health Check 健康检查 支持的几种服务消费方式使用RestTemplate使用WebClient使用Feign Nacos作为配置中心创建配置创建应用 Nacos配置的加载规则详解Nacos的多环境管理使用Data ID与profiles实现使用Group实现使用Namespace实现 Nacos配置的多文件加载与共享配置Nacos配置的多文件加载共享配置配置加载的优先级 数据持久化集群搭建MySQL数据源配置集群配置启动实例本地测试生产环境Proxy配置 什么是 Nacos Nacos 是服务注册中心，是阿里巴巴推出来的一个新开源项目，是致力于帮助我们发现、配置和管理微服务的。
Nacos 提供了一组简单易用的特性集，帮助快速实现动态服务发现、服务配置、服务元数据及流量管理。
Nacos 是构建以“服务”为中心的现代应用架构 (例如微服务范式、云原生范式) 的服务基础设施。
相对于 Spring Cloud Eureka 来说，Nacos 更强大。Nacos = Spring Cloud Eureka &#43; Spring Cloud Config
通俗来说，Nacos是一个注册中心&amp; 配置中心 ——作为注册中心，Nacos可用于替代Spring Cloud中的Eureka、Spring Cloud Zookeeper Discovery、Spring Cloud Consul Discovery；作为配置中心，Nacos可用于替代Spring Cloud Config、Spring Cloud Zookeper Config、Spring Cloud Consul Config。
Nacos 可以与 Spring, Spring Boot, Spring Cloud 集成，并能代替 Spring Cloud Eureka, Spring Cloud Config" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f8dced054dbeb5190d28f757753341b7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-04T20:20:38+08:00" />
<meta property="article:modified_time" content="2022-04-04T20:20:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">进一步的认识服务注册中心--Nacos</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_Nacos_8" rel="nofollow">什么是 Nacos</a></li><li><a href="#Nacos__19" rel="nofollow">Nacos 架构</a></li><li><ul><li><a href="#_22" rel="nofollow">用户层</a></li><li><a href="#_29" rel="nofollow">业务层</a></li><li><a href="#_34" rel="nofollow">内核层</a></li><li><a href="#_48" rel="nofollow">插件</a></li></ul> 
   </li><li><a href="#Nacos_59" rel="nofollow">Nacos能做什么。</a></li><li><a href="#_68" rel="nofollow">注册中心原理</a></li><li><a href="#Nacos_93" rel="nofollow">构建应用接入Nacos注册中心</a></li><li><ul><li><a href="#_94" rel="nofollow">服务提供者</a></li><li><a href="#_233" rel="nofollow">服务消费者</a></li></ul> 
   </li><li><a href="#_292" rel="nofollow">数据模型</a></li><li><ul><li><a href="#Namespace__298" rel="nofollow">Namespace 命名空间</a></li><li><a href="#Group__301" rel="nofollow">Group 服务分组</a></li><li><a href="#Service__303" rel="nofollow">Service 服务</a></li></ul> 
   </li><li><a href="#_307" rel="nofollow">服务领域模型</a></li><li><ul><li><a href="#Instance__309" rel="nofollow">Instance 实例</a></li><li><a href="#Cluster__314" rel="nofollow">Cluster 集群</a></li><li><a href="#Metadata__317" rel="nofollow">Metadata 元数据</a></li><li><a href="#Health_Check__329" rel="nofollow">Health Check 健康检查</a></li></ul> 
   </li><li><a href="#_336" rel="nofollow">支持的几种服务消费方式</a></li><li><ul><li><a href="#RestTemplate_338" rel="nofollow">使用RestTemplate</a></li><li><a href="#WebClient_369" rel="nofollow">使用WebClient</a></li><li><a href="#Feign_408" rel="nofollow">使用Feign</a></li></ul> 
   </li><li><a href="#Nacos_458" rel="nofollow">Nacos作为配置中心</a></li><li><ul><li><a href="#_460" rel="nofollow">创建配置</a></li><li><a href="#_469" rel="nofollow">创建应用</a></li></ul> 
   </li><li><a href="#Nacos_555" rel="nofollow">Nacos配置的加载规则详解</a></li><li><a href="#Nacos_589" rel="nofollow">Nacos的多环境管理</a></li><li><ul><li><a href="#Data_IDprofiles_590" rel="nofollow">使用Data ID与profiles实现</a></li><li><a href="#Group_609" rel="nofollow">使用Group实现</a></li><li><a href="#Namespace_622" rel="nofollow">使用Namespace实现</a></li></ul> 
   </li><li><a href="#Nacos_638" rel="nofollow">Nacos配置的多文件加载与共享配置</a></li><li><ul><li><a href="#Nacos_639" rel="nofollow">Nacos配置的多文件加载</a></li><li><a href="#_665" rel="nofollow">共享配置</a></li><li><a href="#_675" rel="nofollow">配置加载的优先级</a></li></ul> 
   </li><li><a href="#_703" rel="nofollow">数据持久化</a></li><li><a href="#_722" rel="nofollow">集群搭建</a></li><li><ul><li><a href="#MySQL_727" rel="nofollow">MySQL数据源配置</a></li><li><a href="#_740" rel="nofollow">集群配置</a></li><li><a href="#_751" rel="nofollow">启动实例</a></li><li><ul><li><a href="#_752" rel="nofollow">本地测试</a></li><li><a href="#_771" rel="nofollow">生产环境</a></li><li><a href="#Proxy_773" rel="nofollow">Proxy配置</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<h3><a id="_Nacos_8"></a>什么是 Nacos</h3> 
<ul><li> <p><strong>Nacos 是服务注册中心</strong>，是阿里巴巴推出来的一个新开源项目，是致力于帮助我们<strong>发现、配置和管理微服务的</strong>。</p> </li><li> <p>Nacos 提供了一组简单易用的特性集，帮助快速实现<strong>动态服务发现、服务配置、服务元数据及流量管理。</strong></p> </li><li> <p>Nacos 是构建以“<strong>服务</strong>”为中心的现代应用架构 (例如微服务范式、云原生范式) 的服务基础设施。<br> 相对于 Spring Cloud Eureka 来说，Nacos 更强大。<strong>Nacos = Spring Cloud Eureka + Spring Cloud Config</strong></p> </li><li> <p><strong>通俗来说，Nacos是一个注册中心&amp; 配置中心</strong> ——<strong>作为注册中心，Nacos可用于替代Spring Cloud中的Eureka、Spring Cloud Zookeeper Discovery、Spring Cloud Consul Discovery</strong>；<strong>作为配置中心，Nacos可用于替代Spring Cloud Config、Spring Cloud Zookeper Config、Spring Cloud Consul Config。</strong></p> </li><li> <p>Nacos 可以与 Spring, Spring Boot, Spring Cloud 集成，并能代替 Spring Cloud Eureka, Spring Cloud Config</p> </li><li> <p>通过 <code>Nacos Serve</code>r 和 <code>spring-cloud-starter-alibaba-nacos-config</code> 实现<strong>配置的动态变更</strong></p> </li><li> <p>通过 <code>Nacos Server</code> 和 <code>spring-cloud-starter-alibaba-nacos-discovery</code> 实现<strong>服务的注册与发现</strong></p> </li></ul> 
<h3><a id="Nacos__19"></a>Nacos 架构</h3> 
<p>整体架构分为<strong>用户层、业务层、内核层和插件</strong>，用户层主要解决用户使用的易用性问题，业务层主要解决服务发现和配置管理的功能问题，内核层解决分布式系统一致性、存储、高可用等核心问题，插件解决扩展性问题。<br> <img src="https://images2.imgbox.com/38/9a/mkYsZbnA_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_22"></a>用户层</h4> 
<ul><li>OpenAPI：暴露标准Rest风格HTTP接口，简单易用，方便多语言集成</li><li>Console：易用控制台，做服务管理、配置管理等操作</li><li>SDK：多语言 SDK，目前几乎支持所有主流编程语言</li><li>Agent：Sidecar 模式运行，通过标准 DNS 协议与业务解耦</li><li>CLI：命令行对产品进行轻量化管理，像 git 一样好用</li></ul> 
<h4><a id="_29"></a>业务层</h4> 
<ul><li>服务管理：实现服务 CRUD，域名 CRUD，服务健康状态检查，服务权重管理等功能</li><li>配置管理：实现配置管 CRUD，版本管理，灰度管理，监听管理，推送轨迹，聚合数据等功能</li><li>元数据管理：提供元数据 CURD 和打标能力，为实现上层流量和服务灰度非常关键</li></ul> 
<h4><a id="_34"></a>内核层</h4> 
<ul><li>插件机制：实现三个模块可分可合能力，实现扩展点 SPI 机制，用于扩展自己公司定制</li><li>事件机制：实现异步化事件通知，SDK 数据变化异步通知等逻辑，是Nacos高性能的关键部分</li><li>日志模块：管理日志分类，日志级别，日志可移植性（尤其避免冲突），日志格式，异常码+帮助文档</li><li>回调机制：SDK 通知数据，通过统一的模式回调用户处理。接口和数据结构需要具备可扩展性</li><li>寻址模式：解决 Server IP 直连，域名访问，Nameserver 寻址、广播等多种寻址模式，需要可扩展</li><li>推送通道：解决 Server 与存储、Server 间、Server 与 SDK 间高效通信问题</li><li>容量管理：管理每个租户，分组下的容量，防止存储被写爆，影响服务可用性</li><li>流量管理：按照租户，分组等多个维度对请求频率，长链接个数，报文大小，请求流控进行控制</li><li>缓存机制：容灾目录，本地缓存，Server 缓存机制，是 Nacos 高可用的关键</li><li>启动模式：按照单机模式，配置模式，服务模式，DNS 模式模式，启动不同的模块</li><li>一致性协议：解决不同数据，不同一致性要求情况下，不同一致性要求，是 Nacos 做到 AP 协议的关键</li><li>存储模块：解决数据持久化、非持久化存储，解决数据分片问题</li></ul> 
<h4><a id="_48"></a>插件</h4> 
<ul><li>Nameserver：解决 Namespace 到 ClusterID 的路由问题，解决用户环境与 Nacos 物理环境映射问题</li><li>CMDB：解决元数据存储，与三方 CMDB 系统对接问题，解决应用，人，资源关系</li><li>Metrics：暴露标准 Metrics 数据，方便与三方监控系统打通</li><li>Trace：暴露标准 Trace，方便与 SLA 系统打通，日志白平化，推送轨迹等能力，并且可以和计量计费系统打通</li><li>接入管理：相当于阿里云开通服务，分配身份、容量、权限过程</li><li>用户管理：解决用户管理，登录，SSO 等问题</li><li>权限管理：解决身份识别，访问控制，角色管理等问题</li><li>审计系统：扩展接口方便与不同公司审计系统打通</li><li>通知系统：核心数据变更，或者操作，方便通过SMS系统打通，通知到对应人数据变更</li></ul> 
<h3><a id="Nacos_59"></a>Nacos能做什么。</h3> 
<ul><li>Nacos是以服务为主要服务对象的中间件，Nacos支持所有主流的服务发现、配置和管理。</li><li>Nacos主要提供以下四大功能： 
  <ul><li>服务发现和服务健康监测</li><li>动态配置服务</li><li>动态DNS服务</li><li>服务及其元数据管理</li></ul> </li></ul> 
<h3><a id="_68"></a>注册中心原理</h3> 
<p>在使用注册中心时，一共有三种角色：服务提供者（<code>Service Provider</code>）、服务消费者（<code>Service Consumer</code>）、注册中心（<code>Registry</code>）。</p> 
<blockquote> 
 <p>在一些文章中，服务提供者被称为 Server，服务消费者被称为 Client。</p> 
</blockquote> 
<p>三个角色交互如下图所示：</p> 
<p><img src="https://images2.imgbox.com/c5/d4/CWB2HOTU_o.png" alt="在这里插入图片描述"></p> 
<p>① Provider：</p> 
<ul><li>启动时，向 <code>Registry</code> 注册自己为一个服务（Service）的实例（Instance）。</li><li>同时，定期向 <code>Registry </code>发送心跳，告诉自己还存活。</li><li>关闭时，向 <code>Registry </code>取消注册。</li></ul> 
<p>② Consumer：</p> 
<ul><li>启动时，向 Registry 订阅使用到的服务，并缓存服务的实例列表在内存中。</li><li>后续，Consumer 向对应服务的 Provider 发起调用时，从内存中的该服务的实例列表选择一个，进行远程调用。</li><li>关闭时，向 Registry 取消订阅。</li></ul> 
<p>③ Registry：</p> 
<ul><li>Provider 超过一定时间未心跳时，从服务的实例列表移除。<br> *服务的实例列表发生变化（新增或者移除）时，通知订阅该服务的 Consumer，从而让 Consumer 能够刷新本地缓存。</li></ul> 
<p><code>Provider</code> 和<code> Consumer</code> 是角色上的定义，<strong>一个服务同时即可以是 Provider 也可以作为 Consumer</strong>。例如说，优惠劵服务可以给订单服务提供接口，同时又调用用户服务提供的接口。</p> 
<h3><a id="Nacos_93"></a>构建应用接入Nacos注册中心</h3> 
<h4><a id="_94"></a>服务提供者</h4> 
<p><strong>第一步：创建一个Spring Boot应用，可以命名为：alibaba-nacos-discovery-server。作为服务提供者 demo-provider<br> 第二步：编辑pom.xml，加入必要的依赖配置，比如：</strong></p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>labx-01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.iocoder.springboot.labs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>alibaba-nacos-discovery-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.boot.version</span><span class="token punctuation">&gt;</span></span>2.2.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.boot.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.cloud.version</span><span class="token punctuation">&gt;</span></span>Hoxton.SR1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.cloud.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.cloud.alibaba.version</span><span class="token punctuation">&gt;</span></span>2.2.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.cloud.alibaba.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--
        引入 Spring Boot、Spring Cloud、Spring Cloud Alibaba 三者 BOM 文件，进行依赖版本的管理，防止不兼容。
        在 https://dwz.cn/mcLIfNKt 文章中，Spring Cloud Alibaba 开发团队推荐了三者的依赖关系
     --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.boot.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.cloud.alibaba.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 引入 SpringMVC 相关依赖，并实现对其的自动配置 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- 引入 Spring Cloud Alibaba Nacos Discovery 相关依赖，将 Nacos 作为注册中心，并实现对其的自动配置 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>在 <code>&lt;dependencyManagement /&gt; </code>中，我们引入了 Spring Boot、Spring Cloud、Spring Cloud Alibaba 三者 BOM 文件，进行依赖版本的管理，防止不兼容。在《Spring Cloud 官方文档 —— 版本说明》文档中，推荐了三者的依赖关系。如下表格：<img src="https://images2.imgbox.com/1e/09/XCwelKL8_o.png" alt="在这里插入图片描述"></p> 
<ul><li>这里，我们选择了 Spring Cloud Alibaba 版本为 2.2.0.RELEASE。</li><li>当前版版本下，我们使用的 Nacos 版本为 1.1.4。</li></ul> 
<p>引入<code>spring-cloud-starter-alibaba-nacos-discovery</code>依赖，将 Nacos 作为注册中心，并实现对它的自动配置。<br> <strong>第三步，配置文件</strong><br> 创建 <code>application.yaml</code> 配置文件，添加 <code>Nacos Discovery</code> 配置项。配置如下</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>provider <span class="token comment"># Spring 应用名</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token comment"># Nacos 作为注册中心的配置项，对应 NacosDiscoveryProperties 配置类</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># Nacos 服务器地址</span>
        <span class="token key atrule">service</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span> <span class="token comment"># 注册到 Nacos 的服务名。默认值为 ${spring.application.name}。</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">18080</span> <span class="token comment"># 服务器端口。默认为 8080</span>
</code></pre> 
<p>重点看 <code>spring.cloud.nacos.discovery</code> 配置项，它是 Nacos Discovery 配置项的前缀，对应 <code>NacosDiscoveryProperties</code> 配置项。<br> <strong>第四步，创建应用启动类，并提供 HTTP 接口。</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoProviderApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">DemoProviderApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@RestController</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/echo"</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">"provider:"</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>①<code> @SpringBootApplication</code> 注解，被添加在类上，声明这是一个 Spring Boot 应用。Spring Cloud 是构建在 Spring Boot 之上的，所以需要添加。</p> 
<p>② <code>@EnableDiscoveryClient</code> 注解，开启 Spring Cloud 的<code>注册发现功能</code>。不过从 Spring Cloud Edgware 版本开始，实际上已经不需要添加 @EnableDiscoveryClient 注解，只需要引入 Spring Cloud 注册发现组件，就会自动开启注册发现的功能。例如说，我们这里已经引入了 spring-cloud-starter-alibaba-nacos-discovery 依赖，就不用再添加 @EnableDiscoveryClient 注解了。</p> 
<blockquote> 
 <p>拓展小知识：在 Spring Cloud Common 项目中，定义了 DiscoveryClient<br> 接口，作为通用的发现客户端，提供读取服务和读取服务列表的 API 方法。而想要集成到 Spring Cloud<br> 体系的注册中心的组件，需要提供对应的 DiscoveryClient 实现类。 例如说，Spring Cloud Alibaba Nacos<br> Discovery 提供了 NacosDiscoveryClient 实现，Spring Cloud Netflix Eureka 提供了<br> EurekaDiscoveryClient 实现。 如此，所有需要使用到的地方，只需要获取到 DiscoveryClient<br> 客户端，而无需关注具体实现，保证其通用性。</p> 
</blockquote> 
<p>③ TestController 类，提供了 /echo 接口，返回 provider:${name} 结果。<br> <strong>简单测试</strong><br> ① 通过 启动类启动服务提供者，IDEA 控制台输出日志如：</p> 
<pre><code class="prism language-java"><span class="token comment">// ... 省略其它日志</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">57.406</span>  INFO <span class="token number">27805</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>c<span class="token punctuation">.</span>n<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span>NacosServiceRegistry</span>    <span class="token operator">:</span> nacos registry<span class="token punctuation">,</span> DEFAULT_GROUP demo<span class="token operator">-</span>provider <span class="token number">10.171</span><span class="token number">.1</span><span class="token number">.115</span><span class="token operator">:</span><span class="token number">18080</span> register finished
</code></pre> 
<ul><li>服务 <code>demo-provider</code> 注册到 Nacos 上的日志。</li></ul> 
<p>② 在启动都ok之后，我们可以访问Nacos的管理页面http://127.0.0.1:8848/nacos/来查看服务列表，此时可以看到如下内容：<br> <img src="https://images2.imgbox.com/1c/88/WXaZFqXb_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_233"></a>服务消费者</h4> 
<p><strong>接下来，实现一个应用来消费上面已经注册到Nacos的服务。</strong></p> 
<p><strong>第一步：创建一个Spring Boot应用，命名为：alibaba-nacos-discovery-client-common,作为服务消费者 demo-consumer。<br> 第二步：编辑pom.xml中的依赖内容，与上面服务提供者的一样即可。<br> 第三步，创建 application.yaml 配置文件，添加相应配置项。配置如下</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>consumer <span class="token comment"># Spring 应用名</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token comment"># Nacos 作为注册中心的配置项，对应 NacosDiscoveryProperties 配置类</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># Nacos 服务器地址</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span> <span class="token comment"># 服务器端口。默认为 8080</span>
</code></pre> 
<p><strong>第四步：创建应用主类，并实现一个HTTP接口，在该接口中调用服务提供方的接口。</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TestApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Slf4j</span>
    <span class="token annotation punctuation">@RestController</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Autowired</span>
        <span class="token class-name">LoadBalancerClient</span> loadBalancerClient<span class="token punctuation">;</span>
        <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 通过spring cloud common中的负载均衡接口选取服务提供节点实现接口调用</span>
            <span class="token class-name">ServiceInstance</span> serviceInstance <span class="token operator">=</span> loadBalancerClient<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token string">"alibaba-nacos-discovery-server"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> url <span class="token operator">=</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/hello?name="</span> <span class="token operator">+</span> <span class="token string">"abc"</span><span class="token punctuation">;</span>
            <span class="token class-name">RestTemplate</span> restTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"Invoke : "</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">", return : "</span> <span class="token operator">+</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里使用了<code>Spring Cloud Common</code>中的<code>LoadBalancerClient</code>接口来挑选服务实例信息。然后从挑选出的实例信息中获取可访问的URI，拼接上服务提供方的接口规则来发起调用</p> 
<p>第五步，启动服务消费者，然后通过curl或者postman等工具发起访问，下面以curl为例：</p> 
<pre><code class="prism language-bash">$ <span class="token function">curl</span> localhost:9000/test
Invoke <span class="token builtin class-name">:</span> http://10.123.18.216:8001/hello?name<span class="token operator">=</span>didi, <span class="token builtin class-name">return</span> <span class="token builtin class-name">:</span> hello abc
$ <span class="token function">curl</span> localhost:9000/test
Invoke <span class="token builtin class-name">:</span> http://10.123.18.216:8002/hello?name<span class="token operator">=</span>didi, <span class="token builtin class-name">return</span> <span class="token builtin class-name">:</span> hello abc
</code></pre> 
<p>可以看到，两次不同请求的时候，真正实际调用的服务提供者实例是不同的，也就是说，<strong>通过<code>LoadBalancerClient</code>接口在获取服务实例的时候，已经实现了对服务提供方实例的负载均衡</strong>。但是很明显，这样的实现还是比较繁琐，</p> 
<h3><a id="_292"></a>数据模型</h3> 
<p>Nacos 数据模型 Key 由三元组唯一确认。如下图所示：<br> <img src="https://images2.imgbox.com/c9/ce/wio4ypaC_o.png" alt="在这里插入图片描述"></p> 
<ul><li><font color="red">作为注册中心时，Namespace + Group + Service</font></li><li><font color="red">作为配置中心时，Namespace + Group + DataId</font></li></ul> 
<h4><a id="Namespace__298"></a>Namespace 命名空间</h4> 
<p>用于进行租户粒度的配置隔离。<strong>默认为 public（公共命名空间）</strong>。<br> <strong>不同的命名空间下，可以存在相同的 Group 或 Data ID 的配置</strong>。Namespace 的常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等。</p> 
<h4><a id="Group__301"></a>Group 服务分组</h4> 
<p>不同的服务可以归类到同一分组。默认为 <strong>DEFAULT_GROUP</strong>（默认分组）。</p> 
<h4><a id="Service__303"></a>Service 服务</h4> 
<p>例如说，用户服务、订单服务、商品服务等等。</p> 
<h3><a id="_307"></a>服务领域模型</h3> 
<p>Service 可以进一步细拆服务领域模型，如下图：<img src="https://images2.imgbox.com/0b/46/3JHWikez_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Instance__309"></a>Instance 实例</h4> 
<p>提供一个或多个服务的具有可访问网络地址（IP:Port）的进程。<br> 以前面搭建的服务提供者服务为例：</p> 
<ul><li>如果我们启动<strong>一个 JVM 进程</strong>，就是服务 demo-provider 下的一个实例。</li><li>如果我们启动<strong>多个 JVM 进程</strong>，就是服务 demo-provider 下的多个实例。</li></ul> 
<h4><a id="Cluster__314"></a>Cluster 集群</h4> 
<p><strong>同一个服务下的所有服务实例组成一个默认集群（Default）</strong>。集群可以被进一步按需求划分，划分的单位可以是虚拟集群。<br> 例如说，我们将服务部署在多个机房之中，每个机房可以创建为一个虚拟集群。每个服务在注册到 Nacos 时，设置所在机房的虚拟集群。这样，服务在调用其它服务时，可以通过虚拟集群，优先调用本机房的服务。如此，在提升服务的可用性的同时，保证了性能。</p> 
<h4><a id="Metadata__317"></a>Metadata 元数据</h4> 
<p>Nacos 元数据（如配置和服务）描述信息，如服务版本、权重、容灾策略、负载均衡策略、鉴权配置、各种自定义标签 (label)。<br> 从作用范围来看，分为<strong>服务级别的元信息、集群的元信息及实例的元信息</strong>。</p> 
<p>以 Nacos 元数据的<strong>服务版本</strong>举例子。当一个接口实现，出现不兼容升级时，可以用版本号过渡，版本号不同的服务相互间不引用。<br> 可以按照以下的步骤进行版本迁移：</p> 
<ol><li>在低压力时间段，先升级一半提供者为新版本</li><li>再将所有消费者升级为新版本</li><li>然后将剩下的一半提供者升级为新版本</li></ol> 
<p>再次 Nacos 元数据的鉴权配置举例子。通过令牌验证在注册中心控制权限，以决定要不要下发令牌给消费者，可以防止消费者绕过注册中心访问提供者。另外，通过注册中心可灵活改变授权方式，而不需修改或升级提供者。<img src="https://images2.imgbox.com/49/58/jfep4prO_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Health_Check__329"></a>Health Check 健康检查</h4> 
<p>以指定方式检查服务下挂载的实例的健康度，从而确认该实例是否能提供服务。根据检查结果，实例会被判断为健康或不健康。<br> 对服务发起解析请求时，不健康的实例不会返回给客户端。</p> 
<p><strong>健康保护阈值</strong><br> 为了防止因过多实例不健康导致流量全部流向健康实例，继而造成流量压力把健康实例实例压垮并形成雪崩效应，应将健康保护阈值定义为一个 0 到 1 之间的浮点数。<br> 当域名健康实例占总服务实例的比例小于该值时，无论实例是否健康，都会将这个实例返回给客户端。这样做虽然损失了一部分流量，但是保证了集群的剩余健康实例能正常工作。</p> 
<h3><a id="_336"></a>支持的几种服务消费方式</h3> 
<p>（RestTemplate、WebClient、Feign）：</p> 
<h4><a id="RestTemplate_338"></a>使用RestTemplate</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TestApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Slf4j</span>
    <span class="token annotation punctuation">@RestController</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Autowired</span>
        <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>
        <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://alibaba-nacos-discovery-server/hello?name=abc"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"Return : "</span> <span class="token operator">+</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，在定义<code>RestTemplate</code>的时候，增加了<code>@LoadBalanced</code>注解，而在真正调用服务接口的时候，原来host部分是通过手工拼接ip和端口的，直接采用服务名的时候来写请求路径即可。在真正调用的时候，Spring Cloud会将请求拦截下来，然后通过负载均衡器选出节点，并替换服务名部分为具体的ip和端口，从而实现基于服务名的负载均衡调用。</p> 
<h4><a id="WebClient_369"></a>使用WebClient</h4> 
<p>WebClient是Spring 5中最新引入的，可以将其理解为reactive版的RestTemplate。下面举个具体的例子，它将实现与上面RestTemplate一样的请求调用：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestApplication</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TestApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Slf4j</span>
    <span class="token annotation punctuation">@RestController</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{<!-- --></span>

        <span class="token annotation punctuation">@Autowired</span>
        <span class="token keyword">private</span> <span class="token class-name">WebClient<span class="token punctuation">.</span>Builder</span> webClientBuilder<span class="token punctuation">;</span>

        <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> webClientBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">"http://alibaba-nacos-discovery-server/hello?name=abc"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">retrieve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">bodyToMono</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">public</span> <span class="token class-name">WebClient<span class="token punctuation">.</span>Builder</span> <span class="token function">loadBalancedWebClientBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">WebClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在定义<code>WebClient.Builder</code>的时候，也增加了<code>@LoadBalanced</code>注解，其原理与之前的RestTemplate时一样的。</p> 
<h4><a id="Feign_408"></a>使用Feign</h4> 
<p>RestTemplate和WebClient都是Spring自己封装的工具，接下来使用的是Netflix OSS中的成员，通过它可以更方便的定义和使用服务消费客户端。<br> <strong>第一步：在pom.xml中增加openfeign的依赖：</strong></p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><strong>第二步：定义Feign客户端和使用Feign客户端：</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestApplication</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TestApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Slf4j</span>
    <span class="token annotation punctuation">@RestController</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{<!-- --></span>

        <span class="token annotation punctuation">@Autowired</span>
        <span class="token class-name">Client</span> client<span class="token punctuation">;</span>

        <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> result <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token string">"didi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"Return : "</span> <span class="token operator">+</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"alibaba-nacos-discovery-server"</span><span class="token punctuation">)</span>
    <span class="token keyword">interface</span> <span class="token class-name">Client</span> <span class="token punctuation">{<!-- --></span>

        <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>
        <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>这里主要先通过<code>@EnableFeignClients</code>注解开启扫描<code>Spring Cloud Feign</code>客户端的功能；然后又创建一个<code>Feign</code>的客户端接口定义。使用<code>@FeignClient</code>注解来<strong>指定这个接口所要调用的服务名称</strong>，<mark>接口中定义的各个函数使用Spring MVC的注解就可以来绑定服务提供方的REST接口</mark>，比如下面就是绑定alibaba-nacos-discovery-server服务的/hello接口的例子。最后，在Controller中，注入了Client接口的实现，并调用hello方法来触发对服务提供方的调用。</p> 
<h3><a id="Nacos_458"></a>Nacos作为配置中心</h3> 
<p>Nacos除了实现了<strong>服务的注册发现之外</strong>，还将<strong>配置中心功能整合在了一起</strong>。Nacos的配置管理模型与淘宝开源的配置中心<code>Diamond</code>类似，基础层面都通过<code>DataId</code>和<code>Group</code>来定位配置内容，除此之外还增加了很多其他的管理功能。</p> 
<h4><a id="_460"></a>创建配置</h4> 
<p><strong>第一步：进入Nacos的控制页面，在配置列表功能页面中，点击右上角的“+”按钮，进入“新建配置”页面，如下图填写内容：</strong><img src="https://images2.imgbox.com/26/15/Gis8D2it_o.png" alt="在这里插入图片描述"></p> 
<p><strong>其中：</strong></p> 
<ul><li><code>Data ID</code>：填入<code>alibaba-nacos-config-client.properties</code></li><li><code>Group</code>：不修改，使用默认值<code>DEFAULT_GROUP</code></li><li><code>配置格式</code>：选择<code>Properties</code></li><li><code>配置内容</code>：应用要加载的配置内容，这里仅作为示例，做简单配置，比如：<code>didispace.title=spring-cloud-alibaba-learning</code></li></ul> 
<h4><a id="_469"></a>创建应用</h4> 
<p><strong>第一步：创建一个Spring Boot应用，可以命名为：<code>alibaba-nacos-config-client</code>。</strong><br> <strong>第二步：编辑pom.xml，加入必要的依赖配置，比如：</strong></p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.18.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><strong>上述内容主要三部分：</strong></p> 
<ul><li><code>parent</code>：定义spring boot的版本</li><li><code>dependencyManagement</code>：spring cloud的版本以及spring cloud alibaba的版本</li><li>dependencies：当前应用要使用的依赖内容。这里主要新加入了<code>Nacos的配置客户端模块</code>：<code>spring-cloud-starter-alibaba-nacos-config</code>。由于在dependencyManagement中已经引入了版本，所以这里就不用指定具体版本了。</li></ul> 
<blockquote> 
 <p>可以看到，这个例子中并没有加入nacos的服务发现模块，所以这两个内容是完全可以独立使用的</p> 
</blockquote> 
<p><strong>第三步：创建应用主类，并实现一个HTTP接口：</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TestApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Slf4j</span>
    <span class="token annotation punctuation">@RestController</span>
    <span class="token annotation punctuation">@RefreshScope</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${didispace.title:}"</span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>
        <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> title<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><code>@SpringBootApplication</code>定义是个Spring Boot应用；</li><li>还定义了一个Controller，其中通过<code>@Value</code>注解，注入了key为didispace.title的配置（默认为空字符串），这个配置会通过<code>/test</code>接口返回，后续我们会通过这个接口来验证Nacos中配置的加载。</li><li>另外，这里还有一个比较重要的注解<code>@RefreshScope</code>，主要用来<strong>让这个类下的配置内容支持动态刷新，也就是当我们的应用启动之后，修改了Nacos中的配置内容之后，这里也会马上生效。</strong></li></ul> 
<p><strong>第四步：创建配置文件bootstrap.properties，并配置服务名称和Nacos地址</strong></p> 
<pre><code class="prism language-java">spring<span class="token punctuation">.</span>application<span class="token punctuation">.</span>name<span class="token operator">=</span>alibaba<span class="token operator">-</span>nacos<span class="token operator">-</span>config<span class="token operator">-</span>client
server<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">8001</span>
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>server<span class="token operator">-</span>addr<span class="token operator">=</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8848</span>
</code></pre> 
<blockquote> 
 <p>注意：这里必须使用<code>bootstrap.properties</code>。同时，<code>spring.application.name</code>值必须与上一阶段Nacos中创建的配置<code>Data Id</code>匹配（除了.properties或者.yaml后缀）。</p> 
</blockquote> 
<p><strong>第五步：启动上面创建的应用。</strong></p> 
<pre><code class="prism language-java"><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">27</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">29</span><span class="token operator">:</span><span class="token number">43.497</span>  INFO <span class="token number">93597</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>n<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>NacosPropertySourceBuilder</span>   <span class="token operator">:</span> <span class="token class-name">Loading</span> nacos data<span class="token punctuation">,</span> dataId<span class="token operator">:</span> 'alibaba<span class="token operator">-</span>nacos<span class="token operator">-</span>config<span class="token operator">-</span>client<span class="token punctuation">.</span>properties'<span class="token punctuation">,</span> group<span class="token operator">:</span> 'DEFAULT_GROUP'
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">27</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">29</span><span class="token operator">:</span><span class="token number">43.498</span>  INFO <span class="token number">93597</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">b<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>PropertySourceBootstrapConfiguration</span> <span class="token operator">:</span> <span class="token class-name">Located</span> property source<span class="token operator">:</span> <span class="token class-name">CompositePropertySource</span> <span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span><span class="token char">'NACOS'</span><span class="token punctuation">,</span> propertySources<span class="token operator">=</span><span class="token punctuation">[</span><span class="token class-name">NacosPropertySource</span> <span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span>'alibaba<span class="token operator">-</span>nacos<span class="token operator">-</span>config<span class="token operator">-</span>client<span class="token punctuation">.</span>properties'<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>  
</code></pre> 
<p>在启动的时候，我们可以看到类似上面的日志信息，这里会输出应用程序要从Nacos中获取配置的<code>dataId</code>和<code>group</code>。如果在启动之后，发现配置信息没有获取到的时候，可以先从这里着手，看看配置加载的目标是否正确。</p> 
<p><strong>第六步：验证配置获取和验证动态刷新</strong><br> 用<code>curl</code>或者<code>postman</code>等工具，访问接口: <code>localhost:8001/test</code>，<strong>一切正常的话，将返回Nacos中配置的<code>spring-cloud-alibaba-learning</code></strong>。然后，再通过Nacos页面，修改这个内容，点击发布之后，再访问接口，可以看到返回结果变了。<br> <strong>同时，在应用的客户端，我们还能看到如下日志：</strong></p> 
<pre><code class="prism language-java"><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">27</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">14.162</span>  INFO <span class="token number">93597</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1_8848</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span>RefreshEventListener</span>       <span class="token operator">:</span> <span class="token class-name">Refresh</span> keys changed<span class="token operator">:</span> <span class="token punctuation">[</span>didispace<span class="token punctuation">.</span>title<span class="token punctuation">]</span>
</code></pre> 
<p>在Nacos中修改了Key，在用到这个配置的应用中，也自动刷新了这个配置信息。</p> 
<h3><a id="Nacos_555"></a>Nacos配置的加载规则详解</h3> 
<p><img src="https://images2.imgbox.com/e9/c1/3ExA5YH1_o.png" alt="在这里插入图片描述"></p> 
<p><strong>图中的Nacos中创建的配置内容是这样的：</strong></p> 
<ul><li><code>Data ID</code>：alibaba-nacos-config-client.properties</li></ul> 
<ul><li><code>Group</code>：DEFAULT_GROUP<br> <strong>拆解一下，主要有三个元素，它们与具体应用的配置内容对应关系如下：</strong></li><li>Data ID中的<code>alibaba-nacos-config-client</code>：对应客户端的配置<code>spring.cloud.nacos.config.prefix</code>，默认值为<code>${spring.application.name}</code>，即：<mark><strong>服务名</strong></mark></li><li>Data ID中的<code>properties</code>：对应客户端的配置<code>spring.cloud.nacos.config.file-extension</code>，默认值为<code>properties</code></li><li>Group的值<code>DEFAULT_GROUP</code>：对应客户端的配置<code>spring.cloud.nacos.config.group</code>，默认值为<code>DEFAULT_GROUP</code><br> 在采用默认值的应用要加载的配置规则就是：<code>Data ID=${spring.application.name}.properties</code>，<code>Group=DEFAULT_GROUP</code>。</li></ul> 
<p><strong>例子一：</strong> 如果我们不想通过服务名来加载，那么可以增加如下配置，就会加载到<code>Data ID=example.properties</code>，<code>Group=DEFAULT_GROUP</code>的配置内容了：</p> 
<pre><code class="prism language-bash">spring.cloud.nacos.config.prefix<span class="token operator">=</span>example
</code></pre> 
<p><strong>例子二：</strong> 如果我们想要加载yaml格式的内容，而不是Properties格式的内容，那么可以通过如下配置，实现加载<code>Data ID=example.yaml</code>，<code>Group=DEFAULT_GROUP</code>的配置内容了：</p> 
<pre><code class="prism language-bash">spring.cloud.nacos.config.prefix<span class="token operator">=</span>example
spring.cloud.nacos.config.file-extension<span class="token operator">=</span>yaml
</code></pre> 
<p><strong>例子三</strong>：如果我们对配置做了分组管理，那么可以通过如下配置，实现加载<code>Data ID=example.yaml</code>，<code>Group=DEV_GROUP</code>的配置内容了：</p> 
<pre><code class="prism language-java">spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>prefix<span class="token operator">=</span>example
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>file<span class="token operator">-</span>extension<span class="token operator">=</span>yaml
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>group<span class="token operator">=</span>DEV_GROUP
</code></pre> 
<h3><a id="Nacos_589"></a>Nacos的多环境管理</h3> 
<h4><a id="Data_IDprofiles_590"></a>使用Data ID与profiles实现</h4> 
<p><code>Data ID</code>在Nacos中，我们可以理解为就是一个<code>Spring Cloud应用的配置文件名</code>。我们知道默认情况下<code>Data ID</code>的名称格式是这样的：<code>${spring.application.name}.properties</code>，即：<strong>以Spring Cloud应用命名的properties文件。</strong></p> 
<p>实际上，<code>Data ID</code>的规则中，还包含了环境逻辑，这一点与Spring Cloud Config的设计类似。我们在应用启动时，可以通过<code>spring.profiles.active</code>来指定<strong>具体的环境名称</strong>，此时客户端就会把要获取配置的<code>Data ID</code>组织为：<code>${spring.application.name}-${spring.profiles.active}.properties</code>。</p> 
<blockquote> 
 <p>实际上，更原始且最通用的匹配规则，是这样的：<code>${spring.cloud.nacos.config.prefix}-${spring.profile.active}.${spring.cloud.nacos.config.file-extension}</code>。而上面的结果是因为<code>${spring.cloud.nacos.config.prefix}</code>和<code>${spring.cloud.nacos.config.file-extension}</code>都使用了默认值。</p> 
</blockquote> 
<p><strong>第一步：先在Nacos中，根据这个规则，创建两个不同环境的配置内容。比如：</strong><br> <img src="https://images2.imgbox.com/9f/0f/Xrlp8LMj_o.png" alt="在这里插入图片描述"></p> 
<p>如上图，我们为<code>alibaba-nacos-config-client</code>应用，定义了<code>DEV</code>和<code>TEST</code>的两个独立的环境配置。我们可以在里面定义不同的内容值，以便后续验证是否真实加载到了正确的配置。<br> <strong>第二步：在<code>alibaba-nacos-config-client</code>应用的配置文件中，增加环境配置：<code>spring.profiles.active=DEV</code></strong><br> <strong>第三步：启动应用，我们可以看到日志中打印了，加载的配置文件：</strong></p> 
<pre><code class="prism language-java"><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">30</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">18.216</span>  INFO <span class="token number">96958</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>n<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>NacosPropertySourceBuilder</span>   <span class="token operator">:</span> <span class="token class-name">Loading</span> nacos data<span class="token punctuation">,</span> dataId<span class="token operator">:</span> 'alibaba<span class="token operator">-</span>nacos<span class="token operator">-</span>config<span class="token operator">-</span>client<span class="token operator">-</span>DEV<span class="token punctuation">.</span>properties'<span class="token punctuation">,</span> group<span class="token operator">:</span> 'DEFAULT_GROUP'
</code></pre> 
<h4><a id="Group_609"></a>使用Group实现</h4> 
<p><strong>第一步：先在Nacos中，通过区分Group来创建两个不同环境的配置内容。比如：</strong> <img src="https://images2.imgbox.com/41/89/OimVqHjn_o.png" alt="在这里插入图片描述"></p> 
<p>如上图，我们为<code>alibaba-nacos-config-client</code>应用，定义了<code>DEV</code>环境和<code>TEST</code>环境的两个独立的配置，这两个匹配与上一种方法不同，它们的<code>Data ID</code>是完全相同的，只是<code>GROUP</code>不同。</p> 
<p><strong>第二步：在alibaba-nacos-config-client应用的配置文件中，增加Group的指定配置</strong><code>spring.cloud.nacos.config.group=DEV_GROUP</code></p> 
<p><strong>第三步：启动应用，我们可以看到日志中打印了，加载的配置文件：</strong></p> 
<pre><code class="prism language-java"><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">30</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">23.718</span>  INFO <span class="token number">3216</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>n<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>NacosPropertySourceBuilder</span>   <span class="token operator">:</span> <span class="token class-name">Loading</span> nacos data<span class="token punctuation">,</span> dataId<span class="token operator">:</span> 'alibaba<span class="token operator">-</span>nacos<span class="token operator">-</span>config<span class="token operator">-</span>client<span class="token punctuation">.</span>properties'<span class="token punctuation">,</span> group<span class="token operator">:</span> 'DEV_GROUP' 
</code></pre> 
<h4><a id="Namespace_622"></a>使用Namespace实现</h4> 
<p><code>Namespace</code>,用于进行租户粒度的配置隔离。<strong>不同的命名空间下，可以存在相同的<code>Group</code>或<code>Data ID</code>的配置</strong>。Namespace的常用场景之一是不同环境的配置的区分隔离，例如：开发测试环境和生产环境的资源（如配置、服务）隔离等。</p> 
<p><strong>第一步：先在Nacos中，根据环境名称来创建多个Namespace。比如：</strong><br> <img src="https://images2.imgbox.com/00/7c/fgqSqfHP_o.png" alt="在这里插入图片描述"></p> 
<p>第二步：在配置列表的最上方，可以看到除了<code>Public</code>之外，多了几个刚才创建的Namepsace。分别在<code>DEV</code>和<code>TEST</code>空间下为<code>alibaba-nacos-config-client</code>应用创建配置内容：<br> <img src="https://images2.imgbox.com/03/36/lT2nq7KA_o.png" alt="在这里插入图片描述"></p> 
<p>第三步：在<code>alibaba-nacos-config-client</code>应用的配置文件中，增加<code>Namespace</code>的指定配置，比如：<code>spring.cloud.nacos.config.namespace=83eed625-d166-4619-b923-93df2088883a。</code></p> 
<blockquote> 
 <p>这里需要注意<code>namespace</code>的配置<strong>不是使用名称，而是使用<code>Namespace的ID</code></strong>。</p> 
</blockquote> 
<p>第四步：启动应用，通过访问<code>localhost:8001/test</code>接口，验证一下返回内容是否正确。</p> 
<h3><a id="Nacos_638"></a>Nacos配置的多文件加载与共享配置</h3> 
<h4><a id="Nacos_639"></a>Nacos配置的多文件加载</h4> 
<p>Spring应用对Nacos中配置内容的对应关系是通过下面三个参数控制的：</p> 
<ul><li>spring.cloud.nacos.config.prefix</li><li>spring.cloud.nacos.config.file-extension</li><li>spring.cloud.nacos.config.group</li></ul> 
<p>默认情况下，会加载<code>Data ID=${spring.application.name}.properties</code>，<code>Group=DEFAULT_GROUP</code>的配置。</p> 
<p>假设现在有这样的一个需求：我们想要对所有应用的Actuator模块以及日志输出做统一的配置管理。所以，我们希望可以将Actuator模块的配置放在独立的配置文件<code>actuator.properties</code>文件中，而对于日志输出的配置放在独立的配置文件<code>log.properties</code>文件中。通过拆分这两类配置内容，希望可以做到配置的共享加载与统一管理。<br> 这时候，我们只需要做以下两步，就可以实现这个需求 :<br> <strong>第一步：在Nacos中创建<code>Data ID=actuator.properties</code>，<code>Group=DEFAULT_GROUP</code>和<code>Data ID=log.properties</code>，<code>Group=DEFAULT_GROUP</code>的配置内容。</strong><br> <img src="https://images2.imgbox.com/80/79/6MoLCepv_o.png" alt="在这里插入图片描述"></p> 
<p><strong>第二步：在Spring Cloud应用中通过使用<code>spring.cloud.nacos.config.ext-config</code>参数来配置要加载的这两个配置内容，比如：</strong></p> 
<pre><code class="prism language-java">spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ext<span class="token operator">-</span>config<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token operator">-</span>id<span class="token operator">=</span>actuator<span class="token punctuation">.</span>properties
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ext<span class="token operator">-</span>config<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>group<span class="token operator">=</span>DEFAULT_GROUP
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ext<span class="token operator">-</span>config<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>refresh<span class="token operator">=</span><span class="token boolean">true</span>
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ext<span class="token operator">-</span>config<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token operator">-</span>id<span class="token operator">=</span>log<span class="token punctuation">.</span>properties
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ext<span class="token operator">-</span>config<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>group<span class="token operator">=</span>DEFAULT_GROUP
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ext<span class="token operator">-</span>config<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>refresh<span class="token operator">=</span><span class="token boolean">true</span>
</code></pre> 
<p>可以看到，<code>spring.cloud.nacos.config.ext-config</code>配置是一个<code>数组List类型</code>。每个配置中包含三个参数：<code>data-id</code>、<code>group</code>，<code>refresh</code>；前两个不做赘述，与Nacos中创建的配置相互对应，<code>refresh</code>参数控制<strong>这个配置文件中的内容是否支持自动刷新</strong>，<strong>默认情况下，只有默认加载的配置才会自动刷新，对于这些扩展的配置加载内容需要配置该设置时候才会实现自动刷新。</strong></p> 
<h4><a id="_665"></a>共享配置</h4> 
<p>通过上面加载多个配置的实现，实际上我们已经可以实现不同应用共享配置了。但是Nacos中还提供了另外一个便捷的配置方式，比如下面的设置与上面使用的配置内容是等价的：</p> 
<pre><code class="prism language-java">spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>shared<span class="token operator">-</span>dataids<span class="token operator">=</span>actuator<span class="token punctuation">.</span>properties<span class="token punctuation">,</span>log<span class="token punctuation">.</span>properties
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>refreshable<span class="token operator">-</span>dataids<span class="token operator">=</span>actuator<span class="token punctuation">.</span>properties<span class="token punctuation">,</span>log<span class="token punctuation">.</span>properties
</code></pre> 
<ul><li><code>spring.cloud.nacos.config.shared-dataids</code>参数用来<strong>配置多个共享配置的<code>Data Id</code>，多个的时候用用逗号分隔</strong></li><li><code>spring.cloud.nacos.config.refreshable-dataids</code>参数用来<strong>定义哪些共享配置的<code>Data Id</code>在配置变化时，应用中可以动态刷新，多个Data Id之间用逗号隔开。如果没有明确配置，默认情况下所有共享配置都不支持动态刷新</strong></li></ul> 
<h4><a id="_675"></a>配置加载的优先级</h4> 
<p>在使用Nacos配置的时候，主要有以下三类配置：</p> 
<ul><li>A: 通过<code>spring.cloud.nacos.config.shared-dataids</code>定义的共享配置</li><li>B: 通过<code>spring.cloud.nacos.config.ext-config[n]</code>定义的加载配置</li><li>C: <strong>通过内部规则</strong>（<code>spring.cloud.nacos.config.prefix</code>、<code>spring.cloud.nacos.config.file-extension</code>、<code>spring.cloud.nacos.config.group</code>这几个参数）拼接出来的配置</li></ul> 
<p><strong>要弄清楚这几个配置加载的顺序，我们从日志中也可以很清晰的看到，我们可以做一个简单的实验：</strong></p> 
<pre><code class="prism language-java">spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ext<span class="token operator">-</span>config<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token operator">-</span>id<span class="token operator">=</span>actuator<span class="token punctuation">.</span>properties
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ext<span class="token operator">-</span>config<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>group<span class="token operator">=</span>DEFAULT_GROUP
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ext<span class="token operator">-</span>config<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>refresh<span class="token operator">=</span><span class="token boolean">true</span>

spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>shared<span class="token operator">-</span>dataids<span class="token operator">=</span>log<span class="token punctuation">.</span>properties
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>refreshable<span class="token operator">-</span>dataids<span class="token operator">=</span>log<span class="token punctuation">.</span>properties
</code></pre> 
<p><strong>根据上面的配置，应用分别会去加载三类不同的配置文件，启动应用的时候，将会在日志中看到如下输出：</strong></p> 
<pre><code class="prism language-java"><span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">02.665</span>  INFO <span class="token number">63804</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>n<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>NacosPropertySourceBuilder</span>   <span class="token operator">:</span> <span class="token class-name">Loading</span> nacos data<span class="token punctuation">,</span> dataId<span class="token operator">:</span> 'log<span class="token punctuation">.</span>properties'<span class="token punctuation">,</span> group<span class="token operator">:</span> 'DEFAULT_GROUP' 
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">02.671</span>  INFO <span class="token number">63804</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>n<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>NacosPropertySourceBuilder</span>   <span class="token operator">:</span> <span class="token class-name">Loading</span> nacos data<span class="token punctuation">,</span> dataId<span class="token operator">:</span> 'actuator<span class="token punctuation">.</span>properties'<span class="token punctuation">,</span> group<span class="token operator">:</span> 'DEFAULT_GROUP' 
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">02.677</span>  INFO <span class="token number">63804</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>n<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>NacosPropertySourceBuilder</span>   <span class="token operator">:</span> <span class="token class-name">Loading</span> nacos data<span class="token punctuation">,</span> dataId<span class="token operator">:</span> 'alibaba<span class="token operator">-</span>nacos<span class="token operator">-</span>config<span class="token operator">-</span>client<span class="token punctuation">.</span>properties'<span class="token punctuation">,</span> group<span class="token operator">:</span> 'DEFAULT_GROUP'
</code></pre> 
<p><strong>后面加载的配置会覆盖之前加载的配置，所以优先级关系是：A &lt; B &lt; C</strong></p> 
<p><mark><strong>结论： 后面加载的配置会覆盖之前加载的配置，所以优先级关系是：A &lt; B &lt; C</strong></mark></p> 
<h3><a id="_703"></a>数据持久化</h3> 
<p><strong>在搭建Nacos集群之前，我们需要先修改Nacos的数据持久化配置为MySQL存储</strong>。默认情况下，Nacos使用嵌入式数据库实现数据的存储。所以，如果启动多个默认配置下的Nacos节点，数据存储是存在一致性问题的。为了解决这个问题，Nacos采用了集中式存储的方式来支持集群化部署，目前只要支持MySQL的存储。</p> 
<p>配置Nacos的MySQL存储只需要下面三步：</p> 
<ul><li> <p><strong>第一步</strong>：安装数据库，版本要求：5.6.5+</p> </li><li> <p><strong>第二步</strong>：初始化MySQL数据库，数据库初始化文件：<code>nacos-mysql.sql</code>，该文件可以在Nacos程序包下的<code>conf</code>目录下获得。执行完成后可以得到如下图所示的表结构：<br> <img src="https://images2.imgbox.com/c0/0d/12tFNPQY_o.png" alt="在这里插入图片描述"></p> </li><li> <p><strong>第三步</strong>：修改<code>conf/application.properties</code>文件，增加支持MySQL数据源配置，添加（目前只支持mysql）数据源的url、用户名和密码。配置样例如下：</p> </li></ul> 
<pre><code class="prism language-java">spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>platform<span class="token operator">=</span>mysql

db<span class="token punctuation">.</span>num<span class="token operator">=</span><span class="token number">1</span>
db<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">=</span>jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>nacos<span class="token operator">?</span>characterEncoding<span class="token operator">=</span>utf8<span class="token operator">&amp;</span>connectTimeout<span class="token operator">=</span><span class="token number">1000</span><span class="token operator">&amp;</span>socketTimeout<span class="token operator">=</span><span class="token number">3000</span><span class="token operator">&amp;</span>autoReconnect<span class="token operator">=</span><span class="token boolean">true</span>
db<span class="token punctuation">.</span>user<span class="token operator">=</span>root
db<span class="token punctuation">.</span>password<span class="token operator">=</span>
</code></pre> 
<h3><a id="_722"></a>集群搭建</h3> 
<p>根据官方文档的介绍，Nacos的集群架构大致如下图所示（省略了集中化存储信息的MySQL）：</p> 
<p><img src="https://images2.imgbox.com/88/b2/4tEshRpm_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="MySQL_727"></a>MySQL数据源配置</h4> 
<p><strong>在进行集群配置之前，先完成对MySQL数据源的初始化和配置。主要分以下两步：</strong></p> 
<ul><li>第一步：<strong>初始化MySQL数据库</strong>，数据库初始化文件：<code>nacos-mysql.sql</code>，该文件可以在Nacos程序包下的conf目录下获得。</li><li>第二步：<strong>修改conf/application.properties文件</strong>，增加支持MySQL数据源配置，添加（目前只支持mysql）数据源的url、用户名和密码。配置样例如下：</li></ul> 
<pre><code class="prism language-java">spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>platform<span class="token operator">=</span>mysql

db<span class="token punctuation">.</span>num<span class="token operator">=</span><span class="token number">1</span>
db<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">=</span>jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>nacos<span class="token operator">?</span>characterEncoding<span class="token operator">=</span>utf8<span class="token operator">&amp;</span>connectTimeout<span class="token operator">=</span><span class="token number">1000</span><span class="token operator">&amp;</span>socketTimeout<span class="token operator">=</span><span class="token number">3000</span><span class="token operator">&amp;</span>autoReconnect<span class="token operator">=</span><span class="token boolean">true</span>
db<span class="token punctuation">.</span>user<span class="token operator">=</span>root
db<span class="token punctuation">.</span>password<span class="token operator">=</span>
</code></pre> 
<h4><a id="_740"></a>集群配置</h4> 
<p>在Nacos的<code>conf</code>目录下有一个<code>cluster.conf.example</code>，可以直接把<code>example</code>扩展名去掉来使用，也可以单独创建一个<code>cluster.conf</code>文件，然后打开将后续要部署的<strong>Nacos实例地址</strong>配置在这里。</p> 
<pre><code class="prism language-java"><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8841</span>
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8842</span>
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8843</span>
</code></pre> 
<blockquote> 
 <p>注意：Nacos的集群需要<strong>3个或3个以上</strong>的节点，并且确保这三个节点之间是可以<strong>互相访问</strong>的。</p> 
</blockquote> 
<h4><a id="_751"></a>启动实例</h4> 
<h5><a id="_752"></a>本地测试</h5> 
<p>为了可以方便地启动Nacos的三个本地实例，我们可以将<code>bin</code>目录下的<code>startup.sh</code>脚本复制三份，分别用来启动三个不同端口的Nacos实例，为了可以方便区分不同实例的启动脚本，我们可以把端口号加入到脚本的命名中，比如：</p> 
<ul><li>startup-8841.sh</li><li>startup-8842.sh</li><li>startup-8843.sh</li></ul> 
<p>然后，分别修改这三个脚本中的参数，具体如下图的红色部分（端口号根据上面脚本命名分配）： <img src="https://images2.imgbox.com/77/8a/6gU3ssvQ_o.png" alt="在这里插入图片描述"></p> 
<p>这里我们通过<code>-Dserver.port</code>的方式，在启动命令中，为Nacos指定具体的端口号，以实现在本机上启动三个不同的Nacos实例来组成集群。</p> 
<p>修改完3个脚本配置之后，分别执行下面的命令就可以在本地启动Nacos集群了：</p> 
<pre><code class="prism language-java">sh startup<span class="token operator">-</span><span class="token number">8841.</span>sh
sh startup<span class="token operator">-</span><span class="token number">8842.</span>sh
sh startup<span class="token operator">-</span><span class="token number">8843.</span>sh
</code></pre> 
<h5><a id="_771"></a>生产环境</h5> 
<p>在实际生产环境部署的时候，由于每个实例分布在不同的节点上，我们可以直接使用默认的启动脚本（除非要调整一些JVM参数等才需要修改）。只需要在各个节点的Nacos的<code>bin</code>目录下执行<code>sh startup.sh</code>命令即可。</p> 
<h5><a id="Proxy_773"></a>Proxy配置</h5> 
<p>在Nacos的集群启动完毕之后，根据架构图所示，我们还需要提供一个统一的入口给我们用来维护以及给Spring Cloud应用访问。简单地说，就是我们需要为上面启动的的三个Nacos实例做一个可以为它们实现负载均衡的访问点。这个实现的方式非常多，这里就举个用Nginx来实现的简单例子吧。<br> <strong>在Nginx配置文件的http段中，我们可以加入下面的配置内容：</strong><br> <img src="https://images2.imgbox.com/8e/b6/bl6O2bgs_o.png" alt="在这里插入图片描述"></p> 
<p>这样，当我们访问：<code>http://localhost:8080/nacos/</code>的时候，就会被负载均衡的代理到之前我们启动的三个Nacos实例上了。这里我们没有配置upstream的具体策略，默认会使用线性轮训的方式 。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/22a53ae36d2f9c2586414cf285faa8ff/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">epoll的LT模式（水平触发）和ET模式（边沿触发）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/13b9d2d822b255f18469eb69f7d438af/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于SpringMVC页面跳转不了的问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>