<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>浅谈JavaAgent - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="浅谈JavaAgent" />
<meta property="og:description" content="文章首发于先知社区：浅谈JavaAgent
Java Agent Javaagent是java命令的一个参数。参数 Javaagent 可以用于指定一个 jar 包，并且对该 java 包有2个要求：
这个 jar 包的 MANIFEST.MF 文件必须指定 Premain-Class 项。Premain-Class 指定的那个类必须实现 premain() 方法。 premain 方法，从字面上理解，就是运行在 main 函数之前的的类。当Java 虚拟机启动时，在执行 main 函数之前，JVM 会先运行-javaagent所指定 jar 包内 Premain-Class 这个类的 premain 方法 。
启动时加载Agent 前边提到premain()函数，它实在main函数之前运行的，也就是启动时加载的Agent，函数声明如下，Instrumentation inst参数的方法优先级更高：
public static void agentmain(String agentArgs, Instrumentation inst) { ... } public static void agentmain(String agentArgs) { ... } String agentArgs 就是Java agent后跟的参数。
Instrumentaion inst 用于和目标JVM进行交互，从而达到修改数据的效果。
先看下premain()函数的具体使用：
PreMainDemo import java.lang.instrument.Instrumentation; public class PreMainDemo { public static void premain(String agentArgs, Instrumentation inst){ System." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1a04affdd2e1e370bb843b9d43b9c2a0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-02T22:05:39+08:00" />
<meta property="article:modified_time" content="2023-07-02T22:05:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">浅谈JavaAgent</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>文章首发于先知社区：<a href="https://xz.aliyun.com/t/12626" rel="nofollow">浅谈JavaAgent</a></p> 
</blockquote> 
<h2><a id="Java_Agent_2"></a>Java Agent</h2> 
<p>Javaagent是java命令的一个参数。参数 Javaagent 可以用于指定一个 jar 包，并且对该 java 包有2个要求：</p> 
<ol><li>这个 jar 包的 MANIFEST.MF 文件必须指定 Premain-Class 项。</li><li>Premain-Class 指定的那个类必须实现 premain() 方法。</li></ol> 
<p>premain 方法，从字面上理解，就是运行在 main 函数之前的的类。当Java 虚拟机启动时，在执行 main 函数之前，JVM 会先运行<code>-javaagent</code>所指定 jar 包内 Premain-Class 这个类的 premain 方法 。</p> 
<h3><a id="Agent_11"></a>启动时加载Agent</h3> 
<p>前边提到<code>premain()</code>函数，它实在main函数之前运行的，也就是启动时加载的Agent，函数声明如下，<code>Instrumentation inst</code>参数的方法<strong>优先级更高</strong>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li> <p><code>String agentArgs</code> 就是Java agent后跟的参数。</p> </li><li> <p><code>Instrumentaion inst</code> 用于和目标JVM进行交互，从而达到修改数据的效果。</p> </li></ul> 
<p>先看下premain()函数的具体使用：</p> 
<h4><a id="PreMainDemo_31"></a><strong>PreMainDemo</strong></h4> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>instrument<span class="token punctuation">.</span></span><span class="token class-name">Instrumentation</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PreMainDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>agentArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">5</span> <span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"premain is loading....."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接着打包，先创建 mainfest(注：在前边说到过文件中一定要有Premain-Class属性，其次最后要有空行)</p> 
<p><strong>agent.mf</strong></p> 
<pre><code class="prism language-java"><span class="token class-name">Manifest</span><span class="token operator">-</span><span class="token class-name">Version</span><span class="token operator">:</span> <span class="token number">1.0</span>
<span class="token class-name">Premain</span><span class="token operator">-</span><span class="token class-name">Class</span><span class="token operator">:</span> <span class="token class-name">Agent<span class="token punctuation">.</span>PreMainDemo</span>

</code></pre> 
<p><strong>agent.jar</strong></p> 
<p>将msf文件和PreMainDemo打成一个jar包</p> 
<pre><code class="prism language-java">jar cvfm agent<span class="token punctuation">.</span>jar agent<span class="token punctuation">.</span>mf <span class="token class-name">Agent</span>\<span class="token class-name">PreMainDemo</span><span class="token punctuation">.</span><span class="token keyword">class</span>
</code></pre> 
<p>前边说到premain是在main函数之前调用的，所以这里再写个带有main的测试类</p> 
<h4><a id="Hellojava_66"></a><strong>Hello.java</strong></h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello,Sentiment!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>Hello.mf</strong></p> 
<pre><code class="prism language-java"><span class="token class-name">Manifest</span><span class="token operator">-</span><span class="token class-name">Version</span><span class="token operator">:</span> <span class="token number">1.0</span>
<span class="token class-name">Main</span><span class="token operator">-</span><span class="token class-name">Class</span><span class="token operator">:</span> <span class="token class-name">Agent<span class="token punctuation">.</span>Hello</span>

</code></pre> 
<p><strong>hello.jar</strong></p> 
<pre><code class="prism language-java">jar cvfm hello<span class="token punctuation">.</span>jar <span class="token class-name">Hello</span><span class="token punctuation">.</span>mf <span class="token class-name">Agent</span>\<span class="token class-name">Hello</span><span class="token punctuation">.</span><span class="token keyword">class</span>
</code></pre> 
<p>之后就是利用<code>-javaagent</code>进行加载</p> 
<pre><code class="prism language-java">java <span class="token operator">-</span>javaagent<span class="token operator">:</span>agent<span class="token punctuation">.</span>jar<span class="token operator">=</span><span class="token class-name">Sentiment</span> <span class="token operator">-</span>jar hello<span class="token punctuation">.</span>jar
</code></pre> 
<p>可以看到我们 agent 中 premain 的代码被优先执行了，同时还获取 到了 agentArgs 参数</p> 
<p><img src="https://images2.imgbox.com/04/d8/sQQtN5xr_o.png" alt="在这里插入图片描述"></p> 
<p>这种有个比较明显的弊端：若目标服务器已启动，则无法预先加载premain。</p> 
<h3><a id="_Agent_102"></a>启动后加载 Agent</h3> 
<p>在前边说到agent中用到的两种加载方式，第二种就是<code>agentmain</code>，这种方式就有效的解决了上述premain中提到的弊端，因为他是启动后加载的。</p> 
<p>函数声明如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> agentmain <span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> agentmain <span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">)</span>
</code></pre> 
<p>官方为了实现启动后加载，提供了<code>Attach API</code>。Attach API 很简单，只有 2 个主要的类，都在 <code>com.sun.tools.attach</code> 包里面。这里有两个比较重要的类，分别是 VirtualMachine 和 VirtualMachineDescriptor。</p> 
<p>由于Attach API 在 tool.jar 中，jvm 启动时是默认不加载该依赖的，所以需要手动加载进去</p> 
<p><img src="https://images2.imgbox.com/e0/20/ylr0u8MV_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="VirtualMachine_119"></a>VirtualMachine</h4> 
<p>VirtualMachine 可以来实现获取系统信息，内存dump、线程dump、类信息统计（例如JVM加载的类）。里面配备有几个方法LoadAgent，Attach 和 Detach 。下面来看看这几个方法的作用</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">VirtualMachine</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获得当前所有的JVM列表</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VirtualMachineDescriptor</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

    <span class="token comment">// 根据pid连接到JVM</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">VirtualMachine</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

    <span class="token comment">// 断开连接</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token comment">// 加载agent，agentmain方法靠的就是这个方法</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadAgent</span><span class="token punctuation">(</span><span class="token class-name">String</span> agent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>list</strong>：获取所有JVM列表</li><li><strong>Attach</strong> ：允许我们通过给attach方法传入一个jvm的pid(进程id)，远程连接到jvm上</li><li><strong>loadAgent</strong>：向jvm注册一个代理程序agent，在该agent的代理程序中会得到一个Instrumentation实例，该实例可以 在class加载前改变class的字节码，也可以在class加载后重新加载。在调用Instrumentation实例的方法时，这些方法会使用ClassFileTransformer接口中提供的方法进行处理。</li><li><strong>Detach</strong>：断开连接即解除代理</li></ul> 
<p>VirtualMachineDescriptor 就不做探究了，其实就是个描述虚拟机的容器类，配合 VirtualMachine 使用的。</p> 
<h5><a id="AgentMainDemo_147"></a>AgentMainDemo</h5> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentMainDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"agentmain start........."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>agent.mf</strong></p> 
<pre><code class="prism language-java"><span class="token class-name">Manifest</span><span class="token operator">-</span><span class="token class-name">Version</span><span class="token operator">:</span> <span class="token number">1.0</span>
<span class="token class-name">Agent</span><span class="token operator">-</span><span class="token class-name">Class</span><span class="token operator">:</span> <span class="token class-name">Agent<span class="token punctuation">.</span>AgentMainDemo</span>

</code></pre> 
<p>打包</p> 
<pre><code class="prism language-java">jar cvfm agent<span class="token punctuation">.</span>jar agent<span class="token punctuation">.</span>mf <span class="token class-name">Agent</span>\<span class="token class-name">AgentMainDemo</span><span class="token punctuation">.</span><span class="token keyword">class</span>
</code></pre> 
<h5><a id="Hellojava_171"></a><strong>Hello.java</strong></h5> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello.main() in test project start!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello.main() in test project  end!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行Hello.java后，会sleep等待状态来模拟正常服务，此时查看java服务进程发现，Hello的进程是14460<br> <img src="https://images2.imgbox.com/b6/8d/xevZQAvK_o.png" alt="在这里插入图片描述"></p> 
<p>接着就用attach绑定pid进程，并通过<strong>loadAgent</strong>绑定对应的agent.jar来调用</p> 
<h5><a id="AttchDemo_189"></a><strong>AttchDemo</strong></h5> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AttchDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AgentLoadException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">AgentInitializationException</span><span class="token punctuation">,</span> <span class="token class-name">AttachNotSupportedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">VirtualMachine</span> attach <span class="token operator">=</span> <span class="token class-name">VirtualMachine</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token string">"14460"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 命令行找到这个jvm的进程号</span>
        attach<span class="token punctuation">.</span><span class="token function">loadAgent</span><span class="token punctuation">(</span><span class="token string">"D:\\java\\AgentMemory\\target\\classes\\agent.jar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        attach<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行后可以发现在输出<code>Hello.main() in test project end!!</code>前输出了我们agent中的语句<code>agentmain start.........</code>，达到了启动服务后仍能加载Agent的效果</p> 
<p><img src="https://images2.imgbox.com/d0/0b/F8DdQ8Xj_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_205"></a>动态修改字节码</h2> 
<p>agentmain中有一个形参Instrumentation，通过它能和目标 JVM 进行交互，结合Javassist修改数据，达到真正Agent的效果。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> agentmain <span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="Instrumentation_213"></a>Instrumentation</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Instrumentation</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 增加一个 Class 文件的转换器，转换器用于改变 Class 二进制流的数据，参数 canRetransform 设置是否允许重新转换。在类加载之前，重新定义 Class 文件，ClassDefinition 表示对一个类新的定义，如果在类加载之后，需要使用 retransformClasses 方法重新定义。addTransformer方法配置之后，后续的类加载都会被Transformer拦截。对于已经加载过的类，可以执行retransformClasses来重新触发这个Transformer的拦截。类加载的字节码被修改后，除非再次被retransform，否则不会恢复。</span>
    <span class="token keyword">void</span> <span class="token function">addTransformer</span><span class="token punctuation">(</span><span class="token class-name">ClassFileTransformer</span> transformer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 删除一个类转换器</span>
    <span class="token keyword">boolean</span> <span class="token function">removeTransformer</span><span class="token punctuation">(</span><span class="token class-name">ClassFileTransformer</span> transformer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 在类加载之后，重新定义 Class。这个很重要，该方法是1.6 之后加入的，事实上，该方法是 update 了一个类。</span>
    <span class="token keyword">void</span> <span class="token function">retransformClasses</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> classes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnmodifiableClassException</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断目标类是否能够修改。</span>
    <span class="token keyword">boolean</span> <span class="token function">isModifiableClass</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> theClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取目标已经加载的类。</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"rawtypes"</span><span class="token punctuation">)</span>
    <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getAllLoadedClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>先看下getAllLoadedClasses<code>和</code>isModifiableClasses`。</p> 
<h4><a id="getAllLoadedClasses_240"></a>getAllLoadedClasses</h4> 
<p>获取所有已经加载的类。</p> 
<p>还是用刚才的例子，只是换下<code>AgentMainDemo</code>类的代码</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentMainDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classes <span class="token operator">=</span> inst<span class="token punctuation">.</span><span class="token function">getAllLoadedClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span> aClass <span class="token operator">:</span> classes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token string">"class ==&gt; "</span> <span class="token operator">+</span> aClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到打印出了所有已经加载的类</p> 
<p><img src="https://images2.imgbox.com/2f/44/ENJY84yu_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="isModifiableClasses_262"></a>isModifiableClasses</h4> 
<p>判断该类是否可以修改</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentMainDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classes <span class="token operator">=</span> inst<span class="token punctuation">.</span><span class="token function">getAllLoadedClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span> aClass <span class="token operator">:</span> classes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token string">"class ==&gt; "</span> <span class="token operator">+</span> aClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> aClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n\t"</span> <span class="token operator">+</span> <span class="token string">"Modifiable ==&gt; "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>inst<span class="token punctuation">.</span><span class="token function">isModifiableClass</span><span class="token punctuation">(</span>aClass<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"true"</span> <span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a7/f8/Q7kJc28e_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="ClassFileTransformer_282"></a>ClassFileTransformer</h3> 
<p>Instrumentation中还有两个比较重要的类，但是这两个类的都有一个共同类型的形参<code>ClassFileTransformer </code>，所以先来了解一下这个transform</p> 
<pre><code class="prism language-java"><span class="token comment">// 添加 Transformer</span>
<span class="token keyword">void</span> <span class="token function">addTransformer</span><span class="token punctuation">(</span><span class="token class-name">ClassFileTransformer</span> transformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 触发 Transformer</span>
<span class="token keyword">boolean</span> <span class="token function">removeTransformer</span><span class="token punctuation">(</span><span class="token class-name">ClassFileTransformer</span> transformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>ClassFileTransformer</code>中只有一个方法</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ClassFileTransformer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">default</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token function">transform</span><span class="token punctuation">(</span>  <span class="token class-name">ClassLoader</span>         loader<span class="token punctuation">,</span>
                <span class="token class-name">String</span>              className<span class="token punctuation">,</span>
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span>            classBeingRedefined<span class="token punctuation">,</span>
                <span class="token class-name">ProtectionDomain</span>    protectionDomain<span class="token punctuation">,</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>              classfileBuffer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中<code>classBeingRedefined</code>为我们要修改的类，他的值受retransformClasses函数传入的值影响，即：</p> 
<pre><code class="prism language-java">inst<span class="token punctuation">.</span><span class="token function">retransformClasses</span><span class="token punctuation">(</span><span class="token class-name">Hello</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>当<code>retransformClasses</code>中的值是Hello类时，那此时的<code>classBeingRedefined</code>对应的类也就是Hello，根据调用栈也不难看出(<strong>这个后续会用到</strong>)</p> 
<p><img src="https://images2.imgbox.com/46/5c/OYht0CZ8_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Javassist_318"></a>Javassist</h4> 
<p>知道了<code>retransformClasses</code>的用处之后，我们就可以通过构造<code>retransformClasses</code>方法中的值，来自定义要重新修改的字节码文件</p> 
<p>而修改字节码就牵扯到了Javassist，前文有介绍过就不多说了：https://blog.csdn.net/weixin_54902210/article/details/129562446</p> 
<p>这里就介绍一点：</p> 
<blockquote> 
 <p>如果程序运行在 JBoss 或者 Tomcat 等 Web 服务器上，ClassPool 可能无法找到用户的类，因为 Web 服务器使用多个类加载器作为系统类加载器。在这种情况下，<strong>ClassPool 必须添加额外的类搜索路径</strong>，使用insertClassPath()函数</p> 
</blockquote> 
<pre><code class="prism language-java">cp<span class="token punctuation">.</span><span class="token function">insertClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassClassPath</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>insertClassPath中要填写的是我们要修改文件的路径，而前文提到<code>classBeingRedefined</code>存储的就是我们要修改的类，所以这里只需要改成：</p> 
<pre><code class="prism language-java"><span class="token class-name">ClassClassPath</span> ccp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassClassPath</span><span class="token punctuation">(</span>classBeingRedefined<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这样就可以避免无法加载类的情况</p> 
<h3><a id="_340"></a>测试</h3> 
<p><strong>Hello</strong></p> 
<p>这个是我们要修改的类</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"This is Sentiment !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>HelloWorld</strong></p> 
<p>这个类通过sleep()进行隔断，前后调用两次Hello()方法，来验证我们修改完字节码后的结果</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloWorld</span>  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Hello</span> h1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">h1<span class="token punctuation">.</span></span>Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">15000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Hello</span> h2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">h2<span class="token punctuation">.</span></span>Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>AgentMainDemo</strong></p> 
<p>agentmain类，它会触发TransformerDemo()类中的transform()</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentMainDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnmodifiableClassException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classes <span class="token operator">=</span> inst<span class="token punctuation">.</span><span class="token function">getAllLoadedClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span> aClass <span class="token operator">:</span> classes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>aClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">TransformerDemo</span><span class="token punctuation">.</span>editClassName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token comment">// 添加 Transformer</span>
                inst<span class="token punctuation">.</span><span class="token function">addTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransformerDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 触发 Transformer</span>
                inst<span class="token punctuation">.</span><span class="token function">retransformClasses</span><span class="token punctuation">(</span>aClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>TransformerDemo</strong></p> 
<p>这个类就是要通过<code>agentmain()</code>的<code>retransformClasses()</code>方法触发的ClassFileTransformer</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformerDemo</span> <span class="token keyword">implements</span> <span class="token class-name">ClassFileTransformer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> editClassName <span class="token operator">=</span> <span class="token string">"Agent.Hello"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> editMethod <span class="token operator">=</span> <span class="token string">"Hello"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> classBeingRedefined<span class="token punctuation">,</span> <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalClassFormatException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ClassPool</span> cp <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>classBeingRedefined <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">ClassClassPath</span> ccp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassClassPath</span><span class="token punctuation">(</span>classBeingRedefined<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cp<span class="token punctuation">.</span><span class="token function">insertClassPath</span><span class="token punctuation">(</span>ccp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">CtClass</span> ctc <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>editClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CtMethod</span> method <span class="token operator">=</span> ctc<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span>editMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">//将Hello中的函数体改成System.out.println("Has been modified");</span>
            <span class="token class-name">String</span> source <span class="token operator">=</span> <span class="token string">"{System.out.println(\"Has been modified\");}"</span><span class="token punctuation">;</span>
            method<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> ctc<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ctc<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> bytes<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>agent.mf</strong></p> 
<p><strong>注意</strong>：如果需要修改已经被JVM加载过的类的字节码，那么还需要设置在 MANIFEST.MF 中添加 Can-Retransform-Classes: true 或 Can-Redefine-Classes: true，其次别忘了空格</p> 
<pre><code class="prism language-java"><span class="token class-name">Manifest</span><span class="token operator">-</span><span class="token class-name">Version</span><span class="token operator">:</span> <span class="token number">1.0</span>
<span class="token class-name">Can</span><span class="token operator">-</span><span class="token class-name">Redefine</span><span class="token operator">-</span><span class="token class-name">Classes</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token class-name">Can</span><span class="token operator">-</span><span class="token class-name">Retransform</span><span class="token operator">-</span><span class="token class-name">Classes</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token class-name">Agent</span><span class="token operator">-</span><span class="token class-name">Class</span><span class="token operator">:</span> <span class="token class-name">Agent<span class="token punctuation">.</span>AgentMainDemo</span>

</code></pre> 
<p>打成jar包</p> 
<pre><code class="prism language-java">jar cvfm agent<span class="token punctuation">.</span>jar <span class="token class-name">Hello</span><span class="token punctuation">.</span>mf <span class="token class-name">Agent</span>\<span class="token class-name">AgentMainDemo</span><span class="token punctuation">.</span><span class="token keyword">class</span>
</code></pre> 
<p>运行HelloWorld，获取其进程号，然后通过自定义的Attch类加载agent包</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AttchDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AgentLoadException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">AgentInitializationException</span><span class="token punctuation">,</span> <span class="token class-name">AttachNotSupportedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">VirtualMachine</span> attach <span class="token operator">=</span> <span class="token class-name">VirtualMachine</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token string">"15484"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 命令行找到这个jvm的进程号</span>
        attach<span class="token punctuation">.</span><span class="token function">loadAgent</span><span class="token punctuation">(</span><span class="token string">"D:\\java\\AgentMemory\\target\\classes\\agent.jar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        attach<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/bc/01/sCIWevWm_o.png" alt="在这里插入图片描述"></p> 
<p>可看到结果原本应该是输出：</p> 
<pre><code class="prism language-java"><span class="token class-name">This</span> is <span class="token class-name">Sentiment</span> <span class="token operator">!</span>
<span class="token class-name">This</span> is <span class="token class-name">Sentiment</span> <span class="token operator">!</span>
</code></pre> 
<p>但在输出第二条语句时通过agentMain的Transform进行了拦截修改成了<code>Has been modified</code>，因此结果为：</p> 
<pre><code class="prism language-java"><span class="token class-name">This</span> is <span class="token class-name">Sentiment</span> <span class="token operator">!</span>
<span class="token class-name">Has</span> been modified
</code></pre> 
<h2><a id="_474"></a>参考</h2> 
<p><a href="https://blog.csdn.net/weixin_54902210/article/details/126353573">[Java安全]—Agent内存马_Sentiment.的博客-CSDN博客</a><br> https://blog.csdn.net/weixin_54902210/article/details/129562446</p> 
<p><a href="https://xz.aliyun.com/t/9450" rel="nofollow">Java Agent 从入门到内存马 - 先知社区 (aliyun.com)</a></p> 
<p><a href="https://www.cnblogs.com/bitterz/p/15080403.html" rel="nofollow">从零开始的Java RASP实现(一) - bitterz - 博客园 (cnblogs.com)</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/10fe5df1b7624ed9e43136981719c03e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">第十周：机器学习周报</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6dfc764c75e7e85c8644f2a3e067d02b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">操作系统之调度算法总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>