<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【嵌入式环境下linux内核及驱动学习笔记-（19）LCD驱动框架2-FrameBuffer】 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【嵌入式环境下linux内核及驱动学习笔记-（19）LCD驱动框架2-FrameBuffer】" />
<meta property="og:description" content="目录 1、 Frmebuffer(帧缓冲）操作介绍1.1 显示设备的抽象1.2 内存映像1.3 输出画面数据1.4 用户态下操作屏显1.4.1 用文件I / O 操作屏显1.4.2 mmap() 函数1.4.3 ioctl()函数1.4.5 用命令操作屏1.4.6 测试程序 2、Framebuffer总体框架2.1 框架要点2.2 fbmem.c分析2.2.1 fbmem的入口分析2.2.2 fbmem的接口功能2.2.2.1 向上的接口2.2.2.2 向下的接口 2.2.3 相关函数详解2.2.3.1 proc_create()函数2.2.3.2 fb_proc_fops结构体变量2.2.3.3. register_chrdev()函数2.2.3.4 class_create()函数2.2.3.5 register_framebuffer()函数 2.3 LCD驱动分析（设备树匹配的platform平台驱动）2.3.1 设备树相关内容2.3.2 数据结构及函数struct fb_infostruct fb_var_screeninfo 和 struct fb_fix_screeninfostruct fb_var_screeninfostruct fb_fix_screeninfostruct fb_videomode结构体fb_var_to_videomode()与 fb_videomode_to_var()函数struct fb_ops宏 module_platform_driver 2.3.3 LCD驱动的结构与步骤 3、驱动程序实例4、测试LCD显示的应用程序写在结尾参考 1、 Frmebuffer(帧缓冲）操作介绍 1.1 显示设备的抽象 \qquad Linux是工作在保护模式下，Linux抽象出FrameBuffer这个设备来供用户态进程实现直接写屏。
\qquad Framebuffer机制模仿显卡的功能，将显卡硬件结构抽象掉，可以通过Framebuffer的读写直接对显存进行操作。用户可以将Framebuffer看成是显示内存的一个映像，将其映射到进程地址空间之后，就可以直接进行读写操作，而写操作可以立即反应在屏幕上。这种操作是抽象的，统一的。用户不必关心物理显存的位置、换页机制等等具体细节。这些都是由Framebuffer设备驱动来完成的。
1.2 内存映像 \qquad 显示画面的输出，实际是通过往显存里面写像素数据来实现的。由于显存实际是处于内核态的物理内存，所以下一步要把这块物理内存映射到用户态，这样应用程序就可以直接操作这块物理内存了。
\qquad 内存的映像是在使用时，由使用者通过mmap命令实现的。
1.3 输出画面数据 \qquad 我们有了显存之后，要如何才能将画面数据写入显存了？
\qquad 假设我们当前的环境， xres_virtual、yres_virtual分别为800，960；bpp（像素深度）为32位；所以每个像素用一个int来表示，虚拟屏幕尺寸为800*960像素。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a9d7526f49d372e707faa3726281bbe4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-13T23:38:20+08:00" />
<meta property="article:modified_time" content="2023-08-13T23:38:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【嵌入式环境下linux内核及驱动学习笔记-（19）LCD驱动框架2-FrameBuffer】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#1_Frmebuffer_4" rel="nofollow">1、 Frmebuffer(帧缓冲）操作介绍</a></li><li><ul><li><a href="#11__5" rel="nofollow">1.1 显示设备的抽象</a></li><li><a href="#12__10" rel="nofollow">1.2 内存映像</a></li><li><a href="#13__13" rel="nofollow">1.3 输出画面数据</a></li><li><a href="#14__21" rel="nofollow">1.4 用户态下操作屏显</a></li><li><ul><li><a href="#141_I__O__22" rel="nofollow">1.4.1 用文件I / O 操作屏显</a></li><li><a href="#142_mmap__50" rel="nofollow">1.4.2 mmap() 函数</a></li><li><a href="#143_ioctl_88" rel="nofollow">1.4.3 ioctl()函数</a></li><li><a href="#145__148" rel="nofollow">1.4.5 用命令操作屏</a></li><li><a href="#146__163" rel="nofollow">1.4.6 测试程序</a></li></ul> 
  </li></ul> 
  </li><li><a href="#2Framebuffer_188" rel="nofollow">2、Framebuffer总体框架</a></li><li><ul><li><a href="#21__190" rel="nofollow">2.1 框架要点</a></li><li><a href="#22_fbmemc_222" rel="nofollow">2.2 fbmem.c分析</a></li><li><ul><li><a href="#221__fbmem_226" rel="nofollow">2.2.1 fbmem的入口分析</a></li><li><a href="#222__fbmem_240" rel="nofollow">2.2.2 fbmem的接口功能</a></li><li><ul><li><a href="#2221__242" rel="nofollow">2.2.2.1 向上的接口</a></li><li><a href="#2222__265" rel="nofollow">2.2.2.2 向下的接口</a></li></ul> 
    </li><li><a href="#223__274" rel="nofollow">2.2.3 相关函数详解</a></li><li><ul><li><a href="#2231_proc_create_275" rel="nofollow">2.2.3.1 proc_create()函数</a></li><li><a href="#2232_fb_proc_fops_293" rel="nofollow">2.2.3.2 fb_proc_fops结构体变量</a></li><li><a href="#2233_register_chrdev_317" rel="nofollow">2.2.3.3. register_chrdev()函数</a></li><li><a href="#2234_class_create_342" rel="nofollow">2.2.3.4 class_create()函数</a></li><li><a href="#2235_register_framebuffer_363" rel="nofollow">2.2.3.5 register_framebuffer()函数</a></li></ul> 
   </li></ul> 
   </li><li><a href="#23_LCDplatform_386" rel="nofollow">2.3 LCD驱动分析（设备树匹配的platform平台驱动）</a></li><li><ul><li><a href="#231___393" rel="nofollow">2.3.1 设备树相关内容</a></li><li><a href="#232__406" rel="nofollow">2.3.2 数据结构及函数</a></li><li><ul><li><a href="#struct__fb_info_408" rel="nofollow">struct fb_info</a></li><li><a href="#struct__fb_var_screeninfo___struct_fb_fix_screeninfo_511" rel="nofollow">struct fb_var_screeninfo 和 struct fb_fix_screeninfo</a></li><li><a href="#struct_fb_var_screeninfo_514" rel="nofollow">struct fb_var_screeninfo</a></li><li><a href="#struct_fb_fix_screeninfo_587" rel="nofollow">struct fb_fix_screeninfo</a></li><li><a href="#struct_fb_videomode_628" rel="nofollow">struct fb_videomode结构体</a></li><li><a href="#fb_var_to_videomode_fb_videomode_to_var_630" rel="nofollow">fb_var_to_videomode()与 fb_videomode_to_var()函数</a></li><li><a href="#struct___fb_ops_695" rel="nofollow">struct fb_ops</a></li><li><a href="#_module_platform_driver_773" rel="nofollow">宏 module_platform_driver</a></li></ul> 
    </li><li><a href="#233_LCD_813" rel="nofollow">2.3.3 LCD驱动的结构与步骤</a></li></ul> 
  </li></ul> 
  </li><li><a href="#3_831" rel="nofollow">3、驱动程序实例</a></li><li><a href="#4LCD_1252" rel="nofollow">4、测试LCD显示的应用程序</a></li><li><a href="#_1343" rel="nofollow">写在结尾</a></li><li><a href="#_1354" rel="nofollow">参考</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1_Frmebuffer_4"></a>1、 Frmebuffer(帧缓冲）操作介绍</h2> 
<h3><a id="11__5"></a>1.1 显示设备的抽象</h3> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>Linux是工作在保护模式下，Linux抽象出FrameBuffer这个设备来供用户态进程实现直接写屏。</p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>Framebuffer机制模仿显卡的功能，将显卡硬件结构抽象掉，可以通过Framebuffer的读写直接对显存进行操作。用户可以将Framebuffer看成是显示内存的一个映像，将其映射到进程地址空间之后，就可以直接进行读写操作，而写操作可以立即反应在屏幕上。这种操作是抽象的，统一的。用户不必关心物理显存的位置、换页机制等等具体细节。这些都是由Framebuffer设备驱动来完成的。</p> 
<h3><a id="12__10"></a>1.2 内存映像</h3> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>显示画面的输出，实际是通过往显存里面写像素数据来实现的。由于显存实际是处于内核态的物理内存，所以下一步要把这块物理内存映射到用户态，这样应用程序就可以直接操作这块物理内存了。<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>内存的映像是在使用时，由使用者通过mmap命令实现的。</p> 
<h3><a id="13__13"></a>1.3 输出画面数据</h3> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>我们有了显存之后，要如何才能将画面数据写入显存了？<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>假设我们当前的环境， xres_virtual、yres_virtual分别为800，960；bpp（像素深度）为32位；所以每个像素用一个int来表示，虚拟屏幕尺寸为800*960像素。<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>显存中，数据排布的顺序就是按照虚拟屏幕中像素数据从上到下，从左到右的数据来排布。而每一个像素数据则按照A（透明度）、R（红）、G（绿）、B（蓝）的顺序排布的。<br> <img src="https://images2.imgbox.com/4e/07/MkQbFbnf_o.png" alt="在这里插入图片描述" width="400"></p> 
<h3><a id="14__21"></a>1.4 用户态下操作屏显</h3> 
<h4><a id="141_I__O__22"></a>1.4.1 用文件I / O 操作屏显</h4> 
<p>在Linux环境下,可以通过framebuffer设备文件(/dev/fb0等)来操作LCD屏幕。具体步骤如下:</p> 
<ol><li>打开framebuffer设备文件:</li></ol> 
<pre><code class="prism language-c"><span class="token keyword">int</span> fbfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/fb0"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>通过ioctl()来获取framebuffer参数,如屏分辨率,像素格式等:</li></ol> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">fb_var_screeninfo</span> vinfo<span class="token punctuation">;</span>
<span class="token function">ioctl</span><span class="token punctuation">(</span>fbfd<span class="token punctuation">,</span> FBIOGET_VSCREENINFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="3"><li>通过mmap()来映射LCD屏幕的显存到用户空间,得到一个指针fbp:</li></ol> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token operator">*</span>fbp <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> vinfo<span class="token punctuation">.</span>xres <span class="token operator">*</span> vinfo<span class="token punctuation">.</span>yres <span class="token operator">*</span> vinfo<span class="token punctuation">.</span>bits_per_pixel <span class="token operator">/</span> <span class="token number">8</span> <span class="token punctuation">,</span> 
                 PROT_READ <span class="token operator">|</span> PROT_WRIT E<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fbfd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="4"><li>可以通过fbp指针来直接操作显存,实现画点,画线,填充等功能。</li><li>通过ioctl(FBIOPUT_VSCREENINFO)来修改vinfo参数,实现Resolution修改,色深变化等功能。</li><li>unmap显存:</li></ol> 
<pre><code class="prism language-c"><span class="token function">munmap</span><span class="token punctuation">(</span>fbp<span class="token punctuation">,</span> vinfo<span class="token punctuation">.</span>xres <span class="token operator">*</span> vinfo<span class="token punctuation">.</span>yres <span class="token operator">*</span> vinfo<span class="token punctuation">.</span>bits_per_pixel <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="7"><li>关闭framebuffer设备文件:</li></ol> 
<pre><code class="prism language-c"><span class="token function">close</span><span class="token punctuation">(</span>fbfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>总之,通过framebuffer设备,我们可以获得屏幕信息,映射显存,直接操作显存来刷屏,这就是不使用GUI的原生LCD屏幕操作方法。</p> 
<h4><a id="142_mmap__50"></a>1.4.2 mmap() 函数</h4> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>mmap是Linux系统调用,用于映射设备(如文件)的权限到进程的地址空间。对于framebuffer设备,我们可以通过mmap来映射LCD屏幕的显存到进程的用户空间,然后就可以直接操作显存来刷新屏幕。<br> mmap的原型如下:</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>参数说明:</strong></p> 
<ul><li>addr: 要映射的内存块的起始地址,一般设为NULL让系统选择地址</li><li>length: 要映射的内存块的大小</li><li>prot: 设定内存块的访问权限,如PROT_READ、PROT_WRITE、PROT_EXEC等</li><li>flags: 设定映射类型,如MAP_SHARED、MAP_PRIVATE等</li><li>fd: 要映射的文件描述符</li><li>offset: 文件映射的偏移量</li></ul> 
<p><strong>对于framebuffer,主要步骤如下:</strong></p> 
<ol><li>打开/dev/fb0获取文件描述符fd</li><li>通过ioctl获取屏参数,如分辨率、色深等,计算映射大小length</li><li>mmap映射:</li></ol> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token operator">*</span>fbp <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<ul><li>这里我们要读写显存,所以权限为PROT_READ | PROT_WRITE</li><li>映射类型为MAP_SHARED,因为多个进程可能要同时访问屏幕</li><li>偏移量offset为0,从文件开始映射</li></ul> 
<ol start="4"><li>fbp就是映射到用户空间的显存指针,可以直接操作它来刷屏</li><li>用munmap释放映射:</li></ol> 
<pre><code class="prism language-c"><span class="token function">munmap</span><span class="token punctuation">(</span>fbp<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>mmap的优点是可以直接操作物理内存,速度快;优点是会占用内存空间,并且映射和unmap也需要时间。<br> 所以简单来说,mmap实现的是文件(物理内存)到进程虚拟地址空间的映射,我们可以通过虚拟地址直接操作文件(物理内存)。</p> 
<h4><a id="143_ioctl_88"></a>1.4.3 ioctl()函数</h4> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>ioctl()系统调用用于在用户空间和驱动空间之间传递信息。对于framebuffer设备,我们可以通过ioctl来获取和修改LCD屏的相关参数。主要的ioctl命令如下:</p> 
<ul><li>1、 FBIOGET_VSCREENINFO: 获取可变屏幕参数,如分辨率、色彩模式等.<br> 从字面上可以理解为“fb ioctl, get variable screen info”：获取应用程序可改变的参数（如设定的分辨率）</li></ul> 
<p><strong>用法:</strong></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fb.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">fb_var_screeninfo</span> vinfo<span class="token punctuation">;</span>
<span class="token function">ioctl</span><span class="token punctuation">(</span>fbfd<span class="token punctuation">,</span> FBIOGET_VSCREENINFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>用法:</strong></p> 
<pre><code class="prism language-c"><span class="token function">ioctl</span><span class="token punctuation">(</span>fbfd<span class="token punctuation">,</span> FBIOPUT_VSCREENINFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>3、 FBIOGET_FSCREENINFO:获取固定屏参数,对应的数据结构是fb_fix_screeninfo,包括帧缓冲区大小等信息。<br> 从字面上理解“fb ioctl, get fixed screen info”：获取固定的参数（如屏幕的分辨率）<br> <strong>用法:</strong></li></ul> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">fb_fix_screeninfo</span> finfo<span class="token punctuation">;</span>  
<span class="token function">ioctl</span><span class="token punctuation">(</span>fbfd<span class="token punctuation">,</span> FBIOGET_FSCREENINFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>finfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>4、 FBIOBLANK: 设置屏幕的blanking参数,用于开启或关闭屏幕显示。<br> <strong>用法:</strong></li></ul> 
<pre><code class="prism language-c"><span class="token keyword">int</span> blank_mode <span class="token operator">=</span> FB_BLANK_UNBLANK<span class="token punctuation">;</span>   <span class="token comment">//开屏</span>
<span class="token function">ioctl</span><span class="token punctuation">(</span>fbfd<span class="token punctuation">,</span> FBIOBLANK<span class="token punctuation">,</span> blank_mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>5、 FBIOGETCMAP: 获取颜色映射表<br> <strong>用法:</strong></li></ul> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">fb_cmap</span> cmap<span class="token punctuation">;</span>
<span class="token function">ioctl</span><span class="token punctuation">(</span>fbfd<span class="token punctuation">,</span> FBIOGETCMAP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cmap<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<ul><li> <p>6、 FBIOPUTCMAP: 设置颜色映射表<br> **用法:**同 FBIOGETCMAP</p> </li><li> <p>7、 FBIOGET_CON2FBMAP: 获取虚拟控制台到framebuffer的映射<br> <strong>用法:</strong></p> </li></ul> 
<pre><code class="prism language-c">__u32 console_fb_map<span class="token punctuation">[</span>MAX_NR_CONSOLES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">ioctl</span><span class="token punctuation">(</span>fbfd<span class="token punctuation">,</span> FBIOGET_CON2FBMAP<span class="token punctuation">,</span> console_fb_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li> <p>8、 FBIOPUT_CON2FBMAP: 设置虚拟控制台到framebuffer的映射<br> **用法:**同FBIOGET_CON2FBMAP</p> </li><li> <p>9、. FBIOGET_VBLANK: 获取垂直空白中断相关参数<br> <strong>用法:</strong></p> </li></ul> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">fb_vblank</span> vblank<span class="token punctuation">;</span>
<span class="token function">ioctl</span><span class="token punctuation">(</span>fbfd<span class="token punctuation">,</span> FBIOGET_VBLANK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vblank<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre> 
<h4><a id="145__148"></a>1.4.5 用命令操作屏</h4> 
<p>framebuffer的设备文件一般是<code>/dev/fb0、/dev/fb1</code>等等。</p> 
<p>可以用命令: <code>dd if=/dev/zero of=/dev/fb </code>清空屏幕.</p> 
<p>如果显示模式是1024x768-8 位色，用命令：<br> <code>dd if=/dev/zero of=/dev/fb0 bs=1024 count=768 </code>清空屏幕；</p> 
<p>用命令: <code>dd if=/dev/fb0 of=fbfile </code>可以将fb中的内容保存下来；</p> 
<p>可以重新写回屏幕: <code>dd if=fbfile of=/dev/fb</code>；</p> 
<p>在使用Framebuffer时，Linux是将显卡置于图形模式下的。</p> 
<h4><a id="146__163"></a>1.4.6 测试程序</h4> 
<p>在测试前，可以先在系统中查看lcd参数</p> 
<p>输入 cat /sys/class/graphics/fb0/modes即可查看分辨率<br> 输入cat /dev/urandom &gt; /dev/fb0即可知晓fb是否能正常工作</p> 
<pre><code class="prism language-c">fb_test<span class="token punctuation">.</span>c
该程序在用户态打开fb0，然后，用ioctl函数读出fb可变参数与固定参数。然后用两个函数在framebuff上绘制背影和线条
</code></pre> 
<blockquote> 
 <p>编译正确后，需要切换到tty模式运行测试程序：<br> 1、按ctrl+alt+F1 进入tty模式<br> 2、登录，进入工作目录内<br> 3、运行./fb_test.efl<br> 4、运行结束后，按ctrl+alt+F7退出，回到x server状态</p> 
</blockquote> 
<hr> 
<h2><a id="2Framebuffer_188"></a>2、Framebuffer总体框架</h2> 
<h3><a id="21__190"></a>2.1 框架要点</h3> 
<ul><li>Framebuffer(帧缓冲）是Linux系统为显示设备提供的一个接口，它将显示缓冲区抽象，并屏蔽图像硬件的底层差异，允许上层应用程序在图形模式下直接对显示缓冲区进行读写操作。</li><li> 
  <ul><li>framebuffer帧缓冲（简称fb）是一个platform类型设备，设备文件位于/dev/fbn。（n或以是0，1，…）</li></ul> </li><li> 
  <ul><li>framebuffer向应用层提供一个统一标准接口的显示设备。不论最终输出是通过hdmi还是lcd控制器，可以认为所有的GUI都是向fb输出画面的。</li></ul> </li><li>对于帧缓冲设备而言，只要在显示缓冲区中与显示点对应的区域内写入着色值，对应的着色会自动在屏幕上显示。</li><li> 
  <ul><li>实际上是frambuffer就是linux内核驱动申请的一片内存空间，然后lcd内有一片sram，cpu内部有个lcd控制器，它有个单独的dma用来将frambuffer中的数据拷贝到lcd的sram中去，拷贝到lcd的sram中的数据就会显示在lcd上，具体数据的内容是由应用程序控制的。</li></ul> </li><li> 
  <ul><li>LCD驱动和framebuffer驱动没有必然的联系，它只是驱动LCD正常工作的，比如有信号传过来，那么LCD驱动负责把信号转成显示屏上的内容，至于什么内容，怎么显示，它根本不关心也不知道。</li></ul> </li><li> 
  <ul><li>对于现代LCD，有一种“多屏叠加”的机制，即一个LCD设备可以有多个独立虚拟屏幕，以达到画面叠加的效果。所以fb与LCD不是一对一的关系，在常见的情况下，一个LCD对应了fb0~fb4。像QT这种GUI会默认把画面输出到fb0</li></ul> </li></ul> 
<p><img src="https://images2.imgbox.com/e0/14/J3uXaD9R_o.png" alt="在这里插入图片描述"></p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>上图是Linux帧缓冲设备驱动结构是一个四层结构。从下到上分别为硬件（LCD控制器）、设备驱动（需要使用者开发）、fbmem层（系统已完成）、应用层（需要使用者开发应用程序）。而与驱动框架密切相关的就是中间这两层fbmem层和设备驱动层。<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>fb的结构由内核中的fb框架实现一部分（上图中的fbmem.c），然后再由设备驱动本身实现一部分（图中的xxxfb.c）。设备驱动本身就是一个普通的platform总线驱动 。</p> 
<ul><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            f 
           
          
            b 
           
          
            m 
           
          
            e 
           
          
            m 
           
          
            层 
           
          
         
        
       
         \color{red}{fbmem层} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord mathnormal" style="margin-right: 0.1076em; color: red;">f</span><span class="mord mathnormal" style="color: red;">bm</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="color: red;">m</span><span class="mord cjk_fallback" style="color: red;">层</span></span></span></span></span></span>主要完成了“上传下达”的任务：</li><li> 
  <ul><li>1、向下获buffer地址。</li></ul> </li><li> 
  <ul><li>2、创建设备类（graphics）。</li></ul> </li><li> 
  <ul><li>3、注册字符设备主设备号。</li></ul> </li><li> 
  <ul><li>4、向上提供操作函数接口。</li></ul> </li><li><font color="red">驱动设备层</font>主要完成了“驱动”的任务：</li><li> 
  <ul><li>1、创建buffer。</li></ul> </li><li> 
  <ul><li>2、构建设备模型（完成数据结构fb_info填写）</li></ul> </li><li> 
  <ul><li>3、设置LCD控制器的寄存器。</li></ul> </li><li> 
  <ul><li>4、实现设备的操作接口fb_ops。</li></ul> </li></ul> 
<p>下面这图是另一个角度来描述分层的概念。更宏观一点，有助于参考：</p> 
<p><img src="https://images2.imgbox.com/49/b7/9SuAkrl8_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22_fbmemc_222"></a>2.2 fbmem.c分析</h3> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>fbmem.c实质也是一个驱动模块，是在linux系统启动时自动加载的。对于驱动模块，我们分为两个方面来分析，一是驱动的启动入口__init函数，启动时做了什么。二是fbmem提供了什么接口和能力，为LCD的驱动模块提供了哪些能力。</p> 
<h4><a id="221__fbmem_226"></a>2.2.1 fbmem的入口分析</h4> 
<p>对于驱动程序首先从其入口的__init 函数分析起，这个__init 入口函数是在该驱动被加载时首先运行的。源码如下：</p> 
<p><img src="https://images2.imgbox.com/b6/f2/9mZM6n37_o.png" alt="在这里插入图片描述"></p> 
<p>上图可以看出，fbmem启动时只做了几个简单的工作：</p> 
<ul><li>1、创建了/proc/fb文件，并关联了struct file_operations fb_proc_fops结构体，用于绑定/proc中操作fb文件的相关函数。</li><li>2、创建了一个主设备号为29的主设备（注意，这里只是建立了主设备，没有具体的fb设备），并关联了fb_fops，用于向用户层使用/dev/fbx设备提供接口。</li><li>3、创建了一个设备类，生成一个类文件/sys/class/graphics<br> （具体的上面的三个函数 可以看下面的4.2.3节。）</li></ul> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>fbmem在启动初始化阶段只做了一些很简单的共性的工作。重要的是创建了主设备号29，并向用户层提供了两个操作接口。</p> 
<h4><a id="222__fbmem_240"></a>2.2.2 fbmem的接口功能</h4> 
<p>fbmem的接口，有对上（用户层）的接口，也有对（LCD控制器）向下的接口。</p> 
<h5><a id="2221__242"></a>2.2.2.1 向上的接口</h5> 
<p><strong>提供了用户层操作的接口函数：</strong><br> 向上的接口有两个，一个是与用户操作相关的fb_fops这个结构体变量。提供了默认的open，read，ioctrl等操作接口。因此下面主要讨论的是这个接口。另一个向上接口是对内存文件系统/proc中的fb进行操作的接口。</p> 
<p><strong>在fbmem.c中，fb_fops和fb_proc_fops是两个不同的结构体变量，分别用于不同的用途，源码中定义如下：</strong><br> <img src="https://images2.imgbox.com/53/fb/5Rpnjwde_o.png" alt="在这里插入图片描述"></p> 
<table><thead><tr><th align="left">fb_fops作用</th><th align="left">fb_proc_fops作用</th></tr></thead><tbody><tr><td align="left"><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
        
         
          
           
          
         
           \qquad 
          
         
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>fb_fops是用于定义fb设备在文件系统中的普通文件操作的结构体变量，它定义了打开、读取、写入、寻址等操作的回调函数。这个结构体变量被用于处理用户对fb设备文件的操作，例如通过open()函数打开设备文件、通过read()函数读取设备文件的内容等。</td><td align="left"><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
        
         
          
           
          
         
           \qquad 
          
         
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>而fb_proc_fops是用于定义fb设备在/proc文件系统中的文件操作的结构体变量。在Linux内核中，/proc文件系统是一种特殊的文件系统，用于提供内核和进程的运行时信息。/proc/fb是一个特殊的文件，它提供了有关帧缓冲设备的一些信息，如设备名称、设备类型、设备大小等。</td></tr></tbody></table> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span> 可以看到，fb_fops和fb_proc_fops是用于不同的文件系统和不同的操作类型的结构体变量。它们分别定义了对应于不同文件系统中的fb设备的文件操作。这样设计的目的是为了能够根据不同的文件系统和操作类型，提供不同的文件操作处理方式，以满足不同的需求和场景。</p> 
<p><strong>提供了用户层操作的数据接口：</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>registered_fb<span class="token punctuation">[</span>FB_MAX<span class="token punctuation">]</span> 
</code></pre> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>struct fb_info *registered_fb[FB_MAX]是一个全局数组，用于存储已注册的帧缓冲设备的帧缓冲信息结构体。<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>在Linux的帧缓冲设备框架中，struct fb_info结构体代表了一个帧缓冲设备的信息。该结构体包含了帧缓冲设备的各种属性和状态，如设备名称、设备类型、设备大小、显存地址、像素格式等。<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>registered_fb数组的作用是用于管理已注册的帧缓冲设备。当一个帧缓冲设备被成功注册时（在帧缓冲设备框架中，通过register_framebuffer()函数将一个帧缓冲设备注册到内核中，并将其struct fb_info结构体存储在registered_fb数组中的一个位置上。），内核就可以通过访问registered_fb数组来获取已注册的帧缓冲设备的信息。  当需要访问已注册的帧缓冲设备时，可以通过遍历registered_fb数组来获取相应的帧缓冲信息。 <br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>registered_fb数组的大小是由宏FB_MAX定义的，它表示系统中最大支持的帧缓冲设备数量。通过限制registered_fb数组的大小，可以限制系统中可以注册的帧缓冲设备的数量。<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>在实际过程中，不同的帧缓冲设备的fb_info结构体是存入以次设备号做为下标的registered_fb数组中。例如/dev/fb0的fb_info信息是存在registered_fb[0]中。</p> 
<h5><a id="2222__265"></a>2.2.2.2 向下的接口</h5> 
<p>fbmem.c向lcd的驱动层提供了一个重要的注册接口register_framebuffer()，该函数主要功能是将其参数info指向的帧缓冲设备信息添加到内核的帧缓冲设备列表中并进行注册。 <br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>具体来说，register_framebuffer()函数执行以下操作：</p> 
<ul><li>1.检查帧缓冲设备信息的有效性，比如检查是否提供了必需的回调函数（如刷新屏幕函数fb_ops-&gt;fb_pan_display、设置显示模式函数fb_ops-&gt;fb_set_par等）。</li><li>2.为帧缓冲设备信息分配内存，并将设备信息的指针存储在内核中的帧缓冲设备列表（registered_fb[]）的一个位置上。</li><li>3.调用设备驱动程序的初始化函数（如果存在的话），完成设备的初始化工作。</li><li>4.根据设备信息中指定的显存地址和大小等信息，为帧缓冲设备分配显存空间。</li><li>5.注册帧缓冲设备到内核的帧缓冲子系统，使得应用程序可以使用对应设备的帧缓冲操作接口。 通过registered_fb[]数组，内核可以追踪已注册的帧缓冲设备，并提供对它们进行管理、控制和访问的功能。 需要注意的是，注册帧缓冲设备需要具有相应的权限，通常需要在内核初始化期间或者使用特权用户执行才能成功注册。</li></ul> 
<h4><a id="223__274"></a>2.2.3 相关函数详解</h4> 
<h5><a id="2231_proc_create_275"></a>2.2.3.1 proc_create()函数</h5> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span> 在Linux内核中，函数proc_create()是用于创建/proc这个内存文件系统中的文件的函数。它的声明位于&lt;linux/proc_fs.h&gt;头文件中。以下是proc_create()函数的声明：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">proc_dir_entry</span> <span class="token operator">*</span><span class="token function">proc_create</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> 
									<span class="token class-name">umode_t</span> mode<span class="token punctuation">,</span> 
									<span class="token keyword">struct</span> <span class="token class-name">proc_dir_entry</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span> 
									<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>proc_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>函数的参数</strong>：<br>  -  1. name：要创建的文件的名称。这应该是一个唯一的字符串，作为文件在/proc目录下的名称。 <br>  - 2. mode：文件的访问权限模式（例如，S_IRUGO | S_IWUGO表示可读写文件）。这些模式定义在&lt;linux/stat.h&gt;头文件中。<br>  -  3. parent：指向父目录的指针，即/proc中包含新文件的目录。<br>  -  4. proc_fops：指向struct file_operations结构体的指针，它包含文件在被读/写时将调用的回调函数。该结构体包含了一个文件的各种操作函数，例如读取（read()）、写入（write()）和关闭（release()）。<br>  <strong>函数的功能</strong>:<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>创建一个新的文件，并将其添加到/proc文件系统中。创建的文件将在通过parent参数指定的目录中可见。通过设置适当的回调函数来响应文件的读取和写入操作。 通过proc_create()函数创建的文件将在/proc中出现为一个虚拟的文件，并且可以通过相应的读写操作进行处理。这样，用户空间程序可以通过读取/proc文件系统来获取内核状态和信息。 需要注意的是，proc_create()函数已经被标记为弃用，并不推荐在新的内核代码中使用。代替的推荐方法是使用proc_create_data()函数或更高级的proc_create_single_data()函数，它们提供了更丰富的功能和更好的安全性。</p> 
<h5><a id="2232_fb_proc_fops_293"></a>2.2.3.2 fb_proc_fops结构体变量</h5> 
<p><strong>原型：</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fb_proc_fops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>owner		<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open		<span class="token operator">=</span> proc_fb_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read		<span class="token operator">=</span> seq_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>llseek		<span class="token operator">=</span> seq_lseek<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release	<span class="token operator">=</span> seq_release<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>在Linux内核版本3.14中，fbmem.c文件中定义了一个名为fb_proc_fops的结构体变量，其类型为struct file_operations。<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>这个结构体变量用于定义对应于在/proc文件系统中的fb设备请求的文件操作。 <br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>在这个特定的结构体变量中，定义了以下几个函数指针：</p> 
<ol><li>.owner：指向fb设备对应的内核模块的指针。</li><li>.open：打开设备的回调函数，用于处理打开设备的操作。</li><li>.read：读取设备的回调函数，用于处理从设备中读取数据的操作。</li><li>.llseek：寻址设备的回调函数，用于在设备中寻址位置的操作。</li><li>.release：释放设备的回调函数，用于处理释放设备的操作。 <br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
        
       
         \qquad 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>其中，THIS_MODULE宏作为.owner参数，表示当前fb设备模块是这个文件操作的所有者。其他的回调函数则是指向相应的处理函数。 <br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
        
       
         \qquad 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>这个结构体变量fb_proc_fops在fbmem.c文件中的作用是定义了对应于fb设备在/proc文件系统中的操作。当用户在/proc文件系统中访问fb设备时，内核将按照这个结构体变量中指定的函数来处理相应的操作，例如打开、读取、寻址和释放等。 通过这个结构体变量，fb设备模块可以响应相关的文件操作，以对用户的请求做出适当的响应。这种机制允许用户通过文件系统的方式与设备进行交互，提供了一种统一的接口来管理和控制fb设备。</li></ol> 
<h5><a id="2233_register_chrdev_317"></a>2.2.3.3. register_chrdev()函数</h5> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>在Linux内核3.14中，函数register_chrdev()用于注册字符设备驱动程序。它的声明位于&lt;linux/fs.h&gt;头文件中。以下是register_chrdev()函数的声明：</p> 
<pre><code class="prism language-c"> 
 <span class="token keyword">int</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> major<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span> 
 
</code></pre> 
<p><strong>参数解释如下：</strong><br>  -  1. major：设备的主设备号。如果指定为0，则会由内核动态分配可用的主设备号。<br>  -  2. name：设备的名称。这个名称将作为设备的标识，可以在/dev目录下找到相应的设备文件。<br>  -  3. fops：指向struct file_operations结构体的指针，其中包含了为设备定义的各种操作函数。 <br> <strong>返回值</strong><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>表示注册结果，返回一个负值表示注册失败，返回一个非负值表示注册成功，并返回已分配或动态分配的主设备号。</p> 
<p><strong>功能：</strong><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>register_chrdev()函数的功能是向内核注册字符设备驱动程序。注册后，操作系统将分配一个设备文件并将其与驱动程序关联起来，这将使其可以与用户程序进行通信。 字符设备驱动程序通常涉及到文件操作，例如打开、关闭、读取和写入。通过提供适当的回调函数，例如open()、release()、read()和write()，驱动程序可以响应这些操作。</p> 
<p><strong> 需要注意</strong><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>register_chrdev()函数已经被标记为弃用，并不推荐在新的内核代码中使用。代替的推荐方法是使用register_chrdev_region()函数或更高级的alloc_chrdev_region()函数，它们提供更灵活的设备号管理方式。此外，还可以使用字符设备框架中的设备模型进行设备注册和管理。</p> 
<h5><a id="2234_class_create_342"></a>2.2.3.4 class_create()函数</h5> 
<p>在Linux内核3.14中，函数class_create()用于在/sys/class目录下创建和注册一个新的设备类。它的声明位于&lt;linux/device.h&gt;头文件中。以下是class_create()函数的声明：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span><span class="token function">class_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>参数解释如下：</strong><br>  <br>   1、owner：指向拥有该类的内核模块的指针。通常使用THIS_MODULE宏作为参数，表示当前模块是该类的所有。<br>  <br>   2、name：设备类的名称。这个名称将作为设备类的标识，会出现在/sys/class目录下。</p> 
<p><strong>返回值：</strong><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>是一个指向struct class结构体的指针，代表创建的设备类。如果创建失败，将返回一个错误指针。</p> 
<p><strong>函数的功能：</strong><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>是创建并注册一个新的设备类。设备类是用于管理一组相关设备的集合。通过创建设备类，可以将一组具有相似功能或属性的设备进行分组，并在/sys/class目录下创建相应的子目录。 创建设备类后，可以使用device_create()函数在设备类下创建具体的设备实例，并将其与相应的设备文件进行关联。 需要注意的是，class_create()函数在创建并注册设备类时，还会自动在/sys/class目录下创建与设备类同名的子目录，用于存放该类的具体设备实例。同时，该函数会创建和注册相关的属性文件，用于获取和设置设备类的属性。 对于设备驱动开发者来说，使用设备类是一种将相关设备进行组织和分类的有效方式，可以更好地管理和控制设备。</p> 
<h5><a id="2235_register_framebuffer_363"></a>2.2.3.5 register_framebuffer()函数</h5> 
<p>在Linux 3.14中，register_framebuffer()函数用于注册一个帧缓冲设备，并将其添加到内核的帧缓冲设备列表中。</p> 
<p><strong>函数原型：</strong></p> 
<pre><code class="prism language-c"> <span class="token keyword">int</span> <span class="token function">register_framebuffer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>参数：</strong></p> 
<ul><li>info：指向帧缓冲设备信息的指针，类型为struct fb_info。帧缓冲设备信息结构体struct fb_info包含了与该设备相关的各种信息，例如显存地址、显存大小、像素格式、分辨率等。</li></ul> 
<p><strong>返回值：</strong></p> 
<ul><li>成功时，函数返回值为0，表示设备注册成功。</li><li>失败时，函数返回值为负数，表示设备注册失败。</li></ul> 
<p><strong> 功能：</strong><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>register_framebuffer()函数的主要功能是将其参数info指向的帧缓冲设备信息添加到内核的帧缓冲设备列表中并进行注册。</p> 
<h3><a id="23_LCDplatform_386"></a>2.3 LCD驱动分析（设备树匹配的platform平台驱动）</h3> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>LCD驱动是platform平台驱动。框架难度不大，麻烦的是LCD有大量的硬件配置需要设置。<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>LCD驱动的核心能力在lcd_probe（）函数，而初始化的 lcd_init()函数则是简单调用platform_driver_register()注册平台设备。本驱动采用platform的设备树匹配模式。驱动模块在切尔西成功则去调用lcd_probe()函数，完成驱动的主要能力。</p> 
<p>这里主要参考了<a href="https://www.ngui.cc/zz/1632478.html?action=onClick" rel="nofollow">这编文章</a>来详细说明LCD 驱动，由于都是用了exynos4412内核，因此参数的设置有很多相同，同时更正了文章中的一些错误以及增加了fs4412主板上的相应适配的内容。</p> 
<h4><a id="231___393"></a>2.3.1 设备树相关内容</h4> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>由于驱动采用的是设备树匹配。因此，驱动的第一步是正确设置设备树相关的节点。</p> 
<p>由于exynos4412的设备树节点分布在几个不同的dtsi文件中，显得比较分散，这里一一列出，阅读时，注意节点的层次。</p> 
<p><img src="https://images2.imgbox.com/71/d8/WooJzHYe_o.png" alt="在这里插入图片描述"></p> 
<p>以上的树节点需要一一对照，没有的要一一补上。这里不再细说。因为以上内容，要细说，可以单独再开一篇了。</p> 
<h4><a id="232__406"></a>2.3.2 数据结构及函数</h4> 
<h5><a id="struct__fb_info_408"></a>struct fb_info</h5> 
<p>这个结构体fb_info定义了Linux内核中关于帧缓冲设备(Framebuffer)的所有信息。<br> 头文件/include/linux/fb.h</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">atomic_t</span> count<span class="token punctuation">;</span>  这个原子计数器记录了当前打开此帧缓冲设备的进程数
	<span class="token keyword">int</span> node<span class="token punctuation">;</span>  numenode节点编号。对于支持NUMA的系统来说<span class="token punctuation">,</span>这个值定义了帧缓冲设备所在的节点。
	<span class="token keyword">int</span> flags<span class="token punctuation">;</span>   一些标志位<span class="token punctuation">,</span>定义此帧缓冲设备的一些属性
	<span class="token keyword">int</span> fbcon_rotate_hint<span class="token punctuation">;</span>   一个提示值<span class="token punctuation">,</span>默认情况下为<span class="token operator">-</span><span class="token number">1</span>，由驱动器设置为FB_ROTATE_<span class="token operator">*</span>值，如果它知道lcd没有垂直安装，fbcon应该旋转进行补偿。
	
	<span class="token keyword">struct</span> <span class="token class-name">mutex</span> lock<span class="token punctuation">;</span>		      两个互斥锁<span class="token punctuation">,</span>lock用于open<span class="token operator">/</span>release<span class="token operator">/</span>ioctl操作 
	<span class="token keyword">struct</span> <span class="token class-name">mutex</span> mm_lock<span class="token punctuation">;</span>		  mm_lock用于fb_mmap和smem_<span class="token operator">*</span>字段的访问。
	<span class="token keyword">struct</span> <span class="token class-name">fb_var_screeninfo</span> var<span class="token punctuation">;</span>	 可变参数结构体
	<span class="token keyword">struct</span> <span class="token class-name">fb_fix_screeninfo</span> fix<span class="token punctuation">;</span>	 LCD固定参数结构体
	<span class="token keyword">struct</span> <span class="token class-name">fb_monspecs</span> monspecs<span class="token punctuation">;</span>	 LCD显示器规格描述了当前显示器的规格信息<span class="token punctuation">,</span>如制造商、型号等。
	<span class="token keyword">struct</span> <span class="token class-name">work_struct</span> queue<span class="token punctuation">;</span>	  帧缓冲事件队列一个工作队列<span class="token punctuation">,</span>用于在中断上下文中排队和调度非中断上下文的Framebuffer事件。
	<span class="token keyword">struct</span> <span class="token class-name">fb_pixmap</span> pixmap<span class="token punctuation">;</span>	  图像硬件mapper，  pixmap用于硬件上映射的图像<span class="token punctuation">,</span>
	<span class="token keyword">struct</span> <span class="token class-name">fb_pixmap</span> sprite<span class="token punctuation">;</span>	  光标硬件mapper ，sprite用于光标的硬件映射。
	<span class="token keyword">struct</span> <span class="token class-name">fb_cmap</span> cmap<span class="token punctuation">;</span>		  当前的颜色表cmap用于描述帧缓冲设备的当前色彩映射表。
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> modelist<span class="token punctuation">;</span>      <span class="token comment">/* mode list */</span>
	<span class="token keyword">struct</span> <span class="token class-name">fb_videomode</span> <span class="token operator">*</span>mode<span class="token punctuation">;</span>	  当前的显示模式<span class="token operator">*</span><span class="token operator">/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_FB_BACKLIGHT<span class="token punctuation">)</span></span></span>
	<span class="token keyword">struct</span> <span class="token class-name">backlight_device</span> <span class="token operator">*</span>bl_dev <span class="token punctuation">;</span>   帧缓冲区注册前设置的指定背光设备，注销后删除
	<span class="token keyword">struct</span> <span class="token class-name">mutex</span> bl_curve_mutex<span class="token punctuation">;</span>	    背光水平曲线
	u8 bl_curve<span class="token punctuation">[</span>FB_BACKLIGHT_LEVELS<span class="token punctuation">]</span><span class="token punctuation">;</span>   背光调整
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_FB_DEFERRED_IO</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">delayed_work</span> deferred_work<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">fb_deferred_io</span> <span class="token operator">*</span>fbdefio<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token keyword">struct</span> <span class="token class-name">fb_ops</span> <span class="token operator">*</span>fbops<span class="token punctuation">;</span>        对底层硬件操作的函数指针
	<span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>device<span class="token punctuation">;</span>		 父设备指针
	<span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>		     本fb设备
	<span class="token keyword">int</span> class_flag<span class="token punctuation">;</span>              <span class="token comment">/* private sysfs flags */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_FB_TILEBLITTING</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">fb_tile_ops</span> <span class="token operator">*</span>tileops<span class="token punctuation">;</span>    图块<span class="token function">Blitting</span><span class="token punctuation">(</span>位图<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">char</span> __iomem <span class="token operator">*</span>screen_base<span class="token punctuation">;</span>	  虚拟基地址 
		<span class="token keyword">char</span> <span class="token operator">*</span>screen_buffer<span class="token punctuation">;</span>          “联合体，这两个互相覆盖”
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> screen_size<span class="token punctuation">;</span>	   LCD IO映射的虚拟内存大小，重新映射的VRAM数量或<span class="token number">0</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>pseudo_palette<span class="token punctuation">;</span>		   伪<span class="token number">16</span>色颜色表
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_STATE_RUNNING</span>	<span class="token expression"><span class="token number">0</span>   </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_STATE_SUSPENDED</span>	<span class="token expression"><span class="token number">1</span></span></span>
	u32 state<span class="token punctuation">;</span>			  LCD的挂起或恢复状态，值为上面这两个宏之一
	<span class="token keyword">void</span> <span class="token operator">*</span>fbcon_par<span class="token punctuation">;</span>                <span class="token comment">/* fbcon use-only private area */</span>
	从这里开始，往下，一切都依赖于设备
	<span class="token keyword">void</span> <span class="token operator">*</span>par<span class="token punctuation">;</span>
	
我们需要PCI或类似的光圈基础<span class="token operator">/</span>大小，而不是smem_start<span class="token operator">/</span>size，因为smem_start可能只是分配在光圈内部的对象，因此实际上可能不会重叠
	<span class="token keyword">struct</span> <span class="token class-name">apertures_struct</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">unsigned</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">aperture</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">resource_size_t</span> base<span class="token punctuation">;</span>
			<span class="token class-name">resource_size_t</span> size<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> ranges<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token operator">*</span>apertures<span class="token punctuation">;</span>

	bool skip_vt_switch<span class="token punctuation">;</span> <span class="token comment">/* no VT switch on suspend/resume required */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>在fb_info结构体中,flags字段是一个整数,它包含一些标志位,用于表示Framebuffer设备的某些属性。<br> 标志位定义在&lt;linux/fb.h&gt;头文件中,如:</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_MODULE</span>		<span class="token expression"><span class="token number">0x0001</span>  </span><span class="token comment">/* Low-level driver is a module */</span><span class="token comment">/*低级驱动器是一个模块*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_HWACCEL_DISABLED</span>	<span class="token expression"><span class="token number">0x0002</span>    </span><span class="token comment">/*设置FBINFO_HWACCEL_DISABLED时：*硬件加速被关闭。所需函数（copyrea（）、fillrect（）和imageblit（））的软件实现 取而代之；加速发动机应处于静止状态*/</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_VIRTFB</span>		<span class="token expression"><span class="token number">0x0004</span>        </span><span class="token comment">/*FB是系统RAM，而不是设备*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_PARTIAL_PAN_OK</span>	<span class="token expression"><span class="token number">0x0040</span>    </span><span class="token comment">/*otw只使用pan进行双重缓冲*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_READS_FAST</span>	<span class="token expression"><span class="token number">0x0080</span>  </span><span class="token comment">/* soft-copy 比渲染快  /*硬件支持的操作*/</span></span>
<span class="token comment">/*语义：当设置了一个位时，表示硬件加速了操作。即使未设置位，所需的功能仍将工作。*如果没有设置标志位，则可选功能甚至可能不存在。*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_HWACCEL_NONE</span>		<span class="token expression"><span class="token number">0x0000</span>     表示帧缓冲设备不支持硬件加速。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_HWACCEL_COPYAREA</span>		<span class="token expression"><span class="token number">0x0100</span>  表示帧缓冲设备支持copyarea硬件加速，用于高效地复制区域。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_HWACCEL_FILLRECT</span>		<span class="token expression"><span class="token number">0x0200</span>  表示帧缓冲设备支持fillrect硬件加速，用于高效地填充矩形区域。 </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_HWACCEL_IMAGEBLIT</span>	<span class="token expression"><span class="token number">0x0400</span>  表示帧缓冲设备支持imageblit硬件加速，用于高效地传输图像数据。 </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_HWACCEL_ROTATE</span>		<span class="token expression"><span class="token number">0x0800</span>  表示帧缓冲设备支持旋转操作的硬件加速。这是可选的功能。 </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_HWACCEL_XPAN</span>		<span class="token expression"><span class="token number">0x1000</span> </span><span class="token comment">/* optional */</span><span class="token expression">表示帧缓冲设备支持水平平移的硬件加速。这是可选的功能。 </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_HWACCEL_YPAN</span>		<span class="token expression"><span class="token number">0x2000</span> </span><span class="token comment">/* optional */</span><span class="token expression">表示帧缓冲设备支持垂直平移的硬件加速。这是可选的功能。 </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_HWACCEL_YWRAP</span>		<span class="token expression"><span class="token number">0x4000</span> </span><span class="token comment">/* optional */</span><span class="token expression">表示帧缓冲设备支持垂直循环滚动的硬件加速。这是可选的功能。 </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_MISC_USEREVENT</span>          <span class="token expression"><span class="token number">0x10000</span> </span><span class="token comment">/* event request来自用户空间*/</span><span class="token expression">表示帧缓冲设备接收到的事件请求来自用户空间。 </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_MISC_TILEBLITTING</span>       <span class="token expression"><span class="token number">0x20000</span> </span><span class="token comment">/* use tile blitting */</span><span class="token expression">表示帧缓冲设备使用瓦片传输进行加速。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_MISC_ALWAYS_SETPAR</span>   <span class="token expression"><span class="token number">0x40000</span>    此标志用于指示在每次切换控制台时都调用set_par函数。这可以确保在依赖于正确的硬件状态或更改该状态的任何函数之前，set_par函数始终被调用。但如果set_par函数执行较慢，会导致控制台切换的延迟增加。 </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_MISC_FIRMWARE</span>        <span class="token expression"><span class="token number">0x80000</span>     </span><span class="token comment">/*其中fb是一个固件驱动程序，可以用合适的驱动程序替换*/</span><span class="token expression">该标志表示帧缓冲驱动程序是一个固件驱动程序，并可被适当的驱动程序替换。 </span></span>
<span class="token operator">*</span><span class="token operator">/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_FOREIGN_ENDIAN</span>	<span class="token expression"><span class="token number">0x100000</span>  </span><span class="token comment">/*主机和GPU端序不同。*/</span><span class="token expression">表示主机和GPU的字节序不同。 </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_BE_MATH</span>  <span class="token expression"><span class="token number">0x100000</span>  大端序。这与上面的标志相同，但含义不同，由fb子系统根据FOREIGN_ENDIAN标志和主机端序设置。驱动不应使用此标志。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBINFO_CAN_FORCE_OUTPUT</span>     <span class="token expression"><span class="token number">0x200000</span>     向VT层报告此fb驱动程序可以接受像oopes一样的强制控制台输出</span></span>

</code></pre> 
<h5><a id="struct__fb_var_screeninfo___struct_fb_fix_screeninfo_511"></a>struct fb_var_screeninfo 和 struct fb_fix_screeninfo</h5> 
<p>在头文件include/uapi/linux/fb.h 中定义</p> 
<h5><a id="struct_fb_var_screeninfo_514"></a>struct fb_var_screeninfo</h5> 
<p>fb_var_screeninfo结构体主要记录用户可以修改的控制器的参数，比如屏幕的分辨率和每个像素的比特数等，该结构体定义如下：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;uapi/linux/fb.h&gt;</span></span>
<span class="token keyword">struct</span> <span class="token class-name">fb_var_screeninfo</span> <span class="token punctuation">{<!-- --></span>
	__u32 xres<span class="token punctuation">;</span>		        可见屏幕一行有多少个像素点visible resolution
	__u32 yres<span class="token punctuation">;</span>		        可见屏幕一列有多少个像素点
	__u32 xres_virtual<span class="token punctuation">;</span>		虚拟屏幕一行有多少个像素点。虚拟屏幕是在硬件上模拟的屏幕，可以比可见屏幕更大。 	
	__u32 yres_virtual<span class="token punctuation">;</span>		虚拟屏幕一列有多少个像素点。和xres_virtual一样，这个成员存储虚拟屏幕的垂直分辨率。
	__u32 xoffset<span class="token punctuation">;</span>			    虚拟屏幕到可见屏幕之间的行偏移。当虚拟屏幕大于可见屏幕时，这个成员指定了虚拟
							屏幕相对于可见屏幕的水平偏移。
	__u32 yoffset<span class="token punctuation">;</span>			    虚拟屏幕到可见屏幕之间的列偏移。和xoffset一样，这个成员指定了虚拟屏幕相对于可
							见屏幕的垂直偏移。		

	__u32 bits_per_pixel<span class="token punctuation">;</span>		每个像素的位数，即BPP（Bits Per Pixel）。这个成员存储屏幕中每个像素的位数，
							用于确定图像的颜色深度。			
	__u32 grayscale<span class="token punctuation">;</span>		非<span class="token number">0</span>时，表示图像为灰度图像。当grayscale为<span class="token number">0</span>时，表示图像为彩色图像。   		
	<span class="token keyword">struct</span> <span class="token class-name">fb_bitfield</span> red<span class="token punctuation">;</span>		 表示帧缓冲中的红、绿、蓝位域。这些位域用于存储真彩色图像的每个像素的颜色值。
	<span class="token keyword">struct</span> <span class="token class-name">fb_bitfield</span> green<span class="token punctuation">;</span>	 
	<span class="token keyword">struct</span> <span class="token class-name">fb_bitfield</span> blue<span class="token punctuation">;</span>	 
	<span class="token keyword">struct</span> <span class="token class-name">fb_bitfield</span> transp<span class="token punctuation">;</span>	  透明度位域。如果图像支持透明度，这个位域用于存储每个像素的透明度值。			

	__u32 nonstd<span class="token punctuation">;</span>			非<span class="token number">0</span>时，表示非标准像素格式。这个成员用于区分非标准的像素格式。

	__u32 activate<span class="token punctuation">;</span>			    用于指定激活显示的方式，可以是FB_ACTIVATE_NOW（立即激活）或
							FB_ACTIVATE_FORCE（强制激活）。看fb<span class="token punctuation">.</span>h中的 FB_ACTIVATE_<span class="token operator">*</span>宏		

	__u32 height<span class="token punctuation">;</span>			 图像的高度，以毫米为单位。这个成员用于描述图像在屏幕上的实际高度。
	__u32 width<span class="token punctuation">;</span>			 图像的宽度，以毫米为单位。和height一样，这个成员用于描述图像在屏幕上的实际宽度。

	__u32 accel_flags<span class="token punctuation">;</span>		<span class="token comment">/* (OBSOLETE) see fb_info.flags */</span>

	<span class="token comment">/* Timing: All values in pixclocks, except pixclock (of course) */</span>
	定时：除了pixclock本身外，其他的都以像素时钟为单位
	__u32 pixclock<span class="token punctuation">;</span>			 像素时钟，这个成员存储像素时钟的频率，用于计算图像的时序信息。
	__u32 left_margin<span class="token punctuation">;</span>		 行切换，从同步到绘图之间的延迟 time from sync to picture	
	__u32 right_margin<span class="token punctuation">;</span>		 行切换，从绘图到同步之间的延迟 time from picture to sync	
	__u32 upper_margin<span class="token punctuation">;</span>		 帧切换，从同步到绘图之间的延迟 time from sync to picture	
	__u32 lower_margin<span class="token punctuation">;</span>      帧切换，从绘图到同步之间的延迟
	__u32 hsync_len<span class="token punctuation">;</span>		 水平同步的长度。它们表示同步信号的持续时间。
	__u32 vsync_len<span class="token punctuation">;</span>		 垂直同步的长度。它们表示同步信号的持续时间。
	__u32 sync<span class="token punctuation">;</span>			         示同步的方式，可以是FB_SYNC_HOR_HIGH_ACT（水平同步信号为高电平活动）
							或FB_SYNC_VERT_HIGH_ACT（垂直同步信号为高电平活动）等。看fb<span class="token punctuation">.</span>h中的 FB_SYNC_<span class="token operator">*</span>宏
	__u32 vmode<span class="token punctuation">;</span>			    显示模式。它指定了显示器的模式，可以是FB_VMODE_NONINTERLACED（非隔行模式）
							或FB_VMODE_INTERLACED（隔行模式）等。参考fb<span class="token punctuation">.</span>h中的 FB_VMODE_<span class="token operator">*</span>宏		
	__u32 rotate<span class="token punctuation">;</span>			以逆时针方向旋转的角度。它表示图像在屏幕上显示时的旋转角度。
	__u32 colorspace<span class="token punctuation">;</span>		基于FOURCC的模式的颜色空间。它指定了基于FOURCC的模式的颜色空间，例如RGB或YUV。
	__u32 reserved<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>		保留Reserved <span class="token keyword">for</span> future compatibility 
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre> 
<p>**比较重要的可变参数有： **</p> 
<ul><li>xres、yres：可视画面的x、y轴分辨率（应用层改不了）</li><li>xres_virtual、yres_virtual：虚拟画面（即fb）x、y轴分辨率</li><li>xoffset、yoffset：可视画面相对于虚拟画面的x、y轴偏移量</li><li>bits_per_pixel：像素深度，每个像数的bit位数。<br> <img src="https://images2.imgbox.com/29/a5/zQmD1zKJ_o.png" alt="在这里插入图片描述" width="400"></li></ul> 
<p><strong>虚拟画面的尺寸</strong><br> 虚拟画面一般可设为可视画面的两倍，这种结构被称之为“双缓冲机制”，这样做的好处是可以一边显示，一边缓冲下一幅画面 。</p> 
<ul><li>activate: 激活设定参数的方式。在fb.h中定义的宏。这些宏在设置帧缓冲设备的属性时，用于激活或改变属性的不同标志。下面是每个宏的具体含义：</li><li> 
  <ul><li>FB_ACTIVATE_NOW（0）：立即设置属性的值（或在垂直空白期设置）。</li></ul> </li><li> 
  <ul><li>FB_ACTIVATE_NXTOPEN（1）：在下一次打开设备时激活属性。</li></ul> </li><li> 
  <ul><li>FB_ACTIVATE_TEST（2）：不设置属性的值，将不可能的值四舍五入。</li></ul> </li><li> 
  <ul><li>FB_ACTIVATE_MASK（15）：用于掩码操作的值。</li></ul> </li><li> 
  <ul><li>FB_ACTIVATE_VBL（16）：在下一个垂直空白期激活属性的值。</li></ul> </li><li> 
  <ul><li>FB_CHANGE_CMAP_VBL（32）：在下一个垂直空白期更改颜色映射表。</li></ul> </li><li> 
  <ul><li>FB_ACTIVATE_ALL（64）：更改此帧缓冲设备上的所有虚拟控制台。</li></ul> </li><li> 
  <ul><li>FB_ACTIVATE_FORCE（128）：即使没有更改，也强制应用属性的设置。</li></ul> </li><li> 
  <ul><li>FB_ACTIVATE_INV_MODE（256）：使当前视频模式无效。</li></ul> </li><li> 
  <ul><li>这些标志可以用来指定在设置帧缓冲设备属性时应采取的行动。可以根据需要组合使用这些标志。</li></ul> </li></ul> 
<h5><a id="struct_fb_fix_screeninfo_587"></a>struct fb_fix_screeninfo</h5> 
<p>而fb_fix_screeninfo结构体又主要记录用户不可以修改的控制器的参数，比如屏幕缓冲区的物理地址和长度等，该结构体的定义如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">fb_fix_screeninfo</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> id<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>			 字符串形式的标示符  identification string eg <span class="token string">"TT Builtin"</span> 
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> smem_start<span class="token punctuation">;</span>	fb缓存的开始位置  Start of frame buffer <span class="token function">mem</span>  <span class="token punctuation">(</span>physical address<span class="token punctuation">)</span> 
	__u32 smem_len<span class="token punctuation">;</span>			    fb缓存的长度  Length of frame buffer mem 
	__u32 type<span class="token punctuation">;</span>			        看FB_TYPE_<span class="token operator">*</span>	
	__u32 type_aux<span class="token punctuation">;</span>			    分界 Interleave <span class="token keyword">for</span> interleaved Planes 
	__u32 visual<span class="token punctuation">;</span>			    看 FB_VISUAL_<span class="token operator">*</span>		
	__u16 xpanstep<span class="token punctuation">;</span>			    如果没有硬件panning就赋值为<span class="token number">0</span> zero <span class="token keyword">if</span> no hardware panning  
	__u16 ypanstep<span class="token punctuation">;</span>			    如果没有硬件panning就赋值为<span class="token number">0</span>  zero <span class="token keyword">if</span> no hardware panning  
	__u16 ywrapstep<span class="token punctuation">;</span>		    如果没有硬件ywrap就赋值为<span class="token number">0</span>  zero <span class="token keyword">if</span> no hardware ywrap    
	__u32 line_length<span class="token punctuation">;</span>		    一行的字节数  length of a line in bytes    
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> mmio_start<span class="token punctuation">;</span>	内存映射IO的开始位置 <span class="token comment">/* Start of Memory Mapped I/O   */</span>
					<span class="token comment">/* (physical address) */</span>
	__u32 mmio_len<span class="token punctuation">;</span>			内存映射IO的长度<span class="token comment">/* Length of Memory Mapped I/O  */</span>
	__u32 accel<span class="token punctuation">;</span>			<span class="token comment">/* Indicate to driver which	*/</span>
					<span class="token comment">/*  specific chip/card we have	*/</span>
	__u16 capabilities<span class="token punctuation">;</span>		<span class="token comment">/* see FB_CAP_*			*/</span>
	__u16 reserved<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">/* Reserved for future compatibility */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>这里比较常用的是:</p> 
<ul><li>smem_len : framebuff的长度</li><li>type : 类型，在fb.h中有如下的宏定义。</li><li> 
  <ul><li>#define FB_TYPE_PACKED_PIXELS 0 /* Packed Pixels 表示使用“Packed Pixels”格式的像素数据。在此格式中，像素按照紧密排列的方式存储，每个像素占用固定数量的位或字节。这是一种常见的视频和图形数据存储格式。*/</li></ul> </li><li> 
  <ul><li>#define FB_TYPE_PLANES 1 /* Non interleaved planes 表示使用“非交错平面”格式的像素数据。在此格式中，像素数据被分为多个独立的平面，每个平面存储一种颜色分量。这种像素排列方式在某些情况下可以提供更高的灵活性和图像质量。*/</li></ul> </li><li> 
  <ul><li>#define FB_TYPE_INTERLEAVED_PLANES 2 /* Interleaved planes 表示使用“交错平面”格式的像素数据。在此格式中，像素数据以交错方式存储在不同的平面中。这种像素排列方式可以提供更高的内存访问效率。*/</li></ul> </li><li> 
  <ul><li>#define FB_TYPE_TEXT 3 /* Text/attributes 表示使用“文本/属性”格式的像素数据。在此格式中，像素数据用于显示文本字符和相关属性（如前景色、背景色、样式等）。 */</li></ul> </li><li> 
  <ul><li>#define FB_TYPE_VGA_PLANES 4 /* EGA/VGA planes 表示使用“EGA/VGA平面”格式的像素数据。这种格式与 FB_TYPE_PLANES 类似，但特定于 VGA 图形适配器。 */</li></ul> </li><li> 
  <ul><li>#define FB_TYPE_FOURCC 5 /* Type identified by a V4L2 FOURCC 表示使用由 V4L2（Video for Linux 2）定义的 FOURCC（Four-Character Code）标识的像素数据类型。这种类型标识可以用于表示各种特定格式和压缩算法的像素数据。*/</li></ul> </li><li>visual : 可视化模式或像素模式，在fb.h中有如下的宏定义</li><li> 
  <ul><li>#define FB_VISUAL_MONO01 0 /* Monochr. 1=Black 0=White 表示单色模式，像素值为0表示白色，像素值为1表示黑色。 */</li></ul> </li><li> 
  <ul><li>#define FB_VISUAL_MONO10 1 /* Monochr. 1=White 0=Black 表示单色模式，像素值为0表示黑色，像素值为1表示白色。 */</li></ul> </li><li> 
  <ul><li>#define FB_VISUAL_TRUECOLOR 2 /* True color 表示真彩色模式， 可以支持高分辨率图像显示。在此模式中，每个像素由红、绿、蓝三个颜色分量组成，可以使用更广泛的颜色范围，以呈现更真实的图像。*/</li></ul> </li><li> 
  <ul><li>#define FB_VISUAL_PSEUDOCOLOR 3 /* Pseudo color (like atari) 表示伪彩色模式，类似于Atari ST的显示模式。在此模式中，每个像素的颜色值是通过颜色映射表（调色板）查找来确定的，显卡上的颜色映射表支持有限的颜色范围。*/</li></ul> </li><li> 
  <ul><li>#define FB_VISUAL_DIRECTCOLOR 4 /* Direct color 表示直接彩色模式，像素的颜色将由红、绿、蓝三个颜色分量组成，但与真彩色不同，颜色分量的数量可能不同，且混合方式可能不同。此模式在显示彩色图像时提供了更高的位深度和精度。 */</li></ul> </li><li> 
  <ul><li>#define FB_VISUAL_STATIC_PSEUDOCOLOR 5 /* Pseudo color readonly 表示静态伪彩色模式，类似于伪彩色模式，但只读，即无法更改像素的颜色映射表。 */</li></ul> </li><li> 
  <ul><li>#define FB_VISUAL_FOURCC 6 /* Visual identified by a V4L2 FOURCC 表示被V4L2（Video for Linux 2）标识的特定像素格式。它允许使用V4L2 FOURCC（四字符码）来标识特定的像素编解码器和压缩算法，以支持多种图像格式。 */</li></ul> </li></ul> 
<h5><a id="struct_fb_videomode_628"></a>struct fb_videomode结构体</h5> 
<p>（详见2.6.1）</p> 
<h5><a id="fb_var_to_videomode_fb_videomode_to_var_630"></a>fb_var_to_videomode()与 fb_videomode_to_var()函数</h5> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">fb_var_to_videomode</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_videomode</span> <span class="token operator">*</span>mode<span class="token punctuation">,</span>
			 <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">fb_var_screeninfo</span> <span class="token operator">*</span>var<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 pixclock<span class="token punctuation">,</span> hfreq<span class="token punctuation">,</span> htotal<span class="token punctuation">,</span> vtotal<span class="token punctuation">;</span>

	mode<span class="token operator">-&gt;</span>name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	mode<span class="token operator">-&gt;</span>xres <span class="token operator">=</span> var<span class="token operator">-&gt;</span>xres<span class="token punctuation">;</span>
	mode<span class="token operator">-&gt;</span>yres <span class="token operator">=</span> var<span class="token operator">-&gt;</span>yres<span class="token punctuation">;</span>
	mode<span class="token operator">-&gt;</span>pixclock <span class="token operator">=</span> var<span class="token operator">-&gt;</span>pixclock<span class="token punctuation">;</span>
	mode<span class="token operator">-&gt;</span>hsync_len <span class="token operator">=</span> var<span class="token operator">-&gt;</span>hsync_len<span class="token punctuation">;</span>
	mode<span class="token operator">-&gt;</span>vsync_len <span class="token operator">=</span> var<span class="token operator">-&gt;</span>vsync_len<span class="token punctuation">;</span>
	mode<span class="token operator">-&gt;</span>left_margin <span class="token operator">=</span> var<span class="token operator">-&gt;</span>left_margin<span class="token punctuation">;</span>
	mode<span class="token operator">-&gt;</span>right_margin <span class="token operator">=</span> var<span class="token operator">-&gt;</span>right_margin<span class="token punctuation">;</span>
	mode<span class="token operator">-&gt;</span>upper_margin <span class="token operator">=</span> var<span class="token operator">-&gt;</span>upper_margin<span class="token punctuation">;</span>
	mode<span class="token operator">-&gt;</span>lower_margin <span class="token operator">=</span> var<span class="token operator">-&gt;</span>lower_margin<span class="token punctuation">;</span>
	mode<span class="token operator">-&gt;</span>sync <span class="token operator">=</span> var<span class="token operator">-&gt;</span>sync<span class="token punctuation">;</span>
	mode<span class="token operator">-&gt;</span>vmode <span class="token operator">=</span> var<span class="token operator">-&gt;</span>vmode <span class="token operator">&amp;</span> FB_VMODE_MASK<span class="token punctuation">;</span>
	mode<span class="token operator">-&gt;</span>flag <span class="token operator">=</span> FB_MODE_IS_FROM_VAR<span class="token punctuation">;</span>
	mode<span class="token operator">-&gt;</span>refresh <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>var<span class="token operator">-&gt;</span>pixclock<span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>

	pixclock <span class="token operator">=</span> <span class="token function">PICOS2KHZ</span><span class="token punctuation">(</span>var<span class="token operator">-&gt;</span>pixclock<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>

	htotal <span class="token operator">=</span> var<span class="token operator">-&gt;</span>xres <span class="token operator">+</span> var<span class="token operator">-&gt;</span>right_margin <span class="token operator">+</span> var<span class="token operator">-&gt;</span>hsync_len <span class="token operator">+</span>
		var<span class="token operator">-&gt;</span>left_margin<span class="token punctuation">;</span>
	vtotal <span class="token operator">=</span> var<span class="token operator">-&gt;</span>yres <span class="token operator">+</span> var<span class="token operator">-&gt;</span>lower_margin <span class="token operator">+</span> var<span class="token operator">-&gt;</span>vsync_len <span class="token operator">+</span>
		var<span class="token operator">-&gt;</span>upper_margin<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>var<span class="token operator">-&gt;</span>vmode <span class="token operator">&amp;</span> FB_VMODE_INTERLACED<span class="token punctuation">)</span>
		vtotal <span class="token operator">/=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>var<span class="token operator">-&gt;</span>vmode <span class="token operator">&amp;</span> FB_VMODE_DOUBLE<span class="token punctuation">)</span>
		vtotal <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>

	hfreq <span class="token operator">=</span> pixclock<span class="token operator">/</span>htotal<span class="token punctuation">;</span>
	mode<span class="token operator">-&gt;</span>refresh <span class="token operator">=</span> hfreq<span class="token operator">/</span>vtotal<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">fb_videomode_to_var</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_var_screeninfo</span> <span class="token operator">*</span>var<span class="token punctuation">,</span>
			 <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">fb_videomode</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	var<span class="token operator">-&gt;</span>xres <span class="token operator">=</span> mode<span class="token operator">-&gt;</span>xres<span class="token punctuation">;</span>
	var<span class="token operator">-&gt;</span>yres <span class="token operator">=</span> mode<span class="token operator">-&gt;</span>yres<span class="token punctuation">;</span>
	var<span class="token operator">-&gt;</span>xres_virtual <span class="token operator">=</span> mode<span class="token operator">-&gt;</span>xres<span class="token punctuation">;</span>
	var<span class="token operator">-&gt;</span>yres_virtual <span class="token operator">=</span> mode<span class="token operator">-&gt;</span>yres<span class="token punctuation">;</span>
	var<span class="token operator">-&gt;</span>xoffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	var<span class="token operator">-&gt;</span>yoffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	var<span class="token operator">-&gt;</span>pixclock <span class="token operator">=</span> mode<span class="token operator">-&gt;</span>pixclock<span class="token punctuation">;</span>
	var<span class="token operator">-&gt;</span>left_margin <span class="token operator">=</span> mode<span class="token operator">-&gt;</span>left_margin<span class="token punctuation">;</span>
	var<span class="token operator">-&gt;</span>right_margin <span class="token operator">=</span> mode<span class="token operator">-&gt;</span>right_margin<span class="token punctuation">;</span>
	var<span class="token operator">-&gt;</span>upper_margin <span class="token operator">=</span> mode<span class="token operator">-&gt;</span>upper_margin<span class="token punctuation">;</span>
	var<span class="token operator">-&gt;</span>lower_margin <span class="token operator">=</span> mode<span class="token operator">-&gt;</span>lower_margin<span class="token punctuation">;</span>
	var<span class="token operator">-&gt;</span>hsync_len <span class="token operator">=</span> mode<span class="token operator">-&gt;</span>hsync_len<span class="token punctuation">;</span>
	var<span class="token operator">-&gt;</span>vsync_len <span class="token operator">=</span> mode<span class="token operator">-&gt;</span>vsync_len<span class="token punctuation">;</span>
	var<span class="token operator">-&gt;</span>sync <span class="token operator">=</span> mode<span class="token operator">-&gt;</span>sync<span class="token punctuation">;</span>
	var<span class="token operator">-&gt;</span>vmode <span class="token operator">=</span> mode<span class="token operator">-&gt;</span>vmode <span class="token operator">&amp;</span> FB_VMODE_MASK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="struct___fb_ops_695"></a>struct fb_ops</h5> 
<p>fb_ops结构体是对底层硬件操作的函数指针，该结构体中定义了对硬件的操作有:</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fb.h&gt;</span></span>
<span class="token keyword">struct</span> <span class="token class-name">fb_ops</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* open/release and usage marking */</span>
	<span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_open<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">int</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_release<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">int</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

	对于具有奇怪非线性布局或不适用于正常内存映射访问的帧缓冲区
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_read<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span>
			   <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_write<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span>
			    <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">;</span>

	检查可变参数并进行设置<span class="token comment">/* checks var and eventually tweaks it to something supported,DO NOT MODIFY PAR */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_check_var<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_var_screeninfo</span> <span class="token operator">*</span>var<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

	根据设置的值进行更新，使之有效<span class="token comment">/* set the video mode according to info-&gt;var */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_set_par<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

	设置颜色寄存器<span class="token comment">/* set color register */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_setcolreg<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> regno<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> red<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> green<span class="token punctuation">,</span>
			    <span class="token keyword">unsigned</span> blue<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> transp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* set color registers in batch */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_setcmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_cmap</span> <span class="token operator">*</span>cmap<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

	显示空白<span class="token comment">/* blank display */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_blank<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span> blank<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* pan display */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_pan_display<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_var_screeninfo</span> <span class="token operator">*</span>var<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

	矩形填充<span class="token comment">/* Draws a rectangle */</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_fillrect<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">fb_fillrect</span> <span class="token operator">*</span>rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
	复制数据<span class="token comment">/* Copy data from area to another */</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_copyarea<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">fb_copyarea</span> <span class="token operator">*</span>region<span class="token punctuation">)</span><span class="token punctuation">;</span>
	图形填充<span class="token comment">/* Draws a image to the display */</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_imageblit<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">fb_image</span> <span class="token operator">*</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Draws cursor */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_cursor<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">fb_cursor</span> <span class="token operator">*</span>cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Rotates the display */</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_rotate<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">int</span> angle<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* wait for blit idle, optional */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_sync<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* perform fb specific ioctl (optional) */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_ioctl<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span>
			<span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Handle 32bit compat ioctl (optional) */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_compat_ioctl<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> cmd<span class="token punctuation">,</span>
			<span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* perform fb specific mmap */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_mmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span>vma<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* get capability given var */</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_get_caps<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">fb_blit_caps</span> <span class="token operator">*</span>caps<span class="token punctuation">,</span>
			    <span class="token keyword">struct</span> <span class="token class-name">fb_var_screeninfo</span> <span class="token operator">*</span>var<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* teardown any resources to do with this framebuffer */</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_destroy<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* called at KDB enter and leave time to prepare the console */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_debug_enter<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fb_debug_leave<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_module_platform_driver_773"></a>宏 module_platform_driver</h5> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">module_platform_driver</span><span class="token expression"><span class="token punctuation">(</span>__platform_driver<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token function">module_driver</span><span class="token punctuation">(</span>__platform_driver<span class="token punctuation">,</span> platform_driver_register<span class="token punctuation">,</span> </span><span class="token punctuation">\</span>
			<span class="token expression">platform_driver_unregister<span class="token punctuation">)</span></span></span>
</code></pre> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">module_driver</span><span class="token expression"><span class="token punctuation">(</span>__driver<span class="token punctuation">,</span> __register<span class="token punctuation">,</span> __unregister<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">static</span> <span class="token keyword">int</span> __init __driver</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">{<!-- --></span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">return</span> <span class="token function">__register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>__driver<span class="token punctuation">)</span> <span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token function">module_init</span><span class="token punctuation">(</span>__driver</span><span class="token punctuation">##</span><span class="token expression">_init<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">static</span> <span class="token keyword">void</span> __exit __driver</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">{<!-- --></span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token function">__unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>__driver<span class="token punctuation">)</span> <span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token function">module_exit</span><span class="token punctuation">(</span>__driver</span><span class="token punctuation">##</span><span class="token expression">_exit<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
</code></pre> 
<p><strong>实例：</strong><br> <code>module_platform_driver(s3c_fb_driver)</code></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">module_driver</span><span class="token expression"><span class="token punctuation">(</span>__driver<span class="token punctuation">,</span> __register<span class="token punctuation">,</span> __unregister<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">s3c_fb_driver_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">{<!-- --></span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">return</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>s3c_fb_driver<span class="token punctuation">)</span> <span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token function">module_init</span><span class="token punctuation">(</span>s3c_fb_driver_init<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">s3c_fb_driver_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">{<!-- --></span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>s3c_fb_driver<span class="token punctuation">)</span> <span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token function">module_exit</span><span class="token punctuation">(</span>s3c_fb_driver_exit<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
</code></pre> 
<h4><a id="233_LCD_813"></a>2.3.3 LCD驱动的结构与步骤</h4> 
<p>在FrameBuffer框架下，LCD驱动的编写也是程式化了。<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>首先，LCD驱动是一个标准的platform平台总线驱动，因此其驱动的总体结构就确定下来了，而匹配模式可以采用的是多种匹配方式，本文采用的是设备树匹配。 <br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>其次，其probe函数是最重要的初始化函数，其具本步骤如下：</p> 
<ul><li>1、分配一个fb_info</li><li>2、设置fb_info数据结构</li><li> 
  <ul><li>2.1 设置 fix 固定的参数</li></ul> </li><li> 
  <ul><li>2.2 设置 var 可变的参数</li></ul> </li><li> 
  <ul><li>2.3 设置操作函数</li></ul> </li><li> 
  <ul><li>2.4 其他的设置</li></ul> </li><li>3、 硬件相关的操作</li><li> 
  <ul><li>3.1 配置GPIO用于LCD</li></ul> </li><li> 
  <ul><li>3.2 根据LCD手册设置LCD控制器</li></ul> </li><li> 
  <ul><li>3.3 分配显存(framebuffer), 并把地址告诉LCD控制器</li></ul> </li><li>4、注册</li></ul> 
<p>这里先给个初步的概念，关键是直接对照去阅读调试后的源码，里面已按上述步骤，又做了相对较细的注释。</p> 
<h2><a id="3_831"></a>3、驱动程序实例</h2> 
<pre><code class="prism language-c"><span class="token comment">//{% codeblock lang:c [lcd_drv.c] https://github.com/hceng/learn/blob/master/tiny4412/02_lcd_drv/lcd_drv.c %}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/dma-mapping.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/workqueue.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/clk.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/io.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/div64.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/mach/map.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/types.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VIDCON0</span> <span class="token expression"><span class="token number">0x00</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VIDCON1</span> <span class="token expression"><span class="token number">0x04</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VIDTCON0</span> <span class="token expression"><span class="token number">0x10</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VIDTCON1</span> <span class="token expression"><span class="token number">0x14</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VIDTCON2</span> <span class="token expression"><span class="token number">0x18</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WINCON0</span> <span class="token expression"><span class="token number">0x20</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VIDOSD0C</span> <span class="token expression"><span class="token number">0x48</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SHADOWCON</span> <span class="token expression"><span class="token number">0x34</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WINCHMAP2</span> <span class="token expression"><span class="token number">0x3c</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VIDOSD0A</span> <span class="token expression"><span class="token number">0x40</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VIDOSD0B</span> <span class="token expression"><span class="token number">0x44</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VIDW00ADD0B0</span> <span class="token expression"><span class="token number">0xA0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VIDW00ADD1B0</span> <span class="token expression"><span class="token number">0xD0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLK_SRC_LCD0</span> <span class="token expression"><span class="token number">0x234</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLK_SRC_MASK_LCD</span> <span class="token expression"><span class="token number">0x334</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLK_DIV_LCD</span> <span class="token expression"><span class="token number">0x534</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLK_GATE_IP_LCD</span> <span class="token expression"><span class="token number">0x934</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCDBLK_CFG</span> <span class="token expression"><span class="token number">0x00</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCDBLK_CFG2</span> <span class="token expression"><span class="token number">0x04</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_LENTH</span> <span class="token expression"><span class="token number">1024</span>   </span><span class="token comment">//800</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_WIDTH</span> <span class="token expression"><span class="token number">600</span>    </span><span class="token comment">//480</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BITS_PER_PIXEL</span> <span class="token expression"><span class="token number">32</span></span></span>

<span class="token comment">/**********调试用到的变量****/</span>
<span class="token keyword">int</span> j<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>res_debug<span class="token punctuation">;</span>
<span class="token comment">/**********/</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>fs4412_lcd<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">void</span> __iomem <span class="token operator">*</span>lcd_regs_base<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">void</span> __iomem <span class="token operator">*</span>lcdblk_regs_base<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">void</span> __iomem <span class="token operator">*</span>lcd0_configuration<span class="token punctuation">;</span><span class="token comment">//Configures power mode of LCD0.0x10020000+0x3C80</span>
<span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">void</span> __iomem <span class="token operator">*</span>clk_regs_base<span class="token punctuation">;</span>

<span class="token keyword">static</span> u32 pseudo_palette<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>res0<span class="token punctuation">,</span> <span class="token operator">*</span>res1<span class="token punctuation">,</span> <span class="token operator">*</span>res2<span class="token punctuation">,</span> <span class="token operator">*</span>res3<span class="token punctuation">;</span>

<span class="token comment">/* from pxafb.c */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">chan_to_field</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> chan<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">fb_bitfield</span> <span class="token operator">*</span>bf<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    chan <span class="token operator">&amp;=</span> <span class="token number">0xFFFF</span><span class="token punctuation">;</span><span class="token comment">//保留低16位</span>
    chan <span class="token operator">&gt;&gt;=</span> <span class="token number">16</span> <span class="token operator">-</span> bf<span class="token operator">-&gt;</span>length<span class="token punctuation">;</span><span class="token comment">//保留高bf-&gt;length位</span>
    
    <span class="token keyword">return</span> chan <span class="token operator">&lt;&lt;</span> bf<span class="token operator">-&gt;</span>offset<span class="token punctuation">;</span><span class="token comment">//返回保留的位，且在原位置</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">cfb_setcolreg</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> regno<span class="token punctuation">,</span>   <span class="token keyword">unsigned</span> <span class="token keyword">int</span> red<span class="token punctuation">,</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> green<span class="token punctuation">,</span>   <span class="token keyword">unsigned</span> <span class="token keyword">int</span> blue<span class="token punctuation">,</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> transp<span class="token punctuation">,</span>     <span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> color <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    color  <span class="token operator">=</span> <span class="token function">chan_to_field</span><span class="token punctuation">(</span>red<span class="token punctuation">,</span>   <span class="token operator">&amp;</span>info<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>
    color <span class="token operator">|=</span> <span class="token function">chan_to_field</span><span class="token punctuation">(</span>green<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>green<span class="token punctuation">)</span><span class="token punctuation">;</span>
    color <span class="token operator">|=</span> <span class="token function">chan_to_field</span><span class="token punctuation">(</span>blue<span class="token punctuation">,</span>  <span class="token operator">&amp;</span>info<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>blue<span class="token punctuation">)</span><span class="token punctuation">;</span>p <span class="token operator">=</span> info<span class="token operator">-&gt;</span>pseudo_palette<span class="token punctuation">;</span>  
    p<span class="token punctuation">[</span>regno<span class="token punctuation">]</span> <span class="token operator">=</span> color<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">fb_ops</span> fs4412_lcdfb_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>fb_setcolreg <span class="token operator">=</span> cfb_setcolreg<span class="token punctuation">,</span> <span class="token comment">//设置调色板，实现伪颜色表</span>
    <span class="token punctuation">.</span>fb_fillrect <span class="token operator">=</span> cfb_fillrect<span class="token punctuation">,</span> <span class="token comment">//填充矩形</span>
    <span class="token punctuation">.</span>fb_copyarea <span class="token operator">=</span> cfb_copyarea<span class="token punctuation">,</span> <span class="token comment">//数据复制</span>
    <span class="token punctuation">.</span>fb_imageblit <span class="token operator">=</span> cfb_imageblit<span class="token punctuation">,</span> <span class="token comment">//图形填充</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">lcd_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> temp<span class="token punctuation">;</span>

    
    
    <span class="token comment">/* 1. 分配一个fb_info */</span>
    fs4412_lcd <span class="token operator">=</span> <span class="token function">framebuffer_alloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">//不要额外空间设置私有数据</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fs4412_lcd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       
        <span class="token keyword">return</span>  <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 2. 设置 */</span>
    
    <span class="token comment">/* 2.1 设置 fix 固定的参数 */</span>
    
    <span class="token function">strcpy</span><span class="token punctuation">(</span>fs4412_lcd<span class="token operator">-&gt;</span>fix<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">"s702"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">//设置fix名称</span>
    fs4412_lcd<span class="token operator">-&gt;</span>fix<span class="token punctuation">.</span>smem_len <span class="token operator">=</span> LCD_LENTH<span class="token operator">*</span>LCD_WIDTH<span class="token operator">*</span>BITS_PER_PIXEL<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">//显存的长度=分辨率*每象素字节数</span>
    fs4412_lcd<span class="token operator">-&gt;</span>fix<span class="token punctuation">.</span>type     <span class="token operator">=</span> FB_TYPE_PACKED_PIXELS<span class="token punctuation">;</span>                <span class="token comment">//类型:填充式像素(常用在TFT屏幕)</span>
    fs4412_lcd<span class="token operator">-&gt;</span>fix<span class="token punctuation">.</span>visual   <span class="token operator">=</span> FB_VISUAL_TRUECOLOR<span class="token punctuation">;</span>                  <span class="token comment">//TFT 真彩色</span>
    fs4412_lcd<span class="token operator">-&gt;</span>fix<span class="token punctuation">.</span>line_length <span class="token operator">=</span> LCD_LENTH<span class="token operator">*</span>BITS_PER_PIXEL<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span>        <span class="token comment">//每行的长度，以字节为单位</span>
    
    <span class="token comment">/* 2.2 设置 var 可变的参数 */</span>
    
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>xres           <span class="token operator">=</span> LCD_LENTH<span class="token punctuation">;</span>                      <span class="token comment">//x方向分辨率</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>yres           <span class="token operator">=</span> LCD_WIDTH<span class="token punctuation">;</span>                      <span class="token comment">//y方向分辨率</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>xres_virtual   <span class="token operator">=</span> LCD_LENTH<span class="token punctuation">;</span>                      <span class="token comment">//x方向虚拟分辨率</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>yres_virtual   <span class="token operator">=</span> LCD_WIDTH<span class="token punctuation">;</span>                      <span class="token comment">//y方向虚拟分辨率</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>xoffset        <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>                   <span class="token comment">//x方向真实值和虚拟值得差值0</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>yoffset        <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                     <span class="token comment">//y方向真实值和虚拟值得差值</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>bits_per_pixel <span class="token operator">=</span> BITS_PER_PIXEL<span class="token punctuation">;</span>                 <span class="token comment">//每个像素占多少位RGB:888</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>red<span class="token punctuation">.</span>length     <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>red<span class="token punctuation">.</span>offset     <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>   <span class="token comment">//红</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>green<span class="token punctuation">.</span>length   <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>green<span class="token punctuation">.</span>offset   <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>    <span class="token comment">//绿</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>blue<span class="token punctuation">.</span>length    <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>blue<span class="token punctuation">.</span>offset    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//蓝</span>

    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>pixclock <span class="token operator">=</span> <span class="token number">65000000</span><span class="token punctuation">;</span>  <span class="token comment">//65MHZ</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>left_margin <span class="token operator">=</span> <span class="token number">140</span><span class="token punctuation">;</span> <span class="token comment">//HBP</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>right_margin <span class="token operator">=</span> <span class="token number">160</span><span class="token punctuation">;</span> <span class="token comment">//HFP</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>upper_margin <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>  <span class="token comment">//VBP</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>lower_margin <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>  <span class="token comment">//VFP</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>hsync_len <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>  
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>vsync_len <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token operator">~</span>FB_SYNC_HOR_HIGH_ACT <span class="token operator">|</span> <span class="token operator">~</span>FB_SYNC_VERT_HIGH_ACT<span class="token punctuation">;</span>
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>vmode <span class="token operator">=</span> FB_VMODE_NONINTERLACED<span class="token punctuation">;</span>
    
    fs4412_lcd<span class="token operator">-&gt;</span>var<span class="token punctuation">.</span>activate       <span class="token operator">=</span> FB_ACTIVATE_NOW<span class="token punctuation">;</span>      <span class="token comment">//使设置的值立即生效</span>

    <span class="token comment">/* 2.3 设置操作函数 */</span>
    
    fs4412_lcd<span class="token operator">-&gt;</span>fbops              <span class="token operator">=</span> <span class="token operator">&amp;</span>fs4412_lcdfb_ops<span class="token punctuation">;</span>  <span class="token comment">//绑定操作函数</span>
    
    <span class="token comment">/* 2.4 其他的设置 */</span>
    
    fs4412_lcd<span class="token operator">-&gt;</span>pseudo_palette     <span class="token operator">=</span> pseudo_palette<span class="token punctuation">;</span>       <span class="token comment">//存放调色板所调颜色的数组</span>
    fs4412_lcd<span class="token operator">-&gt;</span>screen_size        <span class="token operator">=</span> LCD_LENTH <span class="token operator">*</span> LCD_WIDTH <span class="token operator">*</span> BITS_PER_PIXEL <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">;</span>   <span class="token comment">//显存大小</span>
    
    <span class="token comment">/* 3. 硬件相关的操作 */</span>
    
    <span class="token comment">/* 3.1 配置GPIO用于LCD */</span>
    
    <span class="token comment">//在设备树中，将 GPF0_0-GPF0_7、GPF1_0-GPF1_7、GPF2_0-GPF2_7、GPF3_0-GPF3_3</span>
    <span class="token comment">//配置为了复用第二功能(LCD)，禁止内部上拉，驱动强度配置设置为0;</span>
    
    <span class="token comment">/* 3.2 根据LCD手册设置LCD控制器, 比如VCLK的频率等 */</span>
    <span class="token comment">//寄存器映射</span>
    <span class="token comment">/**********打印出所有resource*/</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>pdev<span class="token operator">-&gt;</span>num_resources<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        res_debug <span class="token operator">=</span> pdev<span class="token operator">-&gt;</span>resource<span class="token operator">+</span>j<span class="token punctuation">;</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"debug: resournces[%d],start:[%X], end:[%X],name:[%s],flags:[%X],parent[%p],sibling[%p],child[%p]\n"</span><span class="token punctuation">,</span>j<span class="token punctuation">,</span>res_debug<span class="token operator">-&gt;</span>start<span class="token punctuation">,</span>res_debug<span class="token operator">-&gt;</span>end<span class="token punctuation">,</span>res_debug<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>res_debug<span class="token operator">-&gt;</span>flags<span class="token punctuation">,</span>res_debug<span class="token operator">-&gt;</span>parent<span class="token punctuation">,</span>res_debug<span class="token operator">-&gt;</span>sibling<span class="token punctuation">,</span>res_debug<span class="token operator">-&gt;</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**********/</span>
    res0 <span class="token operator">=</span> <span class="token function">platform_get_resource</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> IORESOURCE_MEM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res0 <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"debug: lcd_driver.c-&gt;lcd_probe()  platform_get_resource A  error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    lcd_regs_base <span class="token operator">=</span> <span class="token function">devm_ioremap_resource</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> res0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lcd_regs_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"debug : lcd_driver.c -&gt; lcd_probe() devm_ioremap_resource  A error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    res1 <span class="token operator">=</span> <span class="token function">platform_get_resource</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> IORESOURCE_MEM<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res1 <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"debug: lcd_driver.c-&gt;lcd_probe()  platform_get_resource B  error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    lcdblk_regs_base <span class="token operator">=</span> <span class="token function">devm_ioremap_resource</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> res1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lcdblk_regs_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"debug : lcd_driver.c -&gt; lcd_probe() devm_ioremap_resource  B error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    res2 <span class="token operator">=</span> <span class="token function">platform_get_resource</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> IORESOURCE_MEM<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res2 <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"debug: lcd_driver.c-&gt;lcd_probe()  platform_get_resource C  error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/*devm_ioremap()和devm_ioremap_resource()区别：
        devm_ioremap()可以重复map相同的地址空间，devm_ioremap_resource()不可以。
        一般SoC的中，各个硬件模块各自的memory region都有严格的划分(比如说USB host的地址空间绝对不会和flash host冲突)，所以一般的driver使用devm_ioremap()和devm_ioremap_resource()都行。
        但这里，应该系统已经映射过一次了，所以使用devm_ioremap_resource()会报错。*/</span>

    lcd0_configuration <span class="token operator">=</span> <span class="token function">devm_ioremap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> res2<span class="token operator">-&gt;</span>start<span class="token punctuation">,</span> <span class="token function">resource_size</span><span class="token punctuation">(</span>res2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lcd0_configuration <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"debug : lcd_driver.c -&gt; lcd_probe() devm_ioremap_resource  C  error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>lcd0_configuration <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">//Reset Value = 0x00000007 power on </span>
    
    res3 <span class="token operator">=</span> <span class="token function">platform_get_resource</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> IORESOURCE_MEM<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res3 <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"debug: lcd_driver.c-&gt;lcd_probe()  platform_get_resource D  error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    

    <span class="token comment">//clk_regs_base = devm_ioremap_resource(&amp;pdev-&gt;dev, res3);</span>
    clk_regs_base <span class="token operator">=</span> <span class="token function">devm_ioremap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> res3<span class="token operator">-&gt;</span>start<span class="token punctuation">,</span> <span class="token function">resource_size</span><span class="token punctuation">(</span>res3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clk_regs_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"debug : lcd_driver.c -&gt; lcd_probe() devm_ioremap_resource  D  error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//时钟源选择\使能时钟</span>
    <span class="token comment">//Selects clock source for LCD_BLK</span>
    <span class="token comment">//FIMD0_SEL:bit[3:0]=0110=SCLKMPLL_USER_T=800M</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>clk_regs_base <span class="token operator">+</span> CLK_SRC_LCD0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x0F</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> clk_regs_base <span class="token operator">+</span> CLK_SRC_LCD0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//Clock source mask for LCD_BLK</span>
    <span class="token comment">//FIMD0_MASK:Mask output clock of MUXFIMD0 (1=Unmask)</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>clk_regs_base <span class="token operator">+</span> CLK_SRC_MASK_LCD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x01</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> clk_regs_base <span class="token operator">+</span> CLK_SRC_MASK_LCD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//设置LCD_BLK的时钟分频    </span>
    <span class="token comment">//SCLK_FIMD0 = MOUTFIMD0/(FIMD0_RATIO + 1),分频比 1/1</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>clk_regs_base <span class="token operator">+</span> CLK_DIV_LCD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x0F</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> clk_regs_base <span class="token operator">+</span> CLK_DIV_LCD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//Controls IP clock gating for LCD_BLK 时钟使能  </span>
    <span class="token comment">//CLK_FIMD0:Gating all clocks for FIMD0 (1=Pass)</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>clk_regs_base <span class="token operator">+</span> CLK_GATE_IP_LCD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x01</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> clk_regs_base <span class="token operator">+</span> CLK_GATE_IP_LCD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//背光控制</span>
    <span class="token comment">//FIMDBYPASS_LBLK0:FIMD of LBLK0 Bypass Selection (1=FIMD Bypass)</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>lcdblk_regs_base <span class="token operator">+</span> LCDBLK_CFG<span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x01</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> lcdblk_regs_base <span class="token operator">+</span> LCDBLK_CFG<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//PWM设置</span>
    <span class="token comment">//MIE0_DISPON:MIE0_DISPON: PWM output control (1=PWM outpupt enable)</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>lcdblk_regs_base <span class="token operator">+</span> LCDBLK_CFG2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x01</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> lcdblk_regs_base <span class="token operator">+</span> LCDBLK_CFG2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mdelay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    
    <span class="token comment">//VIDCON0的VCLK时钟设置</span>
    <span class="token comment">//LCD时钟:  VCLK=FIMD*SCLK/(CLKVAL+1), where CLKVAL&gt;=1</span>
    <span class="token comment">//800/(19+1) == 40M&lt;80M</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>lcd_regs_base <span class="token operator">+</span> VIDCON0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">19</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//temp |= (3&lt;&lt;6);</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> VIDCON0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/** 
    * VIDCON1:
    * [5]:IVSYNC  ===&gt; 1 : Inverted(反转)
    * [6]:IHSYNC  ===&gt; 1 : Inverted(反转)
    * [7]:IVCLK   ===&gt; 1 : Fetches video data at VCLK rising edge (上降沿触发)
    * [10:9]:FIXVCLK  ====&gt; 01 : VCLK running
    * */</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>lcd_regs_base <span class="token operator">+</span> VIDCON1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> VIDCON1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/** 
    * VIDTCON0:
    * * [23:16]:  VBPD+1=tvb-tvpw=23-11=12 --&gt; VBPD=11
    * * [15:8] :  VFPD+1=tvfp=22 --&gt; VFPD=21
    * * [7:0]  :  VSPW+1=tvpw=1~20(暂取11) --&gt; VSPW=10
    * */</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>lcd_regs_base <span class="token operator">+</span> VIDTCON0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//temp |= (11 &lt;&lt; 16) | (21 &lt;&lt; 8) | (10 &lt;&lt; 0);</span>
    temp <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">20</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">12</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> VIDTCON0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/** VIDTCON1:
    * * [23:16]:  HBPD+1=thb-hpw=46-21=25 --&gt; HBPD=24
    * * [15:8] :  HFPD+1=thfp=210 --&gt; HFPD=209
    * * [7:0]  :  HSPW+1=hpw=1~40(暂取21) --&gt; HSPW=20
    * */</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>lcd_regs_base <span class="token operator">+</span> VIDTCON1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//temp |= (24 &lt;&lt; 16) | (209 &lt;&lt; 8)  | (20 &lt;&lt; 0);</span>
    temp <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">140</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">160</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span>  <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">20</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> VIDTCON1<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   <span class="token comment">/**VIDTCON2 
    * HOZVAL = (Horizontal display size) - 1 
    * LINEVAL = (Vertical display size) - 1.
    * * Horizontal(水平) display size : 800
    * * Vertical(垂直) display size : 480*/</span>
    temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>LCD_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>LCD_LENTH <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> VIDTCON2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/**   
    * WINCON0:
    * * [15]:Specifies Word swap control bit.  1 = Enables swap 低位像素存放在低字节
    * * [5:2]: Selects Bits Per Pixel (BPP) mode for Window image : 1101 ===&gt; Unpacked 25 BPP (non-palletized A:1-R:8-G:8-B:8)
    * * [0]:Enables/disables video output   1 = Enables
    * */</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>lcd_regs_base <span class="token operator">+</span> WINCON0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x0F</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0X01</span> <span class="token operator">&lt;&lt;</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x0D</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x01</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> WINCON0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//SHADOWCON</span>
    <span class="token comment">//Enables Channel 0.</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>lcd_regs_base <span class="token operator">+</span> SHADOWCON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp <span class="token operator">|</span> <span class="token number">0x01</span><span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> SHADOWCON<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    <span class="token comment">//WINCHMAP2</span>
    <span class="token comment">//Selects Channel 0</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>lcd_regs_base <span class="token operator">+</span> WINCHMAP2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">7</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x01</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//CH0FISEL:Selects Channel 0's channel.001 = Window 0</span>
    temp <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">7</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x01</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//W0FISEL:Selects Window 0's channel.001 = Channel 0</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> WINCHMAP2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//VIDOSD0A VIDOSD0B VIDOSD0C</span>
    <span class="token comment">//设置OSD显示大小</span>
    <span class="token comment">//Window Size For example. Height *  Width (number of word)</span>
    temp <span class="token operator">=</span> <span class="token punctuation">(</span>LCD_LENTH <span class="token operator">*</span> LCD_WIDTH<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> VIDOSD0C<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/** bit0-10 : 指定OSD图像左上像素的垂直屏幕坐标
    * * bit11-21: 指定OSD图像左上像素的水平屏幕坐标*/</span>
    <span class="token function">writel</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> VIDOSD0A<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/** bit0-10 : 指定OSD图像右下像素的垂直屏幕坐标
    * * bit11-21: 指定OSD图像右下像素的水平屏幕坐标*/</span>
    <span class="token function">writel</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LCD_LENTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>LCD_WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> VIDOSD0B<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//VIDCON0</span>
    <span class="token comment">//Display On: ENVID and ENVID_F are set to "1".</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>lcd_regs_base <span class="token operator">+</span> VIDCON0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x01</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x01</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> VIDCON0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 3.3 分配显存(framebuffer), 并把地址告诉LCD控制器 */</span>
    <span class="token comment">// fs4412_lcd-&gt;screen_base         显存虚拟地址</span>
    <span class="token comment">// fs4412_lcd-&gt;fix.smem_len        显存大小，前面计算的</span>
    <span class="token comment">// fs4412_lcd-&gt;fix.smem_start      显存物理地址</span>
    fs4412_lcd<span class="token operator">-&gt;</span>screen_base <span class="token operator">=</span> <span class="token function">dma_alloc_writecombine</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> fs4412_lcd<span class="token operator">-&gt;</span>fix<span class="token punctuation">.</span>smem_len<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">dma_addr_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>fs4412_lcd<span class="token operator">-&gt;</span>fix<span class="token punctuation">.</span>smem_start<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//显存起始地址</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>fs4412_lcd<span class="token operator">-&gt;</span>fix<span class="token punctuation">.</span>smem_start<span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> VIDW00ADD0B0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//显存结束地址</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>fs4412_lcd<span class="token operator">-&gt;</span>fix<span class="token punctuation">.</span>smem_start <span class="token operator">+</span> fs4412_lcd<span class="token operator">-&gt;</span>fix<span class="token punctuation">.</span>smem_len<span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> VIDW00ADD1B0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 4. 注册 */</span>

    ret <span class="token operator">=</span> <span class="token function">register_framebuffer</span><span class="token punctuation">(</span>fs4412_lcd<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">lcd_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">//Direct Off: ENVID and ENVID_F are set to “0” simultaneously.</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> temp<span class="token punctuation">;</span>
    temp <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>lcd_regs_base <span class="token operator">+</span> VIDCON0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span> <span class="token operator">|</span> <span class="token number">0x01</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> lcd_regs_base <span class="token operator">+</span> VIDCON0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">unregister_framebuffer</span><span class="token punctuation">(</span>fs4412_lcd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dma_free_writecombine</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> fs4412_lcd<span class="token operator">-&gt;</span>fix<span class="token punctuation">.</span>smem_len<span class="token punctuation">,</span> fs4412_lcd<span class="token operator">-&gt;</span>screen_base<span class="token punctuation">,</span> fs4412_lcd<span class="token operator">-&gt;</span>fix<span class="token punctuation">.</span>smem_start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">framebuffer_release</span><span class="token punctuation">(</span>fs4412_lcd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> lcd_dt_ids<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"samsung,exynos4210-fimd"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">MODULE_DEVICE_TABLE</span><span class="token punctuation">(</span>of<span class="token punctuation">,</span> lcd_dt_ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> lcd_driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>driver<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"mylcd"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>of_match_table <span class="token operator">=</span> <span class="token function">of_match_ptr</span><span class="token punctuation">(</span>lcd_dt_ids<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> lcd_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> lcd_remove<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">lcd_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lcd_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">lcd_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"enter %s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lcd_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>lcd_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>lcd_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>以上内容。细节很多，特别是在probe函数中的寄存器赋值部份还有相当多的细节，但在这里是讲述驱动框架的，因此另开一篇来讲解exynos4412的LCD控制器的寄存器操作。</p> 
<h2><a id="4LCD_1252"></a>4、测试LCD显示的应用程序</h2> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FBDEVICE</span> <span class="token string">"/dev/fb0"</span></span>
<span class="token keyword">void</span> <span class="token function">draw_back</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>pfb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">draw_line</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>pfb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>pfb <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">fb_fix_screeninfo</span> finfo<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">fb_var_screeninfo</span> vinfo<span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>FBDEVICE<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open %s success \n"</span><span class="token punctuation">,</span> FBDEVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*获取fb信息*/</span>
    ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> FBIOGET_FSCREENINFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>finfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> FBIOGET_VSCREENINFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*建立mmap映射*/</span>
    pfb <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> finfo<span class="token punctuation">.</span>smem_len<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> pfb<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pfb :0x%x \n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token punctuation">)</span> pfb<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">draw_back</span><span class="token punctuation">(</span>pfb<span class="token punctuation">,</span> vinfo<span class="token punctuation">.</span>xres_virtual<span class="token punctuation">,</span> vinfo<span class="token punctuation">.</span>yres_virtual<span class="token punctuation">,</span> <span class="token number">0xffff0000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">draw_line</span><span class="token punctuation">(</span>pfb<span class="token punctuation">,</span> vinfo<span class="token punctuation">.</span>xres_virtual<span class="token punctuation">,</span> vinfo<span class="token punctuation">.</span>yres_virtual<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">draw_back</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>pfb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> color<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span><span class="token punctuation">(</span>pfb <span class="token operator">+</span> y <span class="token operator">*</span> width <span class="token operator">+</span> x<span class="token punctuation">)</span> <span class="token operator">=</span> color<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">draw_line</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>pfb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> width <span class="token operator">-</span> <span class="token number">50</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span><span class="token punctuation">(</span>pfb <span class="token operator">+</span> <span class="token number">50</span> <span class="token operator">*</span> width <span class="token operator">+</span> x<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0xffffff00</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> height <span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span><span class="token punctuation">(</span>pfb <span class="token operator">+</span> y <span class="token operator">*</span> width <span class="token operator">+</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0xffffff00</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2><a id="_1343"></a>写在结尾</h2> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span> 本篇与上一篇是linux下的LCD驱动框架-FrameBuffer框架的完整笔记，框架本身是简单的，但由于涉及到大量LCD的显示原理，LCD控制器的配置，寄存器的配置，时序的分辨等。而这些又与大量的数据结构相对应。在理清上述内容后，又需要在开发板上进行验证，因此这两篇实际写了一个多月。<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
       
      
        \qquad 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em;"></span><span class="mspace" style="margin-right: 2em;"></span></span></span></span></span>内容又多又杂，难免有诸多遗漏与不足，因此，在以后如有发现缺漏，我将会随时进行修改。</p> 
<h2><a id="_1354"></a>参考</h2> 
<p>https://blog.csdn.net/qq_28992301/article/details/52727050<br> https://www.cnblogs.com/armlinux/archive/2011/01/14/2396864.html<br> https://zhuanlan.zhihu.com/p/598132318<br> http://www.51hei.com/bbs/dpj-43162-1.html<br> https://www.ngui.cc/zz/1632478.html?action=onClick</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/436c3e3743249dc06a34bb7672b28991/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">heap pwn 入门大全 - 1：glibc heap机制与源码阅读(上)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/861a095774428b3452891031a2a8e271/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">heap pwn 入门大全 - 2：glibc heap机制与源码阅读(下)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>