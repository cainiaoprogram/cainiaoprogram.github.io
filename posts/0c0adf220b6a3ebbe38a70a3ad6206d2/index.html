<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【MMCV】让你在10分钟了解mmcv注册器（registry) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【MMCV】让你在10分钟了解mmcv注册器（registry)" />
<meta property="og:description" content="文章目录 前言一、注册器是什么？二、使用步骤一个简单的例子自定义构建MMCV实例说明三.注册器的层次 总结 前言 MMCV 使用 注册器 来管理具有相似功能的不同模块, 例如, 检测器中的主干网络、头部、和模型颈部。 在 OpenMMLab 家族中的绝大部分开源项目使用注册器去管理数据集和模型的模块，例如 MMDetection。
官方指南
一、注册器是什么？ 在MMCV中，注册器可以看作类到字符串的映射。 一个注册器中的类通常有相似的接口，但是可以实现不同的算法或支持不同的数据集。 借助注册器，用户可以通过使用相应的字符串查找并实例化该类，并根据他们的需要实例化对应模块。
二、使用步骤 1.创建一个构建方法（可选，在大多数情况下您可以只使用默认方法）
2.创建注册器
3.使用此注册器来管理模块
一个简单的例子 file1： from mmcv.utils import Registry # 创建转换器（converter）的注册器（registry） CONVERTERS = Registry(&#39;converter&#39;) file2： from .builder import CONVERTERS # 使用注册器管理模块 @CONVERTERS.register_module() class Converter1(object): def __init__(self, a, b): self.a = a self.b = b file3： converter_cfg = dict(type=&#39;Converter1&#39;, a=a_value, b=b_value) converter = CONVERTERS.build(converter_cfg) 在这里就实现了字符串到类的 对应转化——‘Converter1’ -&gt; &lt;class ‘Converter1’&gt;
通过XXX.build( )函数来实例化" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0c0adf220b6a3ebbe38a70a3ad6206d2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-05T16:35:01+08:00" />
<meta property="article:modified_time" content="2021-12-05T16:35:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【MMCV】让你在10分钟了解mmcv注册器（registry)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_7" rel="nofollow">前言</a></li><li><a href="#_14" rel="nofollow">一、注册器是什么？</a></li><li><a href="#_21" rel="nofollow">二、使用步骤</a></li><li><ul><li><a href="#_26" rel="nofollow">一个简单的例子</a></li><li><a href="#_51" rel="nofollow">自定义构建</a></li><li><a href="#MMCV_73" rel="nofollow">MMCV实例说明</a></li><li><a href="#_107" rel="nofollow">三.注册器的层次</a></li></ul> 
  </li><li><a href="#_116" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<h2><a id="_7"></a>前言</h2> 
<p>MMCV 使用 注册器 来管理具有相似功能的不同模块, 例如, 检测器中的主干网络、头部、和模型颈部。 在 OpenMMLab 家族中的绝大部分开源项目使用注册器去管理数据集和模型的模块，例如 MMDetection。<br> <font color="#999AAA"> <a href="https://mmcv.readthedocs.io/en/latest/understand_mmcv/registry.html" rel="nofollow">官方指南</a></font></p> 
<hr color="#000000" size='1"'> 
<h2><a id="_14"></a>一、注册器是什么？</h2> 
<p>在MMCV中，注册器可以看作<font color="#dd0000"><strong>类到字符串的映射</strong></font>。 一个注册器中的类通常有相似的接口，但是可以实现不同的算法或支持不同的数据集。 借助注册器，用户可以<font color="#dd0000"><strong>通过使用相应的字符串查找并实例化该类</strong></font>，并根据他们的需要实例化对应模块。</p> 
<h2><a id="_21"></a>二、使用步骤</h2> 
<p>1.创建一个构建方法（可选，在大多数情况下您可以只使用默认方法）<br> 2.创建注册器<br> 3.使用此注册器来管理模块</p> 
<h3><a id="_26"></a>一个简单的例子</h3> 
<pre><code class="prism language-python">file1：
	<span class="token keyword">from</span> mmcv<span class="token punctuation">.</span>utils <span class="token keyword">import</span> Registry
	<span class="token comment"># 创建转换器（converter）的注册器（registry）</span>
	CONVERTERS <span class="token operator">=</span> Registry<span class="token punctuation">(</span><span class="token string">'converter'</span><span class="token punctuation">)</span>
	
file2：
	<span class="token keyword">from</span> <span class="token punctuation">.</span>builder <span class="token keyword">import</span> CONVERTERS
	
	<span class="token comment"># 使用注册器管理模块</span>
	<span class="token decorator annotation punctuation">@CONVERTERS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">class</span> <span class="token class-name">Converter1</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
	        self<span class="token punctuation">.</span>a <span class="token operator">=</span> a
	        self<span class="token punctuation">.</span>b <span class="token operator">=</span> b
file3：   
	converter_cfg <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Converter1'</span><span class="token punctuation">,</span> a<span class="token operator">=</span>a_value<span class="token punctuation">,</span> b<span class="token operator">=</span>b_value<span class="token punctuation">)</span>
	converter <span class="token operator">=</span> CONVERTERS<span class="token punctuation">.</span>build<span class="token punctuation">(</span>converter_cfg<span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p>在这里就实现了字符串到类的 对应转化——‘Converter1’ -&gt; &lt;class ‘Converter1’&gt;<br> 通过XXX.build( )函数来实例化</p> 
</blockquote> 
<h3><a id="_51"></a>自定义构建</h3> 
<p>我们可以实现一个自定义的 build_func （构建函数）并将其传递到注册器中。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> mmcv<span class="token punctuation">.</span>utils <span class="token keyword">import</span> Registry

<span class="token comment"># 创建一个构建函数</span>
<span class="token keyword">def</span> <span class="token function">build_converter</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> registry<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cfg_ <span class="token operator">=</span> cfg<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    converter_type <span class="token operator">=</span> cfg_<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> converter_type <span class="token keyword">not</span> <span class="token keyword">in</span> registry<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> KeyError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Unrecognized converter type </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>converter_type<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        converter_cls <span class="token operator">=</span> registry<span class="token punctuation">.</span>get<span class="token punctuation">(</span>converter_type<span class="token punctuation">)</span>

    converter <span class="token operator">=</span> converter_cls<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">,</span> <span class="token operator">**</span>cfg_<span class="token punctuation">)</span>
    <span class="token keyword">return</span> converter

<span class="token comment"># 创建一个用于转换器（converters）的注册器，并传递（registry）``build_converter`` 函数</span>
CONVERTERS <span class="token operator">=</span> Registry<span class="token punctuation">(</span><span class="token string">'converter'</span><span class="token punctuation">,</span> build_func<span class="token operator">=</span>build_converter<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="MMCV_73"></a>MMCV实例说明</h3> 
<p>在mmcv/cnn/builder.py 中自定义了build_func( )</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">build_model_from_cfg</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> registry<span class="token punctuation">,</span> default_args<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Build a PyTorch model from config dict(s). Different from
    ``build_from_cfg``, if cfg is a list, a ``nn.Sequential`` will be built.

    Args:
        cfg (dict, list[dict]): The config of modules, is is either a config
            dict or a list of config dicts. If cfg is a list, a
            the built modules will be wrapped with ``nn.Sequential``.
        registry (:obj:`Registry`): A registry the module belongs to.
        default_args (dict, optional): Default arguments to build the module.
            Defaults to None.

    Returns:
        nn.Module: A built nn module.
    """</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        modules <span class="token operator">=</span> <span class="token punctuation">[</span>
            build_from_cfg<span class="token punctuation">(</span>cfg_<span class="token punctuation">,</span> registry<span class="token punctuation">,</span> default_args<span class="token punctuation">)</span> <span class="token keyword">for</span> cfg_ <span class="token keyword">in</span> cfg
        <span class="token punctuation">]</span>
        <span class="token keyword">return</span> Sequential<span class="token punctuation">(</span><span class="token operator">*</span>modules<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> build_from_cfg<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> registry<span class="token punctuation">,</span> default_args<span class="token punctuation">)</span>


MODELS <span class="token operator">=</span> Registry<span class="token punctuation">(</span><span class="token string">'model'</span><span class="token punctuation">,</span> build_func<span class="token operator">=</span>build_model_from_cfg<span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p>其中就包含了自定义函数的注册器的用法<br> 上述函数实现了——如果config类型是一个list，构建一个modules，其类型为‘ nn.Sequential ’</p> 
</blockquote> 
<h3><a id="_107"></a>三.注册器的层次</h3> 
<p>可以通过父类注册器来构建子类注册器</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> mmcv<span class="token punctuation">.</span>cnn <span class="token keyword">import</span> MODELS <span class="token keyword">as</span> MMCV_MODELS

MODELS <span class="token operator">=</span> Registry<span class="token punctuation">(</span><span class="token string">'models'</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>MMCV_MODELS<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_116"></a>总结</h2> 
<p><font color="#999AAA">注册器是理解mmcv的重要内容，作者也是通过这篇文章来，记下相关内容，供自己学习使用！</font></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/58396741e6872a4f7c42fb9c7905da2b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">集合之深入理解PriorityQueue</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bb85a8a2aedcf76f7107852c58fe23ad/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">OOK调制解调的FPGA实现，求Verilog代码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>