<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>实际应用Supervisor部署Flask项目 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="实际应用Supervisor部署Flask项目" />
<meta property="og:description" content="1. 什么是supervisor superviosr是一个Linux/Unix系统上的进程监控工具，他/她upervisor是一个Python开发的通用的进程管理程序，可以管理和监控Linux上面的进程，能将一个普通的命令行进程变为后台daemon，并监控进程状态，异常退出时能自动重启。不过同daemontools一样，它不能监控daemon进程。
各个微服务的开发过程中，都是使用 Flask 自带的 server 来运行应用。在正式部署的时候，需要使用性能更好的专业 WSGI 容器来运行应用。所以选择superviosr，在每个服务的 app 里已经添加了使用 gevent 的 WSGIServer 来运行应用的代码。
2. 为什么用supervisor 使用简单
supervisor提供了一种统一的方式来start、stop、monitor你的进程， 进程可以单独控制，也可以成组的控制。你可以在本地或者远程命令行或者web接口来配置Supervisor。
在linux下的很多程序通常都是一直运行着的，一般来说都需要自己编写一个能够实现进程start/stop/restart/reload功能的脚本，然后放到/etc/init.d/下面。但这样做也有很多弊端，第一我们要为每个程序编写一个类似脚本，第二，当这个进程挂掉的时候，linux不会自动重启它的，想要自动重启的话，我们还要自己写一个监控重启脚本。
而supervisor则可以完美的解决这些问题。supervisor管理进程，就是通过fork/exec的方式把这些被管理的进程，当作supervisor的子进程来启动。这样的话，我们只要在supervisor的配置文件中，把要管理的进程的可执行文件的路径写进去就OK了。第二，被管理进程作为supervisor的子进程，当子进程挂掉的时候，父进程可以准确获取子进程挂掉的信息的，所以当然也就可以对挂掉的子进程进行自动重启，当然重启还是不重启，也要看你的配置文件里面有木有设置autostart=true了。
supervisor通过INI格式配置文件进行配置，很容易掌握，它为每个进程提供了很多配置选项，可以使你很容易的重启进程或者自动的轮转日志。
集中管理
supervisor管理的进程，进程组信息，全部都写在一个ini格式的文件里就OK了。而且，我们管理supervisor的时候的可以在本地进行管理，也可以远程管理，而且supervisor提供了一个web界面，我们可以在web界面上监控，管理进程。 当然了，本地，远程和web管理的时候，需要调用supervisor的xml_rpc接口，这个也是后话。
supervisor可以对进程组统一管理，也就是说咱们可以把需要管理的进程写到一个组里面，然后我们把这个组作为一个对象进行管理，如启动，停止，重启等等操作。而linux系统则是没有这种功能的，我们想要停止一个进程，只能一个一个的去停止，要么就自己写个脚本去批量停止
3. supervisor组件 supervisord
主进程,负责管理进程的server，它会根据配置文件创建指定数量的应用程序的子进程，管理子进程的整个生命周期，对crash的进程重启，对进程变化发送事件通知等。同时内置web server和XML-RPC Interface，轻松实现进程管理。。该服务的配置文件在/etc/supervisor/supervisord.conf。
supervisorctl
客户端的命令行工具，提供一个类似shell的操作接口，通过它你可以连接到不同的supervisord进程上来管理它们各自的子程序，命令通过UNIX socket或者TCP来和服务通讯。用户通过命令行发送消息给supervisord，可以查看进程状态，加载配置文件，启停进程，查看进程标准输出和错误输出，远程操作等。服务端也可以要求客户端提供身份验证之后才能进行操作。
Web Server
superviosr提供了web server功能，可通过web控制进程(需要设置[inethttpserver]配置项)。
XML-RPC Interface
XML-RPC接口， 就像HTTP提供WEB UI一样，用来控制supervisor和由它运行的程序。
4. 安装、配置、使用 supervisor是python编写的，可以用easy_install、pip都可以安装，比如在我的centos机器下，安装命令如下：
yum install python-setuptools easy_install pip pip install superviso 在这里我使用pip安装之后，在创建配置文件的时候出错，所以我又选择了使用easy_install supervisor的安装方法
当然也可以下载源码进行安装，比如：
wget https://pypi.python.org/packages/source/s/supervisor/supervisor-3.1.3.tar.gz --no-check-certificat tar -zxvf supervisor-3.1.3.tar.gz cd supervisor-3.1.3 sudo python setup." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/77a36de4c2789b08bd4166d527bd63ea/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-27T19:19:05+08:00" />
<meta property="article:modified_time" content="2021-04-27T19:19:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">实际应用Supervisor部署Flask项目</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="1_supervisor_0"></a>1. 什么是supervisor</h4> 
<p>superviosr是一个Linux/Unix系统上的进程监控工具，他/她upervisor是一个Python开发的通用的进程管理程序，可以管理和监控Linux上面的进程，能将一个普通的命令行进程变为后台daemon，并监控进程状态，异常退出时能自动重启。不过同daemontools一样，它不能监控daemon进程。</p> 
<p>各个微服务的开发过程中，都是使用 Flask 自带的 server 来运行应用。在正式部署的时候，需要使用性能更好的专业 WSGI 容器来运行应用。所以选择superviosr，在每个服务的 app 里已经添加了使用 gevent 的 WSGIServer 来运行应用的代码。</p> 
<h4><a id="2_supervisor_5"></a>2. 为什么用supervisor</h4> 
<p><strong>使用简单</strong><br> supervisor提供了一种统一的方式来start、stop、monitor你的进程， 进程可以单独控制，也可以成组的控制。你可以在本地或者远程命令行或者web接口来配置Supervisor。<br> 在linux下的很多程序通常都是一直运行着的，一般来说都需要自己编写一个能够实现进程start/stop/restart/reload功能的脚本，然后放到/etc/init.d/下面。但这样做也有很多弊端，第一我们要为每个程序编写一个类似脚本，第二，<mark>当这个进程挂掉的时候，linux不会自动重启它的，想要自动重启的话，我们还要自己写一个监控重启脚本</mark>。<br> 而supervisor则可以完美的解决这些问题。supervisor管理进程，就是通过fork/exec的方式把这些被管理的进程，当作supervisor的子进程来启动。这样的话，我们只要在supervisor的配置文件中，把要管理的进程的可执行文件的路径写进去就OK了。第二，<mark>被管理进程作为supervisor的子进程，当子进程挂掉的时候，父进程可以准确获取子进程挂掉的信息的，所以当然也就可以对挂掉的子进程进行自动重启，当然重启还是不重启，也要看你的配置文件里面有木有设置autostart=true了</mark>。<br> supervisor通过INI格式配置文件进行配置，很容易掌握，它为每个进程提供了很多配置选项，可以使你很容易的重启进程或者自动的轮转日志。</p> 
<p><strong>集中管理</strong><br> supervisor管理的进程，进程组信息，全部都写在一个ini格式的文件里就OK了。而且，我们管理supervisor的时候的可以在本地进行管理，也可以远程管理，而且supervisor提供了一个web界面，我们可以在web界面上监控，管理进程。 当然了，本地，远程和web管理的时候，需要调用supervisor的xml_rpc接口，这个也是后话。<br> supervisor可以对进程组统一管理，也就是说咱们可以把需要管理的进程写到一个组里面，然后我们把这个组作为一个对象进行管理，如启动，停止，重启等等操作。而linux系统则是没有这种功能的，我们想要停止一个进程，只能一个一个的去停止，要么就自己写个脚本去批量停止</p> 
<h4><a id="3_supervisor_17"></a>3. supervisor组件</h4> 
<p><strong>supervisord</strong><br> 主进程,负责管理进程的server，它会根据配置文件创建指定数量的应用程序的子进程，管理子进程的整个生命周期，对crash的进程重启，对进程变化发送事件通知等。同时<strong>内置web server和XML-RPC Interface</strong>，轻松实现进程管理。。该服务的配置文件在/etc/supervisor/supervisord.conf。</p> 
<p>supervisorctl<br> 客户端的命令行工具，提供一个类似shell的操作接口，通过它你可以连接到不同的supervisord进程上来管理它们各自的子程序，命令通过UNIX socket或者TCP来和服务通讯。用户通过命令行发送消息给supervisord，可以查看进程状态，加载配置文件，启停进程，查看进程标准输出和错误输出，远程操作等。服务端也可以要求客户端提供身份验证之后才能进行操作。</p> 
<p>Web Server<br> superviosr提供了web server功能，可通过web控制进程(需要设置[inethttpserver]配置项)。</p> 
<p>XML-RPC Interface<br> XML-RPC接口， 就像HTTP提供WEB UI一样，用来控制supervisor和由它运行的程序。</p> 
<h4><a id="4__31"></a>4. 安装、配置、使用</h4> 
<p>supervisor是python编写的，可以用easy_install、pip都可以安装，比如在我的centos机器下，安装命令如下：</p> 
<pre><code class="prism language-python">yum install python<span class="token operator">-</span>setuptools
easy_install pip
pip install superviso
</code></pre> 
<p>在这里我使用pip安装之后，在创建配置文件的时候出错，所以我又选择了使用easy_install supervisor的安装方法</p> 
<p>当然也可以下载源码进行安装，比如：</p> 
<pre><code class="prism language-python"> wget https<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>python<span class="token punctuation">.</span>org<span class="token operator">/</span>packages<span class="token operator">/</span>source<span class="token operator">/</span>s<span class="token operator">/</span>supervisor<span class="token operator">/</span>supervisor<span class="token operator">-</span><span class="token number">3.1</span><span class="token number">.3</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz <span class="token operator">-</span><span class="token operator">-</span>no<span class="token operator">-</span>check<span class="token operator">-</span>certificat

tar <span class="token operator">-</span>zxvf supervisor<span class="token operator">-</span><span class="token number">3.1</span><span class="token number">.3</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
cd supervisor<span class="token operator">-</span><span class="token number">3.1</span><span class="token number">.3</span>
sudo python setup<span class="token punctuation">.</span>py install
</code></pre> 
<p>安装之后可以直接supervisord运行验证是否成功，如果报错，再逐一解决，比如可能会报meld3版本问题，这里给出安装步骤：</p> 
<pre><code class="prism language-python">wget http<span class="token punctuation">:</span><span class="token operator">//</span>effbot<span class="token punctuation">.</span>org<span class="token operator">/</span>media<span class="token operator">/</span>downloads<span class="token operator">/</span>elementtree<span class="token operator">-</span><span class="token number">1.2</span><span class="token number">.7</span><span class="token operator">-</span><span class="token number">20070827</span><span class="token operator">-</span>preview<span class="token punctuation">.</span><span class="token builtin">zip</span>
unzip elementtree<span class="token operator">-</span><span class="token number">1.2</span><span class="token number">.7</span><span class="token operator">-</span><span class="token number">20070827</span><span class="token operator">-</span>preview<span class="token punctuation">.</span><span class="token builtin">zip</span>  <span class="token operator">&amp;</span><span class="token operator">&amp;</span>  cd elementtree<span class="token operator">-</span><span class="token number">1.2</span><span class="token number">.7</span><span class="token operator">-</span><span class="token number">20070827</span><span class="token operator">-</span>preview
python setup<span class="token punctuation">.</span>py install
</code></pre> 
<p>或者下载此版本：</p> 
<pre><code class="prism language-python">wget http<span class="token punctuation">:</span><span class="token operator">//</span>www<span class="token punctuation">.</span>plope<span class="token punctuation">.</span>com<span class="token operator">/</span>software<span class="token operator">/</span>meld3<span class="token operator">/</span>meld3<span class="token operator">-</span><span class="token number">0.6</span><span class="token number">.5</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
tar <span class="token operator">-</span>xf meld3<span class="token operator">-</span><span class="token number">0.6</span><span class="token number">.5</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz <span class="token operator">&amp;</span><span class="token operator">&amp;</span> cd meld3<span class="token operator">-</span><span class="token number">0.6</span><span class="token number">.5</span>
python setup<span class="token punctuation">.</span>py install
</code></pre> 
<p>如果安装成功就可以进行下一步了：设置配置文件。<br> 在生成配置文件的时候，有时候会报错</p> 
<pre><code class="prism language-bash">Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:
  File <span class="token string">"/home/zhangweijian/.local/bin/echo_supervisord_conf"</span>, line <span class="token number">5</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>
    from supervisor.confecho <span class="token function">import</span> main
ModuleNotFoundError: No module named <span class="token string">'supervisor'</span>
</code></pre> 
<p>可以试着改 <code>vim /home/zhangweijian/.local/bin/echo_supervisord_conf</code></p> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/usr/bin/python2.7    // 其中大概率是python版本引发的错误</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token function">import</span> re
<span class="token function">import</span> sys
from supervisor.confecho <span class="token function">import</span> main
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token builtin class-name">:</span>
    sys.argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> re.sub<span class="token punctuation">(</span>r<span class="token string">'(-script\.pyw|\.exe)?$'</span>, <span class="token string">''</span>, sys.argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    sys.exit<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">))</span>

</code></pre> 
<pre><code class="prism language-powershell"><span class="token comment">### 生成配置文件，且放在/etc目录下</span>
echo_supervisord_conf &gt; <span class="token operator">/</span>etc<span class="token operator">/</span>supervisord<span class="token punctuation">.</span>conf  

<span class="token comment">###为了不将所有新增配置信息全写在一个配置文件里，这里新建一个文件夹，每个程序设置一个配置文件，相互隔离</span>
mkdir <span class="token operator">/</span>etc<span class="token operator">/</span>supervisord<span class="token punctuation">.</span>d<span class="token operator">/</span>  

<span class="token comment">### 修改配置文件</span>
vim <span class="token operator">/</span>etc<span class="token operator">/</span>supervisord<span class="token punctuation">.</span>conf

<span class="token comment">### 加入以下配置信息</span>
<span class="token namespace">[include]</span>
files = <span class="token operator">/</span>etc<span class="token operator">/</span>supervisord<span class="token punctuation">.</span>d/<span class="token operator">*</span><span class="token punctuation">.</span>conf

<span class="token comment">### 在supervisord.conf中设置通过web可以查看管理的进程，加入以下代码（默认即有，取消注释即可）    </span>
<span class="token namespace">[inet_http_server]</span> 
port=9001
username=user      
password=123
</code></pre> 
<p>实例项目中的配置</p> 
<pre><code class="prism language-lua"><span class="token punctuation">[</span>unix_http_server<span class="token punctuation">]</span>
file<span class="token operator">=</span><span class="token operator">/</span>var<span class="token operator">/</span>run<span class="token operator">/</span>supervisor<span class="token punctuation">.</span>sock   <span class="token punctuation">;</span> the path to the socket file
<span class="token punctuation">;</span>chmod<span class="token operator">=</span><span class="token number">0700</span>                 <span class="token punctuation">;</span> socket file <span class="token function">mode</span> <span class="token punctuation">(</span>default <span class="token number">0700</span><span class="token punctuation">)</span>
<span class="token punctuation">;</span>chown<span class="token operator">=</span>nobody<span class="token punctuation">:</span>nogroup       <span class="token punctuation">;</span> socket file uid<span class="token punctuation">:</span>gid owner

<span class="token operator">#</span>可以通过web 查看管理的进程
<span class="token punctuation">[</span>inet_http_server<span class="token punctuation">]</span>         <span class="token punctuation">;</span> <span class="token function">inet</span> <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span> server disabled by default
port<span class="token operator">=</span><span class="token number">10.1</span><span class="token number">.115</span><span class="token number">.29</span><span class="token punctuation">:</span><span class="token number">19001</span>        <span class="token punctuation">;</span> ip_address<span class="token punctuation">:</span>port specifier<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">:</span>port <span class="token keyword">for</span> all iface
username<span class="token operator">=</span>EB              <span class="token punctuation">;</span> default is no <span class="token function">username</span> <span class="token punctuation">(</span>open server<span class="token punctuation">)</span>
password<span class="token operator">=</span><span class="token number">82325588</span>               <span class="token punctuation">;</span> default is no <span class="token function">password</span> <span class="token punctuation">(</span>open server<span class="token punctuation">)</span>

<span class="token punctuation">[</span>supervisord<span class="token punctuation">]</span>
logfile<span class="token operator">=</span><span class="token operator">/</span>tmp<span class="token operator">/</span>supervisord<span class="token punctuation">.</span>log <span class="token punctuation">;</span> main log file<span class="token punctuation">;</span> default $CWD<span class="token operator">/</span>supervisord<span class="token punctuation">.</span>log
logfile_maxbytes<span class="token operator">=</span>50MB        <span class="token punctuation">;</span> max main logfile bytes b4 rotation<span class="token punctuation">;</span> default 50MB
logfile_backups<span class="token operator">=</span><span class="token number">10</span>           <span class="token punctuation">;</span> <span class="token operator">#</span> of main logfile backups<span class="token punctuation">;</span> <span class="token number">0</span> means none<span class="token punctuation">,</span> default <span class="token number">10</span>
loglevel<span class="token operator">=</span>info                <span class="token punctuation">;</span> log level<span class="token punctuation">;</span> default info<span class="token punctuation">;</span> others<span class="token punctuation">:</span> debug<span class="token punctuation">,</span>warn<span class="token punctuation">,</span>trace
pidfile<span class="token operator">=</span><span class="token operator">/</span>tmp<span class="token operator">/</span>supervisord<span class="token punctuation">.</span>pid <span class="token punctuation">;</span> supervisord pidfile<span class="token punctuation">;</span> default supervisord<span class="token punctuation">.</span>pid
nodaemon<span class="token operator">=</span><span class="token keyword">false</span>               <span class="token punctuation">;</span> start <span class="token keyword">in</span> foreground <span class="token keyword">if</span> <span class="token keyword">true</span><span class="token punctuation">;</span> default <span class="token keyword">false</span>
minfds<span class="token operator">=</span><span class="token number">1024</span>                  <span class="token punctuation">;</span> min<span class="token punctuation">.</span> avail startup file descriptors<span class="token punctuation">;</span> default <span class="token number">1024</span>
minprocs<span class="token operator">=</span><span class="token number">200</span>                 <span class="token punctuation">;</span> min<span class="token punctuation">.</span> avail process descriptors<span class="token punctuation">;</span>default <span class="token number">200</span>

<span class="token punctuation">[</span>rpcinterface<span class="token punctuation">:</span>supervisor<span class="token punctuation">]</span>
supervisor<span class="token punctuation">.</span>rpcinterface_factory <span class="token operator">=</span> supervisor<span class="token punctuation">.</span>rpcinterface<span class="token punctuation">:</span>make_main_rpcinterface

<span class="token punctuation">[</span>supervisorctl<span class="token punctuation">]</span>
serverurl<span class="token operator">=</span>unix<span class="token punctuation">:</span><span class="token operator">//</span><span class="token operator">/</span>var<span class="token operator">/</span>run<span class="token operator">/</span>supervisor<span class="token punctuation">.</span>sock <span class="token punctuation">;</span> use a unix<span class="token punctuation">:</span><span class="token operator">//</span> URL  <span class="token keyword">for</span> a unix socket
<span class="token punctuation">;</span>serverurl<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">9001</span> <span class="token punctuation">;</span> use an http<span class="token punctuation">:</span><span class="token operator">//</span> url to specify an inet socket

<span class="token operator">#</span> 配置信息的路径
<span class="token punctuation">[</span>include<span class="token punctuation">]</span>
files <span class="token operator">=</span> <span class="token operator">/</span>etc<span class="token operator">/</span>supervisord<span class="token punctuation">.</span>d<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf <span class="token operator">/</span>home<span class="token operator">/</span>lixiaoli<span class="token operator">/</span>meo<span class="token operator">/</span>MEO<span class="token operator">/</span>MEO<span class="token operator">/</span>configure<span class="token operator">/</span>supervisor<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf <span class="token operator">/</span>home<span class="token operator">/</span>hyf<span class="token operator">/</span>meo<span class="token operator">/</span>MEO<span class="token operator">/</span>MEO<span class="token operator">/</span>configure<span class="token operator">/</span>supervisor<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf <span class="token operator">/</span>home<span class="token operator">/</span>zhangweijian<span class="token operator">/</span>MEO<span class="token operator">/</span>meo<span class="token operator">/</span>MEO<span class="token operator">/</span>MEO<span class="token operator">/</span>configure<span class="token operator">/</span>supervisor<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf

</code></pre> 
<p>配置信息的路径：<br> <img src="https://images2.imgbox.com/c1/97/RxXLE7Ph_o.png" alt="在这里插入图片描述"><br> 配置信息内容，项目名、脚本路径、进程输入输出日志等<br> <img src="https://images2.imgbox.com/7f/c3/URJQhUYP_o.png" alt="在这里插入图片描述"><br> 启动supervisord</p> 
<pre><code class="prism language-lua"> <span class="token operator">#</span> supervisord <span class="token operator">-</span>c <span class="token operator">/</span>etc<span class="token operator">/</span>supervisord<span class="token punctuation">.</span>conf
</code></pre> 
<p>查看一下是否监听</p> 
<pre><code class="prism language-lua"><span class="token operator">#</span> <span class="token punctuation">[</span>inet_http_server<span class="token punctuation">]</span>中配置的port

 <span class="token operator">#</span> lsof <span class="token operator">-</span>i<span class="token punctuation">:</span><span class="token number">9001</span>
 COMMAND     PID USER   FD   TYPE   DEVICE SIZE<span class="token operator">/</span>OFF NODE NAME
 superviso <span class="token number">14685</span> root    4u  IPv4 <span class="token number">20155719</span>      0t0  TCP <span class="token operator">*</span><span class="token punctuation">:</span><span class="token function">etlservicemgr</span> <span class="token punctuation">(</span>LISTEN<span class="token punctuation">)</span>
</code></pre> 
<p>现在通过 http://ip:9001/ 就可以查看supervisor的web界面了(默认用户名及密码是user和123)，当然目前还没有加入任何监控的程序。</p> 
<p>下面写一个简单的python脚本，用来验证supervisor的监控效果。</p> 
<pre><code class="prism language-python"><span class="token comment">#cat /root/temp/test_http.py   ###以下即是test_http.py脚本中的代码</span>
<span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># coding=utf-8</span>
<span class="token keyword">import</span> sys  
<span class="token keyword">import</span> BaseHTTPServer  
<span class="token keyword">from</span> SimpleHTTPServer <span class="token keyword">import</span> SimpleHTTPRequestHandler  
HandlerClass <span class="token operator">=</span> SimpleHTTPRequestHandler  
ServerClass <span class="token operator">=</span> BaseHTTPServer<span class="token punctuation">.</span>HTTPServer  
Protocol <span class="token operator">=</span> <span class="token string">"HTTP/1.0"</span>  

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>  
        port <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  
    <span class="token keyword">else</span><span class="token punctuation">:</span>  
        port <span class="token operator">=</span> <span class="token number">10000</span>  

    server_address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span>  
    HandlerClass<span class="token punctuation">.</span>protocol_version <span class="token operator">=</span> Protocol  
    httpd <span class="token operator">=</span> ServerClass<span class="token punctuation">(</span>server_address<span class="token punctuation">,</span> HandlerClass<span class="token punctuation">)</span>  

    sa <span class="token operator">=</span> httpd<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>getsockname<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span> <span class="token string">"Serving HTTP on"</span><span class="token punctuation">,</span> sa<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"port"</span><span class="token punctuation">,</span> sa<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"..."</span>  
    httpd<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>增加一个配置文件，以便supervisor用来监控test_http.py程序。</p> 
<pre><code class="prism language-python"><span class="token comment">#cat /etc/supervisord.d/supervisor_test_http.conf  ### 以下即为配置文件中的内容</span>
<span class="token punctuation">[</span>program<span class="token punctuation">:</span>test_http<span class="token punctuation">]</span>
command<span class="token operator">=</span>python <span class="token operator">/</span>root<span class="token operator">/</span>temp<span class="token operator">/</span>test_http<span class="token punctuation">.</span>py <span class="token number">9999</span>    <span class="token punctuation">;</span> 被监控的进程路径
directory<span class="token operator">=</span><span class="token operator">/</span>root<span class="token operator">/</span>temp                <span class="token punctuation">;</span> 执行前要不要先cd到目录去，一般不用
priority<span class="token operator">=</span><span class="token number">1</span>                    <span class="token punctuation">;</span>数字越高，优先级越高
numprocs<span class="token operator">=</span><span class="token number">1</span>                    <span class="token punctuation">;</span> 启动几个进程
autostart<span class="token operator">=</span>true                <span class="token punctuation">;</span> 随着supervisord的启动而启动
autorestart<span class="token operator">=</span>true              <span class="token punctuation">;</span> 自动重启。。当然要选上了
startretries<span class="token operator">=</span><span class="token number">10</span>               <span class="token punctuation">;</span> 启动失败时的最多重试次数
exitcodes<span class="token operator">=</span><span class="token number">0</span>                   <span class="token punctuation">;</span> 正常退出代码（是说退出代码是这个时就不再重启了吗？待确定）
stopsignal<span class="token operator">=</span>KILL               <span class="token punctuation">;</span> 用来杀死进程的信号
stopwaitsecs<span class="token operator">=</span><span class="token number">10</span>               <span class="token punctuation">;</span> 发送SIGKILL前的等待时间
redirect_stderr<span class="token operator">=</span>true          <span class="token punctuation">;</span> 重定向stderr到stdout
</code></pre> 
<p>重新启动supervisord，或者重新加载配置文件：</p> 
<pre><code class="prism language-python">supervisorctl <span class="token builtin">reload</span>
<span class="token comment">### 或者</span>
supervisorctl <span class="token operator">-</span>c <span class="token operator">/</span>etc<span class="token operator">/</span>supervisord<span class="token punctuation">.</span>conf
</code></pre> 
<p>此时再访问http页面，就会发现test_http.py程序已经被监控了，且已经自动启动了。</p> 
<p>此时也可以访问test_http.py程序提供的http服务了，比如http://ip:9999。</p> 
<p>注意：<mark><strong>supervisor只能监控前台程序</strong>， 如果你的程序是通过fork方式实现的daemon服务，则不能用它监控</mark>，<strong>否则supervisor&gt; status 会提示：BACKOFF Exited too quickly (process log may have details)</strong>。 因此像apache、tomcat服务默认启动都是按daemon方式启动的，则不能通过supervisor直接运行启动脚本(service httpd start)，相反要通过一个包装过的启停脚本来完成，比如tomcat在supervisor下的启停脚本请参考：Controlling tomcat with supervisor或者supervisor-tomcat.conf。</p> 
<p>另外，可以将supervisor随系统启动而启动，<strong>Linux 在启动的时候会执行 /etc/rc.local 里面的脚本</strong>，所以只要在这里添加执行命令即可：</p> 
<pre><code class="prism language-python"><span class="token comment"># 如果是 Ubuntu 添加以下内容（这里要写全路径，因为此时PATH的环境变量未必设置）</span>
<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>supervisord <span class="token operator">-</span>c <span class="token operator">/</span>etc<span class="token operator">/</span>supervisord<span class="token punctuation">.</span>conf

<span class="token comment"># 如果是 Centos 添加以下内容</span>
<span class="token operator">/</span>usr<span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>supervisord <span class="token operator">-</span>c <span class="token operator">/</span>etc<span class="token operator">/</span>supervisord<span class="token punctuation">.</span>conf
</code></pre> 
<h4><a id="6_supervisor_244"></a>6. supervisor管理</h4> 
<p>supervisor的管理可以用命令行工具（supervisorctl）或者web界面管理，如果一步步按上面步骤操作，那么web管理就可以正常使用了，这里单独介绍下supervisorctl命令工具：</p> 
<pre><code class="prism language-python"><span class="token comment">### 查看supervisorctl支持的命令</span>
<span class="token comment"># supervisorctl help    </span>
default commands <span class="token punctuation">(</span><span class="token builtin">type</span> <span class="token builtin">help</span> <span class="token operator">&lt;</span>topic<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
add    exit      <span class="token builtin">open</span>  <span class="token builtin">reload</span>  restart   start   tail   
avail  fg        pid   remove  shutdown  status  update 
clear  maintail  quit  reread  signal    stop    version

<span class="token comment">### 查看当前运行的进程列表</span>
<span class="token comment"># supervisorctl status</span>
test_http                        RUNNING   pid <span class="token number">28087</span><span class="token punctuation">,</span> uptime <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">05</span><span class="token punctuation">:</span><span class="token number">17</span>
</code></pre> 
<p>其中</p> 
<ul><li>update 更新新的配置到supervisord（不会重启原来已运行的程序）</li><li>reload，载入所有配置文件，并按新的配置启动、管理所有进程（会重启原来已运行的程序）</li><li>start xxx: 启动某个进程</li><li>restart xxx: 重启某个进程</li><li>stop xxx: 停止某一个进程(xxx)，xxx为[program:theprogramname]里配置的值</li><li>stop groupworker: 重启所有属于名为groupworker这个分组的进程(start,restart同理)</li><li>stop all，停止全部进程，注：start、restart、stop都不会载入最新的配置文</li><li>reread，当一个服务由自动启动修改为手动启动时执行一下就ok<br> 注意：如果原来的程序启动时需要带上参数，那通过supervisorctl start时应该先写一个shell脚本，然后supervisorctl运行该脚本即可。</li></ul> 
<h4><a id="7_supervisor_274"></a>7. supervisor配置参数介绍</h4> 
<p>supervisord的配置文件主要由几个配置段构成，配置项以K/V格式呈现。</p> 
<p><strong>unix_http_server配置块</strong><br> 在该配置块的参数项表示的是一个监听在socket上的HTTP server，如果[unixhttpserver]块不在配置文件中或被注释，则不会启动基于socket的HTTP server。该块的参数介绍如下：</p> 
<pre><code class="prism language-python"><span class="token operator">-</span> <span class="token builtin">file</span>：一个unix domain socket的文件路径，HTTP<span class="token operator">/</span>XML<span class="token operator">-</span>RPC会监听在这上面
<span class="token operator">-</span> chmod：在启动时修改unix domain socket的mode
<span class="token operator">-</span> chown：修改socket文件的属主
<span class="token operator">-</span> username：HTTP server在认证时的用户名
<span class="token operator">-</span> password：认证密码
</code></pre> 
<p><strong>inet_http_server配置块</strong><br> 在该配置块的参数项表示的是一个监听在TCP上的HTTP server，如果[inethttpserver]块不在配置文件中或被注释，则不会启动基于TCP的HTTP server。该块的参数介绍如下：</p> 
<pre><code class="prism language-python"><span class="token operator">-</span> port：TCP监听的地址和端口<span class="token punctuation">(</span>ip<span class="token punctuation">:</span>port<span class="token punctuation">)</span>，这个地址会被HTTP<span class="token operator">/</span>XML<span class="token operator">-</span>RPC监听
<span class="token operator">-</span> username：HTTP server在认证时的用户名
<span class="token operator">-</span> password：认证密码
</code></pre> 
<p>比如：</p> 
<pre><code class="prism language-python"> <span class="token punctuation">[</span>inet_http_server<span class="token punctuation">]</span>         <span class="token punctuation">;</span> inet <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span> server disabled by default
 port<span class="token operator">=</span><span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">9001</span>          <span class="token punctuation">;</span> <span class="token punctuation">(</span>ip_address<span class="token punctuation">:</span>port specifier<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">:</span>port <span class="token keyword">for</span> <span class="token builtin">all</span> iface<span class="token punctuation">)</span>
 username<span class="token operator">=</span>user              <span class="token punctuation">;</span> <span class="token punctuation">(</span>default <span class="token keyword">is</span> no username <span class="token punctuation">(</span><span class="token builtin">open</span> server<span class="token punctuation">)</span><span class="token punctuation">)</span>
 password<span class="token operator">=</span><span class="token number">123</span>               <span class="token punctuation">;</span> <span class="token punctuation">(</span>default <span class="token keyword">is</span> no password <span class="token punctuation">(</span><span class="token builtin">open</span> server<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>表示监听在9001端口，需要使用用户名+密码的方式访问，访问地址是:http//127.0.0.1:9001。</p> 
<p><strong>supervisord配置块</strong><br> 该配置块的参数项是关于supervisord进程的全局配置项。该块的参数介绍如下：</p> 
<pre><code class="prism language-python"><span class="token operator">-</span> logfile：log文件路径
<span class="token operator">-</span> logfile_maxbytes：log文件达到多少后自动进行轮转，单位是KB、MB、GB。如果设置为<span class="token number">0</span>则表示不限制日志文件大小
<span class="token operator">-</span> logfile_backups：轮转日志备份的数量，默认是<span class="token number">10</span>，如果设置为<span class="token number">0</span>，则不备份
<span class="token operator">-</span> loglevel：error、warn、info、debug、trace、blather、critical
<span class="token operator">-</span> pidfile：pid文件路径
<span class="token operator">-</span> umask：umask值，默认<span class="token number">022</span>
<span class="token operator">-</span> nodaemon：如果设置为true，则supervisord在前台启动，而不是以守护进程启动
<span class="token operator">-</span> minfds：supervisord在成功启动前可用的最小文件描述符数量，默认<span class="token number">1024</span>
<span class="token operator">-</span> minprocs：supervisord在成功启动前可用的最小进程描述符数量，默认<span class="token number">200</span>
<span class="token operator">-</span> nocleanup：防止supervisord在启动的时候清除已经存在的子进程日志文件
<span class="token operator">-</span> childlogdir：自动启动的子进程的日志目录
<span class="token operator">-</span> user：supervisord的运行用户
<span class="token operator">-</span> directory：supervisord以守护进程运行的时候切换到这个目录
<span class="token operator">-</span> strip_ansi：消除子进程日志文件中的转义序列
<span class="token operator">-</span> environment：一个k<span class="token operator">/</span>v对的<span class="token builtin">list</span>列表
</code></pre> 
<p>该块的参数通常不需要改动就可以使用，当然也可以按需修改。</p> 
<p><strong>program配置块</strong><br> 该块就是我们要监控的程序的配置项。该配置块的头部是有固定格式的，一个关键字program，后面跟着一个冒号，接下来才是程序名。例如：[program:foo]，foo就是程序名，在使用supervisorctl来操作程序的时候，就是以foo来标明的。该块的参数介绍如下：</p> 
<pre><code class="prism language-python"><span class="token operator">-</span> command：启动程序使用的命令，可以是绝对路径或者相对路径
<span class="token operator">-</span> process_name：一个python字符串表达式，用来表示supervisor进程启动的这个的名称，默认值是<span class="token operator">%</span><span class="token punctuation">(</span>program_name<span class="token punctuation">)</span>s
<span class="token operator">-</span> numprocs：Supervisor启动这个程序的多个实例，如果numprocs<span class="token operator">&gt;</span><span class="token number">1</span>，则process_name的表达式必须包含<span class="token operator">%</span><span class="token punctuation">(</span>process_num<span class="token punctuation">)</span>s，默认是<span class="token number">1</span>
<span class="token operator">-</span> numprocs_start：一个<span class="token builtin">int</span>偏移值，当启动实例的时候用来计算numprocs的值
<span class="token operator">-</span> priority：权重，可以控制程序启动和关闭时的顺序，权重越低：越早启动，越晚关闭。默认值是<span class="token number">999</span>
<span class="token operator">-</span> autostart：如果设置为true，当supervisord启动的时候，进程会自动重启。
<span class="token operator">-</span> autorestart：值可以是false、true、unexpected。false：进程不会自动重启，unexpected：当程序退出时的退出码不是exitcodes中定义的时，进程会重启，true：进程会无条件重启当退出的时候。
<span class="token operator">-</span> startsecs：程序启动后等待多长时间后才认为程序启动成功
<span class="token operator">-</span> startretries：supervisord尝试启动一个程序时尝试的次数。默认是<span class="token number">3</span>
<span class="token operator">-</span> exitcodes：一个预期的退出返回码，默认是<span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span>。
<span class="token operator">-</span> stopsignal：当收到stop请求的时候，发送信号给程序，默认是TERM信号，也可以是 HUP<span class="token punctuation">,</span> INT<span class="token punctuation">,</span> QUIT<span class="token punctuation">,</span> KILL<span class="token punctuation">,</span> USR1<span class="token punctuation">,</span> <span class="token keyword">or</span> USR2。
<span class="token operator">-</span> stopwaitsecs：在操作系统给supervisord发送SIGCHILD信号时等待的时间
<span class="token operator">-</span> stopasgroup：如果设置为true，则会使supervisor发送停止信号到整个进程组
<span class="token operator">-</span> killasgroup：如果设置为true，则在给程序发送SIGKILL信号的时候，会发送到整个进程组，它的子进程也会受到影响。
<span class="token operator">-</span> user：如果supervisord以root运行，则会使用这个设置用户启动子程序
<span class="token operator">-</span> redirect_stderr：如果设置为true，进程则会把标准错误输出到supervisord后台的标准输出文件描述符。
<span class="token operator">-</span> stdout_logfile：把进程的标准输出写入文件中，如果stdout_logfile没有设置或者设置为AUTO，则supervisor会自动选择一个文件位置。
<span class="token operator">-</span> stdout_logfile_maxbytes：标准输出log文件达到多少后自动进行轮转，单位是KB、MB、GB。如果设置为<span class="token number">0</span>则表示不限制日志文件大小
<span class="token operator">-</span> stdout_logfile_backups：标准输出日志轮转备份的数量，默认是<span class="token number">10</span>，如果设置为<span class="token number">0</span>，则不备份
<span class="token operator">-</span> stdout_capture_maxbytes：当进程处于stderr capture mode模式的时候，写入FIFO队列的最大<span class="token builtin">bytes</span>值，单位可以是KB、MB、GB
<span class="token operator">-</span> stdout_events_enabled：如果设置为true，当进程在写它的stderr到文件描述符的时候，PROCESS_LOG_STDERR事件会被触发
<span class="token operator">-</span> stderr_logfile：把进程的错误日志输出一个文件中，除非redirect_stderr参数被设置为true
<span class="token operator">-</span> stderr_logfile_maxbytes：错误log文件达到多少后自动进行轮转，单位是KB、MB、GB。如果设置为<span class="token number">0</span>则表示不限制日志文件大小
<span class="token operator">-</span> stderr_logfile_backups：错误日志轮转备份的数量，默认是<span class="token number">10</span>，如果设置为<span class="token number">0</span>，则不备份
<span class="token operator">-</span> stderr_capture_maxbytes：当进程处于stderr capture mode模式的时候，写入FIFO队列的最大<span class="token builtin">bytes</span>值，单位可以是KB、MB、GB
<span class="token operator">-</span> stderr_events_enabled：如果设置为true，当进程在写它的stderr到文件描述符的时候，PROCESS_LOG_STDERR事件会被触发
<span class="token operator">-</span> environment：一个k<span class="token operator">/</span>v对的<span class="token builtin">list</span>列表
<span class="token operator">-</span> directory：supervisord在生成子进程的时候会切换到该目录
<span class="token operator">-</span> umask：设置进程的umask
<span class="token operator">-</span> serverurl：是否允许子进程和内部的HTTP服务通讯，如果设置为AUTO，supervisor会自动的构造一个url
</code></pre> 
<p>比如下面这个选项块就表示监控一个名叫test_http的程序：</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>program<span class="token punctuation">:</span>test_http<span class="token punctuation">]</span>
command<span class="token operator">=</span>python test_http<span class="token punctuation">.</span>py <span class="token number">10000</span>  <span class="token punctuation">;</span> 被监控的进程启动命令
directory<span class="token operator">=</span><span class="token operator">/</span>root<span class="token operator">/</span>                <span class="token punctuation">;</span> 执行前要不要先cd到目录去，一般不用
priority<span class="token operator">=</span><span class="token number">1</span>                    <span class="token punctuation">;</span>数字越高，优先级越高
numprocs<span class="token operator">=</span><span class="token number">1</span>                    <span class="token punctuation">;</span> 启动几个进程
autostart<span class="token operator">=</span>true                <span class="token punctuation">;</span> 随着supervisord的启动而启动
autorestart<span class="token operator">=</span>true              <span class="token punctuation">;</span> 自动重启。。当然要选上了
startretries<span class="token operator">=</span><span class="token number">10</span>               <span class="token punctuation">;</span> 启动失败时的最多重试次数
exitcodes<span class="token operator">=</span><span class="token number">0</span>                   <span class="token punctuation">;</span> 正常退出代码（是说退出代码是这个时就不再重启了吗？待确定）
stopsignal<span class="token operator">=</span>KILL               <span class="token punctuation">;</span> 用来杀死进程的信号
stopwaitsecs<span class="token operator">=</span><span class="token number">10</span>               <span class="token punctuation">;</span> 发送SIGKILL前的等待时间
redirect_stderr<span class="token operator">=</span>true          <span class="token punctuation">;</span> 重定向stderr到stdout
</code></pre> 
<h4><a id="8__383"></a>8. 集群管理</h4> 
<p>supervisor不支持跨机器的进程监控，一个supervisord只能监控本机上的程序，大大限制了supervisor的使用。</p> 
<p>不过由于supervisor本身支持xml-rpc，因此也有一些基于supervisor二次开发的多机器进程管理工具。比如：</p> 
<ul><li>Django-Dashvisor<br> Web-based dashboard written in Python. Requires Django 1.3 or 1.4.</li><li>Nodervisor<br> Web-based dashboard written in Node.js.</li><li>Supervisord-Monitor<br> Web-based dashboard written in PHP.</li><li>SupervisorUI<br> Another Web-based dashboard written in PHP.</li><li>cesi<a href="https://github.com/Gamegos/cesi">(详情信息)</a><br> cesi is a web interface provides manage supervizors from same interface.<br> 以上那么多，我都不会，一个个试起来也很麻烦，搞不定，除了最后一个cesi，还好懂点pyhon，勉强安装成功了。、</li></ul> 
<p>cesi具体安装说明请直接参考原<a href="https://github.com/Gamegos/cesi/blob/master/README.md">Readme</a>。这里只做一点说明：</p> 
<pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/Gamegos/cesi
<span class="token builtin class-name">cd</span> cesi <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> pack
python setup.py build
python setup.py <span class="token function">install</span>
sqlite3 /自己的路径path/userinfo.db <span class="token operator">&lt;</span> userinfo.sql
<span class="token function">cp</span> cesi.conf /etc/cesi.conf  <span class="token comment">### 自行修改cesi.conf内容，kv对，很简单</span>
<span class="token builtin class-name">cd</span> cesi <span class="token operator">&amp;&amp;</span> python web.py     <span class="token comment">### 即可启动成功</span>
</code></pre> 
<p>cesi.conf配置文件的设置：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>node:local<span class="token punctuation">]</span>                            <span class="token comment">### 设置监控的各个机器</span>
username <span class="token operator">=</span> user
password <span class="token operator">=</span> <span class="token number">123</span>
<span class="token function">host</span> <span class="token operator">=</span> <span class="token number">192.168</span>.14.8
port <span class="token operator">=</span> <span class="token number">9001</span>

<span class="token punctuation">;</span><span class="token punctuation">[</span>node:<span class="token operator">&lt;</span>node_name<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token punctuation">]</span>                    <span class="token comment">### 如果有多台机器，就依次添加</span>
<span class="token punctuation">;</span>username <span class="token operator">=</span> <span class="token operator">&lt;</span>username<span class="token operator">&gt;</span>
<span class="token punctuation">;</span>password <span class="token operator">=</span> <span class="token operator">&lt;</span>password<span class="token operator">&gt;</span>
<span class="token punctuation">;</span><span class="token function">host</span> <span class="token operator">=</span> <span class="token operator">&lt;</span>hostname<span class="token operator">&gt;</span>
<span class="token punctuation">;</span>port <span class="token operator">=</span> <span class="token operator">&lt;</span>port<span class="token operator">&gt;</span>

<span class="token punctuation">;</span><span class="token punctuation">[</span>environment:<span class="token operator">&lt;</span>environment_name<span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token punctuation">;</span>members <span class="token operator">=</span> <span class="token operator">&lt;</span>node_name<span class="token operator">&gt;</span>, <span class="token operator">&lt;</span>node_name<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>

<span class="token punctuation">[</span>cesi<span class="token punctuation">]</span>
database <span class="token operator">=</span> /root/temp/cesi/userinfo.db    <span class="token comment">### 设置db路径</span>
activity_log <span class="token operator">=</span> /root/temp/cesi/cesi.log   <span class="token comment">### 设置log路径</span>
<span class="token function">host</span> <span class="token operator">=</span> <span class="token number">0.0</span>.0.0
</code></pre> 
<p>一切顺利的话，可通过页面http://ip:5000，用户名，密码都是admin，最终的效果如下所示：</p> 
<p>cesi repo上的示例效果：</p> 
<p>Reference</p> 
<h5><a id="_449"></a>异常情况</h5> 
<p><mark><strong>其中大部分错误 都是配置文件的问题</strong></mark>，包括<strong>账户权限、脚本路径、格式</strong>等等</p> 
<ol><li>Error: Another program is already listening on a port that one of our HTTP servers is configured to use. Shut this program down first before starting supervisord.</li></ol> 
<p>For help, use /home/admin/idcp-check/virtualenv/bin/supervisord -h</p> 
<p>解决：(<a href="https://serverfault.com/questions/114477/supervisor-http-server-port-issue" rel="nofollow">参考</a>)</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> unlink /tmp/supervisor.sock
or
<span class="token function">sudo</span> unlink /var/run/supervisor.sock
</code></pre> 
<ol start="2"><li>启动不起来</li></ol> 
<p>$sudo supervisorctl<br> create_roadnet_tasks3 FATAL Exited too quickly (process log may have details)<br> 解决：（<a href="https://stackoverflow.com/questions/29421832/how-should-laravel-queues-set-up-properly-for-production-with-supervisor" rel="nofollow">参考</a>）</p> 
<p>Check if supervisor startsecs=0 #被监控程序启动时持续时间</p> 
<ol start="3"><li>启动不起来，日志提示不能用root用户启动</li></ol> 
<p>Running a worker with superuser privileges when the<br> worker accepts messages serialized with pickle is a very bad idea!</p> 
<p>If you really want to continue then you have to set the C_FORCE_ROOT<br> environment variable (but please think about this before you do).</p> 
<p>解决</p> 
<pre><code class="prism language-bash">from celery <span class="token function">import</span> Celery, platforms
app <span class="token operator">=</span> Celery<span class="token punctuation">(</span><span class="token string">'tasks'</span>, <span class="token assign-left variable">broker</span><span class="token operator">=</span><span class="token string">'amqp://myuser:
mypassword@localhost :5672/vhost'</span><span class="token punctuation">)</span>
platforms.C_FORCE_ROOT <span class="token operator">=</span> True        <span class="token comment">#加上这一行</span>
@app.task
def add<span class="token punctuation">(</span>x, y<span class="token punctuation">)</span>:
    <span class="token builtin class-name">return</span> x + y
</code></pre> 
<ol start="4"><li>启动后，用supervisorctl 查看是出现异常：</li></ol> 
<pre><code class="prism language-bash">http://127.0.0.1:9001 refused connection
</code></pre> 
<p>解决，去掉注释</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>inet_http_server<span class="token punctuation">]</span>         <span class="token punctuation">;</span> inet <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span> server disabled by default
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:9001        <span class="token punctuation">;</span> <span class="token punctuation">(</span>ip_address:port specifier, *:port <span class="token keyword">for</span> all iface<span class="token punctuation">)</span>
<span class="token comment">#username=user              ; (default is no username (open server))</span>
<span class="token comment">#password=123               ; (default is no password (open server))</span>
</code></pre> 
<p></p> 
<p><a href="https://www.cnblogs.com/kaituorensheng/p/5020793.html" rel="nofollow">WEB 管理界面操作</a><br> <a href="http://supervisord.org/introduction.html" rel="nofollow">http://supervisord.org/introduction.html</a></p> 
<p>https://www.cnblogs.com/smail-bao/p/5673434.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a0107c021cbbb8b35e9e315d6bf0723e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">微博社交登录接入出现错误码：21322 重定向地址不匹配——成功解决方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a63c466841cc1c842d28e6b8635ee8e1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">张俊林：对比学习研究进展精要</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>