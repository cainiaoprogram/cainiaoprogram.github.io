<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>从零开始搭建企业管理系统（七）：RBAC 之用户管理 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="从零开始搭建企业管理系统（七）：RBAC 之用户管理" />
<meta property="og:description" content="RBAC 之用户管理 创建表（Entity）用户表角色表权限表用户角色表关系注解@ManyToMany 角色权限表 接口开发UserControllerUserServiceUserServiceImplUserRepository 问题解决update 更新问题懒加载问题JSON 循环依赖问题 根据上一小结对表的设计，我们开始编写代码实现权限管理模块的代码。
我们直接通过编写实体映射类，让JPA自动帮我们生成一下数据库表。
创建表（Entity） 首先通过 JPA 将需要用到的5张表都建好。
先将基础实体类修改一下
@Data @MappedSuperclass @EntityListeners(AuditingEntityListener.class) @Schema(description = &#34;基础实体&#34;) public class BaseEntity { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) @Schema(description = &#34;用户ID&#34;) private Long id; @Column(columnDefinition = &#34;tinyint(1) NOT NULL COMMENT &#39;状态&#39;&#34;) @Schema(description = &#34;状态&#34;) private Integer status; @Column(columnDefinition = &#34;bit NOT NULL COMMENT &#39;0正常，1删除&#39;&#34;) @Schema(description = &#34;逻辑删除&#34;) private Boolean isDelete; @CreatedBy @Column(updatable = false, columnDefinition = &#34;varchar(32) COMMENT &#39;创建用户&#39;&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/20bc2ef648bebf9d491136dd49155b21/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-14T23:17:21+08:00" />
<meta property="article:modified_time" content="2023-12-14T23:17:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">从零开始搭建企业管理系统（七）：RBAC 之用户管理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>RBAC 之用户管理</h4> 
 <ul><li><ul><li><a href="#Entity_6" rel="nofollow">创建表（Entity）</a></li><li><ul><li><a href="#_64" rel="nofollow">用户表</a></li><li><a href="#_119" rel="nofollow">角色表</a></li><li><a href="#_155" rel="nofollow">权限表</a></li><li><a href="#_285" rel="nofollow">用户角色表</a></li><li><ul><li><a href="#_289" rel="nofollow">关系注解</a></li><li><a href="#ManyToMany_298" rel="nofollow">@ManyToMany</a></li></ul> 
    </li><li><a href="#_344" rel="nofollow">角色权限表</a></li></ul> 
   </li><li><a href="#_363" rel="nofollow">接口开发</a></li><li><ul><li><a href="#UserController_375" rel="nofollow">UserController</a></li><li><a href="#UserService_418" rel="nofollow">UserService</a></li><li><a href="#UserServiceImpl_464" rel="nofollow">UserServiceImpl</a></li><li><a href="#UserRepository_501" rel="nofollow">UserRepository</a></li></ul> 
   </li><li><a href="#_521" rel="nofollow">问题解决</a></li><li><ul><li><a href="#update__523" rel="nofollow">update 更新问题</a></li><li><a href="#_681" rel="nofollow">懒加载问题</a></li><li><a href="#JSON__702" rel="nofollow">JSON 循环依赖问题</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p>根据上一小结对表的设计，我们开始编写代码实现权限管理模块的代码。</p> 
<blockquote> 
 <p>我们直接通过编写实体映射类，让JPA自动帮我们生成一下数据库表。</p> 
</blockquote> 
<h3><a id="Entity_6"></a>创建表（Entity）</h3> 
<p>首先通过 JPA 将需要用到的5张表都建好。</p> 
<p>先将基础实体类修改一下</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@MappedSuperclass</span>
<span class="token annotation punctuation">@EntityListeners</span><span class="token punctuation">(</span><span class="token class-name">AuditingEntityListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"基础实体"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span><span class="token constant">IDENTITY</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"用户ID"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"tinyint(1) NOT NULL COMMENT '状态'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"状态"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> status<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"bit NOT NULL COMMENT '0正常，1删除'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"逻辑删除"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> isDelete<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@CreatedBy</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>updatable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> columnDefinition <span class="token operator">=</span> <span class="token string">"varchar(32) COMMENT '创建用户'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"创建用户"</span><span class="token punctuation">,</span> hidden <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> createUser<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@LastModifiedBy</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"varchar(32) COMMENT '修改用户'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"修改用户"</span><span class="token punctuation">,</span> hidden <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> updateUser<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@CreatedDate</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>updatable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> columnDefinition <span class="token operator">=</span> <span class="token string">"datetime COMMENT '创建时间'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"创建时间"</span><span class="token punctuation">,</span> hidden <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@LastModifiedDate</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"datetime COMMENT '修改时间'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"修改时间"</span><span class="token punctuation">,</span> hidden <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>将一些每个表都存在的共有属性抽离出来当作一个父类，需要这些字段的实体通过继承获得这些字段属性。</p> 
 <p><code>@MappedSuperclass</code>：标注了@MappedSuperclass的类将不是一个完整的实体类，他将不会映射到数据库表，但是他的属性都将映射到其子类的数据库字段中。</p> 
 <p><code>@Column</code>：用来标识实体类中属性与数据表中字段的对应关系。</p> 
 <p><code>updatable</code>：updatable属性表示 在使用“UPDATE”脚本插入数据时，是否需要更新该字段值。</p> 
 <p><code>columnDefinition</code>：表示创建表时，该字段创建的SQL语句，一般用于通过Entity生成表定义时使用。</p> 
</blockquote> 
<h4><a id="_64"></a>用户表</h4> 
<p>先看一下表结构：</p> 
<table><thead><tr><th>字段</th><th>类型</th><th>含义</th></tr></thead><tbody><tr><td>id</td><td>bigint(20)</td><td>主键ID</td></tr><tr><td>name</td><td>varchar(32)</td><td>用户名</td></tr><tr><td>mobile</td><td>char(11)</td><td>手机号</td></tr><tr><td>avatar</td><td>varchar(255)</td><td>头像</td></tr><tr><td>email</td><td>varchar(50)</td><td>邮箱</td></tr><tr><td>password</td><td>varchar(12)</td><td>密码</td></tr><tr><td>status</td><td>tinyint(1)</td><td>状态：0正常，1锁定</td></tr><tr><td>is_delete</td><td>bit</td><td>0删除，1未删除</td></tr><tr><td>last_login_time</td><td>datetime</td><td>最后登录时间</td></tr><tr><td>create_time</td><td>datetime</td><td>创建时间</td></tr><tr><td>create_user</td><td>varchar(32)</td><td>创建用户</td></tr><tr><td>update_time</td><td>datetime</td><td>更新时间</td></tr><tr><td>update_user</td><td>varchar(32)</td><td>更新用户</td></tr></tbody></table> 
<p>UserEntity：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"sys_user"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"用户实体"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserEntity</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>unique <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> columnDefinition <span class="token operator">=</span> <span class="token string">"varchar(32) NOT NULL COMMENT '名称'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"用户名称"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"char(11) COMMENT '手机号'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"手机号"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mobile<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"varchar(255) COMMENT '头像'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"头像"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> avatar<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"varchar(50) COMMENT '邮箱'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"用户邮箱"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"varchar(12) NOT NULL COMMENT '密码'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"用户密码"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"datetime COMMENT '最后登录时间'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"最后登录时间"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> lastLoginTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_119"></a>角色表</h4> 
<p>表结构：</p> 
<table><thead><tr><th>字段</th><th>类型</th><th>含义</th></tr></thead><tbody><tr><td>id</td><td>bigint(20)</td><td>主键ID</td></tr><tr><td>name</td><td>varchar(32)</td><td>角色名称</td></tr><tr><td>remark</td><td>varchar(255)</td><td>备注</td></tr><tr><td>status</td><td>tinyint(1)</td><td>状态</td></tr><tr><td>is_delete</td><td>bit</td><td>0删除，1未删除</td></tr><tr><td>create_time</td><td>datetime</td><td>创建时间</td></tr><tr><td>create_user</td><td>varchar(32)</td><td>创建用户</td></tr><tr><td>update_time</td><td>datetime</td><td>更新时间</td></tr><tr><td>update_user</td><td>varchar(32)</td><td>更新用户</td></tr></tbody></table> 
<p>RoleEntity：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"sys_role"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"角色实体"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoleEntity</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>unique <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> columnDefinition <span class="token operator">=</span> <span class="token string">"varchar(32) NOT NULL COMMENT '角色名称'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"角色名称"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"varchar(500) COMMENT '备注'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"备注"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> remark<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_155"></a>权限表</h4> 
<p>表结构：</p> 
<table><thead><tr><th>字段</th><th>类型</th><th>含义</th></tr></thead><tbody><tr><td>id</td><td>bigint(20)</td><td>主键ID</td></tr><tr><td>pid</td><td>bigint(20)</td><td>父菜单ID，一级菜单为0</td></tr><tr><td>name</td><td>varchar(32)</td><td>菜单名称</td></tr><tr><td>url</td><td>varchar(255)</td><td>菜单URL</td></tr><tr><td>perms</td><td>varchar(500)</td><td>授权(多个用逗号分隔，如：user:list,user:create)</td></tr><tr><td>type</td><td>tinyint(1)</td><td>类型： 0目录， 1菜单， 2按钮</td></tr><tr><td>icon</td><td>varchar(50)</td><td>菜单图标</td></tr><tr><td>sort</td><td>tinyint(2)</td><td>排序</td></tr><tr><td>status</td><td>tinyint(1)</td><td>状态</td></tr><tr><td>is_delete</td><td>bit</td><td>0删除，1未删除</td></tr><tr><td>create_time</td><td>datetime</td><td>创建时间</td></tr><tr><td>create_user</td><td>varchar(32)</td><td>创建用户</td></tr><tr><td>update_time</td><td>datetime</td><td>更新时间</td></tr><tr><td>update_user</td><td>varchar(32)</td><td>更新用户</td></tr></tbody></table> 
<p>MenuEntity：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"sys_menu"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"菜单实体"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MenuEntity</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"bigint NOT NULL COMMENT '父菜单ID'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"父菜单ID"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> pid<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>unique <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> columnDefinition <span class="token operator">=</span> <span class="token string">"varchar(32) NOT NULL COMMENT '菜单名称'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"菜单名称"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"varchar(255) COMMENT '菜单url'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"url"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"varchar(500) COMMENT '授权(多个用逗号分隔，如：user:list,user:create)'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"授权(多个用逗号分隔，如：user:list,user:create)"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> perms<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"tinyint(1) NOT NULL COMMENT '菜单类型：0目录，1菜单，2按钮'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"菜单类型：0目录，1菜单，2按钮"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Byte</span> type<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"varchar(50) COMMENT '菜单图标'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"菜单图标"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> icon<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"tinyint(2) COMMENT '排序'"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"排序"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> sort<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>编写好3个entity，启动程序查看建表是否成功。控制台打印如下建表语句，同时查看数据库，发现表创建没有问题。</p> 
<pre><code class="prism language-sql">Hibernate: 
    <span class="token keyword">create</span> <span class="token keyword">table</span> sys_menu <span class="token punctuation">(</span>
        id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
        create_time <span class="token keyword">datetime</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
        create_user <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建用户'</span><span class="token punctuation">,</span>
        is_delete <span class="token keyword">bit</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'0正常，1删除'</span><span class="token punctuation">,</span>
        <span class="token keyword">status</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'状态'</span><span class="token punctuation">,</span>
        update_time <span class="token keyword">datetime</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>
        update_user <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改用户'</span><span class="token punctuation">,</span>
        icon <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'菜单图标'</span><span class="token punctuation">,</span>
        name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'菜单名称'</span><span class="token punctuation">,</span>
        perms <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'授权(多个用逗号分隔，如：user:list,user:create)'</span><span class="token punctuation">,</span>
        pid <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'父菜单ID'</span><span class="token punctuation">,</span>
        sort <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'排序'</span><span class="token punctuation">,</span>
        <span class="token keyword">type</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'菜单类型：0目录，1菜单，2按钮'</span><span class="token punctuation">,</span>
        url <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'菜单url'</span><span class="token punctuation">,</span>
        <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>
Hibernate: 
    <span class="token keyword">create</span> <span class="token keyword">table</span> sys_role <span class="token punctuation">(</span>
        id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
        create_time <span class="token keyword">datetime</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
        create_user <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建用户'</span><span class="token punctuation">,</span>
        is_delete <span class="token keyword">bit</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'0正常，1删除'</span><span class="token punctuation">,</span>
        <span class="token keyword">status</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'状态'</span><span class="token punctuation">,</span>
        update_time <span class="token keyword">datetime</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>
        update_user <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改用户'</span><span class="token punctuation">,</span>
        name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'角色名称'</span><span class="token punctuation">,</span>
        remark <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'备注'</span><span class="token punctuation">,</span>
        <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>
Hibernate: 
    <span class="token keyword">create</span> <span class="token keyword">table</span> sys_user <span class="token punctuation">(</span>
        id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
        create_time <span class="token keyword">datetime</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
        create_user <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建用户'</span><span class="token punctuation">,</span>
        is_delete <span class="token keyword">bit</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'0正常，1删除'</span><span class="token punctuation">,</span>
        <span class="token keyword">status</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'状态'</span><span class="token punctuation">,</span>
        update_time <span class="token keyword">datetime</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>
        update_user <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改用户'</span><span class="token punctuation">,</span>
        avatar <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'头像'</span><span class="token punctuation">,</span>
        email <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'邮箱'</span><span class="token punctuation">,</span>
        last_login_time <span class="token keyword">datetime</span> <span class="token keyword">COMMENT</span> <span class="token string">'最后登录时间'</span><span class="token punctuation">,</span>
        mobile <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'手机号'</span><span class="token punctuation">,</span>
        name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'名称'</span><span class="token punctuation">,</span>
        password <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'密码'</span><span class="token punctuation">,</span>
        <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>
</code></pre> 
<p>同时还为name字段添加了索引，因为我们给name字段添加了 <code>unique=true</code> 表示name字段为唯一，jpa 会为这个字段添加索引。</p> 
<pre><code class="prism language-sql">Hibernate: 
    <span class="token keyword">alter</span> <span class="token keyword">table</span> sys_menu 
       <span class="token keyword">add</span> <span class="token keyword">constraint</span> UK_4kk1vl4bvpaho8ked9v4xkr9d <span class="token keyword">unique</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span>
       
Hibernate: 
    <span class="token keyword">alter</span> <span class="token keyword">table</span> sys_role 
       <span class="token keyword">add</span> <span class="token keyword">constraint</span> UK_bqy406dtsr7j7d6fawi1ckyn1 <span class="token keyword">unique</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span>
       
Hibernate: 
    <span class="token keyword">alter</span> <span class="token keyword">table</span> sys_user 
       <span class="token keyword">add</span> <span class="token keyword">constraint</span> UK_iic0kskryiymn15fg9bqpmw22 <span class="token keyword">unique</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_285"></a>用户角色表</h4> 
<p>使用实体映射来创建单表很好理解，但是怎么创建关联表呢，我们可以通过Spring Data JPA关系映射中对表关系定义的注解来创建表的关系。</p> 
<h5><a id="_289"></a>关系注解</h5> 
<table><thead><tr><th>注解</th><th>说</th></tr></thead><tbody><tr><td>@OneToOne</td><td>定义表之间“一对一”的关系。</td></tr><tr><td>@OneToMany</td><td>定义表之间“一对多”的关系。</td></tr><tr><td>@ManyToOne</td><td>定义表之间“多对一”的关系。</td></tr><tr><td>@ManyToMany</td><td>定义表之间“多对多”的关系。</td></tr></tbody></table> 
<h5><a id="ManyToMany_298"></a>@ManyToMany</h5> 
<p>我们之前分析了，我们的表之间的关系都是多对多的关系，所以我们使用 <code>@ManyToMany</code> 来定义表之间的关系，ManyToMany总是会使用中间关系连接表来存储关系，Jpa 会自动帮我们创建中间关联表。</p> 
<blockquote> 
 <p>@<strong>ManyToMany</strong> 注解用来定义具有多对多多重性的多值关联。</p> 
 <p>每个多对多关系都有两个方面，关系的拥有方和非拥有方。连接表（中间表）在关系的拥有方指定。</p> 
 <p>如果关联是双向的，任何一方都可以被指定为关系的拥有方。</p> 
 <p>如果关系是双向的，则关系的非拥有方必须使用 @ManyToMany 注解的 mappingBy 属性来指定拥有方的关系字段或属性。</p> 
</blockquote> 
<p>user表作为主表，在 UserEntity 中添加如下字段</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ManyToMany</span>
<span class="token annotation punctuation">@JoinTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"sys_user_role"</span><span class="token punctuation">,</span>
        joinColumns <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"user_id"</span><span class="token punctuation">,</span> referencedColumnName <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        inverseJoinColumns <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"role_id"</span><span class="token punctuation">,</span> referencedColumnName <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"用户角色"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoleEntity</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>@<strong>JoinTable</strong>：@JoinTable 注解用于关联映射，它是在关联的拥有方进行配置。使用 @JoinTable 注解将创建一个连接表，也称为“中间表”。</p> 
 <p><strong>name</strong>：中间连接表名称(sys_user_role)，默认是主表_副表（user_role）</p> 
 <p><strong>joinColumns</strong>：连接表主表外键（user_id）</p> 
 <p><strong>inverseJoinColumns</strong>：连接表副表外键(role_id)</p> 
</blockquote> 
<p>role表作为副表，需要使用@ManyToMany 注解的 mappingBy 属性来指定拥有方的关系字段或属性。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">"roles"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"角色包含的用户"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">&gt;</span></span> users<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>**mappedBy：**拥有关系的字段，单向关系不需要指定改属性；双向关系必须指定改属性的值。</p> 
</blockquote> 
<p>添加好两个字段，启动看看是否能够成功创建表，控制台打印了如下sql，没有爆出表明表已经成功。</p> 
<p><img src="https://images2.imgbox.com/26/06/dL6iqELY_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_344"></a>角色权限表</h4> 
<p>这个和用户角色表一模一样，直接上代码</p> 
<pre><code>@ManyToMany
@JoinTable(name = "sys_role_menu",
        joinColumns = {@JoinColumn(name = "role_id", referencedColumnName = "id")},
        inverseJoinColumns = {@JoinColumn(name = "menu_id", referencedColumnName = "id")})
@Schema(description = "角色菜单")
private List&lt;MenuEntity&gt; menus;
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">"menus"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"菜单包含的角色"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoleEntity</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_363"></a>接口开发</h3> 
<p>先来梳理一下我们有哪些接口需要开发，现在只有 CRUD，后面根据需求慢慢加。</p> 
<ul><li>分页查询用户</li><li>根据名称查询用户</li><li>根据ID查询用户</li><li>新增|修改用户（批量）</li><li>删除用户</li></ul> 
<p>直接上代码了，毕竟都是简单的crud，容易出错的部分拿出讲一下就好了</p> 
<h4><a id="UserController_375"></a>UserController</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Tag</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"用户管理"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/sys/user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/page"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">"分页查询"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">"根据用户ID查询用户"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">UserEntity</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/name/{name}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">"根据用户名称查询用户"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">UserEntity</span> <span class="token function">getByName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">"新增|修改用户"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">upsert</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">&gt;</span></span> users<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        userService<span class="token punctuation">.</span><span class="token function">upsert</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">"根据用户ID删除用户"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        userService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="UserService_418"></a>UserService</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 分页查询用户
     *
     * @param pageable 分页参数
     * @return Page&lt;UserEntity&gt; 分页用户
     */</span>
    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">page</span><span class="token punctuation">(</span><span class="token class-name">Pageable</span> pageable<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 根据ID查询用户
     *
     * @param id 用户ID
     * @return UserEntity 用户信息
     */</span>
    <span class="token class-name">UserEntity</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 根据名称查询用户
     *
     * @param name 用户名称
     * @return UserEntity 用户信息
     */</span>
    <span class="token class-name">UserEntity</span> <span class="token function">getByName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 保存/更新用户
     *
     * @param users 用户信息
     */</span>
    <span class="token keyword">void</span> <span class="token function">upsert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">&gt;</span></span> users<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 删除用户
     *
     * @param id 用户id
     */</span>
    <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="UserServiceImpl_464"></a>UserServiceImpl</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">page</span><span class="token punctuation">(</span><span class="token class-name">Pageable</span> pageable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>pageable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserEntity</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserEntity</span> <span class="token function">getByName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findByName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">upsert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">&gt;</span></span> users<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        userRepository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        userRepository<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="UserRepository_501"></a>UserRepository</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 根据用户名称查询用户
     * 这个相当与一个公式， findBy字段名称，jpa 就会自动实现查询，不用我们再写查询逻辑
     *
     * @param name 用户名称
     * @return 用户信息
     */</span>
    <span class="token class-name">UserEntity</span> <span class="token function">findByName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>简单的接口开发完了之后，其实还是存在了3个问题，接下来我们一一来解决。</p> 
<h3><a id="_521"></a>问题解决</h3> 
<h4><a id="update__523"></a>update 更新问题</h4> 
<p>jpa 中没有单独的 update 方案，他是通过 save 方法来进行更新的，如果 id 为空就是新增，不为空就是修改。</p> 
<p>我们先通过新增方法新增一条数据，请求数据如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"status"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"isDelete"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"金克斯"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"mobile"</span><span class="token operator">:</span> <span class="token string">"11011101111"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"avatar"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string-property property">"email"</span><span class="token operator">:</span> <span class="token string">"xm@xm.com"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"password"</span><span class="token operator">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"lastLoginTime"</span><span class="token operator">:</span> <span class="token string">"2023-12-12 12:12:12"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>然后假设我们现在想修改密码为：666666，请求体如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"password"</span><span class="token operator">:</span> <span class="token string">"666666"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>按理来说没有如何问题对吧，但是一般这个时候就有问题了，请看VCR。</p> 
<p>我们发现请求失败，返回值500，这肯定是后端报错了。</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"code"</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
  <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"系统异常，请稍后重试"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"body"</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>查看控制台日志，发现报错信息如下</p> 
<pre><code class="prism language-java"><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>SQLIntegrityConstraintViolationException</span><span class="token operator">:</span> <span class="token class-name">Column</span> 'is_delete' cannot be <span class="token keyword">null</span>
</code></pre> 
<p>说的是字段 is_delete 不能为空，这是数据库的校验，但是我们没有修改这个字段呀，继续看打印的sql</p> 
<pre><code class="prism language-sql">    <span class="token keyword">select</span>
        ue1_0<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        ue1_0<span class="token punctuation">.</span>avatar<span class="token punctuation">,</span>
        ue1_0<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>
        ue1_0<span class="token punctuation">.</span>create_user<span class="token punctuation">,</span>
        ue1_0<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
        ue1_0<span class="token punctuation">.</span>is_delete<span class="token punctuation">,</span>
        ue1_0<span class="token punctuation">.</span>last_login_time<span class="token punctuation">,</span>
        ue1_0<span class="token punctuation">.</span>mobile<span class="token punctuation">,</span>
        ue1_0<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        ue1_0<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
        ue1_0<span class="token punctuation">.</span><span class="token keyword">status</span><span class="token punctuation">,</span>
        ue1_0<span class="token punctuation">.</span>update_time<span class="token punctuation">,</span>
        ue1_0<span class="token punctuation">.</span>update_user 
    <span class="token keyword">from</span>
        sys_user ue1_0 
    <span class="token keyword">where</span>
        ue1_0<span class="token punctuation">.</span>id<span class="token operator">=</span>?


	<span class="token keyword">update</span>
        sys_user 
    <span class="token keyword">set</span>
        avatar<span class="token operator">=</span>?<span class="token punctuation">,</span>
        email<span class="token operator">=</span>?<span class="token punctuation">,</span>
        is_delete<span class="token operator">=</span>?<span class="token punctuation">,</span>
        last_login_time<span class="token operator">=</span>?<span class="token punctuation">,</span>
        mobile<span class="token operator">=</span>?<span class="token punctuation">,</span>
        name<span class="token operator">=</span>?<span class="token punctuation">,</span>
        password<span class="token operator">=</span>?<span class="token punctuation">,</span>
        <span class="token keyword">status</span><span class="token operator">=</span>?<span class="token punctuation">,</span>
        update_time<span class="token operator">=</span>?<span class="token punctuation">,</span>
        update_user<span class="token operator">=</span>? 
    <span class="token keyword">where</span>
        id<span class="token operator">=</span>?
</code></pre> 
<p>ok，答案出来了，jpa 默认更新全部字段，先从数据库查询出这条数据，然后更新全部数据，这可不行，这也太费劲了，我们需要更新我们像更新的字段就行呀，这个可以通过在实体类上添加@DynamicUpdate注解，表示动态更新查询。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@DynamicUpdate</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"sys_user"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"用户实体"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserEntity</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>
</code></pre> 
<p>重启测试一下，但是发现还是不行，还是更新了全部数据，这是因为jpa会把属性值为null也当成是修改，意思就是当我们没有传入字段时，比如此时 isDelete=null ，但是jpa以为我们要把这个 null 更新到数据库， 这个怎么解决呢，我们自己写一个工具类将属性值为null的数据过滤掉在进行 save 即可，是不是感觉很麻烦。。。</p> 
<p>编写一个 JpaUtils：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JpaUtils</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 从 src 中复制不为 null 的字段到 target
     *
     * @param src    源实体
     * @param target 目标实体
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">copyNotNullProperties</span><span class="token punctuation">(</span><span class="token class-name">Object</span> src<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token function">getNullPropertyNames</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取实体中为null的属性名称
     *
     * @param source 实体类
     * @return 需要过滤掉的属性名称
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getNullPropertyNames</span><span class="token punctuation">(</span><span class="token class-name">Object</span> source<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">BeanWrapper</span> src <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanWrapperImpl</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">getPropertyDescriptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 获取每一个属性名称</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">FeatureDescriptor</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span>
                <span class="token comment">// 过滤掉属性值不为null的字段</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>name <span class="token operator">-&gt;</span> src<span class="token punctuation">.</span><span class="token function">getPropertyValue</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            	<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>修改实现类中的upsert方法</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">upsert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">&gt;</span></span> users<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    users<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">&gt;</span></span> userEntity <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userEntity<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 修改</span>
            <span class="token class-name">JpaUtils</span><span class="token punctuation">.</span><span class="token function">copyNotNullProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> userEntity<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>userEntity<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 新增</span>
            userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ok，到此这个问题解决。</p> 
<h4><a id="_681"></a>懒加载问题</h4> 
<p>我们在查询用户时，会抛出异常</p> 
<pre><code class="prism language-java"><span class="token class-name">Resolved</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>converter<span class="token punctuation">.</span></span>HttpMessageNotWritableException</span><span class="token operator">:</span> <span class="token class-name">Could</span> not write <span class="token constant">JSON</span><span class="token operator">:</span> failed <span class="token keyword">to</span> <span class="token namespace">lazily</span> initialize a collection of role<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xm<span class="token punctuation">.</span>module<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span>UserEntity</span><span class="token punctuation">.</span>roles<span class="token operator">:</span> could not initialize proxy <span class="token operator">-</span> no <span class="token class-name">Session</span><span class="token punctuation">]</span>
</code></pre> 
<p>意思是获取 roles 的时候是懒加载的，但是懒加载失败，因为找不到session，那我们就修改为及时加载</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@JoinTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"sys_user_role"</span><span class="token punctuation">,</span>
        joinColumns <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"user_id"</span><span class="token punctuation">,</span> referencedColumnName <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        inverseJoinColumns <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"role_id"</span><span class="token punctuation">,</span> referencedColumnName <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"用户角色"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoleEntity</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>**fetch：**关联是应该延迟加载还是必须马上加载。EAGER 策略表示必须马上获取关联的实体，LAZY 策略表示用到关联对象时才去加载。默认值为 javax.persistence.FetchType.LAZY</p> 
</blockquote> 
<h4><a id="JSON__702"></a>JSON 循环依赖问题</h4> 
<p>我们先为用户关联上一个角色，然后再去查询该用户信息，会显示这个，这是因为循环依赖导致返回数据非常大，因为我们的 UserEntity 中包含了 RoleEntity，而 RoleEntity 中有包含有 UserEntity，就会导致这个问题。</p> 
<p><img src="https://images2.imgbox.com/fc/c2/m4ATVCA9_o.png" alt="在这里插入图片描述"></p> 
<p>后台报错：</p> 
<pre><code class="prism language-java"><span class="token class-name">Resolved</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>converter<span class="token punctuation">.</span></span>HttpMessageNotWritableException</span><span class="token operator">:</span> <span class="token class-name">Could</span> not write <span class="token constant">JSON</span><span class="token operator">:</span> <span class="token class-name">Infinite</span> recursion <span class="token punctuation">(</span><span class="token class-name">StackOverflowError</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> 
<p>解决方案：</p> 
<p>在副表的字段上添加<code>@JsonIgnore</code>注解，表示序列化的时候忽略这个子段。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@JsonIgnore</span>
<span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">"roles"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"角色包含的用户"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">&gt;</span></span> users<span class="token punctuation">;</span>

<span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@JoinTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"sys_role_menu"</span><span class="token punctuation">,</span>
        joinColumns <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"role_id"</span><span class="token punctuation">,</span> referencedColumnName <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        inverseJoinColumns <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"menu_id"</span><span class="token punctuation">,</span> referencedColumnName <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"角色菜单"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MenuEntity</span><span class="token punctuation">&gt;</span></span> menus<span class="token punctuation">;</span>
</code></pre> 
<p>最后解决掉这些问题，查询OK，这个JPA的坑还是有点多，如果不清楚他的原理，很容易冒出一些奇怪的问题。</p> 
<p><img src="https://images2.imgbox.com/96/2b/j62Ghg2k_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9f58bc8a00d0721a53bbca122ca185e2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">根据 csv文件 快速生成自定义 mysql 语句</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6e28a073bb8fc5b6f15e9fbaa2f9f2cd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">从零开始搭建企业管理系统（八）：Spring Data Jpa 代码生成器</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>