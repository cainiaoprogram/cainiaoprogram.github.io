<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32 ADC没有输入电压时，采集结果不为0 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32 ADC没有输入电压时，采集结果不为0" />
<meta property="og:description" content="目录 1. 问题概述2. 问题分析2.1 钳位二极管2.2 反向漏电流 3. 复用功能4. 总结 1. 问题概述 硬件焊接完成后测试程序ADC采集功能，先通过接入3.3V来看下。结果发现三个通道可以采集到0V/3.3V，而另外三个通道在没有接入3.3V时，采集结果并不为0，基本在1V以上。
2. 问题分析 6个通道都是ADC1，对于程序来说，不同通道只是设置下通道号而已，按道理不应该出现部分采集正常，部分采集异常呀？
查了不少资料手册和例程，程序配置上没有发现明显问题。翻出了一块旧电路板，正好使用了出现异常的一个ADC通道。将程序直接下载进去，发现可以采集0V/3V。
对比两块电路板的原理图，发现了差异。可以正常采集的三个通道，外部电路均进行了分压：
而出现问题，浮空时仍然采集到电压的三个通道，外部电路均为直接输入：
顺着这个角度查阅了一些资料，的确有人遇到相同的情况，普遍反应是ADC管脚不要悬空使用。
相当于一个悬浮电压，大概为3.3V的一半。
是因为里面多路开关的特性引起的，开关输入引脚悬空就是个亚稳态。
回想一下，确实以前遇到的都是先分压再接到STM32的IO，一直以为是单纯因为参考电压的限制。这次因为采集电压的压值并不高，且电流非常小，担心会采不准，所以选择了直接接到IO上。不过查看了下手册，并没有找到相关的说明：
哪位大佬看到还希望能够详细解释下！
2021.5.31更新
评论区weixin_45464719大佬给出了一种说法：
感觉是单片机内部两个钳位二极管分压引起的，因为IO口悬空，二极管反向漏电流导致IO口电压约等于供电电压的一半！
我的模电书早就卖废纸了，上网重新了解了下钳位二极管和反向漏电流。
2.1 钳位二极管 在端口配置图中，IO管脚有两个二级管：
这是两个钳位二极管，保证IO电压在Vss~VDD之间（忽略二级管的导通电压）。简单理解就是：
当IO大于VDD时，上面的二级管导通，将IO电压限制在VDD；当IO小于Vss时，下面的二级管导通，将IO电压限制在Vss。 再看下百度百科的专业解释：
2.2 反向漏电流 说完了两个二级管的钳位作用，再简单看下反向漏电流。不细说PN结电场怎么反向的了，反正就是二级管会有反向电流。耶稣来了也是！
出现问题的三个通道，IO浮空，VDD和IO之间反向漏电流，IO和Vss之间反向漏电流，最终两个二级管达到一个分压效果，IO上就有一个二分之一的VDD。
3. 复用功能 刚开始怀疑是没有成功配置成ADC功能。如下图：
第二功能有好多个，如何选择成ADC呢？程序上还真没有针对性的做过配置，查了一番：
PA5支持的三种外设（SPI1、DAC、ADC）在同一时刻只能选择一种，选择的方法是开启相应外设的时钟，并使其它外设的时钟保持关闭状态。（如何理解STM32单片机引脚的复用功能？）
但是我的程序一直使能了USART2，又开启了ADC。测试结果是可以正常作为ADC来使用的，并不需要关闭USART2的时钟。可能是因为把管脚配置成了模拟输入？
4. 总结 越来越发现，单片机程序写了不少，往往更关注业务逻辑，一些细节理解还不到位。一直以为悬空会不稳定，只是对电平输入而言，没想到模拟输入同样存在这个问题。
一位同事之前还用悬空的AD通道来做硬件随机数发生器，看来还是自己的经验不足，要继续努力呀" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a10a38c6b221f5dc17a562f83b723a6f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-28T20:09:42+08:00" />
<meta property="article:modified_time" content="2021-05-28T20:09:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32 ADC没有输入电压时，采集结果不为0</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#1__1" rel="nofollow">1. 问题概述</a></li><li><a href="#2__3" rel="nofollow">2. 问题分析</a></li><li><ul><li><a href="#21__26" rel="nofollow">2.1 钳位二极管</a></li><li><a href="#22__37" rel="nofollow">2.2 反向漏电流</a></li></ul> 
  </li><li><a href="#3__44" rel="nofollow">3. 复用功能</a></li><li><a href="#4__52" rel="nofollow">4. 总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1__1"></a>1. 问题概述</h2> 
<p>硬件焊接完成后测试程序ADC采集功能，先通过接入3.3V来看下。结果发现三个通道可以采集到0V/3.3V，而另外三个通道在没有接入3.3V时，采集结果并不为0，基本在1V以上。</p> 
<h2><a id="2__3"></a>2. 问题分析</h2> 
<p>6个通道都是ADC1，对于程序来说，不同通道只是设置下通道号而已，按道理不应该出现部分采集正常，部分采集异常呀？<br> 查了不少资料手册和例程，程序配置上没有发现明显问题。翻出了一块旧电路板，正好使用了出现异常的一个ADC通道。将程序直接下载进去，发现可以采集0V/3V。<br> 对比两块电路板的原理图，发现了差异。可以正常采集的三个通道，外部电路均进行了分压：<br> <img src="https://images2.imgbox.com/84/15/ru2wjS8O_o.png" alt="在这里插入图片描述"><br> 而出现问题，浮空时仍然采集到电压的三个通道，外部电路均为直接输入：<br> <img src="https://images2.imgbox.com/70/43/4io02GoF_o.png" alt="在这里插入图片描述"><br> 顺着这个角度查阅了一些资料，的确有人遇到相同的情况，普遍反应是ADC管脚不要悬空使用。</p> 
<blockquote> 
 <p>相当于一个悬浮电压，大概为3.3V的一半。<br> 是因为里面多路开关的特性引起的，开关输入引脚悬空就是个亚稳态。</p> 
</blockquote> 
<p>回想一下，确实以前遇到的都是先分压再接到STM32的IO，一直以为是单纯因为参考电压的限制。这次因为采集电压的压值并不高，且电流非常小，担心会采不准，所以选择了直接接到IO上。不过查看了下手册，并没有找到相关的说明：<br> <img src="https://images2.imgbox.com/da/53/Od9O96jT_o.png" alt="在这里插入图片描述"><br> <strong>哪位大佬看到还希望能够详细解释下</strong>！</p> 
<hr> 
<p>2021.5.31更新<br> 评论区weixin_45464719大佬给出了一种说法：</p> 
<blockquote> 
 <p>感觉是单片机内部两个钳位二极管分压引起的，因为IO口悬空，二极管反向漏电流导致IO口电压约等于供电电压的一半！</p> 
</blockquote> 
<p>我的模电书早就卖废纸了，上网重新了解了下钳位二极管和反向漏电流。</p> 
<h3><a id="21__26"></a>2.1 钳位二极管</h3> 
<p>在端口配置图中，IO管脚有两个二级管：<br> <img src="https://images2.imgbox.com/11/42/ye0eqoiR_o.png" alt="在这里插入图片描述"><br> 这是两个钳位二极管，保证IO电压在Vss~VDD之间（忽略二级管的导通电压）。简单理解就是：</p> 
<ul><li>当IO大于VDD时，上面的二级管导通，将IO电压限制在VDD；</li><li>当IO小于Vss时，下面的二级管导通，将IO电压限制在Vss。</li></ul> 
<p>再看下百度百科的专业解释：<br> <img src="https://images2.imgbox.com/f6/eb/ntjokCsB_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22__37"></a>2.2 反向漏电流</h3> 
<p>说完了两个二级管的钳位作用，再简单看下反向漏电流。不细说PN结电场怎么反向的了，反正就是二级管会有反向电流。耶稣来了也是！<br> 出现问题的三个通道，IO浮空，VDD和IO之间反向漏电流，IO和Vss之间反向漏电流，最终两个二级管达到一个分压效果，IO上就有一个二分之一的VDD。</p> 
<hr> 
<h2><a id="3__44"></a>3. 复用功能</h2> 
<p>刚开始怀疑是没有成功配置成ADC功能。如下图：<br> <img src="https://images2.imgbox.com/3b/12/iGrganDk_o.png" alt="在这里插入图片描述"><br> 第二功能有好多个，如何选择成ADC呢？程序上还真没有针对性的做过配置，查了一番：</p> 
<blockquote> 
 <p>PA5支持的三种外设（SPI1、DAC、ADC）在同一时刻只能选择一种，选择的方法是开启相应外设的时钟，并使其它外设的时钟保持关闭状态。（<a href="https://zhuanlan.zhihu.com/p/32346166" rel="nofollow">如何理解STM32单片机引脚的复用功能？</a>）</p> 
</blockquote> 
<p>但是我的程序一直使能了USART2，又开启了ADC。测试结果是可以正常作为ADC来使用的，并不需要关闭USART2的时钟。<strong>可能是因为把管脚配置成了模拟输入</strong>？</p> 
<h2><a id="4__52"></a>4. 总结</h2> 
<p>越来越发现，单片机程序写了不少，往往更关注业务逻辑，一些细节理解还不到位。一直以为悬空会不稳定，只是对电平输入而言，没想到模拟输入同样存在这个问题。<br> 一位同事之前还用悬空的AD通道来做硬件随机数发生器，看来还是自己的经验不足，要继续努力呀</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/51601d35362c97390e623ab02f4cc6c5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">项目经理的优势有哪些？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f5f15cb86f7f9c7a2a3d3e872028c395/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python 一个快速视频剪辑编辑神器 — Moviepy</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>