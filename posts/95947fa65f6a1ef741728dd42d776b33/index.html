<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[20190823]关于CPU成本计算2.txt - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="[20190823]关于CPU成本计算2.txt" />
<meta property="og:description" content="[20190823]关于CPU成本计算2.txt --//前几天探究CPU cost时遇到的问题,获取行成本时我的测试查询结果出现跳跃，不知道为什么，感觉有点奇怪，分析看看。 --//ITPUB原始链接已经不存在，我的日记本还有记录，现在想想当时的记录思路很乱，不过这些都是猜测的过程，以前思路混乱也是正常的。 --//顺便做一些必要补充。 1.环境: SCOTT@test01p&gt; @ ver1 PORT_STRING VERSION BANNER CON_ID -------------------- ---------- ---------------------------------------------------------------------------- ------ IBMPC/WIN_NT64-9.1.0 12.2.0.1.0 Oracle Database 12c Enterprise Edition Release 12.2.0.1.0 - 64bit Production 0 2.测试: SCOTT@test01p&gt; create table t as select rownum a1 , rownum a2 ,rownum a3 from dual connect by level&lt;=100 ; Table created. --//分析略. select &#39;explain plan set statement_id=&#39;&#39;&#39;||lpad(rownum,3,&#39;0&#39;)||&#39;&#39;&#39;&#39;||&#39; for select 1 from t where rownum&lt;=&#39;||rownum||&#39;;&#39; c80 from t; --//把以上的输出保存一个文件执行,然后执行如下: select STATEMENT_ID,CPU_COST,lead(cpu_cost ) over ( order by STATEMENT_ID ) N1,lead(cpu_cost ) over ( order by STATEMENT_ID )- cpu_cost N2 from ( select STATEMENT_ID,OPERATION, OPTIONS, COST, CPU_COST, IO_COST, TIME from plan_table where options=&#39;FULL&#39;); STATEMENT_ CPU_COST N1 N2 ---------- -------- ----- ---- 001 7271 7421 150 002 7421 7571 150 003 7571 7721 150 004 7721 7871 150 005 7871 8021 150 006 8021 8321 300 007 8321 8321 0 008 8321 8471 150 009 8471 8621 150 010 8621 8771 150 011 8771 8921 150 012 8921 9071 150 013 9071 9371 300 014 9371 9371 0 015 9371 9521 150 016 9521 9671 150 017 9671 9821 150 018 9821 9971 150 019 9971 10121 150 020 10121 10271 150 021 10271 10421 150 022 10421 10571 150 023 10571 10721 150 024 10721 10871 150 025 10871 18143 7272 026 18143 18293 150 027 18293 18593 300 028 18593 18593 0 029 18593 18743 150 030 18743 18893 150 031 18893 19043 150 032 19043 19193 150 033 19193 19343 150 034 19343 19493 150 035 19493 19643 150 036 19643 19793 150 037 19793 19943 150 038 19943 20093 150 039 20093 20243 150 040 20243 20393 150 041 20393 20543 150 042 20543 20693 150 043 20693 20843 150 044 20843 20993 150 045 20993 21143 150 046 21143 21293 150 047 21293 21443 150 048 21443 21593 150 049 21593 21743 150 050 21743 29014 7271 051 29014 29164 150 052 29164 29314 150 053 29314 29464 150 054 29464 29914 450 055 29914 29914 0 056 29914 29914 0 057 29914 30064 150 058 30064 30214 150 059 30214 30364 150 060 30364 30514 150 061 30514 30664 150 062 30664 30814 150 063 30814 30964 150 064 30964 31114 150 065 31114 31264 150 066 31264 31414 150 067 31414 31564 150 068 31564 31714 150 069 31714 31864 150 070 31864 32014 150 071 32014 32164 150 072 32164 32314 150 073 32314 32464 150 074 32464 32614 150 075 32614 39886 7272 076 39886 40036 150 077 40036 40186 150 078 40186 40336 150 079 40336 40486 150 080 40486 40636 150 081 40636 40786 150 082 40786 40936 150 083 40936 41086 150 084 41086 41236 150 085 41236 41386 150 086 41386 41536 150 087 41536 41686 150 088 41686 41836 150 089 41836 41986 150 090 41986 42136 150 091 42136 42286 150 092 42286 42436 150 093 42436 42586 150 094 42586 42736 150 095 42736 42886 150 096 42886 43036 150 097 43036 43186 150 098 43186 43486 300 099 43486 43486 0 100 43486 100 rows selected." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/95947fa65f6a1ef741728dd42d776b33/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-08-24T20:14:07+08:00" />
<meta property="article:modified_time" content="2019-08-24T20:14:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[20190823]关于CPU成本计算2.txt</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="preview-main"> 
 <p> <span style="font-family:'微软雅黑', 'Microsoft YaHei';font-size:12px;">[20190823]关于CPU成本计算2.txt <br><br>--//前几天探究CPU cost时遇到的问题,获取行成本时我的测试查询结果出现跳跃，不知道为什么，感觉有点奇怪，分析看看。 <br>--//ITPUB原始链接已经不存在，我的日记本还有记录，现在想想当时的记录思路很乱，不过这些都是猜测的过程，以前思路混乱也是正常的。 <br>--//顺便做一些必要补充。 <br><br>1.环境: <br>SCOTT@test01p&gt; @ ver1 <br>PORT_STRING          VERSION    BANNER                                                                       CON_ID <br>-------------------- ---------- ---------------------------------------------------------------------------- ------ <br>IBMPC/WIN_NT64-9.1.0 12.2.0.1.0 Oracle Database 12c Enterprise Edition Release 12.2.0.1.0 - 64bit Production      0 <br><br>2.测试: <br>SCOTT@test01p&gt; create table t as select rownum a1 , rownum a2 ,rownum a3 from dual connect by level&lt;=100 ; <br>Table created. <br><br>--//分析略. <br>select 'explain plan set statement_id='''||lpad(rownum,3,'0')||''''||' for select 1 from t where rownum&lt;='||rownum||';' c80 from t; <br>--//把以上的输出保存一个文件执行,然后执行如下: <br><br>select STATEMENT_ID,CPU_COST,lead(cpu_cost ) over ( order by STATEMENT_ID ) N1,lead(cpu_cost ) over ( order by STATEMENT_ID )- cpu_cost N2 from ( <br>select STATEMENT_ID,OPERATION, OPTIONS, COST, CPU_COST, IO_COST, TIME from plan_table where options='FULL'); <br><br>STATEMENT_ CPU_COST    N1   N2 <br>---------- -------- ----- ---- <br>001            7271  7421  150 <br>002            7421  7571  150 <br>003            7571  7721  150 <br>004            7721  7871  150 <br>005            7871  8021  150 <br>006            8021  8321  300 <br>007            8321  8321    0 <br>008            8321  8471  150 <br>009            8471  8621  150 <br>010            8621  8771  150 <br>011            8771  8921  150 <br>012            8921  9071  150 <br>013            9071  9371  300 <br>014            9371  9371    0 <br>015            9371  9521  150 <br>016            9521  9671  150 <br>017            9671  9821  150 <br>018            9821  9971  150 <br>019            9971 10121  150 <br>020           10121 10271  150 <br>021           10271 10421  150 <br>022           10421 10571  150 <br>023           10571 10721  150 <br>024           10721 10871  150 <br>025           10871 18143 7272 <br>026           18143 18293  150 <br>027           18293 18593  300 <br>028           18593 18593    0 <br>029           18593 18743  150 <br>030           18743 18893  150 <br>031           18893 19043  150 <br>032           19043 19193  150 <br>033           19193 19343  150 <br>034           19343 19493  150 <br>035           19493 19643  150 <br>036           19643 19793  150 <br>037           19793 19943  150 <br>038           19943 20093  150 <br>039           20093 20243  150 <br>040           20243 20393  150 <br>041           20393 20543  150 <br>042           20543 20693  150 <br>043           20693 20843  150 <br>044           20843 20993  150 <br>045           20993 21143  150 <br>046           21143 21293  150 <br>047           21293 21443  150 <br>048           21443 21593  150 <br>049           21593 21743  150 <br>050           21743 29014 7271 <br>051           29014 29164  150 <br>052           29164 29314  150 <br>053           29314 29464  150 <br>054           29464 29914  450 <br>055           29914 29914    0 <br>056           29914 29914    0 <br>057           29914 30064  150 <br>058           30064 30214  150 <br>059           30214 30364  150 <br>060           30364 30514  150 <br>061           30514 30664  150 <br>062           30664 30814  150 <br>063           30814 30964  150 <br>064           30964 31114  150 <br>065           31114 31264  150 <br>066           31264 31414  150 <br>067           31414 31564  150 <br>068           31564 31714  150 <br>069           31714 31864  150 <br>070           31864 32014  150 <br>071           32014 32164  150 <br>072           32164 32314  150 <br>073           32314 32464  150 <br>074           32464 32614  150 <br>075           32614 39886 7272 <br>076           39886 40036  150 <br>077           40036 40186  150 <br>078           40186 40336  150 <br>079           40336 40486  150 <br>080           40486 40636  150 <br>081           40636 40786  150 <br>082           40786 40936  150 <br>083           40936 41086  150 <br>084           41086 41236  150 <br>085           41236 41386  150 <br>086           41386 41536  150 <br>087           41536 41686  150 <br>088           41686 41836  150 <br>089           41836 41986  150 <br>090           41986 42136  150 <br>091           42136 42286  150 <br>092           42286 42436  150 <br>093           42436 42586  150 <br>094           42586 42736  150 <br>095           42736 42886  150 <br>096           42886 43036  150 <br>097           43036 43186  150 <br>098           43186 43486  300 <br>099           43486 43486    0 <br>100           43486 <br>100 rows selected. <br>--//大于7271的部分,我前面已经解析. <br>--//在STATEMENT_ID=025,050,075,N2分别是7272,7271,7272.说明在statement_id=026,051,076多访问1块。 <br>--//可以这么理解表T占4blocks,共100行，平均下来每块25行。这样当查询等于rownum&lt;=26,51,76时出现多访问1块的情况。 <br><br>--//剩下就是为什么查询条件rownum&lt;=55,rownum&lt;=56,rownum&lt;=57时CPU_COST一样的,不好理解。N2出现跳跃的情况呢? <br><br>3.继续探究: <br>SCOTT@test01p&gt; set feedback only <br>SCOTT@test01p&gt; select 1 from t where rownum&lt;=55 ; <br>         1 <br>---------- <br><br>55 rows selected. <br><br>SCOTT@test01p&gt; set feedback 6 <br>SCOTT@test01p&gt; @ dpc '' '' <br>PLAN_TABLE_OUTPUT <br>------------------------------------- <br>SQL_ID  g2r21fyyf3y90, child number 1 <br>------------------------------------- <br>select 1 from t where rownum&lt;=55 <br>Plan hash value: 508354683 <br>------------------------------------------------------------------------------------------------------------- <br>| Id  | Operation          | Name | Starts | E-Rows | Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | <br>------------------------------------------------------------------------------------------------------------- <br>|   0 | SELECT STATEMENT   |      |      1 |        |     3 (100)|          |     55 |00:00:00.01 |       6 | <br>|*  1 |  COUNT STOPKEY     |      |      1 |        |            |          |     55 |00:00:00.01 |       6 | <br>|   2 |   TABLE ACCESS FULL| T    |      1 |     57 |     3   (0)| 00:00:01 |     55 |00:00:00.01 |       6 | <br>------------------------------------------------------------------------------------------------------------- <br>Query Block Name / Object Alias (identified by operation id): <br>------------------------------------------------------------- <br>   1 - SEL$1 <br>   2 - SEL$1 / T@SEL$1 <br>Predicate Information (identified by operation id): <br>--------------------------------------------------- <br>   1 - filter(ROWNUM&lt;=55) <br>--//注意看E-Rows = 57.噢!这样明白为什么出现跳跃.是oracle估计选择率的算法非常特别造成这样的情况. <br>--//感觉oracle这样条件算法有点奇怪,什么可能查询条件rownum&lt;=55,E-Rows = 57呢? <br><br>--//看看select 1 from t where rownum&lt;=7的执行计划也可以验证: <br>SCOTT@test01p&gt; @ dpc '' '' <br>PLAN_TABLE_OUTPUT <br>------------------------------------- <br>SQL_ID  a8yj08mysamg1, child number 0 <br>------------------------------------- <br>select 1 from t where rownum&lt;=7 <br>Plan hash value: 508354683 <br>------------------------------------------------------------------------------------------------------------- <br>| Id  | Operation          | Name | Starts | E-Rows | Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | <br>------------------------------------------------------------------------------------------------------------- <br>|   0 | SELECT STATEMENT   |      |      1 |        |     2 (100)|          |      7 |00:00:00.01 |       6 | <br>|*  1 |  COUNT STOPKEY     |      |      1 |        |            |          |      7 |00:00:00.01 |       6 | <br>|   2 |   TABLE ACCESS FULL| T    |      1 |      8 |     2   (0)| 00:00:01 |      7 |00:00:00.01 |       6 | <br>------------------------------------------------------------------------------------------------------------- <br>--//E-ROWS=8.这样就明白为什么我当时的算法每行成本出现跳跃的情况.其它大家可以自行验证. <br><br>4.选择率如何计算呢? <br>--//rownun&lt;=N,这样的查询我看了&lt;基于成本的Oracle优化法则&gt;,也没有这方面的内容. <br>--//我试图按照区间的算法不对. <br>--// Selectivity =  (limit – low_value) / (high_value – low_value) + 1/num_distinct <br>--//(55-1)/(100-1)+1/100 = .55545454545454545454 , 不对,rownum虚拟列,这样的查询条件选择率如何确定不知道. <br>SCOTT@test01p&gt; set feedback only <br>SCOTT@test01p&gt; select 1 from t where a1&lt;=55 ; <br>         1 <br>---------- <br><br>55 rows selected. <br><br>SCOTT@test01p&gt; set feedback 6 <br>SCOTT@test01p&gt; @ dpc '' '' <br>PLAN_TABLE_OUTPUT <br>------------------------------------- <br>SQL_ID  4vmjyzbu16y74, child number 0 <br>------------------------------------- <br>select 1 from t where a1&lt;=55 <br><br>Plan hash value: 1601196873 <br><br>-------------------------------------------------------------------------------------------------------------------- <br>| Id  | Operation         | Name | Starts | E-Rows |E-Bytes| Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | <br>-------------------------------------------------------------------------------------------------------------------- <br>|   0 | SELECT STATEMENT  |      |      1 |        |       |     3 (100)|          |     55 |00:00:00.01 |      10 | <br>|*  1 |  TABLE ACCESS FULL| T    |      1 |     56 |   168 |     3   (0)| 00:00:01 |     55 |00:00:00.01 |      10 | <br>-------------------------------------------------------------------------------------------------------------------- <br>Query Block Name / Object Alias (identified by operation id): <br>------------------------------------------------------------- <br>   1 - SEL$1 / T@SEL$1 <br>Predicate Information (identified by operation id): <br>--------------------------------------------------- <br>   1 - filter("A1"&lt;=55) <br><br>--//如果查询select 1 from t where a1&lt;=55;E-Rows=56,按照上面公式Selectivity =  (limit – low_value) / (high_value – low_value) + 1/num_distinct <br>--//计算的结果是正确的. <br>--//仅仅知道为什么出现上面的情况,不知道条件rownum&lt;=N的选择率计算公式. <br>--//如果加大NUMROWS=&gt; 1000,就不会出现前面的情况. <br><br>SCOTT@test01p&gt; exec dbms_stats.set_table_stats(ownname=&gt; NULL,TABNAME=&gt;'T',NUMROWS=&gt; 1000); <br>PL/SQL procedure successfully completed. <br><br>SCOTT@test01p&gt; alter system flush shared_pool; <br>System altered. <br><br>--//select 'explain plan set statement_id='''||lpad(rownum,3,'0')||''''||' for select 1 from t where rownum&lt;='||rownum||';' c80 from t; <br><br>SCOTT@test01p&gt; SELECT * <br>  FROM (SELECT STATEMENT_ID,CPU_COST,lead(cpu_cost ) <br>  OVER ( ORDER BY STATEMENT_ID ) N1,lead(cpu_cost ) <br>  OVER ( ORDER BY STATEMENT_ID )- cpu_cost N2 <br>  FROM ( SELECT STATEMENT_ID, <br>       OPERATION, OPTIONS, COST, CPU_COST, IO_COST, <br>       TIME FROM plan_table WHERE options =  'FULL') ) <br> WHERE N2 &lt;&gt; 150; <br><br>no rows selected <br><br></span></p> 
 <p style="clear:both;"></p> 
 <p class="translate"> 来自 “ ITPUB博客 ” ，链接：http://blog.itpub.net/267265/viewspace-2654832/，如需转载，请注明出处，否则将追究法律责任。 </p> 
</div> 
<p>转载于:http://blog.itpub.net/267265/viewspace-2654832/</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b30b5920adfe556540e562e5aa6c869e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">faiss安装方法：anaconda安装和swig安装</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bf169fc0300a71a0a5b7d064df1674f8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在百度或者淘宝搜索时,每次输入字符串都会出现搜索建议,例如输入北京,在搜索输入框下面会以北京为前缀,展示北京爱情故事,北京公交,北京医院等搜索词,实现这类技术所采用的数据结构是什么</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>