<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>从零编写linux0.11 - 第九章 文件系统（一） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="从零编写linux0.11 - 第九章 文件系统（一）" />
<meta property="og:description" content="从零编写linux0.11 - 第九章 文件系统（一） 编程环境：Ubuntu 20.04、gcc-9.4.0
代码仓库：https://gitee.com/AprilSloan/linux0.11-project
linux0.11源码下载（不能直接编译，需进行修改）
本章目标 完成文件系统的部分功能。能够读取文件，打印输出。
1.qemu 接下来的章节将使用 qemu 模拟器运行程序。为什么使用 qemu 而不使用 bochs 呢？
1.bochs 无法看 C 语言源码。只看汇编代码调试 C 语言程序还是挺麻烦的。使用 gdb-dashboard 插件后，可以同时查看 C 语言源码、编译后的汇编代码和寄存器，十分不错，就是看内存有点麻烦。
2.bochs 运行程序出错。bochs 读取软盘扇区时会发生奇怪的错误，让我百思不得其解，同样的代码在 qemu 上却能运行。
综上，最终决定使用 qemu。不过 qemu 也有些问题，它没法调试 main 函数之前的汇编代码。
首先，我们需要安装 qemu。运行下面的指令。
sudo apt-get install gcc-multilib qemu-system-x86 接下来要修改 Makefile。
CC	=gcc CFLAGS	=-Wall -g -O -m32 -fomit-frame-pointer -fno-stack-protector -no-pie -fno-pic -Iinclude all: run Image: clean mkimg boot/bootsect.bin boot/setup.bin system objcopy -O binary -R ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ce31094ec8d8ca5c94d201fda83f43ab/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-12T16:41:34+08:00" />
<meta property="article:modified_time" content="2023-02-12T16:41:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">从零编写linux0.11 - 第九章 文件系统（一）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="linux011____0"></a>从零编写linux0.11 - 第九章 文件系统（一）</h2> 
<p>编程环境：Ubuntu 20.04、gcc-9.4.0</p> 
<p>代码仓库：https://gitee.com/AprilSloan/linux0.11-project</p> 
<p><a href="http://www.oldlinux.org/Linux.old/kernel/0.1x/linux-0.11-060618-gcc4.tar.gz" rel="nofollow">linux0.11源码下载</a>（不能直接编译，需进行修改）</p> 
<h3><a id="_8"></a>本章目标</h3> 
<p>完成文件系统的部分功能。能够读取文件，打印输出。</p> 
<h3><a id="1qemu_12"></a>1.qemu</h3> 
<p>接下来的章节将使用 qemu 模拟器运行程序。为什么使用 qemu 而不使用 bochs 呢？</p> 
<p>1.<strong>bochs 无法看 C 语言源码</strong>。只看汇编代码调试 C 语言程序还是挺麻烦的。使用 gdb-dashboard 插件后，可以同时查看 C 语言源码、编译后的汇编代码和寄存器，十分不错，就是看内存有点麻烦。</p> 
<p>2.<strong>bochs 运行程序出错</strong>。bochs 读取软盘扇区时会发生奇怪的错误，让我百思不得其解，同样的代码在 qemu 上却能运行。</p> 
<p>综上，最终决定使用 qemu。不过 qemu 也有些问题，它没法调试 main 函数之前的汇编代码。</p> 
<p>首先，我们需要安装 qemu。运行下面的指令。</p> 
<pre><code class="prism language-bash![请添加图片描述](https://img-blog.csdnimg.cn/69c46b774d494ef5a6d5936af2cc546e.jpeg)">
sudo apt-get install gcc-multilib qemu-system-x86
</code></pre> 
<p>接下来要修改 Makefile。</p> 
<pre><code class="prism language-C">CC	=gcc
CFLAGS	=-Wall -g -O -m32 -fomit-frame-pointer -fno-stack-protector -no-pie -fno-pic -Iinclude

all: run

Image: clean mkimg boot/bootsect.bin boot/setup.bin system
	objcopy -O binary -R .note -R .comment system kernel.bin
	dd if=boot/bootsect.bin of=kernel.img bs=512 count=1 conv=notrunc
	dd if=boot/setup.bin of=kernel.img bs=512 count=4 seek=1 conv=notrunc
	dd if=kernel.bin of=kernel.img bs=512 count=384 seek=5 conv=notrunc
	rm kernel.bin -f

run: Image
	qemu-system-i386 -m 32 -k en-us -rtc base=localtime -device cirrus-vga -fda kernel.img -fdb rootimage -boot a
        
debug: Image
	qemu-system-i386 -m 32 -k en-us -rtc base=localtime -device cirrus-vga -fda kernel.img -fdb rootimage -boot a -s -S

gdb:
	gdb -n -x .gdbinit
</code></pre> 
<p>根目录 Makefile 的 CFLAGS 才有<code>-O</code>选项，其他目录中的 Makefile 都删掉<code>-O</code>，尽量不优化代码。<code>-g</code>是生成调试信息，不然用 gdb 调试时无法看到 C 语言源码。<code>-no-pie -fno-pic</code>能够方便我们在 gdb 中查看局部变量。</p> 
<p>qemu-system-i386 的<code>-m 32</code>指定内存大小为 32M，<code>-k en-us</code>选择英文键盘映射方式，<code>-rtc base=localtime</code>设置虚拟 RTC 匹配本地时间，<code>-device cirrus-vga</code>定义 VGA 视频卡，<code>-fda kernel.img</code>指定操作系统在0号软盘，<code>-fdb</code>指定文件系统在1号软盘，<code>-boot a</code>设置软盘启动，<code>-s</code>指定 gdb 调试端口为1234，<code>-S</code>让 CPU 在开始时就暂停，等待调试。</p> 
<p>.gdbinit 中有 gdb 的设置和 gdb-dashboard 插件，我自己做了一些小小的修改。</p> 
<p><strong>如何运行和调试操作系统？</strong></p> 
<p>在目录中打开终端，执行<code>make</code>即可运行操作系统。运行结果如下：</p> 
<p><img src="https://images2.imgbox.com/12/65/egGA4U3q_o.jpg" alt="9.1运行"></p> 
<p>在目录中打开两个终端，一个执行<code>make debug</code>，另一个执行<code>make gdb</code>即可调试操作系统。运行结果如下：</p> 
<p><img src="https://images2.imgbox.com/dd/9e/tIhtAuLY_o.jpg" alt="调试"></p> 
<p>在右侧的终端输入<code>c</code>并回车，就会运行到 main 函数。</p> 
<p><img src="https://images2.imgbox.com/06/36/ohhZxGhL_o.jpg" alt="调试到main"></p> 
<p>在 System.map 中找到 init 的地址是 0x6532，输入并执行<code>b *0x4006532</code>和<code>c</code>就可以运行到 init 函数。请注意，如果想在某个地址打断点，要在地址前加*。为什么我们查到的地址是 0x6532，而打断点的地址是 0x4006532呢？init 函数运行在第二个进程中，第二个进程的地址空间的首地址是 0x4000000。</p> 
<p>介绍一些 qemu 的操作。鼠标点到 qemu 黑色窗口区域，鼠标会消失，按下 Ctrl+Alt 会重新显示鼠标。Ctrl+Alt+2 会切换到 qemu 的操作台，输入并执行<code>q</code>会退出 qemu（当然也可以通过点击右上的 x 关闭 qemu）。Ctrl+Alt+1 又会回到操作系统运行窗口。</p> 
<p>接下来是 gdb 的一些简单命令。</p> 
<ul><li>b + 行号/函数名/*地址：打断点</li><li>s：单步执行一条 C 语句</li><li>n：单步跳过一条 C 语句</li><li>si：单步执行一条汇编语句</li><li>ni：单步跳过一条汇编语句</li><li>l：查看 C 语言源码</li><li>c：继续执行</li><li>info b：查看断点编号</li><li>d + 断点编号：删除断点</li><li>print + 变量：查看变量值</li><li>x/5x + 地址：查看从该地址开始的5个数据</li><li>x/5i + 地址：查看从该地址开始的5条指令</li><li>q：退出调试</li></ul> 
<h3><a id="2_94"></a>2.文件系统结构介绍</h3> 
<p>这一节来讲讲文件系统的结构。现在存在着许多的操作系统，你可以用下面这条指令看看linux中支持的操作系统。</p> 
<pre><code class="prism language-bash"><span class="token function">cat</span> /proc/filesystems
</code></pre> 
<p>不同的文件系统的结构不同。接下里就介绍我们要使用的文件系统。</p> 
<p>linux0.11 的文件系统用的是 minix1.0 的文件系统（minix 也是一个操作系统）。它的结构如图所示：</p> 
<p><img src="https://images2.imgbox.com/13/e7/8lYAOl5g_o.jpg" alt="文件系统结构"></p> 
<p>可以看到 minix1.0 文件系统一共分为6部分，分别是引导块、超级块、inode 位图、逻辑块位图、inode、数据区。每个逻辑块大小为 1KB。</p> 
<p>引导块存放操作系统的 bootloader，大小为 1KB。</p> 
<p>超级块存放盘设备上文件系统的结构信息，占用 1KB 空间，其内容如下所示。虽然占用 1KB 空间，但是其实只有18个字节有用。</p> 
<pre><code class="prism language-c"><span class="token comment">// fs.h</span>
<span class="token keyword">struct</span> <span class="token class-name">d_super_block</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_ninodes<span class="token punctuation">;</span>       <span class="token comment">// inode数</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_nzones<span class="token punctuation">;</span>        <span class="token comment">// 逻辑块数</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_imap_blocks<span class="token punctuation">;</span>   <span class="token comment">// inode位图所占块数</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_zmap_blocks<span class="token punctuation">;</span>   <span class="token comment">// 逻辑块位图所占块数</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_firstdatazone<span class="token punctuation">;</span> <span class="token comment">// 数据区第一个逻辑块的块号</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_log_zone_size<span class="token punctuation">;</span> <span class="token comment">// log2(数据块数/逻辑块)</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> s_max_size<span class="token punctuation">;</span>       <span class="token comment">// 最大文件长度</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_magic<span class="token punctuation">;</span>         <span class="token comment">// 文件系统魔数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>一个 inode 与一个文件或目录相对应，记录文件或目录的信息。文件能否被读、写或执行？文件属于谁？文件有多大？文件最近什么时候被修改过？文件的数据在哪个逻辑块上？</p> 
<pre><code class="prism language-c"><span class="token comment">// fs.h</span>
<span class="token keyword">struct</span> <span class="token class-name">d_inode</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i_mode<span class="token punctuation">;</span>      <span class="token comment">// 文件的类型和属性(rwx)</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i_uid<span class="token punctuation">;</span>       <span class="token comment">// 文件所有者的用户id</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> i_size<span class="token punctuation">;</span>       <span class="token comment">// 文件长度（字节）</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> i_time<span class="token punctuation">;</span>       <span class="token comment">// 修改时间（从1970.1.1:0时算起，单位：秒）</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> i_gid<span class="token punctuation">;</span>        <span class="token comment">// 文件所有者的组id</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> i_nlinks<span class="token punctuation">;</span>     <span class="token comment">// 链接数</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i_zone<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 文件占用的逻辑块的块号</span>
                                <span class="token comment">// zone[0]-zone[6]是直接块号</span>
                                <span class="token comment">// zone[7]是一级间接块号</span>
                                <span class="token comment">// zone[8]是二级间接块号</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>inode 位图表示 inode 的使用情况。以创建文件为例，我们需要知道哪些 inode 没有被使用，将没有被使用的 inode 与新文件关联起来。位图可以很好的节省空间。</p> 
<p>一个字节有八个位，用一个位来表示一个 inode 的使用情况，这就是位图的使用方法。逻辑块位图中也是用一个位表示一个逻辑块的使用情况。</p> 
<p>数据区用来存放文件的数据。</p> 
<p>可以使用 bless 或 ghex 等工具打开 rootimage，查看里面的数据，如下所示。超级块从 0x400 开始。</p> 
<p><img src="https://images2.imgbox.com/f1/3d/Oodj6jU7_o.jpg" alt="超级块"></p> 
<p>为了提高效率，一般会把文件数据读到内存中，当不需要这些数据时，再将内存中的数据写到软盘上。我们也不会一口气将文件所有数据都读入内存，这方面的算法和缺页中断类似，需要哪个逻辑块的数据，就读取哪个逻辑块的数据。我们将文件数据保存到 buffer_head 的 b_data 成员中，b_blocknr 表示是从哪个逻辑块读取的数据。</p> 
<pre><code class="prism language-c"><span class="token comment">// fs.h</span>
<span class="token comment">// 缓冲头结构体，用于保存从逻辑块读取的数据</span>
<span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> <span class="token operator">*</span>b_data<span class="token punctuation">;</span>               <span class="token comment">// 指向数据块（1KB）的指针</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> b_blocknr<span class="token punctuation">;</span>    <span class="token comment">// 逻辑块号</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> b_dev<span class="token punctuation">;</span>       <span class="token comment">// 设备号，0-空闲</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> b_uptodate<span class="token punctuation">;</span>   <span class="token comment">// 是否更新</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> b_dirt<span class="token punctuation">;</span>       <span class="token comment">// 脏位，0-未修改，1-修改过</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> b_count<span class="token punctuation">;</span>      <span class="token comment">// 使用此结构的用户数</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> b_lock<span class="token punctuation">;</span>       <span class="token comment">// 0 - 未上锁，1 - 上锁</span>
    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>b_wait<span class="token punctuation">;</span> <span class="token comment">// 指向该缓冲区解锁的任务</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>b_prev<span class="token punctuation">;</span> <span class="token comment">// hash队列的上一块</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>b_next<span class="token punctuation">;</span> <span class="token comment">// hash队列的下一块</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>b_prev_free<span class="token punctuation">;</span>    <span class="token comment">// 空闲表上一块</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>b_next_free<span class="token punctuation">;</span>    <span class="token comment">// 空闲表下一块</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>缓冲头结构体我们在第四章就已经讲过了，不过这里要添加一个成员 b_wait，需要在 buffer_init 中进行初始化。</p> 
<p>之后我们主要围绕这三种结构体及其变体来写文件系统，这一节只是简单的介绍，详细的内容之后慢慢说明。</p> 
<p>这节最后，留给大家几个问题。</p> 
<p>1.该文件系统的数据区有多少个逻辑块？</p> 
<p>2.该文件系统中能存放一个 512MB 大小的文件吗？为什么？</p> 
<p>3.你能通过 d_inode 的 i_zone 成员计算出文件最大长度吗？</p> 
<p>4.（思考题）目录 a 中有一个文件 b，如何在文件系统中表示 a 和 b 的关系？</p> 
<h3><a id="3_191"></a>3.读取超级块</h3> 
<p>我们首先要改变设备号。0x21c 是 kernel.img 软盘的设备号，0x21d 是 rootimage 软盘的设备号 。</p> 
<pre><code class="prism language-assembly">; bootsect.s
ROOT_DEV    equ 0x21d
</code></pre> 
<p>在第八章，我们使用 ll_rw_block 函数来读取扇区，但是需要自己设置缓冲头结构体的值，不太方便。于是，又添加了一个函数，把设备号和逻辑块号作为参数传入函数。</p> 
<pre><code class="prism language-c"><span class="token comment">// buffer.c</span>
<span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span><span class="token function">bread</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> block<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh <span class="token operator">=</span> free_list<span class="token punctuation">;</span>
    bh<span class="token operator">-&gt;</span>b_dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    bh<span class="token operator">-&gt;</span>b_blocknr <span class="token operator">=</span> block<span class="token punctuation">;</span>
    <span class="token function">ll_rw_block</span><span class="token punctuation">(</span>READ<span class="token punctuation">,</span> bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">18</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%x "</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> bh<span class="token operator">-&gt;</span>b_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_uptodate<span class="token punctuation">)</span>
		<span class="token keyword">return</span> bh<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>buffer_init 中将所有缓冲头结构体串成一个循环链表，free_list 指向其中一个成员。</p> 
<p>ll_rw_block 会提交读请求，然后就是十分熟悉的流程了，执行驱动程序添加定时器，一定时间后，设置 DMA 通道，发送读命令和参数，DMA 读取数据结束后，触发中断，执行 rw_interrupt 函数，开始下一个请求或结束软盘操作。</p> 
<p>这里会出现一个问题，我们不知道 DMA 什么时候才能读完数据。在 ll_rw_block 后打印 b_data 的数据就会发现，b_data 中没有软盘的数据。因为 DMA 还没有把数据读到 b_data 中。</p> 
<p>应该要怎么解决这个问题呢？linux0.11采用的方法是，当进程发送请求后，将其睡眠。当读取结束后，在中断中唤醒睡眠的进程。</p> 
<p>缓冲头结构体中的 b_lock 就是为此而定义的。一开始，b_lock 的值为0，在提交请求的过程中，将 b_lock 的值设置为1，ll_rw_block 函数结束后，如果 b_lock 的值为1任务进入休眠。当 DMA 读取数据结束后，在 rw_interrupt 函数中将 b_lock 的值设置为0，然后唤醒任务，之后任务就可以继续执行了。</p> 
<p>具体代码如下所示。</p> 
<pre><code class="prism language-c"><span class="token comment">// buffer.c</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">cli</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_lock<span class="token punctuation">)</span>
		<span class="token function">sleep_on</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bh<span class="token operator">-&gt;</span>b_wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sti</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ll_rw_block.c</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">lock_buffer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">cli</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_lock<span class="token punctuation">)</span>
		<span class="token function">sleep_on</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bh<span class="token operator">-&gt;</span>b_wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
	bh<span class="token operator">-&gt;</span>b_lock <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">sti</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// blk.h</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">unlock_buffer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token operator">-&gt;</span>b_lock<span class="token punctuation">)</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>DEVICE_NAME <span class="token string">": free buffer being unlocked\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	bh<span class="token operator">-&gt;</span>b_lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bh<span class="token operator">-&gt;</span>b_wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">make_request</span><span class="token punctuation">(</span><span class="token keyword">int</span> major<span class="token punctuation">,</span> <span class="token keyword">int</span> rw<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>rw <span class="token operator">!=</span> READ <span class="token operator">&amp;&amp;</span> rw <span class="token operator">!=</span> WRITE<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Bad block dev command, must be R/W/RA/WA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lock_buffer</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">end_request</span><span class="token punctuation">(</span><span class="token keyword">int</span> uptodate<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">DEVICE_OFF</span><span class="token punctuation">(</span>REQUEST<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 设置驱动器电动机停止的时间</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>REQUEST<span class="token operator">-&gt;</span>bh<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        REQUEST<span class="token operator">-&gt;</span>bh<span class="token operator">-&gt;</span>b_uptodate <span class="token operator">=</span> uptodate<span class="token punctuation">;</span>
        <span class="token function">unlock_buffer</span><span class="token punctuation">(</span>REQUEST<span class="token operator">-&gt;</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>uptodate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span>DEVICE_NAME <span class="token string">" I/O error\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"dev %04x, block %d\n\r"</span><span class="token punctuation">,</span> REQUEST<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> REQUEST<span class="token operator">-&gt;</span>bh<span class="token operator">-&gt;</span>b_blocknr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wait_for_request<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 唤醒等待的任务</span>
    REQUEST<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    REQUEST <span class="token operator">=</span> REQUEST<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当我们要修改 buffer_head 的 b_data 的时候，都要在前面加上 lock_buffer，只能由当前进程修改 b_data 。当修改 b_data 完毕后，都要使用 unlock_buffer ，让所有进程都可以读写 b_data。这是同步互斥的思想。</p> 
<p>读取扇区、修改 b_data 之前都会运行 make_request 函数，读取扇区结束、修改 b_data 之后都会运行 end_request 函数。所以，要在 make_request 中调用 lock_buffer，在 end_request 中调用 unlock_buffer。</p> 
<p>bread 中调用 wait_on_buffer，等待数据同步完成（等待 DMA 将数据读取完毕）。</p> 
<p>rw_interrupt 会调用 end_request 函数，将 b_lock 设置为0，唤醒 lock_buffer 函数休眠的任务。如果读取成功，还会将 b_uptodate 设置为1，表示缓冲头中已经有数据了。</p> 
<p>end_request 函数之前并没有参数，添加了参数后需要在调用 end_request 的地方添加参数。读取出错的地方，它的参数为0。读取成功的地方，它的参数为1。此处就不列出代码了。</p> 
<pre><code class="prism language-c"><span class="token comment">// fs.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SUPER_MAGIC</span> <span class="token expression"><span class="token number">0x137F</span></span></span>

<span class="token comment">// super.c</span>
<span class="token keyword">struct</span> <span class="token class-name">d_super_block</span> ds<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">d_super_block</span> <span class="token operator">*</span><span class="token function">read_super</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">d_super_block</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token operator">&amp;</span>ds<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">;</span>
	
    bh <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">"cld"</span><span class="token operator">::</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 不加这句，结构体赋值会出错</span>
    <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">d_super_block</span> <span class="token operator">*</span><span class="token punctuation">)</span> bh<span class="token operator">-&gt;</span>b_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>s_magic <span class="token operator">!=</span> SUPER_MAGIC<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里定义了一个全局的 d_super_block 结构体变量，用来保存读取的超级块的信息。</p> 
<p>超级块的逻辑块号是1，我们用 bread 读取超级块的内容。读取成功后，使用结构体赋值方法为相应的结构体成员赋值。</p> 
<p>minix1.0 文件系统魔数为 0x137f，我们也需要检查一下读错没有。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">mount_root</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">d_super_block</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    
    p <span class="token operator">=</span> <span class="token function">read_super</span><span class="token punctuation">(</span>ROOT_DEV<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Unable to read super block"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"s_ninodes:       %x\r\n"</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>s_ninodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"s_nzones:        %x\r\n"</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>s_nzones<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"s_imap_blocks:   %x\r\n"</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>s_imap_blocks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"s_zmap_blocks:   %x\r\n"</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>s_zmap_blocks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"s_firstdatazone: %x\r\n"</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>s_firstdatazone<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"s_log_zone_size: %x\r\n"</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>s_log_zone_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"s_max_size:      %x\r\n"</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>s_max_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"s_magic:         %x\r\n"</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>s_magic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>读取超级快数据后，把数值打印出来。</p> 
<pre><code class="prism language-c"><span class="token comment">// hd.c</span>
<span class="token keyword">int</span> <span class="token function">sys_setup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> callable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>callable<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    callable <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token function">mount_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后重新写一些 sys_setup。setup 用于初始化文件系统，并且只能运行一次。这里设置了静态变量来保证只会运行一次。</p> 
<p>运行结果如下：</p> 
<p><img src="https://images2.imgbox.com/9d/a0/CLBbaZCE_o.jpg" alt="9.3运行结果"></p> 
<p>屏幕中的一排0是运行 ll_rw_block 之后从 b_data 读取的内容，此时超级块的数据还没有被读到 b_data 中。之后的输出是在运行 wait_on_buffer 之后从 b_data 读取的内容，此时数据已经从软盘读取到内存。</p> 
<p>打印的数值与 rootimage 中的数值是一样的。我们读取超级块成功了。</p> 
<p>那么这个程序有什么缺陷吗？我们可以用 bread 读取一个逻辑块，但是，如果想读取第二个逻辑块，我们会使用同一个缓冲头结构体，导致会覆盖掉之前读取的数据。这可不行，得好好处理一下。</p> 
<h3><a id="4_377"></a>4.修改文件数据缓冲</h3> 
<p>对于上一节的问题，需要一个什么样的功能来解决它呢？我们想获得一个空闲的缓冲头结构体。从哪里获得呢？从 free_list 指向的双向循环链表中获得，这个链表共有307个可使用的缓冲头结构体。一旦一个缓冲头结构体被分配出去，就将它移动到链表的末尾。</p> 
<pre><code class="prism language-c"><span class="token comment">// buffer.c</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>buffer_wait <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span><span class="token function">getblk</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> block<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">;</span>

repeat<span class="token operator">:</span>
    bh <span class="token operator">=</span> <span class="token function">get_hash_table</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token punctuation">)</span>		<span class="token comment">// 如果已经读取过这个逻辑块的数据</span>
        <span class="token keyword">return</span> bh<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>bh <span class="token operator">=</span> free_list<span class="token operator">-&gt;</span>b_next_free<span class="token punctuation">;</span> bh <span class="token operator">!=</span> free_list<span class="token punctuation">;</span> bh <span class="token operator">=</span> bh<span class="token operator">-&gt;</span>b_next_free<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_count<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>	<span class="token comment">// 如果没有可用的缓冲头结构体</span>
        <span class="token function">sleep_on</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer_wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> repeat<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    bh<span class="token operator">-&gt;</span>b_count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">// 读取一个逻辑块</span>
    bh<span class="token operator">-&gt;</span>b_dirt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">// 数据还未被修改</span>
    bh<span class="token operator">-&gt;</span>b_uptodate <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">// 还未加载数据</span>
    <span class="token function">remove_from_queues</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 从链表中移出</span>
    bh<span class="token operator">-&gt;</span>b_dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    bh<span class="token operator">-&gt;</span>b_blocknr <span class="token operator">=</span> block<span class="token punctuation">;</span>
    <span class="token function">insert_into_queues</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 插入到链表末尾</span>
    <span class="token keyword">return</span> bh<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个函数用于获得一个未被使用的缓冲头结构体，以设备号和逻辑块号为参数。我们遍历 free_list 指向的链表，寻找一个可用的缓冲头结构体，找到后，设置缓冲头结构体的成员，并将缓冲头结构体移动到链表的末尾。如果没找到可用的缓冲头结构体，就休眠当前任务，被唤醒后再次查找有无可用的缓冲头结构体。</p> 
<pre><code class="prism language-c"><span class="token comment">// buffer.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_hashfn</span><span class="token expression"><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dev <span class="token operator">^</span> block<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> NR_HASH<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">hash</span><span class="token expression"><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span> hash_table<span class="token punctuation">[</span><span class="token function">_hashfn</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">]</span></span></span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">remove_from_queues</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 将bh移出哈希链表</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_next<span class="token punctuation">)</span>
        bh<span class="token operator">-&gt;</span>b_next<span class="token operator">-&gt;</span>b_prev <span class="token operator">=</span> bh<span class="token operator">-&gt;</span>b_prev<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_prev<span class="token punctuation">)</span>
        bh<span class="token operator">-&gt;</span>b_prev<span class="token operator">-&gt;</span>b_next <span class="token operator">=</span> bh<span class="token operator">-&gt;</span>b_next<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev<span class="token punctuation">,</span> bh<span class="token operator">-&gt;</span>b_blocknr<span class="token punctuation">)</span> <span class="token operator">==</span> bh<span class="token punctuation">)</span>
        <span class="token function">hash</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev<span class="token punctuation">,</span> bh<span class="token operator">-&gt;</span>b_blocknr<span class="token punctuation">)</span> <span class="token operator">=</span> bh<span class="token operator">-&gt;</span>b_next<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_prev_free<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_next_free<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Free block list corrupted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将bh移出free_list循环链表</span>
    bh<span class="token operator">-&gt;</span>b_prev_free<span class="token operator">-&gt;</span>b_next_free <span class="token operator">=</span> bh<span class="token operator">-&gt;</span>b_next_free<span class="token punctuation">;</span>
    bh<span class="token operator">-&gt;</span>b_next_free<span class="token operator">-&gt;</span>b_prev_free <span class="token operator">=</span> bh<span class="token operator">-&gt;</span>b_prev_free<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>free_list <span class="token operator">==</span> bh<span class="token punctuation">)</span>
        free_list <span class="token operator">=</span> bh<span class="token operator">-&gt;</span>b_next_free<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">insert_into_queues</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 将bh加入到free_list循环链表的末尾（free_list为头节点）</span>
    bh<span class="token operator">-&gt;</span>b_next_free <span class="token operator">=</span> free_list<span class="token punctuation">;</span>
    bh<span class="token operator">-&gt;</span>b_prev_free <span class="token operator">=</span> free_list<span class="token operator">-&gt;</span>b_prev_free<span class="token punctuation">;</span>
    free_list<span class="token operator">-&gt;</span>b_prev_free<span class="token operator">-&gt;</span>b_next_free <span class="token operator">=</span> bh<span class="token punctuation">;</span>
    free_list<span class="token operator">-&gt;</span>b_prev_free <span class="token operator">=</span> bh<span class="token punctuation">;</span>

    bh<span class="token operator">-&gt;</span>b_prev <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    bh<span class="token operator">-&gt;</span>b_next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">// 在执行该函数前会设置b_dev的值，如果为0，说明这个设备不可用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token operator">-&gt;</span>b_dev<span class="token punctuation">)</span>	
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">// 将bh加入到哈希链表</span>
    bh<span class="token operator">-&gt;</span>b_next <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev<span class="token punctuation">,</span> bh<span class="token operator">-&gt;</span>b_blocknr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hash</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev<span class="token punctuation">,</span> bh<span class="token operator">-&gt;</span>b_blocknr<span class="token punctuation">)</span> <span class="token operator">=</span> bh<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_next<span class="token punctuation">)</span>
    	bh<span class="token operator">-&gt;</span>b_next<span class="token operator">-&gt;</span>b_prev <span class="token operator">=</span> bh<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>hash_table 是一个哈希链表，用于更快速地找到已使用缓冲头结构体。我们只需要设备号和逻辑块号就能知道这个逻辑块是否已经加载到内存中。</p> 
<p>为了方便理解，下面举一个例子。</p> 
<p><img src="https://images2.imgbox.com/70/0c/LqWMkZAl_o.jpg" alt="free_list链表变化"></p> 
<p>一开始哈希表中元素都为 NULL。当读取541号逻辑块时，找到一个可用的缓冲头结构体，将它放在链表的末尾，然后插入到哈希链表0中((0x21d ^ 0x21d) % 307 = 0)。当读取540号逻辑块时，也会把缓冲头结构体放到链表的末尾，并插入到哈希链表1中((0x21d ^ 0x21c) % 307 = 1)。</p> 
<p>假如逻辑块的数据已经被读入缓冲头结构体，我们自然不必要再读一次，只需要在哈希链表中搜索就可以了。</p> 
<pre><code class="prism language-c"><span class="token comment">// buffer.c</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span><span class="token function">find_buffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> block<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>        
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>tmp <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span> tmp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> tmp <span class="token operator">=</span> tmp<span class="token operator">-&gt;</span>b_next<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-&gt;</span>b_dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> tmp<span class="token operator">-&gt;</span>b_blocknr <span class="token operator">==</span> block<span class="token punctuation">)</span>	<span class="token comment">// 对比链表中的元素</span>
            <span class="token keyword">return</span> tmp<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span><span class="token function">get_hash_table</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> block<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        bh <span class="token operator">=</span> <span class="token function">find_buffer</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span>	<span class="token comment">// 逻辑块还没被读过</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        bh<span class="token operator">-&gt;</span>b_count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果正在读取数据，需要等待</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> bh<span class="token operator">-&gt;</span>b_blocknr <span class="token operator">==</span> block<span class="token punctuation">)</span>
            <span class="token keyword">return</span> bh<span class="token punctuation">;</span>
        bh<span class="token operator">-&gt;</span>b_count<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>b_count 表示使用此缓冲头结构体的用户数，如果为0，说明无人使用这个缓冲头结构体，里面的数据可以被其他数据覆盖掉。在读取软盘数据时 b_count 被设置为1。</p> 
<pre><code class="prism language-c"><span class="token comment">// buffer.c</span>
<span class="token keyword">void</span> <span class="token function">brelse</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buf<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>buf<span class="token operator">-&gt;</span>b_count<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Trying to free free buffer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer_wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span><span class="token function">bread</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> block<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">;</span>
    bh <span class="token operator">=</span> <span class="token function">getblk</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"bread: getblk returned NULL\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_uptodate<span class="token punctuation">)</span>
        <span class="token keyword">return</span> bh<span class="token punctuation">;</span>
    <span class="token function">ll_rw_block</span><span class="token punctuation">(</span>READ<span class="token punctuation">,</span> bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_uptodate<span class="token punctuation">)</span>
        <span class="token keyword">return</span> bh<span class="token punctuation">;</span>
	<span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 bread 函数中使用 getblk 函数获得一个可使用的缓冲头结构体，如果读取数据不成功，使用 brelse 释放掉该缓冲头结构体，如果有等待缓冲头结构体的任务，还需要唤醒该任务。</p> 
<p>每当我们不再使用缓冲头结构体的数据时，就使用 brelse 函数释放掉缓冲头结构体，这样缓冲头结构体就可以被反复使用。</p> 
<p>为了测试程序，修改了如下代码。读取两次逻辑块，缓冲头结构体的地址应该不同。</p> 
<pre><code class="prism language-c"><span class="token comment">// super.c</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">d_super_block</span> <span class="token operator">*</span><span class="token function">read_super</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">d_super_block</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token operator">&amp;</span>ds<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">,</span> <span class="token operator">*</span>bh1<span class="token punctuation">;</span>
    
    bh <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    bh1 <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh1<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"bh: %x, bh1: %x\n\r"</span><span class="token punctuation">,</span> bh<span class="token punctuation">,</span> bh1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">"cld"</span><span class="token operator">::</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 不加这句，结构体赋值会出错</span>
    <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">d_super_block</span> <span class="token operator">*</span><span class="token punctuation">)</span> bh<span class="token operator">-&gt;</span>b_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>s_magic <span class="token operator">!=</span> SUPER_MAGIC<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/cc/69/e0Ny4Urr_o.jpg" alt="9.4运行结果"></p> 
<p>代码运行起来并没有问题。你也可以读同一个逻辑块，看 b_count 是否发生了变化。</p> 
<p>最后，提出一个问题：缓冲头结构体中 b_uptodate、b_count 和 b_lock 的作用分别是什么？</p> 
<h3><a id="5inode_562"></a>5.获得根目录inode</h3> 
<p>在读取根目录 inode 之前，我们还需要对超级块做一些修改。</p> 
<p>系统中可能存在多个含有文件系统的软盘，我们需要把这些软盘的超级块都读取到内存中，为了区分超级块属于哪个软盘，我们需要向超级块结构体中添加一个成员——设备号。</p> 
<pre><code class="prism language-c"><span class="token comment">// fs.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NR_SUPER</span> <span class="token expression"><span class="token number">8</span></span></span>
<span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_ninodes<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_nzones<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_imap_blocks<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_zmap_blocks<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_firstdatazone<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_log_zone_size<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> s_max_size<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_magic<span class="token punctuation">;</span>
<span class="token comment">/* These are only in memory */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> reserved<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_dev<span class="token punctuation">;</span>           <span class="token comment">// 设备号</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// super.c</span>
<span class="token keyword">struct</span> <span class="token class-name">super_block</span> super_block<span class="token punctuation">[</span>NR_SUPER<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>并不是直接向 d_super_block 中添加成员，而是重新定义了一个结构体，因为我们还需要用 d_super_block 来进行赋值。在汇编中结构体赋值是以4字节为单位进行的，不加 reserved 的话，会导致赋值后 s_dev 的值变为0。（调试了好久才发现了这个 bug）</p> 
<p>另外还定义了一个 super_block 结构体数组，用于记录软盘的超级块信息。</p> 
<p>添加了上面的代码，我们需要修改一下 read_super 函数的代码。</p> 
<pre><code class="prism language-c"><span class="token comment">// fs.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NR_SUPER</span> <span class="token expression"><span class="token number">8</span></span></span>

<span class="token comment">// super.c</span>
<span class="token keyword">struct</span> <span class="token class-name">super_block</span> super_block<span class="token punctuation">[</span>NR_SUPER<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span><span class="token function">read_super</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>s<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    s <span class="token operator">=</span> <span class="token function">get_super</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span>  <span class="token comment">// 如果超级块信息已经被读入内存</span>
        <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> super_block<span class="token punctuation">;</span> <span class="token punctuation">;</span> s<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;=</span> NR_SUPER <span class="token operator">+</span> super_block<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token comment">// 如果没有空闲的超级块结构体</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token operator">-&gt;</span>s_dev<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    s<span class="token operator">-&gt;</span>s_dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    bh <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        s<span class="token operator">-&gt;</span>s_dev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">"cld"</span><span class="token operator">::</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 不加这句，结构体赋值会出错</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">d_super_block</span> <span class="token operator">*</span><span class="token punctuation">)</span>s <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">d_super_block</span> <span class="token operator">*</span><span class="token punctuation">)</span>bh<span class="token operator">-&gt;</span>b_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>s_magic <span class="token operator">!=</span> SUPER_MAGIC<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    <span class="token comment">// 超级块的数据有问题</span>
        s<span class="token operator">-&gt;</span>s_dev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>get_super 通过设备号查找超级块信息，如果该设备的超级块还未被读入，就返回 NULL；否则，返回超级块的指针。</p> 
<p>如果设备的超级块还未被读入，我们需要找到一个空闲的超级块，将超级块信息读入内存，然后对相应的超级块结构体成员赋值。当然，我们需要检查超级块的魔数，如果魔数不对，说明文件系统出问题了。最后将这个超级块返回。</p> 
<pre><code class="prism language-c"><span class="token comment">// super.c</span>
<span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span><span class="token function">get_super</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>s<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    s <span class="token operator">=</span> super_block<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>s <span class="token operator">&lt;</span> NR_SUPER <span class="token operator">+</span> super_block<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>s_dev <span class="token operator">==</span> dev<span class="token punctuation">)</span>
            <span class="token keyword">return</span> s<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            s<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>get_super 的代码很简单，就是遍历超级块数组，找到一个和参数相同设备号的超级块。没找到就返回 NULL。</p> 
<p>接下来讲讲与 inode 相关的内容。</p> 
<p>我们读取 inode，需要知道它来自哪个设备，节点号是多少，于是也需要向 inode 结构体中添加成员。</p> 
<pre><code class="prism language-c"><span class="token comment">// fs.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NR_INODE</span> <span class="token expression"><span class="token number">32</span></span></span>
<span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i_mode<span class="token punctuation">;</span>      <span class="token comment">// 文件的类型和属性(rwx)</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i_uid<span class="token punctuation">;</span>       <span class="token comment">// 文件所有者的用户id</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> i_size<span class="token punctuation">;</span>       <span class="token comment">// 文件长度（字节）</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> i_mtime<span class="token punctuation">;</span>      <span class="token comment">// 修改时间（从1970.1.1:0时算起，单位：秒）</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> i_gid<span class="token punctuation">;</span>        <span class="token comment">// 文件所有者的组id</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> i_nlinks<span class="token punctuation">;</span>     <span class="token comment">// 链接数</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i_zone<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 文件占用的逻辑块的块号</span>
                                <span class="token comment">// zone[0]-zone[6]是直接块号</span>
                                <span class="token comment">// zone[7]是一次间接块号</span>
                                <span class="token comment">// zone[8]是二次间接块号</span>
<span class="token comment">/* these are in memory also */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i_dev<span class="token punctuation">;</span>   	<span class="token comment">// 设备号</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i_num<span class="token punctuation">;</span>   	<span class="token comment">// inode号</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// inode.c</span>
<span class="token keyword">struct</span> <span class="token class-name">m_inode</span> inode_table<span class="token punctuation">[</span>NR_INODE<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>同样，我们需要定义一个 inode 数组保存读取的 inode，方便我们在之后的操作中使用。</p> 
<pre><code class="prism language-c"><span class="token comment">// fs.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NR_INODE</span> <span class="token expression"><span class="token number">32</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INODES_PER_BLOCK</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>BLOCK_SIZE<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">d_inode</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token comment">// inode.c</span>
<span class="token keyword">struct</span> <span class="token class-name">m_inode</span> inode_table<span class="token punctuation">[</span>NR_INODE<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span><span class="token function">iget</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> nr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>inode<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"iget with dev == 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    inode <span class="token operator">=</span> inode_table<span class="token punctuation">;</span>
    inode<span class="token operator">-&gt;</span>i_dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    inode<span class="token operator">-&gt;</span>i_num <span class="token operator">=</span> nr<span class="token punctuation">;</span>
    <span class="token function">read_inode</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> inode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">read_inode</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>inode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>sb<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">;</span>
    <span class="token keyword">int</span> block<span class="token punctuation">;</span>

    sb <span class="token operator">=</span> <span class="token function">get_super</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    block <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">+</span> sb<span class="token operator">-&gt;</span>s_imap_blocks <span class="token operator">+</span> sb<span class="token operator">-&gt;</span>s_zmap_blocks <span class="token operator">+</span> <span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> INODES_PER_BLOCK<span class="token punctuation">;</span>  <span class="token comment">// 计算inode所在的逻辑块</span>
    bh <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"unable to read i-node block"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">"cld"</span><span class="token operator">::</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">d_inode</span> <span class="token operator">*</span><span class="token punctuation">)</span>inode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">d_inode</span> <span class="token operator">*</span><span class="token punctuation">)</span>bh<span class="token operator">-&gt;</span>b_data<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> INODES_PER_BLOCK<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>系统中第一个 inode 对应于根目录，它的 inode 号是1。</p> 
<p>iget 的代码写得比较简单，直接粗暴地分配了一个 inode 结构体。如果再次调用 iget 函数，就会将之前的信息覆盖掉。这个 bug 等下一节在修改吧。</p> 
<p>read_inode 用于读取 inode。之前讲过，minix1.0 文件系统分为6个部分：引导区，超级块，inode 位图，逻辑块位图，inode，数据区。引导区和超级块共占用2个逻辑块，s_imap_blocks 代表 inode 位图占用的逻辑块数量，s_zmap_blocks 代表逻辑块位图占用的逻辑块数量，最后再通过 inode 号计算出 inode 所在的逻辑块。INODES_PER_BLOCK 代表一个逻辑块中 inode 的个数。</p> 
<p>将逻辑块读入内存，对 inode 成员进行赋值。由于之后不再使用 bh，所以最后要释放它。</p> 
<p>最后，我们要读出根目录的 inode。</p> 
<pre><code class="prism language-c"><span class="token comment">// super.c</span>
<span class="token keyword">void</span> <span class="token function">mount_root</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>mi<span class="token punctuation">;</span>
    
    p <span class="token operator">=</span> <span class="token function">read_super</span><span class="token punctuation">(</span>ROOT_DEV<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Unable to mount root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mi <span class="token operator">=</span> <span class="token function">iget</span><span class="token punctuation">(</span>ROOT_DEV<span class="token punctuation">,</span> ROOT_INO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mi<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Unable to read root i-node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"i_mode:     %x\r\n"</span><span class="token punctuation">,</span> mi<span class="token operator">-&gt;</span>i_mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"i_uid:      %x\r\n"</span><span class="token punctuation">,</span> mi<span class="token operator">-&gt;</span>i_uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"i_size:     %x\r\n"</span><span class="token punctuation">,</span> mi<span class="token operator">-&gt;</span>i_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"i_mtime:    %x\r\n"</span><span class="token punctuation">,</span> mi<span class="token operator">-&gt;</span>i_mtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"i_gid:      %x\r\n"</span><span class="token punctuation">,</span> mi<span class="token operator">-&gt;</span>i_gid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"i_nlinks:   %x\r\n"</span><span class="token punctuation">,</span> mi<span class="token operator">-&gt;</span>i_nlinks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>来看看运行结果吧。</p> 
<p><img src="https://images2.imgbox.com/66/72/uH3WUeuw_o.jpg" alt="9.5运行结果"></p> 
<h3><a id="6_762"></a>6.读取文件系统信息</h3> 
<p>如果想要创建文件，需要知道哪些 inode 和逻辑块没有被使用，那么如何知道呢？通过 inode 位图和逻辑块位图。我们需要将这些数据从磁盘读取到内存中。</p> 
<p>为了在之后的代码中使用位图，我们将相关的结构放在超级块结构体中。这样就可以通过超级块知道软盘的 inode 和逻辑块的使用情况。</p> 
<pre><code class="prism language-c"><span class="token comment">// fs.h</span>
<span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_ninodes<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_nzones<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_imap_blocks<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_zmap_blocks<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_firstdatazone<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_log_zone_size<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> s_max_size<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_magic<span class="token punctuation">;</span>
<span class="token comment">/* These are only in memory */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> reserved<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>s_imap<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// inode位图</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>s_zmap<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 逻辑块位图</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> s_dev<span class="token punctuation">;</span>           <span class="token comment">// 设备号</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>接下来是读取 inode 位图和逻辑块位图的代码。</p> 
<pre><code class="prism language-c"><span class="token comment">// fs.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I_MAP_SLOTS</span> <span class="token expression"><span class="token number">8</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Z_MAP_SLOTS</span> <span class="token expression"><span class="token number">8</span></span></span>

<span class="token comment">// super.c</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span><span class="token function">read_super</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>s<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> block<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> I_MAP_SLOTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        s<span class="token operator">-&gt;</span>s_imap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Z_MAP_SLOTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        s<span class="token operator">-&gt;</span>s_zmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    block <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 2号逻辑块是inode位图</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> s<span class="token operator">-&gt;</span>s_imap_blocks<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">// 读取inode位图</span>
        s<span class="token operator">-&gt;</span>s_imap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>s_imap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            block<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> s<span class="token operator">-&gt;</span>s_zmap_blocks<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    <span class="token comment">// 读取逻辑块位图</span>
        s<span class="token operator">-&gt;</span>s_zmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>s_zmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            block<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">!=</span> <span class="token number">2</span> <span class="token operator">+</span> s<span class="token operator">-&gt;</span>s_imap_blocks <span class="token operator">+</span> s<span class="token operator">-&gt;</span>s_zmap_blocks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果读取的数量出现问题，将读取的数据释放掉</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> I_MAP_SLOTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">brelse</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>s_imap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Z_MAP_SLOTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">brelse</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>s_zmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        s<span class="token operator">-&gt;</span>s_dev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>第13-16行初始化相关数据结构。</p> 
<p>第17-31行读取 inode 位图和逻辑块位图。</p> 
<p>如果读取的逻辑块数量出现问题，释放掉 buffer_head 结构体，返回 NULL。</p> 
<p>如果没有问题，就返回超级块指针。</p> 
<p>现在来解决上一节关于 m_inode 结构体分配的问题。</p> 
<pre><code class="prism language-c"><span class="token comment">// inode.c</span>
<span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span><span class="token function">iget</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> nr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token operator">*</span>empty<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"iget with dev == 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    inode <span class="token operator">=</span> inode_table<span class="token punctuation">;</span>
    <span class="token comment">// 查看inode是否已被读入</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>inode <span class="token operator">&lt;</span> NR_INODE <span class="token operator">+</span> inode_table<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_dev <span class="token operator">!=</span> dev <span class="token operator">||</span> inode<span class="token operator">-&gt;</span>i_num <span class="token operator">!=</span> nr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            inode<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        inode<span class="token operator">-&gt;</span>i_count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> inode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 查找一个未被使用的inode结构体</span>
    empty <span class="token operator">=</span> <span class="token function">get_empty_inode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>empty<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    inode <span class="token operator">=</span> empty<span class="token punctuation">;</span>
    inode<span class="token operator">-&gt;</span>i_dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    inode<span class="token operator">-&gt;</span>i_num <span class="token operator">=</span> nr<span class="token punctuation">;</span>
    <span class="token function">read_inode</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将数据读到这个结构体中</span>
    <span class="token keyword">return</span> inode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们已经定义了一个 inode 数组，当需要从软盘读取 inode 时，首先查看该 inode 是否被已被读取，如果没有被读取过，再从 inode 数组中找到一个未被使用的成员，将 inode 数据读取到这个成员中。</p> 
<pre><code class="prism language-c"><span class="token comment">// string.h</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">memset</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">int</span> c<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">"cld\n\t"</span>
            <span class="token string">"rep\n\t"</span>
            <span class="token string">"stosb"</span>
            <span class="token operator">::</span> <span class="token string">"a"</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// inode.c</span>
<span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span><span class="token function">get_empty_inode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>inode<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>last_inode <span class="token operator">=</span> inode_table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
        inode <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token comment">// 遍历查找未使用的结构体</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> NR_INODE<span class="token punctuation">;</span> i<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>last_inode <span class="token operator">&gt;=</span> inode_table <span class="token operator">+</span> NR_INODE<span class="token punctuation">)</span>
                last_inode <span class="token operator">=</span> inode_table<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>last_inode<span class="token operator">-&gt;</span>i_count<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                inode <span class="token operator">=</span> last_inode<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果结构体都被使用了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NR_INODE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%04x: %6d\t"</span><span class="token punctuation">,</span> inode_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>i_dev<span class="token punctuation">,</span> 
                    inode_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>i_num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"No free inodes in mem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>inode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    inode<span class="token operator">-&gt;</span>i_count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> inode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>查找一个未被使用的 inode 结构体的办法很简单，通过遍历数组元素即可。如果数组元素都被使用，就报错。</p> 
<p>上面的函数中 m_inode 结构体使用了一个新成员——i_count。当 i_count 为0时，表示该结构体未被使用。当 i_count 从1变为0时，需要将该 inode 写回软盘中。</p> 
<pre><code class="prism language-c"><span class="token comment">// fs.h</span>
<span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i_mode<span class="token punctuation">;</span>      <span class="token comment">// 文件的类型和属性(rwx)</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i_uid<span class="token punctuation">;</span>       <span class="token comment">// 文件所有者的用户id</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> i_size<span class="token punctuation">;</span>       <span class="token comment">// 文件长度（字节）</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> i_mtime<span class="token punctuation">;</span>      <span class="token comment">// 修改时间（从1970.1.1:0时算起，单位：秒）</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> i_gid<span class="token punctuation">;</span>        <span class="token comment">// 文件所有者的组id</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> i_nlinks<span class="token punctuation">;</span>     <span class="token comment">// 链接数</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i_zone<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 文件占用的逻辑块的块号</span>
                                <span class="token comment">// zone[0]-zone[6]是直接块号</span>
                                <span class="token comment">// zone[7]是一次间接块号</span>
                                <span class="token comment">// zone[8]是二次间接块号</span>
<span class="token comment">/* these are in memory also */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i_dev<span class="token punctuation">;</span>   <span class="token comment">// i 节点号</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i_num<span class="token punctuation">;</span>   <span class="token comment">// 设备号</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i_count<span class="token punctuation">;</span> <span class="token comment">// 引用计数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>最后我们来计算一下，有多少未使用的 inode 和逻辑块。</p> 
<pre><code class="prism language-c"><span class="token comment">// super.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_bit</span><span class="token expression"><span class="token punctuation">(</span>bitnr<span class="token punctuation">,</span>addr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">register</span> <span class="token keyword">int</span> __res <span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token function">__asm__</span><span class="token punctuation">(</span></span><span class="token string">"bt %2, %3\n\tsetb %%al"</span><span class="token expression"><span class="token operator">:</span></span><span class="token string">"=a"</span><span class="token expression"><span class="token punctuation">(</span>__res<span class="token punctuation">)</span><span class="token operator">:</span> </span><span class="token string">"a"</span><span class="token expression"><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token string">"r"</span><span class="token expression"><span class="token punctuation">(</span>bitnr<span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token string">"m"</span><span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression">__res<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">mount_root</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> free<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>mi<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mi <span class="token operator">=</span> <span class="token function">iget</span><span class="token punctuation">(</span>ROOT_DEV<span class="token punctuation">,</span> ROOT_INO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mi<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Unable to read root i-node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    free <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    i <span class="token operator">=</span> p<span class="token operator">-&gt;</span>s_nzones<span class="token punctuation">;</span>        <span class="token comment">// 逻辑块数</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">set_bit</span><span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">8191</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>s_zmap<span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>b_data<span class="token punctuation">)</span><span class="token punctuation">)</span>
            free<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%d/%d free blocks\n\r"</span><span class="token punctuation">,</span> free<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>s_nzones<span class="token punctuation">)</span><span class="token punctuation">;</span>
    free <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    i <span class="token operator">=</span> p<span class="token operator">-&gt;</span>s_ninodes <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">// inode数</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">set_bit</span><span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">8191</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>s_imap<span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>b_data<span class="token punctuation">)</span><span class="token punctuation">)</span>
            free<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%d/%d free inodes\n\r"</span><span class="token punctuation">,</span> free<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>s_ninodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>汇编指令<code>bt</code>用于位测试，这个指令会更改 CF 的值。假设 ax 的值为 0x81，<code>bt $2, %ax</code>会检查 ax 的 bit2 是否为1，0x81 的 bit2 位为0，因此会使得 CF=0。而<code>bt $0, ax</code>会使得 CF=1，因为 ax 的 bit0 为1。</p> 
<p><code>i &gt;&gt; 13</code> 用于指定逻辑块或 inode 所属的位图。1个逻辑块有1024字节（byte），即8192个位（bit）。<code>i &amp; 8191</code> 用于取得位图的第几位。</p> 
<p>第19-21行会遍历所有逻辑块位图的所有位，如果对应的位为0，表示该逻辑块未被使用，空闲逻辑块数加1。</p> 
<p>在统计 inode 个数时，并没有算上0号 inode（根目录是1号 inode），第24行加1，就是把0号 inode 也算上。</p> 
<p>最后来看看执行结果。</p> 
<p><img src="https://images2.imgbox.com/a8/dc/wlIQsTqs_o.jpg" alt="9.6执行结果"></p> 
<h3><a id="7open___989"></a>7.open - 寻找文件所在目录</h3> 
<p>这一节开始介绍 open 函数的实现过程，open 函数的内容较多，将会拆分成几个部分进行介绍。而这一节，主要讲如何通过文件路径找到文件所在目录的 inode和逻辑块。</p> 
<p>首先，要在 task_struct 里添加两个 inode 指针，root 代表根目录的 inode，pwd 代表当前目录的inode。并将第一个进程的这两个指针设置为 NULL。</p> 
<pre><code class="prism language-c"><span class="token comment">// sched.h</span>
<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">int</span> tty<span class="token punctuation">;</span>    <span class="token comment">// 进程使用的tty的子设备号。-1表示没有使用</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> umask<span class="token punctuation">;</span>   <span class="token comment">// 文件创建属性屏蔽位</span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>pwd<span class="token punctuation">;</span>    <span class="token comment">// 当前目录的inode</span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>root<span class="token punctuation">;</span>   <span class="token comment">// 根目录的inode</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> close_on_exec<span class="token punctuation">;</span>    <span class="token comment">// 运行可执行文件时关闭文件句柄位图</span>
    <span class="token keyword">struct</span> <span class="token class-name">desc_struct</span> ldt<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 任务局部描述符表。0-空，1-代码段，2-数据和堆栈段</span>
    <span class="token keyword">struct</span> <span class="token class-name">tss_struct</span> tss<span class="token punctuation">;</span>      <span class="token comment">// 进程的任务状态段信息</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INIT_TASK</span> <span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span></span>
<span class="token comment">/* tty etc */</span>   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0022</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> \
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>添加这两个指针是为了方便查找文件的 inode 和逻辑块。比如，文件的路径是<code>/dev/tty0</code>，文件系统会以根目录–&gt;dev–&gt;tty0 的顺序依次查找文件。我们必须知道根目录的 inode。又比如，文件的路径是<code>./Desktop/main.c</code>，文件系统会以当前目录–&gt;Desktop–&gt;main.c 的顺序依次查找文件。此时也必须知道当前目录的 inode。</p> 
<p>在 task_struct 中添加了成员，在 fork、exit 中也要对其进行设置。</p> 
<pre><code class="prism language-c"><span class="token comment">// fork.c</span>
<span class="token keyword">int</span> <span class="token function">copy_process</span><span class="token punctuation">(</span><span class="token keyword">int</span> nr<span class="token punctuation">,</span> <span class="token keyword">long</span> ebp<span class="token punctuation">,</span> <span class="token keyword">long</span> edi<span class="token punctuation">,</span> <span class="token keyword">long</span> esi<span class="token punctuation">,</span> <span class="token keyword">long</span> gs<span class="token punctuation">,</span>
        <span class="token keyword">long</span> none<span class="token punctuation">,</span> <span class="token keyword">long</span> ebx<span class="token punctuation">,</span> <span class="token keyword">long</span> ecx<span class="token punctuation">,</span> <span class="token keyword">long</span> edx<span class="token punctuation">,</span>
        <span class="token keyword">long</span> fs<span class="token punctuation">,</span> <span class="token keyword">long</span> es<span class="token punctuation">,</span> <span class="token keyword">long</span> ds<span class="token punctuation">,</span> <span class="token keyword">long</span> eip<span class="token punctuation">,</span>
        <span class="token keyword">long</span> cs<span class="token punctuation">,</span> <span class="token keyword">long</span> eflags<span class="token punctuation">,</span> <span class="token keyword">long</span> esp<span class="token punctuation">,</span> <span class="token keyword">long</span> ss<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>pwd<span class="token punctuation">)</span>
        current<span class="token operator">-&gt;</span>pwd<span class="token operator">-&gt;</span>i_count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>root<span class="token punctuation">)</span>
        current<span class="token operator">-&gt;</span>root<span class="token operator">-&gt;</span>i_count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置新任务的tss和ldt描述符</span>
    <span class="token function">set_tss_desc</span><span class="token punctuation">(</span>gdt <span class="token operator">+</span> <span class="token punctuation">(</span>nr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> FIRST_TSS_ENTRY<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>tss<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_ldt_desc</span><span class="token punctuation">(</span>gdt <span class="token operator">+</span> <span class="token punctuation">(</span>nr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> FIRST_LDT_ENTRY<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ldt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token operator">-&gt;</span>state <span class="token operator">=</span> TASK_RUNNING<span class="token punctuation">;</span>    <span class="token comment">// 将任务设置为可运行状态</span>

    <span class="token keyword">return</span> last_pid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// exit.c</span>
<span class="token keyword">int</span> <span class="token function">do_exit</span><span class="token punctuation">(</span><span class="token keyword">long</span> code<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    current<span class="token operator">-&gt;</span>pwd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    current<span class="token operator">-&gt;</span>root <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    current<span class="token operator">-&gt;</span>state <span class="token operator">=</span> TASK_ZOMBIE<span class="token punctuation">;</span>
    current<span class="token operator">-&gt;</span>exit_code <span class="token operator">=</span> code<span class="token punctuation">;</span>
    <span class="token function">tell_father</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>father<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>fork时，子进程会继承父进程的 root 和 pwd，并将它们的引用计数加1。exit时，会将 root 和 pwd 设置为 NULL。</p> 
<p>在第5节中，我们获得了根目录的 inode，这之后，需要设置当前进程的 root 和 pwd。</p> 
<pre><code class="prism language-c"><span class="token comment">// super.c</span>
<span class="token keyword">void</span> <span class="token function">mount_root</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mi <span class="token operator">=</span> <span class="token function">iget</span><span class="token punctuation">(</span>ROOT_DEV<span class="token punctuation">,</span> ROOT_INO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mi<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Unable to read root i-node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mi<span class="token operator">-&gt;</span>i_count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    current<span class="token operator">-&gt;</span>pwd <span class="token operator">=</span> mi<span class="token punctuation">;</span>
    current<span class="token operator">-&gt;</span>root <span class="token operator">=</span> mi<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>pwd 和 root 都使用 mi，mi 的 i_count 应该为2。调用 iget 后 mi 的 i_count 变为1，第8行加1就是2。</p> 
<p>好了，做完这些工作，我们就可以尝试寻找文件所在的目录的 inode 了。假设给定的路径是<code>/dev/tty0</code>，我们可以很容易地找到根目录的 inode，通过 inode，我们能够找到根目录的逻辑块。目录的逻辑块中保存了文件名和文件的 inode 号，其结构如下所示。</p> 
<pre><code class="prism language-c"><span class="token comment">// fs.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NAME_LEN</span> <span class="token expression"><span class="token number">14</span></span></span>
<span class="token keyword">struct</span> <span class="token class-name">dir_entry</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> inode<span class="token punctuation">;</span>
    <span class="token keyword">char</span> name<span class="token punctuation">[</span>NAME_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d0/68/O2qGjQNh_o.jpg" alt="目录项"></p> 
<p>上图是 rootimage 中根目录的逻辑块。第一个文件是".“，代表当前目录。第二个文件是”…"，代表上一级目录。第三个文件是 bin（inode 号是2），以此类推。inode 号为0表示没有文件或文件被删除。</p> 
<p>了解这些信息后，就可以开始设计算法了。仍以<code>/dev/tty0</code>为例。</p> 
<p>（1）根据根目录的 inode 找到根目录的逻辑块</p> 
<p>（2）在根目录的逻辑块找到名为 dev 的文件，获得它的 inode 号</p> 
<p>（3）根据 dev 的 inode 号找到 dev 的逻辑块</p> 
<p>（4）在 dev 的逻辑块中找到名为 tty0 的文件</p> 
<p>当然，这个流程还是太简单了，下面的流程图将寻找文件的流程一般化，相信能让大家更容易理解。</p> 
<p><img src="https://images2.imgbox.com/71/e5/Wez7D6dX_o.jpg" alt="寻找文件流程图"></p> 
<p>我承认，我这个图确实有点丑，但不妨碍理解。下面就是用代码实现流程图的逻辑。</p> 
<pre><code class="prism language-c"><span class="token comment">// fs/open.c</span>
<span class="token keyword">int</span> <span class="token function">sys_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">open_namei</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// namei.c</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span><span class="token function">dir_namei</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">get_dir</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">open_namei</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>dir<span class="token punctuation">;</span>

    dir <span class="token operator">=</span> <span class="token function">dir_namei</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>原本在 linux0.11 中，这三个函数有不少内容，我只保留了最基础的部分，在之后的章节填充。</p> 
<pre><code class="prism language-c"><span class="token comment">// namei.c</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span><span class="token function">get_dir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> c<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>thisname<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>inode<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">;</span>
    <span class="token keyword">int</span> namelen<span class="token punctuation">,</span> inr<span class="token punctuation">,</span> idev<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">dir_entry</span> <span class="token operator">*</span>de<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>current<span class="token operator">-&gt;</span>root <span class="token operator">||</span> <span class="token operator">!</span>current<span class="token operator">-&gt;</span>root<span class="token operator">-&gt;</span>i_count<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"No root inode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>current<span class="token operator">-&gt;</span>pwd <span class="token operator">||</span> <span class="token operator">!</span>current<span class="token operator">-&gt;</span>pwd<span class="token operator">-&gt;</span>i_count<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"No cwd inode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    c <span class="token operator">=</span> <span class="token function">get_fs_byte</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 第一个字符是/，说明是绝对路径</span>
        inode <span class="token operator">=</span> current<span class="token operator">-&gt;</span>root<span class="token punctuation">;</span>
        pathname<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span>   <span class="token comment">// 相对路径</span>
        inode <span class="token operator">=</span> current<span class="token operator">-&gt;</span>pwd<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        thisname <span class="token operator">=</span> pathname<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">S_ISDIR</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_mode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">permission</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> MAY_EXEC<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        c <span class="token operator">=</span> <span class="token function">get_fs_byte</span><span class="token punctuation">(</span>pathname<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>namelen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> namelen<span class="token operator">++</span><span class="token punctuation">)</span>
            c <span class="token operator">=</span> <span class="token function">get_fs_byte</span><span class="token punctuation">(</span>pathname<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>c<span class="token punctuation">)</span>
            <span class="token keyword">return</span> inode<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> namelen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> thisname<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        bh <span class="token operator">=</span> <span class="token function">find_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inode<span class="token punctuation">,</span> thisname<span class="token punctuation">,</span> namelen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        inr <span class="token operator">=</span> de<span class="token operator">-&gt;</span>inode<span class="token punctuation">;</span>
        idev <span class="token operator">=</span> inode<span class="token operator">-&gt;</span>i_dev<span class="token punctuation">;</span>
        <span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inode <span class="token operator">=</span> <span class="token function">iget</span><span class="token punctuation">(</span>idev<span class="token punctuation">,</span> inr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inode<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>get_dir 会返回文件所在目录的 inode。</p> 
<p>第16-24行：判断是从根目录还是从当前目录开始查找文件。</p> 
<p>第28行：读取的 inode 必须是目录且目录没有可执行权限。</p> 
<p>第31-35行代码解析下一级文件名或目录名。如果 c 为 ‘/’，说明这是一个目录；如果 c 为0，说明路径解析完成，返回文件所在目录的 inode。不过这里并没有判断目录中是否存在该文件，这是下一节的内容。</p> 
<p>第37-38行：打印解析的目录名。</p> 
<p>第40行：读取上一级目录的逻辑块，并查找是否存在刚才解析的目录。假设路径是<code>/dev/tty0</code>，我们解析的目录名是 dev，这里读取的是根目录的逻辑块，并在根目录的逻辑块中查找是否有 dev。</p> 
<p>第44-49行：将解析的目录的inode读取到内存中。</p> 
<p>permission 函数会检查进程是否有文件的权限。suser() 返回1代表当前进程属于超级用户，超级用户拥有所有的权限。</p> 
<pre><code class="prism language-c"><span class="token comment">// namei.c</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">permission</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">int</span> mask<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> mode <span class="token operator">=</span> inode<span class="token operator">-&gt;</span>i_mode<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_dev <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inode<span class="token operator">-&gt;</span>i_nlinks<span class="token punctuation">)</span>   <span class="token comment">// 链接数至少为1</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>euid <span class="token operator">==</span> inode<span class="token operator">-&gt;</span>i_uid<span class="token punctuation">)</span> <span class="token comment">// 当前进程属于创建文件的用户</span>
        mode <span class="token operator">&gt;&gt;=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>egid <span class="token operator">==</span> inode<span class="token operator">-&gt;</span>i_gid<span class="token punctuation">)</span> <span class="token comment">// 当前进程所属的用户与创建文件的用户在同一用户组</span>
        mode <span class="token operator">&gt;&gt;=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> mask <span class="token operator">&amp;</span> <span class="token number">0007</span><span class="token punctuation">)</span> <span class="token operator">==</span> mask<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">suser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>i_mode 的低9位是不同用户对文件的读/写/执行权限，如下图所示。也可以通过它得知文件是普通文件、目录、字符设备等等。</p> 
<p><img src="https://images2.imgbox.com/a8/9c/HVlb3CR6_o.jpg" alt="文件权限"></p> 
<p>接下来看看 find_entry 中读取逻辑块和查找目录的操作。</p> 
<pre><code class="prism language-c"><span class="token comment">// namei.c</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span><span class="token function">find_entry</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span><span class="token operator">*</span>dir<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">int</span> namelen<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dir_entry</span> <span class="token operator">*</span><span class="token operator">*</span>res_dir<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> entries<span class="token punctuation">;</span>
    <span class="token keyword">int</span> block<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">dir_entry</span> <span class="token operator">*</span>de<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>namelen<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>namelen <span class="token operator">&gt;</span> NAME_LEN<span class="token punctuation">)</span>
        namelen <span class="token operator">=</span> NAME_LEN<span class="token punctuation">;</span>

    entries <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>dir<span class="token punctuation">)</span><span class="token operator">-&gt;</span>i_size <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dir_entry</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>res_dir <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    block <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>dir<span class="token punctuation">)</span><span class="token operator">-&gt;</span>i_zone<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>block<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    bh <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>dir<span class="token punctuation">)</span><span class="token operator">-&gt;</span>i_dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    de <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dir_entry</span> <span class="token operator">*</span><span class="token punctuation">)</span> bh<span class="token operator">-&gt;</span>b_data<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">match</span><span class="token punctuation">(</span>namelen<span class="token punctuation">,</span> name<span class="token punctuation">,</span> de<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>res_dir <span class="token operator">=</span> de<span class="token punctuation">;</span>
            <span class="token keyword">return</span> bh<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        de<span class="token operator">++</span><span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>第10-13行：检查目录名长度是否有问题，名字过长会被截掉一部分。假如路径是<code>/dev//</code>，dev 的下一级目录的长度为0，这也是不行的。</p> 
<p>第15行：计算上一级目录存在多少个文件。</p> 
<p>第18行：找到上一级目录的第一个逻辑块号。</p> 
<p>第22-24行：通过逻辑块号读取相应的逻辑块到内存中。</p> 
<p>第26-35行：不断循环对比文件名。如果不存在该文件，则返回 NULL。这一段代码还不够完善。一个逻辑块最多存储64个目录项，假设一个目录有128个文件，文件名保存在两个逻辑块中，如果要读取的文件名在第二个逻辑块，那么就可能出现错误。这个错误的完善也会放在之后的章节来完成。</p> 
<p>文件名对比的函数比较简单。由于 linux0.11 自带的 strncmp 有点小问题，所以我自己实现了一个。</p> 
<pre><code class="prism language-c"><span class="token comment">// string.h</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">strncmp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cs<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ct<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> <span class="token operator">*</span>base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>cs<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> cs <span class="token operator">-</span> base <span class="token operator">&lt;</span> count <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>cs <span class="token operator">==</span> <span class="token operator">*</span>ct<span class="token punctuation">;</span> cs<span class="token operator">++</span><span class="token punctuation">,</span> ct<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span>cs<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cs <span class="token operator">-</span> base <span class="token operator">==</span> count <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token operator">*</span>cs <span class="token operator">-</span> <span class="token operator">*</span>ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// namei.c</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dir_entry</span> <span class="token operator">*</span>de<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>de <span class="token operator">||</span> <span class="token operator">!</span>de<span class="token operator">-&gt;</span>inode <span class="token operator">||</span> len <span class="token operator">&gt;</span> NAME_LEN<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> NAME_LEN <span class="token operator">&amp;&amp;</span> de<span class="token operator">-&gt;</span>name<span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment">// 解析的文件名长度比目录项的文件名长度小</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> de<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> len<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接下来要完善用户使用的系统调用。</p> 
<pre><code class="prism language-c"><span class="token comment">// unistd.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__NR_open</span>   <span class="token expression"><span class="token number">5</span></span></span>

<span class="token comment">// lib/open.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__LIBRARY__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">register</span> <span class="token keyword">int</span> res<span class="token punctuation">;</span>
    va_list arg<span class="token punctuation">;</span>

    <span class="token function">va_start</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">"int $0x80"</span>
        <span class="token operator">:</span><span class="token string">"=a"</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token operator">:</span><span class="token string">"0"</span> <span class="token punctuation">(</span>__NR_open<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"b"</span> <span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"c"</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"d"</span> <span class="token punctuation">(</span><span class="token function">va_arg</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    errno <span class="token operator">=</span> <span class="token operator">-</span>res<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sys.h</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">sys_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fn_ptr sys_call_table<span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>sys_setup<span class="token punctuation">,</span> sys_exit<span class="token punctuation">,</span> sys_fork<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sys_open<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sys_pause<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>最后是在 main.c 中调用 open 函数。</p> 
<pre><code class="prism language-c"><span class="token comment">// main.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/tty0"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行结果如下。可以看到，最下方打印了 dev。</p> 
<p><img src="https://images2.imgbox.com/84/39/v3YCWWqc_o.jpg" alt="9.7运行结果"></p> 
<h3><a id="8open___1349"></a>8.open - 读取文件信息</h3> 
<p>为了方便查找已打开的文件，使用数组管理所有打开的文件。同时，也会在进程中添加一个结构来管理文件，这可以很方便地知道进程打开了那些文件，方便进行资源的管理。</p> 
<p>我们应该用怎样的数据结构去描述一个文件呢？我们不仅要知道文件的信息，还要知道对文件做什么操作。</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> f_mode<span class="token punctuation">;</span>      <span class="token comment">// 文件操作模式</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> f_flags<span class="token punctuation">;</span>     <span class="token comment">// 文件打开和控制的标志</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> f_count<span class="token punctuation">;</span>     <span class="token comment">// 引用计数</span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>f_inode<span class="token punctuation">;</span>    <span class="token comment">// 文件对应的inode</span>
    <span class="token class-name">off_t</span> f_pos<span class="token punctuation">;</span>                <span class="token comment">// 文件内的读写偏移值</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>通过 f_inode 主要用来找文件的逻辑块号。通过 f_flags 可以知道进程对文件的操作权限，比如创建(O_CREAT)、只读(O_RDONLY)、只写(O_WRONLY)等。f_mode 的信息与 inode 中的 i_mode 一样，可以知道文件的信息，用户对文件的访问权限等。f_count 代表使用该文件的次数。f_pos 是当前读写的位置，可以参考 lseek 函数了解该功能。</p> 
<p>然后要将它添加到进程中，每个进程最多只能打开20个文件。</p> 
<pre><code class="prism language-c"><span class="token comment">// fs.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NR_OPEN</span> <span class="token expression"><span class="token number">20</span></span></span>

<span class="token comment">// sched.h</span>
<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>pwd<span class="token punctuation">;</span>    <span class="token comment">// 当前目录的inode</span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>root<span class="token punctuation">;</span>   <span class="token comment">// 根目录的inode</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> close_on_exec<span class="token punctuation">;</span>    <span class="token comment">// 运行可执行文件时关闭文件句柄位图</span>
    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">[</span>NR_OPEN<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 进程打开的文件</span>
    <span class="token keyword">struct</span> <span class="token class-name">desc_struct</span> ldt<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 任务局部描述符表。0-空，1-代码段，2-数据和堆栈段</span>
    <span class="token keyword">struct</span> <span class="token class-name">tss_struct</span> tss<span class="token punctuation">;</span>      <span class="token comment">// 进程的任务状态段信息</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INIT_TASK</span> <span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span></span>
<span class="token comment">/* tty etc */</span>   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0022</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> \
<span class="token comment">/* filp */</span>  <span class="token punctuation">{<!-- --></span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span> \
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>添加到进程后应该做什么？没错，又要改 fork。</p> 
<pre><code class="prism language-c"><span class="token comment">// fork.c</span>
<span class="token keyword">int</span> <span class="token function">copy_process</span><span class="token punctuation">(</span><span class="token keyword">int</span> nr<span class="token punctuation">,</span> <span class="token keyword">long</span> ebp<span class="token punctuation">,</span> <span class="token keyword">long</span> edi<span class="token punctuation">,</span> <span class="token keyword">long</span> esi<span class="token punctuation">,</span> <span class="token keyword">long</span> gs<span class="token punctuation">,</span>
        <span class="token keyword">long</span> none<span class="token punctuation">,</span> <span class="token keyword">long</span> ebx<span class="token punctuation">,</span> <span class="token keyword">long</span> ecx<span class="token punctuation">,</span> <span class="token keyword">long</span> edx<span class="token punctuation">,</span>
        <span class="token keyword">long</span> fs<span class="token punctuation">,</span> <span class="token keyword">long</span> es<span class="token punctuation">,</span> <span class="token keyword">long</span> ds<span class="token punctuation">,</span> <span class="token keyword">long</span> eip<span class="token punctuation">,</span>
        <span class="token keyword">long</span> cs<span class="token punctuation">,</span> <span class="token keyword">long</span> eflags<span class="token punctuation">,</span> <span class="token keyword">long</span> esp<span class="token punctuation">,</span> <span class="token keyword">long</span> ss<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>

    p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">get_free_page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>
    task<span class="token punctuation">[</span>nr<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NR_OPEN<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        f <span class="token operator">=</span> p<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span>
            f<span class="token operator">-&gt;</span>f_count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>pwd<span class="token punctuation">)</span>
        current<span class="token operator">-&gt;</span>pwd<span class="token operator">-&gt;</span>i_count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>root<span class="token punctuation">)</span>
        current<span class="token operator">-&gt;</span>root<span class="token operator">-&gt;</span>i_count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>子进程会继承父进程打开的文件。第14行会把父进程的文件指针拷贝到子进程，第20行会增加数据结构的引用计数。</p> 
<p>现在来完善 sys_open 函数。</p> 
<pre><code class="prism language-c"><span class="token comment">// file_table.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token keyword">struct</span> <span class="token class-name">file</span> file_table<span class="token punctuation">[</span>NR_FILE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// open.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sched.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">sys_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>inode<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> fd<span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> fd <span class="token operator">&lt;</span> NR_OPEN<span class="token punctuation">;</span> fd<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>current<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;=</span> NR_OPEN<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    
    f <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">+</span> file_table<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NR_FILE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> f<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token operator">-&gt;</span>f_count<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> NR_FILE<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    
    current<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">;</span>
    
    i <span class="token operator">=</span> <span class="token function">open_namei</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        current<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
    f<span class="token operator">-&gt;</span>f_mode <span class="token operator">=</span> inode<span class="token operator">-&gt;</span>i_mode<span class="token punctuation">;</span>
	f<span class="token operator">-&gt;</span>f_flags <span class="token operator">=</span> flag<span class="token punctuation">;</span>
	f<span class="token operator">-&gt;</span>f_count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	f<span class="token operator">-&gt;</span>f_inode <span class="token operator">=</span> inode<span class="token punctuation">;</span>
	f<span class="token operator">-&gt;</span>f_pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"open file successfully!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>file_table 用于管理所有打开的文件。sys_open 的 mode 参数用于创建文件，现在不使用。</p> 
<p>第15-19行：查找进程的文件数组中是否有空闲项，没有就不能打开文件。</p> 
<p>第21-26行：查找 file_table 中是否有空闲项，没有就不能打开文件。</p> 
<p>第28行：找到 file_table 中空闲项后，将其记录在进程中。</p> 
<p>第30-34行：open_namei 返回负数代表出错，此时清除进程中的文件信息，并返回错误值。在 open_namei 返回正常的情况下，inode 变量保存了目标文件的 inode。</p> 
<p>第36-42行：对文件结构进行赋值，并返回文件描述符。如果打开文件成功就会打印上面的语句。</p> 
<p>这一节的 open_namei 需要读取文件的 inode，修改如下：</p> 
<pre><code class="prism language-c"><span class="token comment">// namei.c</span>
<span class="token keyword">int</span> <span class="token function">open_namei</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span><span class="token operator">*</span>res_inode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>basename<span class="token punctuation">;</span>
    <span class="token keyword">int</span> inr<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> namelen<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>dir<span class="token punctuation">,</span> <span class="token operator">*</span>inode<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">dir_entry</span> <span class="token operator">*</span>de<span class="token punctuation">;</span>

    dir <span class="token operator">=</span> <span class="token function">dir_namei</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>namelen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>basename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>namelen<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EISDIR<span class="token punctuation">;</span>
    
    bh <span class="token operator">=</span> <span class="token function">find_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dir<span class="token punctuation">,</span> basename<span class="token punctuation">,</span> namelen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
    
    inr <span class="token operator">=</span> de<span class="token operator">-&gt;</span>inode<span class="token punctuation">;</span>
    dev <span class="token operator">=</span> dir<span class="token operator">-&gt;</span>i_dev<span class="token punctuation">;</span>
    <span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>

    inode <span class="token operator">=</span> <span class="token function">iget</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> inr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inode<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EACCES<span class="token punctuation">;</span>
    
    inode<span class="token operator">-&gt;</span>i_atime <span class="token operator">=</span> CURRENT_TIME<span class="token punctuation">;</span>
    <span class="token operator">*</span>res_inode <span class="token operator">=</span> inode<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// sched.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CURRENT_TIME</span> <span class="token expression"><span class="token punctuation">(</span>startup_time <span class="token operator">+</span> jiffies <span class="token operator">/</span> HZ<span class="token punctuation">)</span></span></span>
</code></pre> 
<p>open_namei 的返回值用于判断是否出现问题。但是我们又想获得文件的 inode 指针，这怎么办呢？很简单，如果我们想修改 inode 成员的值，将 inode 的指针传入就行了。那么我们想要修改 inode 指针的值，将 inode 指针的指针作为参数就行了。</p> 
<p>第10-14行：dir_namei 会返回文件所在目录的 inode，通过路径解析出文件名和文件名长度。如果路径中的目录不存在，或是路径中只有目录没有文件名，就会出错。</p> 
<p>第16-18行：find_entry 中会通过目录的 inode 找到逻辑块，然后查找文件名。如果目录中不存在该文件就会报错。</p> 
<p>第20-22行：获取文件的 inode 号和文件所在设备的设备号。bh 是目录的文件缓冲区，由于之后不会再使用它，所有这里会释放该缓冲区。</p> 
<p>第24-26行：读取文件的 inode。</p> 
<p>第28行修改文件最近的访问时间。i_atime 是 m_inode 结构体中新的成员。</p> 
<p>第29行设置 res_inode，以供调用 open_namei 的函数使用。</p> 
<p>最后返回0。</p> 
<p>dir_namei 的改动不大，仅仅是找到文件名和算出文件名长度。</p> 
<pre><code class="prism language-c"><span class="token comment">// namei.c</span>
<span class="token comment">/**
 * 通过路径名找到文件名、文件所在目录的inode，计算出文件名长度
 * @param pathname 文件的路径（绝对路径或相对路径）
 * @param namelen 通过指针得到文件名的长度
 * @param name 通过指针得到文件名
 * @return NULL：没有找到文件的目录；其他：文件目录的inode
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span><span class="token function">dir_namei</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>namelen<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> c<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>basename<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>dir<span class="token punctuation">;</span>

    dir <span class="token operator">=</span> <span class="token function">get_dir</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    basename <span class="token operator">=</span> pathname<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
        c <span class="token operator">=</span> <span class="token function">get_fs_byte</span><span class="token punctuation">(</span>pathname<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'/'</span><span class="token punctuation">)</span>
            basename <span class="token operator">=</span> pathname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>namelen <span class="token operator">=</span> pathname <span class="token operator">-</span> basename <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 计算文件名长度</span>
    <span class="token operator">*</span>name <span class="token operator">=</span> basename<span class="token punctuation">;</span>   <span class="token comment">// 计算文件名起始地址</span>
    <span class="token keyword">return</span> dir<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后看看运行的结果。</p> 
<p><img src="https://images2.imgbox.com/83/0a/IqXZrnEq_o.jpg" alt="9.8运行结果"></p> 
<h3><a id="9write___1577"></a>9.write - 字符设备文件</h3> 
<p>本来是要先写 close 的，但是我发现没有 printf 真的很不方便，printf 的实现需要用到 write，所以就先写 write 了。</p> 
<p>printf 中要写的文件是 /dev/tty0。没错，就是上面打开的那个文件，这是个字符设备文件。在 open 的时候本来应该对字符设备文件做一些特殊处理，但我们这是一个简单的内核，现在还不做这些功能。</p> 
<p>按照 C 库标准，0号文件描述符代表标准输入(stdin)，1号文件描述符代表标准输出(stdout)，2号文件描述符代表标准错误输出。</p> 
<p>我们上一节打开的文件的文件描述符是0，代表 stdin。而 printf 中的 write 是对 stdout 输出，那我们怎么搞出新文件呢？这就需要使用 dup 系统调用了。</p> 
<pre><code class="prism language-c"><span class="token comment">// fcntl.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sched.h&gt;</span></span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">dupfd</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;=</span> NR_OPEN <span class="token operator">||</span> <span class="token operator">!</span>current<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EBADF<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>arg <span class="token operator">&gt;=</span> NR_OPEN<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	
    <span class="token keyword">while</span> <span class="token punctuation">(</span>arg <span class="token operator">&lt;</span> NR_OPEN<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>arg<span class="token punctuation">]</span><span class="token punctuation">)</span>
			arg<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>arg <span class="token operator">&gt;=</span> NR_OPEN<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EMFILE<span class="token punctuation">;</span>
    
    current<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>arg<span class="token punctuation">]</span> <span class="token operator">=</span> current<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span>
    current<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>arg<span class="token punctuation">]</span><span class="token operator">-&gt;</span>f_count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> arg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">sys_dup</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fildes<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">dupfd</span><span class="token punctuation">(</span>fildes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们可以使用 dup 函数复制文件描述符。</p> 
<p>第12-18行：寻找进程中空闲的文件项。</p> 
<p>第20-21行：可以看到，我们只是复制文件指针，并增加了文件结构体的引用计数。</p> 
<p>最后返回新的文件描述符。</p> 
<p>我们只需要使用 dup 复制0号文件描述符两次就可以得到 stdout 和 stderr。那为什么要把一个文件分成三个文件指针呢？好问题！我也不知道。</p> 
<p>接下来就可以写 write 函数了。</p> 
<pre><code class="prism language-c"><span class="token comment">// read_write.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sched.h&gt;</span></span>

<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">rw_char</span><span class="token punctuation">(</span><span class="token keyword">int</span> rw<span class="token punctuation">,</span> <span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">off_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">sys_write</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>inode<span class="token punctuation">;</span>

    file <span class="token operator">=</span> current<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;=</span> NR_OPEN <span class="token operator">||</span> count <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span>file<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>count<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    inode <span class="token operator">=</span> file<span class="token operator">-&gt;</span>f_inode<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISCHR</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_mode<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">rw_char</span><span class="token punctuation">(</span>WRITE<span class="token punctuation">,</span> inode<span class="token operator">-&gt;</span>i_zone<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file<span class="token operator">-&gt;</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"(Write)inode-&gt;i_mode=%06o\n"</span><span class="token punctuation">,</span> inode<span class="token operator">-&gt;</span>i_mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>第15-19行：检查参数是否有问题。</p> 
<p>第21-23行：如果是字符设备，向设备写入内容。字符设备文件的 inode 的 i_zone[0] 存储的是字符设备的设备号。</p> 
<p>第25-26行：现在只做了字符设备的功能，如果是其他类型的文件就直接报错。</p> 
<pre><code class="prism language-c"><span class="token comment">// char_dev.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sched.h&gt;</span></span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">tty_write</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> minor<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>crw_ptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span> rw<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> minor<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">off_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rw_ttyx</span><span class="token punctuation">(</span><span class="token keyword">int</span> rw<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> minor<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">off_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rw <span class="token operator">==</span> WRITE<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">tty_write</span><span class="token punctuation">(</span>minor<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rw_tty</span><span class="token punctuation">(</span><span class="token keyword">int</span> rw<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> minor<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">off_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>tty <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">rw_ttyx</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span> current<span class="token operator">-&gt;</span>tty<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NRDEVS</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>crw_table<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>crw_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">static</span> crw_ptr crw_table<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>    <span class="token comment">/* nodev */</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>    <span class="token comment">/* /dev/mem etc */</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>    <span class="token comment">/* /dev/fd */</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>    <span class="token comment">/* /dev/hd */</span>
    rw_ttyx<span class="token punctuation">,</span> <span class="token comment">/* /dev/ttyx */</span>
    rw_tty<span class="token punctuation">,</span>  <span class="token comment">/* /dev/tty */</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>    <span class="token comment">/* /dev/lp */</span>
    <span class="token constant">NULL</span>     <span class="token comment">/* unnamed pipes */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">rw_char</span><span class="token punctuation">(</span><span class="token keyword">int</span> rw<span class="token punctuation">,</span> <span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">off_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    crw_ptr call_addr<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">MAJOR</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> NRDEVS<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>

    call_addr <span class="token operator">=</span> crw_table<span class="token punctuation">[</span><span class="token function">MAJOR</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>call_addr<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">call_addr</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span> <span class="token function">MINOR</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>rw_char 函数中，第39-40行检查设备号是否有问题。第42-44行获得相应设备的调用函数。最后调用该函数。</p> 
<p>rw_ttyx 和 rw_tty 的功能相似，都是 tty_write 函数输出字符。</p> 
<p>/dev/tty0 的设备号是 0x400，所以会调用 rw_ttyx 函数。</p> 
<p>这样一看，sys_write 的实现还是很简单的嘛（前提是我们已经完成了 tty_write）。</p> 
<p>然后需要完善 dup 和 write 的系统调用。</p> 
<pre><code class="prism language-c"><span class="token comment">// write.c</span>
<span class="token function">_syscall3</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> write<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token class-name">off_t</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>

<span class="token comment">// dup.c</span>
<span class="token function">_syscall1</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> dup<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span>

<span class="token comment">// unistd.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__NR_write</span>  <span class="token expression"><span class="token number">4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__NR_dup</span>	<span class="token expression"><span class="token number">41</span></span></span>
    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_syscall1</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span>name<span class="token punctuation">,</span>atype<span class="token punctuation">,</span>a<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression">type <span class="token function">name</span><span class="token punctuation">(</span>atype a<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">{<!-- --></span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">long</span> __res<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression">__asm__ <span class="token keyword">volatile</span> <span class="token punctuation">(</span></span><span class="token string">"int $0x80"</span> <span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">:</span> </span><span class="token string">"=a"</span> <span class="token expression"><span class="token punctuation">(</span>__res<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">:</span> </span><span class="token string">"0"</span> <span class="token expression"><span class="token punctuation">(</span>__NR_</span><span class="token punctuation">##</span><span class="token expression">name<span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="token string">"b"</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>__res <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> __res<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression">errno <span class="token operator">=</span> <span class="token operator">-</span>__res<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_syscall3</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span>name<span class="token punctuation">,</span>atype<span class="token punctuation">,</span>a<span class="token punctuation">,</span>btype<span class="token punctuation">,</span>b<span class="token punctuation">,</span>ctype<span class="token punctuation">,</span>c<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression">type <span class="token function">name</span><span class="token punctuation">(</span>atype a<span class="token punctuation">,</span>btype b<span class="token punctuation">,</span>ctype c<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">{<!-- --></span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">long</span> __res<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression">__asm__ <span class="token keyword">volatile</span> <span class="token punctuation">(</span></span><span class="token string">"int $0x80"</span> <span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">:</span> </span><span class="token string">"=a"</span> <span class="token expression"><span class="token punctuation">(</span>__res<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">:</span> </span><span class="token string">"0"</span> <span class="token expression"><span class="token punctuation">(</span>__NR_</span><span class="token punctuation">##</span><span class="token expression">name<span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="token string">"b"</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="token string">"c"</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="token string">"d"</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>__res<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> __res<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression">errno<span class="token operator">=</span><span class="token operator">-</span>__res<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span></span></span>

<span class="token keyword">int</span> <span class="token function">dup</span><span class="token punctuation">(</span><span class="token keyword">int</span> fildes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> fildes<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">off_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// sys.h</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">sys_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">sys_dup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fn_ptr sys_call_table<span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>sys_setup<span class="token punctuation">,</span> sys_exit<span class="token punctuation">,</span> sys_fork<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sys_write<span class="token punctuation">,</span> sys_open<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sys_pause<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sys_dup<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>有了 write 函数就可以写 printf 了，它的逻辑很简单。</p> 
<pre><code class="prism language-c"><span class="token comment">// main.c</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> printbuf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	va_list args<span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>

	<span class="token function">va_start</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    i <span class="token operator">=</span> <span class="token function">vsprintf</span><span class="token punctuation">(</span>printbuf<span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> printbuf<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>并对根目录的 Makefile 的 CFLAGS 进行修改，添加上<code>-fno-builtin</code>选项，防止编译器将 printf 优化成 puts，导致编译报错。</p> 
<pre><code>CFLAGS	=-Wall -g -O -m32 -fno-builtin -fomit-frame-pointer -fno-stack-protector -no-pie -fno-pic -Iinclude
</code></pre> 
<p>对 init 函数的修改如下：</p> 
<pre><code class="prism language-c"><span class="token comment">// main.c</span>
<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/tty0"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello World!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>看看最后的运行结果。</p> 
<p><img src="https://images2.imgbox.com/ef/48/IeXYsRRE_o.jpg" alt="9.9运行结果"></p> 
<h3><a id="10read___1816"></a>10.read - 读取普通文件</h3> 
<p>这一节实现普通文件的读取。读取的文件是 /usr/root/hello.c，它的内容是一个打印 Hello World 的程序。</p> 
<p>还是从 sys_read 函数开始说起。</p> 
<pre><code class="prism language-c"><span class="token comment">// read_write.c</span>
<span class="token keyword">int</span> <span class="token function">sys_read</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>inode<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;=</span> NR_OPEN <span class="token operator">||</span> count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    file <span class="token operator">=</span> current<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>count<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token function">verify_area</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    inode <span class="token operator">=</span> file<span class="token operator">-&gt;</span>f_inode<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISDIR</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_mode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">S_ISREG</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">+</span> file<span class="token operator">-&gt;</span>f_pos <span class="token operator">&gt;</span> inode<span class="token operator">-&gt;</span>i_size<span class="token punctuation">)</span>
            count <span class="token operator">=</span> inode<span class="token operator">-&gt;</span>i_size <span class="token operator">-</span> file<span class="token operator">-&gt;</span>f_pos<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">file_read</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> file<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"(Read)inode-&gt;i_mode=%06o\n\r"</span><span class="token punctuation">,</span> inode<span class="token operator">-&gt;</span>i_mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>sys_read 的参数是文件描述符 fd，存储内容的指针 buf 和读取的字符数 count。</p> 
<p>第7-14行：判断参数是否合法。</p> 
<p>第16行：在 fork 时，子进程只是拥有了自己的页表，并没有填充页表项。verify_area 会检查进程是否有数据所在的页，如果没有就把页的内容从父进程拷贝到子进程。</p> 
<p>第17-26行：如果文件是目录或普通文件，就读取文件；如果是其他种类的文件，就会报错，之后的章节在处理多种类型的文件。</p> 
<pre><code class="prism language-c"><span class="token comment">// file_dev.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MIN</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">file_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> left<span class="token punctuation">,</span> chars<span class="token punctuation">,</span> nr<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">;</span>

    left <span class="token operator">=</span> count<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        nr <span class="token operator">=</span> <span class="token function">bmap</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> <span class="token punctuation">(</span>filp<span class="token operator">-&gt;</span>f_pos<span class="token punctuation">)</span> <span class="token operator">/</span> BLOCK_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            bh <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_dev<span class="token punctuation">,</span> nr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
            bh <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		
        nr <span class="token operator">=</span> filp<span class="token operator">-&gt;</span>f_pos <span class="token operator">%</span> BLOCK_SIZE<span class="token punctuation">;</span>
        chars <span class="token operator">=</span> <span class="token function">MIN</span><span class="token punctuation">(</span>BLOCK_SIZE <span class="token operator">-</span> nr<span class="token punctuation">,</span> left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        filp<span class="token operator">-&gt;</span>f_pos <span class="token operator">+=</span> chars<span class="token punctuation">;</span>
        left <span class="token operator">-=</span> chars<span class="token punctuation">;</span>
		
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> nr <span class="token operator">+</span> bh<span class="token operator">-&gt;</span>b_data<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>chars<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">put_fs_byte</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buf<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>chars<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">put_fs_byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	inode<span class="token operator">-&gt;</span>i_atime <span class="token operator">=</span> CURRENT_TIME<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>count <span class="token operator">-</span> left<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>count <span class="token operator">-</span> left<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token operator">-</span>ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>第14行：bmap 的参数分别是文件的 inode 指针和文件的第几个逻辑块。这个函数用于查找文件第 n 个逻辑块的块号。</p> 
<p>第15-21行：如果找到了逻辑块的块号，将逻辑块读取到内存中。</p> 
<p>第23-26行：算出当前逻辑块最多可读取多少字符。如果当前逻辑块可读取所有字符，则无需再循环。</p> 
<p>第28-36行：如果之前将逻辑块读取到内存中，就将数据复制到 buf 中，并释放该文件缓冲区。否则，向 buf 中填充0。</p> 
<pre><code class="prism language-c"><span class="token comment">// segment.h</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">put_fs_byte</span><span class="token punctuation">(</span><span class="token keyword">char</span> val<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">"movb %0,%%fs:%1"</span> <span class="token operator">::</span><span class="token string">"r"</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"m"</span><span class="token punctuation">(</span><span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>put_fs_byte 将内核的一个字节复制到用户进程空间中。</p> 
<p>在看 bmap 的实现前，我们要回顾一下文件的相关信息。文件的逻辑块号保存在 inode 的 i_zone[9] 中。数组前7个元素都保存了一个逻辑块号，第8个保存了一个一级逻辑块号，第9个保存了一个二级逻辑块号。我们的思路是：先看看逻辑块号是不是在 i_zone 的前7个元素中，如果不在，那就看是不是在一级逻辑块中，如果也不在，那就去二级逻辑块找。</p> 
<pre><code class="prism language-c"><span class="token comment">// inode.c</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">_bmap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">int</span> block<span class="token punctuation">,</span> <span class="token keyword">int</span> create<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"_bmap: block &lt; 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">&gt;=</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">512</span> <span class="token operator">+</span> <span class="token number">512</span> <span class="token operator">*</span> <span class="token number">512</span><span class="token punctuation">)</span>   <span class="token comment">// 7个直接 + 1个一级间接 + 1个二级间接</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"_bmap: block &gt; big"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 直接</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> inode<span class="token operator">-&gt;</span>i_zone<span class="token punctuation">[</span>block<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 一级间接</span>
    block <span class="token operator">-=</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inode<span class="token operator">-&gt;</span>i_zone<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        bh <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_dev<span class="token punctuation">,</span> inode<span class="token operator">-&gt;</span>i_zone<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>block<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 二级间接</span>
    block <span class="token operator">-=</span> <span class="token number">512</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inode<span class="token operator">-&gt;</span>i_zone<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    bh <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_dev<span class="token punctuation">,</span> inode<span class="token operator">-&gt;</span>i_zone<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span>bh<span class="token operator">-&gt;</span>b_data<span class="token punctuation">)</span><span class="token punctuation">[</span>block <span class="token operator">&gt;&gt;</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>i<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    bh <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_dev<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span>bh<span class="token operator">-&gt;</span>b_data<span class="token punctuation">)</span><span class="token punctuation">[</span>block <span class="token operator">&amp;</span> <span class="token number">511</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">bmap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">int</span> block<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">_bmap</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> block<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>_bmap 的 create 参数与创建文件有关，现在不使用。</p> 
<p>第7-10行：检查参数是否合法。block 不能小于0也不能大于文件拥有逻辑块的最大值。</p> 
<p>第13-15行：如果要读取的是文件的前7个逻辑块，就直接返回逻辑块号。</p> 
<p>第18-28行：一级逻辑块保存了512个逻辑块号，如果要读取文件的第8-519号逻辑块，需要将一级逻辑块读入内存，我们就能够通过数组索引的方式找到逻辑块号。</p> 
<p>第31-48行：二级逻辑块保存了512个一个逻辑块。第35-41行将二级逻辑块读入内存，找到一级逻辑块号。第43-48行将一级逻辑块号读入内存，找到逻辑块号。</p> 
<p>OK，接下来是将 read 做成系统调用并使用。</p> 
<pre><code class="prism language-c"><span class="token comment">// unistd.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__NR_read</span>	<span class="token expression"><span class="token number">3</span></span></span>
<span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fildes<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">off_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// sys.h</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">sys_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fn_ptr sys_call_table<span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>sys_setup<span class="token punctuation">,</span> sys_exit<span class="token punctuation">,</span> sys_fork<span class="token punctuation">,</span> sys_read<span class="token punctuation">,</span> sys_write<span class="token punctuation">,</span> sys_open<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sys_pause<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sys_dup<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// main.c</span>
<span class="token keyword">inline</span> <span class="token function">_syscall3</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> read<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token class-name">off_t</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">75</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/tty0"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/usr/root/hello.c"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下面是代码运行结果：</p> 
<p><img src="https://images2.imgbox.com/58/42/8CgRvBLI_o.jpg" alt="9.10运行结果"></p> 
<h3><a id="11close__inode_2022"></a>11.close - 关闭文件回收inode</h3> 
<p>本章的最后一节是关闭文件。在关闭文件时，当文件 inode 的引用计数为0时（没有进程使用该 inode），需要回收分配出去的 inode。</p> 
<pre><code class="prism language-c"><span class="token comment">// open.c</span>
<span class="token keyword">int</span> <span class="token function">sys_close</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;=</span> NR_OPEN<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    filp <span class="token operator">=</span> current<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filp<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    
    current<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filp<span class="token operator">-&gt;</span>f_count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Close: file count is 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>filp<span class="token operator">-&gt;</span>f_count<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">iput</span><span class="token punctuation">(</span>filp<span class="token operator">-&gt;</span>f_inode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>第6-10行：检查参数是否合法。</p> 
<p>第14行：将文件指针从进程的文件数组中移除。</p> 
<p>第15-16行：如果文件的引用计数为0，说明没有进程使用该文件，这明显是出问题了。</p> 
<p>第17-20行：递减文件的引用计数，之后，如果文件的引用计数不等于0，说明还有进程在使用该文件，直接返回。如果等于0，说明没有进程使用该文件，这时就可以释放 inode。</p> 
<p>我们在 open 中使用 iget 获取 inode_table 中空闲的 inode，在 close 中使用 iput 将获取的 inode 改为空闲状态。这是对 inode 的分配和回收。</p> 
<pre><code class="prism language-c"><span class="token comment">// inode.c</span>
<span class="token keyword">void</span> <span class="token function">iput</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span>inode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inode<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inode<span class="token operator">-&gt;</span>i_count<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"iput: trying to free free inode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    inode<span class="token operator">-&gt;</span>i_count<span class="token operator">--</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>之前 sys_close 中不是检查了引用计数吗？为什么要再次检查引用计数？因为 iput 不只是 sys_close 在用，其他函数在调用 iput 之前可能不会检查引用计数，这一步就得由 iput 完成。</p> 
<p>最后递减 i_count。当 inode 的 i_count 为0时，表示这个 inode 未被使用。</p> 
<p>接着，我们需要在已有的函数中不再需要 inode 的地方添加 iput，释放 inode。</p> 
<p>第一步，我们需要找到使用过 m_inode 结构体的函数。有 file_read、read_inode、_bmap、bmap、iput、get_empty_inode、iget、read_inode、permission、find_entry、get_dir、dir_namei、open_namei、sys_open、sys_read、sys_write、mount_root、sys_close、do_exit、fork。</p> 
<p>第二步，去掉以 m_inode 结构体指针为参数的函数，这些函数只会涉及到对 m_inode 结构体成员的访问，释放操作在其他函数进行。剩下的函数有 get_empty_inode、iget、get_dir、dir_namei、open_namei、sys_open、sys_read、sys_write、mount_root、sys_close、do_exit、fork。</p> 
<p>第三步，对第二步中剩余的函数逐个分析。get_empty_inode 函数只是对 inode_table 进行遍历，不需要。目前，iget 函数会读取 inode，没有释放 inode 的地方，不需要。get_dir 函数会读取inode，在解析文件路径出错时，应该释放读取的 inode，需要。open_namei 函数在不能获取文件的 inode 时，会释放文件所在目录的 inode，需要。sys_open、dir_namei 函数中关于 inode 的操作都在 get_dir 中，不需要。sys_read、sys_write 函数只是访问 inode 的成员，不需要。mount_root 是获取 inode 和对 inode 赋值，不需要。sys_close 在上面说过，需要。do_exit 会释放进程的 root 和 pwd，需要。fork 只是对 inode 的赋值，不需要。</p> 
<p>综上，需要 iput 的函数有 get_dir，open_namei，do_exit 和 sys_close。sys_close 的代码已在上面给出。</p> 
<pre><code class="prism language-c"><span class="token comment">// exit.c</span>
<span class="token keyword">int</span> <span class="token function">do_exit</span><span class="token punctuation">(</span><span class="token keyword">long</span> code<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">iput</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>pwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    current<span class="token operator">-&gt;</span>pwd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">iput</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    current<span class="token operator">-&gt;</span>root <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    current<span class="token operator">-&gt;</span>state <span class="token operator">=</span> TASK_ZOMBIE<span class="token punctuation">;</span>
    current<span class="token operator">-&gt;</span>exit_code <span class="token operator">=</span> code<span class="token punctuation">;</span>
    <span class="token function">tell_father</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>father<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在清理进程的 pwd 和 root 之前，释放 pwd 和 root，递减它们的 i_count（在 fork 时，子进程会拷贝父进程的 pwd 和 root，并递增它们的 i_count）。</p> 
<pre><code class="prism language-c"><span class="token comment">// namei.c</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span><span class="token function">get_dir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    inode<span class="token operator">-&gt;</span>i_count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        thisname <span class="token operator">=</span> pathname<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">S_ISDIR</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_mode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">permission</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> MAY_EXEC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">iput</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        c <span class="token operator">=</span> <span class="token function">get_fs_byte</span><span class="token punctuation">(</span>pathname<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>namelen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> namelen<span class="token operator">++</span><span class="token punctuation">)</span>
            c <span class="token operator">=</span> <span class="token function">get_fs_byte</span><span class="token punctuation">(</span>pathname<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>c<span class="token punctuation">)</span>
            <span class="token keyword">return</span> inode<span class="token punctuation">;</span>
        bh <span class="token operator">=</span> <span class="token function">find_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inode<span class="token punctuation">,</span> thisname<span class="token punctuation">,</span> namelen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">iput</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        inr <span class="token operator">=</span> de<span class="token operator">-&gt;</span>inode<span class="token punctuation">;</span>
        idev <span class="token operator">=</span> inode<span class="token operator">-&gt;</span>i_dev<span class="token punctuation">;</span>
        <span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">iput</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inode <span class="token operator">=</span> <span class="token function">iget</span><span class="token punctuation">(</span>idev<span class="token punctuation">,</span> inr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inode<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当解析文件路径出错或读取新的 inode 时，需要释放原来的 inode。iput 会使 inode 的 i_count 减1，iget 会使 inode 的 i_count 加1。我们要保证在 get_dir 函数运行结束后，除文件所在目录以外，其他目录的 inode 的 i_count 保持不变。</p> 
<pre><code class="prism language-c"><span class="token comment">// namei.c</span>
<span class="token keyword">int</span> <span class="token function">open_namei</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span><span class="token operator">*</span>res_inode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    dir <span class="token operator">=</span> <span class="token function">dir_namei</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>namelen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>basename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>namelen<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">iput</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EISDIR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    bh <span class="token operator">=</span> <span class="token function">find_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dir<span class="token punctuation">,</span> basename<span class="token punctuation">,</span> namelen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">iput</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    inr <span class="token operator">=</span> de<span class="token operator">-&gt;</span>inode<span class="token punctuation">;</span>
    dev <span class="token operator">=</span> dir<span class="token operator">-&gt;</span>i_dev<span class="token punctuation">;</span>
    <span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iput</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

    inode <span class="token operator">=</span> <span class="token function">iget</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> inr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inode<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EACCES<span class="token punctuation">;</span>
    
    inode<span class="token operator">-&gt;</span>i_atime <span class="token operator">=</span> CURRENT_TIME<span class="token punctuation">;</span>
    <span class="token operator">*</span>res_inode <span class="token operator">=</span> inode<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 open_namei 函数中，我们需要保证只有目标文件的 inode 的 i_count 加1，目录的 i_count 保持不变。</p> 
<p>接下来完善 close 系统调用。</p> 
<pre><code class="prism language-c"><span class="token comment">// sys.h</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">sys_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fn_ptr sys_call_table<span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>sys_setup<span class="token punctuation">,</span> sys_exit<span class="token punctuation">,</span> sys_fork<span class="token punctuation">,</span> sys_read<span class="token punctuation">,</span> sys_write<span class="token punctuation">,</span> sys_open<span class="token punctuation">,</span> sys_close<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sys_pause<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sys_dup<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// unistd.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__NR_close</span>  <span class="token expression"><span class="token number">6</span></span></span>
<span class="token keyword">int</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">int</span> fildes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// close.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__LIBRARY__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token function">_syscall1</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> close<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span>

<span class="token comment">// main.c</span>
<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">75</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/tty0"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/usr/root/hello.c"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这一节没有测试结果。</p> 
<p>这一章的内容到此为止，需要掌握和理解的知识点有很多，需要大家多看看代码。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3edb2a381be94d597d2f91d29acbed56/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">macOs安装mysql5.7，并修改字符问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0d71fdb0502537574036bc99f038688a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【英语七下】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>