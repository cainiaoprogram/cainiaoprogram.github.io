<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mac 自动化执行脚本 Expect - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Mac 自动化执行脚本 Expect" />
<meta property="og:description" content="环境 Mac
安装expect brew install expect 使用 传参 # 表示获取执行脚本命名空格后第一个参数 set user [lindex $argv 0] 实际应用例子 ssh自动登录 #!/usr/bin/expect set user root set ipaddress 120.76.xx.xx set passwd xxx set timeout 30 spawn ssh $user@$ipaddress expect { &#34;*password:&#34; { send &#34;$passwd\r&#34; } &#34;yes/no&#34; { send &#34;yes\r&#34;;exp_continue } } interact 或
#!/usr/bin/expect -f spawn ssh -p 22 developer@120.76.103.192 expect &#34;*password:&#34; send &#34;Sound318\r&#34; interact #操作完成 scp传输例子
#!/usr/bin/expect set user root set user host set pwd 123pwd set from_path 120." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/add66d00066930bfe49408a0589c5603/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-08-18T07:00:39+08:00" />
<meta property="article:modified_time" content="2017-08-18T07:00:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Mac 自动化执行脚本 Expect</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3 id="环境">环境</h3> 
<p>Mac</p> 
<h3 id="安装expect">安装expect</h3> 
<pre class="prettyprint"><code class=" hljs cmake">brew <span class="hljs-keyword">install</span> expect</code></pre> 
<h3 id="使用">使用</h3> 
<h4 id="传参">传参</h4> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-comment"># 表示获取执行脚本命名空格后第一个参数</span>
<span class="hljs-keyword">set</span> user [lindex <span class="hljs-variable">$argv</span> <span class="hljs-number">0</span>]</code></pre> 
<h3 id="实际应用例子">实际应用例子</h3> 
<p>ssh自动登录 </p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-comment">#!/usr/bin/expect</span>
<span class="hljs-keyword">set</span> user root  
<span class="hljs-keyword">set</span> ipaddress <span class="hljs-number">120.76</span>.xx.xx
<span class="hljs-keyword">set</span> passwd xxx
<span class="hljs-keyword">set</span> timeout <span class="hljs-number">30</span>

spawn ssh <span class="hljs-variable">$user</span>@<span class="hljs-variable">$ipaddress</span>
expect {
    <span class="hljs-string">"*password:"</span> { send <span class="hljs-string">"<span class="hljs-variable">$passwd</span>\r"</span> }
    <span class="hljs-string">"yes/no"</span> { send <span class="hljs-string">"yes\r"</span>;exp_<span class="hljs-keyword">continue</span> }
}
interact</code></pre> 
<p>或</p> 
<pre class="prettyprint"><code class=" hljs d"><span class="hljs-shebang">#!/usr/bin/expect -f</span>
spawn ssh -p <span class="hljs-number">22</span> developer@<span class="hljs-number">120.76</span>.103.192 
expect <span class="hljs-string">"*password:"</span>
send <span class="hljs-string">"Sound318\r"</span>
interact #操作完成</code></pre> 
<p>scp传输例子</p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-comment">#!/usr/bin/expect </span>
<span class="hljs-keyword">set</span> user root  
<span class="hljs-keyword">set</span> user host  
<span class="hljs-keyword">set</span> <span class="hljs-built_in">pwd</span> <span class="hljs-number">123</span><span class="hljs-built_in">pwd</span>
<span class="hljs-keyword">set</span> from_path <span class="hljs-number">120.76</span>.xx.xx
<span class="hljs-keyword">set</span> to_path xxx

spawn scp <span class="hljs-variable">$from_path</span> <span class="hljs-variable">$user</span>@<span class="hljs-variable">$host</span>:<span class="hljs-variable">$to_path</span>
expect {
    <span class="hljs-string">"*password:"</span> { send <span class="hljs-string">"<span class="hljs-variable">$pwd</span>\n"</span> }
}
interact</code></pre> 
<h3 id="录制脚本">录制脚本</h3> 
<p>可以使用提供的脚本进行录制 </p> 
<p>vim autoexpect.exp</p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-comment">#!/usr/bin/expect --</span>
<span class="hljs-comment"># Name: autoexpect - generate an Expect script from watching a session</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Description:</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Given a program name, autoexpect will run that program.  Otherwise</span>
<span class="hljs-comment"># autoexpect will start a shell.  Interact as desired.  When done, exit</span>
<span class="hljs-comment"># the program or shell.  Autoexpect will create a script that reproduces</span>
<span class="hljs-comment"># your interactions.  By default, the script is named script.exp.</span>
<span class="hljs-comment"># See the man page for more info.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Author: Don Libes, NIST</span>
<span class="hljs-comment"># Date: June 30 1995</span>
<span class="hljs-comment"># Version: 1.4b</span>

<span class="hljs-keyword">set</span> filename <span class="hljs-string">"script.exp"</span>
<span class="hljs-keyword">set</span> verbose <span class="hljs-number">1</span>
<span class="hljs-keyword">set</span> conservative <span class="hljs-number">0</span>
<span class="hljs-keyword">set</span> promptmode <span class="hljs-number">0</span>
<span class="hljs-keyword">set</span> option_keys <span class="hljs-string">""</span>

proc check_<span class="hljs-keyword">for</span>_following {<!-- --><span class="hljs-built_in">type</span>} {
    <span class="hljs-keyword">if</span> ![llength [uplevel <span class="hljs-keyword">set</span> argv]] {
        puts <span class="hljs-string">"autoexpect: [uplevel set flag] requires following <span class="hljs-variable">$type</span>"</span>
        <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
    }
}    

<span class="hljs-keyword">while</span> {[llength <span class="hljs-variable">$argv</span>]&gt;<span class="hljs-number">0</span>} {
    <span class="hljs-keyword">set</span> flag [lindex <span class="hljs-variable">$argv</span> <span class="hljs-number">0</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span>==[regexp <span class="hljs-string">"^-"</span> <span class="hljs-variable">$flag</span>] <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">set</span> argv [lrange <span class="hljs-variable">$argv</span> <span class="hljs-number">1</span> end]
    switch -- <span class="hljs-variable">$flag</span> \
      <span class="hljs-string">"-c"</span> {
        <span class="hljs-keyword">set</span> conservative <span class="hljs-number">1</span>
    } <span class="hljs-string">"-C"</span> {
        check_<span class="hljs-keyword">for</span>_following character
        lappend option_keys [lindex <span class="hljs-variable">$argv</span> <span class="hljs-number">0</span>] ctoggle
        <span class="hljs-keyword">set</span> argv [lrange <span class="hljs-variable">$argv</span> <span class="hljs-number">1</span> end]
    } <span class="hljs-string">"-p"</span> {
        <span class="hljs-keyword">set</span> promptmode <span class="hljs-number">1</span>
    } <span class="hljs-string">"-P"</span> {
        check_<span class="hljs-keyword">for</span>_following character
        lappend option_keys [lindex <span class="hljs-variable">$argv</span> <span class="hljs-number">0</span>] ptoggle
        <span class="hljs-keyword">set</span> argv [lrange <span class="hljs-variable">$argv</span> <span class="hljs-number">1</span> end]
    } <span class="hljs-string">"-Q"</span> {
        check_<span class="hljs-keyword">for</span>_following character
        lappend option_keys [lindex <span class="hljs-variable">$argv</span> <span class="hljs-number">0</span>] quote
        <span class="hljs-keyword">set</span> argv [lrange <span class="hljs-variable">$argv</span> <span class="hljs-number">1</span> end]
    } <span class="hljs-string">"-f"</span> {
        check_<span class="hljs-keyword">for</span>_following filename
        <span class="hljs-keyword">set</span> filename [lindex <span class="hljs-variable">$argv</span> <span class="hljs-number">0</span>]
        <span class="hljs-keyword">set</span> argv [lrange <span class="hljs-variable">$argv</span> <span class="hljs-number">1</span> end]
    } <span class="hljs-string">"-quiet"</span> {
        <span class="hljs-keyword">set</span> verbose <span class="hljs-number">0</span>
    } default {
        <span class="hljs-keyword">break</span>
    }
}

<span class="hljs-comment">#############################################################</span>
<span class="hljs-comment"># Variables    Descriptions</span>
<span class="hljs-comment">#############################################################</span>
<span class="hljs-comment"># userbuf    buffered characters from user</span>
<span class="hljs-comment"># procbuf    buffered characters from process</span>
<span class="hljs-comment"># lastkey    last key pressed by user</span>
<span class="hljs-comment">#        if undefined, last key came from process</span>
<span class="hljs-comment"># echoing    if the process is echoing</span>
<span class="hljs-comment">#############################################################</span>

<span class="hljs-comment"># Handle a character that came from user input (i.e., the keyboard)</span>
proc input {c} {
    global userbuf lastkey

    send -- <span class="hljs-variable">$c</span>
    append userbuf <span class="hljs-variable">$lastkey</span>
    <span class="hljs-keyword">set</span> lastkey <span class="hljs-variable">$c</span>
}

<span class="hljs-comment"># Handle a null character from the keyboard</span>
proc input_null {} {
    global lastkey userbuf procbuf echoing

    send -null

    <span class="hljs-keyword">if</span> {<!-- --><span class="hljs-variable">$lastkey</span> == <span class="hljs-string">""</span>} {
        <span class="hljs-keyword">if</span> <span class="hljs-variable">$echoing</span> {
            sendcmd <span class="hljs-string">"<span class="hljs-variable">$userbuf</span>"</span>
        }
        <span class="hljs-keyword">if</span> {<!-- --><span class="hljs-variable">$procbuf</span> != <span class="hljs-string">""</span>} {
            expcmd <span class="hljs-string">"<span class="hljs-variable">$procbuf</span>"</span>
        }
    } <span class="hljs-keyword">else</span> {
        sendcmd <span class="hljs-string">"<span class="hljs-variable">$userbuf</span>"</span>
        <span class="hljs-keyword">if</span> <span class="hljs-variable">$echoing</span> {
            expcmd <span class="hljs-string">"<span class="hljs-variable">$procbuf</span>"</span>
            sendcmd <span class="hljs-string">"<span class="hljs-variable">$lastkey</span>"</span>
        }            
    }
    cmd <span class="hljs-string">"send -null"</span>
    <span class="hljs-keyword">set</span> userbuf <span class="hljs-string">""</span>
    <span class="hljs-keyword">set</span> procbuf <span class="hljs-string">""</span>
    <span class="hljs-keyword">set</span> lastkey <span class="hljs-string">""</span>
    <span class="hljs-keyword">set</span> echoing <span class="hljs-number">0</span>
}

<span class="hljs-comment"># Handle a character that came from the process</span>
proc output {s} {
    global lastkey procbuf userbuf echoing

    send_user -raw -- <span class="hljs-variable">$s</span>

    <span class="hljs-keyword">if</span> {<!-- --><span class="hljs-variable">$lastkey</span> == <span class="hljs-string">""</span>} {
        <span class="hljs-keyword">if</span> !<span class="hljs-variable">$echoing</span> {
            append procbuf <span class="hljs-variable">$s</span>
        } <span class="hljs-keyword">else</span> {
            sendcmd <span class="hljs-string">"<span class="hljs-variable">$userbuf</span>"</span>
            expcmd <span class="hljs-string">"<span class="hljs-variable">$procbuf</span>"</span>
            <span class="hljs-keyword">set</span> echoing <span class="hljs-number">0</span>
            <span class="hljs-keyword">set</span> userbuf <span class="hljs-string">""</span>
            <span class="hljs-keyword">set</span> procbuf <span class="hljs-variable">$s</span>
        }
        <span class="hljs-keyword">return</span>
    }

    regexp (.)(.*) <span class="hljs-variable">$s</span> dummy c tail
    <span class="hljs-keyword">if</span> {<!-- --><span class="hljs-variable">$c</span> == <span class="hljs-variable">$lastkey</span>} {
        <span class="hljs-keyword">if</span> <span class="hljs-variable">$echoing</span> {
            append userbuf <span class="hljs-variable">$lastkey</span>
            <span class="hljs-keyword">set</span> lastkey <span class="hljs-string">""</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> {<!-- --><span class="hljs-variable">$procbuf</span> != <span class="hljs-string">""</span>} {
                expcmd <span class="hljs-string">"<span class="hljs-variable">$procbuf</span>"</span>
                <span class="hljs-keyword">set</span> procbuf <span class="hljs-string">""</span>
            }
            <span class="hljs-keyword">set</span> echoing <span class="hljs-number">1</span>
        }
        append procbuf <span class="hljs-variable">$s</span>

        <span class="hljs-keyword">if</span> [string length <span class="hljs-variable">$tail</span>] {
            sendcmd <span class="hljs-string">"<span class="hljs-variable">$userbuf</span><span class="hljs-variable">$lastkey</span>"</span>
            <span class="hljs-keyword">set</span> userbuf <span class="hljs-string">""</span>
            <span class="hljs-keyword">set</span> lastkey <span class="hljs-string">""</span>
            <span class="hljs-keyword">set</span> echoing <span class="hljs-number">0</span>
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> !<span class="hljs-variable">$echoing</span> {
            expcmd <span class="hljs-string">"<span class="hljs-variable">$procbuf</span>"</span>
        }
        sendcmd <span class="hljs-string">"<span class="hljs-variable">$userbuf</span><span class="hljs-variable">$lastkey</span>"</span>
        <span class="hljs-keyword">set</span> procbuf <span class="hljs-variable">$s</span>
        <span class="hljs-keyword">set</span> userbuf <span class="hljs-string">""</span>
        <span class="hljs-keyword">set</span> lastkey <span class="hljs-string">""</span>
        <span class="hljs-keyword">set</span> echoing <span class="hljs-number">0</span>
    }
}

<span class="hljs-comment"># rewrite raw strings so that can appear as source code but still reproduce</span>
<span class="hljs-comment"># themselves.</span>
proc expand {s} {
    regsub -all <span class="hljs-string">"\\\\"</span> <span class="hljs-variable">$s</span> <span class="hljs-string">"\\\\\\\\"</span> s
    regsub -all <span class="hljs-string">"\r"</span> <span class="hljs-variable">$s</span> <span class="hljs-string">"\\r"</span>  s
    regsub -all <span class="hljs-string">"\""</span> <span class="hljs-variable">$s</span> <span class="hljs-string">"\\\""</span> s
    regsub -all <span class="hljs-string">"\\\["</span> <span class="hljs-variable">$s</span> <span class="hljs-string">"\\\["</span> s
    regsub -all <span class="hljs-string">"\\\]"</span> <span class="hljs-variable">$s</span> <span class="hljs-string">"\\\]"</span> s
    regsub -all <span class="hljs-string">"\\\$"</span> <span class="hljs-variable">$s</span> <span class="hljs-string">"\\\$"</span> s

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$s</span>
}

<span class="hljs-comment"># generate an expect command</span>
proc expcmd {s} {
    global promptmode

    <span class="hljs-keyword">if</span> <span class="hljs-variable">$promptmode</span> {
        regexp <span class="hljs-string">".*\[\r\n]+(.*)"</span> <span class="hljs-variable">$s</span> dummy s
    }

    cmd <span class="hljs-string">"expect -exact \"[expand <span class="hljs-variable">$s</span>]\""</span>
}

<span class="hljs-comment"># generate a send command</span>
proc sendcmd {s} {
    global send_style conservative

    <span class="hljs-keyword">if</span> {<!-- --><span class="hljs-variable">$conservative</span>} {
        cmd <span class="hljs-string">"sleep .1"</span>
    }

    cmd <span class="hljs-string">"send<span class="hljs-variable">$send_style</span> -- \"[expand <span class="hljs-variable">$s</span>]\""</span>
}

<span class="hljs-comment"># generate any command</span>
proc cmd {s} {
    global fd
    puts <span class="hljs-variable">$fd</span> <span class="hljs-string">"<span class="hljs-variable">$s</span>"</span>
}

proc verbose_send_user {s} {
    global verbose

    <span class="hljs-keyword">if</span> <span class="hljs-variable">$verbose</span> {
        send_user -- <span class="hljs-variable">$s</span>
    }
}

proc ctoggle {} {
    global conservative send_style

    <span class="hljs-keyword">if</span> <span class="hljs-variable">$conservative</span> {
        cmd <span class="hljs-string">"# conservative mode off - adding no delays"</span>
        verbose_send_user <span class="hljs-string">"conservative mode off\n"</span>
        <span class="hljs-keyword">set</span> conservative <span class="hljs-number">0</span>
        <span class="hljs-keyword">set</span> send_style <span class="hljs-string">""</span>
    } <span class="hljs-keyword">else</span> {
        cmd <span class="hljs-string">"# prompt mode on - adding delays"</span>
        verbose_send_user <span class="hljs-string">"conservative mode on\n"</span>
        <span class="hljs-keyword">set</span> conservative <span class="hljs-number">1</span>
        <span class="hljs-keyword">set</span> send_style <span class="hljs-string">" -s"</span>
    }
}

proc ptoggle {} {
    global promptmode

    <span class="hljs-keyword">if</span> <span class="hljs-variable">$promptmode</span> {
        cmd <span class="hljs-string">"# prompt mode off - now looking for complete output"</span>
        verbose_send_user <span class="hljs-string">"prompt mode off\n"</span>
        <span class="hljs-keyword">set</span> promptmode <span class="hljs-number">0</span>
    } <span class="hljs-keyword">else</span> {
        cmd <span class="hljs-string">"# prompt mode on - now looking only for prompts"</span>
        verbose_send_user <span class="hljs-string">"prompt mode on\n"</span>
        <span class="hljs-keyword">set</span> promptmode <span class="hljs-number">1</span>
    }
}

<span class="hljs-comment"># quote the next character from the user</span>
proc quote {} {
    expect_user -re .
    send -- <span class="hljs-variable">$expect_out</span>(buffer)
}


<span class="hljs-keyword">if</span> [catch {<!-- --><span class="hljs-keyword">set</span> fd [open <span class="hljs-variable">$filename</span> w]} msg] {
    puts <span class="hljs-variable">$msg</span>
    <span class="hljs-keyword">exit</span>
}
<span class="hljs-keyword">exec</span> chmod +x <span class="hljs-variable">$filename</span>
verbose_send_user <span class="hljs-string">"autoexpect started, file is <span class="hljs-variable">$filename</span>\n"</span>

<span class="hljs-comment"># calculate a reasonable #! line</span>
<span class="hljs-keyword">set</span> expectpath /usr/local/bin        ;<span class="hljs-comment"># prepare default</span>
foreach dir [split <span class="hljs-variable">$env</span>(PATH) :] {    ;<span class="hljs-comment"># now look for real location</span>
    <span class="hljs-keyword">if</span> [file executable <span class="hljs-variable">$dir</span>/expect] {
        <span class="hljs-keyword">set</span> expectpath <span class="hljs-variable">$dir</span>
        <span class="hljs-keyword">break</span>
    }
}

cmd <span class="hljs-string">"#![set expectpath]/expect -f
#
# This Expect script was generated by autoexpect on [timestamp -format %c]
# Expect and autoexpect were both written by Don Libes, NIST."</span>
cmd {<!-- --><span class="hljs-comment">#</span>
<span class="hljs-comment"># Note that autoexpect does not guarantee a working script.  It</span>
<span class="hljs-comment"># necessarily has to guess about certain things.  Two reasons a script</span>
<span class="hljs-comment"># might fail are:</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># 1) timing - A surprising number of programs (rn, ksh, zsh, telnet,</span>
<span class="hljs-comment"># etc.) and devices discard or ignore keystrokes that arrive "too</span>
<span class="hljs-comment"># quickly" after prompts.  If you find your new script hanging up at</span>
<span class="hljs-comment"># one spot, try adding a short sleep just before the previous send.</span>
<span class="hljs-comment"># Setting "force_conservative" to 1 (see below) makes Expect do this</span>
<span class="hljs-comment"># automatically - pausing briefly before sending each character.  This</span>
<span class="hljs-comment"># pacifies every program I know of.  The -c flag makes the script do</span>
<span class="hljs-comment"># this in the first place.  The -C flag allows you to define a</span>
<span class="hljs-comment"># character to toggle this mode off and on.</span>

<span class="hljs-keyword">set</span> force_conservative <span class="hljs-number">0</span>  ;<span class="hljs-comment"># set to 1 to force conservative mode even if</span>
              ;<span class="hljs-comment"># script wasn't run conservatively originally</span>
<span class="hljs-keyword">if</span> {<!-- --><span class="hljs-variable">$force_conservative</span>} {
    <span class="hljs-keyword">set</span> send_slow {<!-- --><span class="hljs-number">1</span> .<span class="hljs-number">1</span>}
    proc send {ignore arg} {
        sleep .<span class="hljs-number">1</span>
        exp_send <span class="hljs-operator">-s</span> -- <span class="hljs-variable">$arg</span>
    }
}

<span class="hljs-comment">#</span>
<span class="hljs-comment"># 2) differing output - Some programs produce different output each time</span>
<span class="hljs-comment"># they run.  The "date" command is an obvious example.  Another is</span>
<span class="hljs-comment"># ftp, if it produces throughput statistics at the end of a file</span>
<span class="hljs-comment"># transfer.  If this causes a problem, delete these patterns or replace</span>
<span class="hljs-comment"># them with wildcards.  An alternative is to use the -p flag (for</span>
<span class="hljs-comment"># "prompt") which makes Expect only look for the last line of output</span>
<span class="hljs-comment"># (i.e., the prompt).  The -P flag allows you to define a character to</span>
<span class="hljs-comment"># toggle this mode off and on.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Read the man page for more info.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># -Don</span>

}

cmd <span class="hljs-string">"set timeout -1"</span>
<span class="hljs-keyword">if</span> <span class="hljs-variable">$conservative</span> {
    <span class="hljs-keyword">set</span> send_style <span class="hljs-string">" -s"</span>
    cmd <span class="hljs-string">"set send_slow {1 .1}"</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">set</span> send_style <span class="hljs-string">""</span>
}

<span class="hljs-keyword">if</span> [llength <span class="hljs-variable">$argv</span>]&gt;<span class="hljs-number">0</span> {
    <span class="hljs-built_in">eval</span> spawn -noecho <span class="hljs-variable">$argv</span>
    cmd <span class="hljs-string">"spawn <span class="hljs-variable">$argv</span>"</span>
} <span class="hljs-keyword">else</span> {
    spawn -noecho <span class="hljs-variable">$env</span>(SHELL)
    cmd <span class="hljs-string">"spawn \$env(SHELL)"</span>
}

cmd <span class="hljs-string">"match_max 100000"</span>

<span class="hljs-keyword">set</span> lastkey <span class="hljs-string">""</span>
<span class="hljs-keyword">set</span> procbuf <span class="hljs-string">""</span>
<span class="hljs-keyword">set</span> userbuf <span class="hljs-string">""</span>
<span class="hljs-keyword">set</span> echoing <span class="hljs-number">0</span>

remove_nulls <span class="hljs-number">0</span>

<span class="hljs-built_in">eval</span> interact <span class="hljs-variable">$option_keys</span> {
    -re . {
        input <span class="hljs-variable">$interact_out</span>(<span class="hljs-number">0</span>,string)
    } null {
        input_null
    } \
    -o \
    -re .+ {
        output <span class="hljs-variable">$interact_out</span>(<span class="hljs-number">0</span>,string)
    } eof {
        cmd <span class="hljs-string">"expect eof"</span>
        <span class="hljs-keyword">return</span>
    } null {
    }
}

close <span class="hljs-variable">$fd</span>
verbose_send_user <span class="hljs-string">"autoexpect done, file is <span class="hljs-variable">$filename</span>\n"</span></code></pre> 
<p>执行</p> 
<pre class="prettyprint"><code class=" hljs vbscript"># <span class="hljs-keyword">exit</span>退出，会在当前目录生成一个script.<span class="hljs-built_in">exp</span>文件
expect autoexpect.<span class="hljs-built_in">exp</span> -p</code></pre> 
<h3 id="自己使用例子">自己使用例子</h3> 
<h4 id="打包上传dev备份重启">打包、上传dev、备份、重启</h4> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-comment">#!/usr/local/bin/expect -f</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Auto pack, scp, restart app by expect.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Use example:</span>
<span class="hljs-comment">#   ./pack_dev.sh developer 192.140.12.2 pwd /java/workspace-idea-soundbus/bet-game-service /java/workspace-idea-soundbus/bet-game-service/bet-game/target/bet-game.jar /home/developer/sunbar/bet-game-service/bet-game-$(date +'%Y%m%d').jar bet-game /home/developer/sunbar/bet-game-service</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Init env(mac os):</span>
<span class="hljs-comment">#   brew install expect</span>
<span class="hljs-comment"># </span>
<span class="hljs-comment"># Created by suzhida on 2017-08-06 14:47:11</span>

<span class="hljs-keyword">set</span> service_user [lindex <span class="hljs-variable">$argv</span> <span class="hljs-number">0</span>]
<span class="hljs-keyword">set</span> service_ip [lindex <span class="hljs-variable">$argv</span> <span class="hljs-number">1</span>]
<span class="hljs-keyword">set</span> service_<span class="hljs-built_in">pwd</span> [lindex <span class="hljs-variable">$argv</span> <span class="hljs-number">2</span>]

<span class="hljs-keyword">set</span> pack_path [lindex <span class="hljs-variable">$argv</span> <span class="hljs-number">3</span>]
<span class="hljs-keyword">set</span> scp_<span class="hljs-built_in">source</span>_path [lindex <span class="hljs-variable">$argv</span> <span class="hljs-number">4</span>]
<span class="hljs-keyword">set</span> scp_to_path [lindex <span class="hljs-variable">$argv</span> <span class="hljs-number">5</span>]
<span class="hljs-keyword">set</span> app_name [lindex <span class="hljs-variable">$argv</span> <span class="hljs-number">6</span>]
<span class="hljs-keyword">set</span> service_app_path [lindex <span class="hljs-variable">$argv</span> <span class="hljs-number">7</span>]

<span class="hljs-keyword">set</span> timeout -<span class="hljs-number">1</span>
<span class="hljs-comment"># bash shell</span>
spawn <span class="hljs-variable">$env</span>(SHELL)
match_max <span class="hljs-number">100000</span>
expect -exact <span class="hljs-string">""</span>

<span class="hljs-comment"># pack</span>
send -- <span class="hljs-string">"cd <span class="hljs-variable">$pack_path</span>\r"</span>
expect -exact <span class="hljs-string">"cd <span class="hljs-variable">$pack_path</span>"</span>
send -- <span class="hljs-string">"mvn clean install -Dskip.unit.tests=true\r"</span>
expect -exact <span class="hljs-string">"mvn clean install -Dskip.unit.tests=true"</span>

<span class="hljs-comment"># scp </span>
send -- <span class="hljs-string">"scp <span class="hljs-variable">$scp_source_path</span> <span class="hljs-variable">$service_user</span>@<span class="hljs-variable">$service_ip</span>:<span class="hljs-variable">$scp_to_path</span>\r"</span>
expect -exact <span class="hljs-string">"<span class="hljs-variable">$service_user</span>@<span class="hljs-variable">$service_ip</span>'s password: "</span>
send -- <span class="hljs-string">"<span class="hljs-variable">$service_pwd</span>\r"</span>
expect -exact <span class="hljs-string">""</span>

<span class="hljs-comment"># restart app</span>
send -- <span class="hljs-string">"ssh -p 22 <span class="hljs-variable">$service_user</span>@<span class="hljs-variable">$service_ip</span>\r"</span>
expect -exact <span class="hljs-string">"<span class="hljs-variable">$service_user</span>@<span class="hljs-variable">$service_ip</span>'s password: "</span>
send -- <span class="hljs-string">"<span class="hljs-variable">$service_pwd</span>\r"</span>
expect -exact <span class="hljs-string">""</span>
send -- <span class="hljs-string">"cd <span class="hljs-variable">$service_app_path</span>\r"</span>
expect -exact <span class="hljs-string">""</span>
send -- <span class="hljs-string">"ln -sf <span class="hljs-variable">$service_app_path</span>-\$(date +'%Y%m%d').jar <span class="hljs-variable">$service_app_path</span>-current.jar\r"</span>
expect -exact <span class="hljs-string">""</span>
send -- <span class="hljs-string">"./boot.sh\r"</span>
expect -exact <span class="hljs-string">""</span>
send -- <span class="hljs-string">"tailf log/spring.log\r"</span>
expect -exact <span class="hljs-string">""</span>

<span class="hljs-comment"># done </span>
interact</code></pre> 
<hr> 
<p>1) <a href="https://zh.wikipedia.org/wiki/Expect" rel="nofollow noopener noreferrer" target="_blank">维基百科介绍</a> <br> 2) <a href="http://expect.nist.gov" rel="nofollow noopener noreferrer" target="_blank">官网</a> <br> 3) <a href="http://blog.csdn.net/wangdeng1314/article/details/7289938" target="_blank" rel="noopener noreferrer">使用expect工具ssh登录远程服务器并执行命令操作</a> <br> 4) <a href="http://www.cnblogs.com/iloveyoucc/archive/2012/05/11/2496433.html" rel="nofollow noopener noreferrer" target="_blank">expect用法</a> <br> 5) <a href="http://www.cnblogs.com/lzrabbit/p/4298794.html" rel="nofollow noopener noreferrer" target="_blank">linux expect详解</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/73889aa31a21258e80b299478c23b243/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python3《机器学习实战》学习笔记（四）：朴素贝叶斯基础篇之言论过滤器</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3f1440343ef7181dbddcb09c1105203e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">&lt;input&gt;type=&#39;file&#39; 标签选取文件/文件夹</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>