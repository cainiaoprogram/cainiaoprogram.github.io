<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>如何用 Nginx 代理 MySQL 连接，并限制可访问IP？ - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="如何用 Nginx 代理 MySQL 连接，并限制可访问IP？" />
<meta property="og:description" content="1.前言 我们的生产环境基本上都部署在云服务器上，例如应用服务器、MySQL服务器等。如果MySQL服务器直接暴露在公网，就会存在很大的风险，为了保证数据安全，MySQL服务器的端口是不对外开放的。
好巧不巧，线上业务遇到bug了，开发的小伙伴需要远程连接MySQL来查看数据，那应该怎么办呢？
我们可以通过Nginx代理（“跳板机”）来进行连接。
2.Nginx代理连接 要实现对连接的代理转发，我们需要一台服务器并安装Nginx，且与MySQL服务器处于一个内网之中，内网之间可以访问。
其次，我们需要用到ngx_stream_core_module模块，该模块不是默认构建的，我们需要在configure时添加--with-stream来进行构建。
添加过程可以参照【Nginx基本命令&amp;不停机版本升级】一文进行，我们这里不再赘述。
既然要用到ngx_stream_core_module模块，首当其冲，是看看其提供的指令，我们才知道怎么来进行配置。
1）stream 该指令定义了stream服务器。与http块平级，定义在main块中。
作用域：main
语法：stream {...}
示例：
stream { server { ...... } } 2）server 该指令定义一个虚拟主机，与http块中的server类似。我们可以在stream块中定义多个server块。
作用域：stream
语法：server {...}
stream { server { ...... } server { ...... } } 3）listen 该指令定义虚拟主机server要监听的socket的地址和端口。
作用域：server
语法：listen address:port;
示例：
listen 127.0.0.1:3306; listen *:3306; # 效果与listen *:3306一样 listen 3306; listen localhost:3306; 4）配置示例 MySQL服务器，端口3306（单机环境）
stream { server { listen 3306; proxy_pass 192.168.110.101:3306; } } MySQL服务器，端口3306（集群环境）
stream { upstream mysql_socket { server 192." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a7081c9239d4800750db0f8bc9329256/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-27T20:39:41+08:00" />
<meta property="article:modified_time" content="2023-07-27T20:39:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">如何用 Nginx 代理 MySQL 连接，并限制可访问IP？</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>1.前言</h3> 
<p>我们的生产环境基本上都部署在云服务器上，例如应用服务器、MySQL服务器等。如果MySQL服务器直接暴露在公网，就会存在很大的风险，为了保证数据安全，MySQL服务器的端口是不对外开放的。</p> 
<p>好巧不巧，线上业务遇到bug了，开发的小伙伴需要远程连接MySQL来查看数据，那应该怎么办呢？</p> 
<p>我们可以通过Nginx代理（“跳板机”）来进行连接。</p> 
<h3>2.Nginx代理连接</h3> 
<p>要实现对连接的代理转发，我们需要一台服务器并安装Nginx，且与MySQL服务器处于一个内网之中，内网之间可以访问。</p> 
<p>其次，我们需要用到<code>ngx_stream_core_module</code>模块，该模块不是默认构建的，我们需要在configure时添加<code>--with-stream</code>来进行构建。</p> 
<p>添加过程可以参照【Nginx基本命令&amp;不停机版本升级】一文进行，我们这里不再赘述。</p> 
<p>既然要用到<code>ngx_stream_core_module</code>模块，首当其冲，是看看其提供的指令，我们才知道怎么来进行配置。</p> 
<h4>1）stream</h4> 
<p>该指令定义了stream服务器。与http块平级，定义在main块中。</p> 
<ul><li> <p>作用域：main</p> </li><li> <p>语法：stream {...}</p> </li></ul> 
<p>示例：</p> 
<pre><code> stream {
     server {
         ......
     }
 }
</code></pre> 
<h4>2）server</h4> 
<p>该指令定义一个虚拟主机，与http块中的server类似。我们可以在stream块中定义多个server块。</p> 
<ul><li> <p>作用域：stream</p> </li><li> <p>语法：server {...}</p> </li></ul> 
<pre><code>stream {
     server {
         ......
     }
     server {
         ......
     }
 }
</code></pre> 
<h4>3）listen</h4> 
<p>该指令定义虚拟主机server要监听的socket的地址和端口。</p> 
<ul><li> <p>作用域：server</p> </li><li> <p>语法：listen address:port;</p> </li></ul> 
<p>示例：</p> 
<pre><code>listen 127.0.0.1:3306;
 listen *:3306;
 # 效果与listen *:3306一样
 listen 3306;
 listen localhost:3306;
</code></pre> 
<h4>4）配置示例</h4> 
<p>MySQL服务器，端口3306（单机环境）</p> 
<pre><code>stream  {
     server {
         listen 3306;
         proxy_pass 192.168.110.101:3306;
     }
 }
</code></pre> 
<p>MySQL服务器，端口3306（集群环境）</p> 
<pre><code>stream  {
     upstream mysql_socket {
         server 192.168.110.101:3306;
     }
     server {
             listen 3306;
             proxy_pass mysql_socket;
     }
 }
</code></pre> 
<p>此时，我们就可以通过例如Navicat等客户端进行连接。</p> 
<h3>3.限制访问IP</h3> 
<p>实现了对连接的代理，所有人都可以通过访问Nginx来连接MySQL服务器，解决了外网无法连接的问题。</p> 
<p>为了更进一步的缩小访问范围，保证数据安全，我们可以限制只有公司网络的IP地址可以通过Nginx进行连接。</p> 
<p>Nginx提供了<code>ngx_stream_access_module</code>模块，其指令非常简单，仅包含allow和deny指令。</p> 
<h4>1）allow</h4> 
<p>该指令设置指定的IP允许访问。可以和deny指令配合使用</p> 
<ul><li> <p>作用域：stream, server</p> </li><li> <p>语法：allow address | CIDR | unix: | all;</p> </li></ul> 
<p>示例：</p> 
<pre><code> # 允许192.168.110.1访问
 allow 192.168.110.1;
 
 # 允许192.168.110.1到192.168.255.254
 allow 192.168.110.0/16;
 
 # 允许192.168.110.1到192.168.110.254
 allow 192.168.110.0/24;
 
 # 允许所有的IP访问
 allow all;
</code></pre> 
<h4>2）deny</h4> 
<p>该指令设置指定的IP禁止访问。可以和allow指令配合使用。</p> 
<ul><li> <p>作用域：stream, server</p> </li><li> <p>语法：deny address | CIDR | unix: | all;</p> </li></ul> 
<pre><code># 禁止192.168.110.1访问
 deny 192.168.110.1;
 
 # 禁止192.168.110.1到192.168.255.254
 deny 192.168.110.0/16;
 
 # 禁止192.168.110.1到192.168.110.254
 deny 192.168.110.0/24;
 
 # 禁止所有的IP访问
 deny all;
</code></pre> 
<h4>3）配置示例</h4> 
<p>禁止所有的IP访问，192.168.110.100除外。</p> 
<pre><code>allow 192.168.110.100;
 deny all;
</code></pre> 
<blockquote> 
 <p>Tips：如果指定了allow，需要配合deny使用，否则就是允许所有的IP地址访问。</p> 
</blockquote> 
<h3>4.综合案例</h3> 
<p>只允许192.168.110.100通过Nginx连接MySQL服务器。</p> 
<pre><code>stream  {
     allow 192.168.110.100;
     deny all;
     server {
         listen 3306;
         proxy_pass 192.168.110.101:3306;
     }
 }
</code></pre> 
<blockquote></blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/88008df77b26682e65ec8f02a225243a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Nuxt3项目配置项整理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a0ff16c3aa23fbd8b11fe0cdc82680d7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">同名但是类型不同的bean的BUGorg.springframework.beans.factory.BeanDefinitionStoreException: Failed to parse con</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>