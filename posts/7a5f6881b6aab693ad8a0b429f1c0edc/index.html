<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>openwrt下tcpdump抓取usb数据包 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="openwrt下tcpdump抓取usb数据包" />
<meta property="og:description" content="原文地址::https://blog.csdn.net/m0_38134493/article/details/72723733?utm_source=blogxgwz3
相关文章
1、linux下的usb抓包方法----https://www.cnblogs.com/listenerln/p/7263481.html
2、Linux下Tcpdump使用----https://www.cnblogs.com/hzl6255/p/6147985.html
3、linux下usb抓包方法----https://blog.csdn.net/tommy_ly/article/details/97666028
4、Linux 抓USB包----https://blog.csdn.net/zmnqazqaz/article/details/50497733?utm_source=blogxgwz2
这两天在看USB转串口的驱动，并在想办法解决一个4G设备通过USB插入openwrt后枚举的串口无法收发的问题。看了大概有一个星期了，大概把USB是什么搞清楚了。但是USB的世界实在是太复杂了，除了USB协议本身，枚举出来的设备和系统中的其他总线总是有一腿，才刚接触linux内核的东西，感觉头大，实在不是短时间能啃下来的。好了废话不多说，先看看我处理tcpdump是怎么抓取usb总线数据的吧。
相关软件 openwrt(我用的是bb版本，linux内核3.10.49)wireshark(我用的最新版本2.2.6)tcpdump(抓包神奇)libpcap (tcpdump以来的库)usbmonitor (usb数据包，就靠它了) 一，编译openwrt支持tcpdump和libpcap 1.1, 在 menuconfig中选择tcpdump和libpacap中的usb Network--&gt; [*] tcpdump Libraries--&gt; -*- libpcap--&gt; Configuration---&gt; [*] Include USB support （注意这个一定要选上，否则你别想通过tcpdump抓usb包） 1234567 下面还有一个 tcpdump mini，我没有用，也没管。
1.2, 在menuconfig 中选择usbmointor Kernel modules---&gt; USB support--&gt; [*] kmod-usbmon 123 1.3， 在kernel_menuconig 内核配置中选择usb monitor Device Drivers --&gt; [*] USB support ---&gt; &lt;*&gt; USB Monitor 123 二，执行make编译 三，下载到目标板 具体的板子不一样，我这里就不写了
四，抓包 终于到了抓包了。
4.1，确认一下你的设备在USB哪个总线上 $ cat /sys/kernel/debug/usb/devices T: Bus=01 Lev=01 Prnt=01 Port=00 Cnt=01 Dev#= 2 Spd=12 MxCh= 0 D: Ver= 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7a5f6881b6aab693ad8a0b429f1c0edc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-15T17:06:56+08:00" />
<meta property="article:modified_time" content="2020-12-15T17:06:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">openwrt下tcpdump抓取usb数据包</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>原文地址::<a href="https://blog.csdn.net/m0_38134493/article/details/72723733?utm_source=blogxgwz3">https://blog.csdn.net/m0_38134493/article/details/72723733?utm_source=blogxgwz3</a></p> 
<p>相关文章</p> 
<p>1、<a href="https://www.cnblogs.com/listenerln/p/7263481.html" rel="nofollow" id="cb_post_title_url">linux下的usb抓包方法</a>----<a href="https://www.cnblogs.com/listenerln/p/7263481.html" rel="nofollow">https://www.cnblogs.com/listenerln/p/7263481.html</a></p> 
<p>2、<a href="https://www.cnblogs.com/hzl6255/p/6147985.html" rel="nofollow">Linux下Tcpdump使用</a>----<a href="https://www.cnblogs.com/hzl6255/p/6147985.html" rel="nofollow">https://www.cnblogs.com/hzl6255/p/6147985.html</a></p> 
<p>3、linux下usb抓包方法----<a href="https://blog.csdn.net/tommy_ly/article/details/97666028">https://blog.csdn.net/tommy_ly/article/details/97666028</a></p> 
<p>4、Linux 抓USB包----<a href="https://blog.csdn.net/zmnqazqaz/article/details/50497733?utm_source=blogxgwz2">https://blog.csdn.net/zmnqazqaz/article/details/50497733?utm_source=blogxgwz2</a></p> 
<p> </p> 
<p>这两天在看USB转串口的驱动，并在想办法解决一个4G设备通过USB插入openwrt后枚举的串口无法收发的问题。看了大概有一个星期了，大概把USB是什么搞清楚了。但是USB的世界实在是太复杂了，除了USB协议本身，枚举出来的设备和系统中的其他总线总是有一腿，才刚接触linux内核的东西，感觉头大，实在不是短时间能啃下来的。好了废话不多说，先看看我处理tcpdump是怎么抓取usb总线数据的吧。</p> 
<h3 id="相关软件"><a name="t0"></a>相关软件</h3> 
<ul><li>openwrt(我用的是bb版本，linux内核3.10.49)</li><li>wireshark(我用的最新版本2.2.6)</li><li>tcpdump(抓包神奇)</li><li>libpcap (tcpdump以来的库)</li><li>usbmonitor (usb数据包，就靠它了)</li></ul> 
<h3 id="一编译openwrt支持tcpdump和libpcap"><a name="t1"></a>一，编译openwrt支持tcpdump和libpcap</h3> 
<h4 id="11-在-menuconfig中选择tcpdump和libpacap中的usb"><a name="t2"></a>1.1, 在 menuconfig中选择tcpdump和libpacap中的usb</h4> 
<pre><code>Network--&gt;
  [*] tcpdump

Libraries--&gt;
  -*- libpcap--&gt;
    Configuration---&gt;
      [*] Include USB support  （注意这个一定要选上，否则你别想通过tcpdump抓usb包）</code></pre> 
<ul><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li></ul> 
<p>下面还有一个 tcpdump mini，我没有用，也没管。</p> 
<h4 id="12-在menuconfig-中选择usbmointor"><a name="t3"></a>1.2, 在menuconfig 中选择usbmointor</h4> 
<pre><code>Kernel modules---&gt;
  USB support--&gt;
    [*] kmod-usbmon</code></pre> 
<ul><li>1</li><li>2</li><li>3</li></ul> 
<h4 id="13-在kernelmenuconig-内核配置中选择usb-monitor"><a name="t4"></a>1.3， 在kernel_menuconig 内核配置中选择usb monitor</h4> 
<pre><code>Device Drivers --&gt;
  [*] USB support  ---&gt;  
    &lt;*&gt;     USB Monitor </code></pre> 
<ul><li>1</li><li>2</li><li>3</li></ul> 
<h3 id="二执行make编译"><a name="t5"></a>二，执行make编译</h3> 
<h3 id="三下载到目标板"><a name="t6"></a>三，下载到目标板</h3> 
<p>具体的板子不一样，我这里就不写了</p> 
<h3 id="四抓包"><a name="t7"></a>四，抓包</h3> 
<p>终于到了抓包了。</p> 
<h4 id="41确认一下你的设备在usb哪个总线上"><a name="t8"></a>4.1，确认一下你的设备在USB哪个总线上</h4> 
<pre><code>$ cat /sys/kernel/debug/usb/devices

T:  Bus=01 Lev=01 Prnt=01 Port=00 Cnt=01 Dev#=  2 Spd=12   MxCh= 0
D:  Ver= 1.10 Cls=00(&gt;ifc ) Sub=00 Prot=00 MxPS= 8 #Cfgs=  1
P:  Vendor=80ee ProdID=0021 Rev= 1.00
S:  Manufacturer=VirtualBox
S:  Product=USB Tablet
C:* #Ifs= 1 Cfg#= 1 Atr=80 MxPwr=100mA
I:* If#= 0 Alt= 0 #EPs= 1 Cls=03(HID  ) Sub=00 Prot=00 Driver=(none)
E:  Ad=81(I) Atr=03(Int.) MxPS=   8 Ivl=10ms
</code></pre> 
<ul><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li></ul> 
<p>上面这个<strong>bus</strong>就表示总线号，<strong>Dev#</strong>表示设备号。不同的总线对应的usbmonx不一样。例如BUS=1就对应usbmon1，BUS=2对应usbmon2。</p> 
<h4 id="42查看tcpdump是否可以检测到usbmonx设备"><a name="t9"></a>4.2，查看tcpdump是否可以检测到usbmonx设备</h4> 
<pre><code>$ tcpdump -D
1.eth0
2.br-lan
3.usbmon1 (USB bus number 1)
4.any (Pseudo-device that captures on all interfaces)
5.lo</code></pre> 
<ul><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li></ul> 
<p>可以看到我这里有<strong>usbmon1</strong>设备可用了。</p> 
<h4 id="43抓取usb数据"><a name="t10"></a>4.3，抓取usb数据</h4> 
<pre><code>$ tcpdump -i usbmon1 -w usb.pcap</code></pre> 
<ul><li>1</li></ul> 
<h4 id="44好了可以插入你想要抓取的usb设备了抓取完成后导出usbpcap"><a name="t11"></a>4.4，好了可以插入你想要抓取的USB设备了，抓取完成后，导出usb.pcap</h4> 
<h4 id="45用wireshark查看usb数据包"><a name="t12"></a>4.5，用wireshark查看usb数据包</h4> 
<p>将导出的usb.pcap文件，用wireshark打开，就可以看看usb交互的数据流程了，看起来已经比较直观了。比起原始的usbmon数据直观很多。</p> 
<hr> 
<h3 id="show一下效果"><a name="t13"></a>show一下效果</h3> 
<p><img alt="usb.png" src="https://images2.imgbox.com/4d/c2/LvRwMQDN_o.png"></p> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2b09823a8ca60bd67418b253c45459a8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java String类型的特性（复用性，值不可变性）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/78cd686c9e4bfb0923a8396e9eca3afd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">部署dashboard</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>