<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>在MySQL中恢复误删的表及数据 &#43; 实战演练 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="在MySQL中恢复误删的表及数据 &#43; 实战演练" />
<meta property="og:description" content="【前言】：MySQL本地环境有2个库，mydb和mysql；其中mydb中有tb1和tb2，为父子关系。在mydb的上下文环境下，试玩RENAME TABLE的时候，意在将mydb的tb1移到mysql中，SQL语句如下：
RENAME TABLE tb1 TO mysql.tb1; 在检查成功移到mysql后，无意间将tb1删除了。。。
在事先没有通过navicat手动备份(稳妥姿势如下图)的前提下，如何还原tb1及数据，保持测试父级数据在后续过程使用的便捷性，成了当下一个头痛的问题。这也就成了我后续写这边博客的初心。
【数据恢复方式】：
当数据丢失后，已知恢复方式有2种：
#1. 从备份的数据中恢复；
在探究Navicat GUI备份本质的时候，我们不难通过下图提取出来的用于备份的SQL中看出脚本的3个过程：
a. 删除现存的表 (数据随之被删除)；
b. 创建备份的表；
c. 插入备份数据；
#2. 从binlog中恢复；
结合本文的背景，接下来将通过DEMO重点介绍通过binlog恢复的过程。
【实战演练】：
案例设计与过程：在mydb中创建test_binlog表 -&gt; 插入4条记录 -&gt; 删除表 -&gt; 表与数据恢复。
/* 数据恢复实操210426 */ -- ***** 01. 预处理 ***** -- -- 查看数据库是否开启binlog日志及所在位置 show variables like &#39;%log_bin%&#39;; -- 查看所有二进制日志列表 show master logs; -- 结束当前日志，开启一个新的日志并查看正在使用的二进制日志 flush logs; show master status; -- - satrt position /* LAPTOP-6301VV5L-bin.000005	155 */ -- ***** 02." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4625f290e2515c19d21686d51c5d9e7f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-26T16:51:46+08:00" />
<meta property="article:modified_time" content="2021-04-26T16:51:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">在MySQL中恢复误删的表及数据 &#43; 实战演练</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>【<strong>前言</strong>】：MySQL本地环境有2个库，mydb和mysql；其中mydb中有tb1和tb2，为父子关系。<u><span style="color:#f33b45;">在mydb的上下文环境下</span></u>，试玩RENAME TABLE的时候，意在将mydb的tb1移到mysql中，SQL语句如下：</p> 
<pre><code class="language-sql">RENAME TABLE tb1 TO mysql.tb1;</code></pre> 
<p>在检查成功移到mysql后，<strong>无意间将tb1删除了</strong>。。。</p> 
<p>在<u>事先没有通过navicat手动备份</u>(稳妥姿势如下图)的前提下，<span style="color:#f33b45;">如何还原tb1及数据，保持测试父级数据在后续过程使用的便捷性，成了当下一个头痛的问题</span>。这也就成了我后续写这边博客的初心。</p> 
<p><img alt="" height="181" src="https://images2.imgbox.com/e1/b6/7sJFoCEX_o.png" width="350"></p> 
<p>【<strong>数据恢复方式</strong>】：</p> 
<p>当数据丢失后，已知恢复方式有2种：</p> 
<p>#1. 从备份的数据中恢复；</p> 
<p>在探究<span style="color:#f33b45;">Navicat GUI备份本质</span>的时候，我们不难通过下图提取出来的用于备份的SQL中看出脚本的3个过程：<br> a. 删除现存的表 (数据随之被删除)；<br> b. 创建备份的表；<br> c. 插入备份数据；</p> 
<p><img alt="" height="785" src="https://images2.imgbox.com/8e/55/vavul3CK_o.png" width="800"></p> 
<p>#2. 从binlog中恢复；</p> 
<p>结合本文的背景，接下来将通过DEMO重点介绍通过binlog恢复的过程。</p> 
<p>【<strong>实战演练</strong>】：</p> 
<p>案例设计与过程：在mydb中创建test_binlog表 -&gt; 插入4条记录 -&gt; 删除表 -&gt; 表与数据恢复。</p> 
<pre><code class="language-sql">/* 数据恢复实操210426 */

-- ***** 01. 预处理 ***** --
-- 查看数据库是否开启binlog日志及所在位置
	show variables like '%log_bin%';
	
-- 查看所有二进制日志列表
	show master logs;
	
-- 结束当前日志，开启一个新的日志并查看正在使用的二进制日志
	flush logs;
	show master status; -- - satrt position
	/*
	LAPTOP-6301VV5L-bin.000005	155
	*/

-- ***** 02. 创建表与数据 ***** --
-- 创建测试表
	create table test_binlog (
		id int not null auto_increment primary key,
		name varchar(50)
	);

-- 插入测试数据
	insert into test_binlog (name) 
	values
	('name1'),
	('name2'),
	('name3'),
	('name4');
	
-- 查看表与数据创建后的正在使用的二进制日志 - stop position
	show master status;
	/*
	LAPTOP-6301VV5L-bin.000005	748
	*/
	
-- 查看插入的数据
	select * from test_binlog;
	
-- ***** 03. 删除表 ***** --
-- 删除test_binlog
	drop table if exists test_binlog;
	
	-- 查看表与数据删除后的正在使用的二进制日志
	show master status;
	/*
	LAPTOP-6301VV5L-bin.000005	971
	*/
	
-- 	SQL语句查看binlog
	show binlog events in 'LAPTOP-6301VV5L-bin.000005';
	
-- ***** 04. 使用DOS恢复数据 ***** --
-- DOS命令查看binlog
	mysqlbinlog -v --base64-output=decode-rows "C:\ProgramData\MySQL\MySQL Server 8.0\Data\LAPTOP-6301VV5L-bin.000005"
	
-- backup the log from specified position range
	mysqlbinlog "C:\ProgramData\MySQL\MySQL Server 8.0\Data\LAPTOP-6301VV5L-bin.000005" --start-position 234 --stop-position 748 &gt; d:\backup\test.sql
	
-- DOS命令恢复数据
	mysqlbinlog "C:\ProgramData\MySQL\MySQL Server 8.0\Data\LAPTOP-6301VV5L-bin.000005" --start-position 234 --stop-position 748 |mysql -u root -p
	</code></pre> 
<p>【<strong>关键成功因素</strong>】：</p> 
<p>#1. 在DOS里边成功使用到mysqlbinlog命令需要配好环境变量，如下图：</p> 
<p><img alt="" height="414" src="https://images2.imgbox.com/1f/07/odUn1IrH_o.png" width="600"></p> 
<p>#2. 找到删表及删除数据在binlog的位置很繁琐，但很重要。</p> 
<p><img alt="" height="847" src="https://images2.imgbox.com/be/29/g7KB1lPm_o.png" width="800"></p> 
<p>结合上图我们不难理解，binlog其实记录了每个操作的过程，其中包含了表创建与数据插入的脚本，恢复的本质也就水落石出了。</p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3f05433eb9efec1002a69f0fb29a9b5c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Centos8 配置时间同步</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1474c0fb4c6851804b9cb9add89d5f2e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">VSCode常用快捷键</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>