<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>entity生成mysql指令max_EntityFrameworkCore教程：控制台程序生成数据库表 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="entity生成mysql指令max_EntityFrameworkCore教程：控制台程序生成数据库表" />
<meta property="og:description" content="一、引言
我们使用Code First的方式来生成数据库表，我们先讲解如何在控制台项目中生成数据库表。
在前面的文章中，我们是直接在控制台项目中安装的Mircosoft.EntityFrameworkCore，在真实的项目中，我们很少这样使用，都是采用分层的结构，将EF Core有关的操作放在一个单独的类库项目里，下面的例子中我们就以这种分层的结构来进行讲解。项目结构如下图所示：
项目结构：
EFCoreTest.Con：控制台项目，用来运行程序，在项目中会引用EFCoreTest.Data。
EFCoreTest.Data：类库项目，基于.Net Standard。存放的是与EF Core相关的内容。
EFCoreTest.Model：类库项目，基于.Net Standard。存放项目中使用到的实体类。
1、添加实体类
我们首先在EFCoreTest.Model类库项目里添加Student实体：
namespaceEFCoreTest.Model
{public classStudent
{public int Id { get; set; }public string Name { get; set; }public int Age { get; set; }public int Gender { get; set; }
}
}
2、添加Mircosoft.EntityFrameworkCore
我们在EFCoreTest.Data类库里面添加Mircosoft.EntityFrameworkCore包：
我们使用SqlServer数据库，所以我们还要安装Microsoft.EntityFrameworkCore.sqlServer包：
安装完成以后我们添加EFCoreTest.Model的引用，然后添加数据上下文类，该类继承自DbContext：
usingEFCoreTest.Model;usingMicrosoft.EntityFrameworkCore;namespaceEFCoreTest.Data
{/// ///数据上下文类，继承自DbContext/// public classEFCoreDbContext:DbContext
{/// ///重写OnConfiguring方法/// /// protected override voidOnConfiguring(DbContextOptionsBuilder optionsBuilder)
{//使用SqlServer数据库，传递连接字符串
optionsBuilder.UseSqlServer(&#34;Data Source=.;Initial Catalog=EFTestDb;User ID=sa;Password=123456;&#34;);base.OnConfiguring(optionsBuilder);
}/// ///重写OnModelCreating，主要做一些配置///例如设置生成的表名、主键、字符长度/// /// protected override voidOnModelCreating(ModelBuilder modelBuilder)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2aa01314646656c7e8c3e00053df424b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-02-23T11:23:05+08:00" />
<meta property="article:modified_time" content="2021-02-23T11:23:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">entity生成mysql指令max_EntityFrameworkCore教程：控制台程序生成数据库表</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>一、引言</p> 
 <p>我们使用Code First的方式来生成数据库表，我们先讲解如何在控制台项目中生成数据库表。</p> 
 <p>在前面的文章中，我们是直接在控制台项目中安装的Mircosoft.EntityFrameworkCore，在真实的项目中，我们很少这样使用，都是采用分层的结构，将EF Core有关的操作放在一个单独的类库项目里，下面的例子中我们就以这种分层的结构来进行讲解。项目结构如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/c8/b7/e4Q7ciQQ_o.png" alt="2080deba7defbcf32c77def7af2961df.png"></p> 
 <p>项目结构：</p> 
 <p>EFCoreTest.Con：控制台项目，用来运行程序，在项目中会引用EFCoreTest.Data。</p> 
 <p>EFCoreTest.Data：类库项目，基于.Net Standard。存放的是与EF Core相关的内容。</p> 
 <p>EFCoreTest.Model：类库项目，基于.Net Standard。存放项目中使用到的实体类。</p> 
 <p>1、添加实体类</p> 
 <p>我们首先在EFCoreTest.Model类库项目里添加Student实体：</p> 
 <p>namespaceEFCoreTest.Model</p> 
 <p>{public classStudent</p> 
 <p>{public int Id { get; set; }public string Name { get; set; }public int Age { get; set; }public int Gender { get; set; }</p> 
 <p>}</p> 
 <p>}</p> 
 <p>2、添加Mircosoft.EntityFrameworkCore</p> 
 <p>我们在EFCoreTest.Data类库里面添加Mircosoft.EntityFrameworkCore包：</p> 
 <p align="center"><img src="https://images2.imgbox.com/50/25/LQOcABzj_o.png" alt="b345e1c67e910e92b6d2067e948818a1.png"></p> 
 <p>我们使用SqlServer数据库，所以我们还要安装Microsoft.EntityFrameworkCore.sqlServer包：</p> 
 <p align="center"><img src="https://images2.imgbox.com/a9/21/wZ1ba2bR_o.png" alt="642d7bebfb12bd79f49e172be897f78d.png"></p> 
 <p>安装完成以后我们添加EFCoreTest.Model的引用，然后添加数据上下文类，该类继承自DbContext：</p> 
 <p>usingEFCoreTest.Model;usingMicrosoft.EntityFrameworkCore;namespaceEFCoreTest.Data</p> 
 <p>{/// </p> 
 <p>///数据上下文类，继承自DbContext/// </p> 
 <p>public classEFCoreDbContext:DbContext</p> 
 <p>{/// </p> 
 <p>///重写OnConfiguring方法/// </p> 
 <p>/// </p> 
 <p>protected override voidOnConfiguring(DbContextOptionsBuilder optionsBuilder)</p> 
 <p>{//使用SqlServer数据库，传递连接字符串</p> 
 <p>optionsBuilder.UseSqlServer("Data Source=.;Initial Catalog=EFTestDb;User ID=sa;Password=123456;");base.OnConfiguring(optionsBuilder);</p> 
 <p>}/// </p> 
 <p>///重写OnModelCreating，主要做一些配置///例如设置生成的表名、主键、字符长度/// </p> 
 <p>/// </p> 
 <p>protected override voidOnModelCreating(ModelBuilder modelBuilder)</p> 
 <p>{//设置生成的表名</p> 
 <p>modelBuilder.Entity().ToTable("T_Student");//设置主键，可以不设置，会默认把Id字段当成主键</p> 
 <p>modelBuilder.Entity().HasKey(p =&gt;p.Id);//设置Name字段的最大长度</p> 
 <p>modelBuilder.Entity().Property("Name").HasMaxLength(32);base.OnModelCreating(modelBuilder);</p> 
 <p>}//DbSet属性</p> 
 <p>public DbSet Students { get; set; }</p> 
 <p>}</p> 
 <p>}</p> 
 <p>这些工作做好以后，我们就可以用来生成数据库表了。</p> 
 <p>二、生成数据库表</p> 
 <p>我们下面以三种方式来生成数据库表。首先在控制台项目中添加EFCoreTest.Data的引用。</p> 
 <p>1、代码生成</p> 
 <p>我们可以使用代码来生成数据库，这样在程序启动的时候调用生成数据库的代码就能自动生成数据库了。代码如下：</p> 
 <p>usingEFCoreTest.Data;usingSystem;namespaceEFCoreTest.Con</p> 
 <p>{classProgram</p> 
 <p>{static void Main(string[] args)</p> 
 <p>{<!-- --></p> 
 <p>Console.WriteLine("Hello World!");</p> 
 <p>EFCoreDbContext dbContext= newEFCoreDbContext();bool tfTrue =dbContext.Database.EnsureCreated();if(tfTrue)</p> 
 <p>{<!-- --></p> 
 <p>Console.WriteLine("数据库创建成功!");</p> 
 <p>}else{<!-- --></p> 
 <p>Console.WriteLine("数据库创建失败!");</p> 
 <p>}</p> 
 <p>Console.ReadKey();</p> 
 <p>}</p> 
 <p>}</p> 
 <p>}</p> 
 <p>运行程序：</p> 
 <p align="center"><img src="https://images2.imgbox.com/aa/be/le87Xv8l_o.png" alt="b6fe98e0f3d9eddfe120e92266715be2.png"></p> 
 <p>输出结果提示我们创建成功了，在去数据库里面看看：</p> 
 <p align="center"><img src="https://images2.imgbox.com/ba/95/Prcz5PqJ_o.png" alt="598d5e270ba65b512d451e37cd93235a.png"></p> 
 <p>我们看到数据库和表都已经生成了，而且表里面的字段属性是按照我们在代码里面的设置生成的。</p> 
 <p>注意：如果这时候在程序启动的时候在去生成数据库就会报错：</p> 
 <p align="center"><img src="https://images2.imgbox.com/5f/d1/uHoGcEY1_o.png" alt="69e61d19fc6aba78ddef95d2a312f520.png"></p> 
 <p>2、程序包管理器控制台迁移</p> 
 <p>除了使用代码的方式生成，我们还可以使用数据迁移命令来生成数据库表，分为下面的三个步骤。</p> 
 <p>1、安装Microsoft.EntityFrameworkCore.Tools包</p> 
 <p>要使用数据迁移命令，首先需要安装Microsoft.EntityFrameworkCore.Tools包：</p> 
 <p align="center"><img src="https://images2.imgbox.com/27/3d/4n2baZRZ_o.png" alt="7da91d70e2c94f529b1b109addee494b.png"></p> 
 <p>2、添加迁移</p> 
 <p>首先在数据上下文类的OnModelCreating()方法里面添加一些种子数据，这样生成数据库以后，表里面就有一些基础数据：</p> 
 <p>usingEFCoreTest.Model;usingMicrosoft.EntityFrameworkCore;namespaceEFCoreTest.Data</p> 
 <p>{/// </p> 
 <p>///数据上下文类，继承自DbContext/// </p> 
 <p>public classEFCoreDbContext:DbContext</p> 
 <p>{/// </p> 
 <p>///重写OnConfiguring方法/// </p> 
 <p>/// </p> 
 <p>protected override voidOnConfiguring(DbContextOptionsBuilder optionsBuilder)</p> 
 <p>{//使用SqlServer数据库，传递连接字符串</p> 
 <p>optionsBuilder.UseSqlServer("Data Source=.;Initial Catalog=EFTestDb;User ID=sa;Password=123456;");base.OnConfiguring(optionsBuilder);</p> 
 <p>}/// </p> 
 <p>///重写OnModelCreating，主要做一些配置///例如设置生成的表名、主键、字符长度/// </p> 
 <p>/// </p> 
 <p>protected override voidOnModelCreating(ModelBuilder modelBuilder)</p> 
 <p>{//设置生成的表名</p> 
 <p>modelBuilder.Entity().ToTable("T_Student");//设置主键，可以不设置，会默认把Id字段当成主键</p> 
 <p>modelBuilder.Entity().HasKey(p =&gt;p.Id);//设置Name字段的最大长度</p> 
 <p>modelBuilder.Entity().Property("Name").HasMaxLength(32);base.OnModelCreating(modelBuilder);//添加种子数据</p> 
 <p>modelBuilder.Entity().HasData(newStudent()</p> 
 <p>{<!-- --></p> 
 <p>Id= 1,</p> 
 <p>Name= "Tom",</p> 
 <p>Age= 24,</p> 
 <p>Gender= 1},newStudent()</p> 
 <p>{<!-- --></p> 
 <p>Id= 2,</p> 
 <p>Name= "Jack",</p> 
 <p>Age= 23,</p> 
 <p>Gender= 2},newStudent()</p> 
 <p>{<!-- --></p> 
 <p>Id= 3,</p> 
 <p>Name= "Kevin",</p> 
 <p>Age= 26,</p> 
 <p>Gender= 2}</p> 
 <p>);</p> 
 <p>}//DbSet属性</p> 
 <p>public DbSet Students { get; set; }</p> 
 <p>}</p> 
 <p>}</p> 
 <p>然后使用下面的命令来添加迁移：</p> 
 <p>Add-Migration Initial</p> 
 <p>Add-Migration：是迁移命令。</p> 
 <p>Initial：可以理解成是给这次迁移起的一个别名，这个名称可以任意起，只要保证每次迁移的时候不重名即可。</p> 
 <p>如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/4f/f0/3RxBQXq2_o.png" alt="762e1ef333fbff6d766af914ab2b9d0f.png"></p> 
 <p>执行这条命令：</p> 
 <p align="center"><img src="https://images2.imgbox.com/77/54/xFgN9peN_o.png" alt="15183b4062551db91d70e6ed9dfc4d31.png"></p> 
 <p>我们看到执行报错了，报错信息提示我们程序的启动项里面也要安装Mircosoft.EntityFrameworkCore.Tools包，我们在控制台程序里面安装这个包，然后在执行迁移命令：</p> 
 <p align="center"><img src="https://images2.imgbox.com/89/66/dK84ylc8_o.png" alt="2789db30348632c9123201c8a7f940bb.png"></p> 
 <p>可以看到，这次执行成功了。成功以后会生成一个Migrations文件夹，这个文件夹下面有两个类文件：</p> 
 <p align="center"><img src="https://images2.imgbox.com/a9/30/3zLM2fhq_o.png" alt="07fc47e1ceaf44e641b1d48aeefc3acd.png"></p> 
 <p>20200223132908_Init.cs文件是根据这次迁移生成的文件，里面记录着这次迁移发生的改变：</p> 
 <p>usingMicrosoft.EntityFrameworkCore.Migrations;namespaceEFCoreTest.Data.Migrations</p> 
 <p>{public partial classInit : Migration</p> 
 <p>{protected override voidUp(MigrationBuilder migrationBuilder)</p> 
 <p>{<!-- --></p> 
 <p>migrationBuilder.CreateTable(</p> 
 <p>name:"T_Student",</p> 
 <p>columns: table=&gt; new{<!-- --></p> 
 <p>Id= table.Column(nullable: false)</p> 
 <p>.Annotation("SqlServer:Identity", "1, 1"),</p> 
 <p>Name= table.Column(maxLength: 32, nullable: true),</p> 
 <p>Age= table.Column(nullable: false),</p> 
 <p>Gender= table.Column(nullable: false)</p> 
 <p>},</p> 
 <p>constraints: table=&gt;{<!-- --></p> 
 <p>table.PrimaryKey("PK_T_Student", x =&gt;x.Id);</p> 
 <p>});</p> 
 <p>migrationBuilder.InsertData(</p> 
 <p>table:"T_Student",</p> 
 <p>columns:new[] { "Id", "Age", "Gender", "Name"},</p> 
 <p>values:new object[] { 1, 24, 1, "Tom"});</p> 
 <p>migrationBuilder.InsertData(</p> 
 <p>table:"T_Student",</p> 
 <p>columns:new[] { "Id", "Age", "Gender", "Name"},</p> 
 <p>values:new object[] { 2, 23, 2, "Jack"});</p> 
 <p>migrationBuilder.InsertData(</p> 
 <p>table:"T_Student",</p> 
 <p>columns:new[] { "Id", "Age", "Gender", "Name"},</p> 
 <p>values:new object[] { 3, 26, 2, "Kevin"});</p> 
 <p>}protected override voidDown(MigrationBuilder migrationBuilder)</p> 
 <p>{<!-- --></p> 
 <p>migrationBuilder.DropTable(</p> 
 <p>name:"T_Student");</p> 
 <p>}</p> 
 <p>}</p> 
 <p>}</p> 
 <p>里面有下面的两个方法：</p> 
 <p>Up：该方法是要应用到数据库的配置。</p> 
 <p>Down：该方法相当于是做回滚操作，执行这个方法，可以恢复到上一个状态。</p> 
 <p>每进行一次迁移就会生成一个这样的文件。</p> 
 <p>EFCoreDbContextModelSnapshot.cs是根据在OnModelCreating()方法中的配置生成的文件：</p> 
 <p>//</p> 
 <p>usingEFCoreTest.Data;usingMicrosoft.EntityFrameworkCore;usingMicrosoft.EntityFrameworkCore.Infrastructure;usingMicrosoft.EntityFrameworkCore.Metadata;usingMicrosoft.EntityFrameworkCore.Storage.ValueConversion;namespaceEFCoreTest.Data.Migrations</p> 
 <p>{<!-- --></p> 
 <p>[DbContext(typeof(EFCoreDbContext))]partial classEFCoreDbContextModelSnapshot : ModelSnapshot</p> 
 <p>{protected override voidBuildModel(ModelBuilder modelBuilder)</p> 
 <p>{#pragma warning disable 612, 618modelBuilder</p> 
 <p>.HasAnnotation("ProductVersion", "3.1.2")</p> 
 <p>.HasAnnotation("Relational:MaxIdentifierLength", 128)</p> 
 <p>.HasAnnotation("SqlServer:ValueGenerationStrategy", SqlServerValueGenerationStrategy.IdentityColumn);</p> 
 <p>modelBuilder.Entity("EFCoreTest.Model.Student", b =&gt;{<!-- --></p> 
 <p>b.Property("Id")</p> 
 <p>.ValueGeneratedOnAdd()</p> 
 <p>.HasColumnType("int")</p> 
 <p>.HasAnnotation("SqlServer:ValueGenerationStrategy", SqlServerValueGenerationStrategy.IdentityColumn);</p> 
 <p>b.Property("Age")</p> 
 <p>.HasColumnType("int");</p> 
 <p>b.Property("Gender")</p> 
 <p>.HasColumnType("int");</p> 
 <p>b.Property("Name")</p> 
 <p>.HasColumnType("nvarchar(32)")</p> 
 <p>.HasMaxLength(32);</p> 
 <p>b.HasKey("Id");</p> 
 <p>b.ToTable("T_Student");</p> 
 <p>b.HasData(new{<!-- --></p> 
 <p>Id= 1,</p> 
 <p>Age= 24,</p> 
 <p>Gender= 1,</p> 
 <p>Name= "Tom"},new{<!-- --></p> 
 <p>Id= 2,</p> 
 <p>Age= 23,</p> 
 <p>Gender= 2,</p> 
 <p>Name= "Jack"},new{<!-- --></p> 
 <p>Id= 3,</p> 
 <p>Age= 26,</p> 
 <p>Gender= 2,</p> 
 <p>Name= "Kevin"});</p> 
 <p>});#pragma warning restore 612, 618}</p> 
 <p>}</p> 
 <p>}</p> 
 <p>3、更新数据库</p> 
 <p>执行完上面的步骤，我们执行更新数据库的命令：</p> 
 <p>Update-Database</p> 
 <p>如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/e4/6c/BoUrMo0G_o.png" alt="6ae13860508a3c95d725eca6756ddad1.png"></p> 
 <p>执行成功，查看数据库数据：</p> 
 <p align="center"><img src="https://images2.imgbox.com/0e/00/dOrjn8OD_o.png" alt="26de0acbbb694aa34ad6748e6a45b3c1.png"></p> 
 <p>T_Student表已经生成了，而且表里面也有添加的种子数据，到此迁移就完成了。</p> 
 <p>3、命令行迁移</p> 
 <p>除了上面的两种方式，还可以使用命令行进行迁移，这种方式主要在Web项目里面比较常用。</p> 
 <p align="center"><img src="https://images2.imgbox.com/24/52/Z6mvUFA3_o.png" alt="36d3e06cc54290e0df29692c7b0f4bbf.png"></p> 
 <p>使用下面的命令安装：</p> 
 <p>dotnet tool install --global dotnet-ef</p> 
 <p>如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/d1/84/BCKiQ0Vk_o.png" alt="f5d64fedb2af70aff4fbd96c34c5b032.png"></p> 
 <p>安装完成以后我们在执行命令：</p> 
 <p align="center"><img src="https://images2.imgbox.com/b5/b0/i8ZJ6Vuj_o.png" alt="ca237aa70e5cad44f39f055293e06b05.png"></p> 
 <p>因为我本机的.NET SDK的版本是3.1.1，刚才安装的dotent-ef的版本是3.1.2，版本不兼容，我们下载最新的.NET SDK，然后安装。</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/396a479d3e26475c99a29252d826f248/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决Pycharm中无法使用中文输入法问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dc7e314a8bd91dcec0c2704694943538/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Sass-5【颜色函数、透明度函数、@规则】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>