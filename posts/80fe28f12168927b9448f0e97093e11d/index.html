<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Nginx -- 基础 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Nginx -- 基础" />
<meta property="og:description" content="Nginx -- 基础 目录结构基本配置最小配置虚拟主机配置反向代理配置负载均衡配置动静分离Url Rewrite配置防盗链 高可用配置https证书配置 目录结构 conf ：存放配置文件相关html ：存放静态文件默认目录html、css等sbin ：nginx的主程序 基本配置 最小配置 worker_processes 1；默认开启一个业务进程worker_connections 1024；单个业务进程可以接收的链接数include mime.types；引入http mime类型deflut_type application/octet-stream；mime类型没匹配上会默认使用二进制流方式传输sendfile on；开启linux的0拷贝keepalive_timeout 65；超时时间 虚拟主机配置 server { listen 80; 监听端口号 server_name localhost; 主机名 location / { 匹配路径 root html; 文件根目录 index index.html index.htm; 默认页名称 } error_page 500 502 503 504 /50x.html; 报错编码对应页面 location = /50x.html { root html; } } 虚拟主机：原本一台服务器只能对应一个站点，通过虚拟主机技术可以虚拟化成多个站点同时对外提供服务server_name：servername匹配分先后顺序，写前面的匹配上就不会继续匹配 完整匹配：同一个servername中可以匹配多个域名 ，server_name a.xxx.com b.xxx.com;通配符开始匹配：server_name *.xxx.com通配符结束匹配：server_name a.xxx.*正则匹配：server_name ~^ [0-9]&#43;.xxx.com$ 反向代理配置 proxy_pass location / { proxy_pass http://atguigu." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/80fe28f12168927b9448f0e97093e11d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-09T17:22:22+08:00" />
<meta property="article:modified_time" content="2022-07-09T17:22:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Nginx -- 基础</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Nginx -- 基础</h4> 
 <ul><li><ul><li><ul><li><a href="#_2" rel="nofollow">目录结构</a></li><li><a href="#_8" rel="nofollow">基本配置</a></li><li><ul><li><a href="#_9" rel="nofollow">最小配置</a></li><li><a href="#_18" rel="nofollow">虚拟主机配置</a></li><li><a href="#_41" rel="nofollow">反向代理配置</a></li><li><a href="#_48" rel="nofollow">负载均衡配置</a></li><li><a href="#_81" rel="nofollow">动静分离</a></li><li><a href="#Url_Rewrite_100" rel="nofollow">Url Rewrite配置</a></li><li><a href="#_121" rel="nofollow">防盗链</a></li></ul> 
    </li><li><a href="#_139" rel="nofollow">高可用配置</a></li><li><a href="#https_186" rel="nofollow">https证书配置</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h4><a id="_2"></a>目录结构</h4> 
<ul><li>conf ：存放配置文件相关</li><li>html ：存放静态文件默认目录html、css等</li><li>sbin ：nginx的主程序</li></ul> 
<h4><a id="_8"></a>基本配置</h4> 
<h5><a id="_9"></a>最小配置</h5> 
<ul><li>worker_processes 1；默认开启一个业务进程</li><li>worker_connections 1024；单个业务进程可以接收的链接数</li><li>include mime.types；引入http mime类型</li><li>deflut_type application/octet-stream；mime类型没匹配上会默认使用二进制流方式传输</li><li>sendfile on；开启linux的0拷贝</li><li>keepalive_timeout 65；超时时间</li></ul> 
<h5><a id="_18"></a>虚拟主机配置</h5> 
<pre><code class="prism language-powershell">server <span class="token punctuation">{<!-- --></span>
	listen 80<span class="token punctuation">;</span> 监听端口号
	server_name localhost<span class="token punctuation">;</span> 主机名
	location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span> 匹配路径
		root html<span class="token punctuation">;</span> 文件根目录
		index index<span class="token punctuation">.</span>html index<span class="token punctuation">.</span>htm<span class="token punctuation">;</span> 默认页名称
	<span class="token punctuation">}</span>
	error_page 500 502 503 504 <span class="token operator">/</span>50x<span class="token punctuation">.</span>html<span class="token punctuation">;</span> 报错编码对应页面
	location = <span class="token operator">/</span>50x<span class="token punctuation">.</span>html <span class="token punctuation">{<!-- --></span>
		root html<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>虚拟主机：原本一台服务器只能对应一个站点，通过虚拟主机技术可以虚拟化成多个站点同时对外提供服务</li><li>server_name：servername匹配分先后顺序，写前面的匹配上就不会继续匹配 
  <ul><li>完整匹配：同一个servername中可以匹配多个域名 ，server_name a.xxx.com b.xxx.com;</li><li>通配符开始匹配：server_name *.xxx.com</li><li>通配符结束匹配：server_name a.xxx.*</li><li>正则匹配：server_name ~^ [0-9]+.xxx.com$</li></ul> </li></ul> 
<h5><a id="_41"></a>反向代理配置</h5> 
<ul><li>proxy_pass</li></ul> 
<pre><code class="prism language-powershell">	location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
		proxy_pass http:<span class="token operator">/</span><span class="token operator">/</span>atguigu<span class="token punctuation">.</span>com/<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_48"></a>负载均衡配置</h5> 
<ul><li>upstream</li></ul> 
<pre><code class="prism language-powershell">upstream proxyPass <span class="token punctuation">{<!-- --></span> <span class="token operator">/</span><span class="token operator">/</span>反向代理的路径
	server 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:8050 weight=10 down<span class="token punctuation">;</span>
	server 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:8060 weight=1<span class="token punctuation">;</span>
	server 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:8060 weight=1 backup<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{<!-- --></span>
	listen 80<span class="token punctuation">;</span> 监听端口号
	server_name localhost<span class="token punctuation">;</span> 主机名
	location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span> 匹配路径
		proxy_pass proxyPass<span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">/</span>配置反向代理upstream路径
		root html<span class="token punctuation">;</span>
		index index<span class="token punctuation">.</span>html index<span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	error_page 500 502 503 504 <span class="token operator">/</span>50x<span class="token punctuation">.</span>html<span class="token punctuation">;</span> 报错编码对应页面
	location = <span class="token operator">/</span>50x<span class="token punctuation">.</span>html <span class="token punctuation">{<!-- --></span>
		root html<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>负载均衡策略</strong></p> 
<ul><li>down：表示当前的server暂时不参与负载</li><li>backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。</li><li>weight：指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况</li><li>ip_hash：根据客户端的ip地址转发同一台服务器，可以保持回话</li><li>least_conn：最少连接访问</li><li>url_hash：根据用户访问的url定向转发请求</li><li>fair：根据后端服务器响应时间转发请求</li></ul> 
<h5><a id="_81"></a>动静分离</h5> 
<ul><li>location配置</li></ul> 
<table><thead><tr><th>location前缀</th><th>匹配规则</th></tr></thead><tbody><tr><td>/</td><td>通用匹配，任何请求都会匹配到</td></tr><tr><td>=</td><td>精准匹配</td></tr><tr><td>~</td><td>正则匹配，区分大小写</td></tr><tr><td>~*</td><td>正则匹配，不区分大小写</td></tr><tr><td>^~</td><td>非正则匹配，匹配以指定模式开头的location</td></tr></tbody></table> 
<ul><li>location匹配顺序 
  <ul><li>多个正则location直接按书写顺序匹配，成功后就不会继续往后面匹配</li><li>普通（非正则）location会一直往下，直到找到匹配度最高的（最大前缀匹配）</li><li>当普通location与正则location同时存在，如果正则匹配成功,则不会再执行普通匹配</li><li>所有类型location存在时，“=”匹配 &gt; “^~”匹配 &gt; 正则匹配 &gt; 普通（最大前缀匹配）</li></ul> </li></ul> 
<h5><a id="Url_Rewrite_100"></a>Url Rewrite配置</h5> 
<pre><code class="prism language-powershell">rewrite &lt;regex&gt; &lt;replacement&gt; <span class="token namespace">[flag]</span><span class="token punctuation">;</span>
flag标记说明：
last <span class="token comment">#本条规则匹配完成后，继续向下匹配新的location URI规则</span>
<span class="token keyword">break</span> <span class="token comment">#本条规则匹配完成即终止，不再匹配后面的任何规则</span>
redirect <span class="token comment">#返回302临时重定向，浏览器地址会显示跳转后的URL地址</span>
permanent <span class="token comment">#返回301永久重定向，浏览器地址栏会显示跳转后的URL地址</span>

<span class="token punctuation">{<!-- --></span>
	server <span class="token punctuation">{<!-- --></span>
		listen 80<span class="token punctuation">;</span> 
		server_name localhost<span class="token punctuation">;</span>
		location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
			rewrite ^<span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">[</span>0-9<span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">)</span><span class="token punctuation">.</span>html$ <span class="token operator">/</span>order<span class="token punctuation">.</span>html?pageNum=<span class="token variable">$1</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">/</span>将x<span class="token punctuation">.</span>html转换到index路径，用于隐藏实际请求路径
			proxy_pass proxyPass<span class="token punctuation">;</span> 
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_121"></a>防盗链</h5> 
<ul><li>none， 检测 Referer 头域不存在的情况。</li><li>blocked，检测 Referer 头域的值被防火墙或者代理服务器删除或伪装的情况。这种情况该头域的值不以“http://” 或 “https://” 开头。</li><li>server_names ，设置一个或多个 URL ，检测 Referer 头域的值是否是这些 URL 中的某一个。</li></ul> 
<pre><code class="prism language-powershell">配置到location中
valid referers none <span class="token punctuation">|</span> blocked <span class="token punctuation">|</span> server_names <span class="token punctuation">|</span> strings <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>

location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
	valid_referers 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>44<span class="token punctuation">.</span>101<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$invalid_referer</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> 403<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_139"></a>高可用配置</h4> 
<ul><li>下载Keepalived</li><li>配置keepalived</li></ul> 
<p>机器1</p> 
<pre><code class="prism language-powershell">	global_defs <span class="token punctuation">{<!-- --></span>
		router_id lb111
	<span class="token punctuation">}</span>
	vrrp_instance atguigu <span class="token punctuation">{<!-- --></span>
		state MASTER <span class="token operator">/</span><span class="token operator">/</span>状态 master、backup
		interface ens33
		virtual_router_id 51
		priority 100 <span class="token operator">/</span><span class="token operator">/</span>优先级，越大主备优先级越高
		advert_int 1
		authentication <span class="token punctuation">{<!-- --></span> <span class="token operator">/</span><span class="token operator">/</span>统一集群认证信息需要一致
			auth_type PASS
			auth_pass 1111
		<span class="token punctuation">}</span>
		virtual_ipaddress <span class="token punctuation">{<!-- --></span>
			192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>44<span class="token punctuation">.</span>200
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>机器2</p> 
<pre><code class="prism language-powershell">	global_defs <span class="token punctuation">{<!-- --></span>
		router_id lb111
	<span class="token punctuation">}</span>
	vrrp_instance atguigu <span class="token punctuation">{<!-- --></span>
		state BACKUP
		interface ens33
		virtual_router_id 51
		priority 99
		advert_int 1
		authentication <span class="token punctuation">{<!-- --></span> <span class="token operator">/</span><span class="token operator">/</span>统一集群认证信息需要一致
			auth_type PASS
			auth_pass 1111
		<span class="token punctuation">}</span>
		virtual_ipaddress <span class="token punctuation">{<!-- --></span>
			192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>44<span class="token punctuation">.</span>200
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="https_186"></a>https证书配置</h4> 
<pre><code class="prism language-powershell"><span class="token punctuation">{<!-- --></span>
	server <span class="token punctuation">{<!-- --></span>
		listen 443 ssl<span class="token punctuation">;</span>  <span class="token operator">/</span><span class="token operator">/</span>监听https 443端口
		server_name localhost<span class="token punctuation">;</span>
		ssl_certificate <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>cert/server<span class="token punctuation">.</span>crt<span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">/</span>配置证书
		ssl_certificate_key <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>cert/server<span class="token punctuation">.</span>key<span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">/</span>配置秘钥
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>学习地址：<a href="https://www.bilibili.com/video/BV1yS4y1N76R" rel="nofollow">尚硅谷Nginx教程</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1dd8351c66cf2d9593a39e86c816f291/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决“无法获得下列许可 solidworks standard无法连接到服务器”的问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e5eb3127adcc3eabe43745f7572975ed/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">GeoJSON快速入门教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>