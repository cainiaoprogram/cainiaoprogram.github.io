<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Flowable 之任务分配 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Flowable 之任务分配" />
<meta property="og:description" content="文章目录 一、任务分配和流程变量1.1 任务分配1.1.1 固定分配1.1.2 表达式分配① 值表达式② 方法表达式 1.1.3 监听器分配 1.2 流程变量1.2.1 全局变量1.2.2 局部变量1.2.3 案例讲解 二、候选人和候选人组2.1 候选人2.1.1 部署和启动流程2.1.2 任务的查询2.1.3 任务的拾取2.1.4 任务的退还2.1.5 任务的交接2.1.6 任务的完成 2.2 候选人组2.2.1 管理用户和组2.2.2 流程的部署启动2.2.3 任务的拾取完成 提示：以下是本篇文章正文内容，Java 系列学习将会持续更新 一、任务分配和流程变量 1.1 任务分配 1.1.1 固定分配 固定分配就是我们前面介绍的，在绘制流程图或者直接在流程文件中通过 Assignee 来指定的方式。
1.1.2 表达式分配 Flowable 使用 UEL 进行表达式解析。UEL代表Unified Expression Language，是EE6规范的一部分.Flowable支持两种UEL表达式： UEL-value 和 UEL-method。
① 值表达式 值表达式 Value expression：解析为一个值。默认情况下，所有流程变量都可以使用。（若使用Spring）所有的Spring bean也可以用在表达式里。例如
可以看到通过表达式处理的效果。
先部署流程，然后在启动流程实例的时候绑定表达式对应的值。
/** * 启动流程实例 */ @Test public void testRunProcess(){ // 设置 assignee 的取值 Map&lt;String,Object&gt; variables = new HashMap&lt;&gt;(); variables." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2431eaac99424d504197c1bf1e38b2d6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-18T14:54:19+08:00" />
<meta property="article:modified_time" content="2023-09-18T14:54:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Flowable 之任务分配</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3 id="mulu"> </h3> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_10" rel="nofollow">一、任务分配和流程变量</a></li><li><ul><li><a href="#11__11" rel="nofollow">1.1 任务分配</a></li><li><ul><li><a href="#111__12" rel="nofollow">1.1.1 固定分配</a></li><li><a href="#112__18" rel="nofollow">1.1.2 表达式分配</a></li><li><ul><li><a href="#__21" rel="nofollow">① 值表达式</a></li><li><a href="#__53" rel="nofollow">② 方法表达式</a></li></ul> 
    </li><li><a href="#113__63" rel="nofollow">1.1.3 监听器分配</a></li></ul> 
   </li><li><a href="#12__99" rel="nofollow">1.2 流程变量</a></li><li><ul><li><a href="#121__118" rel="nofollow">1.2.1 全局变量</a></li><li><a href="#122__125" rel="nofollow">1.2.2 局部变量</a></li><li><a href="#123__130" rel="nofollow">1.2.3 案例讲解</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_210" rel="nofollow">二、候选人和候选人组</a></li><li><ul><li><a href="#21__213" rel="nofollow">2.1 候选人</a></li><li><ul><li><a href="#211__217" rel="nofollow">2.1.1 部署和启动流程</a></li><li><a href="#212__244" rel="nofollow">2.1.2 任务的查询</a></li><li><a href="#213__261" rel="nofollow">2.1.3 任务的拾取</a></li><li><a href="#214__277" rel="nofollow">2.1.4 任务的退还</a></li><li><a href="#215__292" rel="nofollow">2.1.5 任务的交接</a></li><li><a href="#216__312" rel="nofollow">2.1.6 任务的完成</a></li></ul> 
   </li><li><a href="#22__333" rel="nofollow">2.2 候选人组</a></li><li><ul><li><a href="#221__338" rel="nofollow">2.2.1 管理用户和组</a></li><li><a href="#222__382" rel="nofollow">2.2.2 流程的部署启动</a></li><li><a href="#223__408" rel="nofollow">2.2.3 任务的拾取完成</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<font color="#999AAA">提示：以下是本篇文章正文内容，Java 系列学习将会持续更新 </font> 
<p></p> 
<p><img src="https://images2.imgbox.com/b9/2a/ncdEWwmL_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_10"></a>一、任务分配和流程变量</h2> 
<h3><a id="11__11"></a>1.1 任务分配</h3> 
<h4><a id="111__12"></a>1.1.1 固定分配</h4> 
<p>固定分配就是我们前面介绍的，在绘制流程图或者直接在流程文件中通过 Assignee 来指定的方式。<br> <img src="https://images2.imgbox.com/7a/86/AkwbJf0V_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a2/3d/1nAwWizz_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/26/19/eu7e7Nq4_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="112__18"></a>1.1.2 表达式分配</h4> 
<p>Flowable 使用 UEL 进行表达式解析。UEL代表<em>Unified Expression Language</em>，是EE6规范的一部分.Flowable支持两种UEL表达式： UEL-value 和 UEL-method。</p> 
<h5><a id="__21"></a>① 值表达式</h5> 
<p><strong>值表达式 Value expression</strong>：解析为一个值。默认情况下，所有流程变量都可以使用。（若使用Spring）所有的Spring bean也可以用在表达式里。例如<br> <img src="https://images2.imgbox.com/56/95/3wqKjjdS_o.png" alt="在这里插入图片描述"><br> 可以看到通过表达式处理的效果。<br> <img src="https://images2.imgbox.com/af/69/BuaYu6G4_o.png" alt="在这里插入图片描述"></p> 
<p>先部署流程，然后在启动流程实例的时候绑定表达式对应的值。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 启动流程实例
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testRunProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 设置 assignee 的取值</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"assignee0"</span><span class="token punctuation">,</span><span class="token string">"张三"</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"assignee1"</span><span class="token punctuation">,</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 启动流程实例，第一个参数是流程定义的id</span>
    <span class="token class-name">ProcessInstance</span> processInstance <span class="token operator">=</span> runtimeService
            <span class="token punctuation">.</span><span class="token function">startProcessInstanceById</span><span class="token punctuation">(</span><span class="token string">"MyHolidayUI:1:4"</span><span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 启动流程实例</span>
    <span class="token comment">// 输出相关的流程实例信息</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程定义的ID："</span> <span class="token operator">+</span> processInstance<span class="token punctuation">.</span><span class="token function">getProcessDefinitionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程实例的ID："</span> <span class="token operator">+</span> processInstance<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前活动的ID："</span> <span class="token operator">+</span> processInstance<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在流程变量表中我们可以看到对应的流程变量信息。<br> <img src="https://images2.imgbox.com/26/24/3zruWM3d_o.png" alt="在这里插入图片描述"><br> 同时在 Task 表中，可以看到流程当前的分配人是 <code>张三</code>，说明 UEL 表达式被解析了。<br> <img src="https://images2.imgbox.com/4d/29/EWTXCsno_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="__53"></a>② 方法表达式</h5> 
<p><strong>方法表达式 Method expression</strong>: 调用一个方法，可以带或不带参数。<strong>当调用不带参数的方法时，要确保在方法名后添加空括号（以避免与值表达式混淆）</strong>。传递的参数可以是字面值(literal value)，也可以是表达式，它们会被自动解析。例如：</p> 
<pre><code class="prism language-txt">${printer.print()}
${myBean.addNewOrder('orderName')}
${myBean.doSomething(myVar, execution)}
</code></pre> 
<p>myBean 是 Spring 容器中的个 Bean 对象，表示调用的是 bean 的 addNewOrder 方法。</p> 
<h4><a id="113__63"></a>1.1.3 监听器分配</h4> 
<p>可以使用监听器来完成很多 Flowable 的流程业务。我们在此处使用监听器来完成负责人的指定，那么我们在流程设计的时候就不需要指定 assignee。</p> 
<p><strong>①创建自定义监听器</strong>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTaskListener</span> <span class="token keyword">implements</span> <span class="token class-name">TaskListener</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">DelegateTask</span> delegateTask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MyTaskListener 监听器被触发了！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"提交请假流程"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>delegateTask<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">"create"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>delegateTask<span class="token punctuation">.</span><span class="token function">getEventName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            delegateTask<span class="token punctuation">.</span><span class="token function">setAssignee</span><span class="token punctuation">(</span><span class="token string">"小明"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            delegateTask<span class="token punctuation">.</span><span class="token function">setAssignee</span><span class="token punctuation">(</span><span class="token string">"王经理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>②然后在 FlowableUI 中关联对应的监听器</strong>。</p> 
<ul><li>create：任务创建后触发。</li><li>assignment：任务分配后触发。</li><li>Delete：任务完成后触发。</li><li>All：所有事件都触发。</li></ul> 
<p><img src="https://images2.imgbox.com/5c/03/uKrjtaVz_o.png" alt="在这里插入图片描述"><br> 效果如下：<br> <img src="https://images2.imgbox.com/07/33/PX5wFxWu_o.png" alt="在这里插入图片描述"></p> 
<p><strong>③然后我们启动流程，执行查看效果</strong>：<br> <img src="https://images2.imgbox.com/00/48/uBbNyLFO_o.jpg" alt="在这里插入图片描述"></p> 
<p>在 Task 表中我们可以看到对应的分配人为 <code>小明</code> 说明通过监听也完成了任务分配的工作了。<img src="https://images2.imgbox.com/57/38/E5cLyYe1_o.png" alt="在这里插入图片描述"></p> 
<p><a href="#mulu" rel="nofollow">回到目录…</a></p> 
<h3><a id="12__99"></a>1.2 流程变量</h3> 
<p>  流程实例按步骤执行时，需要使用一些数据。在Flowable中，这些数据称作<em>变量(variable)</em>，并会存储在数据库中。变量可以用在表达式中（例如在排他网关中用于选择正确的出口路径），也可以在Java服务任务(service task)中用于调用外部服务（例如为服务调用提供输入或结果存储）等等。</p> 
<p>  流程实例可以持有变量（称作<em>流程变量 process variables</em>）；用户任务以及<em>执行(executions)</em>——流程当前活动节点的指针——也可以持有变量。流程实例可以持有任意数量的变量，每个变量存储为<em>ACT_RU_VARIABLE</em>数据库表的一行。</p> 
<p>所有的 <em>startProcessInstanceXXX</em> 方法都有一个可选参数，用于在流程实例创建及启动时设置变量。例如，在 <em>RuntimeService</em> 中：</p> 
<pre><code class="prism language-java"><span class="token class-name">ProcessInstance</span> <span class="token function">startProcessInstanceByKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> processDefinitionKey<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>也可以在流程执行中加入变量。例如，(<em>RuntimeService</em>):</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">setVariable</span><span class="token punctuation">(</span><span class="token class-name">String</span> executionId<span class="token punctuation">,</span> <span class="token class-name">String</span> variableName<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">setVariableLocal</span><span class="token punctuation">(</span><span class="token class-name">String</span> executionId<span class="token punctuation">,</span> <span class="token class-name">String</span> variableName<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">setVariables</span><span class="token punctuation">(</span><span class="token class-name">String</span> executionId<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">setVariablesLocal</span><span class="token punctuation">(</span><span class="token class-name">String</span> executionId<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/79/7b/kju24tDz_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="121__118"></a>1.2.1 全局变量</h4> 
<p>  流程变量的默认作用域是流程实例。当一个流程变量的作用域为流程实例时，可以称为 global 变量。</p> 
<p>注意：如： Global变量：userId（变量名）、zhangsan（变量值）</p> 
<p>  global 变量中变量名不允许重复，设置相同名称的变量，后设置的值会覆盖前设置的变量值。</p> 
<h4><a id="122__125"></a>1.2.2 局部变量</h4> 
<p>  任务和执行实例仅仅是针对一个任务和一个执行实例范围，范围没有流程实例大， 称为 local 变量。</p> 
<p>  Local 变量由于在不同的任务或不同的执行实例中，作用域互不影响，变量名可以相同没有影响。Local 变量名也可以和 global 变量名相同，没有影响。</p> 
<h4><a id="123__130"></a>1.2.3 案例讲解</h4> 
<p>当部门经理进行审批任务时，他需要设置流程变量为下一步流程指明方向。<br> <img src="https://images2.imgbox.com/84/1c/6mylJVnT_o.png" alt="在这里插入图片描述"></p> 
<p>①部署流程。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Deployment</span> deploy <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">createDeployment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addClasspathResource</span><span class="token punctuation">(</span><span class="token string">"evectionUI.bpmn20.xml"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"20230904出差申请"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"deploy.getId() = "</span> <span class="token operator">+</span> deploy<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"deploy.getName() = "</span> <span class="token operator">+</span> deploy<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"deploy.getCategory() = "</span> <span class="token operator">+</span> deploy<span class="token punctuation">.</span><span class="token function">getCategory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>②启动流程实例：并且指定全局流程变量。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 在启动流程实例的时候设置流程变量
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">runProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 设置流程变量</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">,</span> <span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"manager1"</span><span class="token punctuation">,</span> <span class="token string">"张经理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"manager2"</span><span class="token punctuation">,</span> <span class="token string">"王总经理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"manager3"</span><span class="token punctuation">,</span> <span class="token string">"孙钱务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动流程实例，第一个参数是流程定义的id</span>
    <span class="token class-name">ProcessInstance</span> processInstance <span class="token operator">=</span> runtimeService
            <span class="token punctuation">.</span><span class="token function">startProcessInstanceById</span><span class="token punctuation">(</span><span class="token string">"evection:1:4"</span><span class="token punctuation">,</span>variables<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 启动流程实例</span>
    <span class="token comment">// 输出相关的流程实例信息</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程定义的ID："</span> <span class="token operator">+</span> processInstance<span class="token punctuation">.</span><span class="token function">getProcessDefinitionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程实例的ID："</span> <span class="token operator">+</span> processInstance<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前活动的ID："</span> <span class="token operator">+</span> processInstance<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>③完成 Task 任务，同时也可以指定流程变量。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 完成任务时指定流程变量
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">completeTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"evection:1:4"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 添加流程变量</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getProcessVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"num"</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 完成任务</span>
    taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当然，我们也可以在处理流程之外通过 Task 编号来修改流程变量。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 通过当前任务设置
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">currentTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"evection:1:4"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"王五"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 添加流程变量</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getProcessVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"num"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//  一次设置多个值 设置局部变量</span>
    taskService<span class="token punctuation">.</span><span class="token function">setVariables</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="#mulu" rel="nofollow">回到目录…</a></p> 
<h2><a id="_210"></a>二、候选人和候选人组</h2> 
<p>在流程定义中在任务结点的 assignee 固定设置任务负责人，在流程定义时将参与者固定设置在.bpmn 文件中，如果临时任务负责人变更则需要修改流程定义，系统可扩展性差。针对这种情况可以给任务设置多个候选人或者候选人组，可以从候选人中选择参与者来完成任务。</p> 
<h3><a id="21__213"></a>2.1 候选人</h3> 
<p><img src="https://images2.imgbox.com/f5/de/L2MPwn3z_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c8/3d/L5R3AkZL_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6a/07/PZbPSxIK_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="211__217"></a>2.1.1 部署和启动流程</h4> 
<pre><code class="prism language-java"><span class="token comment">// 部署流程</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Deployment</span> deploy <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">createDeployment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addClasspathResource</span><span class="token punctuation">(</span><span class="token string">"Test3.bpmn20.xml"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"请求流程-候选人"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"deploy.getId() = "</span> <span class="token operator">+</span> deploy<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>deploy<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>启动流程实例，并为候选人赋值。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">runProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 给流程定义中的UEL表达式赋值</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"manager1"</span><span class="token punctuation">,</span><span class="token string">"张经理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"manager2"</span><span class="token punctuation">,</span><span class="token string">"李经理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"manager3"</span><span class="token punctuation">,</span><span class="token string">"王经理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    runtimeService<span class="token punctuation">.</span><span class="token function">startProcessInstanceById</span><span class="token punctuation">(</span><span class="token string">"test3:1:40e8b336-4c84-11ee-8f39-200db0c7aa5b"</span><span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>act_ru_variable 表中有了三个候选人的变量信息：<br> <img src="https://images2.imgbox.com/7d/38/2oCMCWHa_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="212__244"></a>2.1.2 任务的查询</h4> 
<p>根据候选人查询可拾取的任务。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">queryTaskCandidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"test3:1:40e8b336-4c84-11ee-8f39-200db0c7aa5b"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskCandidateUser</span><span class="token punctuation">(</span><span class="token string">"李经理"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Task</span> task <span class="token operator">:</span> tasks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"task.getId() = "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"task.getName() = "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>act_ru_task 表中的任务执行人还是 null，但候选人是可以查出来该任务的。<br> <img src="https://images2.imgbox.com/d3/ad/6eKbUPJF_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="213__261"></a>2.1.3 任务的拾取</h4> 
<p>候选人知道有可拾取的任务后，拾取任务。一个候选人拾取任务后，其他候选人就不能再拾取该任务了。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">claimTaskCandidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"test3:1:40e8b336-4c84-11ee-8f39-200db0c7aa5b"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskCandidateUser</span><span class="token punctuation">(</span><span class="token string">"李经理"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskService<span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"李经理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>拾取后，act_ru_task 表中的任务执行人也显示出来了。<br> <img src="https://images2.imgbox.com/c9/c2/D4UkB69h_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="214__277"></a>2.1.4 任务的退还</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">unclaimTaskCandidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"test3:1:40e8b336-4c84-11ee-8f39-200db0c7aa5b"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"李经理"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskService<span class="token punctuation">.</span><span class="token function">unclaim</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>退还后，act_ru_task 表中的任务执行人又变为 null。<br> <img src="https://images2.imgbox.com/5e/0b/QwXKciWB_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="215__292"></a>2.1.5 任务的交接</h4> 
<p>如果我获取了任务，但是不想执行，那么我可以把这个任务交接给其他的用户。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">taskCandidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 李经理 --&gt; 王经理</span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"test3:1:40e8b336-4c84-11ee-8f39-200db0c7aa5b"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"李经理"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskService<span class="token punctuation">.</span><span class="token function">setAssignee</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"王经理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>交接前，act_ru_task 表中的任务执行人为 “李经理”。<br> <img src="https://images2.imgbox.com/f7/8a/gEknhkFM_o.png" alt="在这里插入图片描述"><br> 交接后，act_ru_task 表中的任务执行人为 “王经理”。<br> <img src="https://images2.imgbox.com/3e/dc/bf4H7AaM_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="216__312"></a>2.1.6 任务的完成</h4> 
<p>由被指派的任务执行人 assignee 完成任务。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"test3:1:40e8b336-4c84-11ee-8f39-200db0c7aa5b"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"王经理"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>流程结束，act_ru_task 表中的信息被清空。<br> <img src="https://images2.imgbox.com/22/43/Yh1Kdh6v_o.png" alt="在这里插入图片描述"></p> 
<p><a href="#mulu" rel="nofollow">回到目录…</a></p> 
<h3><a id="22__333"></a>2.2 候选人组</h3> 
<p><img src="https://images2.imgbox.com/31/01/ILT6U9cq_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0b/54/wTgEaE6R_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6f/5a/LJihpAEr_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="221__338"></a>2.2.1 管理用户和组</h4> 
<p><strong>①创建用户</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> identityService<span class="token punctuation">.</span><span class="token function">newUser</span><span class="token punctuation">(</span><span class="token string">"诸葛亮"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setFirstName</span><span class="token punctuation">(</span><span class="token string">"亮"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setLastName</span><span class="token punctuation">(</span><span class="token string">"孔明"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">"123456@163.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    identityService<span class="token punctuation">.</span><span class="token function">saveUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 act_id_user 表中可以看到创建的用户信息。<br> <img src="https://images2.imgbox.com/92/93/zEdVTtUJ_o.png" alt=""></p> 
<p><strong>②创建组</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">createGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Group</span> group <span class="token operator">=</span> identityService<span class="token punctuation">.</span><span class="token function">newGroup</span><span class="token punctuation">(</span><span class="token string">"group2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    group<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"生产部"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    group<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"type2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    identityService<span class="token punctuation">.</span><span class="token function">saveGroup</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 act_id_group 表中可以看到创建的组信息。<br> <img src="https://images2.imgbox.com/14/01/e4qsQ1pt_o.png" alt="在这里插入图片描述"></p> 
<p><strong>③将用户分配给组</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">userGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Group</span> group <span class="token operator">=</span> identityService<span class="token punctuation">.</span><span class="token function">createGroupQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">groupId</span><span class="token punctuation">(</span><span class="token string">"group2"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> identityService<span class="token punctuation">.</span><span class="token function">createUserQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span><span class="token string">"诸葛亮"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    identityService<span class="token punctuation">.</span><span class="token function">createMembership</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> group<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 act_id_membership 表中可以看到用户和组的关系了。<br> <img src="https://images2.imgbox.com/e4/a9/KNyaSmkf_o.png" alt=""></p> 
<h4><a id="222__382"></a>2.2.2 流程的部署启动</h4> 
<p>部署流程定义：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Deployment</span> deploy <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">createDeployment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addClasspathResource</span><span class="token punctuation">(</span><span class="token string">"Test4-候选人组.bpmn20.xml"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"请求流程-候选人组"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"deploy.getId() = "</span> <span class="token operator">+</span> deploy<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>deploy<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>启动流程实例：需要将候选组ID添加到运行时变量表中。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">runProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Group</span><span class="token punctuation">&gt;</span></span> groups <span class="token operator">=</span> identityService<span class="token punctuation">.</span><span class="token function">createGroupQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Group</span> group1 <span class="token operator">=</span> groups<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Group</span> group2 <span class="token operator">=</span> groups<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"g1"</span><span class="token punctuation">,</span> group1<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"g2"</span><span class="token punctuation">,</span> group2<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    runtimeService<span class="token punctuation">.</span><span class="token function">startProcessInstanceById</span><span class="token punctuation">(</span><span class="token string">"test4:1:44ae7634-4bb2-11ee-9fc5-200db0c7aa5b"</span><span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="223__408"></a>2.2.3 任务的拾取完成</h4> 
<p>任务的查询和拾取：根据登录的用户查询对应的组，再根据组查询可以拾取的任务。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">queryTaskCandidateGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> userId <span class="token operator">=</span> <span class="token string">"赵云"</span><span class="token punctuation">;</span>
    <span class="token class-name">Group</span> group <span class="token operator">=</span> identityService<span class="token punctuation">.</span><span class="token function">createGroupQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">groupMember</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"test4:1:44ae7634-4bb2-11ee-9fc5-200db0c7aa5b"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskCandidateGroup</span><span class="token punctuation">(</span>group<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskService<span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>完成任务。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"test4:1:44ae7634-4bb2-11ee-9fc5-200db0c7aa5b"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"赵云"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="#mulu" rel="nofollow">回到目录…</a></p> 
<hr> 
<p><strong>总结</strong>:<br> <font color="#999AAA">提示：这里对文章进行总结：<br> 本文是对flowable的进阶学习，学习了流程中任务分配的方式，候选人和候选组拾取任务，以及四种网关的使用。之后的学习内容将持续更新！！！</font></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9871c332037417517f9137cb073113d4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Flowable 之表结构分析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/741f4aa5cd896269157be01ee986ede3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">web引入live2d教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>