<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>时间序列预测之卷积神经网络CNN - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="时间序列预测之卷积神经网络CNN" />
<meta property="og:description" content="文章目录 1 前期准备1.1 引入库1.2 读取数据1.3 可视化 2 数据预处理2.1 划分训练集、测试集2.2 划分特征与标签 3 构建一维卷积神经网络4 训练模型4.1 划分batch4.2 设置损失函数4.3 参数初始化4.4 训练模型 5 模型结果5.1 损失函数曲线5.2 测试集的真实值与预测值曲线 1 前期准备 1.1 引入库 import numpy as np import pandas as pd import torch.nn as nn #用于构建网络 import torch import matplotlib.pyplot as plt import torch.nn.functional as F torch.set_default_tensor_type(torch.DoubleTensor) #将tensor的默认类型设置为双精度浮点类型（torch.doubletensor），便于反向传播 1.2 读取数据 本文选取了每月太阳黑子数据集，该数据集描述了1749年1月至2023 年10月观测到的太阳黑子数量的月度计数。
数据网址如下（也可以关注并私信博主来获取数据集）：
http://www.sidc.be/silso/datafiles
Data=pd.read_csv(&#34;E:\\代码学习\\CSDN博客\\CNN\\SN_m.csv&#34;) start_time=pd.to_datetime(&#34;1749-01-01&#34;) end_time=pd.to_datetime(&#34;2023-11-01&#34;) time=pd.date_range(start=start_time,end=end_time,freq=&#39;M&#39;)#生成时间序列 Data[&#39;time&#39;]=time #将时间设为索引 data=Data.set_index(&#39;time&#39;,drop=True, append=False, inplace=False, verify_integrity=False) series=np.array(data[&#39;Sunspots&#39;]) 1.3 可视化 从图中可以看出该数据集有很强的的季节性。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e2bd863251f1892c921397c6d5b15c54/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-16T10:46:40+08:00" />
<meta property="article:modified_time" content="2023-11-16T10:46:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">时间序列预测之卷积神经网络CNN</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1__3" rel="nofollow">1 前期准备</a></li><li><ul><li><a href="#11__4" rel="nofollow">1.1 引入库</a></li><li><a href="#12__16" rel="nofollow">1.2 读取数据</a></li><li><a href="#13__30" rel="nofollow">1.3 可视化</a></li></ul> 
  </li><li><a href="#2__40" rel="nofollow">2 数据预处理</a></li><li><ul><li><a href="#21__41" rel="nofollow">2.1 划分训练集、测试集</a></li><li><a href="#22__55" rel="nofollow">2.2 划分特征与标签</a></li></ul> 
  </li><li><a href="#3__107" rel="nofollow">3 构建一维卷积神经网络</a></li><li><a href="#4__152" rel="nofollow">4 训练模型</a></li><li><ul><li><a href="#41_batch_153" rel="nofollow">4.1 划分batch</a></li><li><a href="#42__168" rel="nofollow">4.2 设置损失函数</a></li><li><a href="#43__175" rel="nofollow">4.3 参数初始化</a></li><li><a href="#44__189" rel="nofollow">4.4 训练模型</a></li></ul> 
  </li><li><a href="#5__216" rel="nofollow">5 模型结果</a></li><li><ul><li><a href="#51__217" rel="nofollow">5.1 损失函数曲线</a></li><li><a href="#52__232" rel="nofollow">5.2 测试集的真实值与预测值曲线</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="1__3"></a>1 前期准备</h2> 
<h3><a id="11__4"></a>1.1 引入库</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn <span class="token comment">#用于构建网络</span>
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
torch<span class="token punctuation">.</span>set_default_tensor_type<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>DoubleTensor<span class="token punctuation">)</span>
<span class="token comment">#将tensor的默认类型设置为双精度浮点类型（torch.doubletensor），便于反向传播</span>
</code></pre> 
<h3><a id="12__16"></a>1.2 读取数据</h3> 
<p>本文选取了每月太阳黑子数据集，该数据集描述了1749年1月至2023 年10月观测到的太阳黑子数量的月度计数。<br> 数据网址如下（也可以关注并私信博主来获取数据集）：<br> <a href="http://www.sidc.be/silso/datafiles" rel="nofollow">http://www.sidc.be/silso/datafiles</a></p> 
<pre><code class="prism language-python">Data<span class="token operator">=</span>pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">"E:\\代码学习\\CSDN博客\\CNN\\SN_m.csv"</span><span class="token punctuation">)</span>
start_time<span class="token operator">=</span>pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span><span class="token string">"1749-01-01"</span><span class="token punctuation">)</span>
end_time<span class="token operator">=</span>pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span><span class="token string">"2023-11-01"</span><span class="token punctuation">)</span>
time<span class="token operator">=</span>pd<span class="token punctuation">.</span>date_range<span class="token punctuation">(</span>start<span class="token operator">=</span>start_time<span class="token punctuation">,</span>end<span class="token operator">=</span>end_time<span class="token punctuation">,</span>freq<span class="token operator">=</span><span class="token string">'M'</span><span class="token punctuation">)</span><span class="token comment">#生成时间序列</span>
Data<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span><span class="token operator">=</span>time
<span class="token comment">#将时间设为索引</span>
data<span class="token operator">=</span>Data<span class="token punctuation">.</span>set_index<span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">,</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> append<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> verify_integrity<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
series<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'Sunspots'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="13__30"></a>1.3 可视化</h3> 
<p>从图中可以看出该数据集有很强的的季节性。</p> 
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>data<span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'Sunspots'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Date'</span><span class="token punctuation">)</span>
</code></pre> 
<center> 
 <img src="https://images2.imgbox.com/f0/11/dE1Ipzhb_o.png"> 
</center> 
<h2><a id="2__40"></a>2 数据预处理</h2> 
<h3><a id="21__41"></a>2.1 划分训练集、测试集</h3> 
<p>自定义函数train_test_split用于划分训练集与测试集。其中series表示整体样本，split_prop表示训练集所占的比例。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">train_test_split</span><span class="token punctuation">(</span>series<span class="token punctuation">,</span>split_prop<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#split_prop表示训练集所占的比例</span>
    train <span class="token operator">=</span>series<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span>split_prop<span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">(</span>series<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    test<span class="token operator">=</span>series<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>split_prop<span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">(</span>series<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> train<span class="token punctuation">,</span>test
</code></pre> 
<p>将数据集的70%用作训练集，30%用作测试集</p> 
<pre><code class="prism language-python">split_prop<span class="token operator">=</span><span class="token number">0.7</span><span class="token comment">#设置划分比例</span>
train<span class="token punctuation">,</span>test<span class="token operator">=</span>train_test_split<span class="token punctuation">(</span>series<span class="token punctuation">,</span>split_prop<span class="token punctuation">)</span><span class="token comment">#划分</span>
</code></pre> 
<h3><a id="22__55"></a>2.2 划分特征与标签</h3> 
<p>自定义函数data_process用于滑动窗口采样，从而获得测试集训练集的特征和标签，其中windowsize表示滑窗大小，step表示滑动步长。固定滑动窗口采样示意如图所示：</p> 
<center> 
 <img src="https://images2.imgbox.com/08/e5/Z1hTABAf_o.png"> 
</center> 
<pre><code class="prism language-python"><span class="token keyword">import</span> random
<span class="token keyword">def</span> <span class="token function">data_process</span><span class="token punctuation">(</span>train<span class="token punctuation">,</span>test<span class="token punctuation">,</span>window_size<span class="token punctuation">,</span>step<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#将数据转为tensor数据结构并进行划窗操作，得到短序列</span>
    train_tensor<span class="token operator">=</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train<span class="token punctuation">)</span><span class="token comment">#将训练集数据转为tensor数据结构</span>
    train_window_split<span class="token operator">=</span>train_tensor<span class="token punctuation">.</span>unfold<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>window_size<span class="token punctuation">,</span>step<span class="token punctuation">)</span><span class="token comment">#获得训练集“卷”后的数据集</span>
    train_set<span class="token operator">=</span>train_window_split<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    test_tensor<span class="token operator">=</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token comment">#将测试集数据转为tensor数据结构</span>
    test_window_split<span class="token operator">=</span>test_tensor<span class="token punctuation">.</span>unfold<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>window_size<span class="token punctuation">,</span>step<span class="token punctuation">)</span><span class="token comment">#获得测试集“卷”后的数据集</span>
    test_set<span class="token operator">=</span>test_window_split<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">#将训练集中的各个短序列打乱</span>
    train_temp1<span class="token operator">=</span>train_set<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#转换为列表格式</span>
    <span class="token comment">#random.shuffle()将一个列表中的元素（短序列）打乱顺序，不生成新列表，只是将原列表次序打乱</span>
    random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>train_temp1<span class="token punctuation">)</span><span class="token comment">#打乱训练集</span>
    train_temp2<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>train_temp1<span class="token punctuation">)</span><span class="token comment">#建立数组，数组内容为打乱顺序的列表</span>
    
    <span class="token comment">#将短序列划分为Feature和Label</span>
    train_feature_array<span class="token operator">=</span>train_temp2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span>window_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    train_label_array<span class="token operator">=</span>train_temp2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>window_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token comment">#取各个短序列内最后一个值为该短序列的标签（即时序真实值）</span>
    test_temp1<span class="token operator">=</span>test_set<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#转换为列表格式</span>
    test_temp2<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>test_temp1<span class="token punctuation">)</span><span class="token comment">#建立数组</span>
    test_feature_array<span class="token operator">=</span>test_temp2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span>window_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    test_label_array<span class="token operator">=</span>test_temp2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>window_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    
    <span class="token comment">#将ndarray(N维数组类型的对象)转化为tensor</span>
    train_feature_tensor<span class="token operator">=</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_feature_array<span class="token punctuation">)</span>
    train_label<span class="token operator">=</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_label_array<span class="token punctuation">)</span>
    test_feature_tensor<span class="token operator">=</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>test_feature_array<span class="token punctuation">)</span>
    test_label<span class="token operator">=</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>test_label_array<span class="token punctuation">)</span>
    
    <span class="token comment">#扩展数据维度，符合CNN输出</span>
    train_feature<span class="token operator">=</span>train_feature_tensor<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>train_feature_tensor<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>train_feature_tensor<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    test_feature<span class="token operator">=</span>test_feature_tensor<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>test_feature_tensor<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>test_feature_tensor<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> train_feature<span class="token punctuation">,</span>train_label<span class="token punctuation">,</span>test_feature<span class="token punctuation">,</span>test_label
</code></pre> 
<pre><code class="prism language-python">window_size<span class="token operator">=</span><span class="token number">7</span><span class="token comment">#设置滑窗大小</span>
step<span class="token operator">=</span><span class="token number">1</span><span class="token comment">#设置滑动步长</span>
train_feature<span class="token punctuation">,</span>train_label<span class="token punctuation">,</span>test_feature<span class="token punctuation">,</span>test_label<span class="token operator">=</span>data_process<span class="token punctuation">(</span>train<span class="token punctuation">,</span>test<span class="token punctuation">,</span>window_size<span class="token punctuation">,</span>step<span class="token punctuation">)</span>
</code></pre> 
<p>训练集的特征与标签值如下所示：</p> 
<center> 
 <img src="https://images2.imgbox.com/c5/b4/OtXXpQ8o_o.png"> 
</center> 
<h2><a id="3__107"></a>3 构建一维卷积神经网络</h2> 
<p>本文设计的一维卷积神经网络网络示意图如图所示：</p> 
<center> 
 <img src="https://images2.imgbox.com/9d/6e/OYFhQvIk_o.png"> 
</center> 
<p>构建一维卷积神经网络代码如下：</p> 
<pre><code class="prism language-python"><span class="token comment">#定义一个类MyConv，继承于父类nn.Module（PyTorch 体系下所有神经网络模块的基类）</span>
<span class="token keyword">class</span> <span class="token class-name">MyConv</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#__init__是类的构造函数，self是类的实例</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MyConv<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#super()用于调用父类中的构造函数</span>
        <span class="token comment">#一层一维卷积</span>
        <span class="token comment">#nn.Sequential相当于一个容器，按照顺序存储模块</span>
        self<span class="token punctuation">.</span>conv1<span class="token operator">=</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv1d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>out_channels<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token comment">#Convid函数表示在由多个输入平面组成的输入信号上应用一维卷积</span>
        <span class="token comment">#其中in_channels输入信号通道数，out_channels卷积产生的通道，kernel_size卷积核尺寸</span>
        <span class="token comment">#stride卷积步长，padding输入的每一条边补充0的层数</span>
        self<span class="token punctuation">.</span>conv2<span class="token operator">=</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv1d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>out_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token comment">#激活函数ReLU</span>
        <span class="token comment">#将输出通道变为单值</span>
        self<span class="token punctuation">.</span>fc1<span class="token operator">=</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span>
        <span class="token comment">#nn.Linear定义一个神经网络的线性层</span>
        <span class="token comment">#第一个参数表示输入神经元个数，第二个表示输出神经元个数</span>
        self<span class="token punctuation">.</span>fc2<span class="token operator">=</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>X<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#在调用时可直接MyConv(data)，而不用MyConv.forward(data)</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token comment">#一维卷积</span>
        out<span class="token operator">=</span>F<span class="token punctuation">.</span>avg_pool1d<span class="token punctuation">(</span>out<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">#平均池化</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token comment">#一维卷积</span>
        out<span class="token operator">=</span>F<span class="token punctuation">.</span>avg_pool1d<span class="token punctuation">(</span>out<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">#平均池化</span>
        out<span class="token operator">=</span>out<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#去掉值为1的维度，即shape=1的维度</span>
        <span class="token comment">#[[[1,2,3],[3,4,5]]]  》 [[1,2,3],[3,4,5]]</span>
        <span class="token comment">#原来张量的shape为(1,2,3),squeeze()处理后张量的shape为(2,3)</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token keyword">return</span> out
<span class="token comment">#构建网络</span>
net<span class="token operator">=</span>MyConv<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="4__152"></a>4 训练模型</h2> 
<h3><a id="41_batch_153"></a>4.1 划分batch</h3> 
<p>这里先引申出几个神经网络的经典名词：batch、epoch、iteration：</p> 
<ul><li>batch：在神经网络模型训练时，比如有1000个样本，把这些样本分为10批，就是10个batch。每个批（batch）的大小为100，就是batch size=100。</li><li>epoch：使用训练集中的全部样本训练的次数，通俗地讲几次epoch就是整个数据集被训练几次。</li><li>iteration：使用batchsize数量的样本训练的次数，比如训练集有1000个样本，batchsize = 100 ，那么训练完整个训练集：iteration=10，epoch=1。</li></ul> 
<p>自定义函数data_iter用于划分batch。其中batch_size表示一个batch的大小，features表示特征，labels表示标签</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">data_iter</span><span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span>features<span class="token punctuation">,</span>labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
    num_examples<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>features<span class="token punctuation">)</span>
    indices<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>num_examples<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>num_examples<span class="token punctuation">,</span>batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        j<span class="token operator">=</span>torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span>indices<span class="token punctuation">[</span>i<span class="token punctuation">:</span> <span class="token builtin">min</span><span class="token punctuation">(</span>i<span class="token operator">+</span>batch_size<span class="token punctuation">,</span>num_examples<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> features<span class="token punctuation">.</span>index_select<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span>labels<span class="token punctuation">.</span>index_select<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>j<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="42__168"></a>4.2 设置损失函数</h3> 
<p>损失函数（loss function）就是用来度量模型的预测值f(x)与真实值Y的差异程度的运算函数。损失函数使用主要是在模型的训练阶段，每个批次的训练数据送入模型后，通过前向传播输出预测值，然后损失函数会计算出预测值和真实值之间的差异值，也就是损失值。得到损失值之后，模型通过反向传播去更新各个参数，来降低真实值与预测值之间的损失，使得模型生成的预测值往真实值方向靠拢，从而达到学习的目的。</p> 
<pre><code class="prism language-python"><span class="token comment">#损失函数-均方误差</span>
<span class="token keyword">def</span> <span class="token function">square_loss</span><span class="token punctuation">(</span>feature<span class="token punctuation">,</span>label<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>net<span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token operator">-</span>label<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token operator">/</span><span class="token number">2</span>
</code></pre> 
<h3><a id="43__175"></a>4.3 参数初始化</h3> 
<pre><code class="prism language-python"><span class="token comment">#参数初始化</span>
<span class="token keyword">for</span> params <span class="token keyword">in</span> net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#网络的参数包含网络的连接权重W和偏置b</span>
    torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span>params<span class="token punctuation">,</span>mean<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>std<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>
    <span class="token comment">#一般给网络中连接权重W初始化，初始化参数值符合均值为0，标准差为0.01的正态分布</span>

lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token comment">#学习率</span>
num_epochs<span class="token operator">=</span><span class="token number">100</span><span class="token comment">#训练轮数</span>
batch_size<span class="token operator">=</span><span class="token number">128</span><span class="token comment">#batch大小</span>
loss<span class="token operator">=</span>square_loss<span class="token comment">#损失函数</span>
optimizer<span class="token operator">=</span>torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>lr<span class="token punctuation">)</span>
<span class="token comment">#设置优化器，传入网络模型的参数，并设置学习率</span>
</code></pre> 
<h3><a id="44__189"></a>4.4 训练模型</h3> 
<pre><code class="prism language-python"><span class="token comment">#训练模型</span>
train_loss<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
test_loss<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">#模型训练</span>
<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#外循环训练</span>
    train_1<span class="token punctuation">,</span>test_1<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token comment">#更新训练集和测试机的损失函数值</span>
    <span class="token keyword">for</span> X<span class="token punctuation">,</span>y <span class="token keyword">in</span> data_iter<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span>train_feature<span class="token punctuation">,</span>train_label<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#内循环一个batch</span>
        l<span class="token operator">=</span>loss<span class="token punctuation">(</span>X<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#计算每一个batch中的损失函数，即输出值与真实值的差距</span>
        <span class="token keyword">if</span> optimizer <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">#optimizer.zero_grad()是把梯度置零，即把loss关于权重W的导数变成0</span>
        <span class="token keyword">elif</span> params <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grad <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> param <span class="token keyword">in</span> params<span class="token punctuation">:</span>
                param<span class="token punctuation">.</span>grad<span class="token punctuation">.</span>data<span class="token punctuation">.</span>zero_<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#反向传播</span>
        l<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#反向传播计算得到每个参数的梯度值（loss关于权重W的梯度）</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#通过梯度下降执行一步参数（权重W）更新</span>
    train_1<span class="token operator">=</span>loss<span class="token punctuation">(</span><span class="token punctuation">(</span>train_feature<span class="token punctuation">)</span><span class="token punctuation">,</span>train_label<span class="token punctuation">)</span>
    test_1<span class="token operator">=</span>loss<span class="token punctuation">(</span><span class="token punctuation">(</span>test_feature<span class="token punctuation">)</span><span class="token punctuation">,</span>test_label<span class="token punctuation">)</span>
    train_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>train_1<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    test_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>test_1<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'epoch %d,train loss %f,test loss %f'</span><span class="token operator">%</span><span class="token punctuation">(</span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>train_1<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>test_1<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="5__216"></a>5 模型结果</h2> 
<h3><a id="51__217"></a>5.1 损失函数曲线</h3> 
<pre><code class="prism language-python"><span class="token comment">#绘制损失函数loss曲线</span>
x<span class="token operator">=</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span>train_loss<span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'train_loss'</span><span class="token punctuation">,</span>linewidth<span class="token operator">=</span><span class="token number">1.5</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span>test_loss<span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'test_loss'</span><span class="token punctuation">,</span>linewidth<span class="token operator">=</span><span class="token number">1.5</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'epoch'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<center> 
 <img src="https://images2.imgbox.com/6d/ab/haCDQjCE_o.png"> 
</center> 
<h3><a id="52__232"></a>5.2 测试集的真实值与预测值曲线</h3> 
<pre><code class="prism language-python">test_predict<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
split_point<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>split_prop<span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">(</span>series<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#split_prop表示训练集所占的比例</span>
<span class="token comment">#split_point表示训练集和测试集的划分位置</span>
test_time<span class="token operator">=</span>time<span class="token punctuation">[</span>split_point<span class="token operator">+</span>window_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

<span class="token comment">#测试集真实序列</span>
test_true<span class="token operator">=</span>series<span class="token punctuation">[</span>split_point<span class="token operator">+</span>window_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token comment">#测试集预测序列</span>
test_predict<span class="token operator">=</span>net<span class="token punctuation">(</span>test_feature<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#画图</span>
<span class="token comment">#整体</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot2grid<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>test_time<span class="token punctuation">,</span>test_true<span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'true'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>test_time<span class="token punctuation">,</span>test_predict<span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'predict'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>fontsize<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<center> 
 <img src="https://images2.imgbox.com/88/5d/RO0MvUhU_o.png"> 
</center>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7e2bb0d1f792db7d7d4f8617528903b2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">iOS学习 --- Xcode 15 下载iOS_17.0.1_Simulator失败解决方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/43578fb2f708deb7b747cd9c3791410d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python爬虫--获取POI</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>