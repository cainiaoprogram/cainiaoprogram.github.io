<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ICMP 中的 ping 与 tracet - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ICMP 中的 ping 与 tracet" />
<meta property="og:description" content="目录 ICMPpingping的返回参数ping的工作过程ping 域名与ping IP 的区别ping 常用命令格式结合WireShark分析数据包ICMP报文IP数据报以太网帧数据链路层 Tracert ICMP ICMP（Internet Control Message Protocol）ICMP是一个网络层协议，是基于IP协议工作的，但是它并不是传输层的功能，因此仍然把它归结为网络层协议，Internet控制报文协议。它是TCP/IP协议簇的一个子协议，用于在IP主机、路由器之间传递控制消息。
那么ICMP有什么作用呢？
我们数据在网络中传输中，会封装成IP数据包，而IP协议的特点是面向无连接，且不可靠的，可靠性由上层来保证。IP协议所要做的就是尽最大努力把数据传输到目的地，如果当在路由器的转发中出错了而不能到达目的地时，IP协议对错误不进行任何报告和纠正，此时主机就不知道路由器那边有什么问题。而ICMP协议正好解决了这个问题。
ICMP主要有两种功能。
ping：一般用于勘测到达目的网络的连通性
tracert：用于确定ip数据包访问目标所采取的路径
ping 我们知道有时候我们用电脑去ping一个ip地址，去测试一下对这个ip地址之间的连通性，那么ping是如何进行测试的呢？
ping的返回参数 C:\Users\hp&gt;ping www.baidu.com 正在 Ping www.a.shifen.com [36.152.44.96] 具有 32 字节的数据: 来自 36.152.44.96 的回复: 字节=32 时间=74ms TTL=54 来自 36.152.44.96 的回复: 字节=32 时间=67ms TTL=54 来自 36.152.44.96 的回复: 字节=32 时间=46ms TTL=54 来自 36.152.44.96 的回复: 字节=32 时间=48ms TTL=54 36.152.44.96 的 Ping 统计信息: 数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)， 往返行程的估计时间(以毫秒为单位): 最短 = 46ms，最长 = 74ms，平均 = 58ms ICMP报文中有32个字节的测试数据；" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b8efa18dbd146d4ba60288be18024e6e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-17T23:18:29+08:00" />
<meta property="article:modified_time" content="2020-11-17T23:18:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ICMP 中的 ping 与 tracet</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#ICMP_1" rel="nofollow">ICMP</a></li><li><ul><li><a href="#ping_15" rel="nofollow">ping</a></li><li><ul><li><a href="#ping_18" rel="nofollow">ping的返回参数</a></li><li><a href="#ping_49" rel="nofollow">ping的工作过程</a></li><li><a href="#ping_ping_IP__79" rel="nofollow">ping 域名与ping IP 的区别</a></li><li><a href="#ping__124" rel="nofollow">ping 常用命令格式</a></li><li><a href="#WireShark_128" rel="nofollow">结合WireShark分析数据包</a></li><li><ul><li><a href="#ICMP_129" rel="nofollow">ICMP报文</a></li><li><a href="#IP_159" rel="nofollow">IP数据报</a></li><li><a href="#_165" rel="nofollow">以太网帧</a></li><li><a href="#_170" rel="nofollow">数据链路层</a></li></ul> 
   </li></ul> 
   </li><li><a href="#Tracert_175" rel="nofollow">Tracert</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="ICMP_1"></a>ICMP</h2> 
<p>ICMP（Internet Control Message Protocol）ICMP是一个网络层协议，是基于IP协议工作的，但是它并不是传输层的功能，因此仍然把它归结为网络层协议，Internet控制报文协议。它是TCP/IP协议簇的一个子协议，用于在IP主机、路由器之间传递控制消息。</p> 
<p>那么ICMP有什么作用呢？</p> 
<p>我们数据在网络中传输中，会封装成IP数据包，而IP协议的特点是面向无连接，且不可靠的，可靠性由上层来保证。IP协议所要做的就是尽最大努力把数据传输到目的地，如果当在路由器的转发中出错了而不能到达目的地时，IP协议对错误不进行任何报告和纠正，此时主机就不知道路由器那边有什么问题。而ICMP协议正好解决了这个问题。</p> 
<p>ICMP主要有两种功能。</p> 
<p>ping：一般用于勘测到达目的网络的连通性</p> 
<p>tracert：用于确定ip数据包访问目标所采取的路径</p> 
<h3><a id="ping_15"></a>ping</h3> 
<p>我们知道有时候我们用电脑去ping一个ip地址，去测试一下对这个ip地址之间的连通性，那么ping是如何进行测试的呢？</p> 
<h4><a id="ping_18"></a>ping的返回参数</h4> 
<pre><code>C:\Users\hp&gt;ping www.baidu.com

正在 Ping www.a.shifen.com [36.152.44.96] 具有 32 字节的数据:
来自 36.152.44.96 的回复: 字节=32 时间=74ms TTL=54
来自 36.152.44.96 的回复: 字节=32 时间=67ms TTL=54
来自 36.152.44.96 的回复: 字节=32 时间=46ms TTL=54
来自 36.152.44.96 的回复: 字节=32 时间=48ms TTL=54

36.152.44.96 的 Ping 统计信息:
    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
往返行程的估计时间(以毫秒为单位):
    最短 = 46ms，最长 = 74ms，平均 = 58ms
</code></pre> 
<p>ICMP报文中有32个字节的测试数据；<br> "时间=74ms"是往返时间。<br> "已发送=4"发送多个秒包、"已接收=4"收到多个回应包、"丢失=0"丢弃了多少个；<br> Minmum 最小值 、MAXimun 最大值、Average 平均值。</p> 
<pre><code>http://shifen.com是百度当年为了竞价排名这个广告系统注册的，
这个后台系统被命名为Shifen竞价排名，
以前的销售系统现在还叫shifen销售系统。
因为当年百度那个广告最低点击10分起价。
为什么有这么一个奇怪的名字呢？在《相信中国》中，
梁冬先生这样写道：“这个将来成就了百度80%收入的商业模式，
最初的管理平台是由一个叫刘子正的实习生主持开发的。
这也是唯一一个除http://baidu.com以外，
外人所知的百度公司所拥有的国际域名。
</code></pre> 
<h4><a id="ping_49"></a>ping的工作过程</h4> 
<p>①首先ping命令会先发送一个 ICMP Echo Request（请求包）给对端<br> ②对端接收到之后, 会返回一个ICMP Echo Reply（应答包）<br> ③若没有返回，就是超时了，会认为指定的网络地址不存在。<br> 注：默认情况下， ping命令会发送四次请求包，所以我们会看到<br> <img src="https://images2.imgbox.com/fd/ee/5cXMxbmh_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/5c/41/lyKH9Thx_o.png" alt="在这里插入图片描述"><br> 举个例子</p> 
<p><img src="https://images2.imgbox.com/da/3b/F5Dcg6w9_o.png" alt="在这里插入图片描述"><br> Pc1 ping PC2，我们在电脑上输入ping 192.168.1.2之后都发生了什么呢？</p> 
<p>① Ping 命令会构建一个 固定格式的 ICMP 请求数据包（Echo Request）</p> 
<p>② ICMP 协议将这个数据包，连同去往的地址，一起 交给IP 层协议</p> 
<p>③ IP协议将本机作为源地址，去往的地址为目的，加上一些其他的控制信息，交给数据链路层协议</p> 
<p>④数据链层封装源目MAC地址交给物理层</p> 
<p>⑤物理层将其转换成二进制比特流发出</p> 
<p>⑥目的主机将比特流转换为数据，收到Echo Request包开始拆包</p> 
<p>⑦拆开最外层帧头，发现目的地址与自己相同，继续拆包</p> 
<p>⑧继续拆开ip包头，发现协议号为（1），交给ICMP去处理</p> 
<p>⑨ ICMP收到之后进行响应，回复Echo reply</p> 
<h4><a id="ping_ping_IP__79"></a>ping 域名与ping IP 的区别</h4> 
<p>域名</p> 
<pre><code>C:\Users\hp&gt;ping www.baidu.com

正在 Ping www.a.shifen.com [61.135.185.32] 具有 32 字节的数据:
来自 61.135.185.32 的回复: 字节=32 时间=25ms TTL=54
来自 61.135.185.32 的回复: 字节=32 时间=26ms TTL=54
来自 61.135.185.32 的回复: 字节=32 时间=23ms TTL=54
来自 61.135.185.32 的回复: 字节=32 时间=23ms TTL=54

61.135.185.32 的 Ping 统计信息:
    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
往返行程的估计时间(以毫秒为单位):
    最短 = 23ms，最长 = 26ms，平均 = 24ms
</code></pre> 
<p>查下百度对应的IP</p> 
<pre><code>C:\Users\hp&gt;nslookup www.baidu.com
服务器:  cache1-xx
Address:  221.11.1.67

非权威应答:
名称:    www.a.shifen.com
Addresses:  61.135.169.121
          61.135.185.32
Aliases:  www.baidu.com
</code></pre> 
<p>IP</p> 
<pre><code>C:\Users\hp&gt;ping 221.11.1.67

正在 Ping 221.11.1.67 具有 32 字节的数据:
来自 221.11.1.67 的回复: 字节=32 时间=14ms TTL=59
来自 221.11.1.67 的回复: 字节=32 时间=9ms TTL=59
来自 221.11.1.67 的回复: 字节=32 时间=18ms TTL=59
来自 221.11.1.67 的回复: 字节=32 时间=6ms TTL=59

221.11.1.67 的 Ping 统计信息:
    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
往返行程的估计时间(以毫秒为单位):
    最短 = 6ms，最长 = 18ms，平均 = 11ms
</code></pre> 
<p>可以看到ping IP 明显比ping 域名快，除了第一次发包时的域名解析导致慢以外，当每次ping完得到响应之后，ping程序会尝试一次反向dns查询（reverse dns lookup）来获取对应的域名，如果查询速度很慢的话，就会给人似乎延迟很大的感觉，其实这也是ping感觉慢，但是每次ping的响应时间却并不慢的原因。ping指令有一个 -n 选项，加上之后可以阻止ping程序去进行反向dns查询，这样ping起来就“快”了。</p> 
<h4><a id="ping__124"></a>ping 常用命令格式</h4> 
<p>可以使用<code>ping /?</code>查看ping 命令相关参数<br> <img src="https://images2.imgbox.com/2b/cf/Vznr4Ben_o.png" alt="在这里插入图片描述"><br> 我们在电脑上去ping一个地址的时候，不仅能够看到网络是否能够通讯，还能够看到为什么不能进行通讯，比如请求超时，目的不可达，请求被拒绝等等，那么我们的电脑是如何知道这些原因的呢？我们来看一下ping包长什么样子。</p> 
<h4><a id="WireShark_128"></a>结合WireShark分析数据包</h4> 
<h5><a id="ICMP_129"></a>ICMP报文</h5> 
<p><img src="https://images2.imgbox.com/36/75/xOwwCojJ_o.jpg" alt="在这里插入图片描述"></p> 
<table><thead><tr><th>字段</th><th>解释</th></tr></thead><tbody><tr><td>类型</td><td>占据一个字节，标识ICMP报文的类型。ICMP报文类型可以分为两大类，分别是取值在1~127之间的差错报文，另一类是取值大于128的信息报文</td></tr><tr><td>代码</td><td>占据一个字节，与类型字段一起共同标识ICMP报文的详细类型</td></tr><tr><td>校验和</td><td>是将整个ICMP数据包（包括数据部分）以16位为一个单位采用CRC校验，然后按位取反后的值</td></tr></tbody></table> 
<p>注：Frame 即数据帧，WireShark可以看到第一行编号是95<br> <img src="https://images2.imgbox.com/a0/e6/y6phfTgP_o.png" alt="在这里插入图片描述"></p> 
<p>1、ICMP报文的前4个字节是统一的格式，共有三个字段：即类型，代码和检验和</p> 
<p>2、ICMP所有报文的前4个字节都是一样的，但是剩下的其他字节则互不相同。其它字段都ICMP报文类型不同而不同。</p> 
<p>3、8位类型和8位代码字段一起决定了ICMP报文的类型</p> 
<p>常用：</p> 
<p>类型0，代码0：表示回显应答(ping应答)</p> 
<p>类型8，代码0：表示回显请求(ping请求)。<br> 类型11，代码0：超时</p> 
<p>类型3，代码0：网络不可达</p> 
<p>类型3，代码1：主机不可达</p> 
<p>类型5，代码0：重定向<br> 例：<br> <img src="https://images2.imgbox.com/7a/62/Ql1z6stf_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="IP_159"></a>IP数据报</h5> 
<p>ICMP+IP头部构成IP数据报<br> <img src="https://images2.imgbox.com/58/1c/GlQMLYXt_o.png" alt="在这里插入图片描述"><br> <strong>IP头部各字段:</strong><br> <img src="https://images2.imgbox.com/49/24/fhABFAo1_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4e/9e/dZTj4Df4_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_165"></a>以太网帧</h5> 
<p>我们选中以太帧报文（红色方框圈中的地方），则下面有14个字节被选中了（绿色方框圈中的地方）。可以看到圈中的数据分别是：目的地址的mac地址，源地址的mac地址，还有一个值为0x8000的数据。<br> <img src="https://images2.imgbox.com/95/e3/cxPArlhM_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/24/6b/dypjoL7F_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/cc/e1/0QzIqFJc_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_170"></a>数据链路层</h5> 
<p>双击第35帧数据包，可以得到如下的显示结果。点击数据链路层报文（红色方框标注的地方），可以看到整个74字节的报文内容（绿色方框圈起来的地方）就被选中了，这说明ping request数据链路层报文一共有74个字节。<br> <img src="https://images2.imgbox.com/d5/60/itwAWzCv_o.png" alt="在这里插入图片描述"><br> 双击该行，可以展开看到里面更详细的内容：<br> <img src="https://images2.imgbox.com/d8/e3/o1qFH1pc_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Tracert_175"></a>Tracert</h3> 
<p>Tracert工作原理：</p> 
<p>1.首先tracert送出3个<strong>TTL是1</strong>的IP 数据包到目的地，当路径上的第一个路由器收到这个数据包时，它将TTL减1，此时TTL等于0.</p> 
<ol start="2"><li> <p>所以该路由器会将此数据包丢掉，并送回一个ICMP time exceeded消息（TTL超时消息），里面包括发IP包的源地址，IP包的所有内容及路由器的IP地址</p> </li><li> <p>tracert 收到这个消息后，便知道这个路由器存在于这个路径上，接着tracert 再送出另一个<strong>TTL是2</strong> 的数据包，发现第2 个路由器…以此类推</p> </li><li> <p>当数据包到达目的地后，该主机则不会送回ICMP time exceeded消息</p> </li><li> <p>一旦到达目的地，由于tracert通过UDP数据包向不常见端口(30000以上)发送数据包，因此会收到「ICMP port unreachable」消息，故可判断到达目的地。</p> </li></ol> 
<p>Tracert每次发送三个数据包的原因是为了避免有时候网络不稳定而造成的丢包，所以发送三个，为了保证数据包能够正常到达。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1a10289a1008826391c3f7ee5cf1c1ae/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">使用h2数据库单元测试</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8ff3fa393e4841c6acad17ce37a11c18/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Default Boot Device Missing or Boot Filed  以及  grub rescue（台式电脑   安装双系统引发的一连串事件）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>