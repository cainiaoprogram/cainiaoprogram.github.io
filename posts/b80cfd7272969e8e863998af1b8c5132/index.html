<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring笔记（五）: spring 整合jdbc、hibernate、jpa - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Spring笔记（五）: spring 整合jdbc、hibernate、jpa" />
<meta property="og:description" content="一、简介
（一）需要的jar包
1、需要的jar包：spring、hibernate、mysql、xml、apache-commons等等的jar包。
2、以上jar包，如spring、xml和commos都是冗余的。
（二）分析
1、涉及到的实体、service、dao接口、jdbc配置文件以及service实现类都可以通用，只需要实现不同的dao实现类、配置、测试类。
2、通用的源码如下：
1）实体：
&lt;span style=&#34;font-size:18px;&#34;&gt;@Entity @Table(name=&#34;spring_person&#34;) //@Cache(usage=CacheConcurrencyStrategy.READ_WRITE,region=&#34;main.java.com.spring.entity.PersonEntity&#34;) // region用于设置单独的缓存机制，在ehcache.xml 中定义。 public class PersonEntity { @Id @Column(name=&#34;person_id&#34;,nullable=true ) @GeneratedValue(strategy=GenerationType.AUTO) private int personId; private String name; public PersonEntity() { } public int getPersonId() { return personId; } public void setPersonId(int personId) { this.personId = personId; } public String getName() { return name; } public void setName(String name) { this.name = name; } } &lt;/span&gt; 2）service接口：
&lt;span style=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b80cfd7272969e8e863998af1b8c5132/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-25T09:50:58+08:00" />
<meta property="article:modified_time" content="2022-05-25T09:50:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring笔记（五）: spring 整合jdbc、hibernate、jpa</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>一、简介</strong></p> 
<p>（一）需要的jar包</p> 
<p>1、需要的jar包：spring、hibernate、mysql、xml、apache-commons等等的jar包。</p> 
<p><img alt="" src="https://images2.imgbox.com/44/27/nK1PTth9_o.png">  <img alt="" src="https://images2.imgbox.com/07/7d/ie5Fp0uH_o.png">  <img alt="" src="https://images2.imgbox.com/4e/7a/V2sRPGxW_o.png"></p> 
<p></p> 
<p> <img alt="" src="https://images2.imgbox.com/15/43/G30MweIF_o.png"> <img alt="" src="https://images2.imgbox.com/4c/4a/B7udesiV_o.png"></p> 
<p></p> 
<p>2、以上jar包，如spring、xml和commos都是冗余的。</p> 
<p></p> 
<p>（二）分析</p> 
<p>1、涉及到的实体、service、dao接口、jdbc配置文件以及service实现类都可以通用，只需要实现不同的dao实现类、配置、测试类。</p> 
<p>2、通用的源码如下：</p> 
<p>1）实体：</p> 
<p></p> 
<pre class="has"><code class="language-java">&lt;span style="font-size:18px;"&gt;@Entity
@Table(name="spring_person")
//@Cache(usage=CacheConcurrencyStrategy.READ_WRITE,region="main.java.com.spring.entity.PersonEntity")
// region用于设置单独的缓存机制，在ehcache.xml 中定义。
public class PersonEntity {
	
	@Id
	@Column(name="person_id",nullable=true )
	@GeneratedValue(strategy=GenerationType.AUTO)
	private int personId;
	
	private String name;
	
	public PersonEntity() {
	}
	
	public int getPersonId() {
		return personId;
	}
	public void setPersonId(int personId) {
		this.personId = personId;
	}
	public String getName() {
		return name;
	}
	public void setName(String name) {
		this.name = name;
	}
}
&lt;/span&gt;</code></pre> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p>2）service接口：</p> 
<p></p> 
<pre class="has"><code class="language-java">&lt;span style="font-size:18px;"&gt;/**
 * 业务接口
 * PersonService
 * @title
 * @desc
 * @author SAM-SHO
 * @Jan 17, 2015
 */
public interface PersonService {
	/**
	 * 保存用户实体
	 * @param name
	 */
	public void save(PersonEntity persionEntity);
	
	/**
	 * 删除用户实体
	 * @param id
	 */
	public void delete(int id);
	
	/**
	 * 查询编号为id的使用用户姓名
	 * @param id
	 */
	public String queryPersonName(int id);
	
	/**
	 * 查询编号为id的用户
	 * @param id
	 */
	public PersonEntity getPerson(int id);
	
	/**
	 * 查询所有的PersonEntity
	 * @return
	 */
	public List&lt;PersonEntity&gt; getAllPerson();

	
	/**
	 * 更新实体
	 * @param name
	 * @param id
	 */
	public void update(String name ,int id);
}
&lt;/span&gt;</code></pre> 
<p><br> 3）service实现类，注入dao的接口。</p> 
<p></p> 
<p></p> 
<pre class="has"><code class="language-java">&lt;span style="font-size:18px;"&gt;/**
 * 业务实现类
 * PersionServiceImpl
 * @title
 * @desc
 * @author SAM-SHO
 * @Jan 17, 2015
 */
@Service
@Transactional
public class PersonServiceImpl implements PersonService {

	@Resource
	private PersonDao personDao;//利用接口

	@Transactional(readOnly=true,timeout=100,isolation=Isolation.DEFAULT)
	@Override
	public void save(PersonEntity persionEntity) {
		personDao.save(persionEntity);
	}

	@Transactional(rollbackFor=Exception.class)//任何异常就回滚
	@Override
	public void delete(int id) {
		personDao.delete(id);		
	}

	@Override
	public String queryPersonName(int id) {
		
		return personDao.queryPersonName(id);
	}

	@Transactional(noRollbackFor=RuntimeException.class)//运行异常就不会回滚
	@Override
	public void update(String name, int id) {
		personDao.update(name, id);		
	}
	
	
	public PersonDao getPersonDao() {
		return personDao;
	}

	public void setPersonDao(PersonDao personDao) {
		this.personDao = personDao;
	}

	@Override
	public PersonEntity getPerson(int id) {
		return personDao.getPerson(id);
		 
	}

	@Override
	public List&lt;PersonEntity&gt; getAllPerson() {
		
		return personDao.getAllPerson();
	}
	
}
&lt;/span&gt;</code></pre> 
<p><br> 4）dao接口</p> 
<p></p> 
<p></p> 
<pre class="has"><code class="language-java">&lt;span style="font-size:18px;"&gt;/**
 * 
 * @Title: 
 * @Description:
 * @Copyright: Copyright (c) 2015
 * @Company: 
 *
 * @author: SAM-SHO
 * @version: 1.0
 * @CreateDate：Jan 21, 2015
 */
public interface PersonDao {
	/**
	 * 保存用户实体
	 * @param name
	 */
	public void save(PersonEntity persionEntity);
	
	/**
	 * 删除用户实体
	 * @param id
	 */
	public void delete(int id);
	
	/**
	 * 查询编号为id的使用用户姓名
	 * @param id
	 */
	public String queryPersonName(int id);
	
	/**
	 * 查询编号为id的用户
	 * @param id
	 */
	public PersonEntity getPerson(int id);
	
	/**
	 * 查询所有的PersonEntity
	 * @return
	 */
	public List&lt;PersonEntity&gt; getAllPerson();
	
	/**
	 * 更新实体
	 * @param name
	 * @param id
	 */
	public void update(String name ,int id);
}
&lt;/span&gt;</code></pre> 
<p><br> 5）jdbc配置文件：</p> 
<p></p> 
<p></p> 
<pre class="has"><code class="language-html">&lt;span style="font-size:18px;"&gt;driverClassName=com.mysql.jdbc.Driver
url=jdbc\:mysql\://localhost\:3306/spring?useUnicode\=true&amp;characterEncoding\=UTF-8
username=root
password=root
initialSize=1
maxActive=500
maxIdle=2
minIdle=1
&lt;/span&gt;</code></pre> 
<p></p> 
<p></p> 
<p></p> 
<p>3、spring中Bean管理与注入，事务都采用注解。</p> 
<p></p> 
<p><strong>二、spring 整合jdbc</strong></p> 
<p>（一）配置文件：</p> 
<p></p> 
<pre class="has"><code class="language-html">&lt;span style="font-size:18px;"&gt;&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
	xmlns:aop="http://www.springframework.org/schema/aop" xmlns:tx="http://www.springframework.org/schema/tx"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context-2.5.xsd
           http://www.springframework.org/schema/aop
           http://www.springframework.org/schema/aop/spring-aop-2.5.xsd
           http://www.springframework.org/schema/tx 
           http://www.springframework.org/schema/tx/spring-tx-2.5.xsd"&gt;

	&lt;!-- 自动扫描 --&gt;
	&lt;context:component-scan base-package="main.java.com.spring.jdbc" /&gt;
	&lt;!-- 打开aop 注解 --&gt;
	&lt;aop:aspectj-autoproxy /&gt;


	&lt;!-- 配置数据源 --&gt;
	&lt;context:property-placeholder location="classpath:jdbc.properties" /&gt;&lt;!-- location指向jdbc.properties配置 --&gt;
	&lt;bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource"
		destroy-method="close"&gt;
		&lt;property name="driverClassName" value="${driverClassName}" /&gt;
		&lt;property name="url" value="${url}" /&gt;
		&lt;property name="username" value="${username}" /&gt;
		&lt;property name="password" value="${password}" /&gt;
		&lt;!-- 连接池启动时的初始值 --&gt;
		&lt;property name="initialSize" value="${initialSize}" /&gt;
		&lt;!-- 连接池的最大值 --&gt;
		&lt;property name="maxActive" value="${maxActive}" /&gt;
		&lt;!-- 最大空闲值.当经过一个高峰时间后，连接池可以慢慢将已经用不到的连接慢慢释放一部分，一直减少到maxIdle为止 --&gt;
		&lt;property name="maxIdle" value="${maxIdle}" /&gt;
		&lt;!-- 最小空闲值.当空闲的连接数少于阀值时，连接池就会预申请去一些连接，以免洪峰来时来不及申请 --&gt;
		&lt;property name="minIdle" value="${minIdle}" /&gt;
	&lt;/bean&gt;

	&lt;!-- 需要把 dataSource 注入到jdbcTemplate--&gt;
	&lt;bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate"&gt;
		&lt;property name="dataSource" ref="dataSource" /&gt;
	&lt;/bean&gt;

	&lt;!-- 配置JDBC的事物管理器：DataSourceTransactionManager --&gt;
	&lt;bean id="txManager"
		class="org.springframework.jdbc.datasource.DataSourceTransactionManager"&gt;
		&lt;property name="dataSource" ref="dataSource" /&gt;
	&lt;/bean&gt;
	
	&lt;!-- 注解事物 --&gt;
	&lt;!-- &lt;tx:annotation-driven transaction-manager="txManager" /&gt; --&gt;
	
	&lt;!-- XML事物 --&gt;
	&lt;aop:config&gt;
		&lt;aop:pointcut id="transationPointCut" expression="execution(* main.java.com.spring.jdbc.service..*.*(..))" /&gt;
		&lt;aop:advisor advice-ref="txAdvice" pointcut-ref="transationPointCut"/&gt;
	&lt;/aop:config&gt;
	
	&lt;tx:advice id="txAdvice" transaction-manager="txManager"&gt; 
		&lt;tx:attributes&gt;
			&lt;tx:method name="get*" read-only="true" propagation="NOT_SUPPORTED"/&gt;
			&lt;tx:method name="*"  propagation="REQUIRED" isolation="DEFAULT" /&gt;
		&lt;/tx:attributes&gt;
	&lt;/tx:advice&gt;

&lt;/beans&gt;

&lt;/span&gt;</code></pre> 
<p></p> 
<p></p> 
<p>1、JDBC的事务管理器为：DataSourceTransactionManager</p> 
<p><br>  </p> 
<p>（二）、dao实现类：使用 JdbcTemplate</p> 
<p></p> 
<pre class="has"><code class="language-java">&lt;span style="font-size:18px;"&gt;/**
 * 
 * PersonDaoImpl
 * @title
 * @desc
 * @author SAM-SHO
 * @Dec 28, 2014 
 */

@Repository
public class PersonDaoImpl implements PersonDao {
	
	//使用JdbcTemplate，注意需要在配置中，把dataSource数据源注入到jdbcTemplate
	@Resource
	private JdbcTemplate jdbcTemplate;
	

	@Override
	public void save(PersonEntity persionEntity) {
		String sql = "insert into spring_person (person_id, name) values(?,?)";
		jdbcTemplate.update(sql, new Object[]{persionEntity.getPersonId(),persionEntity.getName()}, new int[]{Types.INTEGER,Types.VARCHAR});
	}

	@Override
	public void delete(int id) {
		String sql = "delete from spring_person  where person_id = ?";
		jdbcTemplate.update(sql, new Object[]{id}, new int[]{Types.INTEGER});
		
	}

	@Override
	public String queryPersonName(int id) {
		
		String sql = "select a.name from spring_person a where a.person_id = ?";
		String name = jdbcTemplate.queryForObject(sql, new Object[]{id}, String.class);
		return name;
	}
	
	public PersonEntity getPerson(int id) {
		
		String sql = "select a.* from spring_person a where a.person_id = ?";
		PersonEntity personEntity = jdbcTemplate.queryForObject(sql, new Object[]{id},new RowMapper&lt;PersonEntity&gt;(){

			@Override
			public PersonEntity mapRow(ResultSet rs, int index) throws SQLException {
				
				PersonEntity person = new PersonEntity();
				person.setPersonId(rs.getInt("person_id"));
				person.setName(rs.getString("name"));
				return person;
			}
		});
		
		return personEntity;
	}
	

	@Override
	public List&lt;PersonEntity&gt; getAllPerson() {
		
		String sql = "select a.* from spring_person a";
		List&lt;PersonEntity&gt; lists = jdbcTemplate.query(sql, new RowMapper&lt;PersonEntity&gt;(){

			@Override
			public PersonEntity mapRow(ResultSet rs, int index) throws SQLException {
				
				PersonEntity person = new PersonEntity();
				person.setPersonId(rs.getInt("person_id"));
				person.setName(rs.getString("name"));
				return person;
			}
		});

		return lists;
	}


	
	
	@Override
	public void update(String name, int id) {
		String sql = "update spring_person a set a.name = ? where a.person_id = ?";
		jdbcTemplate.update(sql, new Object[]{name,id}, new int[]{Types.VARCHAR,Types.INTEGER});
		
	}


}
&lt;/span&gt;</code></pre> 
<p><br> 1、使用JdbcTemplate，注意需要在配置中，把dataSource数据源注入到jdbcTemplate</p> 
<p></p> 
<p></p> 
<p>（三）、测试</p> 
<p></p> 
<pre class="has"><code class="language-java">&lt;span style="font-size:18px;"&gt;/**
 * SpringJdbcTest
 * @Title: spring整合jdbc测试
 * @Description:
 * @Copyright: Copyright (c) 2015
 * @Company: 
 *
 * @author: SAM-SHO
 * @version: 1.0
 * @CreateDate：Jan 21, 2015
 */
public class SpringJdbcTest {

	private PersonService mPersonService;
	
	@Before
	public void init(){
		ApplicationContext cxt = new ClassPathXmlApplicationContext("application-Jdbc-Context.xml");
		mPersonService = (PersonService) cxt.getBean("personServiceImpl");
		
	}
	
	
	@Test
	public void save() {
		PersonEntity persionEntity = new  PersonEntity();
		persionEntity.setName("Sam-Sho-99");
		//增
		mPersonService.save(persionEntity); 
		
	}
	
	@Test
	public void delete() {
		
		//删除
		mPersonService.delete(5);
		
	}

	@Test
	public void update() {
		
		//修改
		mPersonService.update("蓝胖子", 6);
		
	}
	
	
	@Test
	public void query() {
		
		//查询一个实体
		PersonEntity persionEntity = mPersonService.getPerson(9);
		System.out.println(persionEntity.getPersonId());
		System.out.println(persionEntity.getName());
		
		// 查询名字
		String personName = mPersonService.queryPersonName(8);
		System.out.println(personName);
		
		
		//查询多个实体
		ArrayList&lt;PersonEntity&gt; lists = (ArrayList&lt;PersonEntity&gt;) mPersonService.getAllPerson();
		for (PersonEntity personEntity : lists) {
			System.out.println(personEntity.getPersonId());
			System.out.println(personEntity.getName());
		}
	}
		
}&lt;/span&gt;</code></pre> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p><strong>三、spring 整合hibernate</strong></p> 
<p></p> 
<p>（一）配置</p> 
<p></p> 
<pre class="has"><code class="language-html">&lt;span style="font-size:18px;"&gt;&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
	xmlns:aop="http://www.springframework.org/schema/aop" xmlns:tx="http://www.springframework.org/schema/tx"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context-2.5.xsd
           http://www.springframework.org/schema/aop
           http://www.springframework.org/schema/aop/spring-aop-2.5.xsd
           http://www.springframework.org/schema/tx 
           http://www.springframework.org/schema/tx/spring-tx-2.5.xsd"&gt;

	&lt;!-- 自动扫描 --&gt;
	&lt;context:component-scan base-package="main.java.com.spring.hibernate" /&gt;
	&lt;!-- 打开aop 注解 --&gt;
	&lt;aop:aspectj-autoproxy /&gt;


	&lt;!-- 配置数据源 --&gt;
	&lt;context:property-placeholder location="classpath:jdbc.properties" /&gt;
	&lt;bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource"
		destroy-method="close"&gt;
		&lt;property name="driverClassName" value="${driverClassName}" /&gt;
		&lt;property name="url" value="${url}" /&gt;
		&lt;property name="username" value="${username}" /&gt;
		&lt;property name="password" value="${password}" /&gt;
		&lt;!-- 连接池启动时的初始值 --&gt;
		&lt;property name="initialSize" value="${initialSize}" /&gt;
		&lt;!-- 连接池的最大值 --&gt;
		&lt;property name="maxActive" value="${maxActive}" /&gt;
		&lt;!-- 最大空闲值.当经过一个高峰时间后，连接池可以慢慢将已经用不到的连接慢慢释放一部分，一直减少到maxIdle为止 --&gt;
		&lt;property name="maxIdle" value="${maxIdle}" /&gt;
		&lt;!-- 最小空闲值.当空闲的连接数少于阀值时，连接池就会预申请去一些连接，以免洪峰来时来不及申请 --&gt;
		&lt;property name="minIdle" value="${minIdle}" /&gt;
	&lt;/bean&gt;

	&lt;!-- Hibernate 的 sessionFactory（使用注解） ，注入数据源和配置 --&gt;
	&lt;!-- &lt;bean id="sessionFactory" class="org.springframework.orm.hibernate4.LocalSessionFactoryBean" hibernate4的配置--&gt;
	&lt;bean id="sessionFactory" class="org.springframework.orm.hibernate3.annotation.AnnotationSessionFactoryBean" destroy-method="destroy"&gt;
		&lt;property name="dataSource" ref="dataSource" /&gt;

		&lt;!-- 自动扫描entity包下所有实体 --&gt;
		&lt;property name="packagesToScan"&gt;
			&lt;list&gt;
				&lt;value&gt;main.java.com.spring.entity&lt;/value&gt;
			&lt;/list&gt;
		&lt;/property&gt;
		
		&lt;property name="hibernateProperties"&gt;
			&lt;value&gt;
				hibernate.dialect=org.hibernate.dialect.MySQL5Dialect
				hibernate.hbm2ddl.auto=update
				hibernate.show_sql=false
				hibernate.format_sql=false
				hibernate.cache.use_second_level_cache=true
				hibernate.cache.use_query_cache=false
				hibernate.cache.provider_class=org.hibernate.cache.EhCacheProvider 
		      &lt;/value&gt;
		&lt;/property&gt;

	&lt;/bean&gt;

	&lt;!-- 配置Hibernate的事物管理器 ：HibernateTransactionManager--&gt;
	&lt;bean id="txManager" class="org.springframework.orm.hibernate3.HibernateTransactionManager"&gt;
		&lt;property name="sessionFactory" ref="sessionFactory"&gt;&lt;/property&gt;
	&lt;/bean&gt;

	&lt;!-- 注解事物 --&gt;
	&lt;tx:annotation-driven transaction-manager="txManager" /&gt; 

&lt;/beans&gt;

&lt;/span&gt;</code></pre> 
<p></p> 
<p></p> 
<p></p> 
<p>1、启用hibernate的 二级缓存：EhCacheProvider</p> 
<p></p> 
<pre class="has"><code class="language-html">&lt;span style="font-size:18px;"&gt;				hibernate.cache.use_second_level_cache=true
				hibernate.cache.use_query_cache=false
				hibernate.cache.provider_class=org.hibernate.cache.EhCacheProvider &lt;/span&gt;</code></pre> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p>2、配置Hibernate的事物管理器 ：HibernateTransactionManager 。</p> 
<p></p> 
<p>（二）dao实现类</p> 
<p></p> 
<pre class="has"><code class="language-java">&lt;span style="font-size:18px;"&gt;/**
 * 
 * PersonDaoImpl
 * @title
 * @desc
 * @author SAM-SHO
 * @Dec 28, 2014 
 */

@Repository
public class PersonDaoImpl implements PersonDao {
	
	
	@Resource
	private SessionFactory sessionFactory;
	
	private Session getSession(){
		return sessionFactory.getCurrentSession();
	}
	
	@Override
	public void save(PersonEntity persionEntity) {
		getSession().persist(persionEntity);
	}

	@Override
	public void delete(int id) {
		sessionFactory.getCurrentSession().delete(sessionFactory.getCurrentSession().load(PersonEntity.class, id));
		
	}

	@Override
	public String queryPersonName(int id) {
		
		String sql = "select a.name from spring_person a where a.person_id = ?";
		String name = (String) sessionFactory.getCurrentSession().createSQLQuery(sql).setParameter(0, id).uniqueResult();
		return name;
	}
	
	public PersonEntity getPerson(int id) {
		return (PersonEntity) sessionFactory.getCurrentSession().get(PersonEntity.class, id);
		
	}
	

	@SuppressWarnings("unchecked")
	@Override
	public List&lt;PersonEntity&gt; getAllPerson() {
		
		String hql = "from PersonEntity";
		return sessionFactory.getCurrentSession().createQuery(hql).list();//使用hql
		 
	}

	@Override
	public void update(String name, int id) {
		String sql = "update spring_person a set a.name = ? where a.person_id = ?";
		sessionFactory.getCurrentSession().createSQLQuery(sql)//使用sql
		.setParameter(0, name)
		.setParameter(1, id)
		.executeUpdate();
	}

	public SessionFactory getSessionFactory() {
		return sessionFactory;
	}

	public void setSessionFactory(SessionFactory sessionFactory) {
		this.sessionFactory = sessionFactory;
	}
}
&lt;/span&gt;</code></pre> 
<p></p> 
<p></p> 
<p></p> 
<p>（三）测试</p> 
<p></p> 
<pre class="has"><code class="language-java">&lt;span style="font-size:18px;"&gt;/**
 * 
 * @Title: 
 * @Description:
 * @Copyright: Copyright (c) 2015
 * @Company: 
 *
 * @author: SAM-SHO
 * @version: 1.0
 * @CreateDate：Jan 21, 2015
 */
public class SpringHibernateTest {
	
	
	
	private PersonService mPersonService;
	
	@Before
	public void init(){
		ApplicationContext cxt = new ClassPathXmlApplicationContext("application-hibernate-Context.xml");
		mPersonService = (PersonService) cxt.getBean("personServiceImpl");
		
	}
	
	
	
	@Test
	public void save() {
		PersonEntity persionEntity = new  PersonEntity();
		persionEntity.setName("Sam-Sho-99");
		//增
		mPersonService.save(persionEntity); 
		
	}
	
	@Test
	public void delete() {
		
		//删除
		mPersonService.delete(16);
		
	}

	@Test
	public void update() {
		
		//修改
		mPersonService.update("蓝胖子", 13);
		
	}
	
	
	@Test
	public void query() {
		
		//查询一个实体
//		PersonEntity persionEntity = mPersonService.getPerson(9);
//		System.out.println(persionEntity.getPersonId());
//		System.out.println(persionEntity.getName());
//		
//		// 查询名字
//		String personName = mPersonService.queryPersonName(8);
//		System.out.println(personName);
		
		
		//查询多个实体
		ArrayList&lt;PersonEntity&gt; lists = (ArrayList&lt;PersonEntity&gt;) mPersonService.getAllPerson();
		for (PersonEntity personEntity : lists) {
			System.out.println(personEntity.getPersonId());
			System.out.println(personEntity.getName());
		}
	}
		
}
&lt;/span&gt;</code></pre> 
<p></p> 
<p></p> 
<p></p> 
<p>（四）使用二级缓存 ehcache.xml</p> 
<p></p> 
<pre class="has"><code class="language-html">&lt;span style="font-size:18px;"&gt;&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!-- 
    defaultCache节点为缺省的缓存策略
     maxElementsInMemory 内存中最大允许存在的对象数量
     eternal 设置缓存中的对象是否永远不过期 true
     overflowToDisk 把溢出的对象存放到硬盘上
     timeToIdleSeconds 指定缓存对象空闲多长时间就过期,过期的对象会被清除掉
     timeToLiveSeconds 指定缓存对象总的存活时间
     diskPersistent 当jvm结束是是否持久化对象
     diskExpiryThreadIntervalSeconds 指定专门用于清除过期对象的监听线程的轮询时间
 --&gt;
&lt;ehcache&gt;
    &lt;diskStore path="D:\cache"/&gt;
    &lt;defaultCache  maxElementsInMemory="1000" eternal="false" overflowToDisk="true"
        timeToIdleSeconds="120"
        timeToLiveSeconds="180"
        diskPersistent="false"
        diskExpiryThreadIntervalSeconds="60"/&gt;
	&lt;cache name="main.java.com.spring.entity.PersonEntity" maxElementsInMemory="100" eternal="false"
    overflowToDisk="true" timeToIdleSeconds="300" timeToLiveSeconds="600" diskPersistent="false"/&gt;
    &lt;!-- 使用自定义cache，需要在该entity中使用 Cache 的region属性指定--&gt;
&lt;/ehcache&gt;
&lt;/span&gt;</code></pre> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p>（五）解决中文和懒加载问题：修改web.xml配置</p> 
<p></p> 
<pre class="has"><code class="language-html">&lt;span style="font-size:18px;"&gt;&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app version="2.5" 
	xmlns="http://java.sun.com/xml/ns/javaee" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xsi:schemaLocation="http://java.sun.com/xml/ns/javaee 
	http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"&gt;
	
	&lt;welcome-file-list&gt;
	  &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;
	&lt;/welcome-file-list&gt;
 	
    &lt;!-- 加载Spring初始化容器对象的监听器 --&gt;
	&lt;listener&gt;
	    &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;
	&lt;/listener&gt;
	&lt;!-- 设置Spring容器加载配置文件路径 --&gt;
	&lt;context-param&gt;
	    &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
	    &lt;param-value&gt;classpath*:applicationContext.xml&lt;/param-value&gt;
	&lt;/context-param&gt;
		
	&lt;!--中文过滤器     START   --&gt;
	&lt;filter&gt;
		&lt;filter-name&gt;encodingFilter&lt;/filter-name&gt;
		&lt;filter-class&gt;org.springframework.web.filter.CharacterEncodingFilter&lt;/filter-class&gt;
		&lt;init-param&gt;
			&lt;param-name&gt;encoding&lt;/param-name&gt;
			&lt;param-value&gt;UTF-8&lt;/param-value&gt;
		&lt;/init-param&gt;
	&lt;/filter&gt;
	&lt;filter-mapping&gt;
		&lt;filter-name&gt;encodingFilter&lt;/filter-name&gt;
		&lt;url-pattern&gt;/*&lt;/url-pattern&gt;
	&lt;/filter-mapping&gt;
	&lt;!--中文过滤器			END  --&gt;
	
	&lt;!-- 解决懒加载 --&gt;
	&lt;filter&gt;
		&lt;filter-name&gt;openSessionInView&lt;/filter-name&gt;
		&lt;filter-class&gt;org.springframework.orm.hibernate3.support.OpenSessionInViewFilter&lt;/filter-class&gt;
		&lt;init-param&gt;
			&lt;param-name&gt;sessionFactoryBeanName&lt;/param-name&gt;
			&lt;param-value&gt;sessionFactory&lt;/param-value&gt;
		&lt;/init-param&gt;
	&lt;/filter&gt;	
	&lt;filter-mapping&gt;
		&lt;filter-name&gt;openSessionInView&lt;/filter-name&gt;
		&lt;url-pattern&gt;*.action&lt;/url-pattern&gt;
	&lt;/filter-mapping&gt;
	
	&lt;!-- 设置Struts2  START--&gt;
	&lt;filter&gt;
		&lt;filter-name&gt;struts2&lt;/filter-name&gt;
		&lt;filter-class&gt;org.apache.struts2.dispatcher.ng.filter.StrutsPrepareAndExecuteFilter&lt;/filter-class&gt;
	&lt;/filter&gt;

	&lt;filter-mapping&gt;
		&lt;filter-name&gt;struts2&lt;/filter-name&gt;
		&lt;url-pattern&gt;/*&lt;/url-pattern&gt;
	&lt;/filter-mapping&gt;
	&lt;!-- Struts2  END--&gt;
  
&lt;/web-app&gt;
&lt;/span&gt;</code></pre> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p><strong>四、spring 整合</strong><strong>jpa</strong></p> 
<p></p> 
<p>（一）配置</p> 
<p></p> 
<pre class="has"><code class="language-html">&lt;span style="font-size:18px;"&gt;&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
	xmlns:aop="http://www.springframework.org/schema/aop" xmlns:tx="http://www.springframework.org/schema/tx"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context-2.5.xsd
           http://www.springframework.org/schema/aop
           http://www.springframework.org/schema/aop/spring-aop-2.5.xsd
           http://www.springframework.org/schema/tx 
           http://www.springframework.org/schema/tx/spring-tx-2.5.xsd"&gt;

	&lt;!-- 自动扫描 --&gt;
	&lt;context:annotation-config/&gt;
	&lt;context:component-scan base-package="main.java.com.spring.jpa" /&gt;

  
  	&lt;!-- JPA 当jpa底层使用hibernate实现，那么entityManagerFactory实际上就是sessionFactory--&gt;
  	&lt;bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalEntityManagerFactoryBean"&gt;
     	 &lt;!-- 持久化单元的名称，value的值必须与persistence.xml文件中 persistence-unit标签中 name属性的值保持一致 --&gt;
      	&lt;property name="persistenceUnitName" value="springJpa"/&gt;
  	&lt;/bean&gt;  

	&lt;!-- JPA的事物管理器： JpaTransactionManager--&gt;
  	&lt;bean id="txManager" class="org.springframework.orm.jpa.JpaTransactionManager"&gt;
  		&lt;property name="entityManagerFactory" ref="entityManagerFactory"/&gt;
 	 &lt;/bean&gt;
 	 
  	&lt;!-- 注解方式的事务 --&gt;
  	&lt;tx:annotation-driven transaction-manager="txManager"/&gt;


&lt;/beans&gt;

&lt;/span&gt;</code></pre> 
<p></p> 
<p></p> 
<p></p> 
<p>（二）Jpa持久化单元配置（代替jdbc.properties）</p> 
<p></p> 
<pre class="has"><code class="language-html">&lt;span style="font-size:18px;"&gt;&lt;?xml version="1.0"?&gt;
&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd" version="1.0"&gt;
   &lt;persistence-unit name="springJpa" transaction-type="RESOURCE_LOCAL"&gt;&lt;!-- 本地事务 --&gt;
      &lt;properties&gt;
         &lt;property name="hibernate.dialect" value="org.hibernate.dialect.MySQL5Dialect"/&gt;
         &lt;property name="hibernate.connection.driver_class" value="org.gjt.mm.mysql.Driver"/&gt;
         &lt;property name="hibernate.connection.username" value="root"/&gt;
         &lt;property name="hibernate.connection.password" value="root"/&gt;
         &lt;property name="hibernate.connection.url" value="jdbc:mysql://localhost:3306/spring?useUnicode=true&amp;characterEncoding=UTF-8"/&gt;
         &lt;property name="hibernate.max_fetch_depth" value="3"/&gt;
         &lt;property name="hibernate.hbm2ddl.auto" value="update"/&gt;
         &lt;property name="hibernate.show_sql" value="false"/&gt;
	     &lt;property name="hibernate.format_sql" value="false"/&gt;
      &lt;/properties&gt;
   &lt;/persistence-unit&gt;
&lt;/persistence&gt;


&lt;!-- 
1. persistence.xml名称不能更改 ，持久化单元名称
2. name="springJpa" 对应   beans.xml中的&lt;property name="persistenceUnitName" value="springJpa"/&gt;

--&gt;&lt;/span&gt;</code></pre> 
<p></p> 
<p></p> 
<p>1、Jpa的实现使用的还是Hibernate 。</p> 
<p>2、持久化单元的配置，一定要放在classpath下 META-INF/ 文件夹下。</p> 
<p><img alt="" src="https://images2.imgbox.com/be/27/MH3nb3bp_o.png"></p> 
<p><br>  </p> 
<p>（三）dao的实现类</p> 
<p></p> 
<pre class="has"><code class="language-java">&lt;span style="font-size:18px;"&gt;/**
 * 
 * @Title: 
 * @Description:
 * @Copyright: Copyright (c) 2015
 * @Company: 
 *
 * @author: SAM-SHO
 * @version: 1.0
 * @CreateDate：Jan 21, 2015
 */
@Repository
public class PersonDaoImpl implements PersonDao {
	
	//注入EntityManager
	@PersistenceContext
	EntityManager entityManager;
	
	@Override
	public void save(PersonEntity persionEntity) {
		
		entityManager.persist(persionEntity);
	}

	@Override
	public void delete(int id) {
		//getReference类似于sessionFactory的load方法
		entityManager.remove(entityManager.getReference(PersonEntity.class, id));
	}

	@Override
	public String queryPersonName(int id) {
		
		String sql = "select a.name from PersonEntity a where a.personId = ?";
		return (String) entityManager.createQuery(sql).setParameter(1, id).getSingleResult();
	}
	
	public PersonEntity getPerson(int id) {
		return entityManager.find(PersonEntity.class, id);
	}
	

	@SuppressWarnings("unchecked")
	@Override
	public List&lt;PersonEntity&gt; getAllPerson() {
		
		String hql = "select o from PersonEntity o";
		return entityManager.createQuery(hql).getResultList();
	}

	@Override
	public void update(String name, int id) {
		String sql = "update PersonEntity a set a.name = ? where a.personId = ?";
		entityManager.createQuery(sql)
		.setParameter(1, name)
		.setParameter(2, id)//这边的参数位置与sessionFaction的不同，从1开始
		.executeUpdate();
		
//		entityManager.merge(PersonEntity)

	}
}
&lt;/span&gt;</code></pre> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p>（四）测试</p> 
<p></p> 
<pre class="has"><code class="language-java">&lt;span style="font-size:18px;"&gt;/**
 * 
 * @Title: 
 * @Description:
 * @Copyright: Copyright (c) 2015
 * @Company: 
 *
 * @author: SAM-SHO
 * @version: 1.0
 * @CreateDate：Jan 21, 2015
 */
public class SpringJpaTest {

	
	private PersonService mPersonService;
	
	@Before
	public void init(){
		ApplicationContext cxt = new ClassPathXmlApplicationContext("application-jpa-Context.xml");
		mPersonService = (PersonService) cxt.getBean("personServiceImpl");
		
	}
	
	@Test
	public void save() {
		PersonEntity persionEntity = new  PersonEntity();
		persionEntity.setName("Sam-Sho-JPA");
		//增
		mPersonService.save(persionEntity); 
		
	}
	
	@Test
	public void delete() {
		
		//删除
		mPersonService.delete(16);
		
	}

	@Test
	public void update() {
		
		//修改
		mPersonService.update("蓝胖子", 16);
		
	}
	
	
	@Test
	public void query() {
		
		//查询一个实体
//		PersonEntity persionEntity = mPersonService.getPerson(16);
//		System.out.println(persionEntity.getPersonId());
//		System.out.println(persionEntity.getName());
//		
//		// 查询名字
		String personName = mPersonService.queryPersonName(16);
		System.out.println(personName);
		
		
		//查询多个实体
//		ArrayList&lt;PersonEntity&gt; lists = (ArrayList&lt;PersonEntity&gt;) mPersonService.getAllPerson();
//		for (PersonEntity personEntity : lists) {
//			System.out.println(personEntity.getPersonId());
//			System.out.println(personEntity.getName());
//		}
	}
	
}
&lt;/span&gt;</code></pre> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a3fe153dc46f84278e27d803cd98c607/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring笔记（四）: spring的编程式事务与声明式事务</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a7f834b6afb7cbb5608ec0435de773b1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">WKWebView 渲染出现白屏的可能因素</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>