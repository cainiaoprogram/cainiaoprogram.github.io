<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C# 文件同步写入 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C# 文件同步写入" />
<meta property="og:description" content="项目场景： 需要对某一文件进行同步写入
问题描述 一般的方法：
File.AppendAllText(filePath, $&#34;{curTimeStr}: {recordText}&#34; &#43; Environment.NewLine); 原因分析： 该方法会引起报错：
Information: WriteToFile() catch exception =&gt; System.IO.IOException: The process cannot access the file &#39;C:\Users\e2e\AppData\Local\Temp\ProxyServerTest_20231222-093555&#39; because it is being used by another process. at System.IO.__Error.WinIOError(Int32 errorCode, String maybeFullPath) 异常信息：WriteToFile() 捕获到异常 =&gt; System.IO.IOException: 无法访问文件 ‘C:\Users\e2e\AppData\Local\Temp\ProxyServerTest_20231222-093555’，因为它正被另一个进程使用。
在 System.IO.__Error.WinIOError(Int32 errorCode, String maybeFullPath)
这个异常是因为WriteToFile()函数尝试访问的文件’C:\Users\e2e\AppData\Local\Temp\ProxyServerTest_20231222-093555’正在被另一个程序或进程使用。
这种情况通常发生在某个程序或进程打开了文件进行读取或写入时，另一个程序或进程尝试同时访问同一文件。要解决这个问题，你可以尝试以下步骤：
1.关闭可能正在使用该文件的所有程序或进程。 2.检查是否是由防病毒软件或安全软件锁定的文件。如果是，暂时禁用该软件并尝试再次访问文件。 3.使用File.Open()方法配合适当的文件访问模式（读、写、读写）和文件共享模式（无、读、写、读写），以确保正确地访问文件。 4.将WriteToFile()函数包裹在try-catch块中，并处理IOException异常，可以通过在短暂延迟后重试操作或向用户显示错误消息来处理。 解决方案： 在C#中，同时对一个文件进行写入可能会导致数据冲突或损坏，因为多个线程或进程同时修改同一文件可能会产生不可预知的结果。为了安全地在同一文件上进行并发写入，你需要使用适当的同步机制。
private static object fileLock = new object(); public static void SafeWriteToFile(string filePath, string content) { lock (fileLock) { using (FileStream fs = new FileStream(filePath, FileMode." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/05280814570280724761bb6fa38e830a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-22T10:41:09+08:00" />
<meta property="article:modified_time" content="2023-12-22T10:41:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C# 文件同步写入</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>项目场景：</h2> 
<p>需要对某一文件进行同步写入</p> 
<hr> 
<h2><a id="_7"></a>问题描述</h2> 
<p>一般的方法：</p> 
<pre><code class="prism language-csharp">File<span class="token punctuation">.</span><span class="token function">AppendAllText</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">curTimeStr</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">recordText</span><span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token operator">+</span> Environment<span class="token punctuation">.</span>NewLine<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_16"></a>原因分析：</h2> 
<p>该方法会引起报错：</p> 
<pre><code class="prism language-bash">Information: WriteToFile<span class="token punctuation">(</span><span class="token punctuation">)</span> catch exception <span class="token operator">=</span><span class="token operator">&gt;</span> System.IO.IOException: The process cannot access the <span class="token function">file</span> <span class="token string">'C:\Users\e2e\AppData\Local\Temp\ProxyServerTest_20231222-093555'</span> because it is being used by another process.
at System.IO.__Error.WinIOError<span class="token punctuation">(</span>Int32 errorCode, String maybeFullPath<span class="token punctuation">)</span>
</code></pre> 
<p>异常信息：WriteToFile() 捕获到异常 =&gt; System.IO.IOException: 无法访问文件 ‘C:\Users\e2e\AppData\Local\Temp\ProxyServerTest_20231222-093555’，因为它正被另一个进程使用。<br> 在 System.IO.__Error.WinIOError(Int32 errorCode, String maybeFullPath)</p> 
<p>这个异常是因为WriteToFile()函数尝试访问的文件’C:\Users\e2e\AppData\Local\Temp\ProxyServerTest_20231222-093555’正在被另一个程序或进程使用。</p> 
<p>这种情况通常发生在某个程序或进程打开了文件进行读取或写入时，另一个程序或进程尝试同时访问同一文件。要解决这个问题，你可以尝试以下步骤：</p> 
<h5><a id="1_32"></a>1.关闭可能正在使用该文件的所有程序或进程。</h5> 
<h5><a id="2_33"></a>2.检查是否是由防病毒软件或安全软件锁定的文件。如果是，暂时禁用该软件并尝试再次访问文件。</h5> 
<h5><a id="3FileOpen_34"></a>3.使用File.Open()方法配合适当的文件访问模式（读、写、读写）和文件共享模式（无、读、写、读写），以确保正确地访问文件。</h5> 
<h5><a id="4WriteToFiletrycatchIOException_35"></a>4.将WriteToFile()函数包裹在try-catch块中，并处理IOException异常，可以通过在短暂延迟后重试操作或向用户显示错误消息来处理。</h5> 
<hr> 
<h2><a id="_39"></a>解决方案：</h2> 
<p>在C#中，同时对一个文件进行写入可能会导致数据冲突或损坏，因为多个线程或进程同时修改同一文件可能会产生不可预知的结果。为了安全地在同一文件上进行并发写入，你需要使用适当的同步机制。</p> 
<pre><code class="prism language-csharp"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token keyword">object</span></span> fileLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">object</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SafeWriteToFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> content<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">lock</span> <span class="token punctuation">(</span>fileLock<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">FileStream</span> fs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>Append<span class="token punctuation">,</span> FileAccess<span class="token punctuation">.</span>Write<span class="token punctuation">,</span> FileShare<span class="token punctuation">.</span>Read<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">StreamWriter</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamWriter</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            writer<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们定义了一个静态对象fileLock作为锁对象。</p> 
<h5><a id="1SafeWriteToFile_60"></a>1.SafeWriteToFile方法接受要写入的文件路径和内容作为参数。</h5> 
<h5><a id="2lock_61"></a>2.使用lock语句确保在同一时间只有一个线程可以执行写入操作。</h5> 
<h5><a id="3FileModeAppend_62"></a>3.使用FileMode.Append模式打开文件，这样每次写入都会添加到文件的末尾，而不是覆盖整个文件。</h5> 
<h5><a id="4StreamWriter_63"></a>4.使用StreamWriter来方便地写入文本内容。</h5> 
<p>请注意，这个示例只保证了在同一应用程序中的线程安全。如果多个进程需要同时写入同一文件，你可能需要使用更复杂的同步机制，如文件锁定、互斥量（Mutex）或者信号量（Semaphore）等。</p> 
<p>另外，如果你的应用场景允许，考虑使用日志框架（如NLog、log4net等）或者数据库来处理多源写入，这些工具通常已经内置了处理并发写入的机制。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/83243a519b57bd7db2e770792c2f0123/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">内网穿透之FRP</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e1614f5e00e0bfde5e1cb0ec200a1145/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Kafka-Eagle】EFAK告警配置与实践</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>