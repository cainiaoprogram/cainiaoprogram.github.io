<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>爬虫基础篇之Scrapy抓取京东 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="爬虫基础篇之Scrapy抓取京东" />
<meta property="og:description" content="虚拟环境 同一台服务器上不同的项目可能依赖的包不同版本，新版本默认覆盖旧版本，可能导致其他项目无法运行，通过虚拟环境，完全隔离各个项目各个版本的依赖包，实现运行环境互不影响。
virtualenv pip install virtualenv	安装virtualenv python -m pip install --upgrade pip 升级pip pip install -i https://pypi.doubanio.com/simple/ --trusted-host pypi.doubanio.com scrapy pip install -i https://pypi.tuna.tsinghua.edu.cn/simple 使用清华源 pip uninstall scrapy 卸载django virtualenv scrapytest 默认环境创建虚拟环境 cd scrapytest/Scripts &amp;&amp; activate.bat &amp;&amp; python 进入3.7虚拟环境 virtualenv -p D:\Python27\python.exe scrapytest cd scrapytest/Scripts &amp;&amp; activate.bat &amp;&amp; python 进入2.7虚拟环境 deactivate.bat 退出虚拟环境 apt-get install python-virtualenv 安装虚拟环境 virtualenv py2 &amp;&amp; cd py2 &amp;&amp; cd bin &amp;&amp; source activate &amp;&amp; python 进入2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f4e1e4677dc8405beff50a4199afae25/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-22T17:51:25+08:00" />
<meta property="article:modified_time" content="2021-04-22T17:51:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">爬虫基础篇之Scrapy抓取京东</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>虚拟环境</h2> 
<p>同一台服务器上不同的项目可能依赖的包不同版本，新版本默认覆盖旧版本，可能导致其他项目无法运行，通过虚拟环境，完全隔离各个项目各个版本的依赖包，实现运行环境互不影响。</p> 
<h3><a id="virtualenv_4"></a>virtualenv</h3> 
<pre><code>pip install virtualenv		安装virtualenv
python -m pip install --upgrade pip  升级pip
pip install -i https://pypi.doubanio.com/simple/ --trusted-host pypi.doubanio.com scrapy
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple  使用清华源
pip uninstall scrapy    卸载django 
virtualenv scrapytest   默认环境创建虚拟环境
cd scrapytest/Scripts &amp;&amp;  activate.bat &amp;&amp; python 进入3.7虚拟环境
virtualenv -p D:\Python27\python.exe scrapytest
cd scrapytest/Scripts &amp;&amp;  activate.bat &amp;&amp; python 进入2.7虚拟环境
deactivate.bat          退出虚拟环境

apt-get install python-virtualenv       安装虚拟环境
virtualenv py2 &amp;&amp; cd py2 &amp;&amp; cd bin &amp;&amp; source activate &amp;&amp; python 进入2.7虚拟环境
virtualenv -p /usr/bin/python3 py3 &amp;&amp; &amp;&amp; cd py3 &amp;&amp; cd bin &amp;&amp; source activate &amp;&amp; python  进入3.7虚拟环境
</code></pre> 
<h3><a id="virtualenvwrapper_23"></a>virtualenvwrapper</h3> 
<pre><code>pip install virtualenvwrapper
pip install virtualenvwrapper-win	解决workon不是内部指令
workon  列出所有虚拟环境
新建环境变量   WORKON_HOME=E:\envs
mkvirtualenv py3scrapy  新建并进入虚拟环境
deactivate          退出虚拟环境
workon py3scrapy        进入指定虚拟环境
    pip install -i https://pypi.douban.com/simple scrapy    安装scrapy源
    若缺少lxml出错https://www.lfd.uci.edu/~gohlke/pythonlibs/寻找对应版本的lxml的whl源
    python -m pip install --upgrade pip     更新pip
    pip install lxml-4.1.1-cp35-cp35m-win_amd64.whl
    若缺少Twisted出错http://www.lfd.uci.edu/~gohlke/pythonlibs/#lxml搜对应版本Twisted
    pip install Twisted‑17.9.0‑cp35‑cp35m‑win_amd64.whl
mkvirtualenv --python=D:\Python27\python.exe py2scrapy      一般不会出问题
    pip install -i https://pypi.douban.com/simple scrapy
    
    
pip install virtualenvwrapper    
    find / -name virualenvwrapper.sh
    vim ~/.bashrc
        export WORKON_HOME=$HOME/.virtualenvs
        source /home/wj/.local/bin/virtualenvwrapper.sh
    source ~/.bashrc    
mkvirtualenv py2scrapy          指向生成~/.virtualenv
deactivate          退出虚拟环境
mkdirtualenv --python=/usr/bin/python3 py3scrapy
rmvirtualenv py3scrapy  删除虚拟环境
</code></pre> 
<h2><a id="Scrapy_55"></a>Scrapy</h2> 
<p><img src="https://images2.imgbox.com/12/54/HQWKQRKc_o.png" alt="在这里插入图片描述"></p> 
<pre><code>pip install -i https://pypi.douban.com/simple/ scrapy  安装scrapy
scrapy startproject mall_spider  创建mall_spider项目
scrapy genspider jd_category https://dc.3.cn/category/get  创建分类爬虫
scrapy genspider --list  查看爬虫生成模板
scrapy genspider -t crawl lagou www.lagou.com   创建全站爬虫
pip freeze &gt; requirements.txt 生成依赖到文件
pip install -r requirements.txt 一键安装依赖
scrapy shell http://blog.jobbole.com/       可以在脚本中调试xpath或者chrome浏览器右键copy xpath,chrome浏览器右键copy selector
scrapy shell -s USER_AGENT="Mozilla/5.0 (Windows NT 6.1; WOW64; rv:51.0) Gecko/20100101 Firefox/51.0" https://www.zhihu.com/question/56320032
view(response)
</code></pre> 
<h3><a id="_73"></a>需求</h3> 
<h4><a id="11__75"></a>1.1 抓取首页的分类信息</h4> 
<ul><li>抓取数据: 各级分类的名称 和 URL</li></ul> 
<p><img src="https://images2.imgbox.com/b7/80/IR0wezgt_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="12__81"></a>1.2 抓取商品信息</h4> 
<ul><li> <p>抓取: 商品名称, 商品价格, 商品评论数量, 商品店铺, 商品促销, 商品选项, 商品图片的URL<br> <img src="https://images2.imgbox.com/15/03/5ahcorHm_o.png" alt="在这里插入图片描述"></p> </li><li> <p>由于全网爬虫, 抓取页面非常多, 为了提高抓的速度, 选择使用scrapy框架 + scrapy_redis分布式组件</p> </li><li> <p>由于京东全网的数据量达到了亿级, 存储又是结构化数据, 数据库, 选择使用MongoDB;</p> </li></ul> 
<h3><a id="_90"></a>实现</h3> 
<p>我们采用广度优先策略, 我们把类别和商品信息的抓取分开来做.</p> 
<p><img src="https://images2.imgbox.com/dd/f5/iuKci4Ox_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_97"></a>模型</h4> 
<h5><a id="_99"></a>类别模型</h5> 
<pre><code>class Category(scrapy.Item):
    """商品类别"""
    # 大分类名称
    b_category_name = scrapy.Field()
    # 大分类URL
    b_category_url = scrapy.Field()
    # 中分类名称
    m_category_name = scrapy.Field()
    # 中分类URL
    m_category_url = scrapy.Field()
    # 小分类名称
    s_category_name = scrapy.Field()
    # 小分类URL
    s_category_url = scrapy.Field()
</code></pre> 
<h5><a id="_118"></a>数据模型</h5> 
<pre><code>class Product(scrapy.Item):
    # 商品类别
    product_category = scrapy.Field()
    # 商品ID
    product_sku_id = scrapy.Field()
    # 商品名称
    product_name = scrapy.Field()
    # 商品图片URL
    product_img_url = scrapy.Field()
    # 商品店铺
    product_shop = scrapy.Field()
    # 图书信息, 作者,出版社
    product_book_info = scrapy.Field()
    # 商品选项
    product_option = scrapy.Field()
    # 商品评论数量
    product_comments = scrapy.Field()
    # 商品促销
    product_ad = scrapy.Field()
    # 商品价格
    product_price = scrapy.Field()
</code></pre> 
<h4><a id="_144"></a>分类爬虫</h4> 
<h5><a id="_URL_146"></a>分析, 分类信息的URL</h5> 
<ul><li> <p><code>目标</code>: <code>确定分类信息的URL</code></p> </li><li> <p><code>步骤</code>:</p> 
  <ol><li>进入到京东首页</li><li>右键检查, 打开开发者工具, 搜索 <code>家用电器</code></li><li>确定分类的URL</li></ol> </li><li> <p><code>图解</code>:<br> <img src="https://images2.imgbox.com/4e/35/OpoPKgx2_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>结论</code>:</p> 
  <ul><li>分类URL: <code>https://dc.3.cn/category/get</code></li></ul> </li></ul> 
<h5><a id="__159"></a>创建爬虫, 抓取数据</h5> 
<ul><li><code>目标</code>: <code>抓取分类数据, 交给引擎</code></li><li><code>步骤</code>: 
  <ol><li>创建类别爬虫</li><li>指定起始URL</li><li>解析数据, 交给引擎</li></ol> </li></ul> 
<h5><a id="_167"></a>创建爬虫</h5> 
<ul><li>进入项目目录: <code>cd mall_spider</code></li><li>创建爬虫: <code>scrapy genspider category_spider jd.com</code></li></ul> 
<h5><a id="URL_172"></a>指定起始URL</h5> 
<ul><li>修改起始URL: <code>https://dc.3.cn/category/get</code></li></ul> 
<h5><a id="__176"></a>解析数据, 交给引擎</h5> 
<ul><li>分析数据格式: 
  <ul><li> <p>整体数据<br> <img src="https://images2.imgbox.com/2d/11/knzuoEmO_o.png" alt="在这里插入图片描述"></p> </li><li> <p>各级分类位置<br> <img src="https://images2.imgbox.com/7c/e4/PUZpJb7C_o.png" alt="在这里插入图片描述"></p> </li><li> <p>分类信息格式</p> 
    <ul><li>格式1: 
      <ul><li><code>jiadian.jd.com|家用电器||0</code></li><li>特点: 第一项分类URL,第二项分类名称</li></ul> </li><li>格式2: 
      <ul><li><code>652-654|摄影摄像||0</code></li><li>对应的URL: <code>https://channel.jd.com/652-654.html</code></li><li>特点:第一项是频道ID, 包含一个 <code>-</code></li></ul> </li><li>格式3: 
      <ul><li><code>1318-2628-12131|户外风衣||0</code></li><li>对应URL: <code>https://list.jd.com/list.html?cat=1318,2628,12131</code></li><li>特点: 第一项为分类ID, 包含两个 <code>-</code></li></ul> </li></ul> </li></ul> </li></ul> 
<pre><code>class JdCategorySpider(scrapy.Spider):
    name = 'jd_category'
    allowed_domains = ['3.cn']
    start_urls = ['https://dc.3.cn/category/get']

    def parse(self, response):
        # print(response.body.decode('GBK'))
        result = json.loads(response.body.decode('GBK'))
        datas = result['data']
        # 遍历数据列表
        for data in datas:

            item = Category()

            b_category = data['s'][0]
            b_category_info = b_category['n']
            # print('大分类: {}'.format(b_category_info))
            item['b_category_name'], item['b_category_url'] = self.get_category_name_url(b_category_info)

            # 中分类信息列表
            m_category_s = b_category['s']
            # 遍历中分类列表
            for m_category in m_category_s:
                # 中分类信息
                m_category_info = m_category['n']
                # print('中分类: {}'.format(m_category_info))
                item['m_category_name'], item['m_category_url'] = self.get_category_name_url(m_category_info)

                # 小分类数据列表
                s_category_s = m_category['s']
                for s_category in s_category_s:
                    s_category_info = s_category['n']
                    # print('小分类: {}'.format(s_category_info))
                    item['s_category_name'], item['s_category_url'] = self.get_category_name_url(s_category_info)
                    # print(item)
                    # 把数据交给引擎
                    yield item

    def get_category_name_url(self, category_info):
        """
        根据分类信息, 提取名称和URL
        :param category_info:  分类信息
        :return: 分类的名称和URL
        分析数据格式(三类数据格式)
        - book.jd.com/library/science.html|科学技术||0
        - 1713-3287|计算机与互联网||0
          - Https://channel.jd.com/{}.html
        - 9987-12854-12856|屏幕换新||0
          - Https://list.jd.com/list.html?cat={}
          - 把 - 替换为逗号, 然后填充到占位的地方.
        """
        category = category_info.split('|')
        # 分类URL
        category_url = category[0]
        # 分类名称
        category_name = category[1]

        # 处理第一类分类URL
        if category_url.count('jd.com') == 1:
            # URL进行补全
            category_url = 'https://' + category_url
        elif category_url.count('-') == 1:
            # 1713-3287|计算机与互联网||0
            category_url = 'https://channel.jd.com/{}.html'.format(category_url)
        else:
            # 9987-12854-12856|屏幕换新||0
            # 把URL中 `-` 替换为 `,`
            category_url = category_url.replace('-', ',')
            # 补全URL
            category_url = 'https://list.jd.com/list.html?cat={}'.format(category_url)

        # 返回类别的名称 和 URL
        return category_name, category_url
</code></pre> 
<h4><a id="_274"></a>保存分类数据</h4> 
<pre><code># 在settings.py开启, 类别的Pipeline
ROBOTSTXT_OBEY = False  不遵守网络协议
ITEM_PIPELINES = {
   'mall_spider.pipelines.CategoryPipeline': 300,
}
</code></pre> 
<p><code>步骤</code>:</p> 
<ol><li><code>open_spider</code>方法中, 链接MongoDB数据库, 获取要操作的集合</li><li><code>process_item</code> 方法中, 向MongoDB中插入类别数据</li><li><code>close_spider</code> 方法中, 关闭MongoDB的链接</li></ol> 
<pre><code>"""
实现保存分类的Pipeline类
- open_spider方法中, 链接MongoDB数据库, 获取要操作的集合
- process_item 方法中, 向MongoDB中插入类别数据
- close_spider 方法中, 关闭MongoDB的链接
"""

class CategoryPipeline(object):

    def open_spider(self, spider):
        """当爬虫启动的时候执行1次"""
        if isinstance(spider, JdCategorySpider):
            # open_spider方法中, 链接MongoDB数据库, 获取要操作的集合
            self.client = MongoClient(MONGODB_URL)
            self.collection = self.client['jd']['category']

    def process_item(self, item, spider):
        # process_item 方法中, 向MongoDB中插入类别数据
        if isinstance(spider, JdCategorySpider):
            self.collection.insert_one(dict(item))

        return item

    def close_spider(self, spider):
        # close_spider 方法中, 关闭MongoDB的链接
        if isinstance(spider, JdCategorySpider):
            self.client.close()
</code></pre> 
<h4><a id="_320"></a>商品爬虫</h4> 
<p><code>总体设计</code>:</p> 
<ol><li>把MongoDB中存储的分类信息, 放到redis_key指定列表中</li><li>支持分布式爬虫, 当然也可以在一台电脑上运行多次, 以启动多个进程,充分使用CPU的多核.</li><li>所以这里的爬虫, 先从一个分类开始抓就可以了, 后面再改造为分布式</li></ol> 
<h5><a id="_328"></a>分析</h5> 
<ul><li> <p>列表页</p> 
  <ul><li> <p>提取商品 skuid<br> <img src="https://images2.imgbox.com/2a/dd/ZZnhWmYS_o.png" alt="在这里插入图片描述"></p> </li><li> <p>实现翻页</p> 
    <ul><li> <p>获取下一页URL<br> <img src="https://images2.imgbox.com/e1/20/W0vAFqJw_o.png" alt="在这里插入图片描述"></p> </li><li> <p>没有下一页的情况<br> <img src="https://images2.imgbox.com/7b/b7/BFgsCoWo_o.png" alt="在这里插入图片描述"></p> </li></ul> </li></ul> </li><li> <p>详情页<br> 由于PC和手机页面商品信息, 在js中, 且比较分散, 并且每次请求数量页比较大, 我们这里使用手机抓包, 抓到json数据.</p> </li><li> <p>商品基本信息</p> 
  <ul><li> <p>图:<br> <img src="https://images2.imgbox.com/f6/e9/tM27azlr_o.png" alt="在这里插入图片描述"></p> </li><li> <p>URL: <code>https://cdnware.m.jd.com/c1/skuDetail/apple/7.3.0/32426231880.json</code>; 最后一部分是商品skuid</p> </li><li> <p>可以获取到的信息: 商品名称, 商品店铺信息 , 商品类别id, 商品品牌id, 商品选项</p> </li></ul> <pre><code class="prism language-json">  <span class="token punctuation">{<!-- --></span>
<span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
<span class="token string">"wareInfo"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
	<span class="token string">"recommendInfo"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string">"recommendList"</span><span class="token punctuation">:</span> <span class="token keyword">null</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 商品店铺信息</span>
	<span class="token string">"shopInfo"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string">"shop"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
			<span class="token string">"shopId"</span><span class="token punctuation">:</span> <span class="token number">1000000127</span><span class="token punctuation">,</span>
			<span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"京东Apple产品专营店"</span><span class="token punctuation">,</span>
		    <span class="token operator">...</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>	
	<span class="token string">"basicInfo"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string">"gift"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
		<span class="token string">"bookInfo"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// 如果是书, 这里是书的选项信息</span>
			<span class="token string">"display"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	
		<span class="token string">"colorSizeInfo"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// 商品选项信息列表 有的没有</span>
			<span class="token string">"colorSize"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
				<span class="token string">"buttons"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
					<span class="token string">"no"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
					<span class="token string">"skuList"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"100000177738"</span><span class="token punctuation">,</span> <span class="token string">"100000287117"</span><span class="token punctuation">,</span> <span class="token string">"100000287145"</span><span class="token punctuation">,</span> <span class="token string">"100000309448"</span><span class="token punctuation">,</span> <span class="token string">"100000309450"</span><span class="token punctuation">,</span> <span class="token string">"100000375233"</span><span class="token punctuation">,</span> <span class="token string">"100000435832"</span><span class="token punctuation">,</span> <span class="token string">"100000458753"</span><span class="token punctuation">,</span> <span class="token string">"100000458755"</span><span class="token punctuation">,</span> <span class="token string">"100001860767"</span><span class="token punctuation">,</span> <span class="token string">"100001860773"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
					<span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"金色"</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
					<span class="token string">"no"</span><span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
					<span class="token string">"skuList"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"100000177764"</span><span class="token punctuation">,</span> <span class="token string">"100000287113"</span><span class="token punctuation">,</span> <span class="token string">"100000287135"</span><span class="token punctuation">,</span> <span class="token string">"100000435780"</span><span class="token punctuation">,</span> <span class="token string">"100000435816"</span><span class="token punctuation">,</span> <span class="token string">"100000435818"</span><span class="token punctuation">,</span> <span class="token string">"100000569049"</span><span class="token punctuation">,</span> <span class="token string">"100000602206"</span><span class="token punctuation">,</span> <span class="token string">"100000602208"</span><span class="token punctuation">,</span> <span class="token string">"100001860765"</span><span class="token punctuation">,</span> <span class="token string">"100002539302"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
					<span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"深空灰色"</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
					<span class="token string">"no"</span><span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>
					<span class="token string">"skuList"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"100000177740"</span><span class="token punctuation">,</span> <span class="token string">"100000177784"</span><span class="token punctuation">,</span> <span class="token string">"100000287147"</span><span class="token punctuation">,</span> <span class="token string">"100000435834"</span><span class="token punctuation">,</span> <span class="token string">"100000458737"</span><span class="token punctuation">,</span> <span class="token string">"100000458739"</span><span class="token punctuation">,</span> <span class="token string">"100000602174"</span><span class="token punctuation">,</span> <span class="token string">"100000602176"</span><span class="token punctuation">,</span> <span class="token string">"100000602204"</span><span class="token punctuation">,</span> <span class="token string">"100001860789"</span><span class="token punctuation">,</span> <span class="token string">"100002539304"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
					<span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"银色"</span>
				<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
				<span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"颜色"</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
				<span class="token string">"buttons"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
					<span class="token string">"no"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
					<span class="token string">"skuList"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"100000177738"</span><span class="token punctuation">,</span> <span class="token string">"100000177740"</span><span class="token punctuation">,</span> <span class="token string">"100000177764"</span><span class="token punctuation">,</span> <span class="token string">"100000177784"</span><span class="token punctuation">,</span> <span class="token string">"100000287113"</span><span class="token punctuation">,</span> <span class="token string">"100000287117"</span><span class="token punctuation">,</span> <span class="token string">"100000287135"</span><span class="token punctuation">,</span> <span class="token string">"100000287145"</span><span class="token punctuation">,</span> <span class="token string">"100000287147"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
					<span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"公开版"</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token operator">...</span>
                  <span class="token punctuation">]</span><span class="token punctuation">,</span>
				<span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"版本"</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
				<span class="token string">"buttons"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
					<span class="token string">"no"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
					<span class="token string">"skuList"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"100000177764"</span><span class="token punctuation">,</span> <span class="token string">"100000287145"</span><span class="token punctuation">,</span> <span class="token string">"100000287147"</span><span class="token punctuation">,</span> <span class="token string">"100000375233"</span><span class="token punctuation">,</span> <span class="token string">"100000435818"</span><span class="token punctuation">,</span> <span class="token string">"100000458739"</span><span class="token punctuation">,</span> <span class="token string">"100000458755"</span><span class="token punctuation">,</span> <span class="token string">"100000602204"</span><span class="token punctuation">,</span> <span class="token string">"100000602208"</span><span class="token punctuation">,</span> <span class="token string">"100001860765"</span><span class="token punctuation">,</span> <span class="token string">"100001860773"</span><span class="token punctuation">,</span> <span class="token string">"100001860789"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
					<span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"64GB"</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span> 
                  <span class="token operator">...</span>
                  <span class="token punctuation">]</span><span class="token punctuation">,</span>
				<span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"内存"</span>
			<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
			<span class="token string">"colorSizeTips"</span><span class="token punctuation">:</span> <span class="token string">"#与其他已选项无法组成可售商品，请重选"</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	    <span class="token operator">...</span>
          <span class="token comment">// 品牌ID</span>
		<span class="token string">"brandID"</span><span class="token punctuation">:</span> <span class="token string">"14026"</span><span class="token punctuation">,</span>
          <span class="token operator">...</span>
          <span class="token comment">// 商品图片</span>
		<span class="token string">"wareImage"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
			<span class="token string">"small"</span><span class="token punctuation">:</span> <span class="token string">"https://m.360buyimg.com/mobilecms/s720x720_jfs/t1/3/15/4536/138660/5b997bf8Ed72ebce7/819dcf182d743897.jpg!q70.jpg.webp"</span><span class="token punctuation">,</span>
              <span class="token operator">...</span>
		  <span class="token punctuation">}</span>
            <span class="token operator">...</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token operator">...</span>
          <span class="token comment">// 商品名称</span>
		<span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Apple iPhone XS Max (A2104) 256GB 深空灰色 移动联通电信4G手机 双卡双待"</span><span class="token punctuation">,</span>
          <span class="token comment">// 商品类别id</span>
		<span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"9987;653;655"</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> </li><li> <p>商品促销信息(PC端):</p> 
  <ul><li> <p>图:<br> <img src="https://images2.imgbox.com/5a/e1/aqRdWWMW_o.png" alt="在这里插入图片描述"></p> </li><li> <p>URL: https://cd.jd.com/promotion/v2?skuId=4749506&amp;area=1_72_4137_0&amp;cat=737%2C794%2C798</p> 
    <ul><li>参数 
      <ul><li>skuId=4749506: 商品sku_id</li><li>area=1_72_4137_0: 购买者区域, 固定的</li><li>cat=737%2C794%2C798: 类别</li></ul> </li></ul> </li><li> <p>数据</p> </li></ul> <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token operator">...</span>
  <span class="token comment">// 商品促销信息</span>
  <span class="token string">"ads"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
      <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"AD_4749506"</span><span class="token punctuation">,</span>
      <span class="token string">"ad"</span><span class="token punctuation">:</span> <span class="token string">"【即刻预约，21号秒杀到手价2999】\n1、前100名晒单送腾讯企鹅影院季卡，联系客服领取！！\n2、曲面爆款，5.5万好评推荐！&lt;a target=\"_blank\" href=\"https://item.jd.com/7055876.html\"&gt;升级55Q1D超清全面屏电视&lt;/a&gt;"</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
  <span class="token punctuation">}</span>
</code></pre> </li><li> <p>商品评论信息(PC端)</p> 
  <ul><li> <p>图:<br> <img src="https://images2.imgbox.com/b9/54/Owm0RmG5_o.png" alt="在这里插入图片描述"></p> </li><li> <p>URL: https://club.jd.com/comment/productCommentSummaries.action?referenceIds=4749506</p> 
    <ul><li>参数 
      <ul><li>referenceIds=4749506: 商品sku_id</li></ul> </li></ul> </li><li> <p>数据:</p> <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string">"CommentsCount"</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">"CommentCountStr"</span><span class="token punctuation">:</span><span class="token string">"10万+"</span><span class="token punctuation">,</span> 
        <span class="token string">"CommentCount"</span><span class="token punctuation">:</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token comment">//评论数量</span>
        <span class="token string">"AverageScore"</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token string">"GoodRate"</span><span class="token punctuation">:</span><span class="token number">0.98</span><span class="token punctuation">,</span> <span class="token comment">//好评率</span>
        <span class="token string">"PoorCountStr"</span><span class="token punctuation">:</span><span class="token string">"600+"</span><span class="token punctuation">,</span> 
        <span class="token string">"PoorCount"</span><span class="token punctuation">:</span><span class="token number">600</span><span class="token punctuation">,</span> <span class="token comment">// 差评数量</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre> </li></ul> </li><li> <p>商品价格信息:</p> 
  <ul><li> <p>图:<br> <img src="https://images2.imgbox.com/40/1f/AJ1K7hIs_o.png" alt="在这里插入图片描述"></p> </li><li> <p>URL: https://p.3.cn/prices/mgets?skuIds=J_4749506</p> 
    <ul><li>参数: 
      <ul><li>skuIds=J_4749506 商品的sku_id</li></ul> </li></ul> </li><li> <p>数据:</p> <pre><code class="prism language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token string">"op"</span><span class="token punctuation">:</span> <span class="token string">"5499.00"</span><span class="token punctuation">,</span>
      <span class="token string">"m"</span><span class="token punctuation">:</span> <span class="token string">"5999.00"</span><span class="token punctuation">,</span>
      <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"J_4749506"</span><span class="token punctuation">,</span> <span class="token comment">//商品skuid</span>
      <span class="token string">"p"</span><span class="token punctuation">:</span> <span class="token string">"3299.00"</span> <span class="token comment">// 商品价格</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
</code></pre> </li></ul> </li></ul> 
<h5><a id="_509"></a>代码实现</h5> 
<ul><li>步骤: 
  <ol><li>重写start_requests方法, 根据分类信息构建列表页的请求</li><li>解析列表页, 提取商品的skuid, 构建商品基本的信息请求; 实现翻页</li><li>解析商品基本信息, 构建商品促销信息的请求</li><li>解析促销信息,构建商品评价信息的请求,</li><li>解析商品评价信息, 构建价格信息的请求</li><li>解析价格信息</li></ol> </li></ul> 
<pre><code>class JdProductSpider(scrapy.Spider):
    name = 'jd_product'
    allowed_domains = ['jd.com', 'p.3.cn']

    def start_requests(self):
        category = {  "b_category_name" : "家用电器",
                      "b_category_url" : "https://jiadian.jd.com",
                      "m_category_name" : "洗衣机",
                      "m_category_url" : "https://list.jd.com/list.html?cat=737,794,880",
                      "s_category_name" : "洗衣机配件",
                      "s_category_url" : "https://list.jd.com/list.html?cat=737,794,877" }

        yield scrapy.Request(category['s_category_url'], self.parse, meta={'category': category})

    def parse(self, response):
        # 获取类别信息
        category = response.meta['category']
        # 获取类别的URL
        category_url = response.url.split('&amp;')[0]
        # 获取所有商品的sku_ids
        sku_ids = response.xpath('//div[contains(@class, "j-sku-item")]/@data-sku').extract()
        # 遍历sku_ids, 构建基本详情信息的请求
        for sku_id in sku_ids:
            item = {
                 'product_category': category,
                 'product_sku_id':sku_id
            }
            product_url = 'https://cdnware.m.jd.com/c1/skuDetail/apple/7.3.0/{}.json'.format(sku_id)
            yield scrapy.Request(product_url, callback=self.parse_product, meta={'item': item})


        # 获取下一页的URL
        next_url = response.xpath('//a[@class="pn-next"]/@href').extract_first()
        if next_url:
            # 补全URL
            next_url = response.urljoin(next_url)
            # 构建下一页请求
            yield scrapy.Request(next_url, callback=self.parse, meta={'category': category})

    def parse_product(self, response):
        # 取出传递过来的数据
        item = response.meta['item']
        # 把响应数据数据转为字典
        product_dic = json.loads(response.text)

        # 获取商品名称
        item['product_name'] = product_dic['wareInfo']['basicInfo']['name']
        if  item['product_name']:
            # 获取类别id, 把 `;` 替换为 ,
            item['product_category_id'] = product_dic['wareInfo']['basicInfo']['category'].replace(';', ',')
            # 获取店铺信息
            product_shop = jsonpath(product_dic, '$..shop')
            if product_shop:
                product_shop = product_shop[0]
                if product_shop is None:
                    item['product_shop'] = {'name':'京东自营'}
                else:
                    item['product_shop'] = {
                        "shopId": product_shop['shopId'],
                        "name": product_shop['name'],
                        "score": product_shop['score'],
                        "url": product_shop['url'],
                    }

            # 如果是书, 记录书的信息
            if product_dic['wareInfo']['basicInfo']['bookInfo']['display']:
                item['product_book_info'] = product_dic['wareInfo']['basicInfo']['bookInfo']
                # 删除display
                del item['book_info']['display']
            # 获取商品选购信息
            color_sizes = jsonpath(product_dic, '$..colorSize')
            product_option = {}
            if color_sizes:
                for color_size in color_sizes[0]:
                    title = color_size['title']
                    texts = jsonpath(color_size, '$..text')
                    product_option.update({title:texts})
                    # print(product_option)
            item['product_option'] = product_option
            # 商品图片
            item['product_img_url'] = jsonpath(product_dic, '$..wareImage[0].small')[0]

            # 构建促销信息的请求
            ad_url = 'https://cd.jd.com/promotion/v2?skuId={}&amp;area=1_72_4137_0&amp;cat={}'.format(item['product_sku_id'], item['product_category_id'])
            yield scrapy.Request(ad_url, callback=self.parse_ad, meta={'item': item})

    def parse_ad(self, response):
        """获取商品促销"""
        item = response.meta['item']
        ad_dic = json.loads(response.body.decode('GB18030'))
        ad =  ad_dic['ads'][0]['ad']
        item['product_ad'] = ad

        # for key, value in item.items():
        #     print('{} = {}'.format(key, value))

        # 构建平均信息请求
        comments_url = 'https://club.jd.com/comment/productCommentSummaries.action?referenceIds={}'.format(item['product_sku_id'])
        yield scrapy.Request(comments_url, callback=self.parse_comments, meta={'item': item})

    def parse_comments(self, response):
        """解析商品评论信息"""
        item = response.meta['item']
        comments_dic = json.loads(response.text)
        comments = {
            'comment_count': jsonpath(comments_dic, '$..CommentCount')[0],
            'good_rate': jsonpath(comments_dic, '$..GoodRate')[0],
            'poor_count': jsonpath(comments_dic, '$..PoorCount')[0],
        }
        item['product_comments'] = comments
        # print(item)
        # 构建价格请求
        price_url = 'https://p.3.cn/prices/mgets?skuIds=J_{}'.format(item['product_sku_id'])
        yield scrapy.Request(price_url, callback=self.parse_price, meta={'item': item})

    def parse_price(self, response):
        """解析价格"""
        item = response.meta['item']
        item['product_price'] = json.loads(response.text)[0]['p']
        # print(item)
        yield item
</code></pre> 
<h5><a id="_643"></a>分布式</h5> 
<ul><li><code>步骤</code>: 
  <ol><li>修改爬虫类</li><li>在settings文件中配置scrapy_redis</li><li>写一个程序用于把MongoDB中分类信息, 放入到爬虫redis_key指定的列表中</li></ol> </li></ul> 
<p><strong>修改爬虫类</strong></p> 
<ul><li><code>步骤</code>: 
  <ol><li>修改继承关系: 继承RedisSpider</li><li>指定redis_key</li><li>把重写start_requests 改为 重写 make_request_from_data</li></ol> </li></ul> 
<pre><code>from scrapy_redis.spiders import RedisSpider
import pickle

#  1. 修改继承关系: 继承RedisSpider
class JdProductSpider(RedisSpider):
    name = 'jd_product'
    allowed_domains = ['jd.com', 'p.3.cn']
    # 2. 指定redis_key
    redis_key = 'jd_product:start_category'

    # 3. 把重写start_requests 改为 重写 make_request_from_data
    def make_request_from_data(self, data):
        # 把从Redis中读取到分类信息, 转换为字典
        category = pickle.loads(data)
        return scrapy.Request(category['s_category_url'], self.parse, meta={'category': category})
</code></pre> 
<p><code>注意</code>: 在<code>make_request_from_data</code>不能使用 <code>yield</code> 必须使用 <code>return</code></p> 
<p><strong>在settings文件中配置scrapy_redis</strong></p> 
<pre><code># MongoDB数据库的URL
MONGO_URL = 'mongodb://127.0.0.1:27017'

# REDIS数据链接
REDIS_URL = ' redis://127.0.0.1:6379/0'

# 去重容器类: 用于把已爬指纹存储到基于Redis的set集合中
DUPEFILTER_CLASS = "scrapy_redis.dupefilter.RFPDupeFilter"
# 调度器: 用于把待爬请求存储到基于Redis的队列
SCHEDULER = "scrapy_redis.scheduler.Scheduler"
# 是不进行调度持久化:
# 如果是True, 当程序结束的时候, 会保留Redis中已爬指纹和待爬的请求
# 如果是False, 当程序结束的时候, 会清空Redis中已爬指纹和待爬的请求
SCHEDULER_PERSIST = True
</code></pre> 
<p><strong>把MongoDB中分类信息, 放入到爬虫redis_key指定的列表中</strong></p> 
<ul><li> <p><code>步骤</code>:</p> 
  <ul><li> 
    <ol><li>在项目文件夹下创建 <code>add_category_to_redis.py</code></li></ol> </li><li> 
    <ol start="2"><li>实现方法 <code>add_category_to_redis</code>: 
      <ol><li>链接MongoDB</li><li>链接Redis</li><li>读取MongoDB中分类信息, 序列化后, 添加到商品爬虫redis_key指定的list</li><li>关闭MongoDB</li></ol> </li></ol> </li><li> 
    <ol start="3"><li>在<code>if __name__ == '__main__':</code>中调用<code>add_category_to_redis</code>方法</li></ol> </li></ul> </li><li> <p><code>代码</code></p> </li></ul> 
<pre><code class="prism language-py"><span class="token keyword">from</span> redis <span class="token keyword">import</span> StrictRedis
<span class="token keyword">from</span> pymongo <span class="token keyword">import</span> MongoClient
<span class="token keyword">import</span> pickle

<span class="token keyword">from</span> mall_spider<span class="token punctuation">.</span>settings <span class="token keyword">import</span> MONGO_URL<span class="token punctuation">,</span> REDIS_URL
<span class="token keyword">from</span> mall_spider<span class="token punctuation">.</span>spiders<span class="token punctuation">.</span>jd_product <span class="token keyword">import</span> JdProductSpider

<span class="token comment"># 把MongoDB中分类信息, 添加到Redis中</span>
<span class="token keyword">def</span> <span class="token function">add_category_to_redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 链接MongoDB</span>
    client <span class="token operator">=</span> MongoClient<span class="token punctuation">(</span>MONGO_URL<span class="token punctuation">)</span>
    <span class="token comment"># 链接Redis</span>
    redis <span class="token operator">=</span> StrictRedis<span class="token punctuation">.</span>from_url<span class="token punctuation">(</span>REDIS_URL<span class="token punctuation">)</span>

    cursor <span class="token operator">=</span> client<span class="token punctuation">[</span><span class="token string">'jd'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 读取MongoDB中分类信息, 序列化后, 添加到商品爬虫redis_key指定的list</span>
    <span class="token keyword">for</span> category <span class="token keyword">in</span> cursor<span class="token punctuation">:</span>
        redis<span class="token punctuation">.</span>rpush<span class="token punctuation">(</span>JdProductSpider<span class="token punctuation">.</span>redis_key<span class="token punctuation">,</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>category<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
    <span class="token comment"># 关闭MongoDB的链接</span>
    client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    add_category_to_redis<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_736"></a>保存商品数据</h4> 
<p><code>步骤</code></p> 
<ul><li> <p>在 open_spider方法, 建立MongoDB数据库连接, 获取要操作的集合</p> </li><li> <p>在 process_item方法, 把数据插入到MongoDB中</p> </li><li> <p>在close_spider方法, 关闭数据库连接</p> </li><li> <p>代码</p> </li></ul> 
<pre><code class="prism language-py"><span class="token keyword">class</span> <span class="token class-name">ProductPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">open_spider</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>spider<span class="token punctuation">,</span> JdProductSpider<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 建立MongoDB数据库链接</span>
            self<span class="token punctuation">.</span>client <span class="token operator">=</span> MongoClient<span class="token punctuation">(</span>MONGO_URL<span class="token punctuation">)</span>
            <span class="token comment"># 获取要操作集合</span>
            self<span class="token punctuation">.</span>category <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">[</span><span class="token string">'jd'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'product'</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>spider<span class="token punctuation">,</span> JdProductSpider<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 把数据插入到mongo中</span>
            self<span class="token punctuation">.</span>category<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> item

    <span class="token keyword">def</span> <span class="token function">close_spider</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""关闭"""</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>spider<span class="token punctuation">,</span> JdProductSpider<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>在settings.py中开启这个管道</strong></p> 
<pre><code class="prism language-py">ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
   <span class="token string">'mall_spider.pipelines.CategoryPipeline'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
    <span class="token comment"># 开启商品管道</span>
   <span class="token string">'mall_spider.pipelines.ProductPipeline'</span><span class="token punctuation">:</span> <span class="token number">301</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_779"></a>反爬</h4> 
<p>为了避免IP反爬, 我们实现随机User-Agent和代理IP的中间件</p> 
<ul><li><code>步骤</code>: 
  <ol><li>实现随机User-Agent的中间件</li><li>实现代理IP中间件</li><li>在settings.py 文件开启, 下载器中间件</li></ol> </li></ul> 
<h5><a id="UserAgent_788"></a>实现随机User-Agent的中间件</h5> 
<ul><li> <p><code>步骤</code></p> 
  <ul><li>准备User-Agent列表</li><li>在middlewares.py中, 实现RandomUserAgent类</li><li>实现process_request方法 
    <ul><li>如果是请求是 <code>https://cdnware.m.jd.com</code> 开头的, 就是设置一个iPhone的user-agent</li><li>否则从User-Agent列表中随机取出一个</li></ul> </li></ul> </li><li> <p>代码</p> </li></ul> 
<pre><code class="prism language-py"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> random

<span class="token comment"># 准备请求头</span>
USER_AGENTS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; AcooBrowser; .NET CLR 1.1.4322; .NET CLR 2.0.50727)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0; Acoo Browser; SLCC1; .NET CLR 2.0.50727; Media Center PC 5.0; .NET CLR 3.0.04506)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/4.0 (compatible; MSIE 7.0; AOL 9.5; AOLBuild 4337.35; Windows NT 5.1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (Windows; U; MSIE 9.0; Windows NT 9.0; en-US)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET CLR 2.0.50727; Media Center PC 6.0)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (compatible; MSIE 8.0; Windows NT 6.0; Trident/4.0; WOW64; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET CLR 1.0.3705; .NET CLR 1.1.4322)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/4.0 (compatible; MSIE 7.0b; Windows NT 5.2; .NET CLR 1.1.4322; .NET CLR 2.0.50727; InfoPath.2; .NET CLR 3.0.04506.30)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN) AppleWebKit/523.15 (KHTML, like Gecko, Safari/419.3) Arora/0.3 (Change: 287 c9dfb30)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (X11; U; Linux; en-US) AppleWebKit/527+ (KHTML, like Gecko, Safari/419.3) Arora/0.6"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.2pre) Gecko/20070215 K-Ninja/2.1.1"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9) Gecko/20080705 Firefox/3.0 Kapiko/3.0"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (X11; Linux i686; U;) Gecko/20070322 Kazehakase/0.4.5"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.8) Gecko Fedora/1.9.0.8-1.fc10 Kazehakase/0.5.6"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.11 (KHTML, like Gecko) Chrome/17.0.963.56 Safari/535.11"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_3) AppleWebKit/535.20 (KHTML, like Gecko) Chrome/19.0.1036.7 Safari/535.20"</span><span class="token punctuation">,</span>
    <span class="token string">"Opera/9.80 (Macintosh; Intel Mac OS X 10.6.8; U; fr) Presto/2.9.168 Version/11.52"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.11 TaoBrowser/2.0 Safari/536.11"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.71 Safari/537.1 LBBROWSER"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; LBBROWSER)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; QQDownload 732; .NET4.0C; .NET4.0E; LBBROWSER)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.11 (KHTML, like Gecko) Chrome/17.0.963.84 Safari/535.11 LBBROWSER"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; QQBrowser/7.0.3698.400)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; QQDownload 732; .NET4.0C; .NET4.0E)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; Trident/4.0; SV1; QQDownload 732; .NET4.0C; .NET4.0E; 360SE)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; QQDownload 732; .NET4.0C; .NET4.0E)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E)"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.89 Safari/537.1"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.89 Safari/537.1"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (iPad; U; CPU OS 4_2_1 like Mac OS X; zh-cn) AppleWebKit/533.17.9 (KHTML, like Gecko) Version/5.0.2 Mobile/8C148 Safari/6533.18.5"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:2.0b13pre) Gecko/20110307 Firefox/4.0b13pre"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:16.0) Gecko/20100101 Firefox/16.0"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.64 Safari/537.11"</span><span class="token punctuation">,</span>
    <span class="token string">"Mozilla/5.0 (X11; U; Linux x86_64; zh-CN; rv:1.9.2.10) Gecko/20100922 Ubuntu/10.10 (maverick) Firefox/3.6.10"</span>
<span class="token punctuation">]</span>

<span class="token keyword">class</span> <span class="token class-name">RandomUserAgent</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'https://cdnware.m.jd.com'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 如果使用手机抓包, 获取到商品信息; 生成请求请求头</span>
            request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'user-agent'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'JD4iPhone/164880 (iPhone; iOS 12.1.2; Scale/2.00)'</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 随机获取一个请求头, 进行设置</span>
            request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'user-agent'</span><span class="token punctuation">]</span> <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>USER_AGENTS<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="IP_851"></a>实现代理IP中间件</h5> 
<ul><li> <p><code>步骤</code>:</p> 
  <ul><li>在middlewares.py中, 实现ProxyMiddleware类</li><li>实现process_request方法 
    <ul><li>从代理池中获取一个随机的代理IP, 需指定代理IP的协议, 和访问的域名</li><li>设置给request.meta[‘proxy’]</li></ul> </li><li>实现process_exception方法</li><li>当请求出现异常的时候, 代理池哪些代理IP在本域名下是不可以用的</li></ul> </li><li> <p><code>代码</code></p> </li></ul> 
<pre><code class="prism language-py"><span class="token triple-quoted-string string">"""
9.2. 实现代理IP中间件
步骤:
    在middlewares.py中, 实现ProxyMiddleware类
    实现process_request方法
    从代理池中获取一个随机的代理IP
    设置给request.meta['proxy']
"""</span>
<span class="token keyword">from</span> twisted<span class="token punctuation">.</span>internet <span class="token keyword">import</span> defer
<span class="token keyword">from</span> twisted<span class="token punctuation">.</span>internet<span class="token punctuation">.</span>error <span class="token keyword">import</span> TimeoutError<span class="token punctuation">,</span> DNSLookupError<span class="token punctuation">,</span> \
        ConnectionRefusedError<span class="token punctuation">,</span> ConnectionDone<span class="token punctuation">,</span> ConnectError<span class="token punctuation">,</span> \
        ConnectionLost<span class="token punctuation">,</span> TCPTimedOutError
<span class="token keyword">from</span> twisted<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client <span class="token keyword">import</span> ResponseFailed
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>core<span class="token punctuation">.</span>downloader<span class="token punctuation">.</span>handlers<span class="token punctuation">.</span>http11 <span class="token keyword">import</span> TunnelError

<span class="token keyword">class</span> <span class="token class-name">ProxyMiddleware</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    EXCEPTIONS_TO_RETRY <span class="token operator">=</span> <span class="token punctuation">(</span>defer<span class="token punctuation">.</span>TimeoutError<span class="token punctuation">,</span> TimeoutError<span class="token punctuation">,</span> DNSLookupError<span class="token punctuation">,</span>
                           ConnectionRefusedError<span class="token punctuation">,</span> ConnectionDone<span class="token punctuation">,</span> ConnectError<span class="token punctuation">,</span>
                           ConnectionLost<span class="token punctuation">,</span> TCPTimedOutError<span class="token punctuation">,</span> ResponseFailed<span class="token punctuation">,</span>
                           IOError<span class="token punctuation">,</span> TunnelError<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
         从代理池中获取一个随机的代理IP
         设置给request.meta['proxy']
        """</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://localhost:6868/random?protocol=https&amp;domain=jd.com'</span><span class="token punctuation">)</span>
        request<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">'proxy'</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
        request<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">'dont_redirect'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

   <span class="token keyword">def</span> <span class="token function">process_exception</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>exception<span class="token punctuation">,</span> self<span class="token punctuation">.</span>EXCEPTIONS_TO_RETRY<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 获取代理IP</span>
            proxy <span class="token operator">=</span> request<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">'proxy'</span><span class="token punctuation">]</span>
            <span class="token comment"># 提取IP地址</span>
            ip <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'https://(.+):\d+'</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

            params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string">'ip'</span><span class="token punctuation">:</span> ip<span class="token punctuation">,</span>
              <span class="token string">'domain'</span><span class="token punctuation">:</span> <span class="token string">'jd.com'</span>
            <span class="token punctuation">}</span>

            requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://localhost:6868/disable_domain'</span><span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span>
            <span class="token comment"># 构建请求返回</span>
            req <span class="token operator">=</span> request<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            req<span class="token punctuation">.</span>dont_filter <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword">return</span> req
</code></pre> 
<p><strong>在settings.py中开启上面的两个下载器中间件</strong></p> 
<pre><code class="prism language-py">    <span class="token comment"># 配置下载器中间件</span>
    DOWNLOADER_MIDDLEWARES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'mall_spider.middlewares.RandomUserAgent'</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
    <span class="token string">'mall_spider.middlewares.ProxyMiddl eware'</span><span class="token punctuation">:</span> <span class="token number">543</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>完整源码请关注微信公众号：ReverseCode，回复：爬虫基础</strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/30d732b9c08c8efc1736f51f9ac8299d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">springmvc&#43;shiro 同一浏览器多次请求，后台controller获取的sessionid不同。</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ae7ec3a0cc66a6aace4ef9e536990d61/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">VS code 报错“检测到 #include 错误，请更新 includepath”</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>