<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PoolFormer实战：使用PoolFormer实现图像分类任务（二） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="PoolFormer实战：使用PoolFormer实现图像分类任务（二）" />
<meta property="og:description" content="文章目录 训练部分导入项目使用的库设置随机因子设置全局参数图像预处理与增强读取数据设置Loss设置模型设置优化器和学习率调整算法设置混合精度，DP多卡，EMA定义训练和验证函数训练函数验证函数调用训练和验证方法 运行以及结果查看测试热力图可视化展示完整的代码 在上一篇文章中完成了前期的准备工作，见链接： PoolFormer实战：使用PoolFormer实现图像分类任务（一） 这篇主要是讲解如何训练和测试 训练部分 完成上面的步骤后，就开始train脚本的编写，新建train.py
导入项目使用的库 在train.py导入
import json import os import matplotlib.pyplot as plt import torch import torch.nn as nn import torch.nn.parallel import torch.optim as optim import torch.utils.data import torch.utils.data.distributed import torchvision.transforms as transforms from timm.utils import accuracy, AverageMeter, ModelEma from sklearn.metrics import classification_report from timm.data.mixup import Mixup from timm.loss import SoftTargetCrossEntropy from timm.models import poolformer_s24 from torch.autograd import Variable from torchvision import datasets torch.backends.cudnn.benchmark = False import warnings warnings." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/19b061dd5a6b3ee17ddd20a8709165dd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-17T06:45:42+08:00" />
<meta property="article:modified_time" content="2023-07-17T06:45:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PoolFormer实战：使用PoolFormer实现图像分类任务（二）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#font_colorDodgerBluefont_5" rel="nofollow"><font color="DodgerBlue">训练部分</font></a></li><li><ul><li><a href="#font_colorDodgerBluefont_9" rel="nofollow"><font color="DodgerBlue">导入项目使用的库</font></a></li><li><a href="#font_colorDodgerBluefont_35" rel="nofollow"><font color="DodgerBlue">设置随机因子</font></a></li><li><a href="#font_colorDodgerBluefont_44" rel="nofollow"><font color="DodgerBlue">设置全局参数</font></a></li><li><a href="#font_colorDodgerBluefont_111" rel="nofollow"><font color="DodgerBlue">图像预处理与增强</font></a></li><li><a href="#font_colorDodgerBluefont_136" rel="nofollow"><font color="DodgerBlue">读取数据</font></a></li><li><a href="#font_colorDodgerBlueLossfont_166" rel="nofollow"><font color="DodgerBlue">设置Loss</font></a></li><li><a href="#font_colorDodgerBluefont_176" rel="nofollow"><font color="DodgerBlue">设置模型</font></a></li><li><a href="#font_colorDodgerBluefont_191" rel="nofollow"><font color="DodgerBlue">设置优化器和学习率调整算法</font></a></li><li><a href="#font_colorDodgerBlueDPEMAfont_200" rel="nofollow"><font color="DodgerBlue">设置混合精度，DP多卡，EMA</font></a></li><li><a href="#font_colorDodgerBluefont_226" rel="nofollow"><font color="DodgerBlue">定义训练和验证函数</font></a></li><li><ul><li><a href="#font_colorDodgerBluefont_228" rel="nofollow"><font color="DodgerBlue">训练函数</font></a></li><li><a href="#font_colorDodgerBluefont_311" rel="nofollow"><font color="DodgerBlue">验证函数</font></a></li><li><a href="#font_colorDodgerBluefont_415" rel="nofollow"><font color="DodgerBlue">调用训练和验证方法</font></a></li></ul> 
  </li></ul> 
  </li><li><a href="#font_colorDodgerBluefont_494" rel="nofollow"><font color="DodgerBlue">运行以及结果查看</font></a></li><li><a href="#font_colorDodgerBluefont_505" rel="nofollow"><font color="DodgerBlue">测试</font></a></li><li><a href="#font_colorDodgerBluefont_577" rel="nofollow"><font color="DodgerBlue">热力图可视化展示</font></a></li><li><a href="#font_colorDodgerBluefont_726" rel="nofollow"><font color="DodgerBlue">完整的代码</font></a></li></ul> 
</div> 
<br> 在上一篇文章中完成了前期的准备工作，见链接： 
<br> 
<a href="https://wanghao.blog.csdn.net/article/details/128494941?spm=1001.2014.3001.5502" rel="nofollow">PoolFormer实战：使用PoolFormer实现图像分类任务（一）</a> 
<br> 这篇主要是讲解如何训练和测试 
<p></p> 
<h2><a id="font_colorDodgerBluefont_5"></a><font color="DodgerBlue">训练部分</font></h2> 
<p>完成上面的步骤后，就开始train脚本的编写，新建train.py</p> 
<h3><a id="font_colorDodgerBluefont_9"></a><font color="DodgerBlue">导入项目使用的库</font></h3> 
<p>在train.py导入</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">import</span> os
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>parallel
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>distributed
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms
<span class="token keyword">from</span> timm<span class="token punctuation">.</span>utils <span class="token keyword">import</span> accuracy<span class="token punctuation">,</span> AverageMeter<span class="token punctuation">,</span> ModelEma
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> classification_report
<span class="token keyword">from</span> timm<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mixup <span class="token keyword">import</span> Mixup
<span class="token keyword">from</span> timm<span class="token punctuation">.</span>loss <span class="token keyword">import</span> SoftTargetCrossEntropy
<span class="token keyword">from</span> timm<span class="token punctuation">.</span>models <span class="token keyword">import</span> poolformer_s24
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> datasets
torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn<span class="token punctuation">.</span>benchmark <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token keyword">import</span> warnings
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'CUDA_VISIBLE_DEVICES'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"0,1"</span>
</code></pre> 
<p>os.environ[‘CUDA_VISIBLE_DEVICES’]=“0,1” 选择显卡，index从0开始，比如一台机器上有8块显卡，我们打算使用前两块显卡训练，设置为“0,1”,同理如果打算使用第三块和第六块显卡训练，则设置为“2,5”。</p> 
<h3><a id="font_colorDodgerBluefont_35"></a><font color="DodgerBlue">设置随机因子</font></h3> 
<pre><code class="prism language-bash">def seed_everything<span class="token punctuation">(</span>seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>:
    os.environ<span class="token punctuation">[</span><span class="token string">'PYHTONHASHSEED'</span><span class="token punctuation">]</span> <span class="token operator">=</span> str<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
    torch.manual_seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
    torch.cuda.manual_seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
    torch.backends.cudnn.deterministic <span class="token operator">=</span> True
</code></pre> 
<p>设置了固定的随机因子，再次训练的时候就可以保证图片的加载顺序不会发生变化。</p> 
<h3><a id="font_colorDodgerBluefont_44"></a><font color="DodgerBlue">设置全局参数</font></h3> 
<pre><code class="prism language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment">#创建保存模型的文件夹</span>
    file_dir <span class="token operator">=</span> <span class="token string">'checkpoints/PoolFormer'</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>file_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'true'</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>file_dir<span class="token punctuation">,</span>exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>file_dir<span class="token punctuation">)</span>
    <span class="token comment"># 设置全局参数</span>
    model_lr <span class="token operator">=</span> <span class="token number">1e-4</span>
    BATCH_SIZE <span class="token operator">=</span> <span class="token number">16</span>
    EPOCHS <span class="token operator">=</span> <span class="token number">1000</span>
    DEVICE <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda:0'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span>
    use_amp <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># 是否使用混合精度</span>
    use_dp <span class="token operator">=</span> <span class="token boolean">True</span> <span class="token comment">#是否开启dp方式的多卡训练</span>
    classes <span class="token operator">=</span> <span class="token number">12</span>
    resume <span class="token operator">=</span><span class="token boolean">None</span>
    CLIP_GRAD <span class="token operator">=</span> <span class="token number">5.0</span>
    Best_ACC <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">#记录最高得分</span>
    use_ema<span class="token operator">=</span><span class="token boolean">True</span>
    model_ema_decay<span class="token operator">=</span><span class="token number">0.9998</span>
    start_epoch<span class="token operator">=</span><span class="token number">1</span>
    SEED<span class="token operator">=</span><span class="token number">42</span>
    seed_everything<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
</code></pre> 
<p>设置存放权重文件的文件夹，如果文件夹存在删除再建立。</p> 
<p>接下来，设置全局参数，比如：学习率、BatchSize、epoch等参数，判断环境中是否存在GPU，如果没有则使用CPU。<br> 注：建议使用GPU，CPU太慢了。</p> 
<p>参数的详细解释：</p> 
<blockquote> 
 <p>model_lr：学习率，根据实际情况做调整。<br> <br> BATCH_SIZE：batchsize，根据显卡的大小设置。<br> <br> EPOCHS：epoch的个数，一般300够用。<br> <br> use_amp：是否使用混合精度。<br> <br> use_dp ：是否开启dp方式的多卡训练？<br> <br> classes：类别个数。<br> <br> resume：再次训练的模型路径，如果不为None,则表示加载resume指向的模型继续训练。<br> <br> CLIP_GRAD：梯度的最大范数，在梯度裁剪里设置。<br> <br> Best_ACC：记录最高ACC得分。<br> <br> use_ema：是否使用ema<br> <br> start_epoch：开始的epoch，默认是1，如果重新训练时，需要给start_epoch重新赋值。<br> <br> SEED:随机因子，数值可以随意设定，但是设置后，不要随意更改，更改后，图片加载的顺序会改变，影响测试结果。</p> 
</blockquote> 
<pre><code class="prism language-bash"> file_dir <span class="token operator">=</span> <span class="token string">'checkpoints/PoolFormer'</span>
</code></pre> 
<p>这是存放PoolFormer模型的路径。</p> 
<h3><a id="font_colorDodgerBluefont_111"></a><font color="DodgerBlue">图像预处理与增强</font></h3> 
<pre><code class="prism language-python">   <span class="token comment"># 数据预处理7</span>
    transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        transforms<span class="token punctuation">.</span>RandomRotation<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>GaussianBlur<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sigma<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>ColorJitter<span class="token punctuation">(</span>brightness<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> contrast<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> saturation<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.44127703</span><span class="token punctuation">,</span> <span class="token number">0.4712498</span><span class="token punctuation">,</span> <span class="token number">0.43714803</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.18507297</span><span class="token punctuation">,</span> <span class="token number">0.18050247</span><span class="token punctuation">,</span> <span class="token number">0.16784933</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    transform_test <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.44127703</span><span class="token punctuation">,</span> <span class="token number">0.4712498</span><span class="token punctuation">,</span> <span class="token number">0.43714803</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.18507297</span><span class="token punctuation">,</span> <span class="token number">0.18050247</span><span class="token punctuation">,</span> <span class="token number">0.16784933</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    mixup_fn <span class="token operator">=</span> Mixup<span class="token punctuation">(</span>
        mixup_alpha<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">,</span> cutmix_alpha<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span> cutmix_minmax<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        prob<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> switch_prob<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'batch'</span><span class="token punctuation">,</span>
        label_smoothing<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span>classes<span class="token punctuation">)</span>
</code></pre> 
<p>数据处理和增强比较简单，加入了随机10度的旋转、高斯模糊、色彩饱和度明亮度的变化、Mixup等比较常用的增强手段，做了Resize和归一化。</p> 
<p>这里注意下Resize的大小，由于选用的PoolFormer模型输入是224×224的大小，所以要Resize为224×224。</p> 
<h3><a id="font_colorDodgerBluefont_136"></a><font color="DodgerBlue">读取数据</font></h3> 
<pre><code class="prism language-python">
   <span class="token comment"># 读取数据</span>

    dataset_train <span class="token operator">=</span> datasets<span class="token punctuation">.</span>ImageFolder<span class="token punctuation">(</span><span class="token string">'data/train'</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>transform<span class="token punctuation">)</span>
    dataset_test <span class="token operator">=</span> datasets<span class="token punctuation">.</span>ImageFolder<span class="token punctuation">(</span><span class="token string">"data/val"</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>transform_test<span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'class.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
        <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>dataset_train<span class="token punctuation">.</span>class_to_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'class.json'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
        <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>dataset_train<span class="token punctuation">.</span>class_to_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 导入数据</span>
    train_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset_train<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>BATCH_SIZE<span class="token punctuation">,</span> pin_memory<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>drop_last<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    test_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset_test<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>BATCH_SIZE<span class="token punctuation">,</span> pin_memory<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

</code></pre> 
<ul><li> <p>使用pytorch默认读取数据的方式，然后将dataset_train.class_to_idx打印出来，预测的时候要用到。</p> </li><li> <p>对于train_loader ，drop_last设置为True，因为使用了Mixup数据增强，必须保证每个batch里面的图片个数为偶数（不能为零），如果最后一个batch里面的图片为奇数，则会报错，所以舍弃最后batch的迭代。pin_memory设置为True，可以加快运行速度。</p> </li><li> <p>将dataset_train.class_to_idx保存到txt文件或者json文件中。</p> </li></ul> 
<p>class_to_idx的结果：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span><span class="token string">'Black-grass'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Charlock'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Cleavers'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'Common Chickweed'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'Common wheat'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'Fat Hen'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'Loose Silky-bent'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'Maize'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'Scentless Mayweed'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'Shepherds Purse'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">'Small-flowered Cranesbill'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'Sugar beet'</span><span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">}</span>
</code></pre> 
<h3><a id="font_colorDodgerBlueLossfont_166"></a><font color="DodgerBlue">设置Loss</font></h3> 
<pre><code class="prism language-python">  <span class="token comment"># 实例化模型并且移动到GPU</span>
    criterion_train <span class="token operator">=</span> SoftTargetCrossEntropy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    criterion_val <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>设置loss函数，训练的loss为：SoftTargetCrossEntropy，验证的loss：nn.CrossEntropyLoss()。</p> 
<h3><a id="font_colorDodgerBluefont_176"></a><font color="DodgerBlue">设置模型</font></h3> 
<pre><code class="prism language-python">  <span class="token comment">#设置模型</span>
    model_ft <span class="token operator">=</span> poolformer_s24<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    model_ft<span class="token punctuation">.</span>reset_classifier<span class="token punctuation">(</span>classes<span class="token punctuation">)</span>
    <span class="token keyword">if</span> resume<span class="token punctuation">:</span>
        model<span class="token operator">=</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>resume<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">[</span><span class="token string">'state_dict'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        model_ft<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>model<span class="token punctuation">[</span><span class="token string">'state_dict'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        Best_ACC<span class="token operator">=</span>model<span class="token punctuation">[</span><span class="token string">'Best_ACC'</span><span class="token punctuation">]</span>
        start_epoch<span class="token operator">=</span>model<span class="token punctuation">[</span><span class="token string">'epoch'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span>
    model_ft<span class="token punctuation">.</span>to<span class="token punctuation">(</span>DEVICE<span class="token punctuation">)</span>
</code></pre> 
<ul><li>设置模型为poolformer_s24，pretrained设置为true,表示加载预训练模型，调用reset_classifier函数将classes设置为12。</li><li>如果resume设置为已经训练的模型的路径，则加载模型接着resume指向的模型接着训练，使用模型里的Best_ACC初始化Best_ACC，使用epoch参数初始化start_epoch</li></ul> 
<h3><a id="font_colorDodgerBluefont_191"></a><font color="DodgerBlue">设置优化器和学习率调整算法</font></h3> 
<pre><code class="prism language-python">   <span class="token comment"># 选择简单暴力的Adam优化器，学习率调低</span>
   optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>AdamW<span class="token punctuation">(</span>model_ft<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>lr<span class="token operator">=</span>model_lr<span class="token punctuation">)</span>
   cosine_schedule <span class="token operator">=</span> optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>CosineAnnealingLR<span class="token punctuation">(</span>optimizer<span class="token operator">=</span>optimizer<span class="token punctuation">,</span> T_max<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> eta_min<span class="token operator">=</span><span class="token number">1e-6</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>优化器设置为adamW。</li><li>学习率调整策略选择为余弦退火。</li></ul> 
<h3><a id="font_colorDodgerBlueDPEMAfont_200"></a><font color="DodgerBlue">设置混合精度，DP多卡，EMA</font></h3> 
<pre><code class="prism language-python">    <span class="token keyword">if</span> use_amp<span class="token punctuation">:</span>
        scaler <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>amp<span class="token punctuation">.</span>GradScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>device_count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">and</span> use_dp<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Let's use"</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>device_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"GPUs!"</span><span class="token punctuation">)</span>
        model_ft <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">(</span>model_ft<span class="token punctuation">)</span>
    <span class="token keyword">if</span> use_ema<span class="token punctuation">:</span>
        model_ema <span class="token operator">=</span> ModelEma<span class="token punctuation">(</span>
            model_ft<span class="token punctuation">,</span>
            decay<span class="token operator">=</span>model_ema_decay<span class="token punctuation">,</span>
            device<span class="token operator">=</span>DEVICE<span class="token punctuation">,</span>
            resume<span class="token operator">=</span>resume<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        model_ema<span class="token operator">=</span><span class="token boolean">None</span>
</code></pre> 
<ul><li>use_amp为True，则开启混合精度训练,声明pytorch自带的混合精度 torch.cuda.amp.GradScaler()。</li><li>检测可用显卡的数量，如果大于1，并且开启多卡训练的情况下，则要用torch.nn.DataParallel加载模型，开启多卡训练。</li><li>如果使用ema，则注册ema<br> 注：torch.nn.DataParallel方式，默认不能开启混合精度训练的，如果想要开启混合精度训练，则需要在模型的forward前面加上@autocast()函数。<br> <img src="https://images2.imgbox.com/0d/68/bsjmFuYe_o.png" alt="在这里插入图片描述"></li></ul> 
<p>如果不开启混合精度则要将@autocast()去掉，否则loss一直试nan。</p> 
<h3><a id="font_colorDodgerBluefont_226"></a><font color="DodgerBlue">定义训练和验证函数</font></h3> 
<h4><a id="font_colorDodgerBluefont_228"></a><font color="DodgerBlue">训练函数</font></h4> 
<pre><code class="prism language-python"><span class="token comment"># 定义训练过程</span>
<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> device<span class="token punctuation">,</span> train_loader<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span>model_ema<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
    loss_meter <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    acc1_meter <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    acc5_meter <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    total_num <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>total_num<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> batch_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data<span class="token punctuation">,</span> target <span class="token operator">=</span> data<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">,</span> non_blocking<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Variable<span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">,</span>                                                                                 non_blocking<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        samples<span class="token punctuation">,</span> targets <span class="token operator">=</span> mixup_fn<span class="token punctuation">(</span>data<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
        output <span class="token operator">=</span> model<span class="token punctuation">(</span>samples<span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> use_amp<span class="token punctuation">:</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>amp<span class="token punctuation">.</span>autocast<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>nan_to_num<span class="token punctuation">(</span>criterion_train<span class="token punctuation">(</span>output<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">)</span>
            scaler<span class="token punctuation">.</span>scale<span class="token punctuation">(</span>loss<span class="token punctuation">)</span><span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>clip_grad_norm_<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CLIP_GRAD<span class="token punctuation">)</span>
            <span class="token comment"># Unscales gradients and calls</span>
            <span class="token comment"># or skips optimizer.step()</span>
            scaler<span class="token punctuation">.</span>step<span class="token punctuation">(</span>optimizer<span class="token punctuation">)</span>
            <span class="token comment"># Updates the scale for next iteration</span>
            scaler<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            loss <span class="token operator">=</span> criterion_train<span class="token punctuation">(</span>output<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># torch.nn.utils.clip_grad_norm_(model.parameters(), CLIP_GRAD)</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> model_ema <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            model_ema<span class="token punctuation">.</span>update<span class="token punctuation">(</span>model<span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>synchronize<span class="token punctuation">(</span><span class="token punctuation">)</span>
        lr <span class="token operator">=</span> optimizer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'param_groups'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span>
        loss_meter<span class="token punctuation">.</span>update<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        acc1<span class="token punctuation">,</span> acc5 <span class="token operator">=</span> accuracy<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">,</span> topk<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        loss_meter<span class="token punctuation">.</span>update<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        acc1_meter<span class="token punctuation">.</span>update<span class="token punctuation">(</span>acc1<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        acc5_meter<span class="token punctuation">.</span>update<span class="token punctuation">(</span>acc5<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>batch_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Train Epoch: {} [{}/{} ({:.0f}%)]\tLoss: {:.6f}\tLR:{:.9f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                epoch<span class="token punctuation">,</span> <span class="token punctuation">(</span>batch_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span><span class="token punctuation">,</span>
                       <span class="token number">100.</span> <span class="token operator">*</span> <span class="token punctuation">(</span>batch_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    ave_loss <span class="token operator">=</span>loss_meter<span class="token punctuation">.</span>avg
    acc <span class="token operator">=</span> acc1_meter<span class="token punctuation">.</span>avg
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'epoch:{}\tloss:{:.2f}\tacc:{:.2f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> ave_loss<span class="token punctuation">,</span> acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ave_loss<span class="token punctuation">,</span> acc

</code></pre> 
<p>训练的主要步骤：</p> 
<blockquote> 
 <p>1、使用AverageMeter保存自定义变量，包括loss，ACC1，ACC5。<br> <br> 2、进入循环，将data和target放入device上，non_blocking设置为True。如果pin_memory=True的话，将数据放入GPU的时候，也应该把non_blocking打开，这样就只把数据放入GPU而不取出，访问时间会大大减少。<br> 如果pin_memory=False时，则将non_blocking设置为False。<br> <br> 3、将数据输入mixup_fn生成mixup数据。<br> <br> 4、将第三部生成的mixup数据输入model，输出预测结果，然后再计算loss。<br> <br> 5、 optimizer.zero_grad() 梯度清零，把loss关于weight的导数变成0。<br> <br> 6、如果使用混合精度，则</p> 
 <blockquote> 
  <ul><li>with torch.cuda.amp.autocast(),开启混合精度。</li><li>计算loss。torch.nan_to_num将输入中的NaN、正无穷大和负无穷大替换为NaN、posinf和neginf。默认情况下，nan会被替换为零，正无穷大会被替换为输入的dtype所能表示的最大有限值，负无穷大会被替换为输入的dtype所能表示的最小有限值。<br> </li><li>scaler.scale(loss).backward()，梯度放大。</li><li>torch.nn.utils.clip_grad_norm_，梯度裁剪，放置梯度爆炸。</li><li>scaler.step(optimizer) ，首先把梯度值unscale回来，如果梯度值不是inf或NaN,则调用optimizer.step()来更新权重，否则，忽略step调用，从而保证权重不更新。</li><li>更新下一次迭代的scaler。</li></ul> 
 </blockquote> 
 <p>否则，直接反向传播求梯度。torch.nn.utils.clip_grad_norm_函数执行梯度裁剪，防止梯度爆炸。<br> <br> 7、如果use_ema为True，则执行model_ema的updata函数，更新模型。<br> <br> 8、 torch.cuda.synchronize()，等待上面所有的操作执行完成。<br> <br> 9、接下来，更新loss，ACC1，ACC5的值。</p> 
</blockquote> 
<p>等待一个epoch训练完成后，计算平均loss和平均acc</p> 
<h4><a id="font_colorDodgerBluefont_311"></a><font color="DodgerBlue">验证函数</font></h4> 
<pre><code class="prism language-python"><span class="token comment"># 验证过程</span>
<span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>no_grad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">val</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> device<span class="token punctuation">,</span> test_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> Best_ACC
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    loss_meter <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    acc1_meter <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    acc5_meter <span class="token operator">=</span> AverageMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    total_num <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>test_loader<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>total_num<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>test_loader<span class="token punctuation">)</span><span class="token punctuation">)</span>
    val_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    pred_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> data<span class="token punctuation">,</span> target <span class="token keyword">in</span> test_loader<span class="token punctuation">:</span>
        <span class="token keyword">for</span> t <span class="token keyword">in</span> target<span class="token punctuation">:</span>
            val_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>t<span class="token punctuation">.</span>data<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        data<span class="token punctuation">,</span> target <span class="token operator">=</span> data<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">,</span>non_blocking<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">,</span>non_blocking<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        output <span class="token operator">=</span> model<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> criterion_val<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
        _<span class="token punctuation">,</span> pred <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> p <span class="token keyword">in</span> pred<span class="token punctuation">:</span>
            pred_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p<span class="token punctuation">.</span>data<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        acc1<span class="token punctuation">,</span> acc5 <span class="token operator">=</span> accuracy<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">,</span> topk<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        loss_meter<span class="token punctuation">.</span>update<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        acc1_meter<span class="token punctuation">.</span>update<span class="token punctuation">(</span>acc1<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        acc5_meter<span class="token punctuation">.</span>update<span class="token punctuation">(</span>acc5<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    acc <span class="token operator">=</span> acc1_meter<span class="token punctuation">.</span>avg
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nVal set: Average loss: {:.4f}\tAcc1:{:.3f}%\tAcc5:{:.3f}%\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
        loss_meter<span class="token punctuation">.</span>avg<span class="token punctuation">,</span>  acc<span class="token punctuation">,</span>  acc5_meter<span class="token punctuation">.</span>avg<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> acc <span class="token operator">&gt;</span> Best_ACC<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">)</span><span class="token punctuation">:</span>
            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>module<span class="token punctuation">,</span> file_dir <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> <span class="token string">'best.pth'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">,</span> file_dir <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> <span class="token string">'best.pth'</span><span class="token punctuation">)</span>
        Best_ACC <span class="token operator">=</span> acc
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">)</span><span class="token punctuation">:</span>
        state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'epoch'</span><span class="token punctuation">:</span> epoch<span class="token punctuation">,</span>
            <span class="token string">'state_dict'</span><span class="token punctuation">:</span> model<span class="token punctuation">.</span>module<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'Best_ACC'</span><span class="token punctuation">:</span>Best_ACC
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> use_ema<span class="token punctuation">:</span>
            state<span class="token punctuation">[</span><span class="token string">'state_dict_ema'</span><span class="token punctuation">]</span><span class="token operator">=</span>model<span class="token punctuation">.</span>module<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>state<span class="token punctuation">,</span> file_dir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> <span class="token string">'model_'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'_'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>acc<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.pth'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'epoch'</span><span class="token punctuation">:</span> epoch<span class="token punctuation">,</span>
            <span class="token string">'state_dict'</span><span class="token punctuation">:</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'Best_ACC'</span><span class="token punctuation">:</span> Best_ACC
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> use_ema<span class="token punctuation">:</span>
            state<span class="token punctuation">[</span><span class="token string">'state_dict_ema'</span><span class="token punctuation">]</span><span class="token operator">=</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>state<span class="token punctuation">,</span> file_dir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> <span class="token string">'model_'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'_'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>acc<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.pth'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> val_list<span class="token punctuation">,</span> pred_list<span class="token punctuation">,</span> loss_meter<span class="token punctuation">.</span>avg<span class="token punctuation">,</span> acc

</code></pre> 
<p>验证集和训练集大致相似，主要步骤：</p> 
<blockquote> 
 <p>1、在val的函数上面添加@torch.no_grad()，作用：所有计算得出的tensor的requires_grad都自动设置为False。即使一个tensor（命名为x）的requires_grad = True，在with torch.no_grad计算，由x得到的新tensor（命名为w-标量）requires_grad也为False，且grad_fn也为None,即不会对w求导。<br> <br> 2、定义参数:<br> loss_meter: 测试的loss<br> acc1_meter:top1的ACC。<br> acc5_meter：top5的ACC。<br> total_num：总的验证集的数量。<br> val_list：验证集的label。<br> pred_list：预测的label。<br> <br> 3、进入循环，迭代test_loader：</p> 
 <blockquote> 
  <p>将label保存到val_list。<br> <br> 将data和target放入device上，non_blocking设置为True。<br> <br> 将data输入到model中，求出预测值，然后输入到loss函数中，求出loss。<br> <br> 调用torch.max函数，将预测值转为对应的label。<br> <br> 将输出的预测值的label存入pred_list。<br> <br> 调用accuracy函数计算ACC1和ACC5<br> <br> 更新loss_meter、acc1_meter、acc5_meter的参数。<br> </p> 
 </blockquote> 
 <p>4、本次epoch循环完成后，求得本次epoch的acc、loss。<br> 5、接下来是保存模型的逻辑<br> 如果ACC比Best_ACC高，则保存best模型<br> 判断模型是否为DP方式训练的模型。</p> 
 <blockquote> 
  <p>如果是DP方式训练的模型，模型参数放在model.module，则需要保存model.module。<br> 否则直接保存model。<br> 注：保存best模型，我们采用保存整个模型的方式，这样保存的模型包含网络结构，在预测的时候，就不用再重新定义网络了。</p> 
 </blockquote> 
 <p>6、接下来保存每个epoch的模型。<br> 判断模型是否为DP方式训练的模型。</p> 
 <blockquote> 
  <p>如果是DP方式训练的模型，模型参数放在model.module，则需要保存model.module.state_dict()。<br> <br> 新建个字典，放置Best_ACC、epoch和 model.module.state_dict()等参数。然后将这个字典保存。判断是否是使用EMA，如果使用，则还需要保存一份ema的权重。<br> 否则，新建个字典，放置Best_ACC、epoch和 model.state_dict()等参数。然后将这个字典保存。判断是否是使用EMA，如果使用，则还需要保存一份ema的权重。</p> 
 </blockquote> 
 <p>注意：对于每个epoch的模型只保存了state_dict参数，没有保存整个模型文件。</p> 
</blockquote> 
<h4><a id="font_colorDodgerBluefont_415"></a><font color="DodgerBlue">调用训练和验证方法</font></h4> 
<pre><code class="prism language-python">    <span class="token comment"># 训练与验证</span>
    is_set_lr <span class="token operator">=</span> <span class="token boolean">False</span>
    log_dir <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    train_loss_list<span class="token punctuation">,</span> val_loss_list<span class="token punctuation">,</span> train_acc_list<span class="token punctuation">,</span> val_acc_list<span class="token punctuation">,</span> epoch_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>start_epoch<span class="token punctuation">,</span> EPOCHS <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        epoch_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>
        train_loss<span class="token punctuation">,</span> train_acc <span class="token operator">=</span> train<span class="token punctuation">(</span>model_ft<span class="token punctuation">,</span> DEVICE<span class="token punctuation">,</span> train_loader<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span>model_ema<span class="token punctuation">)</span>
        train_loss_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_loss<span class="token punctuation">)</span>
        train_acc_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_acc<span class="token punctuation">)</span>
        log_dir<span class="token punctuation">[</span><span class="token string">'train_acc'</span><span class="token punctuation">]</span> <span class="token operator">=</span> train_acc_list
        log_dir<span class="token punctuation">[</span><span class="token string">'train_loss'</span><span class="token punctuation">]</span> <span class="token operator">=</span> train_loss_list
        <span class="token keyword">if</span> use_ema<span class="token punctuation">:</span>
            val_list<span class="token punctuation">,</span> pred_list<span class="token punctuation">,</span> val_loss<span class="token punctuation">,</span> val_acc <span class="token operator">=</span> val<span class="token punctuation">(</span>model_ema<span class="token punctuation">.</span>ema<span class="token punctuation">,</span> DEVICE<span class="token punctuation">,</span> test_loader<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            val_list<span class="token punctuation">,</span> pred_list<span class="token punctuation">,</span> val_loss<span class="token punctuation">,</span> val_acc <span class="token operator">=</span> val<span class="token punctuation">(</span>model_ft<span class="token punctuation">,</span> DEVICE<span class="token punctuation">,</span> test_loader<span class="token punctuation">)</span>
        val_loss_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>val_loss<span class="token punctuation">)</span>
        val_acc_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>val_acc<span class="token punctuation">)</span>
        log_dir<span class="token punctuation">[</span><span class="token string">'val_acc'</span><span class="token punctuation">]</span> <span class="token operator">=</span> val_acc_list
        log_dir<span class="token punctuation">[</span><span class="token string">'val_loss'</span><span class="token punctuation">]</span> <span class="token operator">=</span> val_loss_list
        log_dir<span class="token punctuation">[</span><span class="token string">'best_acc'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Best_ACC
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_dir <span class="token operator">+</span> <span class="token string">'/result.json'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
            <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>log_dir<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>classification_report<span class="token punctuation">(</span>val_list<span class="token punctuation">,</span> pred_list<span class="token punctuation">,</span> target_names<span class="token operator">=</span>dataset_train<span class="token punctuation">.</span>class_to_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> epoch <span class="token operator">&lt;</span> <span class="token number">600</span><span class="token punctuation">:</span>
            cosine_schedule<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> is_set_lr<span class="token punctuation">:</span>
                <span class="token keyword">for</span> param_group <span class="token keyword">in</span> optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">:</span>
                    param_group<span class="token punctuation">[</span><span class="token string">"lr"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1e-6</span>
                    is_set_lr <span class="token operator">=</span> <span class="token boolean">True</span>
        fig <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epoch_list<span class="token punctuation">,</span> train_loss_list<span class="token punctuation">,</span> <span class="token string">'r-'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">u'Train Loss'</span><span class="token punctuation">)</span>
        <span class="token comment"># 显示图例</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epoch_list<span class="token punctuation">,</span> val_loss_list<span class="token punctuation">,</span> <span class="token string">'b-'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">u'Val Loss'</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"Train Loss"</span><span class="token punctuation">,</span> <span class="token string">"Val Loss"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> loc<span class="token operator">=</span><span class="token string">"upper right"</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">u'epoch'</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">u'loss'</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Model Loss '</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>file_dir <span class="token operator">+</span> <span class="token string">"/loss.png"</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        fig2 <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epoch_list<span class="token punctuation">,</span> train_acc_list<span class="token punctuation">,</span> <span class="token string">'r-'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">u'Train Acc'</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epoch_list<span class="token punctuation">,</span> val_acc_list<span class="token punctuation">,</span> <span class="token string">'b-'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">u'Val Acc'</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"Train Acc"</span><span class="token punctuation">,</span> <span class="token string">"Val Acc"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> loc<span class="token operator">=</span><span class="token string">"lower right"</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Model Acc"</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"acc"</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"epoch"</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>file_dir <span class="token operator">+</span> <span class="token string">"/acc.png"</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<p>调用训练函数和验证函数的主要步骤：</p> 
<blockquote> 
 <p>1、定义参数：</p> 
 <ul><li>is_set_lr，是否已经设置了学习率，当epoch大于一定的次数后，会将学习率设置到一定的值，并将其置为True。</li><li>log_dir：记录log用的，将有用的信息保存到字典中，然后转为json保存起来。</li><li>train_loss_list：保存每个epoch的训练loss。</li><li>val_loss_list：保存每个epoch的验证loss。</li><li>train_acc_list：保存每个epoch的训练acc。</li><li>val_acc_list：保存么每个epoch的验证acc。</li><li>epoch_list：存放每个epoch的值。</li></ul> 
 <p>循环epoch</p> 
 <blockquote> 
  <p>1、调用train函数，得到 train_loss, train_acc，并将分别放入train_loss_list，train_acc_list，然后存入到logdir字典中。</p> 
  <p>2、调用验证函数，判断是否使用EMA？<br> 如果使用EMA，则传入model_ema.ema，否则，传入model_ft。得到val_list, pred_list, val_loss, val_acc。将val_loss, val_acc分别放入val_loss_list和val_acc_list中，然后存入到logdir字典中。</p> 
  <p>3、保存log。</p> 
  <p>4、打印本次的测试报告。</p> 
  <p>5、如果epoch大于600，将学习率设置为固定的1e-6。</p> 
  <p>6、绘制loss曲线和acc曲线。</p> 
 </blockquote> 
</blockquote> 
<h2><a id="font_colorDodgerBluefont_494"></a><font color="DodgerBlue">运行以及结果查看</font></h2> 
<p>完成上面的所有代码就可以开始运行了。点击右键，然后选择“run train.py”即可，运行结果如下：<br> <img src="https://images2.imgbox.com/b2/da/5V3KuCP7_o.png" alt="在这里插入图片描述"></p> 
<p>在每个epoch测试完成之后，打印验证集的acc、recall等指标。</p> 
<p>PoolFormer测试结果：</p> 
<p><img src="https://images2.imgbox.com/81/e3/CJ5uzmER_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/5b/dc/SILLzqXs_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="font_colorDodgerBluefont_505"></a><font color="DodgerBlue">测试</font></h2> 
<p>测试，我们采用一种通用的方式。</p> 
<p>测试集存放的目录如下图：</p> 
<pre><code>PoolFormer_demo
├─test
│  ├─1.jpg
│  ├─2.jpg
│  ├─3.jpg
│  ├ ......
└─test.py
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>distributed
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable
<span class="token keyword">import</span> os

classes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'Black-grass'</span><span class="token punctuation">,</span> <span class="token string">'Charlock'</span><span class="token punctuation">,</span> <span class="token string">'Cleavers'</span><span class="token punctuation">,</span> <span class="token string">'Common Chickweed'</span><span class="token punctuation">,</span>
           <span class="token string">'Common wheat'</span><span class="token punctuation">,</span> <span class="token string">'Fat Hen'</span><span class="token punctuation">,</span> <span class="token string">'Loose Silky-bent'</span><span class="token punctuation">,</span>
           <span class="token string">'Maize'</span><span class="token punctuation">,</span> <span class="token string">'Scentless Mayweed'</span><span class="token punctuation">,</span> <span class="token string">'Shepherds Purse'</span><span class="token punctuation">,</span> <span class="token string">'Small-flowered Cranesbill'</span><span class="token punctuation">,</span> <span class="token string">'Sugar beet'</span><span class="token punctuation">)</span>
transform_test <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.51819474</span><span class="token punctuation">,</span> <span class="token number">0.5250407</span><span class="token punctuation">,</span> <span class="token number">0.4945761</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.24228974</span><span class="token punctuation">,</span> <span class="token number">0.24347611</span><span class="token punctuation">,</span> <span class="token number">0.2530049</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

DEVICE <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda:0"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
model<span class="token operator">=</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'checkpoints/PoolFormer/best.pth'</span><span class="token punctuation">,</span>map_location<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>DEVICE<span class="token punctuation">)</span>

path <span class="token operator">=</span> <span class="token string">'test/'</span>
testList <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> testList<span class="token punctuation">:</span>
    img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>path <span class="token operator">+</span> <span class="token builtin">file</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> transform_test<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    img<span class="token punctuation">.</span>unsqueeze_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> Variable<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>DEVICE<span class="token punctuation">)</span>
    out <span class="token operator">=</span> model<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token comment"># Predict</span>
    _<span class="token punctuation">,</span> pred <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Image Name:{},predict:{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> classes<span class="token punctuation">[</span>pred<span class="token punctuation">.</span>data<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


</code></pre> 
<p>测试的主要逻辑：</p> 
<blockquote> 
 <p>1、定义类别，这个类别的顺序和训练时的类别顺序对应，一定不要改变顺序！！！！<br> <br> 2、定义transforms，transforms和验证集的transforms一样即可，别做数据增强。<br> <br> 3、 加载model，并将模型放在DEVICE里，<br> <br> 4、循环 读取图片并预测图片的类别，在这里注意，读取图片用PIL库的Image。不要用cv2，transforms不支持。循环里面的主要逻辑：</p> 
 <blockquote> 
  <ul><li>使用Image.open读取图片</li><li>使用transform_test对图片做归一化和标椎化。</li><li>img.unsqueeze_(0) 增加一个维度，由（3，224，224）变为（1，3，224，224）</li><li>Variable(img).to(DEVICE)：将数据放入DEVICE中。</li><li>model(img)：执行预测。</li><li>_, pred = torch.max(out.data, 1):获取预测值的最大下角标。</li></ul> 
 </blockquote> 
</blockquote> 
<p>运行结果：</p> 
<p><img src="https://images2.imgbox.com/77/9e/F5IWI9Sg_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="font_colorDodgerBluefont_577"></a><font color="DodgerBlue">热力图可视化展示</font></h2> 
<p>新建脚本cam_image.py,插入如下代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> argparse
<span class="token keyword">import</span> os
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> pytorch_grad_cam <span class="token keyword">import</span> GradCAM<span class="token punctuation">,</span> \
    ScoreCAM<span class="token punctuation">,</span> \
    GradCAMPlusPlus<span class="token punctuation">,</span> \
    AblationCAM<span class="token punctuation">,</span> \
    XGradCAM<span class="token punctuation">,</span> \
    EigenCAM<span class="token punctuation">,</span> \
    EigenGradCAM<span class="token punctuation">,</span> \
    LayerCAM<span class="token punctuation">,</span> \
    FullGrad
<span class="token keyword">from</span> pytorch_grad_cam <span class="token keyword">import</span> GuidedBackpropReLUModel
<span class="token keyword">from</span> pytorch_grad_cam<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>image <span class="token keyword">import</span> show_cam_on_image<span class="token punctuation">,</span> \
    deprocess_image<span class="token punctuation">,</span> \
    preprocess_image
<span class="token keyword">from</span> pytorch_grad_cam<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>model_targets <span class="token keyword">import</span> ClassifierOutputTarget

<span class="token keyword">import</span> timm
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable


<span class="token keyword">def</span> <span class="token function">get_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--use-cuda'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Use NVIDIA GPU acceleration'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span>
        <span class="token string">'--image-path'</span><span class="token punctuation">,</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>
        default<span class="token operator">=</span><span class="token string">"./test/0bf7bfb05.png"</span><span class="token punctuation">,</span>
        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Input image path'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span>
        <span class="token string">'--output-image-path'</span><span class="token punctuation">,</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>
        default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Output image path'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span>
        <span class="token string">'--model'</span><span class="token punctuation">,</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>
        default<span class="token operator">=</span><span class="token string">'poolformer'</span><span class="token punctuation">,</span>
        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'model name'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--aug_smooth'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Apply test time augmentation to smooth the CAM'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span>
        <span class="token string">'--eigen_smooth'</span><span class="token punctuation">,</span>
        action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>
        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Reduce noise by taking the first principle componenet'</span>
        <span class="token string">'of cam_weights*activations'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--method'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'gradcam++'</span><span class="token punctuation">,</span>
                        choices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'gradcam'</span><span class="token punctuation">,</span> <span class="token string">'gradcam++'</span><span class="token punctuation">,</span>
                                 <span class="token string">'scorecam'</span><span class="token punctuation">,</span> <span class="token string">'xgradcam'</span><span class="token punctuation">,</span>
                                 <span class="token string">'ablationcam'</span><span class="token punctuation">,</span> <span class="token string">'eigencam'</span><span class="token punctuation">,</span>
                                 <span class="token string">'eigengradcam'</span><span class="token punctuation">,</span> <span class="token string">'layercam'</span><span class="token punctuation">,</span> <span class="token string">'fullgrad'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Can be gradcam/gradcam++/scorecam/xgradcam'</span>
                             <span class="token string">'/ablationcam/eigencam/eigengradcam/layercam'</span><span class="token punctuation">)</span>

    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    args<span class="token punctuation">.</span>use_cuda <span class="token operator">=</span> args<span class="token punctuation">.</span>use_cuda <span class="token keyword">and</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>use_cuda<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Using GPU for acceleration'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Using CPU for computation'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> args


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    args <span class="token operator">=</span> get_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    methods <span class="token operator">=</span> \
        <span class="token punctuation">{<!-- --></span><span class="token string">"gradcam"</span><span class="token punctuation">:</span> GradCAM<span class="token punctuation">,</span>
         <span class="token string">"scorecam"</span><span class="token punctuation">:</span> ScoreCAM<span class="token punctuation">,</span>
         <span class="token string">"gradcam++"</span><span class="token punctuation">:</span> GradCAMPlusPlus<span class="token punctuation">,</span>
         <span class="token string">"ablationcam"</span><span class="token punctuation">:</span> AblationCAM<span class="token punctuation">,</span>
         <span class="token string">"xgradcam"</span><span class="token punctuation">:</span> XGradCAM<span class="token punctuation">,</span>
         <span class="token string">"eigencam"</span><span class="token punctuation">:</span> EigenCAM<span class="token punctuation">,</span>
         <span class="token string">"eigengradcam"</span><span class="token punctuation">:</span> EigenGradCAM<span class="token punctuation">,</span>
         <span class="token string">"layercam"</span><span class="token punctuation">:</span> LayerCAM<span class="token punctuation">,</span>
         <span class="token string">"fullgrad"</span><span class="token punctuation">:</span> FullGrad<span class="token punctuation">}</span>

    DEVICE <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda:0"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
    model <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'checkpoints/PoolFormer/best.pth'</span><span class="token punctuation">,</span>map_location<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span>
    reshape_transform <span class="token operator">=</span> <span class="token boolean">None</span>
    target_layers <span class="token operator">=</span> <span class="token punctuation">[</span>model<span class="token punctuation">.</span>network<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment"># [model.network[-1][-2]]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>target_layers<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    img_path <span class="token operator">=</span> args<span class="token punctuation">.</span>image_path
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>image_path<span class="token punctuation">:</span>
        img_path <span class="token operator">=</span> args<span class="token punctuation">.</span>image_path
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">import</span> requests
        image_url <span class="token operator">=</span> <span class="token string">'http://146.48.86.29/edge-mac/imgs/n02123045/ILSVRC2012_val_00023779.JPEG'</span>
        img_path <span class="token operator">=</span> image_url<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            img_data <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>image_url<span class="token punctuation">)</span><span class="token punctuation">.</span>content
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>img_path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> handler<span class="token punctuation">:</span>
                handler<span class="token punctuation">.</span>write<span class="token punctuation">(</span>img_data<span class="token punctuation">)</span>

    <span class="token keyword">if</span> args<span class="token punctuation">.</span>output_image_path<span class="token punctuation">:</span>
        save_name <span class="token operator">=</span> args<span class="token punctuation">.</span>output_image_path
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        img_type <span class="token operator">=</span> img_path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        it_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>img_type<span class="token punctuation">)</span>
        save_name <span class="token operator">=</span> img_path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token punctuation">(</span>it_len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        save_name <span class="token operator">=</span> save_name <span class="token operator">+</span> <span class="token string">'_'</span> <span class="token operator">+</span> args<span class="token punctuation">.</span>model <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> img_type

    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_AREA<span class="token punctuation">)</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>model <span class="token operator">==</span> <span class="token string">'resize'</span><span class="token punctuation">:</span>
        cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>save_name<span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        rgb_img <span class="token operator">=</span> img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        rgb_img <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span>rgb_img<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255</span>
        input_tensor <span class="token operator">=</span> Variable<span class="token punctuation">(</span>preprocess_image<span class="token punctuation">(</span>rgb_img<span class="token punctuation">,</span>
                                        mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.51819474</span><span class="token punctuation">,</span> <span class="token number">0.5250407</span><span class="token punctuation">,</span> <span class="token number">0.4945761</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                        std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.24228974</span><span class="token punctuation">,</span> <span class="token number">0.24347611</span><span class="token punctuation">,</span> <span class="token number">0.2530049</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        targets <span class="token operator">=</span> <span class="token boolean">None</span>
        cam_algorithm <span class="token operator">=</span> methods<span class="token punctuation">[</span>args<span class="token punctuation">.</span>method<span class="token punctuation">]</span>
        <span class="token keyword">with</span> cam_algorithm<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">,</span>
                        target_layers<span class="token operator">=</span>target_layers<span class="token punctuation">,</span>
                        use_cuda<span class="token operator">=</span>args<span class="token punctuation">.</span>use_cuda<span class="token punctuation">,</span>
                        reshape_transform<span class="token operator">=</span>reshape_transform<span class="token punctuation">,</span> 
                        <span class="token punctuation">)</span> <span class="token keyword">as</span> cam<span class="token punctuation">:</span>
            cam<span class="token punctuation">.</span>batch_size <span class="token operator">=</span> <span class="token number">1</span>
            grayscale_cam <span class="token operator">=</span> cam<span class="token punctuation">(</span>input_tensor<span class="token operator">=</span>input_tensor<span class="token punctuation">,</span>
                                targets<span class="token operator">=</span>targets<span class="token punctuation">,</span>
                                aug_smooth<span class="token operator">=</span>args<span class="token punctuation">.</span>aug_smooth<span class="token punctuation">,</span>
                                eigen_smooth<span class="token operator">=</span>args<span class="token punctuation">.</span>eigen_smooth<span class="token punctuation">)</span>
            grayscale_cam <span class="token operator">=</span> grayscale_cam<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
            cam_image <span class="token operator">=</span> show_cam_on_image<span class="token punctuation">(</span>rgb_img<span class="token punctuation">,</span> grayscale_cam<span class="token punctuation">,</span> use_rgb<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            cam_image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>cam_image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_RGB2BGR<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>save_name<span class="token punctuation">,</span> cam_image<span class="token punctuation">)</span>


</code></pre> 
<p>对get_args函数的参数进行设置：</p> 
<ul><li>use-cuda:是否使用cuda，如果在没有GPU的电脑上调试时，将其设置为False。</li><li>image-path：待测图片的路径，这个是必填项。</li><li>model：必填项，默认值：PoolFormer。</li></ul> 
<p>效果如下图所示：</p> 
<p><img src="https://images2.imgbox.com/fd/43/poJSWsBO_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/28/18/n5YKjJrI_o.png" alt="请添加图片描述"><img src="https://images2.imgbox.com/48/a0/OIcstWwQ_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="font_colorDodgerBluefont_726"></a><font color="DodgerBlue">完整的代码</font></h2> 
<p>完整的代码：https://download.csdn.net/download/hhhhhhhhhhwwwwwwwwww/87357450</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3da063009bf12c52e8eb73b1390b3d64/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【论文阅读】《Distilling the Knowledge in a Neural Network》</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3164073141384b656d1612d0526929bd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python案例分析｜使用Python图像处理库Pillow处理图像文件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>