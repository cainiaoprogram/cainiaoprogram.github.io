<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【神经网络与深度学习day10-基于torch使用Lenet实现手写数字识别】 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【神经网络与深度学习day10-基于torch使用Lenet实现手写数字识别】" />
<meta property="og:description" content="神经网络与深度学习day10-基于pytorch：LeNet实现MNIST 5.3 基于LeNet实现手写体数字识别实验5.3.1 MNIST数据集5.3.1.1 数据集介绍5.3.1.2 数据集导入 5.3.2 模型构建5.3.2.1 **使用自定义算子，构建LeNet-5模型**5.3.2.2 **使用pytorch中的相应算子，构建LeNet-5模型**5.3.2.3模型测试5.3.2.4 测试两个网络的运算速度。5.3.2.5 测试两个网络的运算结果5.3.2.6 统计LeNet-5模型的参数量和计算量。5.3.2.7 paddle可以统计Floats,torch可以吗？ 5.3.3 模型训练5.3.4 模型评价5.3.5 模型预测 使用前馈神经网络实现MNIST识别，与LeNet效果对比。（选做）可视化LeNet中的部分特征图和卷积核，谈谈自己的看法。（选做）总结Rerferences: 5.3 基于LeNet实现手写体数字识别实验 5.3.1 MNIST数据集 5.3.1.1 数据集介绍 手写体数字识别是计算机视觉中最常用的图像分类任务，让计算机识别出给定图片中的手写体数字（0-9共10个数字）。由于手写体风格差异很大，因此手写体数字识别是具有一定难度的任务。
我们采用常用的手写数字识别数据集：MNIST数据集。
我们可以从这里下载手写数字识别数据集：MNIST
MNIST数据集是计算机视觉领域的经典入门数据集，包含了60,000个训练样本和10,000个测试样本。
这些数字已经过尺寸标准化并位于图像中心，图像是固定大小(28×28像素)。
LeNet-5虽然提出的时间比较早，但它是一个非常成功的神经网络模型。
基于LeNet-5的手写数字识别系统在20世纪90年代被美国很多银行使用，用来识别支票上面的手写数字。
导入数据集代码如下：
import json import gzip # 打印并观察数据集分布情况 train_set, dev_set, test_set = json.load(gzip.open(&#39;./mnist.json.gz&#39;)) train_images, train_labels = train_set[0][:3000], train_set[1][:3000] dev_images, dev_labels = dev_set[0][:200], dev_set[1][:200] test_images, test_labels = test_set[0][:200], test_set[1][:200] train_set, dev_set, test_set = [train_images, train_labels], [dev_images, dev_labels], [test_images, test_labels] print(&#39;Length of train/dev/test set:{}/{}/{}&#39;." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/968123ec8907110d5964e23d57ff4444/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-28T22:10:09+08:00" />
<meta property="article:modified_time" content="2022-10-28T22:10:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【神经网络与深度学习day10-基于torch使用Lenet实现手写数字识别】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>神经网络与深度学习day10-基于pytorch：LeNet实现MNIST</h4> 
 <ul><li><a href="#53_LeNet_7" rel="nofollow">5.3 基于LeNet实现手写体数字识别实验</a></li><li><ul><li><a href="#531_MNIST_8" rel="nofollow">5.3.1 MNIST数据集</a></li><li><ul><li><a href="#5311__9" rel="nofollow">5.3.1.1 数据集介绍</a></li><li><a href="#5312__57" rel="nofollow">5.3.1.2 数据集导入</a></li></ul> 
   </li><li><a href="#532__91" rel="nofollow">5.3.2 模型构建</a></li><li><ul><li><a href="#5321_LeNet5_100" rel="nofollow">5.3.2.1 **使用自定义算子，构建LeNet-5模型**</a></li><li><a href="#5322_pytorchLeNet5_149" rel="nofollow">5.3.2.2 **使用pytorch中的相应算子，构建LeNet-5模型**</a></li><li><a href="#5323_192" rel="nofollow">5.3.2.3模型测试</a></li><li><a href="#5324__236" rel="nofollow">5.3.2.4 测试两个网络的运算速度。</a></li><li><a href="#5325__280" rel="nofollow">5.3.2.5 测试两个网络的运算结果</a></li><li><a href="#5326_LeNet5_317" rel="nofollow">5.3.2.6 统计LeNet-5模型的参数量和计算量。</a></li><li><a href="#5327_paddleFloatstorch_330" rel="nofollow">5.3.2.7 paddle可以统计Floats,torch可以吗？</a></li></ul> 
   </li><li><a href="#533__341" rel="nofollow">5.3.3 模型训练</a></li><li><a href="#534__665" rel="nofollow">5.3.4 模型评价</a></li><li><a href="#535__718" rel="nofollow">5.3.5 模型预测</a></li></ul> 
  </li><li><a href="#MNISTLeNet_745" rel="nofollow">使用前馈神经网络实现MNIST识别，与LeNet效果对比。（选做）</a></li><li><a href="#LeNet_827" rel="nofollow">可视化LeNet中的部分特征图和卷积核，谈谈自己的看法。（选做）</a></li><li><a href="#_839" rel="nofollow">总结</a></li><li><a href="#Rerferences_847" rel="nofollow">Rerferences:</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="53_LeNet_7"></a>5.3 基于LeNet实现手写体数字识别实验</h2> 
<h3><a id="531_MNIST_8"></a>5.3.1 MNIST数据集</h3> 
<h4><a id="5311__9"></a>5.3.1.1 数据集介绍</h4> 
<p>手写体数字识别是计算机视觉中最常用的图像分类任务，让计算机识别出给定图片中的手写体数字（0-9共10个数字）。由于手写体风格差异很大，因此手写体数字识别是具有一定难度的任务。</p> 
<p>我们采用常用的手写数字识别数据集：<strong>MNIST数据集。</strong><br> 我们可以从这里下载手写数字识别数据集：<a href="http://yann.lecun.com/exdb/mnist/index.html" rel="nofollow">MNIST</a><br> MNIST数据集是计算机视觉领域的经典入门数据集，包含了60,000个训练样本和10,000个测试样本。</p> 
<p>这些数字已经过尺寸标准化并位于图像中心，图像是固定大小(28×28像素)。<br> <img src="https://images2.imgbox.com/3a/b5/4ShLw9OP_o.png" alt="在这里插入图片描述"><br> LeNet-5虽然提出的时间比较早，但它是一个非常成功的神经网络模型。</p> 
<p>基于LeNet-5的手写数字识别系统在20世纪90年代被美国很多银行使用，用来识别支票上面的手写数字。<br> <img src="https://images2.imgbox.com/22/de/U48kis2L_o.png" alt="在这里插入图片描述"><br> 导入数据集代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">import</span> gzip
<span class="token comment"># 打印并观察数据集分布情况</span>
train_set<span class="token punctuation">,</span> dev_set<span class="token punctuation">,</span> test_set <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>gzip<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./mnist.json.gz'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
train_images<span class="token punctuation">,</span> train_labels <span class="token operator">=</span> train_set<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3000</span><span class="token punctuation">]</span><span class="token punctuation">,</span> train_set<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3000</span><span class="token punctuation">]</span>
dev_images<span class="token punctuation">,</span> dev_labels <span class="token operator">=</span> dev_set<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dev_set<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">]</span>
test_images<span class="token punctuation">,</span> test_labels <span class="token operator">=</span> test_set<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span> test_set<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">]</span>
train_set<span class="token punctuation">,</span> dev_set<span class="token punctuation">,</span> test_set <span class="token operator">=</span> <span class="token punctuation">[</span>train_images<span class="token punctuation">,</span> train_labels<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>dev_images<span class="token punctuation">,</span> dev_labels<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>test_images<span class="token punctuation">,</span> test_labels<span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Length of train/dev/test set:{}/{}/{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>train_set<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dev_set<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>test_set<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>为了方便观察训练过程，我们划分训练集3000张。<br> Length of train/dev/test set:3000/200/200<br> <img src="https://images2.imgbox.com/3e/e8/qgD73hjR_o.png" alt="在这里插入图片描述"><br> <strong>数据集第一张图片展示：</strong><br> 代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> PIL<span class="token punctuation">.</span>Image <span class="token keyword">as</span> Image
image<span class="token punctuation">,</span> label <span class="token operator">=</span> train_set<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> train_set<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
image<span class="token punctuation">,</span> label <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span>
<span class="token comment"># 原始图像数据为长度784的行向量，需要调整为[28,28]大小的图像</span>
image <span class="token operator">=</span> np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
image <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>image<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'uint8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'L'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"The number in the picture is {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'conv-number5.pdf'</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/da/ea/g3vrFboP_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="5312__57"></a>5.3.1.2 数据集导入</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms

<span class="token comment"># 数据预处理</span>
transforms <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> random
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset<span class="token punctuation">,</span>DataLoader

<span class="token keyword">class</span> <span class="token class-name">MNIST_dataset</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dataset<span class="token punctuation">,</span> transforms<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>mode <span class="token operator">=</span> mode
        self<span class="token punctuation">.</span>transforms <span class="token operator">=</span>transforms
        self<span class="token punctuation">.</span>dataset <span class="token operator">=</span> dataset

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 获取图像和标签</span>
        image<span class="token punctuation">,</span> label <span class="token operator">=</span> self<span class="token punctuation">.</span>dataset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>dataset<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        image<span class="token punctuation">,</span> label <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        image <span class="token operator">=</span> np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        image <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>image<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'uint8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'L'</span><span class="token punctuation">)</span>
        image <span class="token operator">=</span> self<span class="token punctuation">.</span>transforms<span class="token punctuation">(</span>image<span class="token punctuation">)</span>

        <span class="token keyword">return</span> image<span class="token punctuation">,</span> label

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>dataset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 加载 mnist 数据集</span>
train_dataset <span class="token operator">=</span> MNIST_dataset<span class="token punctuation">(</span>dataset<span class="token operator">=</span>train_set<span class="token punctuation">,</span> transforms<span class="token operator">=</span>transforms<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">)</span>
test_dataset <span class="token operator">=</span> MNIST_dataset<span class="token punctuation">(</span>dataset<span class="token operator">=</span>test_set<span class="token punctuation">,</span> transforms<span class="token operator">=</span>transforms<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'test'</span><span class="token punctuation">)</span>
dev_dataset <span class="token operator">=</span> MNIST_dataset<span class="token punctuation">(</span>dataset<span class="token operator">=</span>dev_set<span class="token punctuation">,</span> transforms<span class="token operator">=</span>transforms<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'dev'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="532__91"></a>5.3.2 模型构建</h3> 
<p>这里的LeNet-5和原始版本有4点不同：</p> 
<ol><li>C3层没有使用连接表来减少卷积数量。</li><li>汇聚层使用了简单的平均汇聚，没有引入权重和偏置参数以及非线性激活函数。</li><li>卷积层的激活函数使用ReLU函数。</li><li>最后的输出层为一个全连接线性层。</li></ol> 
<p>网络共有7层，包含3个卷积层、2个汇聚层以及2个全连接层的简单卷积神经网络接，受输入图像大小为32×32=1024，输出对应10个类别的得分。</p> 
<h4><a id="5321_LeNet5_100"></a>5.3.2.1 <strong>使用自定义算子，构建LeNet-5模型</strong></h4> 
<p>自定义的Conv2D和Pool2D算子中包含多个for循环，所以运算速度比较慢。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn


<span class="token keyword">class</span> <span class="token class-name">Model_LeNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Model_LeNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 卷积层：输出通道数为6，卷积核大小为5×5</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token comment"># 汇聚层：汇聚窗口为2×2，步长为2</span>
        self<span class="token punctuation">.</span>pool2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment"># 卷积层：输入通道数为6，输出通道数为16，卷积核大小为5×5，步长为1</span>
        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 汇聚层：汇聚窗口为2×2，步长为2</span>
        self<span class="token punctuation">.</span>pool4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>AvgPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment"># 卷积层：输入通道数为16，输出通道数为120，卷积核大小为5×5</span>
        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">120</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 全连接层：输入神经元为120，输出神经元为84</span>
        self<span class="token punctuation">.</span>linear6 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">)</span>
        <span class="token comment"># 全连接层：输入神经元为84，输出神经元为类别数</span>
        self<span class="token punctuation">.</span>linear7 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># C1：卷积层+激活函数</span>

        output <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># S2：汇聚层</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>pool2<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        <span class="token comment"># C3：卷积层+激活函数</span>
        output <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># S4：汇聚层</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>pool4<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        <span class="token comment"># C5：卷积层+激活函数</span>
        output <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 输入层将数据拉平[B,C,H,W] -&gt; [B,CxHxW]</span>
        output <span class="token operator">=</span> torch<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>output<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
        output <span class="token operator">=</span> torch<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>output<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment"># F6：全连接层</span>
        output <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>linear6<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># F7：全连接层</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>linear7<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        <span class="token keyword">return</span> output

</code></pre> 
<h4><a id="5322_pytorchLeNet5_149"></a>5.3.2.2 <strong>使用pytorch中的相应算子，构建LeNet-5模型</strong></h4> 
<p><strong>torch.nn.Conv2d()；torch.nn.MaxPool2d()；torch.nn.avg_pool2d()</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Torch_LeNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Torch_LeNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 卷积层：输出通道数为6，卷积核大小为5*5</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token comment"># 汇聚层：汇聚窗口为2*2，步长为2</span>
        self<span class="token punctuation">.</span>pool2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment"># 卷积层：输入通道数为6，输出通道数为16，卷积核大小为5*5</span>
        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token comment"># 汇聚层：汇聚窗口为2*2，步长为2</span>
        self<span class="token punctuation">.</span>pool4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>AvgPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment"># 卷积层：输入通道数为16，输出通道数为120，卷积核大小为5*5</span>
        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">120</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token comment"># 全连接层：输入神经元为120，输出神经元为84</span>
        self<span class="token punctuation">.</span>linear6 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">120</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">84</span><span class="token punctuation">)</span>
        <span class="token comment"># 全连接层：输入神经元为84，输出神经元为类别数</span>
        self<span class="token punctuation">.</span>linear7 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">84</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># C1：卷积层+激活函数</span>
        output <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># S2：汇聚层</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>pool2<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        <span class="token comment"># C3：卷积层+激活函数</span>
        output <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># S4：汇聚层</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>pool4<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        <span class="token comment"># C5：卷积层+激活函数</span>
        output <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 输入层将数据拉平[B,C,H,W] -&gt; [B,CxHxW]</span>
        output <span class="token operator">=</span> torch<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>output<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
        output <span class="token operator">=</span> torch<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>output<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment"># F6：全连接层</span>
        output <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>linear6<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># F7：全连接层</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>linear7<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        <span class="token keyword">return</span> output
</code></pre> 
<h4><a id="5323_192"></a>5.3.2.3模型测试</h4> 
<p>测试LeNet-5模型，构造一个形状为 [1,1,32,32]的输入数据送入网络，观察每一层特征图的形状变化。</p> 
<pre><code class="prism language-python"><span class="token comment"># 这里用np.random创建一个随机数组作为输入数据</span>
inputs <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
inputs <span class="token operator">=</span> inputs<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>

<span class="token comment"># 创建Model_LeNet类的实例，指定模型名称和分类的类别数目</span>
model <span class="token operator">=</span> Model_LeNet<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>
<span class="token comment"># 通过调用LeNet从基类继承的sublayers()函数，查看LeNet中所包含的子层</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token keyword">for</span> item <span class="token keyword">in</span> model<span class="token punctuation">.</span>children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># item是LeNet类中的一个子层</span>
    <span class="token comment"># 查看经过子层之后的输出数据形状</span>
    item_shapex <span class="token operator">=</span> <span class="token number">0</span>
    names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    parameter <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> name <span class="token keyword">in</span> item<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        names<span class="token punctuation">.</span>append<span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        parameter<span class="token punctuation">.</span>append<span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        item_shapex <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> item<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token comment"># 如果是最后一个卷积层输出，需要展平后才可以送入全连接层</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> item<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    <span class="token keyword">if</span> item_shapex <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token comment"># 查看卷积和全连接层的数据和参数的形状，</span>
        <span class="token comment"># 其中item.parameters()[0]是权重参数w，item.parameters()[1]是偏置参数b</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> parameter<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">,</span> parameter<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 汇聚层没有参数</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</code></pre> 
<p><strong>结果：</strong><br> <img src="https://images2.imgbox.com/eb/b0/msSei1wg_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="5324__236"></a>5.3.2.4 测试两个网络的运算速度。</h4> 
<p>测试两个网络的运算速度的代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> time

<span class="token comment"># 这里用np.random创建一个随机数组作为测试数据</span>
inputs <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
inputs <span class="token operator">=</span> inputs<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>

<span class="token comment"># 创建Model_LeNet类的实例，指定模型名称和分类的类别数目</span>
model <span class="token operator">=</span> Model_LeNet<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment"># 创建Torch_LeNet类的实例，指定模型名称和分类的类别数目</span>
torch_model <span class="token operator">=</span> Torch_LeNet<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment"># 计算Model_LeNet类的运算速度</span>
model_time <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    strat_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    out <span class="token operator">=</span> model<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 预热10次运算，不计入最终速度统计</span>
    <span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    model_time <span class="token operator">+=</span> <span class="token punctuation">(</span>end_time <span class="token operator">-</span> strat_time<span class="token punctuation">)</span>
avg_model_time <span class="token operator">=</span> model_time <span class="token operator">/</span> <span class="token number">50</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Model_LeNet speed:'</span><span class="token punctuation">,</span> avg_model_time<span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">)</span>
<span class="token comment"># 计算Torch_LeNet类的运算速度</span>
torch_model_time <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    strat_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    torch_out <span class="token operator">=</span> torch_model<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 预热10次运算，不计入最终速度统计</span>
    <span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    torch_model_time <span class="token operator">+=</span> <span class="token punctuation">(</span>end_time <span class="token operator">-</span> strat_time<span class="token punctuation">)</span>
avg_torch_model_time <span class="token operator">=</span> torch_model_time <span class="token operator">/</span> <span class="token number">50</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Torch_LeNet speed:'</span><span class="token punctuation">,</span> avg_torch_model_time<span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">)</span>
</code></pre> 
<p>测试结果：<br> <img src="https://images2.imgbox.com/bd/82/k1pZQ0i0_o.png" alt="在这里插入图片描述"><br> 我们发现，自定义算子慢于torch算子，但是相差也不算很大，可以忽略不计，但是torch的性能表现确实比自定义算子的性能表现要好。</p> 
<h4><a id="5325__280"></a>5.3.2.5 测试两个网络的运算结果</h4> 
<p>令两个网络加载同样的权重，测试一下两个网络的输出结果是否一致。</p> 
<pre><code class="prism language-python"><span class="token comment"># 这里用np.random创建一个随机数组作为测试数据</span>
inputs <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
inputs <span class="token operator">=</span> inputs<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>

<span class="token comment"># 创建Model_LeNet类的实例，指定模型名称和分类的类别数目</span>
model <span class="token operator">=</span> Model_LeNet<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment"># 获取网络的权重</span>
params <span class="token operator">=</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 自定义Conv2D算子的bias参数形状为[out_channels, 1]</span>
<span class="token comment"># torch API中Conv2D算子的bias参数形状为[out_channels]</span>
<span class="token comment"># 需要进行调整后才可以赋值</span>
<span class="token keyword">for</span> key <span class="token keyword">in</span> params<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'bias'</span> <span class="token keyword">in</span> key<span class="token punctuation">:</span>
        params<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 创建Torch_LeNet类的实例，指定模型名称和分类的类别数目</span>
torch_model <span class="token operator">=</span> Torch_LeNet<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment"># 将Model_LeNet的权重参数赋予给Torch_LeNet模型，保持两者一致</span>
torch_model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>params<span class="token punctuation">)</span>

<span class="token comment"># 打印结果保留小数点后6位</span>
torch<span class="token punctuation">.</span>set_printoptions<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
<span class="token comment"># 计算Model_LeNet的结果</span>
output <span class="token operator">=</span> model<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Model_LeNet output: '</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span>
<span class="token comment"># 计算Torch_LeNet的结果</span>
torch_output <span class="token operator">=</span> torch_model<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Torch_LeNet output: '</span><span class="token punctuation">,</span> torch_output<span class="token punctuation">)</span>

</code></pre> 
<p>运算结果比较：<br> <img src="https://images2.imgbox.com/0f/74/KgUay1L0_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="5326_LeNet5_317"></a>5.3.2.6 统计LeNet-5模型的参数量和计算量。</h4> 
<p>我们使用torchsummary统计参数量和计算量：<br> 代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> torchsummary <span class="token keyword">import</span> summary
model <span class="token operator">=</span> Torch_LeNet<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
params_info <span class="token operator">=</span> summary<span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>params_info<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/4e/19/hkgWw0gq_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="5327_paddleFloatstorch_330"></a>5.3.2.7 paddle可以统计Floats,torch可以吗？</h4> 
<p>在飞桨中，还可以使用paddle.flopsAPI自动统计计算量。pytorch可以么？<br> <strong>回答</strong>：可以，在torch中，我们可以使用torchstat统计计算量。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> torchstat <span class="token keyword">import</span> stat
<span class="token comment"># 导入模型，输入一张输入图片的尺寸</span>
stat<span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>结果展示：</strong><br> <img src="https://images2.imgbox.com/c9/3c/Aze7DPgI_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="533__341"></a>5.3.3 模型训练</h3> 
<p>使用交叉熵损失函数，并用随机梯度下降法作为优化器来训练LeNet-5网络。<br> 用RunnerV3在训练集上训练5个epoch，并保存准确率最高的模型作为最佳模型。<br> 我们选择训练6个epoch，然后给出RunnerV3和Accuracy的code:</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">RunnerV3</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> loss_fn<span class="token punctuation">,</span> metric<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>model <span class="token operator">=</span> model
        self<span class="token punctuation">.</span>optimizer <span class="token operator">=</span> optimizer
        self<span class="token punctuation">.</span>loss_fn <span class="token operator">=</span> loss_fn
        self<span class="token punctuation">.</span>metric <span class="token operator">=</span> metric  <span class="token comment"># 只用于计算评价指标</span>

        <span class="token comment"># 记录训练过程中的评价指标变化情况</span>
        self<span class="token punctuation">.</span>dev_scores <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token comment"># 记录训练过程中的损失函数变化情况</span>
        self<span class="token punctuation">.</span>train_epoch_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 一个epoch记录一次loss</span>
        self<span class="token punctuation">.</span>train_step_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 一个step记录一次loss</span>
        self<span class="token punctuation">.</span>dev_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token comment"># 记录全局最优指标</span>
        self<span class="token punctuation">.</span>best_score <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> train_loader<span class="token punctuation">,</span> dev_loader<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 将模型切换为训练模式</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 传入训练轮数，如果没有传入值则默认为0</span>
        num_epochs <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"num_epochs"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># 传入log打印频率，如果没有传入值则默认为100</span>
        log_steps <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"log_steps"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token comment"># 评价频率</span>
        eval_steps <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"eval_steps"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment"># 传入模型保存路径，如果没有传入值则默认为"best_model.pdparams"</span>
        save_path <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"save_path"</span><span class="token punctuation">,</span> <span class="token string">"best_model.pdparams"</span><span class="token punctuation">)</span>

        custom_print_log <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"custom_print_log"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>

        <span class="token comment"># 训练总的步数</span>
        num_training_steps <span class="token operator">=</span> num_epochs <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span>

        <span class="token keyword">if</span> eval_steps<span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>metric <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">'Error: Metric can not be None!'</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> dev_loader <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">'Error: dev_loader can not be None!'</span><span class="token punctuation">)</span>

        <span class="token comment"># 运行的step数目</span>
        global_step <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token comment"># 进行num_epochs轮训练</span>
        <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 用于统计训练集的损失</span>
            total_loss <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">for</span> step<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
                X<span class="token punctuation">,</span> y <span class="token operator">=</span> data
                <span class="token comment"># 获取模型预测</span>
                logits <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
                loss <span class="token operator">=</span> self<span class="token punctuation">.</span>loss_fn<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> y<span class="token punctuation">)</span>  <span class="token comment"># 默认求mean</span>
                total_loss <span class="token operator">+=</span> loss

                <span class="token comment"># 训练过程中，每个step的loss进行保存</span>
                self<span class="token punctuation">.</span>train_step_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>global_step<span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                <span class="token keyword">if</span> log_steps <span class="token keyword">and</span> global_step <span class="token operator">%</span> log_steps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span>
                        <span class="token string-interpolation"><span class="token string">f"[Train] epoch: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>num_epochs<span class="token punctuation">}</span></span><span class="token string">, step: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>global_step<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>num_training_steps<span class="token punctuation">}</span></span><span class="token string">, loss: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.5f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

                <span class="token comment"># 梯度反向传播，计算每个参数的梯度值</span>
                loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token keyword">if</span> custom_print_log<span class="token punctuation">:</span>
                    custom_print_log<span class="token punctuation">(</span>self<span class="token punctuation">)</span>

                <span class="token comment"># 小批量梯度下降进行参数更新</span>
                self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># 梯度归零</span>
                optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token comment"># 判断是否需要评价</span>
                <span class="token keyword">if</span> eval_steps <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> global_step <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> \
                        <span class="token punctuation">(</span>global_step <span class="token operator">%</span> eval_steps <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> global_step <span class="token operator">==</span> <span class="token punctuation">(</span>num_training_steps <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

                    dev_score<span class="token punctuation">,</span> dev_loss <span class="token operator">=</span> self<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>dev_loader<span class="token punctuation">,</span> global_step<span class="token operator">=</span>global_step<span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[Evaluate]  dev score: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>dev_score<span class="token punctuation">:</span><span class="token format-spec">.5f</span><span class="token punctuation">}</span></span><span class="token string">, dev loss: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>dev_loss<span class="token punctuation">:</span><span class="token format-spec">.5f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

                    <span class="token comment"># 将模型切换为训练模式</span>
                    self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>

                    <span class="token comment"># 如果当前指标为最优指标，保存该模型</span>
                    <span class="token keyword">if</span> dev_score <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>best_score<span class="token punctuation">:</span>
                        self<span class="token punctuation">.</span>save_model<span class="token punctuation">(</span>save_path<span class="token punctuation">)</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span>
                            <span class="token string-interpolation"><span class="token string">f"[Evaluate] best accuracy performence has been updated: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>best_score<span class="token punctuation">:</span><span class="token format-spec">.5f</span><span class="token punctuation">}</span></span><span class="token string"> --&gt; </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>dev_score<span class="token punctuation">:</span><span class="token format-spec">.5f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                        self<span class="token punctuation">.</span>best_score <span class="token operator">=</span> dev_score

                global_step <span class="token operator">+=</span> <span class="token number">1</span>

            <span class="token comment"># 当前epoch 训练loss累计值</span>
            trn_loss <span class="token operator">=</span> <span class="token punctuation">(</span>total_loss <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># epoch粒度的训练loss保存</span>
            self<span class="token punctuation">.</span>train_epoch_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>trn_loss<span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[Train] Training done!"</span><span class="token punctuation">)</span>

    <span class="token comment"># 模型评估阶段，使用'paddle.no_grad()'控制不计算和存储梯度</span>
    <span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>no_grad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dev_loader<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> self<span class="token punctuation">.</span>metric <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>

        <span class="token comment"># 将模型设置为评估模式</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        global_step <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"global_step"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># 用于统计训练集的损失</span>
        total_loss <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token comment"># 重置评价</span>
        self<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 遍历验证集每个批次</span>
        <span class="token keyword">for</span> batch_id<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dev_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            X<span class="token punctuation">,</span> y <span class="token operator">=</span> data

            <span class="token comment"># 计算模型输出</span>
            logits <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>X<span class="token punctuation">)</span>

            <span class="token comment"># 计算损失函数</span>
            loss <span class="token operator">=</span> self<span class="token punctuation">.</span>loss_fn<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 累积损失</span>
            total_loss <span class="token operator">+=</span> loss

            <span class="token comment"># 累积评价</span>
            self<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>update<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> y<span class="token punctuation">)</span>

        dev_loss <span class="token operator">=</span> <span class="token punctuation">(</span>total_loss <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dev_loader<span class="token punctuation">)</span><span class="token punctuation">)</span>
        dev_score <span class="token operator">=</span> self<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>accumulate<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 记录验证集loss</span>
        <span class="token keyword">if</span> global_step <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>dev_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>global_step<span class="token punctuation">,</span> dev_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>dev_scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dev_score<span class="token punctuation">)</span>

        <span class="token keyword">return</span> dev_score<span class="token punctuation">,</span> dev_loss

    <span class="token comment"># 模型评估阶段，使用'paddle.no_grad()'控制不计算和存储梯度</span>
    <span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>no_grad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 将模型设置为评估模式</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 运行模型前向计算，得到预测值</span>
        logits <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> logits

    <span class="token keyword">def</span> <span class="token function">save_model</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> save_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> save_path<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">load_model</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        state_dict <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>state_dict<span class="token punctuation">)</span>
<span class="token keyword">import</span> torch
<span class="token comment">#新增准确率计算函数</span>
<span class="token keyword">def</span> <span class="token function">accuracy</span><span class="token punctuation">(</span>preds<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    输入：
        - preds：预测值，二分类时，shape=[N, 1]，N为样本数量，多分类时，shape=[N, C]，C为类别数量
        - labels：真实标签，shape=[N, 1]
    输出：
        - 准确率：shape=[1]
    """</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>preds<span class="token punctuation">)</span>
    <span class="token comment"># 判断是二分类任务还是多分类任务，preds.shape[1]=1时为二分类任务，preds.shape[1]&gt;1时为多分类任务</span>
    <span class="token keyword">if</span> preds<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token comment"># 二分类时，判断每个概率值是否大于0.5，当大于0.5时，类别为1，否则类别为0</span>
        <span class="token comment"># 使用'torch.can_cast'将preds的数据类型转换为float32类型</span>
        preds <span class="token operator">=</span> torch<span class="token punctuation">.</span>can_cast<span class="token punctuation">(</span><span class="token punctuation">(</span>preds<span class="token operator">&gt;=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dtype<span class="token punctuation">,</span>to<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 多分类时，使用'torch.argmax'计算最大元素索引作为类别</span>
        preds <span class="token operator">=</span> torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>preds<span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>can_cast<span class="token punctuation">(</span>preds<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span>torch<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">(</span>preds <span class="token operator">==</span> labels<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Accuracy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        输入：
           - is_logist: outputs是logist还是激活后的值
        """</span>

        <span class="token comment"># 用于统计正确的样本个数</span>
        self<span class="token punctuation">.</span>num_correct <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment"># 用于统计样本的总数</span>
        self<span class="token punctuation">.</span>num_count <span class="token operator">=</span> <span class="token number">0</span>

        self<span class="token punctuation">.</span>is_logist <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        输入：
           - outputs: 预测值, shape=[N,class_num]
           - labels: 标签值, shape=[N,1]
        """</span>

        <span class="token comment"># 判断是二分类任务还是多分类任务，shape[1]=1时为二分类任务，shape[1]&gt;1时为多分类任务</span>
        <span class="token keyword">if</span> outputs<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token comment"># 二分类</span>
            outputs <span class="token operator">=</span> torch<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>is_logist<span class="token punctuation">:</span>
                <span class="token comment"># logist判断是否大于0</span>
                preds <span class="token operator">=</span> torch<span class="token punctuation">.</span>can_cast<span class="token punctuation">(</span><span class="token punctuation">(</span>outputs<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment"># 如果不是logist，判断每个概率值是否大于0.5，当大于0.5时，类别为1，否则类别为0</span>
                preds <span class="token operator">=</span> torch<span class="token punctuation">.</span>can_cast<span class="token punctuation">(</span><span class="token punctuation">(</span>outputs<span class="token operator">&gt;=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 多分类时，使用'paddle.argmax'计算最大元素索引作为类别</span>
            preds <span class="token operator">=</span> torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 获取本批数据中预测正确的样本个数</span>
        labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        batch_correct <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>preds <span class="token operator">==</span> labels<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        batch_count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>labels<span class="token punctuation">)</span>

        <span class="token comment"># 更新num_correct 和 num_count</span>
        self<span class="token punctuation">.</span>num_correct <span class="token operator">+=</span> batch_correct
        self<span class="token punctuation">.</span>num_count <span class="token operator">+=</span> batch_count

    <span class="token keyword">def</span> <span class="token function">accumulate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 使用累计的数据，计算总的指标</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>num_count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">0</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>num_correct <span class="token operator">/</span> self<span class="token punctuation">.</span>num_count

    <span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 重置正确的数目和总数</span>
        self<span class="token punctuation">.</span>num_correct <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>num_count <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">name</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"Accuracy"</span>
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> opti
<span class="token comment"># 学习率大小</span>
lr <span class="token operator">=</span> <span class="token number">0.1</span>
<span class="token comment"># 批次大小</span>
batch_size <span class="token operator">=</span> <span class="token number">64</span>
<span class="token comment"># 加载数据</span>
train_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
dev_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>dev_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">)</span>
test_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>test_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">)</span>
<span class="token comment"># 定义LeNet网络</span>
<span class="token comment"># 自定义算子实现的LeNet-5</span>
model <span class="token operator">=</span> Model_LeNet<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment"># 飞桨API实现的LeNet-5</span>
<span class="token comment"># model = Paddle_LeNet(in_channels=1, num_classes=10)</span>
<span class="token comment"># 定义优化器</span>
optimizer <span class="token operator">=</span> opti<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span>
<span class="token comment"># 定义损失函数</span>
loss_fn <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy
<span class="token comment"># 定义评价指标</span>
metric <span class="token operator">=</span> Accuracy<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 实例化 RunnerV3 类，并传入训练配置。</span>
runner <span class="token operator">=</span> RunnerV3<span class="token punctuation">(</span>model<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> loss_fn<span class="token punctuation">,</span> metric<span class="token punctuation">)</span>
<span class="token comment"># 启动训练</span>
log_steps <span class="token operator">=</span> <span class="token number">15</span>
eval_steps <span class="token operator">=</span> <span class="token number">15</span>
runner<span class="token punctuation">.</span>train<span class="token punctuation">(</span>train_loader<span class="token punctuation">,</span> dev_loader<span class="token punctuation">,</span> num_epochs<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> log_steps<span class="token operator">=</span>log_steps<span class="token punctuation">,</span>
                eval_steps<span class="token operator">=</span>eval_steps<span class="token punctuation">,</span> save_path<span class="token operator">=</span><span class="token string">"best_model.pdparams"</span><span class="token punctuation">)</span>

</code></pre> 
<p>结果展示：<br> [Train] epoch: 0/6, step: 0/282, loss: 2.29864<br> [Train] epoch: 0/6, step: 15/282, loss: 2.23512<br> [Evaluate] dev score: 0.35000, dev loss: 2.22403<br> [Evaluate] best accuracy performence has been updated: 0.00000 --&gt; 0.35000<br> :60: UserWarning: To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).<br> batch_correct = torch.sum(torch.tensor(preds == labels, dtype=torch.float32)).numpy()<br> [Train] epoch: 0/6, step: 30/282, loss: 2.26119<br> [Evaluate] dev score: 0.09000, dev loss: 2.31535<br> [Train] epoch: 0/6, step: 45/282, loss: 1.87482<br> [Evaluate] dev score: 0.31500, dev loss: 1.96644<br> [Train] epoch: 1/6, step: 60/282, loss: 1.49791<br> [Evaluate] dev score: 0.32500, dev loss: 1.90903<br> [Train] epoch: 1/6, step: 75/282, loss: 1.08951<br> [Evaluate] dev score: 0.43000, dev loss: 1.97639<br> [Evaluate] best accuracy performence has been updated: 0.35000 --&gt; 0.43000<br> [Train] epoch: 1/6, step: 90/282, loss: 0.72709<br> [Evaluate] dev score: 0.72000, dev loss: 0.62929<br> [Evaluate] best accuracy performence has been updated: 0.43000 --&gt; 0.72000<br> [Train] epoch: 2/6, step: 105/282, loss: 1.01030<br> [Evaluate] dev score: 0.58000, dev loss: 1.11268<br> [Train] epoch: 2/6, step: 120/282, loss: 0.30258<br> [Evaluate] dev score: 0.84000, dev loss: 0.36762<br> [Evaluate] best accuracy performence has been updated: 0.72000 --&gt; 0.84000<br> [Train] epoch: 2/6, step: 135/282, loss: 0.27759<br> [Evaluate] dev score: 0.87500, dev loss: 0.38257<br> [Evaluate] best accuracy performence has been updated: 0.84000 --&gt; 0.87500<br> [Train] epoch: 3/6, step: 150/282, loss: 0.37689<br> [Evaluate] dev score: 0.81500, dev loss: 0.50451<br> [Train] epoch: 3/6, step: 165/282, loss: 0.39598<br> [Evaluate] dev score: 0.90500, dev loss: 0.26139<br> [Evaluate] best accuracy performence has been updated: 0.87500 --&gt; 0.90500<br> [Train] epoch: 3/6, step: 180/282, loss: 0.20255<br> [Evaluate] dev score: 0.89500, dev loss: 0.26024<br> [Train] epoch: 4/6, step: 195/282, loss: 0.08575<br> [Evaluate] dev score: 0.92000, dev loss: 0.16601<br> [Evaluate] best accuracy performence has been updated: 0.90500 --&gt; 0.92000<br> [Train] epoch: 4/6, step: 210/282, loss: 0.16293<br> [Evaluate] dev score: 0.95000, dev loss: 0.14370<br> [Evaluate] best accuracy performence has been updated: 0.92000 --&gt; 0.95000<br> [Train] epoch: 4/6, step: 225/282, loss: 0.20410<br> [Evaluate] dev score: 0.95000, dev loss: 0.14841<br> [Train] epoch: 5/6, step: 240/282, loss: 0.09400<br> [Evaluate] dev score: 0.94000, dev loss: 0.15105<br> [Train] epoch: 5/6, step: 255/282, loss: 0.30644<br> [Evaluate] dev score: 0.96000, dev loss: 0.17032<br> [Evaluate] best accuracy performence has been updated: 0.95000 --&gt; 0.96000<br> [Train] epoch: 5/6, step: 270/282, loss: 0.20965<br> [Evaluate] dev score: 0.87500, dev loss: 0.31949<br> [Evaluate] dev score: 0.94000, dev loss: 0.12479<br> [Train] Training done!<br> <img src="https://images2.imgbox.com/cb/79/h9XK8rg9_o.png" alt="在这里插入图片描述"><br> 可以看出的是，最好的精确度performence展示已经达到了96%，在验证集上的准确度也达到了94%，取得了不错的效果。</p> 
<h3><a id="534__665"></a>5.3.4 模型评价</h3> 
<p>我们看一下训练过程中的误差变化和精确率变化：</p> 
<pre><code class="prism language-python"><span class="token comment">#可视化误差</span>
<span class="token keyword">def</span> <span class="token function">plot</span><span class="token punctuation">(</span>runner<span class="token punctuation">,</span> fig_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
    train_items <span class="token operator">=</span> runner<span class="token punctuation">.</span>train_step_losses<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">30</span><span class="token punctuation">]</span>
    train_steps<span class="token operator">=</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> train_items<span class="token punctuation">]</span>
    train_losses <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> train_items<span class="token punctuation">]</span>

    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>train_steps<span class="token punctuation">,</span> train_losses<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'#8E004D'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Train loss"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> runner<span class="token punctuation">.</span>dev_losses<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        dev_steps<span class="token operator">=</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> runner<span class="token punctuation">.</span>dev_losses<span class="token punctuation">]</span>
        dev_losses <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> runner<span class="token punctuation">.</span>dev_losses<span class="token punctuation">]</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>dev_steps<span class="token punctuation">,</span> dev_losses<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'#E20079'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Dev loss"</span><span class="token punctuation">)</span>
    <span class="token comment">#绘制坐标轴和图例</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"loss"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token string">'x-large'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"step"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token string">'x-large'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'upper right'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token string">'x-large'</span><span class="token punctuation">)</span>
    
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment">#绘制评价准确率变化曲线</span>
    <span class="token keyword">if</span> runner<span class="token punctuation">.</span>dev_losses<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>dev_steps<span class="token punctuation">,</span> runner<span class="token punctuation">.</span>dev_scores<span class="token punctuation">,</span> 
            color<span class="token operator">=</span><span class="token string">'#E20079'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">"--"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Dev accuracy"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>dev_scores<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> runner<span class="token punctuation">.</span>dev_scores<span class="token punctuation">,</span> 
            color<span class="token operator">=</span><span class="token string">'#E20079'</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">"--"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Dev accuracy"</span><span class="token punctuation">)</span>
    <span class="token comment">#绘制坐标轴和图例</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token string">'x-large'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"step"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token string">'x-large'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'lower right'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token string">'x-large'</span><span class="token punctuation">)</span>
    
    plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>fig_name<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
runner<span class="token punctuation">.</span>load_model<span class="token punctuation">(</span><span class="token string">'best_model.pdparams'</span><span class="token punctuation">)</span>
plot<span class="token punctuation">(</span>runner<span class="token punctuation">,</span> <span class="token string">'cnn-loss1.pdf'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>可视化结果：</strong><br> <img src="https://images2.imgbox.com/aa/e1/ErUn5d3k_o.png" alt="在这里插入图片描述"><br> <strong>测试准确率：</strong></p> 
<pre><code class="prism language-python"><span class="token comment"># 加载最优模型</span>
runner<span class="token punctuation">.</span>load_model<span class="token punctuation">(</span><span class="token string">'best_model.pdparams'</span><span class="token punctuation">)</span>
<span class="token comment"># 模型评价</span>
score<span class="token punctuation">,</span> loss <span class="token operator">=</span> runner<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>test_loader<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[Test] accuracy/loss: {:.4f}/{:.4f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/de/e3/QyvYV5zJ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="535__718"></a>5.3.5 模型预测</h3> 
<pre><code class="prism language-python"><span class="token comment"># 获取测试集中第一条数</span>
X<span class="token punctuation">,</span> label <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>test_loader<span class="token punctuation">)</span><span class="token punctuation">)</span>
logits <span class="token operator">=</span> runner<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
<span class="token comment"># 多分类，使用softmax计算预测概率</span>
pred <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>logits<span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>pred<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token comment"># 获取概率最大的类别</span>
pred_class <span class="token operator">=</span> torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>pred<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>pred_class<span class="token punctuation">)</span>
label <span class="token operator">=</span> label<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 输出真实类别与预测类别</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"The true category is {} and the predicted category is {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> pred_class<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 可视化图片</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
image<span class="token punctuation">,</span> label <span class="token operator">=</span> test_set<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> test_set<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
image<span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
image <span class="token operator">=</span> np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
image <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>image<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'uint8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'L'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'cnn-number2.pdf'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>实现结果：</strong><br> <img src="https://images2.imgbox.com/21/d3/oF4fh54S_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="MNISTLeNet_745"></a>使用前馈神经网络实现MNIST识别，与LeNet效果对比。（选做）</h2> 
<p>使用前馈神经网络实现MNIST识别代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> torchvision <span class="token keyword">import</span> datasets<span class="token punctuation">,</span>transforms
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> torchvision
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
transformation <span class="token operator">=</span>transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#转换到Tensor，并且转换为0-1之间,将channel 放到第一个纬度</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
train_ds <span class="token operator">=</span> datasets<span class="token punctuation">.</span>MNIST<span class="token punctuation">(</span><span class="token string">'data/'</span><span class="token punctuation">,</span>train <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>transform <span class="token operator">=</span> transformation<span class="token punctuation">,</span>download <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
test_ds <span class="token operator">=</span> datasets<span class="token punctuation">.</span>MNIST<span class="token punctuation">(</span><span class="token string">'data/'</span><span class="token punctuation">,</span>train <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>transform <span class="token operator">=</span> transformation<span class="token punctuation">,</span>download <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># len(train_ds)</span>
<span class="token comment"># len(test_ds)</span>
train_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_ds<span class="token punctuation">,</span>batch_size <span class="token operator">=</span><span class="token number">64</span> <span class="token punctuation">,</span>shuffle <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>num_workers <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">)</span>
test_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>test_ds<span class="token punctuation">,</span>batch_size <span class="token operator">=</span><span class="token number">256</span> <span class="token punctuation">,</span>shuffle <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>num_workers <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Model</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>linear1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">28</span><span class="token operator">*</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>linear2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>linear3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token operator">*</span><span class="token number">28</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>linear1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>linear2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        y <span class="token operator">=</span> self<span class="token punctuation">.</span>linear3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> y
model <span class="token operator">=</span> Model<span class="token punctuation">(</span><span class="token punctuation">)</span>
loss_fn  <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">accuracy</span><span class="token punctuation">(</span>y_pred<span class="token punctuation">,</span>y_true<span class="token punctuation">)</span><span class="token punctuation">:</span>
    y_pred <span class="token operator">=</span> torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>y_pred<span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    acc <span class="token operator">=</span> <span class="token punctuation">(</span>y_pred<span class="token operator">==</span>y_true<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> acc
<span class="token comment">#测试集</span>
<span class="token keyword">def</span> <span class="token function">evaluate_testset</span><span class="token punctuation">(</span>data_loader<span class="token punctuation">,</span>model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    acc_sum<span class="token punctuation">,</span>loss_sum<span class="token punctuation">,</span>total_example <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0</span>
    <span class="token keyword">for</span> x<span class="token punctuation">,</span>y <span class="token keyword">in</span> data_loader<span class="token punctuation">:</span>
        y_hat <span class="token operator">=</span> model<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        acc_sum <span class="token operator">+=</span> <span class="token punctuation">(</span>y_hat<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        loss <span class="token operator">=</span> loss_fn<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span>y<span class="token punctuation">)</span> 
        loss_sum <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        total_example<span class="token operator">+=</span>y<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> acc_sum<span class="token operator">/</span>total_example<span class="token punctuation">,</span>loss_sum
<span class="token comment">#定义模型训练函数</span>
<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span>train_loader<span class="token punctuation">,</span>test_loader<span class="token punctuation">,</span>loss<span class="token punctuation">,</span>num_epochs<span class="token punctuation">,</span>batch_size<span class="token punctuation">,</span>params<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>lr<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>optimizer<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    train_ls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    test_ls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 训练模型一共需要num_epochs个迭代周期</span>
        train_loss_sum<span class="token punctuation">,</span> train_acc_num<span class="token punctuation">,</span>total_examples <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0</span>
        <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> train_loader<span class="token punctuation">:</span> <span class="token comment"># x和y分别是小批量样本的特征和标签</span>
            y_pred <span class="token operator">=</span> model<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> loss_fn<span class="token punctuation">(</span>y_pred<span class="token punctuation">,</span> y<span class="token punctuation">)</span>  <span class="token comment">#计算损失</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 梯度清零</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 反向传播</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#梯度更新</span>
            total_examples <span class="token operator">+=</span> y<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            train_loss_sum <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            train_acc_num <span class="token operator">+=</span> <span class="token punctuation">(</span>y_pred<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        train_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_loss_sum<span class="token punctuation">)</span>
        test_acc<span class="token punctuation">,</span>test_loss <span class="token operator">=</span> evaluate_testset<span class="token punctuation">(</span>test_loader<span class="token punctuation">,</span>model<span class="token punctuation">)</span>
        test_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>test_loss<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'epoch %d, train_loss %.6f,test_loss %f,train_acc %.6f,test_acc %.6f'</span><span class="token operator">%</span><span class="token punctuation">(</span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> train_ls<span class="token punctuation">[</span>epoch<span class="token punctuation">]</span><span class="token punctuation">,</span>test_ls<span class="token punctuation">[</span>epoch<span class="token punctuation">]</span><span class="token punctuation">,</span>train_acc_num<span class="token operator">/</span>total_examples<span class="token punctuation">,</span>test_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
num_epoch  <span class="token operator">=</span> <span class="token number">20</span>
batch_size <span class="token operator">=</span> <span class="token number">64</span>
train<span class="token punctuation">(</span>model<span class="token punctuation">,</span>train_loader<span class="token punctuation">,</span>test_loader<span class="token punctuation">,</span>loss_fn<span class="token punctuation">,</span>num_epoch<span class="token punctuation">,</span>batch_size<span class="token punctuation">,</span>params<span class="token operator">=</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">,</span>lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span>optimizer<span class="token operator">=</span>optimizer<span class="token punctuation">)</span>

</code></pre> 
<p>训练结果示意：<br> <img src="https://images2.imgbox.com/7c/56/aFZSDHSC_o.png" alt="在这里插入图片描述"><br> <strong>参数量的对比：</strong><br> <img src="https://images2.imgbox.com/72/88/nP5i7kyJ_o.png" alt="在这里插入图片描述"><br> 对比结果发现，卷积神经网络的参数量只有6w，而前馈神经网络却有10w+的参数量，虽然前馈神经网络展现的性能比卷积神经网络好（也可能是因为我卷积神经网络的训练次数太少，具体再高的准确率大家可以自己尝试对比一下），但其5%的准确率却需要再加一倍的性能，这显然展现了卷积神经网络的优点，下面我们来对比一下浮点运算数：<br> <img src="https://images2.imgbox.com/d8/83/m03MaD58_o.png" alt="在这里插入图片描述"><br> 我们得到的结果是卷积神经网络的计算量&gt;前馈神经网络的计算量，但是为什么会这样呢？我查找了很多资料，各大博客和视频，没有找到具体相关的解释，我的理解是虽然卷积神经网络的参数量少于亲前馈神经网络，但是由于其层数的增多，导致计算量不可避免的增加，但是同等性能下，卷积神经网络肯定是优于前馈神经网络的。</p> 
<h2><a id="LeNet_827"></a>可视化LeNet中的部分特征图和卷积核，谈谈自己的看法。（选做）</h2> 
<p>C1：卷积层+激活函数<br> <img src="https://images2.imgbox.com/bd/38/VWlvbJsS_o.png" alt="在这里插入图片描述"><br> S2：汇聚层<br> <img src="https://images2.imgbox.com/64/88/vy9GZh0x_o.png" alt="在这里插入图片描述"><br> C3：卷积层+激活函数<br> <img src="https://images2.imgbox.com/e1/5c/Fp9knuoQ_o.png" alt="在这里插入图片描述"><br> S4：汇聚层<br> <img src="https://images2.imgbox.com/32/a0/FjXbfE8l_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h2><a id="_839"></a>总结</h2> 
<p>今天基于torch使用Lenet实现手写数字识别，实验也写了好久，也和别人探讨了一些准确率低的问题所在，在只更改邱老师的paddle代码的时候，经常会出来准确率为10%的问题，也就是10张图片瞎猜一张的准确率，如下图：<br> <img src="https://images2.imgbox.com/1b/5f/Uk6QLPL4_o.png" alt="在这里插入图片描述"><br> 在探讨问题的过程中，<strong>一开始我认为是学习率的影响因素</strong>，将学习率设置为0.1、0.2、1、2、5、10、20等发现准确率只提高了5个百分点，甚至只提升一个百分点，和别人探讨的过程中，我们发现在torch中，<strong>transform.Normalize的参数过大</strong>，Normalize是对数据做标准化处理的，如果参数设置为175.5和175.5的话，会导致均值处在175.5，方差在175.5内，由于我们<strong>使用的图片在transforms.ToTensor处理后，值均位于0-1之间</strong>，这就解释了为什么这个参数对于卷积神经网络的结果影响之大，顺便提一句，在Normalize中，<strong>均值反映了图像的亮度，均值越大说明图像亮度越大，反之越小；标准差反映了图像像素值与均值的离散程度，标准差越大说明图像的质量越好；</strong> 我们重新修改为mean = 0.5 和std = 0.5 才得到了这个94%的准确率，至于为什么没有到99%，大家可以自己尝试学习率的更改，我这里得到了一个差不多的准确率就没再调参，大家想要得到99%的准确率可以调这个代码的lr试一下，在这里哦~(模型训练5.3.3这一行，我设置的是0.2)：<br> <img src="https://images2.imgbox.com/ae/5a/g6sfkCXi_o.png" alt="在这里插入图片描述"><br> 这就是今天的全部内容了。</p> 
<h2><a id="Rerferences_847"></a>Rerferences:</h2> 
<p><a rel="nofollow">前馈神经网络实现手写数字识别</a><br> <a href="https://blog.csdn.net/Cai_Xu_Kun/article/details/108718584">transforms.Normalize，计算数据量大数据集的像素均值（mean)和标准差（std)</a><br> <a href="https://www.cnblogs.com/hbuwyg/p/16617671.html" rel="nofollow">NNDL 实验5（上）</a><br> <a href="http://zh.d2l.ai/chapter_convolutional-neural-networks/index.html" rel="nofollow">卷积神经网络 — 动手学深度学习 2.0.0-beta1 documentation (d2l.ai)</a><br> 老师博客：<br> <a href="https://blog.csdn.net/qq_38975453/article/details/126799661?spm=1001.2014.3001.5502">NNDL 实验六 卷积神经网络（3）LeNet实现MNIST</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8ffa51be78daaa4a0bf23cdc423adf69/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C/C&#43;&#43;编程：protected的访问权限</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cf1c9f70f5d35804005b401c1560c13e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【educoder 机器学习】线性回归</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>