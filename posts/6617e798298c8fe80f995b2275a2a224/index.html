<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>wifihal的实现原理 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="wifihal的实现原理" />
<meta property="og:description" content="modified: make/target/product/base_system.mk　//这次添加JNI的时候，单边模块是可以生成的jni的库的，但是，整编就是不能生成．　最后，在这个MK文件中添加JNI的模块名，结果还是生成了的．
— a/make/target/product/base_system.mk
&#43;&#43;&#43; b/make/target/product/base_system.mk
@@ -273,6 &#43;273,7 @@ PRODUCT_PACKAGES &#43;= wificond wifi.rc wm \
libwifi-service \ ( w a r n i n g C F G T E E S U P P O R T = (warning CFG_TEE_SUPPORT= (warningCFGT​EES​UPPORT=(CFG_TEE_SUPPORT))　//在ＭＡＫＥＦＩＬＥ中添加ＬＯＧ
typedef enum {
WIFI_POWER_SCENARIO_INVALID = -2,
WIFI_POWER_SCENARIO_DEFAULT = -1,　//wifi_reset_tx_power_scenario
WIFI_POWER_SCENARIO_VOICE_CALL = 0,
WIFI_POWER_SCENARIO_ON_HEAD_CELL_OFF = 1,
WIFI_POWER_SCENARIO_ON_HEAD_CELL_ON = 2,
WIFI_POWER_SCENARIO_ON_BODY_CELL_OFF = 3,
WIFI_POWER_SCENARIO_ON_BODY_CELL_ON = 4," />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6617e798298c8fe80f995b2275a2a224/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-26T21:00:11+08:00" />
<meta property="article:modified_time" content="2021-08-26T21:00:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">wifihal的实现原理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>modified: make/target/product/base_system.mk　//这次添加JNI的时候，单边模块是可以生成的jni的库的，但是，整编就是不能生成．　最后，在这个MK文件中添加JNI的模块名，结果还是生成了的．<br> — a/make/target/product/base_system.mk<br> +++ b/make/target/product/base_system.mk<br> @@ -273,6 +273,7 @@ PRODUCT_PACKAGES += <br> wificond <br> wifi.rc <br> wm \</p> 
<ul><li>libwifi-service \</li></ul> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         w 
        
       
         a 
        
       
         r 
        
       
         n 
        
       
         i 
        
       
         n 
        
       
         g 
        
       
         C 
        
       
         F 
        
        
        
          G 
         
        
          T 
         
        
       
         E 
        
        
        
          E 
         
        
          S 
         
        
       
         U 
        
       
         P 
        
       
         P 
        
       
         O 
        
       
         R 
        
       
         T 
        
       
         = 
        
       
      
        (warning CFG_TEE_SUPPORT= 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">n</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mord mathdefault" style="margin-right: 0.07153em;">C</span><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right: 0.05764em;">E</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.05764em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right: 0.10903em;">U</span><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span><span class="mord mathdefault" style="margin-right: 0.02778em;">O</span><span class="mord mathdefault" style="margin-right: 0.00773em;">R</span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span></span></span></span></span>(CFG_TEE_SUPPORT))　　//在ＭＡＫＥＦＩＬＥ中添加ＬＯＧ</p> 
<p>typedef enum {<!-- --><br> WIFI_POWER_SCENARIO_INVALID = -2,<br> WIFI_POWER_SCENARIO_DEFAULT = -1,　//wifi_reset_tx_power_scenario<br> WIFI_POWER_SCENARIO_VOICE_CALL = 0,<br> WIFI_POWER_SCENARIO_ON_HEAD_CELL_OFF = 1,<br> WIFI_POWER_SCENARIO_ON_HEAD_CELL_ON = 2,<br> WIFI_POWER_SCENARIO_ON_BODY_CELL_OFF = 3,<br> WIFI_POWER_SCENARIO_ON_BODY_CELL_ON = 4,<br> WIFI_POWER_SCENARIO_ON_BODY_BT = 5,<br> } wifi_power_scenario;</p> 
<p>＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋<br> ＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋<br> /u614/android/vendor/mediatek/kernel_modules/connectivity/wlan/core/gen4m/os/linux/gl_init.c　//kernel的调用<br> TINNO_SYSTEM_PROPERTY_OVERRIDES += persist.tinno.sar=true</p> 
<pre><code>/* Set Tx Power Scenario */ //初始化命令CMD以及对应的回调函数
{
	{
		.vendor_id = GOOGLE_OUI,
		.subcmd = WIFI_SUBCMD_SELECT_TX_POWER_SCENARIO//CMD 命令
	},
	.flags = WIPHY_VENDOR_CMD_NEED_WDEV |
			WIPHY_VENDOR_CMD_NEED_NETDEV,
	.doit = mtk_cfg80211_vendor_set_tx_power_scenario //CMD 命令调用回调函数　在kernel里实现的＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋
</code></pre> 
<p>#if KERNEL_VERSION(5, 4, 0) &lt;= LINUX_VERSION_CODE<br> ,<br> .policy = VENDOR_CMD_RAW_DATA<br> #endif<br> },</p> 
<p>/u614/android/vendor/mediatek/proprietary/hardware/connectivity/wlan/wifi_hal/wifi_hal.cpp<br> class SelectTxPowerCommand : public WifiCommand {　//定义了一个SelectTxPowerCommand<br> private:<br> int mScenario;<br> public:<br> SelectTxPowerCommand(wifi_interface_handle handle, int scenario)<br> : WifiCommand(“SelectTxPowerCommand”, handle, 0) {<!-- --><br> mScenario = scenario;<br> }<br> virtual int create() {<!-- --><br> int ret;</p> 
<pre><code>      ret = mMsg.create(GOOGLE_OUI, WIFI_SUBCMD_SELECT_TX_POWER_SCENARIO);　//创建CMD 命令
      if (ret &lt; 0) {
           ALOGE("Can't create message to send to driver - %d", ret);
           return ret;
      }

      nlattr *data = mMsg.attr_start(NL80211_ATTR_VENDOR_DATA);
      if (!data) {
          ALOGE("Failed attr_start for VENDOR_DATA");
          return WIFI_ERROR_UNKNOWN;
      }

      ret = mMsg.put_u32(WIFI_ATTRIBUTE_TX_POWER_SCENARIO, mScenario);　//启动CMD 命令
      if (ret &lt; 0) {
          ALOGE("Failed to put TX_POWER_SCENARIO");
          return ret;
      }

      mMsg.attr_end(data);
      return WIFI_SUCCESS;
  }
</code></pre> 
<p>};</p> 
<p>/u614/android/vendor/mediatek/proprietary/hardware/connectivity/wlan/wifi_hal/wifi_hal.cpp　　//wifi_hal的调用<br> wifi_error wifi_select_tx_power_scenario(wifi_interface_handle handle,<br> wifi_power_scenario scenario)<br> {<!-- --><br> ALOGI(“Select tx power scenario %d”, scenario);<br> SelectTxPowerCommand command(handle, scenario);　//实例化了上面定义的类SelectTxPowerCommand　用于设置tx_power<br> return (wifi_error) command.requestResponse();<br> }<br> wifi_error wifi_reset_tx_power_scenario(wifi_interface_handle handle)<br> {<!-- --><br> ALOGI(“Reset tx power scenario”);<br> SelectTxPowerCommand command(handle, -1);　//实例化了上面定义的类SelectTxPowerCommand　用于恢复reset_tx_power<br> return (wifi_error) command.requestResponse();<br> }</p> 
<p>＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝</p> 
<p>/u614/android/hardware/interfaces/wifi/1.4/default/wifi_legacy_hal.cpp<br> wifi_error WifiLegacyHal::selectTxPowerScenario(const std::string&amp; iface_name,<br> wifi_power_scenario scenario) {　　//legacy_hal的调用<br> return global_func_table_.wifi_select_tx_power_scenario(<br> getIfaceHandle(iface_name), scenario);<br> }</p> 
<p>/u614/android/hardware/interfaces/wifi/1.4/default/wifi_chip.cpp<br> WifiStatus WifiChip::selectTxPowerScenarioInternal_1_2(<br> TxPowerScenario scenario) {<!-- --><br> LOG(DEBUG) &lt;&lt; “zgs 1.4-default-wifiChip-selectTxPowerScenarioInternal_1_2”;<br> auto legacy_status = legacy_hal_.lock()-&gt;selectTxPowerScenario(<br> getFirstActiveWlanIfaceName(),</p> 
<pre><code>    hidl_struct_util::convertHidlTxPowerScenarioToLegacy_1_2(scenario));　//将HIDL的调用转换为legacy_hal的调用
return createWifiStatusFromLegacyError(legacy_status);
</code></pre> 
<p>}<br> ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝<br> 我们应该用/u614/android/hardware/interfaces/wifi/1.4/default/　下面的mediatek的/u614/android/vendor/mediatek/proprietary/hardware/connectivity/wlan/wifi_hidl/1.3/wifi_legacy_hal.cpp是没有用的．但是，这里也说明了，　wifi_legacy_hal.cpp　这个文件是存在HIDL服务里的．　这个文件有WifiLegacyHal类的实例化，定义全局变量：global_func_table_．　通过init_wifi_vendor_hal_func_table(&amp;global_func_table_);　这个函数，将类型为wifi_hal_fn　（这个类型定义在wifi_hal.h中）的全局变量global_func_table_　和实际用的wifi_hal.cpp　联系起来．wifi_hal_fn　定义了wifi_hal的函数指针．这些指针最后指向了实际用的wifi_hal.cpp的函数实现．init_wifi_vendor_hal_func_table这个函数的实现是wifi_hal.cpp里的．　AOSP本身提供的init_wifi_vendor_hal_func_table这个函数的实现是在/frameworks/opt/net/wifi/libwifi_hal/wifi_hal_fallback.cpp这个文件中．并且，函数的实现只有一句话：return WIFI_ERROR_NOT_SUPPORTED;　同时，/frameworks/opt/net/wifi/libwifi_hal　这个目录就是指定当前系统用的LOCAL_MODULE := libwifi-hal　．　为了区别AOSP和MEDIATEK的wifi_hal，　在/android/frameworks/opt/net/wifi/libwifi_hal／Android.mk　这个文件中，通过指定LIB_WIFI_HAL := libwifi-hal-mt66xx　来选择对应的wifi_hal参入编译，最终生成libwifi-hal．　libwifi-hal最终是通过作为LOCAL_SHARED_LIBRARIES，参与生成android.hardware.wifi@1.0-service．　这个是在/hardware/interfaces/wifi/1.4/default/Android.mk　这文件中完成的．</p> 
<p>/u614/android/hardware/interfaces/wifi/1.4/default/<br> A D wifi_legacy_hal_stubs.cpp 137 populateStubFor(&amp;hal_fn-&gt;wifi_select_tx_power_scenario); in initHalFuncTableWithStubs()<br> A D wifi_legacy_hal.cpp 806 return global_func_table_.wifi_select_tx_power_scenario( in selectTxPowerScenario()<br> /u614/android/vendor/mediatek/proprietary/hardware/connectivity/wlan/wifi_hidl/1.3/<br> A D wifi_legacy_hal_stubs.cpp 137 populateStubFor(&amp;hal_fn-&gt;wifi_select_tx_power_scenario); in initHalFuncTableWithStubs()<br> A D wifi_legacy_hal.cpp 812 return global_func_table_.wifi_select_tx_power_scenario( in selectTxPowerScenario()<br> WifiLegacyHal类的实例化：<br> WifiLegacyHal::WifiLegacyHal(<br> const std::weak_ptr&lt;wifi_system::InterfaceTool&gt; iface_tool)<br> ｛｝<br> ＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋<br> ＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋＋</p> 
<p>android.bp 放在哪里都可以被识别．但是，在整个项目编译的时候，不一定会编译到，需要将这个模块添加到项目中．<br> broadcastReceiver 广播是谁注册了，谁接收．<br> NIC(Network Interface Card)或简称为网卡</p> 
<p>error: frameworks/base/services/core/Android.bp:93:13: unrecognized property “jni_libs” ? 生成的native库如何导入？<br> System.loadLibrary(“wifi-service”);　　//加载JNI的LIB库</p> 
<p>error: vendor/mediatek/proprietary/frameworks/opt/net/services/Android.bp:18:1: module “mediatek-framework-net” variant “android_common”: depends on //frameworks/opt/net/wifi/service:service-wifi which is not visible to this module<br> error: frameworks/opt/net/wifi/service/Android.bp:128:15: module “service-wifi”: visibility: “//vendor/mediatek/proprietary/frameworks/opt/net/services/core/java/com/android/server” is not allowed. Packages outside //vendor cannot make themselves visible to specific targets within //vendor, they can only use //vendor:<strong>subpackages</strong>.</p> 
<p>error: frameworks/base/services/core/Android.bp:75:1: module “services.core.unboosted” variant “android_common”: depends on //frameworks/opt/net/wifi/service:service-wifi which is not visible to this module</p> 
<p>/u614/android/frameworks/base/services/core/java/com/mediatek/server/display/MtkWifiDisplayController.java　　//java 反射的应用．<br> import java.lang.reflect.Field;<br> import java.lang.reflect.Method;<br> try {<!-- --><br> // Get WifiInjector<br> Method method = Class.forName(<br> “com.android.server.wifi.WifiInjector”, false,<br> this.getClass().getClassLoader()).getDeclaredMethod(“getInstance”);<br> method.setAccessible(true);<br> Object wi = method.invoke(null);<br> // Get WifiStatemachine</p> 
<pre><code>private void sendStickyBroadcastToAll(Intent intent) {
    intent.addFlags(Intent.FLAG_RECEIVER_FOREGROUND);
    final long ident = Binder.clearCallingIdentity();
    try {
        mContext.sendStickyBroadcastAsUser(intent, UserHandle.ALL);
    } finally {
        Binder.restoreCallingIdentity(ident);
    }
}
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/47b2b6f14df8a37635ae2c52fa9ad8f1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">谷歌8.0新版iframe嵌套跨域请求cookie丢失问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/aa504d109f53bb1fe262bbe2fb28bd44/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【数据结构笔记】数据结构基础—链表</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>