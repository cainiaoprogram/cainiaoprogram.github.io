<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>图像分割——meanshift算法（C&#43;&#43;&amp;GDAL库） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="图像分割——meanshift算法（C&#43;&#43;&amp;GDAL库）" />
<meta property="og:description" content="图像分割——meanshift算法（C&#43;&#43;&amp;GDAL库） 一、meanshift分割原理二、分割技术流程三、代码实例3.1 C&#43;&#43;&amp;GDAL库 实现3.2 分割结果3.3 结果分析 一、meanshift分割原理 Mean-Shift是一种非参数化的多模型分割方法，它的基本计算模块采用的是传统的模式识别程序，即通过分析图像的特征空间和聚类的方法来达到分割的目的。它是通过直接估计特征空间概率密度函数的局部极大值来获得未知类别的密度模式，并确定这个模式的位置，然后使之聚类到和这个模式有关的类别当中。
设S是n维空间X中的一个有限集合，K表示X空间中λ球体的一个特征函数，则其表达式为：
其中，x∈X，那么在向量x点处的样本均值为：
Fukunaga和Hostetle等人在其自己的论文中把m(x)-x的差叫做Mean-Shift。Mean-Shift算法实际上就是数据点到样本均值的重复移动，而且在算法的每一次迭代过程中，对于所有的s∈S，s←m (s)都是同时的。同时，模糊聚类算法还包括最大墒聚类算法以及常用的k均值聚类算法，它们都是Mean-Shift算法的一个有限的特例。Mean-Shift算法作为一种聚类分析方法，由于其密度估计器的梯度是递增的，而其收敛点即为密度梯度的局部极大值点，这个局部极大值即对应特征空间中的一个模式。
Mean-Shift算法对于概率密度函数的估计通常采用Parzen窗函数法，即核密度估计器。在d维空间Rd中，给定n个数据点xi，i=1，2…n，点x的多变量核密度估计器的计算式如式(3)所示。这个估计量可以由核K(x)和一个对称正定的d×d宽度的矩阵H来表示。
一般情况下，具有d个变量的核K(x)是一个满足以下条件的边界函数：
其中，ck是一个常量。从图像分割的目的出发，多变量核K (x)采用的是放射状对称核Ks(x)=ak,dK1(‖x‖)，其中K1(z)是一个对称的单变量核，且K (x)满足下式：
其中，ck,d是可使K (x)等于1的归一化常量。带宽矩阵H一般选择对角阵，H=diag[h12，…，h2d]或与单位矩阵H=h2I成比例。H=h2I情况下的一个明显优点是只需带宽参数h&gt;0。然而，从式(4)可以看出，首先应确定用于特征空间的欧几里德矩阵的有效性。若使用一个宽度参数h，则式(3)就会变成如下典型的表示式：
将(6)式代入上式，就可以得到一个通用的、用核符号表示的核密度估计式：
对有基本密度函数f(x)的一个特征空间，Mean-Shift算法分析的第一步是找到这个密度模式，然后对这个模式进行相关聚类。此模式应该在梯度▽f(x)=0的零点当中，而Mean-Shift程序是不用估计密度，而直接对密度的梯度进行估计，就能定位这些零点。
二、分割技术流程 对于Mean-Shift算法的应用与分割，首先，可设xi和zi(i=1，2，…，n)分别为n维空间内的输人和联合的空值域内的滤波图像的像素，Li为分割后的图像中的第i个像素。那么，其操作可分为以下步骤：
运行均值平移滤波程序对图像进行滤波，并存储所有d维空间内在zi处的收敛点zi=yi，c。在联合域中对所有的zi进行分组以描述类，这些类{Cp}p=1…m在空域内较hs较近，在值域内较hr较近。对于每一个i=1，…，n，并记为： Li={p|zi∈Cp|} (4)消除在空间区域内少于M个像素的区域。
输入：遥感图像，输出：分割后的斑块 三、代码实例 3.1 C&#43;&#43;&amp;GDAL库 实现 #include &#34;gdal_priv.h&#34; #include &#34;cpl_conv.h&#34; #include &lt;iostream&gt; #include &lt;opencv2/highgui/highgui.hpp&gt; #include&lt;cmath&gt; using namespace std; using namespace cv; struct aboutmat{ Mat mat; int width; int height; }; //读取数据并进行初始化：将其保存到3通道的数组中 aboutmat Initialization(const char *path) { //使之支持中文路径 CPLSetConfigOption(&#34;GDAL_FILENAME_IS_UTF8&#34;, &#34;NO&#34;); //注册栅格驱动 GDALAllRegister(); //打开要更新的数据，第二个参数使用介个 GDALDataset *poDS = (GDALDataset*)GDALOpen(path, GA_Update); //获取图像大小 int iWidth = poDS-&gt;GetRasterXSize(); int iHeight = poDS-&gt;GetRasterYSize(); //获取波段个数 int nBands = poDS-&gt;GetRasterCount(); //创建数组 //Mat data_XY(iWidth, iHeight, CV_8U, Scalar::all(0));	//坐标空间 Mat data_RGB(iHeight,iWidth, CV_8UC3, Scalar::all(0));	//色彩空间 //only三波段，多了不行 //进行波段循环，将矩阵形式表示的图像数据以行向量形式表示，如92*112的图像，表示为1*10304, for (int r = 1; r &lt;= nBands; &#43;&#43;r) { GDALRasterBand *xBand = poDS-&gt;GetRasterBand(r); unsigned char *pBuf = new unsigned char[iWidth * iHeight]; //动态指配数组 xBand-&gt;RasterIO(GF_Read, 0, 0, iWidth, iHeight, pBuf, iWidth, iHeight, GDT_Byte, 0, 0); for (int i = 0; i &lt; iHeight; i&#43;&#43;) { for (int j = 0; j &lt; iWidth; j&#43;&#43;) { data_RGB." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1f33e1e369d73b3559b81a0904e385ed/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-31T11:58:47+08:00" />
<meta property="article:modified_time" content="2020-10-31T11:58:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">图像分割——meanshift算法（C&#43;&#43;&amp;GDAL库）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>图像分割——meanshift算法（C++&amp;GDAL库）</h4> 
 <ul><li><a href="#meanshift_8" rel="nofollow">一、meanshift分割原理</a></li><li><a href="#_44" rel="nofollow">二、分割技术流程</a></li><li><a href="#_59" rel="nofollow">三、代码实例</a></li><li><ul><li><a href="#31_CGDAL__60" rel="nofollow">3.1 C++&amp;GDAL库 实现</a></li><li><a href="#32__477" rel="nofollow">3.2 分割结果</a></li><li><a href="#33__501" rel="nofollow">3.3 结果分析</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr size='1"' color="#000000"> 
<h2><a id="meanshift_8"></a>一、meanshift分割原理</h2> 
<p><strong>Mean-Shift</strong>是一种非参数化的多模型分割方法，它的基本计算模块采用的是传统的模式识别程序，即通过分析图像的特征空间和聚类的方法来达到分割的目的。它是通过直接估计特征空间概率密度函数的局部极大值来获得未知类别的密度模式，并确定这个模式的位置，然后使之聚类到和这个模式有关的类别当中。</p> 
<p>设S是n维空间X中的一个有限集合，K表示X空间中λ球体的一个特征函数，则其表达式为：</p> 
<p><img src="https://images2.imgbox.com/4a/39/RweOPl5Z_o.png" alt="在这里插入图片描述"><br> 其中，x∈X，那么在向量x点处的样本均值为：</p> 
<p><img src="https://images2.imgbox.com/fc/cd/xY93uA8Z_o.png" alt="在这里插入图片描述"><br> Fukunaga和Hostetle等人在其自己的论文中把m(x)-x的差叫做Mean-Shift。Mean-Shift算法实际上就是数据点到样本均值的重复移动，而且在算法的每一次迭代过程中，对于所有的s∈S，s←m (s)都是同时的。同时，模糊聚类算法还包括最大墒聚类算法以及常用的k均值聚类算法，它们都是Mean-Shift算法的一个有限的特例。Mean-Shift算法作为一种聚类分析方法，由于其密度估计器的梯度是递增的，而其收敛点即为密度梯度的局部极大值点，这个局部极大值即对应特征空间中的一个模式。</p> 
<p>Mean-Shift算法对于概率密度函数的估计通常采用<strong>Parzen窗函数法，即核密度估计器</strong>。在d维空间Rd中，给定n个数据点xi，i=1，2…n，点x的多变量核密度估计器的计算式如式(3)所示。这个估计量可以由核K(x)和一个对称正定的d×d宽度的矩阵H来表示。</p> 
<p><img src="https://images2.imgbox.com/6d/44/gGeyl435_o.png" alt="在这里插入图片描述"><br> 一般情况下，具有d个变量的核K(x)是一个满足以下条件的边界函数：</p> 
<p><img src="https://images2.imgbox.com/ba/c0/Dnsn6K2J_o.png" alt="在这里插入图片描述"><br> 其中，ck是一个常量。从图像分割的目的出发，多变量核K (x)采用的是放射状对称核Ks(x)=ak,dK1(‖x‖)，其中K1(z)是一个对称的单变量核，且K (x)满足下式：</p> 
<p><img src="https://images2.imgbox.com/dc/c7/DlssX2sR_o.png" alt="在这里插入图片描述"><br> 其中，ck,d是可使K (x)等于1的归一化常量。带宽矩阵H一般选择对角阵，H=diag[h12，…，h2d]或与单位矩阵H=h2I成比例。H=h2I情况下的一个明显优点是只需带宽参数h&gt;0。然而，从式(4)可以看出，首先应确定用于特征空间的欧几里德矩阵的有效性。若使用一个宽度参数h，则式(3)就会变成如下典型的表示式：</p> 
<p><img src="https://images2.imgbox.com/a5/e2/M8au8vTf_o.png" alt="在这里插入图片描述"></p> 
<p>将(6)式代入上式，就可以得到一个通用的、用核符号表示的核密度估计式：</p> 
<p><img src="https://images2.imgbox.com/e0/59/1JB8gLgJ_o.png" alt="在这里插入图片描述"></p> 
<p>对有基本密度函数f(x)的一个特征空间，Mean-Shift算法分析的第一步是找到这个密度模式，然后对这个模式进行相关聚类。此模式应该在梯度▽f(x)=0的零点当中，而Mean-Shift程序是不用估计密度，而直接对密度的梯度进行估计，就能定位这些零点。</p> 
<h2><a id="_44"></a>二、分割技术流程</h2> 
<p>对于Mean-Shift算法的应用与分割，首先，可设xi和zi(i=1，2，…，n)分别为n维空间内的输人和联合的空值域内的滤波图像的像素，Li为分割后的图像中的第i个像素。那么，其操作可分为以下步骤：</p> 
<ol><li>运行均值平移滤波程序对图像进行滤波，并存储所有d维空间内在zi处的收敛点zi=yi，c。</li><li>在联合域中对所有的zi进行分组以描述类，这些类{Cp}p=1…m在空域内较hs较近，在值域内较hr较近。</li><li>对于每一个i=1，…，n，并记为： Li={p|zi∈Cp|} (4)消除在空间区域内少于M个像素的区域。<br> 输入：遥感图像，输出：分割后的斑块</li></ol> 
<h2><a id="_59"></a>三、代码实例</h2> 
<h3><a id="31_CGDAL__60"></a>3.1 C++&amp;GDAL库 实现</h3> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"gdal_priv.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"cpl_conv.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;cmath&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>

<span class="token keyword">struct</span> aboutmat<span class="token punctuation">{<!-- --></span>
	Mat mat<span class="token punctuation">;</span>
	<span class="token keyword">int</span> width<span class="token punctuation">;</span>
	<span class="token keyword">int</span> height<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//读取数据并进行初始化：将其保存到3通道的数组中</span>
aboutmat <span class="token function">Initialization</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//使之支持中文路径</span>
	<span class="token function">CPLSetConfigOption</span><span class="token punctuation">(</span><span class="token string">"GDAL_FILENAME_IS_UTF8"</span><span class="token punctuation">,</span> <span class="token string">"NO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//注册栅格驱动</span>
	<span class="token function">GDALAllRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//打开要更新的数据，第二个参数使用介个</span>
	GDALDataset <span class="token operator">*</span>poDS <span class="token operator">=</span> <span class="token punctuation">(</span>GDALDataset<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">GDALOpen</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> GA_Update<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//获取图像大小</span>
	<span class="token keyword">int</span> iWidth <span class="token operator">=</span> poDS<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetRasterXSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> iHeight <span class="token operator">=</span> poDS<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetRasterYSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//获取波段个数</span>
	<span class="token keyword">int</span> nBands <span class="token operator">=</span> poDS<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetRasterCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//创建数组</span>
	<span class="token comment">//Mat data_XY(iWidth, iHeight, CV_8U, Scalar::all(0));	//坐标空间</span>
	Mat <span class="token function">data_RGB</span><span class="token punctuation">(</span>iHeight<span class="token punctuation">,</span>iWidth<span class="token punctuation">,</span> CV_8UC3<span class="token punctuation">,</span> Scalar<span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//色彩空间</span>

	<span class="token comment">//only三波段，多了不行</span>
	<span class="token comment">//进行波段循环，将矩阵形式表示的图像数据以行向量形式表示，如92*112的图像，表示为1*10304,</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> r <span class="token operator">&lt;=</span> nBands<span class="token punctuation">;</span> <span class="token operator">++</span>r<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		GDALRasterBand <span class="token operator">*</span>xBand <span class="token operator">=</span> poDS<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetRasterBand</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>iWidth <span class="token operator">*</span> iHeight<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//动态指配数组</span>

		xBand<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">RasterIO</span><span class="token punctuation">(</span>GF_Read<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> iWidth<span class="token punctuation">,</span> iHeight<span class="token punctuation">,</span> pBuf<span class="token punctuation">,</span> iWidth<span class="token punctuation">,</span> iHeight<span class="token punctuation">,</span> GDT_Byte<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> iHeight<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> iWidth<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				data_RGB<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">[</span>r<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> pBuf<span class="token punctuation">[</span>i<span class="token operator">*</span>iWidth<span class="token operator">+</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span>xBand<span class="token punctuation">;</span>
		<span class="token keyword">delete</span> pBuf<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	cout <span class="token operator">&lt;&lt;</span> data_RGB<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	
	aboutmat data<span class="token punctuation">;</span>
	data<span class="token punctuation">.</span>mat <span class="token operator">=</span> data_RGB<span class="token punctuation">;</span>
	data<span class="token punctuation">.</span>width <span class="token operator">=</span> iWidth<span class="token punctuation">;</span>
	data<span class="token punctuation">.</span>height <span class="token operator">=</span> iHeight<span class="token punctuation">;</span>
	<span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SingleMeanShift</span><span class="token punctuation">(</span><span class="token keyword">int</span> h<span class="token punctuation">,</span><span class="token keyword">int</span> w<span class="token punctuation">,</span><span class="token keyword">int</span> coreYCoordinate<span class="token punctuation">,</span> <span class="token keyword">int</span> coreXCoordinate<span class="token punctuation">,</span> <span class="token keyword">int</span> spacialH<span class="token punctuation">,</span> <span class="token keyword">int</span> colorRadiusSpace<span class="token punctuation">,</span>
	Mat newDataXY<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> corePointXY<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> dataColorSpatial<span class="token punctuation">,</span> <span class="token keyword">int</span> coreIteration<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>corePointNum<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//int meanNeiborR = 0;</span>
	<span class="token keyword">float</span> xGaussNumerator <span class="token operator">=</span>  <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//x轴高斯核分子</span>
	<span class="token keyword">float</span> xGaussDenominator <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 	<span class="token comment">//高斯核分母</span>
	<span class="token keyword">float</span> yGaussNumerator <span class="token operator">=</span>  <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//y轴高斯核分子</span>
	<span class="token keyword">float</span> yGaussDenominator <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//高斯核分母</span>
	<span class="token keyword">int</span> coreVector<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>	<span class="token comment">//步长</span>
	<span class="token keyword">int</span> coreNeiborNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//记录有几个符合要求的邻域点</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> coreYCoordinate <span class="token operator">-</span> spacialH<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> coreYCoordinate <span class="token operator">+</span> spacialH<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> newDataXY<span class="token punctuation">.</span>rows <span class="token operator">||</span> i <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> coreXCoordinate <span class="token operator">-</span> spacialH<span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> coreXCoordinate <span class="token operator">+</span> spacialH<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>	<span class="token comment">//空间筛选</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> j <span class="token operator">&gt;=</span> newDataXY<span class="token punctuation">.</span>cols<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> rDistance <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dataColorSpatial<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> dataColorSpatial<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> gDistance <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dataColorSpatial<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> dataColorSpatial<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> bDistance <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dataColorSpatial<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> dataColorSpatial<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> colorDistance <span class="token operator">=</span> rDistance <span class="token operator">+</span> gDistance <span class="token operator">+</span> bDistance<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>colorDistance <span class="token operator">&lt;=</span> colorRadiusSpace<span class="token punctuation">)</span>	<span class="token comment">//如果色彩差异在指定范围内（颜色筛选）</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">//这里用高斯核函数计算重心</span>
				xGaussNumerator <span class="token operator">=</span> xGaussNumerator <span class="token operator">+</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token operator">*</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">(</span>j <span class="token operator">-</span> coreXCoordinate<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span>spacialH<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span>j<span class="token punctuation">;</span>
				xGaussDenominator <span class="token operator">=</span> xGaussDenominator <span class="token operator">+</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token operator">*</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">(</span>j <span class="token operator">-</span> coreXCoordinate<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span>spacialH<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				yGaussNumerator <span class="token operator">=</span> yGaussNumerator <span class="token operator">+</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token operator">*</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">(</span>i <span class="token operator">-</span> coreYCoordinate<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span>spacialH<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span>i<span class="token punctuation">;</span>
				yGaussDenominator <span class="token operator">=</span> yGaussDenominator <span class="token operator">+</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token operator">*</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">(</span>i <span class="token operator">-</span> coreYCoordinate<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span>spacialH<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				coreNeiborNum <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> newCoreYCoordinate<span class="token punctuation">;</span>
	<span class="token keyword">int</span> newCoreXCoordinate<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>xGaussDenominator <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> yGaussDenominator <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//cout &lt;&lt; "符合要求的邻域点coreNeiborNum= " &lt;&lt; coreNeiborNum &lt;&lt; endl;</span>
		coreVector<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> xGaussNumerator <span class="token operator">/</span> xGaussDenominator <span class="token operator">-</span> coreXCoordinate<span class="token punctuation">;</span>	<span class="token comment">//向量</span>
		coreVector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> yGaussNumerator <span class="token operator">/</span> yGaussDenominator <span class="token operator">-</span> coreYCoordinate<span class="token punctuation">;</span>
		newCoreYCoordinate <span class="token operator">=</span> yGaussNumerator <span class="token operator">/</span> yGaussDenominator<span class="token punctuation">;</span>	<span class="token comment">//新坐标</span>
		newCoreXCoordinate <span class="token operator">=</span> xGaussNumerator <span class="token operator">/</span> xGaussDenominator<span class="token punctuation">;</span>
		<span class="token comment">//newDataXY.at &lt;Vec2i&gt;(coreYCoordinate, coreXCoordinate)[0] = corePointNum;</span>
		coreIteration<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		coreVector<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		coreVector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		newCoreYCoordinate <span class="token operator">=</span> coreYCoordinate<span class="token punctuation">;</span>	<span class="token comment">//新坐标</span>
		newCoreXCoordinate <span class="token operator">=</span> coreXCoordinate<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>	<span class="token comment">//防止溢出</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>newDataXY<span class="token punctuation">.</span>at <span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>newCoreYCoordinate<span class="token punctuation">,</span> newCoreXCoordinate<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>	<span class="token comment">//如果步进的位置已经有模点</span>
	<span class="token punctuation">{<!-- --></span>
		newDataXY<span class="token punctuation">.</span>at <span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>coreYCoordinate<span class="token punctuation">,</span> coreXCoordinate<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> newDataXY<span class="token punctuation">.</span>at <span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>newCoreYCoordinate<span class="token punctuation">,</span> newCoreXCoordinate<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//行：坐标赋值</span>
		newDataXY<span class="token punctuation">.</span>at <span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>coreYCoordinate<span class="token punctuation">,</span> coreXCoordinate<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> newDataXY<span class="token punctuation">.</span>at <span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>newCoreYCoordinate<span class="token punctuation">,</span> newCoreXCoordinate<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">//列</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>coreVector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">abs</span><span class="token punctuation">(</span>coreVector<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//|| (coreIteration &gt;= 100))	//如果找到了重心或者循环次数达到100</span>
	<span class="token punctuation">{<!-- --></span>
		corePointXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> corePointNum<span class="token punctuation">)</span> <span class="token operator">=</span> coreYCoordinate<span class="token punctuation">;</span>
		corePointXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> corePointNum<span class="token punctuation">)</span> <span class="token operator">=</span> coreXCoordinate<span class="token punctuation">;</span>
		newDataXY<span class="token punctuation">.</span>at <span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>coreYCoordinate<span class="token punctuation">,</span> coreXCoordinate<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> coreYCoordinate<span class="token punctuation">;</span>	<span class="token comment">//行：坐标赋值</span>
		newDataXY<span class="token punctuation">.</span>at <span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>coreYCoordinate<span class="token punctuation">,</span> coreXCoordinate<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> coreXCoordinate<span class="token punctuation">;</span>	<span class="token comment">//列</span>
		corePointNum<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//模点数目加一</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">SingleMeanShift</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span>w<span class="token punctuation">,</span>newCoreYCoordinate<span class="token punctuation">,</span> newCoreXCoordinate<span class="token punctuation">,</span>
			spacialH<span class="token punctuation">,</span> colorRadiusSpace<span class="token punctuation">,</span> newDataXY<span class="token punctuation">,</span> corePointXY<span class="token punctuation">,</span> dataColorSpatial<span class="token punctuation">,</span> coreIteration<span class="token punctuation">,</span> corePointNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
		newDataXY<span class="token punctuation">.</span>at <span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>coreYCoordinate<span class="token punctuation">,</span> coreXCoordinate<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> newDataXY<span class="token punctuation">.</span>at <span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>newCoreYCoordinate<span class="token punctuation">,</span> newCoreXCoordinate<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//行：坐标赋值</span>
		newDataXY<span class="token punctuation">.</span>at <span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>coreYCoordinate<span class="token punctuation">,</span> coreXCoordinate<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> newDataXY<span class="token punctuation">.</span>at <span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>newCoreYCoordinate<span class="token punctuation">,</span> newCoreXCoordinate<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">//列</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/*delete xGaussNumerator;
	delete yGaussNumerator;
	delete xGaussDenominator;
	delete yGaussDenominator;
	delete []coreVector;*/</span>
<span class="token punctuation">}</span>

Mat <span class="token function">MeanShift</span><span class="token punctuation">(</span>aboutmat data<span class="token punctuation">,</span> <span class="token keyword">int</span> spacialH<span class="token punctuation">,</span> <span class="token keyword">int</span> colorR<span class="token punctuation">,</span> Mat <span class="token operator">&amp;</span>corePointXY<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	Mat dataColorSpatial <span class="token operator">=</span> data<span class="token punctuation">.</span>mat<span class="token punctuation">;</span>
	<span class="token keyword">int</span> iWidth <span class="token operator">=</span> data<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
	<span class="token keyword">int</span> iHeight <span class="token operator">=</span> data<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
	<span class="token keyword">int</span> colorRadiusSpace <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span>colorR<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">pow</span><span class="token punctuation">(</span>colorR<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">pow</span><span class="token punctuation">(</span>colorR<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Mat <span class="token function">newDataXY</span><span class="token punctuation">(</span>iHeight<span class="token punctuation">,</span> iWidth<span class="token punctuation">,</span> CV_32SC2<span class="token punctuation">,</span> Scalar<span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//存放新的点坐标，以模点的顺序代替</span>
	<span class="token keyword">int</span> corePointNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//共有几个模点</span>
	
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> h <span class="token operator">&lt;</span> iHeight<span class="token punctuation">;</span> h<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> w <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> w <span class="token operator">&lt;</span> iWidth<span class="token punctuation">;</span> w<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//对每个数据点进行循环计算</span>
			<span class="token keyword">int</span> coreIteration <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//一个点移动了几步</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token comment">//执行单个的meanshift操作</span>
			<span class="token function">SingleMeanShift</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">,</span>spacialH<span class="token punctuation">,</span> colorRadiusSpace<span class="token punctuation">,</span> newDataXY<span class="token punctuation">,</span> corePointXY<span class="token punctuation">,</span> dataColorSpatial<span class="token punctuation">,</span> coreIteration<span class="token punctuation">,</span> corePointNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	dataColorSpatial<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//用来释放Mat空间</span>
	<span class="token keyword">return</span> newDataXY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//opencv的分层迭代法，速度快，处理难</span>
<span class="token comment">//系统采样/随机采样选取一定间隔的初始点</span>
<span class="token comment">//进行meanshift迭代，选出最后的模点位置</span>
Mat <span class="token function">randomPointmeanShift</span><span class="token punctuation">(</span>aboutmat data<span class="token punctuation">,</span><span class="token keyword">int</span> spacialH<span class="token punctuation">,</span><span class="token keyword">int</span> colorR<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> coreInterval <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>	<span class="token comment">//踩点间隔</span>
	Mat dataColor <span class="token operator">=</span> data<span class="token punctuation">.</span>mat<span class="token punctuation">;</span>
	<span class="token keyword">int</span> iWidth <span class="token operator">=</span> data<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
	<span class="token keyword">int</span> iHeight <span class="token operator">=</span> data<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
	<span class="token keyword">int</span> pointNum <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>iWidth <span class="token operator">/</span> coreInterval<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">int</span><span class="token punctuation">(</span>iHeight <span class="token operator">/</span> coreInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//系统采样 / 随机采样选取一定间隔的初始点</span>
	Mat <span class="token function">soursePoint</span><span class="token punctuation">(</span>iHeight<span class="token punctuation">,</span> iWidth<span class="token punctuation">,</span> CV_8U<span class="token punctuation">,</span> Scalar<span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Mat <span class="token function">point_XY</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> pointNum<span class="token punctuation">,</span> CV_32S<span class="token punctuation">,</span> Scalar<span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> coreInterval<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> iHeight<span class="token punctuation">;</span> i <span class="token operator">+</span><span class="token operator">=</span> coreInterval<span class="token punctuation">)</span>	<span class="token comment">//必须是最大的数字，否则容易溢出</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> coreInterval<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> iWidth<span class="token punctuation">;</span> j <span class="token operator">+</span><span class="token operator">=</span> coreInterval<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			soursePoint<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>	<span class="token comment">//存储初始点的xy坐标</span>
			point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>
			n<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/*用于验证坐标正不正确
	cout &lt;&lt; "point_XY.at&lt;int&gt;(0, n)" &lt;&lt; point_XY.at&lt;int&gt;(0, 4000) &lt;&lt; endl;
	cout &lt;&lt; "point_XY.at&lt;int&gt;(0, n)" &lt;&lt; point_XY.at&lt;int&gt;(1, 4000) &lt;&lt; endl;*/</span>
	
	<span class="token keyword">int</span> colorRadiusSpace <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span>colorR<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token function">pow</span><span class="token punctuation">(</span>colorR<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token function">pow</span><span class="token punctuation">(</span>colorR<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//开始meanshift迭代</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> p <span class="token operator">&lt;</span> pointNum<span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span>	<span class="token comment">//每个初始点循环</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> coreIteration <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">do</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">int</span> coreVector<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> coreNeiborNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-</span> spacialH<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">+</span> spacialH<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> iHeight <span class="token operator">&amp;&amp;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-</span> spacialH<span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">+</span> spacialH<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;</span> iWidth<span class="token punctuation">)</span>
						<span class="token punctuation">{<!-- --></span>
							<span class="token comment">//求出核与周围点的色彩差异</span>
							<span class="token keyword">int</span> rDistance <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dataColor<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> dataColor<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">int</span> gDistance <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dataColor<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> dataColor<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">int</span> bDistance <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dataColor<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> dataColor<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">int</span> colorDistance <span class="token operator">=</span> rDistance <span class="token operator">+</span> gDistance <span class="token operator">+</span> bDistance<span class="token punctuation">;</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>colorDistance <span class="token operator">&lt;=</span> colorRadiusSpace<span class="token punctuation">)</span>	<span class="token comment">//如果色彩差异在指定范围内</span>
							<span class="token punctuation">{<!-- --></span>
								<span class="token comment">//这里用高斯核计算中心</span>
								coreVector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> coreVector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> i <span class="token operator">-</span> point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
								coreVector<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> coreVector<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> j <span class="token operator">-</span> point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
								coreNeiborNum <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>	
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>coreNeiborNum <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">//求meanshift向量并移动模点</span>
				coreVector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> coreVector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> coreNeiborNum<span class="token punctuation">;</span>
				coreVector<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> coreVector<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> coreNeiborNum<span class="token punctuation">;</span>

				point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">=</span> point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">+</span> coreVector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">&gt;</span> iHeight<span class="token punctuation">)</span> point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">=</span> iHeight<span class="token punctuation">;</span>
				point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">=</span> point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">+</span> coreVector<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">&gt;</span> iWidth<span class="token punctuation">)</span> point_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">=</span> iWidth<span class="token punctuation">;</span>
				coreIteration<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>coreVector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">5</span> <span class="token operator">&amp;&amp;</span> coreVector<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
		<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>coreIteration <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//cout &lt;&lt; "p" &lt;&lt; p &lt;&lt; endl;</span>
		std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> p <span class="token operator">&lt;&lt;</span> <span class="token string">" 模点移动次数为"</span> <span class="token operator">&lt;&lt;</span> coreIteration <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//cout &lt;&lt; "点坐标" &lt;&lt; point_XY &lt;&lt; endl;</span>
	
	<span class="token keyword">return</span> point_XY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//筛选合格点，将颜色相近的点合并</span>
Mat <span class="token function">MergeCorePoint</span><span class="token punctuation">(</span>Mat data<span class="token punctuation">,</span> Mat sCorePoint_XY<span class="token punctuation">,</span> Mat newDataXY<span class="token punctuation">,</span> <span class="token keyword">int</span> colorDisparity<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> colorDisparitySpace <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span>colorDisparity<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">pow</span><span class="token punctuation">(</span>colorDisparity<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">pow</span><span class="token punctuation">(</span>colorDisparity<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> mergeTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> p1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> p1 <span class="token operator">&lt;</span> sCorePoint_XY<span class="token punctuation">.</span>cols<span class="token punctuation">;</span> p1<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> p2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> p2 <span class="token operator">&lt;</span> sCorePoint_XY<span class="token punctuation">.</span>cols<span class="token punctuation">;</span> p2<span class="token operator">++</span><span class="token punctuation">)</span>	<span class="token comment">//p2=p1+1</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p1 <span class="token operator">!=</span> p2<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>

					<span class="token comment">//三个总和差距小合并				</span>
					<span class="token comment">/*int rPoColorDisparity = pow(data.at&lt;Vec3b&gt;(sCorePoint_XY.at&lt;int&gt;(0, p1), sCorePoint_XY.at&lt;int&gt;(1, p1))[0]
						- data.at&lt;Vec3b&gt;(sCorePoint_XY.at&lt;int&gt;(0, p2), sCorePoint_XY.at&lt;int&gt;(1, p2))[0], 2);
						int gPoColorDisparity = pow(data.at&lt;Vec3b&gt;(sCorePoint_XY.at&lt;int&gt;(0, p1), sCorePoint_XY.at&lt;int&gt;(1, p1))[1]
						- data.at&lt;Vec3b&gt;(sCorePoint_XY.at&lt;int&gt;(0, p2), sCorePoint_XY.at&lt;int&gt;(1, p2))[1], 2);
						int bPoColorDisparity = pow(data.at&lt;Vec3b&gt;(sCorePoint_XY.at&lt;int&gt;(0, p1), sCorePoint_XY.at&lt;int&gt;(1, p1))[2]
						- data.at&lt;Vec3b&gt;(sCorePoint_XY.at&lt;int&gt;(0, p2), sCorePoint_XY.at&lt;int&gt;(1, p2))[2], 2);
						int pointColorDisparity = rPoColorDisparity + gPoColorDisparity + bPoColorDisparity;
						if (pointColorDisparity &lt; colorDisparitySpace)
						{
						newDataXY.at&lt;Vec2i&gt;(sCorePoint_XY.at&lt;int&gt;(0, p2), sCorePoint_XY.at&lt;int&gt;(1, p2))[0] =
						newDataXY.at&lt;Vec2i&gt;(sCorePoint_XY.at&lt;int&gt;(0, p1), sCorePoint_XY.at&lt;int&gt;(1, p1))[0];
						newDataXY.at&lt;Vec2i&gt;(sCorePoint_XY.at&lt;int&gt;(0, p2), sCorePoint_XY.at&lt;int&gt;(1, p2))[1] =
						newDataXY.at&lt;Vec2i&gt;(sCorePoint_XY.at&lt;int&gt;(0, p1), sCorePoint_XY.at&lt;int&gt;(1, p1))[1];
						sCorePoint_XY.at&lt;int&gt;(0, p2) = 0;
						sCorePoint_XY.at&lt;int&gt;(1, p2) = 0;
						}*/</span>
					<span class="token comment">//三个波段相差小就合并				</span>
					<span class="token keyword">int</span> rPoDisparity <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">,</span> sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
						<span class="token operator">-</span> data<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">,</span> sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">int</span> gPoDisparity <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">,</span> sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
						<span class="token operator">-</span> data<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">,</span> sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">int</span> bPoDisparity <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">,</span> sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
						<span class="token operator">-</span> data<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">,</span> sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rPoDisparity <span class="token operator">&lt;</span> colorDisparity<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>gPoDisparity <span class="token operator">&lt;</span> colorDisparity<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>bPoDisparity <span class="token operator">&lt;</span> colorDisparity<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">{<!-- --></span>
						newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">,</span> sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span>
							newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">,</span> sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
						newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">,</span> sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span>
							newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">,</span> sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
						sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
						sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//将存在的剩下的模点导出</span>
	<span class="token keyword">int</span> newCorePointNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">//Mat newCorePoint_XY(2, newCorePointNum, CV_32S, Scalar::all(0));</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>n <span class="token operator">&lt;</span> sCorePoint_XY<span class="token punctuation">.</span>cols<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			newCorePointNum<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	Mat <span class="token function">newCorePoint_XY</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> newCorePointNum<span class="token punctuation">,</span> CV_32S<span class="token punctuation">,</span> Scalar<span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> n1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> sCorePoint_XY<span class="token punctuation">.</span>cols<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			newCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n1<span class="token punctuation">)</span> <span class="token operator">=</span> sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
			newCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n1<span class="token punctuation">)</span> <span class="token operator">=</span> sCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>

			n1<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//输出所对应的颜色信息（用于验证）</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newCorePointNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;</span> data<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> c<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			cout <span class="token operator">&lt;&lt;</span><span class="token string">"第"</span><span class="token operator">&lt;&lt;</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token string">"个模点颜色为 "</span><span class="token operator">&lt;&lt;</span> <span class="token keyword">int</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>newCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> newCorePoint_XY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"  "</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	Mat <span class="token function">newDataColorSpa</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>rows<span class="token punctuation">,</span> data<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> CV_8UC3<span class="token punctuation">,</span> Scalar<span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//存放新的图像（分割后）</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> r <span class="token operator">&lt;</span> newDataXY<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> r<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;</span> newDataXY<span class="token punctuation">.</span>cols<span class="token punctuation">;</span> c<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
				<span class="token punctuation">(</span>newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ch <span class="token operator">&lt;</span> data<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ch<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				newDataColorSpa<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span>ch<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newDataXY<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec2i<span class="token operator">&gt;</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>ch<span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token comment">//cout &lt;&lt; newDataColorSpa.at&lt;Vec3b&gt;(r, c)[ch]&lt;&lt;endl;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>  newDataColorSpa<span class="token punctuation">;</span>
	std<span class="token operator">::</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//将其根据位置赋值并输出</span>
<span class="token keyword">void</span> <span class="token function">SaveImage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> pszRasterFile<span class="token punctuation">,</span> Mat newData<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>path<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//int bytesPerLine = (newData.cols * 24 ) / 8;</span>
	<span class="token function">CPLSetConfigOption</span><span class="token punctuation">(</span><span class="token string">"GDAL_FILNAME_IS_UTF8"</span><span class="token punctuation">,</span> <span class="token string">"NO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>newData<span class="token punctuation">.</span>cols<span class="token operator">*</span>newData<span class="token punctuation">.</span>rows<span class="token operator">*</span>newData<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> r <span class="token operator">&lt;=</span> newData<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>r<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newData<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> newData<span class="token punctuation">.</span>cols<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				pBuf<span class="token punctuation">[</span><span class="token punctuation">(</span>r <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>newData<span class="token punctuation">.</span>rows<span class="token operator">*</span>newData<span class="token punctuation">.</span>cols<span class="token operator">+</span>i<span class="token operator">*</span>newData<span class="token punctuation">.</span>cols <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> newData<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">[</span>r <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token function">GDALAllRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注册数据集  </span>
	GDALDriver <span class="token operator">*</span>poDriver<span class="token punctuation">;</span>
	GDALDataset <span class="token operator">*</span>BiomassDataset<span class="token punctuation">;</span>
	poDriver <span class="token operator">=</span> <span class="token function">GetGDALDriverManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetDriverByName</span><span class="token punctuation">(</span><span class="token string">"Gtiff"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//const char *output_file = "D:\xxxx";</span>
	BiomassDataset <span class="token operator">=</span> poDriver<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Create</span><span class="token punctuation">(</span>pszRasterFile<span class="token punctuation">,</span> newData<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> newData<span class="token punctuation">.</span>rows<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> GDT_Byte<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> panBandMap<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	BiomassDataset<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">RasterIO</span><span class="token punctuation">(</span>GF_Write<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> newData<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> newData<span class="token punctuation">.</span>rows<span class="token punctuation">,</span> pBuf<span class="token punctuation">,</span> newData<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> newData<span class="token punctuation">.</span>rows<span class="token punctuation">,</span> GDT_Byte<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> panBandMap<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GDALClose</span><span class="token punctuation">(</span>BiomassDataset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	BiomassDataset <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> pBuf<span class="token punctuation">;</span>
	pBuf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path <span class="token operator">=</span> <span class="token string">"G:/ER03634.tif"</span><span class="token punctuation">;</span>	
	<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> pszRasterFile <span class="token operator">=</span> <span class="token string">"G:/result/Mean8_8.tif"</span><span class="token punctuation">;</span>
	aboutmat sourseData <span class="token operator">=</span> <span class="token function">Initialization</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> spaceRadius <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>	<span class="token comment">//空间搜索半径</span>
	<span class="token keyword">int</span> colorRadius <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>	<span class="token comment">//色彩空间半径</span>
	<span class="token keyword">int</span> colorDisparity <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
	Mat <span class="token function">corePointXY</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> sourseData<span class="token punctuation">.</span>width<span class="token operator">*</span>sourseData<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> CV_32S<span class="token punctuation">,</span> Scalar<span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//存放模点坐标</span>
	Mat newDataXY <span class="token operator">=</span> <span class="token function">MeanShift</span><span class="token punctuation">(</span>sourseData<span class="token punctuation">,</span> spaceRadius<span class="token punctuation">,</span> colorRadius<span class="token punctuation">,</span> corePointXY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//Mat soursePointXY = randomPointmeanShift(sourseData, spaceRadius, colorRadius);</span>
	Mat newData <span class="token operator">=</span> <span class="token function">MergeCorePoint</span><span class="token punctuation">(</span>sourseData<span class="token punctuation">.</span>mat<span class="token punctuation">,</span> corePointXY<span class="token punctuation">,</span> newDataXY<span class="token punctuation">,</span> colorDisparity<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> newDataXY<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token function">SaveImage</span><span class="token punctuation">(</span>pszRasterFile<span class="token punctuation">,</span> newData<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="32__477"></a>3.2 分割结果</h3> 
<p>首先用openCV库的库函数进行分割，作为对照结果如下（左：原图，右：库函数分割结果）</p> 
<p><img src="https://images2.imgbox.com/2c/e0/cslQTS1I_o.png" alt="在这里插入图片描述"><br> 上述代码处理结果：</p> 
<p><img src="https://images2.imgbox.com/59/a6/dsrYpMSt_o.png" alt="在这里插入图片描述"></p> 
<p><font color="#999AAA">从左到右依次为：（8-8-4，8-8-16,16-4-4）数据说明：第一个参数表示空间半径（像素），第二个参数表示色彩半径（像素），第三个参数表示类合并最小半径，若无说明，合并方法为三个总和差距小合并。</font></p> 
<p>不同空间半径分割结果（左侧8，右侧16）</p> 
<p><img src="https://images2.imgbox.com/37/00/WyLGSQ2Y_o.png" alt="在这里插入图片描述"></p> 
<p>不同合并方法分割结果</p> 
<p><img src="https://images2.imgbox.com/f0/7d/AHdyVbs3_o.png" alt="在这里插入图片描述"><br> <font color="#999AAA">注：都是8-8-8的窗口大小，左：合并方法为三个总和差距小合并；右：合并方法为一个波段相差小就合并。</font></p> 
<h3><a id="33__501"></a>3.3 结果分析</h3> 
<p><strong>由分割总体结果显示来看，分割效果较差，代码优化不好导致分割时间较长。</strong> 代码相比openCV库Mean—Shift分割函数有一些改进：</p> 
<ul><li>1.其库函数的寻找模点（密度最大的点）方法为随机选取点进行寻找，改进对所有像元遍历寻找，更符合Mean-Shift原理，但耗费时间更长。</li><li>2.核密度计算由均匀核函数改进为高斯核函数，即越靠近中心点，对中心点的密度贡献越大，更符合实际情况。</li><li>3.平滑时，库函数对寻找到的模点进行洪水蔓延算法平滑，改进为在寻找模点的同时进行图像平滑，避免了二次遍历，也更符合MeanShift原理。</li><li>4.在合并类时采取了两种方法，可以任意选择。 由不同分类参数结果可以得出结论：在一定范围内，空间半径越大，分割效果越差，运行时间越长；色彩半径同样；合并方法“一个波段相差小就合并”比“三个总和差距小合并”更好。</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4b73e3ee58f51ce4675e0feabbaa51dc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">lotus-miner lotus-worker 运行</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f32eed9c1d8a056a517496604f900869/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">USB2.0 通信协议</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>