<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>TVM Compiler中文教程：TVM如何优化CPU GEMM(矩阵乘法) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="TVM Compiler中文教程：TVM如何优化CPU GEMM(矩阵乘法)" />
<meta property="og:description" content="文章目录 TVM如何优化CPU GEMM(矩阵乘法)准备和基线Opt1：分块Opt2：向量化Opt3：循环排布permuteOpt4：数组打包Opt5：为块写cacheOpt6：并行总结 TVM如何优化CPU GEMM(矩阵乘法) TVM提供抽象接口，允许用户分别描述算法和算法的实施组织（所谓的调度Schedule）。通常，写高性能调度的算法时，会破坏算法的可读性和模块性。此外，尝试各种看似有用的调度是非常耗费人力的。在TVM帮助下，我们能高效地尝试这些调度，来提高计算性能。
在本教程中，我们将演示如何使用TVM优化方阵乘法，并通过简单地添加18行额外代码，实现比基线版本快200倍的优化版本。
在CPU上执行密集计算有两个优化重点：
提高内存访问的cache命中率。复杂的数值计算和hot-spot存储器访问都可以从高cache命中率中加速。这要求我们将原始内存访问模式转换为符合cache策略的模式。SIMD（单指令多数据），也成为向量化处理单元。每次都会处理一小批数据，而不是单个网格。这要求我们以统一模式在循环体中转变数据访问模式，以便LLVM后端可以将其降低到SIMD。 实际上，本教程中使用的所有方法都是此repo中提到的技巧的子集。其中一些已经被TVM抽象并自动应用，但由于TVM限制，其中一些不能简单地应用。
下面提到的所有实验结果都是在配备Intel i7-4770HQ CPU的2015款15英寸MacBook上执行的。对于所有x86 CPU，高速缓存行大小应为64字节。
注：代码里面的测试时间是个人在E5-2620 v4测得 准备和基线 在本教程中，我们将演示如何使用TVM来优化矩阵乘法。在实际演示之前，我们首先定义这些变量。然后我们编写一个基线实现，这是在TVM中编写矩阵乘法的最简单方法。
import tvm import numpy import timeit #矩阵大小(M,K)x(K,N),可以自由尝试不同的形状，有时TVM优化优于MKL的numpy。 M = 1024 K = 1024 N = 1024 #TVM中默认张量类型 dtype = &#34;float32&#34; #使用Intel AVX2（高级矢量扩展）ISA进行SIMD #获得最佳新能要修改下一行为&#39;llvm -mcpu=core-avx2&#39;，或者指定你使用的其他CPU类型 #实测指定CPU以后，Opt6版本可以达到略高于MKL numpy的性能。 target = &#39;llvm&#39; ctx = tvm.context(target, 0) # Random generated tensor for testing a = tvm.nd.array(numpy.random.rand(M, K).astype(dtype), ctx) b = tvm.nd.array(numpy.random.rand(K, N).astype(dtype), ctx) #numpy测试Numpy running time: 0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/8f1faab631bd4257c49bd67f89c0954e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-06-13T23:06:42+08:00" />
<meta property="article:modified_time" content="2019-06-13T23:06:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">TVM Compiler中文教程：TVM如何优化CPU GEMM(矩阵乘法)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#TVMCPU_GEMM_2" rel="nofollow">TVM如何优化CPU GEMM(矩阵乘法)</a></li><li><ul><li><a href="#_19" rel="nofollow">准备和基线</a></li><li><a href="#Opt1_103" rel="nofollow">Opt1：分块</a></li><li><a href="#Opt2_166" rel="nofollow">Opt2：向量化</a></li><li><a href="#Opt3permute_225" rel="nofollow">Opt3：循环排布permute</a></li><li><a href="#Opt4_284" rel="nofollow">Opt4：数组打包</a></li><li><a href="#Opt5cache_367" rel="nofollow">Opt5：为块写cache</a></li><li><a href="#Opt6_455" rel="nofollow">Opt6：并行</a></li><li><a href="#_542" rel="nofollow">总结</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="TVMCPU_GEMM_2"></a>TVM如何优化CPU GEMM(矩阵乘法)</h2> 
<p>TVM提供抽象接口，允许用户分别描述算法和算法的实施组织（所谓的调度Schedule）。通常，写高性能调度的算法时，会破坏算法的可读性和模块性。此外，尝试各种看似有用的调度是非常耗费人力的。在TVM帮助下，我们能高效地尝试这些调度，来提高计算性能。</p> 
<p>在本教程中，我们将演示如何使用TVM优化方阵乘法，并通过简单地添加18行额外代码，实现比基线版本快200倍的优化版本。</p> 
<p><strong>在CPU上执行密集计算有两个优化重点：</strong></p> 
<ol><li>提高内存访问的cache命中率。复杂的数值计算和hot-spot存储器访问都可以从高cache命中率中加速。这要求我们将原始内存访问模式转换为符合cache策略的模式。</li><li>SIMD（单指令多数据），也成为向量化处理单元。每次都会处理一小批数据，而不是单个网格。这要求我们以<em>统一模式</em>在循环体中转变<code>数据访问模式</code>，以便LLVM后端可以将其降低到SIMD。</li></ol> 
<p>实际上，本教程中使用的所有方法都是此<a href="https://github.com/flame/how-to-optimize-gemm">repo</a>中提到的技巧的子集。其中一些已经被TVM抽象并自动应用，但由于TVM限制，其中一些不能简单地应用。</p> 
<p>下面提到的所有实验结果都是在配备Intel i7-4770HQ CPU的2015款15英寸MacBook上执行的。对于所有x86 CPU，<code>高速缓存行</code>大小应为<strong>64字节</strong>。</p> 
<ul><li><code>注：代码里面的测试时间是个人在E5-2620 v4测得</code></li></ul> 
<h3><a id="_19"></a>准备和基线</h3> 
<p>在本教程中，我们将演示如何使用TVM来优化矩阵乘法。在实际演示之前，我们首先定义这些变量。然后我们编写一个基线实现，这是在TVM中编写矩阵乘法的最简单方法。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tvm
<span class="token keyword">import</span> numpy
<span class="token keyword">import</span> timeit

<span class="token comment">#矩阵大小(M,K)x(K,N),可以自由尝试不同的形状，有时TVM优化优于MKL的numpy。</span>
M <span class="token operator">=</span> <span class="token number">1024</span>
K <span class="token operator">=</span> <span class="token number">1024</span>
N <span class="token operator">=</span> <span class="token number">1024</span>
<span class="token comment">#TVM中默认张量类型</span>
dtype <span class="token operator">=</span> <span class="token string">"float32"</span>
<span class="token comment">#使用Intel AVX2（高级矢量扩展）ISA进行SIMD</span>
<span class="token comment">#获得最佳新能要修改下一行为'llvm -mcpu=core-avx2'，或者指定你使用的其他CPU类型</span>
<span class="token comment">#实测指定CPU以后，Opt6版本可以达到略高于MKL numpy的性能。</span>
target <span class="token operator">=</span> <span class="token string">'llvm'</span>
ctx <span class="token operator">=</span> tvm<span class="token punctuation">.</span>context<span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment"># Random generated tensor for testing</span>
a <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>M<span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
b <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>K<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>

<span class="token comment">#numpy测试Numpy running time: 0.004753ms</span>
np_repeat <span class="token operator">=</span> <span class="token number">100</span>
np_runing_time <span class="token operator">=</span> timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">(</span>setup<span class="token operator">=</span><span class="token string">'import numpy\n'</span>
                                     <span class="token string">'M = '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span>
                                     <span class="token string">'K = '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>K<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span>
                                     <span class="token string">'N = '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span>
                                     <span class="token string">'dtype = "float32"\n'</span>
                                     <span class="token string">'a = numpy.random.rand(M, K).astype(dtype)\n'</span>
                                     <span class="token string">'b = numpy.random.rand(K, N).astype(dtype)\n'</span><span class="token punctuation">,</span>
                               stmt<span class="token operator">=</span><span class="token string">'answer = numpy.dot(a, b)'</span><span class="token punctuation">,</span>
                               number<span class="token operator">=</span>np_repeat<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Numpy running time: %f"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>np_runing_time <span class="token operator">/</span> np_repeat<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">#基准测试：Baseline: 2.174880ms</span>
<span class="token comment">#算法</span>
k <span class="token operator">=</span> tvm<span class="token punctuation">.</span>reduce_axis<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'k'</span><span class="token punctuation">)</span>
A <span class="token operator">=</span> tvm<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'A'</span><span class="token punctuation">)</span>
B <span class="token operator">=</span> tvm<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'B'</span><span class="token punctuation">)</span>
C <span class="token operator">=</span> tvm<span class="token punctuation">.</span>compute<span class="token punctuation">(</span>
           <span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> tvm<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span>x<span class="token punctuation">,</span> k<span class="token punctuation">]</span> <span class="token operator">*</span> B<span class="token punctuation">[</span>k<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span>
           name<span class="token operator">=</span><span class="token string">'C'</span><span class="token punctuation">)</span>
<span class="token comment">#默认调度</span>
c <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
func<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
tvm<span class="token punctuation">.</span>testing<span class="token punctuation">.</span>assert_allclose<span class="token punctuation">(</span>c<span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> answer<span class="token punctuation">,</span> rtol<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>

evaluator <span class="token operator">=</span> func<span class="token punctuation">.</span>time_evaluator<span class="token punctuation">(</span>func<span class="token punctuation">.</span>entry_name<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Baseline: %f'</span> <span class="token operator">%</span> evaluator<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code>Numpy running time: 0.036594
Baseline: 2.533367
</code></pre> 
<p>在TVM中，我们可以随时检查较低级别的IR以调试或优化我们的调度。以下是使用我们的基线计划生成的IR。</p> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-c">produce C <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      C<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.000000f</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        C<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">*</span>B<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Opt1_103"></a>Opt1：分块</h3> 
<p>分块（数据块将逐块计算）是一个增强cache命中率的重要技巧。块内的存储器访问是一个具有高内存局部性的小邻域。在本教程中，我们选择32作为分块因子。因此该块将填充32 * 32 * sizeof（float），它占总大小为32KB的缓存中的4KB（L1数据缓存）。</p> 
<pre><code class="prism language-python"><span class="token comment">#Opt1调度方法：</span>
bn <span class="token operator">=</span> <span class="token number">32</span>
<span class="token comment">#通过循环平铺tile来分块</span>
xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span><span class="token comment">#32x32的块，返回内外循环索引</span>
k<span class="token punctuation">,</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token comment">#ko,ki移到内外块循环之间</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> ko<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi<span class="token punctuation">)</span>

func <span class="token operator">=</span> tvm<span class="token punctuation">.</span>build<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'mmult'</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> func

c <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
func<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
tvm<span class="token punctuation">.</span>testing<span class="token punctuation">.</span>assert_allclose<span class="token punctuation">(</span>c<span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> answer<span class="token punctuation">,</span> rtol<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token comment">#通过简单地平铺循环32x32，并在外分块循环出加入ko，ki循环，我们可以看到与基线相比，有很大加速。</span>
<span class="token comment">#Opt1: 0.382091ms</span>
evaluator <span class="token operator">=</span> func<span class="token punctuation">.</span>time_evaluator<span class="token punctuation">(</span>func<span class="token punctuation">.</span>entry_name<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Opt1: %f'</span> <span class="token operator">%</span> evaluator<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code>Opt1: 0.296531
</code></pre> 
<p>这是在分块后生成的IR。</p> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-c">produce C <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          C<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.000000f</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>inner<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              C<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">*</span>B<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Opt2_166"></a>Opt2：向量化</h3> 
<p>向量化是另一个重要的技巧。当内存访问模式一致时，编译器可以检测到这种模式并将连续内存传递给向量处理器。在TVM中，我们可以使用<code>vectorize</code>接口来暗示编译器这种模式，这样我们就可以大大加速它。 在本教程中，我们选择对内部循环行数据进行矢量化，因为它是cache友好的。</p> 
<pre><code class="prism language-python">s <span class="token operator">=</span> tvm<span class="token punctuation">.</span>create_schedule<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">)</span>
xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>
k<span class="token punctuation">,</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> ko<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi<span class="token punctuation">)</span>

<span class="token comment"># 与Opt1唯一区别在：向量化</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>yi<span class="token punctuation">)</span>

func <span class="token operator">=</span> tvm<span class="token punctuation">.</span>build<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'mmult'</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> func

c <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
func<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
tvm<span class="token punctuation">.</span>testing<span class="token punctuation">.</span>assert_allclose<span class="token punctuation">(</span>c<span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> answer<span class="token punctuation">,</span> rtol<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token comment">#Opt2: 0.356233ms</span>
evaluator <span class="token operator">=</span> func<span class="token punctuation">.</span>time_evaluator<span class="token punctuation">(</span>func<span class="token punctuation">.</span>entry_name<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Opt2: %f'</span> <span class="token operator">%</span> evaluator<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code>Opt2: 0.312343
</code></pre> 
<p>这是向量化后生产的IR。</p> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-c">produce C <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        C<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">x32</span><span class="token punctuation">(</span><span class="token number">0.000000f</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            C<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">x32</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>B<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Opt3permute_225"></a>Opt3：循环排布permute</h3> 
<p>如果我们看一下上面的IR，我们可以看到内部循环行数据被向量化，B被转换成PackedB。PackedB的遍历现在是顺序的。因此，我们将查看A的访问模式。在当前调度中，A<code>逐列访问</code>，这是cache不友好的。如果我们改变ki和内轴xi的嵌套循环次序，则A矩阵的访问模式更加cache友好。</p> 
<pre><code class="prism language-python">s <span class="token operator">=</span> tvm<span class="token punctuation">.</span>create_schedule<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">)</span>
xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>
k<span class="token punctuation">,</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token comment"># re-ordering,改变xi和ki的循环位置</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> ko<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> yi<span class="token punctuation">)</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>yi<span class="token punctuation">)</span>

func <span class="token operator">=</span> tvm<span class="token punctuation">.</span>build<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'mmult'</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> func

c <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
func<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
tvm<span class="token punctuation">.</span>testing<span class="token punctuation">.</span>assert_allclose<span class="token punctuation">(</span>c<span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> answer<span class="token punctuation">,</span> rtol<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment">#Opt3: 0.098853</span>
evaluator <span class="token operator">=</span> func<span class="token punctuation">.</span>time_evaluator<span class="token punctuation">(</span>func<span class="token punctuation">.</span>entry_name<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Opt3: %f'</span> <span class="token operator">%</span> evaluator<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code>Opt3: 0.141706
</code></pre> 
<p>这是循环重排后生成的IR。</p> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-c">produce C <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        C<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">x32</span><span class="token punctuation">(</span><span class="token number">0.000000f</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            C<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">x32</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>B<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Opt4_284"></a>Opt4：数组打包</h3> 
<p>数组打包是另一个重要技巧。这个技巧是重新排序数组的存储维度，以便在展平flatten后将特定维度上的连续访问模式转换为顺序模式。</p> 
<p><img src="https://images2.imgbox.com/9d/b8/IrbZZ2jS_o.png" alt=""></p> 
<p>正如上图所示，在分块计算之后，我们可以观察到B（在展平flatten后）的数组访问模式是规则的，但是<code>不连续</code>的。我们希望在经过一些转换后，我们可以获得连续的访问模式我们可以将[16] [16]数组重新排序为[16/4] [16] [4]数组，这样当从打包数组中获取相应的值时，B的访问模式将是连续的。</p> 
<pre><code class="prism language-python"><span class="token comment">#打包B</span>
packedB <span class="token operator">=</span> tvm<span class="token punctuation">.</span>compute<span class="token punctuation">(</span><span class="token punctuation">(</span>N<span class="token operator">/</span>bn<span class="token punctuation">,</span>K<span class="token punctuation">,</span>bn<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">:</span> B<span class="token punctuation">[</span>y<span class="token punctuation">,</span> x <span class="token operator">*</span> bn <span class="token operator">+</span> z<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'packedB'</span><span class="token punctuation">)</span>
<span class="token comment">#矩阵乘法</span>
C <span class="token operator">=</span> tvm<span class="token punctuation">.</span>compute<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> tvm<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span>x<span class="token punctuation">,</span> k<span class="token punctuation">]</span> <span class="token operator">*</span> packedB<span class="token punctuation">[</span>y <span class="token operator">/</span> bn<span class="token punctuation">,</span> k<span class="token punctuation">,</span> y <span class="token operator">%</span> bn<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span>
                name <span class="token operator">=</span> <span class="token string">'C'</span><span class="token punctuation">)</span>
<span class="token comment">#下面与上面Opt3调度</span>
s <span class="token operator">=</span> tvm<span class="token punctuation">.</span>create_schedule<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">)</span>

xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>
k<span class="token punctuation">,</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> ko<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> yi<span class="token punctuation">)</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>yi<span class="token punctuation">)</span>

x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis
s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>z<span class="token punctuation">)</span>
s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>parallel<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

func <span class="token operator">=</span> tvm<span class="token punctuation">.</span>build<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'mmult'</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> func

c <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
func<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
tvm<span class="token punctuation">.</span>testing<span class="token punctuation">.</span>assert_allclose<span class="token punctuation">(</span>c<span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> answer<span class="token punctuation">,</span> rtol<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment">#Opt4: 0.118722 打包耗时，与Opt3速度相比，反而有所下降</span>
evaluator <span class="token operator">=</span> func<span class="token punctuation">.</span>time_evaluator<span class="token punctuation">(</span>func<span class="token punctuation">.</span>entry_name<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Opt4: %f'</span> <span class="token operator">%</span> evaluator<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code>Opt4: 0.260761
</code></pre> 
<p>这是数组打包后生成的IR。</p> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-c"><span class="token comment">// attr [packedB] storage_scope = "global"</span>
allocate packedB<span class="token punctuation">[</span>float32x32 <span class="token operator">*</span> <span class="token number">32768</span><span class="token punctuation">]</span>
produce packedB <span class="token punctuation">{<!-- --></span>
  parallel <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      packedB<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> B<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
produce C <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        C<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">x32</span><span class="token punctuation">(</span><span class="token number">0.000000f</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            C<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">x32</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Opt5cache_367"></a>Opt5：为块写cache</h3> 
<p>分块后，程序会逐块将结果写入C，访问模式<code>不是顺序</code>的。因此，我们可以使用顺序cache数组来保存块结果，并在所有块结果都准备就绪后一起写入C。</p> 
<pre><code class="prism language-python">s <span class="token operator">=</span> tvm<span class="token punctuation">.</span>create_schedule<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">)</span>

<span class="token comment">#为变量C分配写cache</span>
CC <span class="token operator">=</span> s<span class="token punctuation">.</span>cache_write<span class="token punctuation">(</span>C<span class="token punctuation">,</span> <span class="token string">'global'</span><span class="token punctuation">)</span>
<span class="token comment">#分块</span>
xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>
<span class="token comment">#写cache放在yo循环处计算</span>
s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>compute_at<span class="token punctuation">(</span>s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">,</span> yo<span class="token punctuation">)</span>

<span class="token comment">#新的内轴（这里的操作都是对变量CC，等完全计算结束后，再C=CC）</span>
xc<span class="token punctuation">,</span> yc <span class="token operator">=</span> s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis

k<span class="token punctuation">,</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>ko<span class="token punctuation">,</span> xc<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> yc<span class="token punctuation">)</span>
s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>unroll<span class="token punctuation">(</span>ki<span class="token punctuation">)</span>
s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>yc<span class="token punctuation">)</span>

func <span class="token operator">=</span> tvm<span class="token punctuation">.</span>build<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'mmult'</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> func

c <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
func<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
tvm<span class="token punctuation">.</span>testing<span class="token punctuation">.</span>assert_allclose<span class="token punctuation">(</span>c<span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> answer<span class="token punctuation">,</span> rtol<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment">#Opt5: 0.050380</span>
evaluator <span class="token operator">=</span> func<span class="token punctuation">.</span>time_evaluator<span class="token punctuation">(</span>func<span class="token punctuation">.</span>entry_name<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Opt5: %f'</span> <span class="token operator">%</span> evaluator<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">)</span>

</code></pre> 
<p>输出：</p> 
<pre><code>Opt5: 0.242124
</code></pre> 
<p>这是在块写cache后生成的IR。</p> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-c"><span class="token comment">// attr [packedB] storage_scope = "global"</span>
allocate packedB<span class="token punctuation">[</span>float32x32 <span class="token operator">*</span> <span class="token number">32768</span><span class="token punctuation">]</span>
<span class="token comment">// attr [C.global] storage_scope = "global"</span>
allocate C<span class="token punctuation">.</span>global<span class="token punctuation">[</span>float32 <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span>
produce packedB <span class="token punctuation">{<!-- --></span>
  parallel <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      packedB<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> B<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
produce C <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      produce C<span class="token punctuation">.</span>global <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">.</span>init<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">.</span>init<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">x32</span><span class="token punctuation">(</span><span class="token number">0.000000f</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">x32</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">x32</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">x32</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">x32</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>inner<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          C<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Opt6_455"></a>Opt6：并行</h3> 
<p>此外，我们还可以利用多核处理器进行线程级并行化。</p> 
<pre><code class="prism language-python">s <span class="token operator">=</span> tvm<span class="token punctuation">.</span>create_schedule<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">)</span>

CC <span class="token operator">=</span> s<span class="token punctuation">.</span>cache_write<span class="token punctuation">(</span>C<span class="token punctuation">,</span> <span class="token string">'global'</span><span class="token punctuation">)</span>

xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>

s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>compute_at<span class="token punctuation">(</span>s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">,</span> yo<span class="token punctuation">)</span>

xc<span class="token punctuation">,</span> yc <span class="token operator">=</span> s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis

k<span class="token punctuation">,</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>ko<span class="token punctuation">,</span> xc<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> yc<span class="token punctuation">)</span>
s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>unroll<span class="token punctuation">(</span>ki<span class="token punctuation">)</span>
s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>yc<span class="token punctuation">)</span>

<span class="token comment"># parallel对外循环xo进行多线程并行计算</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>parallel<span class="token punctuation">(</span>xo<span class="token punctuation">)</span>

x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis
s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>z<span class="token punctuation">)</span>
s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>parallel<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

func <span class="token operator">=</span> tvm<span class="token punctuation">.</span>build<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'mmult'</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> func

c <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
func<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
tvm<span class="token punctuation">.</span>testing<span class="token punctuation">.</span>assert_allclose<span class="token punctuation">(</span>c<span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> answer<span class="token punctuation">,</span> rtol<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment">#Opt6: 0.004400（这是llvm -mcpu=core-avx2的优化结果，比mkl稍快）</span>
evaluator <span class="token operator">=</span> func<span class="token punctuation">.</span>time_evaluator<span class="token punctuation">(</span>func<span class="token punctuation">.</span>entry_name<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>
opt6_time <span class="token operator">=</span> evaluator<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">.</span>mean
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Opt6: %f'</span> <span class="token operator">%</span> opt6_time<span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code>Opt6: 0.106932
</code></pre> 
<p>这是线程并行后生成的IR。</p> 
<pre><code class="prism language-c"><span class="token comment">// attr [packedB] storage_scope = "global"</span>
allocate packedB<span class="token punctuation">[</span>float32x32 <span class="token operator">*</span> <span class="token number">32768</span><span class="token punctuation">]</span>
produce packedB <span class="token punctuation">{<!-- --></span>
  parallel <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      packedB<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> B<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
produce C <span class="token punctuation">{<!-- --></span>
  parallel <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// attr [C.global] storage_scope = "global"</span>
    allocate C<span class="token punctuation">.</span>global<span class="token punctuation">[</span>float32 <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      produce C<span class="token punctuation">.</span>global <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">.</span>init<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">.</span>init<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">x32</span><span class="token punctuation">(</span><span class="token number">0.000000f</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">x32</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">x32</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">x32</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">x32</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB<span class="token punctuation">[</span><span class="token function">ramp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>inner<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          C<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>outer<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> C<span class="token punctuation">.</span>global<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_542"></a>总结</h3> 
<p>在仅使用18行代码应用上述简单优化之后，我们生成的代码可以使用MKL实现60％的numpy性能。<code>个人测试使用llvm -mcpu=core-avx2，可以优于numpy性能。</code></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/176c20cbb27ebb68fc84e0ffeb034e19/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">win10护眼色设置（注册表）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/62ec37f0d128bf67f9c1de423a2231d7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[算法] 深搜整理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>