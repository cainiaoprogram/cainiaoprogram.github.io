<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>分布式监控平台——Zabbix6.0 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="分布式监控平台——Zabbix6.0" />
<meta property="og:description" content="市场上常用的监控软件：
传统运维：zabbix、 Nagios云原生环境： Prometheus （go语言开发的） 一、zabbix概述 作为一个运维，需要会使用监控系统查看服务器状态以及网站流量指标，利用监控系统的数据去了解上线发布的结果，和网站的健康状态。
利用一个优秀的监控软件，我们可以：
通过一个友好的界面进行浏览整个网站所有的服务器状态可以在Web 前端方便的查看监控数据可以回溯寻找事故发生时系统的问题和报警情况 1 zabbix是什么? zabbix是一个基于Web界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。zabbix能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。zabbix由2部分构成，zabbix server 与可选组件zabbix agent。 通过c/s 模式采集数据，通过B/s模式在web端展示和配置。zabbix server 可以通过SNMP（简单网络管理协议），zabbix agent，ping， 端口监视等方法提供对远程服务器/网络状态的监视，数据收集等功能，它 可以运行在Linux等平台上。（支持多个平台，windows也支持）zabbix agent需要安装在被监视的目标服务器上，它主要完成对硬件信息或与操作系统有关的内存，CPU等信息的收集。 2. zabbix监控原理 zabbix agent安装在被监控的主机上，zabbix agent 负责定期收集客户端本地各项数据，并发送至zabbix server 端，zabbix server收到数据后，将数据存储到数据库中，用户基于zabbix WEB可以看到数据在前端展现图像。
当zabbix 监控某个具体的项目，该项目会设置一个触发器阈值，当被监控的指标超过该触发器设定的阈值，会进行一些必要的动作，动作包括：发送信息(邮件、微信、短信)、发送命令(shell 命令、reboot、 restart、 install 等)。
用户可以基于zabbix-web可以在WEBUI界面中查看展现的数据图像，以及进行相关的配置管理用户还可以在WEBUI界面中设置监控项的触发器，如被监控的数据指标超过触发器设定的阈值，会进行发送通知信息或者一些应急操作指令。
3. zabbix常见的五个程序 zabbix监控部署在系统中，包含常见的五个程序: zabbix server、 zabbix agent、 zabbix proxy、zabbix get、zabbix sender 等。
（1） zabbix server： zabbix 服务端守护进程，其中zabbix_agent、 zabbix_ get、zabbix_sender、 zabbix_proxy的数据最终都提交给zabbix server；
（2） zabbix agent： 客户端守护进程，负责收集客户端数据，例如:收集CPU负载、内存、硬盘使用情况等；
（3）zabbi xproxy： zabbix分布式代理守护进程，通常大于500台主机，需要进行分布式监控架构部署；" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3358f11a02a6609053fe8a501375a9f3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-30T18:48:05+08:00" />
<meta property="article:modified_time" content="2023-05-30T18:48:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">分布式监控平台——Zabbix6.0</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>市场上常用的监控软件：</p> 
<ul><li>传统运维：zabbix、 Nagios</li><li>云原生环境： Prometheus （go语言开发的）</li></ul> 
<h2>一、zabbix概述</h2> 
<p>作为一个运维，需要会使用监控系统查看服务器状态以及网站流量指标，利用监控系统的数据去了解上线发布的结果，和网站的健康状态。</p> 
<p>利用一个优秀的监控软件，我们可以：</p> 
<ul><li>通过一个友好的界面进行浏览整个网站所有的服务器状态</li><li>可以在Web 前端方便的查看监控数据</li><li>可以回溯寻找事故发生时系统的问题和报警情况</li></ul> 
<h3>1 zabbix是什么?</h3> 
<ul><li>zabbix是一个基于Web界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。</li><li>zabbix能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。</li><li>zabbix由2部分构成，zabbix server 与可选组件zabbix agent。 通过c/s 模式采集数据，通过B/s模式在web端展示和配置。</li><li>zabbix server 可以通过SNMP（简单网络管理协议），zabbix agent，ping， 端口监视等方法提供对远程服务器/网络状态的监视，数据收集等功能，它 可以运行在Linux等平台上。（支持多个平台，windows也支持）</li><li>zabbix agent需要安装在被监视的目标服务器上，它主要完成对硬件信息或与操作系统有关的内存，CPU等信息的收集。</li></ul> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/15/16/KRQefJYW_o.png"></p> 
<h3>2. zabbix监控原理</h3> 
<p>zabbix agent安装在被监控的主机上，zabbix agent 负责定期收集客户端本地各项数据，并发送至zabbix server 端，zabbix server收到数据后，将数据存储到数据库中，用户基于zabbix WEB可以看到数据在前端展现图像。</p> 
<p>当zabbix 监控某个具体的项目，该项目会设置一个触发器阈值，当被监控的指标超过该触发器设定的阈值，会进行一些必要的动作，动作包括：发送信息(邮件、微信、短信)、发送命令(shell 命令、reboot、 restart、 install 等)。</p> 
<p>用户可以基于zabbix-web可以在WEBUI界面中查看展现的数据图像，以及进行相关的配置管理用户还可以在WEBUI界面中设置监控项的触发器，如被监控的数据指标超过触发器设定的阈值，会进行发送通知信息或者一些应急操作指令。</p> 
<h3>3. zabbix常见的五个程序</h3> 
<p>zabbix监控部署在系统中，包含常见的五个程序: zabbix server、 zabbix agent、 zabbix proxy、zabbix get、zabbix sender 等。</p> 
<p>（1） <strong>zabbix server：</strong> zabbix 服务端守护进程，其中zabbix_agent、 zabbix_ get、zabbix_sender、 zabbix_proxy的数据最终都提交给zabbix server；</p> 
<p>（2） <strong>zabbix agent：</strong> 客户端守护进程，负责收集客户端数据，例如:收集CPU负载、内存、硬盘使用情况等；</p> 
<p>（3）<strong>zabbi xproxy：</strong> zabbix分布式代理守护进程，通常大于500台主机，需要进行分布式监控架构部署；</p> 
<p>（4）<strong>zabbix get：</strong> zabbix 数据接收工具，单独使用的命令，通常在server 或者proxy端执行获取远程客户端信息的命令；</p> 
<p>（5）<strong>zabbix sender：</strong> zabbix 数据发送工具，用户发送数据给server 或proxy端，通常用户耗时比较长的检查。</p> 
<h3>4. zabbix端口号</h3> 
<ul><li>zabbix服务端zabbix_server 默认使用10051 端口。</li><li>客户端zabbix_agent2 默认使用10050 端口。</li></ul> 
<p></p> 
<h2>二、Zabbix 6.0 新特性：</h2> 
<p><strong>1、Zabbix server高可用防止硬件故障或计划维护期的停机：</strong><br> •原生选择加入HA群集配置<br> •定义一个或多个备用节点<br> •实时监控Zabbix server群集节点的状态<br> •不需要外部工具即可将Zabbix server配置为HA群集模式</p> 
<p><strong>2、Zabbix 6.0 LTS新增Kubernetes监控功能，可以在Kubernetes系统从多个维度采集指标：</strong><br> •Kubernetes节点和pods的自动发现和监控<br> •无代理方式采集Kubernetes pods和节点的信息<br> •获取Kubernetes节点主机高水平信息</p> 
<p></p> 
<h2>三、Zabbix 6.0 功能组件：</h2> 
<p><strong>●Zabbix Server</strong><br> zabbix 服务端守护进程，是 Zabbix 软件的核心组件，Zabbix Agent 向其报告可用性、系统完整性信息和统计信息。<br> Zabbix Server 也是存储所有配置信息、统计信息和操作信息的核心存储库。<br> Zabbix Server 也是 Zabbix 监控系统的告警中心。在监控的系统中出现任何异常，将发出通知给管理员。</p> 
<p>基本的 Zabbix Server 的功能分解成为三个不同的组件。他们是：Zabbix server、Web 前端、数据库。</p> 
<p>Zabbix 的所有配置信息都存储在 Server 和 Web 前端进行交互的数据库中。例如，当你通过 Web 前端（或者API）新增一个监控项时， 它会被添加到数据库的监控项表里。然后，Zabbix server 以每分钟一次的频率查询监控项表中的有效项，接着将它存储在 Zabbix server 中的缓存里。 这就是为什么 Zabbix 前端所做的任何更改需要花费两分钟左右才能显示在最新的数据段的原因。</p> 
<p><strong>●数据库</strong><br> 所有配置信息以及 Zabbix 采集到的数据都被持久存储在数据库中。<br> 可以支持 MySQL、PostgreSQL、Oracle、DB2、TimescaleDB 等多种数据库。</p> 
<p><strong>●Web 界面</strong><br> Web 界面是 Zabbix Server 的一部分，用于实现展示和配置的界面。通常（但不一定）和 Zabbix server 运行在同一台物理机器上。<br> 基于 Apache/Nginx + PHP 实现，早期只支持 LAMP 架构，从 Zabbix5.0 开始支持 LNMP 。</p> 
<p><strong>●Zabbix Agent</strong><br> 客户端守护进程，部署在被监控目标上，用于主动监控本地资源和应用程序，并将收集的数据发送给 Zabbix Server。从 Zabbix5.0 开始支技 Zabbix Agent2 。</p> 
<p><strong>●Zabbix Proxy</strong><br> zabbix 分布式代理守护进程，可以代替 Zabbix Server 采集性能和可用性数据。Zabbix Proxy 在 Zabbix 的部署是可选部分。<br> Zabbix Proxy 的部署可以很好的分担单个 Zabbix Server 的负载。<br> 通常监控大于 500 台主机时使用，需要进行分布式监控架构部署。</p> 
<p style="text-align:center;"><strong>●Java Gateway</strong><br> Zabbix 要监控 Tomcat 服务或其它 JAVA 程序（比例 Elasticsearch、ZooKeeper），需要使用 Java Gateway 做为代理，才能从 JAVA 程序中获取数据。<br><img alt="" src="https://images2.imgbox.com/cd/ef/qL5NEiRl_o.jpg"></p> 
<p></p> 
<p></p> 
<h2>四、安装zabbix6.0</h2> 
<p>●系统：CentOS 7 不支持 yum 方式安装 Zabbix 6.0 服务端</p> 
<p>●安装方式：Zabbix 服务端采用编译安装的方式，zabbix 客户端采用 yum 安装的方式<br>  </p> 
<p><strong>实验环境：</strong></p> 
<table><thead><tr><th>节点</th><th>IP</th><th>安装服务</th></tr></thead><tbody><tr><td>zabbix-server</td><td>192.168.126.21</td><td>zabbix-server-mysql、zabbix-agent</td></tr><tr><td>zabbix-agent</td><td>192.168.126.22</td><td>zabbix-agent2</td></tr></tbody></table> 
<h3>1.部署 zabbix 服务端</h3> 
<pre><code class="language-sql">#关闭 selinux 与防火墙
systemctl disable --now firewalld
setenforce 0
hostnamectl set-hostname zbx-server


#部署 Nginx + PHP 环境并测试
#安装 nginx
cat &gt; /etc/yum.repos.d/nginx.repo &lt;&lt; 'EOF'
[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
EOF

yum install -y nginx

#安装 php
curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
yum install -y epel-release
rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm
yum -y install php72w php72w-cli php72w-common php72w-devel php72w-embedded php72w-gd php72w-mbstring php72w-pdo php72w-xml php72w-fpm php72w-mysqlnd php72w-opcache php72w-ldap php72w-bcmath

#修改 nginx 配置
vim /etc/nginx/conf.d/zbx.conf
server {
  listen 80;
  server_name zbx.kgc.com;
  root /var/www/zbx;
  
  location / {
    index index.php;
  }
  
  location ~ \.php$ {
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME /var/www/zbx$fastcgi_script_name;
    include fastcgi_params;
  }
}

#修改 php 配置
vim /etc/php-fpm.d/www.conf
user = nginx
group = nginx

vim /etc/php.ini
max_execution_time = 300		# 368行
max_input_time = 600			# 378行
post_max_size = 80M				# 656行
date.timezone = Asia/Shanghai	# 877行

#创建目录和测试文件
mkdir -p /var/www/zbx

vim /var/www/zbx/index.php
&lt;?php
phpinfo();
?&gt;

#启动服务
systemctl enable --now nginx php-fpm

#测试访问（hosts解析）
修改 C:\Windows\System32\drivers\etc\hosts
192.168.126.21 zbx.kgc.com

浏览器访问：http://zbx.kgc.com/index.php


//部署数据库，要求 MySQL 5.7 或 Mariadb 10.5 及以上版本
#配置 Mariadb yum源
cat &gt; /etc/yum.repos.d/mariadb.repo &lt;&lt; EOF
[mariadb]
name = MariaDB
baseurl = http://mirrors.aliyun.com/mariadb/yum/10.5/centos7-amd64/
gpgkey = http://mirrors.aliyun.com/mariadb/yum/RPM-GPG-KEY-MariaDB
gpgcheck = 1
enabled=1
EOF

yum install -y mariadb-server mariadb

systemctl enable --now mariadb

#初始化数据库
mysql_secure_installation
分别输入 回车 -&gt; n -&gt; Y (设置root密码，如abc123) -&gt; 后面一路 Y

mysql -u root -pabc123

#创建数据库并指定字符集
CREATE DATABASE zabbix character set utf8 collate utf8_bin;

#创建 zabbix 数据库用户并授权
GRANT all ON zabbix.* TO 'zabbix'@'localhost' IDENTIFIED BY 'zabbix';
GRANT all ON zabbix.* TO 'zabbix'@'%' IDENTIFIED BY 'zabbix';
flush privileges;

#向数据库导入 zabbix 数据
上传源码包 zabbix-6.0.13.tar.gz 到 /opt 目录
cd /opt
tar xf zabbix-6.0.13.tar.gz

ls /opt/zabbix-6.0.13/database/mysql
data.sql  double.sql  history_pk_prepare.sql  images.sql  Makefile.am  Makefile.in  schema.sql

#按照顺利导入数据库
cd /opt/zabbix-6.0.13/database/mysql
mysql -uroot -pabc123 zabbix &lt; schema.sql
mysql -uroot -pabc123 zabbix &lt; images.sql
mysql -uroot -pabc123 zabbix &lt; data.sql
mysql -uroot -pabc123 zabbix &lt; double.sql
mysql -uroot -pabc123 zabbix &lt; history_pk_prepare.sql


//编译安装 zabbix Server 服务端
#安装依赖包，创建 zabbix 用户
yum install -y mysql-devel pcre-devel openssl-devel zlib-devel libxml2-devel net-snmp-devel net-snmp libssh2-devel OpenIPMI-devel libevent-devel openldap-devel libcurl-devel fping gcc gcc-c++ make

useradd -s /sbin/nologin -M zabbix

#编译安装
cd /opt/zabbix-6.0.13/

./configure \
--sysconfdir=/etc/zabbix/ \
--enable-server \
--with-mysql \
--with-net-snmp \
--with-libxml2 \
--with-ssh2 \
--with-openipmi \
--with-zlib \
--with-libpthread \
--with-libevent \
--with-openssl \
--with-ldap \
--with-libcurl \
--with-libpcre

make install

#检查版本
zabbix_server --version
zabbix_server (Zabbix) 6.0.13

#修改 zabbix server 配置文件，修改数据库的密码
vim /etc/zabbix/zabbix_server.conf 
......
LogFile=/var/log/zabbix_server.log		# 38行，指定 zabbix 日志路径
DBPassword=zabbix					# 123行，指定 zabbix 数据库的密码

#准备 systemctl 服务管理文件
cat &gt; /usr/lib/systemd/system/zabbix-server.service &lt;&lt; EOF
[Unit]
Description=Zabbix Server with MySQL DB
After=syslog.target network.target mysqld.service

[Service]
Type=simple
ExecStart=/usr/local/sbin/zabbix_server -f
User=zabbix

[Install]
WantedBy=multi-user.target
EOF

创建日志文件然后加载
mkdir -p /var/log/zabbix_server
chown zabbix.zabbix /var/log/zabbix_server
systemctl daemon-relead
systemctl enable --now zabbix-server

netstat -lntp | grep 10051			#zabbix_server 默认监听 10051 端口


//部署 Web 前端，进行访问
cp -r /opt/zabbix-6.0.13/ui/* /var/www/zbx

chown -R nginx.nginx /var/www/zbx

浏览器访问：http://zbx.kgc.com/ 
【Default language】选择 Chinese(zh_CN)，点击下一步
【密码】输入 zabbix，点击下一步
【Zabbix主机名称】输入 Zabbix-监控；【默认时区】选择 Asia/Shanghai，点击下一步

安装完成后，默认的登录账号和密码为：Admin/zabbix


//安装 zabbix 客户端，实现 zabbix 服务端自我监控
rpm -ivh https://repo.zabbix.com/zabbix/6.0/rhel/7/x86_64/zabbix-release-6.0-4.el7.noarch.rpm
sed -i 's#https://repo.zabbix.com#https://mirrors.aliyun.com/zabbix#' /etc/yum.repos.d/zabbix.repo

#zabbix 5.0 版本开始采用 golang 语言开发的新版本客户端 agent2
yum install -y zabbix-agent2

systemctl enable --now zabbix-agent2

netstat -lntp | grep 10050			#客户端 zabbix_agent2 默认监听 10050 端口


//解决 zabbix-server Web页面中文乱码问题
yum install -y wqy-microhei-fonts

\cp -f /usr/share/fonts/wqy-microhei/wqy-microhei.ttc /var/www/zbx/assets/fonts/DejaVuSans.ttf

刷新浏览器页面
</code></pre> 
<h3>2.添加 zabbix 客户端主机</h3> 
<pre><code class="language-sql">systemctl disable --now firewalld
setenforce 0
hostnamectl set-hostname zbx-agent01


//服务端和客户端都配置时间同步
yum install -y ntpdate
ntpdate -u ntp.aliyun.com


//服务端和客户端都设置 hosts 解析
cat &gt; /etc/hosts &lt;&lt; EOF
192.168.126.21 zbx-server
192.168.126.22 zbx-agent01
EOF


//设置 zabbix 的下载源，安装 zabbix-agent2
rpm -ivh https://repo.zabbix.com/zabbix/6.0/rhel/7/x86_64/zabbix-release-6.0-4.el7.noarch.rpm
sed -i 's#https://repo.zabbix.com#https://mirrors.aliyun.com/zabbix#' /etc/yum.repos.d/zabbix.repo

yum install -y zabbix-agent2


//修改 agent2 配置文件
vim /etc/zabbix/zabbix_agent2.conf
......
Server=192.168.126.21			#80行，指定 zabbix 服务端的 IP 地址
ServerActive=192.168.126.21		#133行，指定 zabbix 服务端的 IP 地址
Hostname=zbx-agent01			#144行，指定当前 zabbix 客户端的主机名</code></pre> 
<h3>3.启动 zabbix-agent2，在服务端验证 zabbix-agent2 的连通性</h3> 
<pre><code class="language-sql">#启动 zabbix-agent2
systemctl start zabbix-agent2
systemctl enable zabbix-agent2

netstat -natp | grep zabbix
tcp6       0      0 :::10050                :::*                    LISTEN      43654/zabbix_agent2 


#在服务端验证 zabbix-agent2 的连通性
yum install -y zabbix-get				#安装 zabbix 主动获取数据的命令

zabbix_get -s '192.168.126.22' -p 10050 -k 'agent.ping'
1

zabbix_get -s '192.168.126.22' -p 10050 -k 'system.hostname'
zbx-agent01


#常用的键值
agent.ping												#服务端与客户端是否连通，返回1表示可达，返回非表示不可达
system.hostname											#系统主机名
agent.hostname											#客户端主机名
net.if.in[if,&lt;mode&gt;]									#网络接口进入的流量统计，if表示网卡名称，带&lt;&gt;的参数表示可以省略
net.if.out[if,&lt;mode&gt;]									#网络接口流出的流量统计
proc.num[&lt;name&gt;,&lt;user&gt;,&lt;state&gt;,&lt;cmdline&gt;,&lt;zone&gt;]		#进程数
net.tcp.port[&lt;ip&gt;,port]									#检查是否能建立tcp连接到指定端口，返回0表示不能连接，返回1表示可以连接
</code></pre> 
<h3>4.将客户端加入服务端的监控主机中，在 Web 页面中添加 agent 主机</h3> 
<pre><code class="language-sql">点击左边菜单栏【配置】中的【主机】，点击【创建主机】
【主机名称】输入 zbx-agent01
【可见的名称】输入 zbx-agent01-192.168.126.22
【模板】搜索 Linux ，选择 Linux by Zabbix agent
【群组】选择 Linux servers
【Interfaces】点击添加 客户端，【IP地址】输入 192.168.126.22


2.再点击上方菜单栏【模板】
 【Link new tamplates】搜索 Linux ，选择 Template OS Linux by Zabbix agent
 点击 【添加】

#监控模板下载地址
https://share.zabbix.com/
https://monitoringartist.github.io/zabbix-searcher/
https://git.zabbix.com/projects/ZBX/repos/zabbix/browse/templates</code></pre> 
<p><strong>zabbix工作原理（工作流程）：</strong></p> 
<ul><li>zabbix-agent 客户端，部署在被监控的对象主机上，负责定期收集监控数据，发送给zabbix-server 端；</li><li>zabbix-server 收到数据后会将数据存储在数据库中。</li><li>用户可以基于zabbix-web可以在WEB UI界面中查看展现的数据图像，以及进行相关的配置管理 用户还可以在WEBUI界面中设置监控项的触发器，如被监控的数据指标超过触发器设定的阈值，会进行发送通知信息或者一些应急操作指令。</li></ul> 
<p></p> 
<h2>五、自定义监控内容</h2> 
<p>案列：自定义监控客户端服务器登录的人数<br> 需求：限制登录人数不超过 3 个，超过 3 个就发出报警信息</p> 
<h4>在客户端创建自定义 key<br> 1.明确需要执行的 linux 命令</h4> 
<pre><code class="language-sql">who | wc -l
</code></pre> 
<h4>2.创建 zabbix 的监控项配置文件，用于自定义 key</h4> 
<pre><code class="language-sql">vim /etc/zabbix/zabbix_agent2.conf
#可以将自定义的监控项配置文件创建在 zabbix_agent2.d 目录中
281 Include=/etc/zabbix/zabbix_agent2.d/*.conf
#自定义监控项的格式如下
321 #	Format: UserParameter=&lt;key&gt;,&lt;shell command&gt;

cd /etc/zabbix/zabbix_agent2.d/

vim UserParameter_login.conf
UserParameter=login.user,who|wc -l

systemctl restart zabbix-agent2
</code></pre> 
<h4>3.在服务端验证新建的监控项</h4> 
<pre><code class="language-sql">zabbix_get -s '192.168.126.22' -p 10050 -k 'login.user'
</code></pre> 
<h4>4.在 Web 页面创建自定义监控项模板</h4> 
<p><strong>1).创建模板</strong><br> 点击左边菜单栏【配置】中的【模板】，点击【创建模板】<br> 【模板名称】设置成 Template Login User<br> 【可见的名称】设置成 Template Login User<br> 【群组】选择 Template<br> 【描述】可自定义<br> 点击 【添加】，此时就可在【名称】中搜索到 Template Login User 了</p> 
<p><br><strong>2).创建监控项</strong><br> 点击 Template Login User 模板进入<br> 点击上方菜单栏【监控项】，点击【创建监控项】<br> 【名称】设置成 Number of login users<br> 【键值】设置成 login.user            #键值必须要与自定义的监控项配置文件中设置的保持一致<br> 【更新间隔】设置成 10s<br> 【历史数据保留时长】Storage period    30d        #保留时间可自定义设置<br> 点击 【添加】</p> 
<p><strong>3).创建触发器（当监控项获取到监控的值后和触发器预设的值进行对比，判断是否报警）</strong><br> 点击上方菜单栏【触发器】，点击【创建触发器】<br> 【名称】设置成 Number of login users is greater than 3<br> 【严重性】设置成 一般严重        #根据严重程度可自定义设置<br> 【表达式】点击添加，【监控项】点击选择 Number of login users，【功能】选择 last()，【结果】选择 &gt; 3，点击 【插入】<br> 点击 【添加】</p> 
<p><strong>4).创建图形</strong><br> 点击上方菜单栏【图形】，点击【创建图形】<br> 【名称】设置成 Number of login users<br> 【宽】、【高】可直接采用默认值<br> 【监控项】点击添加勾选相关监控项 Number of login users，【功能】选择 最大，其它可保持默认值<br> 点击 【添加】</p> 
<p><strong>5).将主机与模板关联起来（一个主机可以关联多个模板）</strong><br> 点击左边菜单栏【配置】中的【主机】，点击你要关联的主机<br> 【模板】搜索 login，选择 Template Login User，点击【更新】</p> 
<p>此时就点击【监测】中的【主机】，点击你关联主机的【图形】，即可查看到相关的监控项指标</p> 
<p><strong>6).设置邮件报警</strong><br> 点击左边菜单栏【管理】中的【报警媒介类型】，点击【创建媒体类型】<br> 【名称】设置成 qq_Email<br> 【SMTP服务器】设置成 smtp.qq.com<br> 【SMTP服务器端口】设置成 25<br> 【SMTP HELO】设置成 qq.com<br> 【SMTP电邮】设置成 自己的邮箱地址，例如 qwe4546456@qq.com<br> 【认证】选择 用户名和密码<br> 【用户名称】设置成 自己的邮箱地址，例如 qwe4546456@qq.com<br> 【密码】可登录QQ邮箱页面，点击【设置】--&gt;【账户】中的【生成授权码】，通过短信获取授权码<br> 【描述】可自定义<br> 点击上方菜单栏【Message templates】，点击【添加】，【Message type】选择 问题，点击【更新】<br> 点击 【添加】，并测试功能</p> 
<p>点击左边菜单栏【User settings】--&gt;【Profile】--&gt;【报警媒介】，点击【添加】<br> 【类型】选择 qq_Email<br> 【收件人】设置成 qwe4546456@wo.cn<br> 【当启用时】设置成 1-7,00:00-24:00<br> 【如果存在严重性则使用】勾选需要的严重性<br> 点击 【添加】<br> 再点击 【更新】</p> 
<p>点击左边菜单栏【配置】-&gt;【动作】-&gt;【Trigger actions】<br> 选择相对应的动作名称点击进入，点击 【添加】<br> 【类型】选择 触发器，【操作者】选择 等于，【触发器】点击选择 Nunber of login users is greater than 3<br> 点击【添加】<br> 勾选 【已启动】<br> 点击 【更新】</p> 
<p><br> //测试邮件报警<br> 增加测试客户端的用户登录数超过触发器预设的值，查看【监测】--&gt;【仪表板】，确认报警<br>  </p> 
<p></p> 
<h2>六、zabbix 自动发现与自动注册</h2> 
<h4>zabbix 自动发现（对于 agent2 是被动模式）</h4> 
<p>zabbix server 主动的去发现所有的客户端，然后将客户端的信息登记在服务端上。<br> 缺点是如果定义的网段中的主机数量多，zabbix server 登记耗时较久，且压力会较大</p> 
<pre><code class="language-sql">systemctl disable --now firewalld
setenforce 0
hostnamectl set-hostname zbx-agent02

2.在 Web 页面删除原有的客户端主机
点击左边菜单栏【配置】中的【主机】，勾选原有的客户端主机，点击 删除


3.在服务端和客户端上配置 hosts 解析
vim /etc/hosts
192.168.126.21 zbx-server
192.168.126.22 zbx-agent01
192.168.126.23 zbx-agent02


4.在 Web 页面配置自动发现
点击左边菜单栏【配置】中的【自动发现】，点击【创建发现规则】
【名称】设置成 mynetwork
【IP范围】设置成 192.168.126.1-254
【更新间隔】设置成 30s
【检查】点击【添加】，【检查类型】选择 Zabbix 客户端，【端口范围】设置成 10050，【键值】设置成 system.uname
【设备唯一性准则】选择 IP地址
【主机名称】选择 DNS名称
【可见的名称】选择 主机名称
勾选 【已启用】，点击 【添加】

点击左边菜单栏【配置】中的【动作】，上方菜单选择 【发现动作】
勾选 【Auto discovery. Linux servers.】，点击 【启用】

点击左边菜单栏【配置】中的【主机】刷新，等待一段时间后即可刷新出自动发现的客户端主机

可在服务端查看 zabbix 日志
tail -f /var/log/zabbix_server.log
......
  6601:20210922:225044.115 enabling Zabbix agent checks on host "zbx-agent02": interface became available</code></pre> 
<h4>zabbix 自动注册（对于 agent2 是主动模式）</h4> 
<p>zabbix agent2 会主动上报自己的信息，发给 zabbix server。<br> 缺点是可能因为配置文件配置错误或者网络不通等原因导致 zabbix agent2 可能找不到 zabbix server。</p> 
<p><strong>1.环境准备</strong><br> 点击左边菜单栏【配置】中的【发现动作】，勾选发现规则，点击 禁用<br> 点击左边菜单栏【配置】中的【主机】，勾选原有的客户端主机，点击 删除</p> 
<pre><code class="language-sql">vim /etc/hosts
192.168.126.21 zbx-server
192.168.126.22 zbx-agent01
192.168.126.23 zbx-agent02
</code></pre> 
<p><strong>2.修改 zabbix-agent2 配置文件</strong></p> 
<pre><code class="language-sql">vim /etc/zabbix/zabbix_agent2.conf
......
HostnameItem=system.hostname		#152行，取消注释

egrep -v "^#|^$" /etc/zabbix/zabbix_agent2.conf 
PidFile=/var/run/zabbix/zabbix_agent2.pid
LogFile=/var/log/zabbix/zabbix_agent2.log
LogFileSize=0
Server=192.168.126.21
ServerActive=192.168.126.21
Hostname=zbx-agent01
HostnameItem=system.hostname
Include=/etc/zabbix/zabbix_agent2.d/*.conf
ControlSocket=/tmp/agent.sock

systemctl restart zabbix-agent2</code></pre> 
<p><strong>3.在 Web 页面配置自动注册</strong></p> 
<p>点击左边菜单栏【配置】中的【动作】，上方菜单选择 【自动注册动作】，点击【创建动作】<br> 【名称】设置成 Auto registration<br> 点击 【添加】，【类型】选择 主机名称，【操作者】选择 包含，【值】设置成 zbx-agent<br> 点击上方菜单栏【操作】，点击【添加】，【操作类型】选择 添加主机，点击 【Add】<br> 再点击【添加】，【操作类型】选择 添加到主机群组，【主机群组】选择 Linux servers，点击 【Add】<br> 再点击【添加】，【操作类型】选择 与模板关联，【模板】搜索 Linux，选择 Linux by Zabbix agent，点击 【Add】<br> 点击下方的【添加】</p> 
<p>等待一段时间后，点击左边菜单栏【配置】中的【主机】刷新，即可刷新出自动发现的客户端主机</p> 
<p>在服务端查看 zabbix 日志<br> tail -f /var/log/zabbix_server.log</p> 
<h3></h3> 
<h3>部署 zabbix 代理服务器</h3> 
<p>分布式监控的作用：<br> ●分担 server 的集中式压力<br> ●解决多机房之间的网络延时问题</p> 
<p>agent --&gt; proxy --&gt; server</p> 
<pre><code class="language-sql">systemctl disable --now firewalld
setenforce 0
hostnamectl set-hostname zbx-proxy</code></pre> 
<p><strong>设置 zabbix 的下载源，安装 zabbix-proxy</strong></p> 
<pre><code class="language-sql">rpm -ivh https://repo.zabbix.com/zabbix/6.0/rhel/7/x86_64/zabbix-release-6.0-4.el7.noarch.rpm
sed -i 's#https://repo.zabbix.com#https://mirrors.aliyun.com/zabbix#' /etc/yum.repos.d/zabbix.repo

yum install -y zabbix-proxy-mysql zabbix-sql-scripts zabbix-selinux-policy</code></pre> 
<p><strong>部署数据库，要求 MySQL 5.7 或 Mariadb 10.5 及以上版本</strong></p> 
<pre><code class="language-sql">#配置 Mariadb yum源
cat &gt; /etc/yum.repos.d/mariadb.repo &lt;&lt; EOF
[mariadb]
name = MariaDB
baseurl = http://mirrors.aliyun.com/mariadb/yum/10.5/centos7-amd64/
gpgkey = http://mirrors.aliyun.com/mariadb/yum/RPM-GPG-KEY-MariaDB
gpgcheck = 1
enabled=1
EOF

yum install -y mariadb-server mariadb

systemctl enable --now mariadb</code></pre> 
<pre><code class="language-sql">#初始化数据库
mysql_secure_installation
分别输入 回车 -&gt; n -&gt; Y (设置root密码，如abc123) -&gt; 后面一路 Y

mysql -u root -pabc123


#创建数据库并指定字符集
CREATE DATABASE zabbix_proxy character set utf8 collate utf8_bin;


#创建 zabbix 数据库用户并授权
GRANT all ON zabbix_proxy.* TO 'zabbix'@'localhost' IDENTIFIED BY 'zabbix';
GRANT all ON zabbix_proxy.* TO 'zabbix'@'%' IDENTIFIED BY 'zabbix';
FLUSH PRIVILEGES;</code></pre> 
<p><strong>导入数据库信息</strong></p> 
<pre><code class="language-sql">rpm -ql zabbix-sql-scripts 		#查询 sql 文件的位置

cat /usr/share/zabbix-sql-scripts/mysql/proxy.sql | mysql -uroot -pabc123 zabbix_proxy</code></pre> 
<p><strong>修改 zabbix-proxy 配置文件</strong></p> 
<pre><code class="language-sql">vim /etc/zabbix/zabbix_proxy.conf
Server=192.168.126.21				#32行，指定 zabbix 服务端的 IP 地址
Hostname=zbx-proxy					#42行，指定当前 zabbix 代理服务器的主机名
DBPassword=zabbix					#194行，指定当前数据库 zabbix 用户的密码




启动 zabbix-proxy
systemctl start zabbix-proxy
systemctl enable zabbix-proxy</code></pre> 
<p><strong>在所有主机上配置 hosts 解析</strong></p> 
<pre><code class="language-sql">vim /etc/hosts
192.168.126.21 zbx-server
192.168.126.22 zbx-agent01
192.168.126.24 zbx-proxy</code></pre> 
<p><strong>在 Web 页面配置 agent 代理</strong><br> 点击左边菜单栏【配置】中的【动作】，勾选自动注册规则，点击 禁用<br> 点击左边菜单栏【配置】中的【主机】，勾选原有的客户端主机，点击 删除</p> 
<p>点击左边菜单栏【管理】中的【agent代理程序】，点击【创建代理】<br> 【agent代理程序名称】输入 zbx-proxy<br> 【系统代理程序模式】选择 主动式<br> 【代理地址】输入 192.168.126.24<br> 点击 【添加】</p> 
<p><strong>配置 agent 使用 proxy</strong></p> 
<pre><code class="language-sql">在客户端修改 agent2 配置文件
vim /etc/zabbix/zabbix_agent2.conf
......
Server=192.168.126.24			#80行，指定 zabbix 代理服务器的 IP 地址
ServerActive=192.168.126.24		#120行，指定 zabbix 代理服务器的 IP 地址</code></pre> 
<p><strong>在 Web 页面配置</strong><br> 点击左边菜单栏【配置】中的【主机】，点击【创建主机】<br> 【主机名称】输入 zbx-agent01<br> 【可见的名称】输入 zbx-agent01<br> 【模板】搜索 Linux ，选择 Linux by Zabbix agent<br> 【群组】选择 Linux server<br> 【Interfaces】选择 客户端，【IP地址】输入 192.168.126.22，【端口】输入 10050<br> 【由agent代理程序监测】选择 zbx-proxy<br> 点击 【添加】</p> 
<pre><code class="language-sql">分别在客户端和代理服务器上重启服务
systemctl restart zabbix-agent2

systemctl restart zabbix-proxy</code></pre> 
<p>等待一段时间后，点击左边菜单栏【配置】中的【主机】刷新，查看客户端主机监控状态正常<br> 在服务端查看日志<br> tail -f /var/log/zabbix/zabbix_proxy.log</p> 
<p></p> 
<h3>部署 Zabbix 高可用集群</h3> 
<p>官方的高可用仅仅针对 Zabbix Server 部分，数据库部分和前端部分需要自行采用各自领域的高可用解决方案</p> 
<p><strong>服务端配置</strong><br> 默认情况下，HA 是关闭的。HA 部分的配置在配置文件的最下面：High availability cluster parameters 部分。</p> 
<pre><code class="language-sql">主节点 Zabbix Server 配置
vim /etc/zabbix/zabbix_server.conf
......
DBHost=192.168.126.21
DBName=zabbix
DBUser=zabbix
DBPassword=zabbix
......
HANodeName=zbx-server01					#设置为当前节点主机名
NodeAddress=192.168.126.21:10051			#设置为节点IP


systemctl restart zabbix-server



#主节点给数据库授权远程登录权限
mysql -uroot -pabc123
GRANT all ON zabbix.* TO 'zabbix'@'%' IDENTIFIED BY 'zabbix';
FLUSH PRIVILEGES;


#备节点 Zabbix Server 配置
vim /etc/zabbix/zabbix_server.conf
......
DBHost=192.168.126.21
DBName=zabbix
DBUser=zabbix
DBPassword=zabbix
......
HANodeName=zbx-server02
NodeAddress=192.168.126.21:10051


systemctl restart zabbix-server</code></pre> 
<p><strong>客户端配置</strong></p> 
<pre><code class="language-sql">vim /etc/zabbix/zabbix_agentd.conf 
......
Server=192.168.126.21,192.168.126.22
ServerActive=192.168.126.21;192.168.126.22		#注意，ServerActive 的连接符是‘;’ ，而不是‘,’</code></pre> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6720dd29300072b0c9f7960e7fe777ac/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python数据分析学习笔记—python基础知识</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f0a292cca60ed0feac3248c10e5ff508/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue--如何自己实现双向数据绑定v-model ？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>