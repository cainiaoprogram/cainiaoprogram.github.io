<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>DPDK环境搭建 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="DPDK环境搭建" />
<meta property="og:description" content="一、版本的选择 首先要说明的是，对于生产来说DPDK版本不是越高越好，如何选择合适的版本？
1、要选择长期支持的版本LTS（Long Term Support）
2、根据当前开发的系统环境选择
可以在以下文档里从高至低查看不同版本的System Requirements章节，它对kernel、glibc等限制有详细说明。
DPDK
我开发是在CentOS7.3 64位，最后选用dpdk-18.11版本。如果你的软件需要同时在不同系统运行，选对版本后续能省不少事。
二、虚拟机配置要求 我使用vmware虚拟机，调研了几款虚拟机发现在windows下只能vmware能模拟出多队列的网卡，如果有发现其他虚拟机能模拟请给我留言。
1、核心：我配置4个。至少有2个以上核心，方便后续程序做线程孤立和绑定。
2、内存：我一般配置3G，为了配置hugepage，多分点比较好。可根据实际情况配置。
3、网卡：需要支持dpdk，我选择vmnet3，它支持多队列。端口至少2个以上，且要求驱动为dpdk支持的，
三、dpdk的安装 1、下载源码
http://fast.dpdk.org/rel/dpdk-18.11.7.tar.xz
2、设置环境变量（18.11版本不需要）
旧版本安装时需要在dpdk根目录执行t以下命令，如果重新登录需要再执行一次，18.11版本不需要，安装脚本里写好了，这里只是记录以下。
64位系统：
export RTE_SDK=`pwd`
export RTE_TARGET=x86_64-native-linuxapp-gcc
32位系统：
export RTE_SDK=`pwd` export RTE_TARGET=i686-default-linuxapp-gcc
3、利用setup.sh进行配置
cd dpdk-stable-18.11.7/usertools
source ./dpdk-setup.sh
1）编译dpdk
编译完提示以下信息：查资料显示没有指定安装路径，我们只是编译而不是install就不用理会。
2）插入IGB UIO模块
3）设置大页内存
默认设置的是2M的大页内存，这里输入1024，表示申请2G的大页内存。由于虚拟机里只有一个node，这里只需要设置node0
查看配置的大页内存
4）查看网卡/加解密设备信息，这里我们只有网卡信息
若报以下错误，是因为没有安装lspci导致，安装解决：yum install pciutils -y
Traceback (mostrecent call last): File&#34;/root/dpdk-16.07/tools/dpdk-devbind.py&#34;, line 576, in &lt;module&gt; main() File&#34;/root/dpdk-16.07/tools/dpdk-devbind.py&#34;, line 572, in main get_nic_details() File&#34;/root/dpdk-16.07/tools/dpdk-devbind.py&#34;, line 248, inget_nic_details dev_lines =check_output([&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/80b55c0392157bb32196ba30f6ded733/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-09T15:51:12+08:00" />
<meta property="article:modified_time" content="2022-02-09T15:51:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">DPDK环境搭建</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>一、版本的选择</h3> 
<p>首先要说明的是，对于生产来说DPDK版本不是越高越好，如何选择合适的版本？</p> 
<p><strong>1、要选择长期支持的版本LTS（Long Term Support）</strong></p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/50/f2/jWWWFMX4_o.png"></p> 
<p><strong>2、根据当前开发的系统环境选择</strong></p> 
<p>可以在以下文档里从高至低查看不同版本的System Requirements章节，它对kernel、glibc等限制有详细说明。</p> 
<p><a href="http://core.dpdk.org/doc/archives/" rel="nofollow" title="DPDK">DPDK</a></p> 
<p>我开发是在CentOS7.3 64位，最后选用dpdk-18.11版本。如果你的软件需要同时在不同系统运行，选对版本后续能省不少事。</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/86/b9/oBON1m2N_o.png"></p> 
<h3>二、虚拟机配置要求</h3> 
<p>我使用vmware虚拟机，调研了几款虚拟机发现在windows下只能vmware能模拟出多队列的网卡，如果有发现其他虚拟机能模拟请给我留言。</p> 
<p>1、<strong>核心</strong>：我配置4个。至少有2个以上核心，方便后续程序做线程孤立和绑定。</p> 
<p>2、<strong>内存</strong>：我一般配置3G，为了配置hugepage，多分点比较好。可根据实际情况配置。</p> 
<p>3、<strong>网卡</strong>：需要支持dpdk，我选择vmnet3，它支持多队列。端口至少2个以上，且要求驱动为dpdk支持的，</p> 
<h3>三、dpdk的安装</h3> 
<p><strong>1、下载源码</strong></p> 
<p><a href="http://fast.dpdk.org/rel/dpdk-18.11.7.tar.xz" rel="nofollow" title="http://fast.dpdk.org/rel/dpdk-18.11.7.tar.xz">http://fast.dpdk.org/rel/dpdk-18.11.7.tar.xz</a></p> 
<p><strong>2、设置环境变量（18.11版本不需要）</strong></p> 
<p>旧版本安装时需要在dpdk根目录执行t以下命令，如果重新登录需要再执行一次，18.11版本不需要，安装脚本里写好了，这里只是记录以下。</p> 
<p>64位系统：</p> 
<p>export RTE_SDK=`pwd`</p> 
<p>export RTE_TARGET=x86_64-native-linuxapp-gcc</p> 
<p>32位系统：</p> 
<p>export RTE_SDK=`pwd` </p> 
<p>export RTE_TARGET=i686-default-linuxapp-gcc</p> 
<p><strong>3、利用setup.sh进行配置</strong></p> 
<p>cd dpdk-stable-18.11.7/usertools</p> 
<p>source ./dpdk-setup.sh</p> 
<p>1）编译dpdk</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/f1/fb/6itDI4ZU_o.png"></p> 
<p>编译完提示以下信息：查资料显示没有指定安装路径，我们只是编译而不是install就不用理会。</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/5a/5b/PYwnHBGt_o.png"></p> 
<p>2）插入IGB UIO模块</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/c9/8f/kZxLrNCy_o.png"></p> 
<p>3）设置大页内存</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/58/a6/hQVz4QcV_o.png"></p> 
<p>默认设置的是2M的大页内存，这里输入1024，表示申请2G的大页内存。由于虚拟机里只有一个node，这里只需要设置node0</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/f2/66/anrWKOdC_o.png"></p> 
<p>查看配置的大页内存</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/88/e1/2IIs4wKr_o.png"></p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/e2/39/SXkZL2ET_o.png"></p> 
<p>4）查看网卡/加解密设备信息，这里我们只有网卡信息</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/95/5c/xlkk4wJO_o.png"></p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/7e/34/RVXspU03_o.png"></p> 
<p>若报以下错误，是因为没有安装lspci导致，安装解决：yum install pciutils -y</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/ab/a5/KDuThO1M_o.gif"></p> 
<pre>Traceback (mostrecent call last):
  File"/root/dpdk-16.07/tools/dpdk-devbind.py", line 576, in &lt;module&gt;
    main()
  File"/root/dpdk-16.07/tools/dpdk-devbind.py", line 572, in main
    get_nic_details()
  File"/root/dpdk-16.07/tools/dpdk-devbind.py", line 248, inget_nic_details
    dev_lines =check_output(["lspci", "-Dvmmn"]).splitlines()
  File"/root/dpdk-16.07/tools/dpdk-devbind.py", line 125, in check_output
    stderr=stderr).communicate()[0]
  File "/usr/lib64/python2.7/             subprocess.py", line 711, in__init__
    errread, errwrite)
  File"/usr/lib64/python2.7/subprocess.py", line 1327, in _execute_child
    raise child_exception
OSError: [Errno 2]No such file or directory</pre> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/94/70/MjT6MmmX_o.gif"></p> 
<p>5）绑定设备</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/fe/86/oLgAy95r_o.png"></p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/99/f8/qYadWEW9_o.png"></p> 
<p>输入pci的地址， 输入0000冒号后面的几位输入就行了，这里将03:00.0和0b:00.0绑定。但我遇到过需要完整输入才能绑定的情况，如果绑定失败就都试试。</p> 
<p>注：绑定的时候可以能有个错误的提示如下；</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/c4/48/kv8ESQjH_o.png"></p> 
<p>因为是你当前的对应的网卡端口处于up状态，所以你要执行ifconfig xxx down命令将其关闭，关闭后再重新执行一下上面的绑定操作。注意为了跑测试用例至少要绑定两个端口</p> 
<p>再次查看，发现已经绑定到dpdk驱动了。</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/c1/a3/YjfS5StR_o.png"></p> 
<p>6）运行testpmd测试程序</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/53/a1/ZmTTJd3i_o.png"></p> 
<p>输入0xf代表程序运行在0~3核心</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/6d/c0/nNikBmFt_o.png"></p> 
<p>如果提示以下错误，是因为大页内存分配不够，尝试分配多一些再试，若还不行重启虚拟机再试试。</p> 
<p>testpmd: create a new mbuf pool &lt;mbuf_pool_socket_0&gt;: n=171456, size=2176, socket=0 testpmd: preferred mempool ops selected: ring_mp_mc EAL: Error - exiting with code: 1 Cause: Creation of mbuf pool for socket 0 failed: Cannot allocate memory</p> 
<p>start开始抓包， 用发包工具对网卡发包（我在windows下使用xcap对虚网卡发包）</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/9a/1d/XB6PuhAg_o.png"></p> 
<p>stop停止抓包，并查看收发情况</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/f3/ce/IE5kbvHL_o.png"></p> 
<p>这说明dpdk收到了1000个包，同时转发出去了1000个包，已正常运行。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9a2c37181926df2fa5d24545fc84161e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">17 个实用 shell 脚本</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/257f59c5a0ce3548e02345eb9a0f84d4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">matlab中统计数组中各数字（元素）出现的次数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>