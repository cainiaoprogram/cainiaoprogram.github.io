<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python subprocess模块 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Python subprocess模块" />
<meta property="og:description" content="https://www.pynote.net/archives/490
https://www.pynote.net/archives/2088
https://www.pynote.net/archives/1757
https://www.pynote.net/archives/1775
目录 介绍引入subprocess模块subprocess.run() 函数的使用subprocess.Popen()函数的使用用subprocess启动后台进程关于subprocess子进程的communicate函数实时获取subprocess子进程的输出 介绍 Python的subprocess模块，用来创建和管理子进程（不是线程），并能够与创建的子进程的stdin，stdout，stderr连接通信，获取子进程执行结束后的返回码，在执行超时或执行错误时得到异常。
从Python3.5版本开始，subprocess模块内部又进行了一次整合 ，最后就剩下官方推荐的两个接口函数，分别是：
subprocess.run() subprocess.Popen() run() 函数的使用场景更多，它的底层调用的是Popen函数，Popen函数更灵活，适合更复杂的场景。我们只要好好学习这两个函数接口的使用，就能够掌握subprocess模块的几乎所有功能。
引入subprocess模块 由于subprocess这个名字很长，考虑到这个模块对外接口的函数和对象名称都比较特别，本文就这样来引入吧：
&gt;&gt;&gt; from subprocess import * &gt;&gt;&gt; dir() [&#39;CalledProcessError&#39;, &#39;CompletedProcess&#39;, &#39;DEVNULL&#39;, &#39;PIPE&#39;, &#39;Popen&#39;, &#39;STDOUT&#39;, &#39;SubprocessError&#39;, &#39;TimeoutExpired&#39;, &#39;__annotations__&#39;, &#39;__builtins__&#39;, &#39;__doc__&#39;, &#39;__loader__&#39;, &#39;__name__&#39;, &#39;__package__&#39;, &#39;__spec__&#39;, &#39;call&#39;, &#39;check_call&#39;, &#39;check_output&#39;, &#39;getoutput&#39;, &#39;getstatusoutput&#39;, &#39;run&#39;] call，check_call，check_output，getoutput，getstatusoutput这些函数，都被run函数代替了，它们在存在只是为了保持向下兼容。从上面的打印还可以看出，subprocess这个模块提供的接口并不多。
subprocess.run() 函数的使用 run函数的作用是：执行args参数所表示的命令，等待命令执行完毕，返回一个CompletedProcess对象。注意，run函数是同步函数，要等待！
run()函数的接口参数：
subprocess.run(args, *, stdin=None, input=None, stdout=None, stderr=None, capture_output=False, shell=False, cwd=None, timeout=None, check=False, encoding=None, errors=None, text=None, env=None, universal_newlines=None) args参数，就是要通过创建进程而执行的命令及参数，run函数通过args来创建一个进程并执行。
shell参数，表示是否通过shell来执行命令（Linux下默认为/bin/sh），默认是False，这时args只能是一个不带参数的命令字符串，或者是命令和参数组成的一个list，如果shell=True，args就可以是一个我们常见的命令字符串。下面举例：
&gt;&gt;&gt; run(&#39;ls&#39;) acme." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/47c33ed21e814f25deae4ed437356828/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-31T15:42:32+08:00" />
<meta property="article:modified_time" content="2020-12-31T15:42:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python subprocess模块</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>https://www.pynote.net/archives/490<br> https://www.pynote.net/archives/2088<br> https://www.pynote.net/archives/1757<br> https://www.pynote.net/archives/1775</p> 
</blockquote> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#_7" rel="nofollow">介绍</a></li><li><a href="#subprocess_17" rel="nofollow">引入subprocess模块</a></li><li><a href="#subprocessrun__28" rel="nofollow">subprocess.run() 函数的使用</a></li><li><a href="#subprocessPopen_205" rel="nofollow">subprocess.Popen()函数的使用</a></li><li><a href="#subprocess_298" rel="nofollow">用subprocess启动后台进程</a></li><li><a href="#subprocesscommunicate_337" rel="nofollow">关于subprocess子进程的communicate函数</a></li><li><a href="#subprocess_348" rel="nofollow">实时获取subprocess子进程的输出</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_7"></a>介绍</h3> 
<p>Python的subprocess模块，用来创建和管理子进程（不是线程），并能够与创建的子进程的stdin，stdout，stderr连接通信，获取子进程执行结束后的返回码，在执行超时或执行错误时得到异常。</p> 
<p>从Python3.5版本开始，subprocess模块内部又进行了一次整合 ，最后就剩下官方推荐的两个接口函数，分别是：</p> 
<pre><code class="prism language-python">subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>run() 函数的使用场景更多，它的底层调用的是Popen函数，Popen函数更灵活，适合更复杂的场景。我们只要好好学习这两个函数接口的使用，就能够掌握subprocess模块的几乎所有功能。</p> 
<h3><a id="subprocess_17"></a>引入subprocess模块</h3> 
<p>由于subprocess这个名字很长，考虑到这个模块对外接口的函数和对象名称都比较特别，本文就这样来引入吧：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> subprocess <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token string">'CalledProcessError'</span><span class="token punctuation">,</span> <span class="token string">'CompletedProcess'</span><span class="token punctuation">,</span> <span class="token string">'DEVNULL'</span><span class="token punctuation">,</span> <span class="token string">'PIPE'</span><span class="token punctuation">,</span> <span class="token string">'Popen'</span><span class="token punctuation">,</span> <span class="token string">'STDOUT'</span><span class="token punctuation">,</span> <span class="token string">'SubprocessError'</span><span class="token punctuation">,</span> 
<span class="token string">'TimeoutExpired'</span><span class="token punctuation">,</span> <span class="token string">'__annotations__'</span><span class="token punctuation">,</span> <span class="token string">'__builtins__'</span><span class="token punctuation">,</span> <span class="token string">'__doc__'</span><span class="token punctuation">,</span> <span class="token string">'__loader__'</span><span class="token punctuation">,</span> <span class="token string">'__name__'</span><span class="token punctuation">,</span> <span class="token string">'__package__'</span><span class="token punctuation">,</span>
<span class="token string">'__spec__'</span><span class="token punctuation">,</span> <span class="token string">'call'</span><span class="token punctuation">,</span> <span class="token string">'check_call'</span><span class="token punctuation">,</span> <span class="token string">'check_output'</span><span class="token punctuation">,</span> <span class="token string">'getoutput'</span><span class="token punctuation">,</span> <span class="token string">'getstatusoutput'</span><span class="token punctuation">,</span> <span class="token string">'run'</span><span class="token punctuation">]</span>
</code></pre> 
<p>call，check_call，check_output，getoutput，getstatusoutput这些函数，都被run函数代替了，它们在存在只是为了保持向下兼容。从上面的打印还可以看出，subprocess这个模块提供的接口并不多。</p> 
<h3><a id="subprocessrun__28"></a>subprocess.run() 函数的使用</h3> 
<p>run函数的作用是：执行args参数所表示的命令，等待命令执行完毕，返回一个CompletedProcess对象。注意，run函数是同步函数，要等待！</p> 
<p>run()函数的接口参数：</p> 
<pre><code class="prism language-python">subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> stdin<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> stderr<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> 
capture_output<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> cwd<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> 
check<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> env<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
 universal_newlines<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre> 
<p>args参数，就是要通过创建进程而执行的命令及参数，run函数通过args来创建一个进程并执行。</p> 
<p>shell参数，表示是否通过shell来执行命令（Linux下默认为/bin/sh），默认是False，这时args只能是一个不带参数的命令字符串，或者是命令和参数组成的一个list，如果shell=True，args就可以是一个我们常见的命令字符串。下面举例：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> run<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span>
acme<span class="token punctuation">.</span>sh  domain<span class="token punctuation">.</span>key  git<span class="token operator">-</span><span class="token number">2.9</span><span class="token number">.5</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz  lina         Python<span class="token operator">-</span><span class="token number">3.7</span><span class="token number">.1</span>      
teapot  test<span class="token punctuation">.</span>sh      dataset  git<span class="token operator">-</span><span class="token number">2.9</span><span class="token number">.5</span>   lamp      private<span class="token punctuation">.</span>key  
Python<span class="token operator">-</span><span class="token number">3.7</span><span class="token number">.1</span><span class="token punctuation">.</span>tgz     test
CompletedProcess<span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token string">'ls'</span><span class="token punctuation">,</span> returncode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ls'</span><span class="token punctuation">,</span><span class="token string">'-lh'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
total 28M
drwxrwxr<span class="token operator">-</span>x<span class="token punctuation">.</span>  <span class="token number">6</span> xinlin xinlin  <span class="token number">130</span> Apr  <span class="token number">5</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">56</span> acme<span class="token punctuation">.</span>sh
drwxrwxr<span class="token operator">-</span>x<span class="token punctuation">.</span>  <span class="token number">5</span> xinlin xinlin  <span class="token number">101</span> Jan <span class="token number">12</span> <span class="token number">10</span><span class="token punctuation">:</span><span class="token number">37</span> dataset
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">.</span>  <span class="token number">1</span> xinlin xinlin <span class="token number">3.</span>2K Apr  <span class="token number">7</span> <span class="token number">13</span><span class="token punctuation">:</span><span class="token number">45</span> domain<span class="token punctuation">.</span>key
drwxrwxr<span class="token operator">-</span>x<span class="token punctuation">.</span> <span class="token number">23</span> xinlin xinlin  20K Dec <span class="token number">29</span>  <span class="token number">2018</span> git<span class="token operator">-</span><span class="token number">2.9</span><span class="token number">.5</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">.</span>  <span class="token number">1</span> xinlin xinlin <span class="token number">5.</span>7M Dec <span class="token number">28</span>  <span class="token number">2018</span> git<span class="token operator">-</span><span class="token number">2.9</span><span class="token number">.5</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
drwxrwxr<span class="token operator">-</span>x<span class="token punctuation">.</span>  <span class="token number">3</span> xinlin xinlin  <span class="token number">108</span> May <span class="token number">31</span> <span class="token number">22</span><span class="token punctuation">:</span><span class="token number">12</span> lamp
drwxrwxr<span class="token operator">-</span>x<span class="token punctuation">.</span>  <span class="token number">3</span> xinlin xinlin  <span class="token number">159</span> Feb <span class="token number">23</span> <span class="token number">15</span><span class="token punctuation">:</span><span class="token number">27</span> lina
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">.</span>  <span class="token number">1</span> xinlin xinlin <span class="token number">3.</span>2K Apr  <span class="token number">7</span> <span class="token number">13</span><span class="token punctuation">:</span><span class="token number">42</span> private<span class="token punctuation">.</span>key
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x<span class="token punctuation">.</span> <span class="token number">19</span> xinlin xinlin <span class="token number">4.</span>0K Dec <span class="token number">28</span>  <span class="token number">2018</span> Python<span class="token operator">-</span><span class="token number">3.7</span><span class="token number">.1</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">.</span>  <span class="token number">1</span> xinlin xinlin  22M Dec <span class="token number">28</span>  <span class="token number">2018</span> Python<span class="token operator">-</span><span class="token number">3.7</span><span class="token number">.1</span><span class="token punctuation">.</span>tgz
drwxrwxr<span class="token operator">-</span>x<span class="token punctuation">.</span>  <span class="token number">5</span> xinlin xinlin <span class="token number">4.</span>0K May <span class="token number">31</span> <span class="token number">22</span><span class="token punctuation">:</span><span class="token number">33</span> teapot
drwxrwxr<span class="token operator">-</span>x<span class="token punctuation">.</span>  <span class="token number">2</span> xinlin xinlin   <span class="token number">22</span> Jun <span class="token number">21</span> <span class="token number">20</span><span class="token punctuation">:</span><span class="token number">22</span> test
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">.</span>  <span class="token number">1</span> xinlin xinlin   <span class="token number">48</span> Apr  <span class="token number">6</span> <span class="token number">15</span><span class="token punctuation">:</span><span class="token number">23</span> test<span class="token punctuation">.</span>sh
CompletedProcess<span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'ls'</span><span class="token punctuation">,</span> <span class="token string">'-lh'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> returncode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> run<span class="token punctuation">(</span><span class="token string">'ls -lh'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
total 28M
drwxrwxr<span class="token operator">-</span>x<span class="token punctuation">.</span>  <span class="token number">6</span> xinlin xinlin  <span class="token number">130</span> Apr  <span class="token number">5</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">56</span> acme<span class="token punctuation">.</span>sh
drwxrwxr<span class="token operator">-</span>x<span class="token punctuation">.</span>  <span class="token number">5</span> xinlin xinlin  <span class="token number">101</span> Jan <span class="token number">12</span> <span class="token number">10</span><span class="token punctuation">:</span><span class="token number">37</span> dataset
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">.</span>  <span class="token number">1</span> xinlin xinlin <span class="token number">3.</span>2K Apr  <span class="token number">7</span> <span class="token number">13</span><span class="token punctuation">:</span><span class="token number">45</span> domain<span class="token punctuation">.</span>key
drwxrwxr<span class="token operator">-</span>x<span class="token punctuation">.</span> <span class="token number">23</span> xinlin xinlin  20K Dec <span class="token number">29</span>  <span class="token number">2018</span> git<span class="token operator">-</span><span class="token number">2.9</span><span class="token number">.5</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">.</span>  <span class="token number">1</span> xinlin xinlin <span class="token number">5.</span>7M Dec <span class="token number">28</span>  <span class="token number">2018</span> git<span class="token operator">-</span><span class="token number">2.9</span><span class="token number">.5</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
drwxrwxr<span class="token operator">-</span>x<span class="token punctuation">.</span>  <span class="token number">3</span> xinlin xinlin  <span class="token number">108</span> May <span class="token number">31</span> <span class="token number">22</span><span class="token punctuation">:</span><span class="token number">12</span> lamp
drwxrwxr<span class="token operator">-</span>x<span class="token punctuation">.</span>  <span class="token number">3</span> xinlin xinlin  <span class="token number">159</span> Feb <span class="token number">23</span> <span class="token number">15</span><span class="token punctuation">:</span><span class="token number">27</span> lina
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">.</span>  <span class="token number">1</span> xinlin xinlin <span class="token number">3.</span>2K Apr  <span class="token number">7</span> <span class="token number">13</span><span class="token punctuation">:</span><span class="token number">42</span> private<span class="token punctuation">.</span>key
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x<span class="token punctuation">.</span> <span class="token number">19</span> xinlin xinlin <span class="token number">4.</span>0K Dec <span class="token number">28</span>  <span class="token number">2018</span> Python<span class="token operator">-</span><span class="token number">3.7</span><span class="token number">.1</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">.</span>  <span class="token number">1</span> xinlin xinlin  22M Dec <span class="token number">28</span>  <span class="token number">2018</span> Python<span class="token operator">-</span><span class="token number">3.7</span><span class="token number">.1</span><span class="token punctuation">.</span>tgz
drwxrwxr<span class="token operator">-</span>x<span class="token punctuation">.</span>  <span class="token number">5</span> xinlin xinlin <span class="token number">4.</span>0K May <span class="token number">31</span> <span class="token number">22</span><span class="token punctuation">:</span><span class="token number">33</span> teapot
drwxrwxr<span class="token operator">-</span>x<span class="token punctuation">.</span>  <span class="token number">2</span> xinlin xinlin   <span class="token number">22</span> Jun <span class="token number">21</span> <span class="token number">20</span><span class="token punctuation">:</span><span class="token number">22</span> test
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">.</span>  <span class="token number">1</span> xinlin xinlin   <span class="token number">48</span> Apr  <span class="token number">6</span> <span class="token number">15</span><span class="token punctuation">:</span><span class="token number">23</span> test<span class="token punctuation">.</span>sh
CompletedProcess<span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token string">'ls -lh'</span><span class="token punctuation">,</span> returncode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<p>第1,6,22行，分别代表了3中不同的args参数的使用方式。</p> 
<p>注意run函数返回的CompletedProcess对象，里面包含了args，以及命令执行的返回码。下面的代码示例，说明了访问CompletedProcess对象的方式。</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc <span class="token operator">=</span> run<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span>
Desktop    Downloads       Music     Public   test
Documents  examples<span class="token punctuation">.</span>desktop  Pictures  Templates  Videos
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc<span class="token punctuation">.</span>args
<span class="token string">'ls'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc<span class="token punctuation">.</span>returncode
<span class="token number">0</span>
</code></pre> 
<p>CompletedProcess对象还可能包含更多的数据，请注意后面的代码示例。</p> 
<p>stdin参数，指定命令的输入途径；</p> 
<p>stdout参数，指定命令的输出途径；默认为None，如上面的代码示例，输出就直接打印出来了；</p> 
<p>stderr参数，指定命令的error输出途径；</p> 
<p>input参数，命令的具体输入内容，默认None，表示没有输入。input与stdin不能同时使用。先看一个有input参数的例子：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc <span class="token operator">=</span> run<span class="token punctuation">(</span><span class="token string">'grep fs'</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token builtin">input</span><span class="token operator">=</span>b<span class="token string">'adfs\ncccc\nfsfsf'</span><span class="token punctuation">)</span>
adfs
fsfsf
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc
CompletedProcess<span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token string">'grep fs'</span><span class="token punctuation">,</span> returncode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc <span class="token operator">=</span> run<span class="token punctuation">(</span><span class="token string">'grep fs'</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token builtin">input</span><span class="token operator">=</span>b<span class="token string">'adfs\ncccc\nfsfsf'</span><span class="token punctuation">,</span>stdout<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc
CompletedProcess<span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token string">'grep fs'</span><span class="token punctuation">,</span> returncode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>b<span class="token string">'adfs\nfsfsf\n'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc<span class="token punctuation">.</span>stdout
b<span class="token string">'adfs\nfsfsf\n'</span>
</code></pre> 
<p>input默认是一个bytes流。</p> 
<p>stdout=PIPE，表示将stdout重定向到管道，用了这个参数，grep fs命令的结果，就不会直接打印出来，而是存入了proc.stdout这个管道内。</p> 
<p>下面的例子用到了stderr：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc <span class="token operator">=</span> run<span class="token punctuation">(</span><span class="token string">'ls fs'</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>stdout<span class="token operator">=</span>PIPE<span class="token punctuation">,</span>stderr<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc<span class="token punctuation">.</span>stdout
b<span class="token string">''</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc<span class="token punctuation">.</span>stderr
b<span class="token string">"ls: cannot access 'fs': No such file or directory\n"</span>
</code></pre> 
<p>看一个stdout与input配合起来使用的例子，有点像我们在Linux shell输入的有管道的命令行：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc <span class="token operator">=</span> run<span class="token punctuation">(</span><span class="token string">'grep fs'</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token builtin">input</span><span class="token operator">=</span>b<span class="token string">'adfs\ncccc\nfsfsf'</span><span class="token punctuation">,</span>stdout<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> run<span class="token punctuation">(</span><span class="token string">'cat -n'</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token operator">=</span>proc<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>
     <span class="token number">1</span>  adfs
     <span class="token number">2</span>  fsfsf
CompletedProcess<span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token string">'cat -n'</span><span class="token punctuation">,</span> returncode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<p>下面是使用stdin的代码例子，stdin的来源是一个文件：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'tt.t'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc <span class="token operator">=</span> run<span class="token punctuation">(</span><span class="token string">'cat -n'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdin<span class="token operator">=</span>f<span class="token punctuation">)</span>
     <span class="token number">1</span>  <span class="token number">12345</span>
     <span class="token number">2</span>  abcde
     <span class="token number">3</span>  xyz<span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>有一个在命令行常见的用法，就是把stderr重定向到stdout，如下：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc <span class="token operator">=</span> run<span class="token punctuation">(</span><span class="token string">'ls kk'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>STDOUT<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc<span class="token punctuation">.</span>stdout
b<span class="token string">"ls: cannot access 'kk': No such file or directory\n"</span>
</code></pre> 
<p>capture_output参数，这个参数顾名思义就是捕获进程的输出，stdout和stderr。capture_output=True的效果与设置stdout=PIPE, stderr=PIPE一样。设置了capture_output=True，就不能再设置stdout和stderr：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc <span class="token operator">=</span> run<span class="token punctuation">(</span><span class="token string">'ls kk'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> capture_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc
CompletedProcess<span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token string">'ls kk'</span><span class="token punctuation">,</span> returncode<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>b<span class="token string">''</span><span class="token punctuation">,</span> stderr<span class="token operator">=</span>b<span class="token string">"ls: cannot access 'kk': No such file or directory\n"</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc<span class="token punctuation">.</span>stdout
b<span class="token string">''</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc<span class="token punctuation">.</span>stderr
b<span class="token string">"ls: cannot access 'kk': No such file or directory\n"</span>
</code></pre> 
<p>使用capture_output=True，只是让代码书写上更简单更短一些。</p> 
<p>cwd参数，这个参数指示了当前工作路径。</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc <span class="token operator">=</span> run<span class="token punctuation">(</span><span class="token string">'ls -lh'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> cwd<span class="token operator">=</span><span class="token string">'/usr/local'</span><span class="token punctuation">)</span>
total 36K
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x <span class="token number">2</span> root root <span class="token number">4.</span>0K Feb  <span class="token number">9</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">12</span> <span class="token builtin">bin</span>
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x <span class="token number">2</span> root root <span class="token number">4.</span>0K Feb  <span class="token number">9</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">12</span> etc
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x <span class="token number">2</span> root root <span class="token number">4.</span>0K Feb  <span class="token number">9</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">12</span> games
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x <span class="token number">2</span> root root <span class="token number">4.</span>0K Feb  <span class="token number">9</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">12</span> include
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x <span class="token number">3</span> root root <span class="token number">4.</span>0K Jun <span class="token number">28</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">54</span> lib
lrwxrwxrwx <span class="token number">1</span> root root    <span class="token number">9</span> Jun <span class="token number">28</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">32</span> man <span class="token operator">-</span><span class="token operator">&gt;</span> share<span class="token operator">/</span>man
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x <span class="token number">6</span> root root <span class="token number">4.</span>0K Jun <span class="token number">28</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">34</span> python<span class="token operator">-</span><span class="token number">3.7</span><span class="token number">.3</span>
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x <span class="token number">2</span> root root <span class="token number">4.</span>0K Feb  <span class="token number">9</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">12</span> sbin
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x <span class="token number">6</span> root root <span class="token number">4.</span>0K Feb  <span class="token number">9</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">15</span> share
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x <span class="token number">2</span> root root <span class="token number">4.</span>0K Feb  <span class="token number">9</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">12</span> src
</code></pre> 
<p>text参数，universal_newlines参数，这两个参数的作用是一样的，universal_newlines这个参数的存在也是为了向下兼容（Python3.7开始有text参数，3.5和3.6都是universal_newlines参数），<br> 因此我们使用text就好了。text参数的作用是，将stdin，stdout，stderr修改为string模式。注意看上面的示例代码，都是bytes流。</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> run<span class="token punctuation">(</span><span class="token string">'grep fs'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token operator">=</span>b<span class="token string">'asdfs\nfdfs'</span><span class="token punctuation">,</span> capture_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
CompletedProcess<span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token string">'grep fs'</span><span class="token punctuation">,</span> returncode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>b<span class="token string">'asdfs\nfdfs\n'</span><span class="token punctuation">,</span> stderr<span class="token operator">=</span>b<span class="token string">''</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> run<span class="token punctuation">(</span><span class="token string">'grep fs'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token operator">=</span><span class="token string">'asdfs\nfdfs'</span><span class="token punctuation">,</span> capture_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> 
CompletedProcess<span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token string">'grep fs'</span><span class="token punctuation">,</span> returncode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span><span class="token string">'asdfs\nfdfs\n'</span><span class="token punctuation">,</span> stderr<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
</code></pre> 
<p>timeout参数，设置进程执行的超时时间。如果时间到子进程还未结束， subprocess.TimeoutExpired异常会抛出。timeout参数的单位是秒。</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">try</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     run<span class="token punctuation">(</span><span class="token string">'python3'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token operator">=</span>b<span class="token string">'import time;time.sleep(30)'</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">except</span> TimeoutExpired<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'timeout happened...'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
timeout happened<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>以上代码，就是sleep 30秒，run函数设置timeout为1秒，触发subprocess.TimeoutExpired后，打印一点信息出来。</p> 
<p>check参数，如果check=True，在子进程的返回不为0的时候，抛出subprocess.CalledProcessError异常。这时，run函数返回的CompletedProcess对象的returncode不可用。</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">try</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     proc <span class="token operator">=</span> run<span class="token punctuation">(</span><span class="token string">'ls kk'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> check<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stderr<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">except</span> CalledProcessError<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>proc<span class="token punctuation">.</span>returncode<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token number">0</span>
</code></pre> 
<p>上面这段代码，走到了except里面，因为kk目录不存在，但是打印出来的returncode却是0，run函数没有成功返回，而是抛出异常，因此返回值不可用。</p> 
<h3><a id="subprocessPopen_205"></a>subprocess.Popen()函数的使用</h3> 
<p>run函数的底层，就是Popen函数。run函数是同步的，要等待子进程实行结束，或者超时。Popen创建子进程后，采用异步的方式，不会等待，要通过poll函数来判断子进程是否执行完毕。整理来说，Popen比run要更加灵活，如果run函数还不能满足你的需求，就考虑Popen吧。</p> 
<p>Popen()函数的接口参数：</p> 
<pre><code class="prism language-python">Popen<span class="token punctuation">(</span>args<span class="token punctuation">,</span> bufsize<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> executable<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> stdin<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> stderr<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> 
preexec_fn<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> close_fds<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> cwd<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> env<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> 
universal_newlines<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> startupinfo<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> creationflags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> 
restore_signals<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> start_new_session<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> pass_fds<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span>
encoding<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre> 
<p>参数args，stdin，stdout，stderr，shell，cwd，universal_newlines，text与run函数的含义和用法都是一样的。</p> 
<p>Popen函数的基本用法：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc <span class="token operator">=</span> Popen<span class="token punctuation">(</span><span class="token string">'ls -hl'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>STDOUT<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> out<span class="token punctuation">,</span> _ <span class="token operator">=</span> proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
total 37M
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>  <span class="token number">1</span> xinlin xinlin  <span class="token number">535</span> Jun <span class="token number">29</span> <span class="token number">06</span><span class="token punctuation">:</span><span class="token number">03</span> apache_log_reader<span class="token punctuation">.</span>py
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>  <span class="token number">1</span> xinlin xinlin <span class="token number">3.</span>2M Jun <span class="token number">30</span> <span class="token number">02</span><span class="token punctuation">:</span><span class="token number">55</span> py<span class="token punctuation">.</span>maixj<span class="token punctuation">.</span>sql
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>  <span class="token number">1</span> xinlin xinlin <span class="token number">3.</span>2M Jun <span class="token number">29</span> <span class="token number">19</span><span class="token punctuation">:</span><span class="token number">20</span> py<span class="token punctuation">.</span>online<span class="token punctuation">.</span>sql
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x <span class="token number">19</span> xinlin xinlin <span class="token number">4.</span>0K Jun <span class="token number">28</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">24</span> Python<span class="token operator">-</span><span class="token number">3.7</span><span class="token number">.3</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>  <span class="token number">1</span> xinlin xinlin  22M Mar <span class="token number">25</span> <span class="token number">13</span><span class="token punctuation">:</span><span class="token number">59</span> Python<span class="token operator">-</span><span class="token number">3.7</span><span class="token number">.3</span><span class="token punctuation">.</span>tgz
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>  <span class="token number">1</span> xinlin xinlin   <span class="token number">27</span> Jul  <span class="token number">5</span> <span class="token number">01</span><span class="token punctuation">:</span><span class="token number">05</span> sleep<span class="token punctuation">.</span>py
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>  <span class="token number">1</span> xinlin xinlin   <span class="token number">18</span> Jul  <span class="token number">5</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">10</span> tt<span class="token punctuation">.</span>t
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>  <span class="token number">1</span> xinlin xinlin  <span class="token number">800</span> Jun <span class="token number">29</span> <span class="token number">03</span><span class="token punctuation">:</span><span class="token number">26</span> walktree<span class="token punctuation">.</span>py
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>r<span class="token operator">-</span><span class="token operator">-</span>  <span class="token number">1</span> xinlin xinlin <span class="token number">8.</span>2M Jun <span class="token number">29</span> <span class="token number">05</span><span class="token punctuation">:</span><span class="token number">47</span> www<span class="token punctuation">.</span>access_log_2019_06_28
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc<span class="token punctuation">.</span>returncode
<span class="token number">0</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc<span class="token punctuation">.</span>pid
<span class="token number">2985</span>
</code></pre> 
<p>Popen函数以异步的方式创建一个子进程，返回一个Popen对象。我们通过 communicate 函数来获取stdout和stderr。communicate函数返回一个tuple，以上示例是将stderr=STDOUT，因此使用 _ 来表示为空的stderr。</p> 
<p>Popen对象的communicate函数有两个参数，input和timeout，分别用来设置给子进程的输入和超时时间。有timeout参数，表示communicate函数会等待子进程执行结束，或者超时。</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc <span class="token operator">=</span> Popen<span class="token punctuation">(</span><span class="token string">'grep fs'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdin<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> out<span class="token punctuation">,</span> err <span class="token operator">=</span> proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span>b<span class="token string">'adfs\nfsmnjkl'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> out
b<span class="token string">'adfs\nfsmnjkl\n'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> err
b<span class="token string">''</span>
</code></pre> 
<p>再来一个有timeout的例子：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> proc <span class="token operator">=</span> Popen<span class="token punctuation">(</span><span class="token string">'python3'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdin<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">try</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     out<span class="token punctuation">,</span>err<span class="token operator">=</span>proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span>b<span class="token string">'import time;time.sleep(30)'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">except</span> TimeoutExpired<span class="token punctuation">:</span> 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'time out...'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
time out<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>Popen对象有一个 wait 成员函数，也可以设置一个timeout来等待子进程的结束：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">try</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     proc<span class="token operator">=</span>Popen<span class="token punctuation">(</span><span class="token string">'python3 -c "import time;time.sleep(30)"'</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>stdout<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     returncode <span class="token operator">=</span> proc<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">except</span> TimeoutExpired<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'after waiting 15 seconds, timeout finally...'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
after waiting <span class="token number">15</span> seconds<span class="token punctuation">,</span> timeout <span class="token keyword">finally</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>注意对returncode的赋值，如果timeout发生，returncode就是not defined。当然也可以通过proc.returncode来获取。如果异常，proc.returncode的值是None。</p> 
<p>很多时候，我们确定子进程会执行结束，只是无法确定需要的时间长度，这种情况就要用 poll 函数来判断子进程的执行是否结束：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test_Popen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">import</span> time
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     proc<span class="token operator">=</span>Popen<span class="token punctuation">(</span><span class="token string">'python3 -c "import time;time.sleep(10)"'</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>stdout<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         returncode <span class="token operator">=</span> proc<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">if</span> returncode <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             i <span class="token operator">+=</span> <span class="token number">2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'sleep'</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token string">'seconds'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">continue</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">else</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'sub process is terminated with returncode'</span><span class="token punctuation">,</span>returncode<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">break</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> test_Popen<span class="token punctuation">(</span><span class="token punctuation">)</span>
sleep <span class="token number">2</span> seconds
sleep <span class="token number">4</span> seconds
sleep <span class="token number">6</span> seconds
sleep <span class="token number">8</span> seconds
sleep <span class="token number">10</span> seconds
sleep <span class="token number">12</span> seconds
sub process <span class="token keyword">is</span> terminated <span class="token keyword">with</span> returncode <span class="token number">0</span>
</code></pre> 
<h3><a id="subprocess_298"></a>用subprocess启动后台进程</h3> 
<p>先说一下自己对Python的subprocess模块和multiprocessing模块不一样地方的理解吧。</p> 
<p>subprocess是使用一行shell命令来启动进程，同步异步都可以。multiprocessing是用一个代码入口启动进程，并提供了更加丰富的进程间信息交互和同步的方式。</p> 
<p>我有一个需求，是需要在python代码中，直接创建一个后台进程，不能因为Ctrl-C或者关闭shell窗口，使这个后台进程退出。在multiprocessing模块中找了一圈，没有发现相关的接口，不过subprocess模块帮我实现了这一个需求。</p> 
<p>因为subprocess模块是用调用shell命令的方式创建进程，我们可以直接用这一行shell命令启动后台进程。</p> 
<pre><code class="prism language-python">$ cat test<span class="token punctuation">.</span>py
<span class="token keyword">import</span> subprocess
subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token string">'python3.8 start.py'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<p>如上示例，test.py的执行，就是启动一个新的python进程，然后自己就退出了。这个新的python进程，就成了后台进程，logout后也依然存在。这个命令行，连nohup都不需要！</p> 
<p>不过，有个小细节，用这种方式启动的后台进程，父进程是一个sh，sh上面就是systemd：</p> 
<pre><code class="prism language-python">$ pstree
systemd─┬─<span class="token number">2</span><span class="token operator">*</span><span class="token punctuation">[</span>agetty<span class="token punctuation">]</span>
        ├─alsactl
        ├─avahi<span class="token operator">-</span>daemon───avahi<span class="token operator">-</span>daemon
        ├─bluetoothd
        ├─cron
        ├─dbus<span class="token operator">-</span>daemon
        ├─dhcpcd
        ├─hciattach
        ├─rngd───<span class="token number">3</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>rngd<span class="token punctuation">}</span><span class="token punctuation">]</span>
        ├─rsyslogd───<span class="token number">3</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>rsyslogd<span class="token punctuation">}</span><span class="token punctuation">]</span>
        ├─sh───python3<span class="token punctuation">.</span><span class="token number">8</span>─┬─python3<span class="token punctuation">.</span><span class="token number">8</span>
        │                └─<span class="token punctuation">{<!-- --></span>python3<span class="token punctuation">.</span><span class="token number">8</span><span class="token punctuation">}</span>
        ├─sshd───sshd───sshd───bash───pstree
        ├─systemd───<span class="token punctuation">(</span>sd<span class="token operator">-</span>pam<span class="token punctuation">)</span>
        ├─systemd<span class="token operator">-</span>journal
        ├─systemd<span class="token operator">-</span>logind
        ├─systemd<span class="token operator">-</span>timesyn───<span class="token punctuation">{<!-- --></span>systemd<span class="token operator">-</span>timesyn<span class="token punctuation">}</span>
        ├─systemd<span class="token operator">-</span>udevd
        ├─thd
        └─<span class="token number">2</span><span class="token operator">*</span><span class="token punctuation">[</span>wpa_supplicant<span class="token punctuation">]</span>
</code></pre> 
<h3><a id="subprocesscommunicate_337"></a>关于subprocess子进程的communicate函数</h3> 
<p>我觉得现在才真正想清楚subprocess子进程的communicate函数的含义。要使用communicate函数，必须要用Popen来创建子进程。</p> 
<p>Popen以异步的方式创建子进程，创建时可以设定stdin，stdout和stderr全部指向PIPE，此时子进程的输入输出全部都在管道中，就像我们再shell命令行直接使用管道（|）一样！</p> 
<p>我们在使用管道（|）连接多个程序的时候，前一个程序的输出成为了后一个程序的输入，此时如果假设后一个程序时通过subprocess的Popen创建的，那么此时此子进程的stdin，就是前一个程序的输出，而它的stdout和stderr，通过communicate函数，可以直接获得！</p> 
<p>我想说的一个关键点是：通过子进程的communicate函数，我们可以像使用shell的管道一样，直接连接多个程序的输入和输出；但是，这种输入和输出，也跟shell管道一样，是一次性的；即如果某个程序有运行时会连续多次获取输入，communicate就无能为力（此时就要使用pexpect）。</p> 
<p>communicate函数是管道！因此，用管道连接多个程序，就需要多次使用Popen创建子进程（stdin，stdout和stderr都要等于PIPE），并将后一个程序的stdin设置为前一个程序的stdout。</p> 
<h3><a id="subprocess_348"></a>实时获取subprocess子进程的输出</h3> 
<p>既然是实时获取subprocess创建的子进程的输出，我们就不能使用run，而要使用Popen创建异步子进程，然后通过poll函数来查看异步子进程的执行状态，如果执行没有结束，我们就直接去读取子进程的stdout，然后在主进程中处理。</p> 
<p>下面是子进程的代码，在subproc.py文件中：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> time

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'subprocess print...'</span><span class="token punctuation">,</span> flush<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p>注意：print函数一定要使用flush=True，否则子进程的输出都在缓存中，主进程也无法读取出来！</p> 
<p>下面是主进程的代码，在proc.py文件中：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> subprocess <span class="token keyword">import</span> <span class="token operator">*</span>

proc <span class="token operator">=</span> Popen<span class="token punctuation">(</span><span class="token string">'python subproc.py'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    rcode <span class="token operator">=</span> proc<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> rcode <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'from subprocess: '</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
        line <span class="token operator">=</span> proc<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>两个.py文件放在同一目录下，下面是执行效果：</p> 
<pre><code class="prism language-python">E<span class="token punctuation">:</span>\py<span class="token operator">&gt;</span>python proc<span class="token punctuation">.</span>py
<span class="token keyword">from</span> subprocess<span class="token punctuation">:</span> subprocess <span class="token keyword">print</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">from</span> subprocess<span class="token punctuation">:</span> subprocess <span class="token keyword">print</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">from</span> subprocess<span class="token punctuation">:</span> subprocess <span class="token keyword">print</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">from</span> subprocess<span class="token punctuation">:</span> subprocess <span class="token keyword">print</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">from</span> subprocess<span class="token punctuation">:</span> subprocess <span class="token keyword">print</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">from</span> subprocess<span class="token punctuation">:</span> Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"proc.py"</span><span class="token punctuation">,</span> line <span class="token number">10</span><span class="token punctuation">,</span> <span class="token keyword">in</span> 
    line <span class="token operator">=</span> proc<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
KeyboardInterrupt
</code></pre> 
<p>用这个技术，可以在python命令行程序上套一层GUI的壳！在GUI程序中，用subprocess以子进程的方式启动命令行程序，<br> 实时获取子进程的输出并在GUI中显示出来。不过有个问题，原命令行程序的print如果没有加flush=True参数怎么办？可以使用python命令行的-u参数！</p> 
<p>如果subproc.py的代码是这样的，即print没有flush=True：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> time

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'subprocess print...'</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p>proc.py的代码修改如下，使用 -u 参数：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> subprocess <span class="token keyword">import</span> <span class="token operator">*</span>

proc <span class="token operator">=</span> Popen<span class="token punctuation">(</span><span class="token string">'python -u subproc.py'</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    rcode <span class="token operator">=</span> proc<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> rcode <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'from subprocess: '</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
        line <span class="token operator">=</span> proc<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9ae63c2a2c1fb81412cf33f2581e4c38/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">springSecurity 学习（一）创建springSecurity项目</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c4e52b36664d3b90e158ff3fbc37b253/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">eclipse插件绘制flowable流程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>