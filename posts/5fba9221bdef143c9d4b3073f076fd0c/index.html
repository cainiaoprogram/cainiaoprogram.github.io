<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBoot&#43;Prometheus&#43;Grafana 实现自定义监控 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringBoot&#43;Prometheus&#43;Grafana 实现自定义监控" />
<meta property="og:description" content="1.Spring Boot 工程集成 Micrometer 1.1引入依赖
&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;io.micrometer&lt;/groupId&gt; &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt; &lt;/dependency&gt; 1.2配置
management.server.port=9003 management.endpoints.web.exposure.include=* management.endpoint.metrics.enabled=true management.endpoint.health.show-details=always management.endpoint.health.probes.enabled=true management.endpoint.prometheus.enabled=true management.metrics.export.prometheus.enabled=true management.metrics.tags.application=voice-qc-backend 这里management.endpoints.web.exposure.include=*配置为开启 Actuator 服务，因为Spring Boot Actuator 会自动配置一个 URL 为/actuator/Prometheus的 HTTP 服务来供 Prometheus 抓取数据，不过默认该服务是关闭的，该配置将打开所有的 Actuator 服务。
management.metrics.tags.application配置会将该工程应用名称添加到计量器注册表的 tag 中去，方便后边 Prometheus 根据应用名称来区分不同的服务。
1.3监控jvm信息
然后在工程启动主类中添加 Bean 如下来监控 JVM 性能指标信息：
@SpringBootApplication public class GatewayDatumApplication { public static void main(String[] args) { SpringApplication.run(GatewayDatumApplication.class, args); } @Bean MeterRegistryCustomizer&lt;MeterRegistry&gt; configurer( @Value(&#34;${spring.application.name}&#34;) String applicationName) { return (registry) -&gt; registry." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/5fba9221bdef143c9d4b3073f076fd0c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-17T10:28:39+08:00" />
<meta property="article:modified_time" content="2022-12-17T10:28:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBoot&#43;Prometheus&#43;Grafana 实现自定义监控</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4>1.Spring Boot 工程集成 Micrometer</h4> 
<p>1.1引入依赖</p> 
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
  &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre> 
<p>1.2配置</p> 
<pre><code>management.server.port=9003
management.endpoints.web.exposure.include=*
management.endpoint.metrics.enabled=true
management.endpoint.health.show-details=always
management.endpoint.health.probes.enabled=true
management.endpoint.prometheus.enabled=true
management.metrics.export.prometheus.enabled=true
management.metrics.tags.application=voice-qc-backend
</code></pre> 
<p>这里<code>management.endpoints.web.exposure.include=*</code>配置为开启 Actuator 服务，因为Spring Boot Actuator 会自动配置一个 URL 为<code>/actuator/Prometheus</code>的 HTTP 服务来供 Prometheus 抓取数据，不过默认该服务是关闭的，该配置将打开所有的 Actuator 服务。</p> 
<p><code>management.metrics.tags.application</code>配置会将该工程应用名称添加到计量器注册表的 tag 中去，方便后边 Prometheus 根据应用名称来区分不同的服务。</p> 
<p>1.3监控jvm信息</p> 
<p>然后在工程启动主类中添加 Bean 如下来监控 JVM 性能指标信息：</p> 
<pre><code>@SpringBootApplication
public class GatewayDatumApplication {

    public static void main(String[] args) {
        SpringApplication.run(GatewayDatumApplication.class, args);
    }

    @Bean
    MeterRegistryCustomizer&lt;MeterRegistry&gt; configurer(
            @Value("${spring.application.name}") String applicationName) {
        return (registry) -&gt; registry.config().commonTags("application", applicationName);
    }

}
</code></pre> 
<p>1.4创建自定义监控</p> 
<p>监控请求次数与响应时间</p> 
<pre><code>package com.lianxin.gobot.api.monitor;

import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.Timer;
import lombok.Getter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.annotation.PostConstruct;

/**
 * @Author: GZ
 * @CreateTime: 2022-08-30  10:50
 * @Description: 自定义监控服务
 * @Version: 1.0
 */
@Component
public class PrometheusCustomMonitor {
    /**
     * 上报拨打请求次数
     */
    @Getter
    private Counter reportDialRequestCount;
    /**
     * 上报拨打URL
     */
    @Value("${lx.call-result-report.url}")
    private String callReportUrl;

    /**
     * 上报拨打响应时间
     */
    @Getter
    private Timer reportDialResponseTime;
    @Getter
    private final MeterRegistry registry;


    @Autowired
    public PrometheusCustomMonitor(MeterRegistry registry) {
        this.registry = registry;
    }

    @PostConstruct
    private void init() {
        reportDialRequestCount = registry.counter("go_api_report_dial_request_count", "url",callReportUrl);
        reportDialResponseTime=  registry.timer("go_api_report_dial_response_time", "url",callReportUrl);
    }
}
</code></pre> 
<p>1.5添加具体业务代码监控</p> 
<pre><code>//统计请求次数
prometheusCustomMonitor.getReportDialRequestCount().increment();
long startTime = System.currentTimeMillis();
String company = HttpUtils.post(companyUrl,"");
//统计响应时间
long endTime = System.currentTimeMillis();
prometheusCustomMonitor.getReportDialResponseTime().record(endTime-startTime, TimeUnit.MILLISECONDS);
</code></pre> 
<p>在浏览器访问<code>http://127.0.0.1:9001/actuator/prometheus</code>，就可以看到服务的一系列不同类型 metrics 信息，例如<code>jvm_memory_used_bytes gauge</code>、<code>jvm_gc_memory_promoted_bytes_total counter</code>，<code>go_api_report_dial_request_count</code>等</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/6a/11/3sZsKrFp_o.png"></p> 
<p>到此，Spring Boot 工程集成 Micrometer 就已经完成，接下里就要与 Prometheus 进行集成了。</p> 
<h4>2.集成 Prometheus</h4> 
<p>2.1安装</p> 
<pre><code>docker pull prom/prometheus
</code></pre> 
<pre><code>mdkir /usr/local/prometheus
</code></pre> 
<pre><code>vi prometheus.yml
</code></pre> 
<pre><code># my global config
global:
  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
  - static_configs:
    - targets:
      # - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.
  - job_name: 'prometheus'

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
    - targets: ['192.168.136.129:9090']
</code></pre> 
<pre><code>docker run -d --name prometheus -p 9090:9090 -v/usr/local/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/fa/fc/0HAXMI3U_o.png"></p> 
<p>2.2集成配置</p> 
<pre><code>global:
  scrape_interval: 15s

scrape_configs:
  - job_name: "prometheus"
    static_configs:
    - targets: ["localhost:9090"]
  - job_name: "metricsLocalTest"
    metrics_path: "/actuator/prometheus"
    static_configs:
    - targets: ["localhost:9003"]
</code></pre> 
<p>这里<code>localhost:9001</code>就是上边本地启动的服务地址，也就是 Prometheus 要监控的服务地址。同时可以添加一些与应用相关的标签，方便后期执行 PromSQL 查询语句区分。最后重启 Prometheus 服务</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/e8/b1/Don11hfO_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/e4/07/EqFA3ZZy_o.png"></p> 
<h4>3.使用 Grafana Dashboard 展示监控项</h4> 
<p>3.1安装grafana</p> 
<pre><code> docker pull grafana/grafana
</code></pre> 
<pre><code>docker run -d --name grafana -p 3000:3000 -v /usr/local/grafana:/var/lib/grafana grafana/grafana
</code></pre> 
<p>默认用户名/密码 admin/admin</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/81/ec/H6b21Sl6_o.png"></p> 
<p>3.2配置prometheus数据源</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/3f/b5/kjWh242O_o.png"></p> 
<p>3.3增加jvm面板</p> 
<p>模板编号为4701</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/81/3c/qoYU9ANV_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/f7/7a/zLITmOSo_o.png"></p> 
<p>3.4配置业务接口监控面板</p> 
<p><img alt="" height="589" src="https://images2.imgbox.com/99/0a/0TVwHZQV_o.png" width="1080"></p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1e3f625d4ba0b27bfed498836a581ef0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">程序猿的福音——猿如意使用有感</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5b67f357c88c64fca11d88cbf1b7b7e7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">四轮两驱小车（一）：STM32驱动AS4950</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>