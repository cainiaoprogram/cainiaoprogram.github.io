<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>JOIN查询流程与驱动表 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="JOIN查询流程与驱动表" />
<meta property="og:description" content="目录 `JOIN` 语句的执行数据准备分别创建表 `t1, t2`表 `t2` 中插入 `1000` 行数据表 `t1` 里插入的是 `100` 行数据 `JOIN` 语句的执行过程`EXPLAIN` 分析语句能不能使用 `JOIN` 语句 为何要用小表驱动大表`JOIN` 查询如何选择驱动表使用 `JOIN` 查询注意点能不能使用 `JOIN` （为何阿里不推荐使用 `JOIN`） JOIN 语句的执行 数据准备 分别创建表 t1, t2 CREATE TABLE `t1` ( `id` int(11) NOT NULL AUTO_INCREMENT, `a` int(11) NOT NULL, `b` int(255) NOT NULL, PRIMARY KEY (`id`), UNIQUE KEY `index_a` (`a`) USING BTREE ) ENGINE=InnoDB AUTO_INCREMENT=101 DEFAULT CHARSET=utf8mb4; CREATE TABLE `t2` ( `id` int(11) NOT NULL AUTO_INCREMENT, `a` int(11) NOT NULL, `b` int(255) NOT NULL, PRIMARY KEY (`id`), UNIQUE KEY `index_a` (`a`) USING BTREE ) ENGINE=InnoDB AUTO_INCREMENT=1001 DEFAULT CHARSET=utf8mb4; 表 t2 中插入 1000 行数据 -- 创建存储过程 CREATE DEFINER=`root`@`localhost` PROCEDURE `NewProc`(INOUT `i` int) BEGIN DECLARE i INT; SET i = 1; WHILE ( i &lt;= 1000 ) DO INSERT INTO t2 VALUES (i, i, i); SET i = i &#43; 1; END WHILE; END 表 t1 里插入的是 100 行数据 INSERT INTO t1 ( SELECT * FROM t2 WHERE id &lt;= 100 ) JOIN 语句的执行过程 EXPLAIN SELECT * FROM t1 STRAIGHT_JOIN t2 ON ( t1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/30124051131621dc01a02fccc630eb3b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-24T19:59:55+08:00" />
<meta property="article:modified_time" content="2022-09-24T19:59:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">JOIN查询流程与驱动表</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#JOIN__1" rel="nofollow">`JOIN` 语句的执行</a></li><li><ul><li><a href="#_2" rel="nofollow">数据准备</a></li><li><ul><li><a href="#_t1_t2_3" rel="nofollow">分别创建表 `t1, t2`</a></li><li><a href="#_t2__1000__22" rel="nofollow">表 `t2` 中插入 `1000` 行数据</a></li><li><a href="#_t1__100__37" rel="nofollow">表 `t1` 里插入的是 `100` 行数据</a></li></ul> 
   </li><li><a href="#JOIN__41" rel="nofollow">`JOIN` 语句的执行过程</a></li><li><ul><li><a href="#EXPLAIN__55" rel="nofollow">`EXPLAIN` 分析语句</a></li><li><a href="#_JOIN__71" rel="nofollow">能不能使用 `JOIN` 语句</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_86" rel="nofollow">为何要用小表驱动大表</a></li><li><a href="#JOIN__95" rel="nofollow">`JOIN` 查询如何选择驱动表</a></li><li><a href="#_JOIN__99" rel="nofollow">使用 `JOIN` 查询注意点</a></li><li><a href="#_JOIN__JOIN_103" rel="nofollow">能不能使用 `JOIN` （为何阿里不推荐使用 `JOIN`）</a></li></ul> 
</div> 
<p></p> 
<h2><a id="JOIN__1"></a><code>JOIN</code> 语句的执行</h2> 
<h3><a id="_2"></a>数据准备</h3> 
<h4><a id="_t1_t2_3"></a>分别创建表 <code>t1, t2</code></h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t1<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>b<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>index_a<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">101</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>


<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t2<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>b<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>index_a<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1001</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_t2__1000__22"></a>表 <code>t2</code> 中插入 <code>1000</code> 行数据</h4> 
<pre><code class="prism language-sql"><span class="token comment">--  创建存储过程</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DEFINER</span><span class="token operator">=</span><span class="token identifier"><span class="token punctuation">`</span>root<span class="token punctuation">`</span></span><span class="token variable">@`localhost`</span> <span class="token keyword">PROCEDURE</span> <span class="token identifier"><span class="token punctuation">`</span>NewProc<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token keyword">INOUT</span> <span class="token identifier"><span class="token punctuation">`</span>i<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span>
		i <span class="token keyword">INT</span><span class="token punctuation">;</span>
	<span class="token keyword">SET</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">WHILE</span>
		<span class="token punctuation">(</span> i <span class="token operator">&lt;=</span> <span class="token number">1000</span> <span class="token punctuation">)</span> 
		<span class="token keyword">DO</span> <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t2 <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> i<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>
</code></pre> 
<h4><a id="_t1__100__37"></a>表 <code>t1</code> 里插入的是 <code>100</code> 行数据</h4> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t1 <span class="token punctuation">(</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t2 <span class="token keyword">WHERE</span> id <span class="token operator">&lt;=</span> <span class="token number">100</span> <span class="token punctuation">)</span>
</code></pre> 
<h3><a id="JOIN__41"></a><code>JOIN</code> 语句的执行过程</h3> 
<pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	t1 STRAIGHT_JOIN t2 <span class="token keyword">ON</span> <span class="token punctuation">(</span> t1<span class="token punctuation">.</span>a <span class="token operator">=</span> t2<span class="token punctuation">.</span>a <span class="token punctuation">)</span>
</code></pre> 
<p>若直接使用 <code>JOIN</code> 语句，<code>MySQL</code> 优化器可能会选择表 <code>t1</code> 或 <code>t2</code> 作为驱动表，这会影响我们分析 <code>SQL</code> 语句的执行过程。为便于分析执行过程中的性能，改用 <code>straight_join</code> 让 <code>MySQL</code> 使用固定的连接方式执行查询，这样优化器只会按照我们指定的方式去 <code>JOIN</code>。所以，该语句里：<code>t1</code> 是驱动表，<code>t2</code> 是被驱动表</p> 
<p>当进行多表连接查询时，驱动表的定义为</p> 
<ul><li>如果指定了连接条件时，满足查询条件的记录行数少的表为驱动表</li><li>如果未指定连接条件时，那么行数少的表为驱动表</li><li>也可以通过 <code>EXPLAIN</code> 查看 <code>SQL</code> 语句的执行计划可以判断谁是驱动表，<code>EXPLAIN</code> 语句分析出来的第一行的表即是驱动表</li></ul> 
<h4><a id="EXPLAIN__55"></a><code>EXPLAIN</code> 分析语句</h4> 
<p><img src="https://images2.imgbox.com/ed/a4/b30vwPwa_o.png" alt="在这里插入图片描述"><br> <code>t2</code> 的字段 <code>a</code>上有索引，<code>JOIN</code> 的过程用了该索引，<code>t1</code> 使用了全表扫描，该语句执行流程</p> 
<ul><li>从 <code>t1</code> 表中读入一行数据 <code>R</code></li><li>从数据行 <code>R</code> 中，取出 <code>a</code> 字段到 <code>t2</code> 表里查找</li><li>取出 <code>t2</code> 表中满足条件的行，跟 <code>R</code> 组成一行，作为结果集一部分</li><li>重复执行步骤 <code>1 ~ 3</code>，直到 <code>t1</code> 的末尾循环结束</li></ul> 
<p>这个过程是先遍历 <code>t1</code>，然后根据从 <code>t1</code> 中取出的每行数据中的 <code>a</code> 值，去 <code>t2</code> 中查找满足条件的记录。形式上和我们写程序时的嵌套查询类似，并且可以用上被驱动表的索引，称之为 <code>Index Nested-Loop Join</code> 算法，简称 <code>NLJ</code></p> 
<p>该流程</p> 
<ul><li>对驱动表 <code>t1</code> 做了全表扫描，需扫描 <code>100</code> 行</li><li>对于每一行 <code>R</code>，根据 <code>a</code> 字段去 <code>t2</code> 查找，这是树搜索。由于构造数据一一对应，因此每次搜索过程都只扫描一行，共扫描 <code>100</code> 行</li><li>所以整个执行流程，总扫描行数是 <code>200</code></li></ul> 
<h4><a id="_JOIN__71"></a>能不能使用 <code>JOIN</code> 语句</h4> 
<p>假设不使用 <code>JOIN</code>，那就只能用单表查询：</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1
</code></pre> 
<p>查出 <code>t1</code> 所有数据，这里有 <code>100</code> 行。循环遍历这 <code>100</code> 行数据：</p> 
<ul><li>从每一行 <code>R</code> 取出字段 <code>a</code> 的值 <code>$R.a</code></li><li>执行</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t2 <span class="token keyword">where</span> a <span class="token operator">=</span> $R<span class="token punctuation">.</span>a
</code></pre> 
<ul><li>把返回的结果和 <code>R</code> 构成结果集的一行</li></ul> 
<p>该查询过程，也扫描了 <code>200</code> 行，但共执行了 <code>101</code> 条语句，比 <code>JOIN</code> 多了 <code>100</code> 次交互。而且客户端还要自己拼接 <code>SQL</code> 语句和结果。这性能还不如直接 <code>JOIN</code></p> 
<h2><a id="_86"></a>为何要用小表驱动大表</h2> 
<p><code>mysql</code> 表关联的算法是 <code>Nest Loop Join</code>，是通过驱动表的结果集作为循环基础数据，然后一条一条地通过该结果集中的数据作为过滤条件到下一个表中查询数据，然后合并结果</p> 
<p>例：<code>User</code> 表里有 <code>10000</code> 条数据，<code>Class</code> 表里有 <code>20</code> 条数据</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 驱动表为 Class 表</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">as</span> u <span class="token keyword">left</span> <span class="token keyword">join</span> class <span class="token keyword">as</span> c u<span class="token punctuation">.</span>userid <span class="token operator">=</span> c<span class="token punctuation">.</span>userid
</code></pre> 
<p>这样则需要用 <code>User</code> 表循环 <code>10000</code> 次才能查询出来，而如果用 <code>Class</code> 表驱动 <code>User</code> 表则只需要循环 <code>20</code> 次就能查询出来</p> 
<h2><a id="JOIN__95"></a><code>JOIN</code> 查询如何选择驱动表</h2> 
<ul><li><code>LEFT JOIN</code>：左表（主表）是驱动表，右表（从表）是被驱动表</li><li><code>RIGHT JOIN</code>：右表（主表）是驱动表，左表（从表）是被驱动表</li><li><code>INNER JOIN</code>：<code>mysql</code> 会选择数据量比较小的表作为驱动表，大表作为被驱动表</li></ul> 
<h2><a id="_JOIN__99"></a>使用 <code>JOIN</code> 查询注意点</h2> 
<ul><li>使用 <code>JOIN</code> 语句，性能比强行拆成多个单表执行 <code>SQL</code> 语句的性能要好</li><li>如果使用 <code>JOIN</code> 语句的话，需要让小表做驱动表</li><li>这些结论的前提是可以使用被驱动表的索引</li></ul> 
<h2><a id="_JOIN__JOIN_103"></a>能不能使用 <code>JOIN</code> （为何阿里不推荐使用 <code>JOIN</code>）</h2> 
<ul><li><mark>当可以使用被驱动表的索引时，是没问题的</mark></li><li><mark>否则，扫描行数就会过多。尤其是在大表上的 <code>JOIN</code>，这样可能要扫描被驱动表很多次，会占用大量的系统资源。所以这种 <code>JOIN</code> 不推荐使用</mark></li></ul> 
<p>所以判断要不要使用 <code>JOIN</code>，就是看 <code>explain</code> 结果里面，<code>Extra</code> 字段里面有没有出现 <code>Block Nested Loop</code></p> 
<ul><li>如果有，则不推荐使用 <code>JOIN</code></li><li>否则，可以使用 <code>JOIN</code></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/66581983c47fbfbf75353a6823aa6952/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">BUUCTF admin</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f4a0011226d3a8db09e173dee760b558/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">OpenBLAS warning这个怎么解决呀</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>