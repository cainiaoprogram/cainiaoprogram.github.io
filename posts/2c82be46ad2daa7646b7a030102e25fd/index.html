<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>OpenLayers源码解析6 ol/source/Vector.js - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="OpenLayers源码解析6 ol/source/Vector.js" />
<meta property="og:description" content="ol/source/Vector.js 父类 ol/source/Source-Source
主要功能 提供矢量图层数据源。
该数据源提供的矢量要素可被编辑。
参数：VectorSource({}) 参数类型说明formatmodule:ol/format/Feature~FeatureFormat若设置了url参数，则需指定要素格式format。如new ol.format.GeoJSON()urlstring
module:ol/featureloader~FeatureUrlFunction使用XHR加载要素，需要提供formatwrapXboolean (defaults to true)水平环绕世界。要使跨-180°和180°子午线的矢量编辑正常工作，应将其设置为false。生成的几何体坐标将超出世界边界。 方法 函数名参数源码返回值类型功能forEachFeatureIntersectingExtent(extent, callback)extent module:ol/extent~Extent Extent.
callback function 每个feature调用的回调函数source/Vector.js, line 630{Tundefined} /** * @module ol/source/Vector */ import Collection from &#39;../Collection.js&#39;; import CollectionEventType from &#39;../CollectionEventType.js&#39;; import Event from &#39;../events/Event.js&#39;; import EventType from &#39;../events/EventType.js&#39;; import ObjectEventType from &#39;../ObjectEventType.js&#39;; import RBush from &#39;../structs/RBush.js&#39;; import Source from &#39;./Source.js&#39;; import SourceState from &#39;./State.js&#39;; import VectorEventType from &#39;./VectorEventType.js&#39;; import {TRUE, VOID} from &#39;../functions.js&#39;; import {all as allStrategy} from &#39;." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2c82be46ad2daa7646b7a030102e25fd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-22T23:37:13+08:00" />
<meta property="article:modified_time" content="2021-08-22T23:37:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">OpenLayers源码解析6 ol/source/Vector.js</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="centerolsourceVectorjscenter_0"></a> 
 <center>
   ol/source/Vector.js 
 </center></h2> 
<h3><a id="_1"></a>父类</h3> 
<p>ol/source/Source-Source</p> 
<h3><a id="_3"></a>主要功能</h3> 
<p>提供矢量图层数据源。<br> 该数据源提供的矢量要素可被编辑。</p> 
<h3><a id="VectorSource_6"></a>参数：VectorSource({})</h3> 
<table><thead><tr><th>参数</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>format</td><td>module:ol/format/Feature~FeatureFormat</td><td>若设置了url参数，则需指定要素格式format。如new ol.format.GeoJSON()</td></tr><tr><td>url</td><td>string<br>module:ol/featureloader~FeatureUrlFunction</td><td>使用XHR加载要素，需要提供format</td></tr><tr><td>wrapX</td><td>boolean (defaults to true)</td><td>水平环绕世界。要使跨-180°和180°子午线的矢量编辑正常工作，应将其设置为false。生成的几何体坐标将超出世界边界。</td></tr></tbody></table> 
<h3><a id="_12"></a>方法</h3> 
<table><thead><tr><th>函数名</th><th>参数</th><th>源码</th><th>返回值类型</th><th>功能</th></tr></thead><tbody><tr><td>forEachFeatureIntersectingExtent(extent, callback)</td><td>extent module:ol/extent~Extent Extent.<br>callback function 每个feature调用的回调函数</td><td>source/Vector.js, line 630</td><td>{T</td><td>undefined}</td></tr></tbody></table> 
<pre><code class="prism language-javascript"><span class="token comment">/**
 * @module ol/source/Vector
 */</span>

<span class="token keyword">import</span> Collection <span class="token keyword">from</span> <span class="token string">'../Collection.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> CollectionEventType <span class="token keyword">from</span> <span class="token string">'../CollectionEventType.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Event <span class="token keyword">from</span> <span class="token string">'../events/Event.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> EventType <span class="token keyword">from</span> <span class="token string">'../events/EventType.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ObjectEventType <span class="token keyword">from</span> <span class="token string">'../ObjectEventType.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> RBush <span class="token keyword">from</span> <span class="token string">'../structs/RBush.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Source <span class="token keyword">from</span> <span class="token string">'./Source.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> SourceState <span class="token keyword">from</span> <span class="token string">'./State.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> VectorEventType <span class="token keyword">from</span> <span class="token string">'./VectorEventType.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span><span class="token constant">TRUE</span><span class="token punctuation">,</span> <span class="token constant">VOID</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../functions.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>all <span class="token keyword">as</span> allStrategy<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../loadingstrategy.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>assert<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../asserts.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>containsExtent<span class="token punctuation">,</span> equals<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../extent.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>extend<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../array.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>getUid<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>getValues<span class="token punctuation">,</span> isEmpty<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../obj.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>listen<span class="token punctuation">,</span> unlistenByKey<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../events.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>xhr<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../featureloader.js'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * A function that takes an {@link module:ol/extent~Extent} and a resolution as arguments, and
 * returns an array of {@link module:ol/extent~Extent} with the extents to load. Usually this
 * is one of the standard {@link module:ol/loadingstrategy} strategies.
 *
 * @typedef {function(import("../extent.js").Extent, number): Array&lt;import("../extent.js").Extent&gt;} LoadingStrategy
 * @api
 */</span>

<span class="token comment">/**
 * @classdesc
 * Events emitted by {@link module:ol/source/Vector} instances are instances of this
 * type.
 * @template {import("../geom/Geometry.js").default} Geometry
 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">VectorSourceEvent</span> <span class="token keyword">extends</span> <span class="token class-name">Event</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/**
   * @param {string} type Type.
   * @param {import("../Feature.js").default&lt;Geometry&gt;} [opt_feature] Feature.
   * @param {Array&lt;import("../Feature.js").default&lt;Geometry&gt;&gt;} [opt_features] Features.
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> opt_feature<span class="token punctuation">,</span> opt_features</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * The added or removed feature for the `ADDFEATURE` and `REMOVEFEATURE` events, `undefined` otherwise.
     * @type {import("../Feature.js").default&lt;Geometry&gt;|undefined}
     * @api
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>feature <span class="token operator">=</span> opt_feature<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The loaded features for the `FEATURESLOADED` event, `undefined` otherwise.
     * @type {Array&lt;import("../Feature.js").default&lt;Geometry&gt;&gt;|undefined}
     * @api
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>features <span class="token operator">=</span> opt_features<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/***
 * @template Return
 * @typedef {import("../Observable").OnSignature&lt;import("../Observable").EventTypes, import("../events/Event.js").default, Return&gt; &amp;
 *   import("../Observable").OnSignature&lt;import("../ObjectEventType").Types, import("../Object").ObjectEvent, Return&gt; &amp;
 *   import("../Observable").OnSignature&lt;import("./VectorEventType").VectorSourceEventTypes, VectorSourceEvent, Return&gt; &amp;
 *   import("../Observable").CombinedOnSignature&lt;import("../Observable").EventTypes|import("../ObjectEventType").Types|
 *     import("./VectorEventType").VectorSourceEventTypes, Return&gt;} VectorSourceOnSignature
 */</span>

<span class="token comment">/**
 * @typedef {Object} Options
 * @property {import("./Source.js").AttributionLike} [attributions] Attributions.
 * @property {Array&lt;import("../Feature.js").default&gt;|Collection&lt;import("../Feature.js").default&gt;} [features]
 * Features. If provided as {@link module:ol/Collection}, the features in the source
 * and the collection will stay in sync.
 * @property {import("../format/Feature.js").default} [format] The feature format used by the XHR
 * feature loader when `url` is set. Required if `url` is set, otherwise ignored.
 * @property {import("../featureloader.js").FeatureLoader} [loader]
 * The loader function used to load features, from a remote source for example.
 * If this is not set and `url` is set, the source will create and use an XHR
 * feature loader. The `'featuresloadend'` and `'featuresloaderror'` events
 * will only fire if the `success` and `failure` callbacks are used.
 *
 * Example:
 *
 * ```js
 * import {Vector} from 'ol/source';
 * import {GeoJSON} from 'ol/format';
 * import {bbox} from 'ol/loadingstrategy';
 *
 * var vectorSource = new Vector({
 *   format: new GeoJSON(),
 *   loader: function(extent, resolution, projection, success, failure) {
 *      var proj = projection.getCode();
 *      var url = 'https://ahocevar.com/geoserver/wfs?service=WFS&amp;' +
 *          'version=1.1.0&amp;request=GetFeature&amp;typename=osm:water_areas&amp;' +
 *          'outputFormat=application/json&amp;srsname=' + proj + '&amp;' +
 *          'bbox=' + extent.join(',') + ',' + proj;
 *      var xhr = new XMLHttpRequest();
 *      xhr.open('GET', url);
 *      var onError = function() {
 *        vectorSource.removeLoadedExtent(extent);
 *        failure();
 *      }
 *      xhr.onerror = onError;
 *      xhr.onload = function() {
 *        if (xhr.status == 200) {
 *          var features = vectorSource.getFormat().readFeatures(xhr.responseText);
 *          vectorSource.addFeatures(features);
 *          success(features);
 *        } else {
 *          onError();
 *        }
 *      }
 *      xhr.send();
 *    },
 *    strategy: bbox
 *  });
 * ```
 * @property {boolean} [overlaps=true] This source may have overlapping geometries.
 * Setting this to `false` (e.g. for sources with polygons that represent administrative
 * boundaries or TopoJSON sources) allows the renderer to optimise fill and
 * stroke operations.
 * @property {LoadingStrategy} [strategy] The loading strategy to use.
 * By default an {@link module:ol/loadingstrategy.all}
 * strategy is used, a one-off strategy which loads all features at once.
 * @property {string|import("../featureloader.js").FeatureUrlFunction} [url]
 * Setting this option instructs the source to load features using an XHR loader
 * (see {@link module:ol/featureloader.xhr}). Use a `string` and an
 * {@link module:ol/loadingstrategy.all} for a one-off download of all features from
 * the given URL. Use a {@link module:ol/featureloader~FeatureUrlFunction} to generate the url with
 * other loading strategies.
 * Requires `format` to be set as well.
 * When default XHR feature loader is provided, the features will
 * be transformed from the data projection to the view projection
 * during parsing. If your remote data source does not advertise its projection
 * properly, this transformation will be incorrect. For some formats, the
 * default projection (usually EPSG:4326) can be overridden by setting the
 * dataProjection constructor option on the format.
 * Note that if a source contains non-feature data, such as a GeoJSON geometry
 * or a KML NetworkLink, these will be ignored. Use a custom loader to load these.
 * @property {boolean} [useSpatialIndex=true]
 * By default, an RTree is used as spatial index. When features are removed and
 * added frequently, and the total number of features is low, setting this to
 * `false` may improve performance.
 *
 * Note that
 * {@link module:ol/source/Vector~VectorSource#getFeaturesInExtent},
 * {@link module:ol/source/Vector~VectorSource#getClosestFeatureToCoordinate} and
 * {@link module:ol/source/Vector~VectorSource#getExtent} cannot be used when `useSpatialIndex` is
 * set to `false`, and {@link module:ol/source/Vector~VectorSource#forEachFeatureInExtent} will loop
 * through all features.
 *
 * When set to `false`, the features will be maintained in an
 * {@link module:ol/Collection}, which can be retrieved through
 * {@link module:ol/source/Vector~VectorSource#getFeaturesCollection}.
 * @property {boolean} [wrapX=true] Wrap the world horizontally. For vector editing across the
 * -180° and 180° meridians to work properly, this should be set to `false`. The
 * resulting geometry coordinates will then exceed the world bounds.
 */</span>

<span class="token comment">/**
 * @classdesc
 * Provides a source of features for vector layers. Vector features provided
 * by this source are suitable for editing. See {@link module:ol/source/VectorTile~VectorTile} for
 * vector data that is optimized for rendering.
 *
 * @fires VectorSourceEvent
 * @api
 * @template {import("../geom/Geometry.js").default} Geometry
 */</span>
<span class="token keyword">class</span> <span class="token class-name">VectorSource</span> <span class="token keyword">extends</span> <span class="token class-name">Source</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/**
   * @param {Options} [opt_options] Vector source options.
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">opt_options</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> opt_options <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      attributions<span class="token operator">:</span> options<span class="token punctuation">.</span>attributions<span class="token punctuation">,</span>
      projection<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
      state<span class="token operator">:</span> SourceState<span class="token punctuation">.</span><span class="token constant">READY</span><span class="token punctuation">,</span>
      wrapX<span class="token operator">:</span> options<span class="token punctuation">.</span>wrapX <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>wrapX <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/***
     * @type {VectorSourceOnSignature&lt;import("../Observable.js").OnReturn&gt;}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>on<span class="token punctuation">;</span>

    <span class="token comment">/***
     * @type {VectorSourceOnSignature&lt;import("../Observable.js").OnReturn&gt;}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>once<span class="token punctuation">;</span>

    <span class="token comment">/***
     * @type {VectorSourceOnSignature&lt;void&gt;}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>un<span class="token punctuation">;</span>

    <span class="token comment">/**
     * @private
     * @type {import("../featureloader.js").FeatureLoader}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loader_ <span class="token operator">=</span> <span class="token constant">VOID</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @private
     * @type {import("../format/Feature.js").default|undefined}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>format_ <span class="token operator">=</span> options<span class="token punctuation">.</span>format<span class="token punctuation">;</span>

    <span class="token comment">/**
     * @private
     * @type {boolean}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>overlaps_ <span class="token operator">=</span> options<span class="token punctuation">.</span>overlaps <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> options<span class="token punctuation">.</span>overlaps<span class="token punctuation">;</span>

    <span class="token comment">/**
     * @private
     * @type {string|import("../featureloader.js").FeatureUrlFunction|undefined}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url_ <span class="token operator">=</span> options<span class="token punctuation">.</span>url<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>loader <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>loader_ <span class="token operator">=</span> options<span class="token punctuation">.</span>loader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url_ <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>format_<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// `format` must be set when `url` is set</span>
      <span class="token comment">// create a XHR feature loader for "url" and "format"</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>loader_ <span class="token operator">=</span> <span class="token function">xhr</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>url_<span class="token punctuation">,</span>
        <span class="token comment">/** @type {import("../format/Feature.js").default} */</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>format_<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @private
     * @type {LoadingStrategy}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>strategy_ <span class="token operator">=</span>
      options<span class="token punctuation">.</span>strategy <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>strategy <span class="token operator">:</span> allStrategy<span class="token punctuation">;</span>

    <span class="token keyword">const</span> useSpatialIndex <span class="token operator">=</span>
      options<span class="token punctuation">.</span>useSpatialIndex <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>useSpatialIndex <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @private
     * @type {RBush&lt;import("../Feature.js").default&lt;Geometry&gt;&gt;}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_ <span class="token operator">=</span> useSpatialIndex <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">RBush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @private
     * @type {RBush&lt;{extent: import("../extent.js").Extent}&gt;}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loadedExtentsRtree_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RBush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @type {number}
     * @private
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loadingExtentsCount_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @private
     * @type {!Object&lt;string, import("../Feature.js").default&lt;Geometry&gt;&gt;}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_ <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * A lookup of features by id (the return from feature.getId()).
     * @private
     * @type {!Object&lt;string, import("../Feature.js").default&lt;Geometry&gt;&gt;}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>idIndex_ <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * A lookup of features by uid (using getUid(feature)).
     * @private
     * @type {!Object&lt;string, import("../Feature.js").default&lt;Geometry&gt;&gt;}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uidIndex_ <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @private
     * @type {Object&lt;string, Array&lt;import("../events.js").EventsKey&gt;&gt;}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>featureChangeKeys_ <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @private
     * @type {Collection&lt;import("../Feature.js").default&lt;Geometry&gt;&gt;}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_ <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> collection<span class="token punctuation">,</span> features<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>features<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      features <span class="token operator">=</span> options<span class="token punctuation">.</span>features<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>features<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      collection <span class="token operator">=</span> options<span class="token punctuation">.</span>features<span class="token punctuation">;</span>
      features <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>useSpatialIndex <span class="token operator">&amp;&amp;</span> collection <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      collection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Collection</span><span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>features <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addFeaturesInternal</span><span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>collection <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bindFeaturesCollection_</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Add a single feature to the source.  If you want to add a batch of features
   * at once, call {@link module:ol/source/Vector~VectorSource#addFeatures #addFeatures()}
   * instead. A feature will not be added to the source if feature with
   * the same id is already there. The reason for this behavior is to avoid
   * feature duplication when using bbox or tile loading strategies.
   * Note: this also applies if an {@link module:ol/Collection} is used for features,
   * meaning that if a feature with a duplicate id is added in the collection, it will
   * be removed from it right away.
   * @param {import("../Feature.js").default&lt;Geometry&gt;} feature Feature to add.
   * @api
   */</span>
  <span class="token function">addFeature</span><span class="token punctuation">(</span><span class="token parameter">feature</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addFeatureInternal</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Add a feature without firing a `change` event.
   * @param {import("../Feature.js").default&lt;Geometry&gt;} feature Feature.
   * @protected
   */</span>
  <span class="token function">addFeatureInternal</span><span class="token punctuation">(</span><span class="token parameter">feature</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> featureKey <span class="token operator">=</span> <span class="token function">getUid</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addToIndex_</span><span class="token punctuation">(</span>featureKey<span class="token punctuation">,</span> feature<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupChangeEvents_</span><span class="token punctuation">(</span>featureKey<span class="token punctuation">,</span> feature<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> geometry <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">getGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> extent <span class="token operator">=</span> geometry<span class="token punctuation">.</span><span class="token function">getExtent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>extent<span class="token punctuation">,</span> feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_<span class="token punctuation">[</span>featureKey<span class="token punctuation">]</span> <span class="token operator">=</span> feature<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">VectorSourceEvent</span><span class="token punctuation">(</span>VectorEventType<span class="token punctuation">.</span><span class="token constant">ADDFEATURE</span><span class="token punctuation">,</span> feature<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @param {string} featureKey Unique identifier for the feature.
   * @param {import("../Feature.js").default&lt;Geometry&gt;} feature The feature.
   * @private
   */</span>
  <span class="token function">setupChangeEvents_</span><span class="token punctuation">(</span><span class="token parameter">featureKey<span class="token punctuation">,</span> feature</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>featureChangeKeys_<span class="token punctuation">[</span>featureKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token function">listen</span><span class="token punctuation">(</span>feature<span class="token punctuation">,</span> EventType<span class="token punctuation">.</span><span class="token constant">CHANGE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleFeatureChange_<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">listen</span><span class="token punctuation">(</span>
        feature<span class="token punctuation">,</span>
        ObjectEventType<span class="token punctuation">.</span><span class="token constant">PROPERTYCHANGE</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handleFeatureChange_<span class="token punctuation">,</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @param {string} featureKey Unique identifier for the feature.
   * @param {import("../Feature.js").default&lt;Geometry&gt;} feature The feature.
   * @return {boolean} The feature is "valid", in the sense that it is also a
   *     candidate for insertion into the Rtree.
   * @private
   */</span>
  <span class="token function">addToIndex_</span><span class="token punctuation">(</span><span class="token parameter">featureKey<span class="token punctuation">,</span> feature</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> valid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idIndex_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>idIndex_<span class="token punctuation">[</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> feature<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>featureKey <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uidIndex_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// The passed `feature` was already added to the source</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>uidIndex_<span class="token punctuation">[</span>featureKey<span class="token punctuation">]</span> <span class="token operator">=</span> feature<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> valid<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Add a batch of features to the source.
   * @param {Array&lt;import("../Feature.js").default&lt;Geometry&gt;&gt;} features Features to add.
   * @api
   */</span>
  <span class="token function">addFeatures</span><span class="token punctuation">(</span><span class="token parameter">features</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addFeaturesInternal</span><span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Add features without firing a `change` event.
   * @param {Array&lt;import("../Feature.js").default&lt;Geometry&gt;&gt;} features Features.
   * @protected
   */</span>
  <span class="token function">addFeaturesInternal</span><span class="token punctuation">(</span><span class="token parameter">features</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> extents <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> newFeatures <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> geometryFeatures <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> features<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> feature <span class="token operator">=</span> features<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> featureKey <span class="token operator">=</span> <span class="token function">getUid</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addToIndex_</span><span class="token punctuation">(</span>featureKey<span class="token punctuation">,</span> feature<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        newFeatures<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> newFeatures<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> feature <span class="token operator">=</span> newFeatures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> featureKey <span class="token operator">=</span> <span class="token function">getUid</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupChangeEvents_</span><span class="token punctuation">(</span>featureKey<span class="token punctuation">,</span> feature<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> geometry <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">getGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> extent <span class="token operator">=</span> geometry<span class="token punctuation">.</span><span class="token function">getExtent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        extents<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>extent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        geometryFeatures<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_<span class="token punctuation">[</span>featureKey<span class="token punctuation">]</span> <span class="token operator">=</span> feature<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>extents<span class="token punctuation">,</span> geometryFeatures<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> newFeatures<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">VectorSourceEvent</span><span class="token punctuation">(</span>VectorEventType<span class="token punctuation">.</span><span class="token constant">ADDFEATURE</span><span class="token punctuation">,</span> newFeatures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @param {!Collection&lt;import("../Feature.js").default&lt;Geometry&gt;&gt;} collection Collection.
   * @private
   */</span>
  <span class="token function">bindFeaturesCollection_</span><span class="token punctuation">(</span><span class="token parameter">collection</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> modifyingCollection <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      VectorEventType<span class="token punctuation">.</span><span class="token constant">ADDFEATURE</span><span class="token punctuation">,</span>
      <span class="token comment">/**
       * @param {VectorSourceEvent&lt;Geometry&gt;} evt The vector source event
       */</span>
      <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modifyingCollection<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          modifyingCollection <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          collection<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>evt<span class="token punctuation">.</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
          modifyingCollection <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      VectorEventType<span class="token punctuation">.</span><span class="token constant">REMOVEFEATURE</span><span class="token punctuation">,</span>
      <span class="token comment">/**
       * @param {VectorSourceEvent&lt;Geometry&gt;} evt The vector source event
       */</span>
      <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modifyingCollection<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          modifyingCollection <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          collection<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>evt<span class="token punctuation">.</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
          modifyingCollection <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    collection<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      CollectionEventType<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token punctuation">,</span>
      <span class="token comment">/**
       * @param {import("../Collection.js").CollectionEvent} evt The collection event
       */</span>
      <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modifyingCollection<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          modifyingCollection <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addFeature</span><span class="token punctuation">(</span>
            <span class="token comment">/** @type {import("../Feature.js").default&lt;Geometry&gt;} */</span> <span class="token punctuation">(</span>
              evt<span class="token punctuation">.</span>element
            <span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          modifyingCollection <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    collection<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      CollectionEventType<span class="token punctuation">.</span><span class="token constant">REMOVE</span><span class="token punctuation">,</span>
      <span class="token comment">/**
       * @param {import("../Collection.js").CollectionEvent} evt The collection event
       */</span>
      <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modifyingCollection<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          modifyingCollection <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeFeature</span><span class="token punctuation">(</span>
            <span class="token comment">/** @type {import("../Feature.js").default&lt;Geometry&gt;} */</span> <span class="token punctuation">(</span>
              evt<span class="token punctuation">.</span>element
            <span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          modifyingCollection <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_ <span class="token operator">=</span> collection<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Remove all features from the source.
   * @param {boolean} [opt_fast] Skip dispatching of {@link module:ol/source/Vector.VectorSourceEvent#event:removefeature removefeature} events.
   * @api
   */</span>
  <span class="token function">clear</span><span class="token punctuation">(</span><span class="token parameter">opt_fast</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>opt_fast<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> featureId <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>featureChangeKeys_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> keys <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>featureChangeKeys_<span class="token punctuation">[</span>featureId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        keys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>unlistenByKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>featureChangeKeys_ <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>idIndex_ <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>uidIndex_ <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeFeatureInternal</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> id <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeFeatureInternal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_ <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> clearEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VectorSourceEvent</span><span class="token punctuation">(</span>VectorEventType<span class="token punctuation">.</span><span class="token constant">CLEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>clearEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Iterate through all features on the source, calling the provided callback
   * with each one.  If the callback returns any "truthy" value, iteration will
   * stop and the function will return the same value.
   * Note: this function only iterate through the feature that have a defined geometry.
   *
   * @param {function(import("../Feature.js").default&lt;Geometry&gt;): T} callback Called with each feature
   *     on the source.  Return a truthy value to stop iteration.
   * @return {T|undefined} The return value from the last call to the callback.
   * @template T
   * @api
   */</span>
  <span class="token function">forEachFeature</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Iterate through all features whose geometries contain the provided
   * coordinate, calling the callback with each feature.  If the callback returns
   * a "truthy" value, iteration will stop and the function will return the same
   * value.
   *
   * @param {import("../coordinate.js").Coordinate} coordinate Coordinate.
   * @param {function(import("../Feature.js").default&lt;Geometry&gt;): T} callback Called with each feature
   *     whose goemetry contains the provided coordinate.
   * @return {T|undefined} The return value from the last call to the callback.
   * @template T
   */</span>
  <span class="token function">forEachFeatureAtCoordinateDirect</span><span class="token punctuation">(</span><span class="token parameter">coordinate<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> extent <span class="token operator">=</span> <span class="token punctuation">[</span>coordinate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> coordinate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> coordinate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> coordinate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEachFeatureInExtent</span><span class="token punctuation">(</span>extent<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">feature</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> geometry <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">getGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>geometry<span class="token punctuation">.</span><span class="token function">intersectsCoordinate</span><span class="token punctuation">(</span>coordinate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Iterate through all features whose bounding box intersects the provided
   * extent (note that the feature's geometry may not intersect the extent),
   * calling the callback with each feature.  If the callback returns a "truthy"
   * value, iteration will stop and the function will return the same value.
   *
   * If you are interested in features whose geometry intersects an extent, call
   * the {@link module:ol/source/Vector~VectorSource#forEachFeatureIntersectingExtent #forEachFeatureIntersectingExtent()} method instead.
   *
   * When `useSpatialIndex` is set to false, this method will loop through all
   * features, equivalent to {@link module:ol/source/Vector~VectorSource#forEachFeature #forEachFeature()}.
   *
   * @param {import("../extent.js").Extent} extent Extent.
   * @param {function(import("../Feature.js").default&lt;Geometry&gt;): T} callback Called with each feature
   *     whose bounding box intersects the provided extent.
   * @return {T|undefined} The return value from the last call to the callback.
   * @template T
   * @api
   */</span>
  <span class="token function">forEachFeatureInExtent</span><span class="token punctuation">(</span><span class="token parameter">extent<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">forEachInExtent</span><span class="token punctuation">(</span>extent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Iterate through all features whose geometry intersects the provided extent,
   * calling the callback with each feature.  If the callback returns a "truthy"
   * value, iteration will stop and the function will return the same value.
   *
   * If you only want to test for bounding box intersection, call the
   * {@link module:ol/source/Vector~VectorSource#forEachFeatureInExtent #forEachFeatureInExtent()} method instead.
   *
   * @param {import("../extent.js").Extent} extent Extent.
   * @param {function(import("../Feature.js").default&lt;Geometry&gt;): T} callback Called with each feature
   *     whose geometry intersects the provided extent.
   * @return {T|undefined} The return value from the last call to the callback.
   * @template T
   * @api
   */</span>
  <span class="token function">forEachFeatureIntersectingExtent</span><span class="token punctuation">(</span><span class="token parameter">extent<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEachFeatureInExtent</span><span class="token punctuation">(</span>
      extent<span class="token punctuation">,</span>
      <span class="token comment">/**
       * @param {import("../Feature.js").default&lt;Geometry&gt;} feature Feature.
       * @return {T|undefined} The return value from the last call to the callback.
       */</span>
      <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">feature</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> geometry <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">getGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>geometry<span class="token punctuation">.</span><span class="token function">intersectsExtent</span><span class="token punctuation">(</span>extent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Get the features collection associated with this source. Will be `null`
   * unless the source was configured with `useSpatialIndex` set to `false`, or
   * with an {@link module:ol/Collection} as `features`.
   * @return {Collection&lt;import("../Feature.js").default&lt;Geometry&gt;&gt;} The collection of features.
   * @api
   */</span>
  <span class="token function">getFeaturesCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Get a snapshot of the features currently on the source in random order. The returned array
   * is a copy, the features are references to the features in the source.
   * @return {Array&lt;import("../Feature.js").default&lt;Geometry&gt;&gt;} Features.
   * @api
   */</span>
  <span class="token function">getFeatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> features<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      features <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_<span class="token punctuation">.</span><span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      features <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">extend</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> <span class="token function">getValues</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token comment">/** @type {Array&lt;import("../Feature.js").default&lt;Geometry&gt;&gt;} */</span> <span class="token punctuation">(</span>
      features
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Get all features whose geometry intersects the provided coordinate.
   * @param {import("../coordinate.js").Coordinate} coordinate Coordinate.
   * @return {Array&lt;import("../Feature.js").default&lt;Geometry&gt;&gt;} Features.
   * @api
   */</span>
  <span class="token function">getFeaturesAtCoordinate</span><span class="token punctuation">(</span><span class="token parameter">coordinate</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> features <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEachFeatureAtCoordinateDirect</span><span class="token punctuation">(</span>coordinate<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">feature</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      features<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> features<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Get all features whose bounding box intersects the provided extent.  Note that this returns an array of
   * all features intersecting the given extent in random order (so it may include
   * features whose geometries do not intersect the extent).
   *
   * When `useSpatialIndex` is set to false, this method will return all
   * features.
   *
   * @param {import("../extent.js").Extent} extent Extent.
   * @return {Array&lt;import("../Feature.js").default&lt;Geometry&gt;&gt;} Features.
   * @api
   */</span>
  <span class="token function">getFeaturesInExtent</span><span class="token punctuation">(</span><span class="token parameter">extent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">getInExtent</span><span class="token punctuation">(</span>extent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>featuresCollection_<span class="token punctuation">.</span><span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Get the closest feature to the provided coordinate.
   *
   * This method is not available when the source is configured with
   * `useSpatialIndex` set to `false`.
   * @param {import("../coordinate.js").Coordinate} coordinate Coordinate.
   * @param {function(import("../Feature.js").default&lt;Geometry&gt;):boolean} [opt_filter] Feature filter function.
   *     The filter function will receive one argument, the {@link module:ol/Feature feature}
   *     and it should return a boolean value. By default, no filtering is made.
   * @return {import("../Feature.js").default&lt;Geometry&gt;} Closest feature.
   * @api
   */</span>
  <span class="token function">getClosestFeatureToCoordinate</span><span class="token punctuation">(</span><span class="token parameter">coordinate<span class="token punctuation">,</span> opt_filter</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Find the closest feature using branch and bound.  We start searching an</span>
    <span class="token comment">// infinite extent, and find the distance from the first feature found.  This</span>
    <span class="token comment">// becomes the closest feature.  We then compute a smaller extent which any</span>
    <span class="token comment">// closer feature must intersect.  We continue searching with this smaller</span>
    <span class="token comment">// extent, trying to find a closer feature.  Every time we find a closer</span>
    <span class="token comment">// feature, we update the extent being searched so that any even closer</span>
    <span class="token comment">// feature must intersect it.  We continue until we run out of features.</span>
    <span class="token keyword">const</span> x <span class="token operator">=</span> coordinate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> y <span class="token operator">=</span> coordinate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> closestFeature <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> closestPoint <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">NaN</span><span class="token punctuation">,</span> <span class="token number">NaN</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> minSquaredDistance <span class="token operator">=</span> <span class="token number">Infinity</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> extent <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">Infinity</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">Infinity</span><span class="token punctuation">,</span> <span class="token number">Infinity</span><span class="token punctuation">,</span> <span class="token number">Infinity</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> filter <span class="token operator">=</span> opt_filter <span class="token operator">?</span> opt_filter <span class="token operator">:</span> <span class="token constant">TRUE</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">forEachInExtent</span><span class="token punctuation">(</span>
      extent<span class="token punctuation">,</span>
      <span class="token comment">/**
       * @param {import("../Feature.js").default&lt;Geometry&gt;} feature Feature.
       */</span>
      <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">feature</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">const</span> geometry <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">getGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> previousMinSquaredDistance <span class="token operator">=</span> minSquaredDistance<span class="token punctuation">;</span>
          minSquaredDistance <span class="token operator">=</span> geometry<span class="token punctuation">.</span><span class="token function">closestPointXY</span><span class="token punctuation">(</span>
            x<span class="token punctuation">,</span>
            y<span class="token punctuation">,</span>
            closestPoint<span class="token punctuation">,</span>
            minSquaredDistance
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>minSquaredDistance <span class="token operator">&lt;</span> previousMinSquaredDistance<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            closestFeature <span class="token operator">=</span> feature<span class="token punctuation">;</span>
            <span class="token comment">// This is sneaky.  Reduce the extent that it is currently being</span>
            <span class="token comment">// searched while the R-Tree traversal using this same extent object</span>
            <span class="token comment">// is still in progress.  This is safe because the new extent is</span>
            <span class="token comment">// strictly contained by the old extent.</span>
            <span class="token keyword">const</span> minDistance <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>minSquaredDistance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            extent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> x <span class="token operator">-</span> minDistance<span class="token punctuation">;</span>
            extent<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> y <span class="token operator">-</span> minDistance<span class="token punctuation">;</span>
            extent<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> x <span class="token operator">+</span> minDistance<span class="token punctuation">;</span>
            extent<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> y <span class="token operator">+</span> minDistance<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> closestFeature<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Get the extent of the features currently in the source.
   *
   * This method is not available when the source is configured with
   * `useSpatialIndex` set to `false`.
   * @param {import("../extent.js").Extent} [opt_extent] Destination extent. If provided, no new extent
   *     will be created. Instead, that extent's coordinates will be overwritten.
   * @return {import("../extent.js").Extent} Extent.
   * @api
   */</span>
  <span class="token function">getExtent</span><span class="token punctuation">(</span><span class="token parameter">opt_extent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">getExtent</span><span class="token punctuation">(</span>opt_extent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Get a feature by its identifier (the value returned by feature.getId()).
   * Note that the index treats string and numeric identifiers as the same.  So
   * `source.getFeatureById(2)` will return a feature with id `'2'` or `2`.
   *
   * @param {string|number} id Feature identifier.
   * @return {import("../Feature.js").default&lt;Geometry&gt;} The feature (or `null` if not found).
   * @api
   */</span>
  <span class="token function">getFeatureById</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> feature <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idIndex_<span class="token punctuation">[</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> feature <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> feature <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Get a feature by its internal unique identifier (using `getUid`).
   *
   * @param {string} uid Feature identifier.
   * @return {import("../Feature.js").default&lt;Geometry&gt;} The feature (or `null` if not found).
   */</span>
  <span class="token function">getFeatureByUid</span><span class="token punctuation">(</span><span class="token parameter">uid</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> feature <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uidIndex_<span class="token punctuation">[</span>uid<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> feature <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> feature <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Get the format associated with this source.
   *
   * @return {import("../format/Feature.js").default|undefined} The feature format.
   * @api
   */</span>
  <span class="token function">getFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>format_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @return {boolean} The source can have overlapping geometries.
   */</span>
  <span class="token function">getOverlaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>overlaps_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Get the url associated with this source.
   *
   * @return {string|import("../featureloader.js").FeatureUrlFunction|undefined} The url.
   * @api
   */</span>
  <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @param {Event} event Event.
   * @private
   */</span>
  <span class="token function">handleFeatureChange_</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> feature <span class="token operator">=</span> <span class="token comment">/** @type {import("../Feature.js").default&lt;Geometry&gt;} */</span> <span class="token punctuation">(</span>
      event<span class="token punctuation">.</span>target
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> featureKey <span class="token operator">=</span> <span class="token function">getUid</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> geometry <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">getGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>featureKey <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_<span class="token punctuation">[</span>featureKey<span class="token punctuation">]</span> <span class="token operator">=</span> feature<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> extent <span class="token operator">=</span> geometry<span class="token punctuation">.</span><span class="token function">getExtent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>featureKey <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_<span class="token punctuation">[</span>featureKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>extent<span class="token punctuation">,</span> feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>extent<span class="token punctuation">,</span> feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> sid <span class="token operator">=</span> id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>idIndex_<span class="token punctuation">[</span>sid<span class="token punctuation">]</span> <span class="token operator">!==</span> feature<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeFromIdIndex_</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>idIndex_<span class="token punctuation">[</span>sid<span class="token punctuation">]</span> <span class="token operator">=</span> feature<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeFromIdIndex_</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>uidIndex_<span class="token punctuation">[</span>featureKey<span class="token punctuation">]</span> <span class="token operator">=</span> feature<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">VectorSourceEvent</span><span class="token punctuation">(</span>VectorEventType<span class="token punctuation">.</span><span class="token constant">CHANGEFEATURE</span><span class="token punctuation">,</span> feature<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Returns true if the feature is contained within the source.
   * @param {import("../Feature.js").default&lt;Geometry&gt;} feature Feature.
   * @return {boolean} Has feature.
   * @api
   */</span>
  <span class="token function">hasFeature</span><span class="token punctuation">(</span><span class="token parameter">feature</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> id <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idIndex_<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token function">getUid</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uidIndex_<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @return {boolean} Is empty.
   */</span>
  <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @param {import("../extent.js").Extent} extent Extent.
   * @param {number} resolution Resolution.
   * @param {import("../proj/Projection.js").default} projection Projection.
   */</span>
  <span class="token function">loadFeatures</span><span class="token punctuation">(</span><span class="token parameter">extent<span class="token punctuation">,</span> resolution<span class="token punctuation">,</span> projection</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> loadedExtentsRtree <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loadedExtentsRtree_<span class="token punctuation">;</span>
    <span class="token keyword">const</span> extentsToLoad <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">strategy_</span><span class="token punctuation">(</span>extent<span class="token punctuation">,</span> resolution<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ii <span class="token operator">=</span> extentsToLoad<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ii<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> extentToLoad <span class="token operator">=</span> extentsToLoad<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> alreadyLoaded <span class="token operator">=</span> loadedExtentsRtree<span class="token punctuation">.</span><span class="token function">forEachInExtent</span><span class="token punctuation">(</span>
        extentToLoad<span class="token punctuation">,</span>
        <span class="token comment">/**
         * @param {<!-- -->{extent: import("../extent.js").Extent}} object Object.
         * @return {boolean} Contains.
         */</span>
        <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token function">containsExtent</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span>extent<span class="token punctuation">,</span> extentToLoad<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>alreadyLoaded<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>loadingExtentsCount_<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>
          <span class="token keyword">new</span> <span class="token class-name">VectorSourceEvent</span><span class="token punctuation">(</span>VectorEventType<span class="token punctuation">.</span><span class="token constant">FEATURESLOADSTART</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loader_</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
          <span class="token keyword">this</span><span class="token punctuation">,</span>
          extentToLoad<span class="token punctuation">,</span>
          resolution<span class="token punctuation">,</span>
          projection<span class="token punctuation">,</span>
          <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">features</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">--</span><span class="token keyword">this</span><span class="token punctuation">.</span>loadingExtentsCount_<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>
              <span class="token keyword">new</span> <span class="token class-name">VectorSourceEvent</span><span class="token punctuation">(</span>
                VectorEventType<span class="token punctuation">.</span><span class="token constant">FEATURESLOADEND</span><span class="token punctuation">,</span>
                <span class="token keyword">undefined</span><span class="token punctuation">,</span>
                features
              <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">--</span><span class="token keyword">this</span><span class="token punctuation">.</span>loadingExtentsCount_<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>
              <span class="token keyword">new</span> <span class="token class-name">VectorSourceEvent</span><span class="token punctuation">(</span>VectorEventType<span class="token punctuation">.</span><span class="token constant">FEATURESLOADERROR</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        loadedExtentsRtree<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>extentToLoad<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>extent<span class="token operator">:</span> extentToLoad<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>loader_<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loadingExtentsCount_ <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loadedExtentsRtree_<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Remove an extent from the list of loaded extents.
   * @param {import("../extent.js").Extent} extent Extent.
   * @api
   */</span>
  <span class="token function">removeLoadedExtent</span><span class="token punctuation">(</span><span class="token parameter">extent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> loadedExtentsRtree <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loadedExtentsRtree_<span class="token punctuation">;</span>
    <span class="token keyword">let</span> obj<span class="token punctuation">;</span>
    loadedExtentsRtree<span class="token punctuation">.</span><span class="token function">forEachInExtent</span><span class="token punctuation">(</span>extent<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">equals</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span>extent<span class="token punctuation">,</span> extent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        obj <span class="token operator">=</span> object<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      loadedExtentsRtree<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Remove a single feature from the source.  If you want to remove all features
   * at once, use the {@link module:ol/source/Vector~VectorSource#clear #clear()} method
   * instead.
   * @param {import("../Feature.js").default&lt;Geometry&gt;} feature Feature to remove.
   * @api
   */</span>
  <span class="token function">removeFeature</span><span class="token punctuation">(</span><span class="token parameter">feature</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> featureKey <span class="token operator">=</span> <span class="token function">getUid</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>featureKey <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nullGeometryFeatures_<span class="token punctuation">[</span>featureKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>featuresRtree_<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeFeatureInternal</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Remove feature without firing a `change` event.
   * @param {import("../Feature.js").default&lt;Geometry&gt;} feature Feature.
   * @protected
   */</span>
  <span class="token function">removeFeatureInternal</span><span class="token punctuation">(</span><span class="token parameter">feature</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> featureKey <span class="token operator">=</span> <span class="token function">getUid</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>featureChangeKeys_<span class="token punctuation">[</span>featureKey<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>unlistenByKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>featureChangeKeys_<span class="token punctuation">[</span>featureKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idIndex_<span class="token punctuation">[</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uidIndex_<span class="token punctuation">[</span>featureKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">VectorSourceEvent</span><span class="token punctuation">(</span>VectorEventType<span class="token punctuation">.</span><span class="token constant">REMOVEFEATURE</span><span class="token punctuation">,</span> feature<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Remove a feature from the id index.  Called internally when the feature id
   * may have changed.
   * @param {import("../Feature.js").default&lt;Geometry&gt;} feature The feature.
   * @return {boolean} Removed the feature from the index.
   * @private
   */</span>
  <span class="token function">removeFromIdIndex_</span><span class="token punctuation">(</span><span class="token parameter">feature</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> removed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> id <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idIndex_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>idIndex_<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">===</span> feature<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idIndex_<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
        removed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> removed<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Set the new loader of the source. The next render cycle will use the
   * new loader.
   * @param {import("../featureloader.js").FeatureLoader} loader The loader to set.
   * @api
   */</span>
  <span class="token function">setLoader</span><span class="token punctuation">(</span><span class="token parameter">loader</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loader_ <span class="token operator">=</span> loader<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Points the source to a new url. The next render cycle will use the new url.
   * @param {string|import("../featureloader.js").FeatureUrlFunction} url Url.
   * @api
   */</span>
  <span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>format_<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// `format` must be set when `url` is set</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url_ <span class="token operator">=</span> url<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setLoader</span><span class="token punctuation">(</span><span class="token function">xhr</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>format_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> VectorSource<span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b5b536ae502fa48b339c43d3b74e676f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CUDA编程(三) —— 编程实践</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ce40ec2a00148599ae538833eeb37a89/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">OpenLayers源码解析7 ol/layer/Vector.js</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>