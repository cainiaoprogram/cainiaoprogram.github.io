<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ansible 概述与模块基本操作 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Ansible 概述与模块基本操作" />
<meta property="og:description" content="文章目录 一、Ansible 概述1.Ansible 的特点2.Ansible 工作机制 二、Ansible 环境安装及部署三、Ansible 命令行模块1.command 模块2.shell 模块3.cron 模块4.user 模块5.group 模块6.copy 模块7.file 模块8.hostname 模块9.ping 模块10.yum 模块11.service/systemctl 模块12.script 模块13.setup 模块 四、inventory 主机清单1.inventory 中的变量2.主机变量3.组变量4.组嵌套 一、Ansible 概述 Ansible是一款为类Unix系统开发的自由开源的配置和自动化工具
它用Python写成，类似于saltstack、Puppet、CHef，但是有一个不同和优点是我们不需要在节点中安装任何客户端
它使用SSH来和节点进行通信。Ansible基于 Pthon paramiko 开发，分布式，无需客户端，轻量级，配置语法使用 YMAL 及 Jinja2模板语言，更强的远程命令执行操作
Ansible官方网站：https://www.ansible.com/，红帽公司于2015年10月收购了ansible，而ansible成立于2013年
Ansible能批量配置、部署、管理上千台主机。比如以前需要切换到每个主机上执行的一或多个操作，使用Ansible 只需在固定的一台Ansible控制节点上去完成所有主机的操作
使用者在使用时，在服务器终端输入命令或者playbooks，会通过预定好的规则将playbook拆解为play，再组织成ansible可以识别的任务，调用模块和插件，根据主机清单通过SSH将临时文件发给远程的客户端执行并返回结果，执行结束后自动删除
1.Ansible 的特点 1.部署简单，没有客户端，只需在主控端部署Ansible环境，被控端无需做任何操作
2.模块化：调用特定的模块，完成特定任务
3.默认使用SSH协议对设备进行管理
4.主从集中化管理
5.配置简单、功能强大、扩展性强
6.支持API及自定义模块，可通过Python轻松扩展
7.通过Playbooks来定制强大的配置、状态管理
8.对云计算平台、大数据都有很好的支持
9.具有幂等性：一个操作在一个主机上执行一遍和执行N遍的结果是一样的
2.Ansible 工作机制 Ansible 在管理节点将 Ansible 模块通过 SSH 协议推送到被管理端执行，执行完之后自动删除，可以使用 SVN 等来管理自定义模块及编排
ansible是基于模块工作的，本身没有批量部署的能力，真正具有批量部署的是ansible所运行的模块，ansible只是提供一种框架。主要包括：
(1)连接插件connection plugins：负责和被监控端实现通信
(2)host inventory：指定操作的主机，是一个配置文件里面定义监控的主机
(3)各种模块核心模块、command模块、自定义模块
(4)借助于插件完成记录日志邮件等功能
(5)playbook：剧本执行多个任务时，非必需可以让节点一次性运行多个任务
由图可以看出Ansible的组成由以下模块组成：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0c3bae7f5a1e0b6c48751d7f571667f3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-19T08:39:20+08:00" />
<meta property="article:modified_time" content="2022-09-19T08:39:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ansible 概述与模块基本操作</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Ansible__1" rel="nofollow">一、Ansible 概述</a></li><li><ul><li><a href="#1Ansible__14" rel="nofollow">1.Ansible 的特点</a></li><li><a href="#2Ansible__34" rel="nofollow">2.Ansible 工作机制</a></li></ul> 
  </li><li><a href="#Ansible__62" rel="nofollow">二、Ansible 环境安装及部署</a></li><li><a href="#Ansible__112" rel="nofollow">三、Ansible 命令行模块</a></li><li><ul><li><a href="#1command__119" rel="nofollow">1.command 模块</a></li><li><a href="#2shell__158" rel="nofollow">2.shell 模块</a></li><li><a href="#3cron__174" rel="nofollow">3.cron 模块</a></li><li><a href="#4user__211" rel="nofollow">4.user 模块</a></li><li><a href="#5group__248" rel="nofollow">5.group 模块</a></li><li><a href="#6copy__274" rel="nofollow">6.copy 模块</a></li><li><a href="#7file__312" rel="nofollow">7.file 模块</a></li><li><a href="#8hostname__350" rel="nofollow">8.hostname 模块</a></li><li><a href="#9ping__357" rel="nofollow">9.ping 模块</a></li><li><a href="#10yum__367" rel="nofollow">10.yum 模块</a></li><li><a href="#11servicesystemctl__386" rel="nofollow">11.service/systemctl 模块</a></li><li><a href="#12script__418" rel="nofollow">12.script 模块</a></li><li><a href="#13setup__436" rel="nofollow">13.setup 模块</a></li></ul> 
  </li><li><a href="#inventory__456" rel="nofollow">四、inventory 主机清单</a></li><li><ul><li><a href="#1inventory__502" rel="nofollow">1.inventory 中的变量</a></li><li><a href="#2_517" rel="nofollow">2.主机变量</a></li><li><a href="#3_532" rel="nofollow">3.组变量</a></li><li><a href="#4_543" rel="nofollow">4.组嵌套</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Ansible__1"></a>一、Ansible 概述</h2> 
<ul><li> <p>Ansible是一款为类Unix系统开发的自由开源的配置和自动化工具</p> </li><li> <p>它用Python写成，类似于saltstack、Puppet、CHef，但是有一个不同和优点是我们不需要在节点中安装任何客户端</p> </li><li> <p>它使用SSH来和节点进行通信。Ansible基于 Pthon paramiko 开发，分布式，无需客户端，轻量级，配置语法使用 YMAL 及 Jinja2模板语言，更强的远程命令执行操作</p> </li><li> <p>Ansible官方网站：https://www.ansible.com/，红帽公司于2015年10月收购了ansible，而ansible成立于2013年</p> </li><li> <p>Ansible能批量配置、部署、管理上千台主机。比如以前需要切换到每个主机上执行的一或多个操作，使用Ansible 只需在固定的一台Ansible控制节点上去完成所有主机的操作</p> </li><li> <p>使用者在使用时，在服务器终端输入命令或者playbooks，会通过预定好的规则将playbook拆解为play，再组织成ansible可以识别的任务，调用模块和插件，根据主机清单通过SSH将临时文件发给远程的客户端执行并返回结果，执行结束后自动删除</p> </li></ul> 
<h3><a id="1Ansible__14"></a>1.Ansible 的特点</h3> 
<p>1.部署简单，没有客户端，只需在主控端部署Ansible环境，被控端无需做任何操作</p> 
<p>2.模块化：调用特定的模块，完成特定任务</p> 
<p>3.默认使用SSH协议对设备进行管理</p> 
<p>4.主从集中化管理</p> 
<p>5.配置简单、功能强大、扩展性强</p> 
<p>6.支持API及自定义模块，可通过Python轻松扩展</p> 
<p>7.通过Playbooks来定制强大的配置、状态管理</p> 
<p>8.对云计算平台、大数据都有很好的支持</p> 
<p>9.具有幂等性：一个操作在一个主机上执行一遍和执行N遍的结果是一样的</p> 
<h3><a id="2Ansible__34"></a>2.Ansible 工作机制</h3> 
<p>Ansible 在管理节点将 Ansible 模块通过 SSH 协议推送到被管理端执行，执行完之后自动删除，可以使用 SVN 等来管理自定义模块及编排</p> 
<p><img src="https://images2.imgbox.com/78/56/gt2vkvyX_o.png" alt="在这里插入图片描述"></p> 
<p>ansible是基于模块工作的，本身没有批量部署的能力，真正具有批量部署的是ansible所运行的模块，ansible只是提供一种框架。主要包括：<br> (1)连接插件connection plugins：负责和被监控端实现通信<br> (2)host inventory：指定操作的主机，是一个配置文件里面定义监控的主机<br> (3)各种模块核心模块、command模块、自定义模块<br> (4)借助于插件完成记录日志邮件等功能<br> (5)playbook：剧本执行多个任务时，非必需可以让节点一次性运行多个任务</p> 
<p>由图可以看出Ansible的组成由以下模块组成：</p> 
<pre><code class="prism language-bash">Ansible： ansible的核心模块
Host Inventory：主机清单，也就是被管理的主机列表
Playbooks：ansible的剧本，可想象为将多个任务放置在一起，一块执行
Core Modules：ansible的核心模块
Custom Modules：自定义模块
Connection Plugins：连接插件，用于与被管控主机之间基于SSH建立连接关系
Plugins：其他插件，包括记录日志等
</code></pre> 
<h2><a id="Ansible__62"></a>二、Ansible 环境安装及部署</h2> 
<table><thead><tr><th>服务器名</th><th>IP</th><th>安装的服务</th></tr></thead><tbody><tr><td>管理端</td><td>192.168.113.125</td><td>Ansible</td></tr><tr><td>被管理端</td><td>192.168.113.128</td><td></td></tr><tr><td>被管理端</td><td>192.168.113.129</td><td></td></tr></tbody></table> 
<pre><code class="prism language-bash"><span class="token comment">#每台机器关闭防火墙核心防护</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop firewalld</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># systemctl disable firewalld</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># setenforce 0</span>
</code></pre> 
<p><strong>1.管理端操作（192.168.113.125）</strong></p> 
<pre><code class="prism language-bash"><span class="token comment">#1.安装ansible</span>
<span class="token comment">#先安装epel源</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yum install -y epel-release</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yum install -y ansible</span>

<span class="token comment">#2.查看anisble树形结构</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yum install -y tree</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># tree /etc/ansible/</span>
/etc/ansible/
├── ansible.cfg			<span class="token comment">#ansible的配置文件，一般 无需修</span>
├── hosts				<span class="token comment">#ansible的主机清单，用于存储需要管理的远程主机的相关信息</span>
└── roles				<span class="token comment">#公共角色目录</span>

<span class="token comment">#3.配置主机清单，最后一行添加</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/ansible/hosts </span>
<span class="token punctuation">[</span>webservers<span class="token punctuation">]</span>       <span class="token comment">#配置组名</span>
<span class="token number">192.168</span>.113.128    <span class="token comment">#组里包含的被管理的主机IP地址或主机名(主机名需要先修改/etc/hosts文件)</span>

<span class="token punctuation">[</span>dbservers<span class="token punctuation">]</span>
<span class="token number">192.168</span>.113.129

<span class="token comment">#4.配置密钥对验证</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ssh-keygen -t rsa    #一路回车，使用免密登录</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># sshpass -p '123123' ssh-copy-id root@192.168.113.129</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># sshpass -p '123123' ssh-copy-id root@192.168.113.128</span>
<span class="token comment">#sshpass -p是一种免交互方式</span>

<span class="token comment">#测试免交互</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ssh 192.168.113.129</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ssh 192.168.113.128</span>
</code></pre> 
<h2><a id="Ansible__112"></a>三、Ansible 命令行模块</h2> 
<pre><code class="prism language-bash">命令格式： ansible <span class="token operator">&lt;</span>组名<span class="token operator">&gt;</span> -m <span class="token operator">&lt;</span>模块<span class="token operator">&gt;</span> -a <span class="token operator">&lt;</span>参数列表<span class="token operator">&gt;</span>
ansible-doc -l      <span class="token comment">#列出所有已安装的模块，按q退出</span>
</code></pre> 
<h3><a id="1command__119"></a>1.command 模块</h3> 
<pre><code class="prism language-bash"><span class="token comment">#在远程主机执行命令，不支持管道，重定向等shell的特性</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible-doc -s command   #-s 列出指定模块的描述信息和操作动作，按q退出</span>

<span class="token comment">#指定ip执行date</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible 192.168.113.128 -m command -a 'date'</span>

<span class="token comment">#指定组执行date</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible webservers -m command -a 'date'</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m command -a 'date'</span>

<span class="token comment">#all代表所有hosts 主机</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible all -m command -a 'date'</span>

<span class="token comment">#如省略-m 模块，则默认运行command 模块，查看所有主机的目录</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible all -a 'ls /'</span>


<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible all -m command -a "chdir=/home ls ./"</span>
<span class="token comment">#常用的参数：</span>
chdir: 在远程主机上运行命令前，提前进入目录
creates: 在命令运行时创建一个文件，如果文件存在，则不会创建任务
removes:在命令运行时移除一个文件，如果文件不存在，则不会执行移除任务
executeble:指明运行命令的shell程序
</code></pre> 
<p>#指定ip执行date</p> 
<p><img src="https://images2.imgbox.com/62/64/99iW1ghR_o.png" alt="在这里插入图片描述"></p> 
<p>#指定组执行date，all代表所有hosts 主机</p> 
<p><img src="https://images2.imgbox.com/24/04/CbIX3HFV_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2shell__158"></a>2.shell 模块</h3> 
<pre><code class="prism language-bash"><span class="token comment">#在远程主机执行命令，相当于调用远程主机的shell进程，然后在该shell下打开一个子shell运行命令(支持管道符号等功能)</span>
<span class="token comment">#列出指定模块的描述信息和操作动作，按q退出</span>
ansible-doc -s shell

<span class="token comment">#指定dbservers组执行shell模块打印出ifconfig ens33第二行第二列，以空格分割截取第二列</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m shell -a 'echo $(ifconfig ens33 | awk "NR==2 {print $2}") | cut -d " " -f2'</span>

<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m shell -a 'echo $(ifconfig ens33 | awk "NR==2 {print \$2}")'</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/eb/cb/c1Jl1ESE_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3cron__174"></a>3.cron 模块</h3> 
<pre><code class="prism language-bash"><span class="token comment">#在远程主机定义任务计划。其中有两种状态(state) : present表示添加 (可以省略) ，absent表示移除</span>
ansible-doc -s <span class="token function">cron</span> 

<span class="token comment">#常用参数：</span>
minute/hour/day/month/weekday:分/时/日/月/周
job: 任务计划要执行的命令
name: 任务计划的名称

<span class="token comment">#指定那个组调用cron模块每一分钟执行一次helloworld并确定目录名字</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible webservers -m cron -a 'minute="*/1" job="/bin/echo helloworld" name="test crontab"'</span>

<span class="token comment">#查看计划任务</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible webservers -a 'crontab -l'</span>

<span class="token comment">#移除计划任务，假如该计划任务没有取名字，name=None即可，再次查看计划任务就没了</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible webservers -m cron -a 'name="test crontab" state=absent'</span>

eg:
<span class="token comment">##10号到20号，每两个小时执行一次hello</span>
ansible webservers -m <span class="token function">cron</span> -a <span class="token string">'hour="*/2" day="10-20" job="/bin/echo hello" name="cron hello"'</span>
ansible webservers -a <span class="token string">'crontab -l'</span>

<span class="token comment">#移除相关效果</span>
ansible webservers -m <span class="token function">cron</span> -a <span class="token string">'name="cron helli" state=absent'</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/da/db/Yhwl2Ucc_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/33/07/kYoySb0h_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/0a/a2/rz8tlZdz_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4user__211"></a>4.user 模块</h3> 
<pre><code class="prism language-bash"><span class="token comment">#用户管理的模块</span>
ansible-doc -s user

<span class="token comment">#常用参数：</span>
<span class="token comment">#name:用户名，必选参数</span>
<span class="token comment">#state-present | absent:创建账号或者删除账号，present表示创建，absent表示删除</span>
<span class="token comment">#system=yes|no:是否为系统账号</span>
<span class="token comment">#uid:用户uid</span>
<span class="token comment">#group:用户基本组</span>
<span class="token comment">#shell:默认使用的shell</span>
<span class="token comment">#move_home=yes|no:如果设置的家目录已经存在，是否将已经存在的家目录进行移动</span>
<span class="token comment">#password:用户的密码，建议使用加密后的字符串</span>
<span class="token comment">#comment:用户的注释信息</span>
<span class="token comment">#remove=yes|no:当state=absent时， 是否删除用户的家目录</span>


<span class="token comment">#例：指定dbservers组创建用户q1</span>
 <span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m user -a 'name="q1"'</span>
 
<span class="token comment">#查看是否创建</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m command -a 'tail /etc/passwd'</span>

<span class="token comment">#指定dbservers组删除用户q1</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m user -a 'name="q1" state=absent</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/44/e8/JadCcgMB_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/73/2e/bNZyroa0_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/a8/87/LezXX4eV_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5group__248"></a>5.group 模块</h3> 
<pre><code class="prism language-bash"><span class="token comment">#用户组管理的模块</span>
ansible-doc -s group

<span class="token comment">#创建qjm组</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m group -a 'name=qjm gid=1007 system=yes' </span>

<span class="token comment">#查看</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -a 'tail -3 /etc/group'</span>

<span class="token comment">#新建一个用户添加到qjm组</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m user -a 'name=q1 uid=1007 system=yes group=qjm'</span>

<span class="token comment">#查看是否添加有两种方法</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -a 'tail -3 /etc/passwd'</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -a 'id q1'</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5f/04/xNymsXR0_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/2b/50/61qSMvRn_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="6copy__274"></a>6.copy 模块</h3> 
<pre><code class="prism language-bash"><span class="token comment">#用于复制指定主机文件到远程主机的</span>
ansible-doc -s copy

常用参数：
<span class="token comment">#dest:指出复制文件的目标及位置，使用绝对路径，如果是源目录，指目标也要是目录，如果目标文件已经存在会覆盖原有的内容</span>
<span class="token comment">#src:指出源文件的路径，可以使用相对路径或绝对路径，支持直接指定目录，如果源是目录则目标也要是日录</span>
<span class="token comment">#mode:指出复制时，目标文件的权限</span>
<span class="token comment">#owner:指出复制时，目标文件的属主</span>
<span class="token comment">#group:指出复制时，目标文件的属组</span>
<span class="token comment">#content:指出复制到目标主机上的内容，不能与src一起使用</span>

<span class="token comment">#例1:</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m copy -a 'src=/etc/fstab dest=/opt/fstab.bak owner=root mode=640'</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -a 'ls -l /opt'  #查看权限</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># absible dbservers -a 'cat /opt/fstab.bak'  #查看内容</span>

<span class="token comment">#例2:</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m copy -a 'content="helloworld" dest=/opt/hello.txt'  #将helloworld写入/opt/he1lo.txt文件中</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -a 'cat /opt/hello.txt'</span>
</code></pre> 
<p>例1：<br> <img src="https://images2.imgbox.com/c6/81/j7nASAbP_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/6c/3e/muG1qIij_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/cf/87/Rc08mZFN_o.png" alt="在这里插入图片描述"></p> 
<p>例2：<br> <img src="https://images2.imgbox.com/20/05/asGjuZri_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="7file__312"></a>7.file 模块</h3> 
<pre><code class="prism language-bash"><span class="token comment">#设置文件属性</span>
ansible-doc -s <span class="token function">file</span>

<span class="token comment">#常用参数</span>
path：指定路径

例：
<span class="token comment">#修改文件的属主属组权限</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m file -a 'owner=q1 group=qjm mode=644 path=/opt/fstab.bak'</span>

<span class="token comment">#设置/opt/fstab.link为/opt/fstab.bak的链接文件</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m file -a 'path=/opt/fstab.link src=/opt/fstab.bak state=link'</span>

<span class="token comment">#查看是否创建</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -a 'ls -l /opt'</span>

<span class="token comment">#创建一个文件</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m file -a "path=/opt/abc.txt state=touch"</span>

<span class="token comment">#删除一个文件</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m file -a "path=/opt/abc.txt state=absent"</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b3/68/eArDF1Zg_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/f7/96/vzxcKIxw_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/2d/d0/dxcAEZF5_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/5f/fc/bqHm3DxM_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="8hostname__350"></a>8.hostname 模块</h3> 
<pre><code class="prism language-bash"><span class="token comment">#用于管理远程主机上的主机名</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m hostname -a "name=q2"</span>
</code></pre> 
<h3><a id="9ping__357"></a>9.ping 模块</h3> 
<pre><code class="prism language-bash"><span class="token comment">#检测远程主机的连通性</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible all -m ping</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c2/fb/7ynBolQ0_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="10yum__367"></a>10.yum 模块</h3> 
<pre><code class="prism language-bash"><span class="token comment">#在远程主机.上安装与卸载软件包</span>
ansible-doc -s yum

<span class="token comment">#安装服务</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible webservers -m yum -a 'name=httpd'</span>

<span class="token comment">#卸载服务</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible webservers -m yum -a 'name=httpd state=absent'</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/bc/e1/gi4BIQSb_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/57/c5/yvCtTlzV_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="11servicesystemctl__386"></a>11.service/systemctl 模块</h3> 
<pre><code class="prism language-bash"><span class="token comment">#用于管理远程主机上的管理服务的运行状态</span>
ansible-doc -s <span class="token function">service</span>

常用的参数:
<span class="token comment">#name:被管理的服务名称</span>
<span class="token comment">#state=started|stopped|restarted:动作包含启动关闭或者重启</span>
<span class="token comment">#enabled=yes|no:表示是否设置该服务开机自启</span>
<span class="token comment">#runlevel:如果设定了enabled开机自启去，则要定义在哪些运行目标下自启动</span>

<span class="token comment">#查看web服务器httpd运行状态，先安装下前面删掉了</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible webservers -m yum -a 'name=httpd'</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible webservers -a 'systemctl status httpd'</span>

<span class="token comment">#启动httpd服务</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible webservers -m service -a 'enabled=true name=httpd state=started'</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c5/70/Uem2cQmv_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/d7/4f/9A4ntDeT_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/8b/4e/0t13b3ba_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/d1/58/EZlIebeb_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="12script__418"></a>12.script 模块</h3> 
<pre><code class="prism language-bash"><span class="token comment">#实现远程批量运行本地的shell脚本</span>
ansible-doc -S script

<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># vim test.sh</span>
<span class="token comment">#!/bin/bash</span>
<span class="token builtin class-name">echo</span> <span class="token string">"hello ansible from script"</span> <span class="token operator">&gt;</span> /opt/script.txt
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># chmod +x test.sh </span>

<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible webservers -m script -a 'test.sh'</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible webservers -a 'cat /opt/script.txt'</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/cb/93/kOXiLPfF_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="13setup__436"></a>13.setup 模块</h3> 
<pre><code class="prism language-bash"><span class="token comment">#facts 组件是用来收集被管理节点信息的，使用setup 模块可以获取这些信息</span>
ansible-doc -s setup

例：
<span class="token comment">#获取qjm组主机的facts信息</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible webservers -m setup </span>

<span class="token comment">#使用filter可以筛选指定的facts信息</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible dbservers -m setup -a 'filter=*ipv4'</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ca/00/qOM49Wzi_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/0c/d5/kimYQAb3_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="inventory__456"></a>四、inventory 主机清单</h2> 
<ul><li>inventory支持对主机进行分组，每个组内可以定义多个主机，每个主机都可以定义在任何一个或多个主机组内</li></ul> 
<pre><code class="prism language-bash">
<span class="token comment">#如果是名称类似的主机，可以使用列表的方式标识各个主机</span>
<span class="token punctuation">[</span>root@server2 opt<span class="token punctuation">]</span><span class="token comment"># vim /etc/ssh/sshd_config   #去被管理者机器，17行取消注释，随意更改端口号但要和管理者机器配置的端口号一致（192.168.113.128）</span>
<span class="token comment">#重启服务</span>
<span class="token punctuation">[</span>root@server2 opt<span class="token punctuation">]</span><span class="token comment"># systemctl restart sshd</span>
<span class="token punctuation">[</span>root@server2 opt<span class="token punctuation">]</span><span class="token comment"># netstat -ntlp|grep ssh  #查看端口是否更改</span>

<span class="token comment">#管理者机器操作（192.168.113.125）</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/ansible/hosts </span>
<span class="token punctuation">[</span>webservers<span class="token punctuation">]</span>
<span class="token number">192.168</span>.113.128:1007   <span class="token comment">#冒号后定义远程连接端口，默认是ssh的22端口</span>

------------------------------------------------------------------
<span class="token number">192.168</span>.113.12<span class="token punctuation">[</span><span class="token number">1</span>:9<span class="token punctuation">]</span>    <span class="token comment">#可访问192.168.113.121-129的机器，只是例子免密交互没做和机器没有那么多</span>
<span class="token punctuation">[</span>dbservers<span class="token punctuation">]</span>
db-<span class="token punctuation">[</span>a:f<span class="token punctuation">]</span>.example.org    <span class="token comment">#支持匹配a~f,一样是例子</span>
------------------------------------------------------------------

<span class="token comment">#测试</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible webservers -a 'ls /'  #端口不一样的情况下是查看不了的</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b1/d3/2PQGAOVc_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/6d/8c/7cQ8GrJG_o.png" alt="在这里插入图片描述"></p> 
<p>#端口号不一致是查看</p> 
<p><img src="https://images2.imgbox.com/ff/0b/xvo2VYOA_o.png" alt="在这里插入图片描述"></p> 
<p>#一致时查看</p> 
<p><img src="https://images2.imgbox.com/7d/e0/skOTeB35_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/90/d2/0Rg7ByRF_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="1inventory__502"></a>1.inventory 中的变量</h3> 
<table><thead><tr><th><strong>Inventory变量名</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>ansible_host</td><td>ansible连接节点时的IP地址</td></tr><tr><td>ansible_port</td><td>连接对方的端口号，ssh连接时默认为22</td></tr><tr><td>ansible_user</td><td>连接对方主机时使用的主机名。不指定时，将使用执行ansible或ansible-playbook命令的用户</td></tr><tr><td>ansible_password</td><td>连接时的用户的ssh密码，仅在未使用密钥对验证的情况下有效</td></tr><tr><td>ansible_ssh_ private_key_file</td><td>指定密钥认证ssh连接时的私钥文件</td></tr><tr><td>ansible_ssh_common_args</td><td>提供给ssh、sftp、 scp命令的额外参数</td></tr><tr><td>ansible become</td><td>允许进行权限提升</td></tr><tr><td>ansible become_ method</td><td>指定提升权限的方式，例如可使用sudo/ su/runas等方式</td></tr><tr><td>ansible become_user</td><td>提升为哪个用户的权限，默认提升为root</td></tr><tr><td>ansible_become_password</td><td>提升为指定用户权限时的密码</td></tr></tbody></table> 
<h3><a id="2_517"></a>2.主机变量</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/ansible/host</span>
<span class="token punctuation">[</span>webservers<span class="token punctuation">]</span>
<span class="token number">192.168</span>.113.128 <span class="token assign-left variable">ansile_port</span><span class="token operator">=</span><span class="token number">22</span> <span class="token assign-left variable">ansible_user</span><span class="token operator">=</span>root <span class="token assign-left variable">ansible_password</span><span class="token operator">=</span><span class="token number">123123</span>

<span class="token comment">#测试</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ansible webservers -a 'ls /'</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a3/94/KOhXpVjF_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/f0/6a/emfsPLs6_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_532"></a>3.组变量</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>webservers:vars<span class="token punctuation">]</span>     <span class="token comment">#表示为webservers 组内所有主机定义变量</span>
<span class="token assign-left variable">ansible_user</span><span class="token operator">=</span>root
<span class="token assign-left variable">ansible_password</span><span class="token operator">=</span><span class="token number">123123</span>

<span class="token punctuation">[</span>all:vars<span class="token punctuation">]</span>       <span class="token comment">#表示为所有组内的所有主机定义变量</span>
<span class="token assign-left variable">ansible_port</span><span class="token operator">=</span><span class="token number">22</span>
</code></pre> 
<h3><a id="4_543"></a>4.组嵌套</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>nginx<span class="token punctuation">]</span>
<span class="token number">192.168</span>.113.126
<span class="token number">192.168</span>.113.130
<span class="token number">192.168</span>.113.127

<span class="token punctuation">[</span>apache<span class="token punctuation">]</span>
<span class="token number">192.168</span>.113.12<span class="token punctuation">[</span><span class="token number">0</span>:3<span class="token punctuation">]</span>

<span class="token punctuation">[</span>webservers: children<span class="token punctuation">]</span>     <span class="token comment">#表示为webservers 主机组中包含了nginx 组和apache 组内的所有主机</span>
nginx
apache
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/54b0966bf1cf803f57ac5e4f66a779f3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数据结构笔记（考研）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/239de80921baa81173a595ff6c516e5a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于如何创建maven私有仓库（docker中），maven中的setting文件内容设置，pom文件中如何设置连接私有仓库与发布到私有仓库</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>