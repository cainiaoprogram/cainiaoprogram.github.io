<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>服务器文件路径的例子,完整SQL Server实例迁移案例 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="服务器文件路径的例子,完整SQL Server实例迁移案例" />
<meta property="og:description" content="1.确认备用服务器的SQL
Server和原版本一致(select
@@version返回的号码必须一模一样)--因为要恢复系统数据库，要保证恢复的master和msdb和原库一致，否则SQL Server不能正常工作。
2.停止SQL
Server服务，并以单用户模式启动
3.Sqlcmd工具连接SQL
Server实例
4.还原master数据库
RESTOREDATABASEmaster
FROMDISK=&#39;C:\backup\master.bak&#39;
withreplace,
MOVE&#39;master&#39;TO&#39;C:\Program
Files\Microsoft SQL
Server\MSSQL11.MSSQLSERVER\MSSQL\DATA\master.mdf&#39;,
MOVE&#39;mastlog&#39;TO&#39;C:\Program
Files\Microsoft SQL
Server\MSSQL11.MSSQLSERVER\MSSQL\DATA\mastlog.ldf&#39;
5.由于恢复的master数据库里记载的其他数据库路径和现在的不一致，这时候重新启动SQL
Server会失败，必须要用跟踪标志3608来启动
6.Sqlcmd连接SQL
Server
7.在原实例上查找各系统数据库文件路径
selectdb_name(database_id),name,physical_name
fromsys.master_files
8.修改其他系统数据库的正确路径
--resource数据库
ALTERDATABASEmssqlsystemresource
MODIFYFILE(NAME=DATA,FILENAME=&#39;C:\Program
Files\Microsoft SQL
Server\MSSQL.4\MSSQL\Data\mssqlsystemresource.mdf&#39;)
GO
ALTERDATABASEmssqlsystemresource
MODIFYFILE(NAME=LOG,FILENAME=&#39;C:\Program
Files\Microsoft SQL
Server\MSSQL.4\MSSQL\Data\mssqlsystemresource.ldf&#39;)
GO
--msdb数据库
ALTERDATABASEmsdb
MODIFYFILE(NAME=MSDBData,FILENAME=&#39;C:\Program
Files\Microsoft SQL
Server\MSSQL.4\MSSQL\Data\msdbdata.mdf&#39;)
GO
ALTERDATABASEmsdb
MODIFYFILE(NAME=MSDBLog,FILENAME=&#39;C:\Program
Files\Microsoft SQL
Server\MSSQL.4\MSSQL\Data\msdblog.ldf&#39;)
GO
--model数据库
ALTERDATABASEmodel
MODIFYFILE(NAME=modeldev,FILENAME=&#39;C:\Program
Files\Microsoft SQL
Server\MSSQL.4\MSSQL\Data\model.mdf&#39;)
GO
ALTERDATABASEmodel
MODIFYFILE(NAME=modellog,FILENAME=&#39;C:\Program
Files\Microsoft SQL
Server\MSSQL.4\MSSQL\Data\modellog.ldf&#39;)
GO
--tempdb数据库
ALTERDATABASEtempdb" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b4ef816ea504557a05d7fc2afa83f5d7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-12T15:10:27+08:00" />
<meta property="article:modified_time" content="2021-08-12T15:10:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">服务器文件路径的例子,完整SQL Server实例迁移案例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>1.确认备用服务器的SQL</p> 
 <p>Server和原版本一致(select</p> 
 <p>@@version返回的号码必须一模一样)--因为要恢复系统数据库，要保证恢复的master和msdb和原库一致，否则SQL Server不能正常工作。</p> 
 <p>2.停止SQL</p> 
 <p>Server服务，并以单用户模式启动</p> 
 <p align="center"><img src="https://images2.imgbox.com/8d/d7/YS2Wl00G_o.png" alt="a4c26d1e5885305701be709a3d33442f.png"></p> 
 <p>3.Sqlcmd工具连接SQL</p> 
 <p>Server实例</p> 
 <p align="center"><img src="https://images2.imgbox.com/ed/9e/AqU1AkRb_o.png" alt="a4c26d1e5885305701be709a3d33442f.png"></p> 
 <p>4.还原master数据库</p> 
 <p>RESTOREDATABASEmaster</p> 
 <p>FROMDISK='C:\backup\master.bak'</p> 
 <p>withreplace,</p> 
 <p>MOVE'master'TO'C:\Program</p> 
 <p>Files\Microsoft SQL</p> 
 <p>Server\MSSQL11.MSSQLSERVER\MSSQL\DATA\master.mdf',</p> 
 <p>MOVE'mastlog'TO'C:\Program</p> 
 <p>Files\Microsoft SQL</p> 
 <p>Server\MSSQL11.MSSQLSERVER\MSSQL\DATA\mastlog.ldf'</p> 
 <p align="center"><img src="https://images2.imgbox.com/53/18/40CtXNZi_o.png" alt="a4c26d1e5885305701be709a3d33442f.png"></p> 
 <p>5.由于恢复的master数据库里记载的其他数据库路径和现在的不一致，这时候重新启动SQL</p> 
 <p>Server会失败，必须要用跟踪标志3608来启动</p> 
 <p align="center"><img src="https://images2.imgbox.com/39/52/zGj1lHiy_o.png" alt="a4c26d1e5885305701be709a3d33442f.png"></p> 
 <p>6.Sqlcmd连接SQL</p> 
 <p>Server</p> 
 <p align="center"><img src="https://images2.imgbox.com/14/2f/HkNfDVGb_o.png" alt="a4c26d1e5885305701be709a3d33442f.png"></p> 
 <p>7.在原实例上查找各系统数据库文件路径</p> 
 <p>selectdb_name(database_id),name,physical_name</p> 
 <p>fromsys.master_files</p> 
 <p align="center"><img src="https://images2.imgbox.com/94/6c/3viV6pSQ_o.png" alt="a4c26d1e5885305701be709a3d33442f.png"></p> 
 <p>8.修改其他系统数据库的正确路径</p> 
 <p align="center"><img src="https://images2.imgbox.com/bc/88/yQqM6A1X_o.png" alt="a4c26d1e5885305701be709a3d33442f.png"></p> 
 <p>--resource数据库</p> 
 <p>ALTERDATABASEmssqlsystemresource</p> 
 <p>MODIFYFILE(NAME=DATA,FILENAME='C:\Program</p> 
 <p>Files\Microsoft SQL</p> 
 <p>Server\MSSQL.4\MSSQL\Data\mssqlsystemresource.mdf')</p> 
 <p>GO</p> 
 <p>ALTERDATABASEmssqlsystemresource</p> 
 <p>MODIFYFILE(NAME=LOG,FILENAME='C:\Program</p> 
 <p>Files\Microsoft SQL</p> 
 <p>Server\MSSQL.4\MSSQL\Data\mssqlsystemresource.ldf')</p> 
 <p>GO</p> 
 <p>--msdb数据库</p> 
 <p>ALTERDATABASEmsdb</p> 
 <p>MODIFYFILE(NAME=MSDBData,FILENAME='C:\Program</p> 
 <p>Files\Microsoft SQL</p> 
 <p>Server\MSSQL.4\MSSQL\Data\msdbdata.mdf')</p> 
 <p>GO</p> 
 <p>ALTERDATABASEmsdb</p> 
 <p>MODIFYFILE(NAME=MSDBLog,FILENAME='C:\Program</p> 
 <p>Files\Microsoft SQL</p> 
 <p>Server\MSSQL.4\MSSQL\Data\msdblog.ldf')</p> 
 <p>GO</p> 
 <p>--model数据库</p> 
 <p>ALTERDATABASEmodel</p> 
 <p>MODIFYFILE(NAME=modeldev,FILENAME='C:\Program</p> 
 <p>Files\Microsoft SQL</p> 
 <p>Server\MSSQL.4\MSSQL\Data\model.mdf')</p> 
 <p>GO</p> 
 <p>ALTERDATABASEmodel</p> 
 <p>MODIFYFILE(NAME=modellog,FILENAME='C:\Program</p> 
 <p>Files\Microsoft SQL</p> 
 <p>Server\MSSQL.4\MSSQL\Data\modellog.ldf')</p> 
 <p>GO</p> 
 <p>--tempdb数据库</p> 
 <p>ALTERDATABASEtempdb</p> 
 <p>MODIFYFILE(NAME=tempdev,FILENAME='C:\Program</p> 
 <p>Files\Microsoft SQL</p> 
 <p>Server\MSSQL.4\MSSQL\Data\tempdb.mdf')</p> 
 <p>GO</p> 
 <p>ALTERDATABASEtempdb</p> 
 <p>MODIFYFILE(NAME=templog,FILENAME='C:\Program</p> 
 <p>Files\Microsoft SQL</p> 
 <p>Server\MSSQL.4\MSSQL\Data\templog.ldf')</p> 
 <p>GO</p> 
 <p>9.停止SQL</p> 
 <p>Server服务，再以正常模式启动</p> 
 <p align="center"><img src="https://images2.imgbox.com/8e/b0/6RCZGwgT_o.png" alt="a4c26d1e5885305701be709a3d33442f.png"></p> 
 <p>--恢复model数据库</p> 
 <p>RESTOREDATABASEmodel</p> 
 <p>FROMDISK='c:\lab\model.bak'3WITH</p> 
 <p>move</p> 
 <p>'modeldev'TO'C:\Program</p> 
 <p>Files\Microsoft SQL</p> 
 <p>Server\MSSQL.4\MSSQL\Data\model.mdf',</p> 
 <p>move'modellog'TO'C:\Program</p> 
 <p>Files\Microsoft SQL</p> 
 <p>Server\MSSQL.4\MSSQL\Data\modellog.ldf',REPLACE</p> 
 <p>--恢复msdb数据库</p> 
 <p>RESTORE DATABASEmsdb</p> 
 <p>FROM DISK='c:\lab\msdb.bak'3</p> 
 <p>WITH</p> 
 <p>move</p> 
 <p>'MSDBData' TO 'C:\Program Files\Microsoft SQL</p> 
 <p>Server\MSSQL.4\MSSQL\Data\MSDBData.mdf',</p> 
 <p>move</p> 
 <p>'MSDBLog' TO 'C:\Program Files\Microsoft SQL</p> 
 <p>Server\MSSQL.4\MSSQL\Data\MSDBLog.ldf' ,REPLACE</p> 
 <p>Ps:为什麽resource数据库跟tempdb数据库不用还原呢？resource：包含SQLSERVER附带的所有系统对象副本的只读数据库，resource数据库是不能备份的，而且在SSMS里是看不见的</p> 
 <p>tempdb：用于保存临时或中间结果集的工作空间。每次启动SQLSERVER实例时SQLSERVER都会根据model数据库为蓝本重新创建此数据库。</p> 
 <p>服务器实例关闭时，将永久删除tempdb数据库中的所有数据</p> 
 <p>10.修改服务器名称</p> 
 <p>迁移到新服务上后需修改master里记录的原服务器名</p> 
 <p>usemaster</p> 
 <p>go</p> 
 <p>select@@servername</p> 
 <p>selectserverproperty('servername')</p> 
 <p>IFserverproperty('servername')&lt;&gt;@@servername</p> 
 <p>BEGIN</p> 
 <p>DECLARE@server</p> 
 <p>SYSNAME</p> 
 <p>SET@server=@@servername</p> 
 <p>EXECsp_dropserver@server=@server</p> 
 <p>SET@server=cast(serverproperty('servername')ASSYSNAME)</p> 
 <p>EXECsp_addserver@server=@server,@local='LOCAL'</p> 
 <p>END</p> 
 <p>ELSE</p> 
 <p>PRINT'实例名与主机名一致，无需修改！'</p> 
 <p>运行完上面语句，重启SQL Server服务，再运行SSELECT@@servername</p> 
 <p>12.恢复所有用户数据库</p> 
 <p>第11步完成后，所有用户数据库都处于置疑状态，因为本地没有数据文件，后续就是恢复所有用户数据库即可</p> 
 <p>USE[master]</p> 
 <p>RESTOREDATABASE[test_shrink]</p> 
 <p>FROMDISK=N'C:\backup\test.bak'WITHFILE=1,</p> 
 <p>MOVEN'test_shrink'TON'C:\Program</p> 
 <p>Files\Microsoft SQL</p> 
 <p>Server\MSSQL11.MSSQLSERVER\MSSQL\DATA\test_shrink.mdf',</p> 
 <p>MOVEN'test_shrink_log'TON'C:\Program</p> 
 <p>Files\Microsoft SQL</p> 
 <p>Server\MSSQL11.MSSQLSERVER\MSSQL\DATA\test_shrink_log.ldf',NOUNLOAD,STATS=5</p> 
 <p>GO</p> 
 <p>--直接对应数据库上右击还原，重定位路径即可。</p> 
 <p>13.迁移完毕检查</p> 
 <p>检查原来所有login是否能成功登陆，linked</p> 
 <p>server、数据库触发器、端点及job等对象是否迁移成功。</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ecc3bd93f1ec4a9be45730e01e7417bd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">柯美彩服务器系统怎么才坏,柯美彩色复印机之系统故障维修技巧</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d9c4d15cf1de1692374dd5ec404e9cc0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">4g没信号就无服务器,福特领界没有4G网络信号故障检修</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>