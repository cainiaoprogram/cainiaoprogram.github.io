<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RT-Thread uart2串口dma idle接收不断帧 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="RT-Thread uart2串口dma idle接收不断帧" />
<meta property="og:description" content="硬件STM32F407，IDE使用RT-Thread Studio。
uart2串口使用这两个引脚：
功能IO端口UART2-TXPA2UART2-RXPA3 UART2 - DMA接收配置 先使能DMA接收，RX缓冲区可以稍微调大些。
board.h 中添加宏，来使能 RX_DMA。
既然都打开了 board.h，再顺便把时钟源改为外部晶振。
编写 UART2 DMA 接收测试代码。
发生接收事件后，会触发回调。回调内记录本次接收的消息长度，并发送信号量。线程内接收到信号量后开始执行后续的任务，调试输出接收到的长度和内容。
main.c
#include &lt;rtthread.h&gt; #define DBG_TAG &#34;main&#34; #define DBG_LVL DBG_LOG #include &lt;rtdbg.h&gt; #include &#34;drivers/serial.h&#34; rt_device_t u2_dev = RT_NULL; struct serial_configure u2_cfg = RT_SERIAL_CONFIG_DEFAULT; struct rt_semaphore u2_rx_sem; rt_thread_t u2_recv_thread; rt_size_t u2_rx_len = 0; rt_err_t u2_rx_callback(rt_device_t dev, rt_size_t size) { u2_rx_len = size; // 记录消息长度 rt_sem_release(&amp;u2_rx_sem); return RT_EOK; } void u2_recv_entry(void *parameter) { char rx_buf[256]; rt_size_t len = 0; while (1) { rt_sem_take(&amp;u2_rx_sem, RT_WAITING_FOREVER); // 等待信号量 len = rt_device_read(u2_dev, 0, rx_buf, u2_rx_len); rx_buf[len] = &#39;\0&#39;; rt_kprintf(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/72ef6adcf36675ebf5de999cbacf0619/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-23T00:49:50+08:00" />
<meta property="article:modified_time" content="2022-06-23T00:49:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">RT-Thread uart2串口dma idle接收不断帧</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>硬件STM32F407，IDE使用RT-Thread Studio。</p> 
<p>uart2串口使用这两个引脚：</p> 
<table><thead><tr><th>功能</th><th>IO端口</th></tr></thead><tbody><tr><td>UART2-TX</td><td>PA2</td></tr><tr><td>UART2-RX</td><td>PA3</td></tr></tbody></table> 
<br> 
<hr> 
<hr> 
<h2><a id="UART2__DMA_12"></a>UART2 - DMA接收配置</h2> 
<ul><li> <p>先使能DMA接收，RX缓冲区可以稍微调大些。<br> <img src="https://images2.imgbox.com/0b/7f/mHpUlbkQ_o.png" alt="在这里插入图片描述"></p> </li><li> <p>board.h 中添加宏，来使能 RX_DMA。<br> <img src="https://images2.imgbox.com/08/48/EQlknksU_o.png" alt="在这里插入图片描述"></p> </li><li> <p>既然都打开了 board.h，再顺便把时钟源改为外部晶振。<br> <img src="https://images2.imgbox.com/35/61/GWtiJZmV_o.png" alt="在这里插入图片描述"></p> </li><li> <p>编写 UART2 DMA 接收测试代码。</p> </li><li> <p>发生接收事件后，会触发回调。回调内记录本次接收的消息长度，并发送信号量。线程内接收到信号量后开始执行后续的任务，调试输出接收到的长度和内容。<br> main.c</p> </li></ul> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;rtthread.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DBG_TAG</span> <span class="token string">"main"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DBG_LVL</span> <span class="token expression">DBG_LOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;rtdbg.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"drivers/serial.h"</span></span>
<span class="token class-name">rt_device_t</span> u2_dev <span class="token operator">=</span> RT_NULL<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">serial_configure</span> u2_cfg <span class="token operator">=</span> RT_SERIAL_CONFIG_DEFAULT<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">rt_semaphore</span> u2_rx_sem<span class="token punctuation">;</span>
<span class="token class-name">rt_thread_t</span> u2_recv_thread<span class="token punctuation">;</span>

<span class="token class-name">rt_size_t</span> u2_rx_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name">rt_err_t</span> <span class="token function">u2_rx_callback</span><span class="token punctuation">(</span><span class="token class-name">rt_device_t</span> dev<span class="token punctuation">,</span> <span class="token class-name">rt_size_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u2_rx_len <span class="token operator">=</span> size<span class="token punctuation">;</span> <span class="token comment">// 记录消息长度</span>
    <span class="token function">rt_sem_release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>u2_rx_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> RT_EOK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">u2_recv_entry</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>parameter<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> rx_buf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">rt_size_t</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">rt_sem_take</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>u2_rx_sem<span class="token punctuation">,</span> RT_WAITING_FOREVER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待信号量</span>
        len <span class="token operator">=</span> <span class="token function">rt_device_read</span><span class="token punctuation">(</span>u2_dev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> rx_buf<span class="token punctuation">,</span> u2_rx_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rx_buf<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
        <span class="token function">rt_kprintf</span><span class="token punctuation">(</span><span class="token string">"u2 recv: %d, %s\n"</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> rx_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">rt_err_t</span> err<span class="token punctuation">;</span>

    u2_dev <span class="token operator">=</span> <span class="token function">rt_device_find</span><span class="token punctuation">(</span><span class="token string">"uart2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>u2_dev <span class="token operator">==</span> RT_NULL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_E</span><span class="token punctuation">(</span><span class="token string">"uart2 rt_device_find failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//rt_device_open(u2_dev, RT_DEVICE_FLAG_RDWR | RT_DEVICE_FLAG_INT_RX);</span>
    err <span class="token operator">=</span> <span class="token function">rt_device_open</span><span class="token punctuation">(</span>u2_dev<span class="token punctuation">,</span> RT_DEVICE_FLAG_DMA_RX<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_E</span><span class="token punctuation">(</span><span class="token string">"uart2 rt_device_open failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">rt_device_control</span><span class="token punctuation">(</span>u2_dev<span class="token punctuation">,</span> RT_DEVICE_CTRL_CONFIG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>u2_cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">rt_device_set_rx_indicate</span><span class="token punctuation">(</span>u2_dev<span class="token punctuation">,</span> u2_rx_callback<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置接收回调函数</span>

    err <span class="token operator">=</span> <span class="token function">rt_sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>u2_rx_sem<span class="token punctuation">,</span> <span class="token string">"u2_rx"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> RT_IPC_FLAG_FIFO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_E</span><span class="token punctuation">(</span><span class="token string">"uart2 rt_sem_init failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    u2_recv_thread <span class="token operator">=</span> <span class="token function">rt_thread_create</span><span class="token punctuation">(</span><span class="token string">"u2_recv"</span><span class="token punctuation">,</span> u2_recv_entry<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 优先级8，时间片长度5</span>

    <span class="token function">rt_thread_startup</span><span class="token punctuation">(</span>u2_recv_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">rt_device_write</span><span class="token punctuation">(</span>u2_dev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> RT_EOK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<br> 
<hr> 
<hr> 
<h2><a id="_99"></a>编译错误解决</h2> 
<ul><li> <p>编译后会提示缺少文件等错误。按如下更改。</p> </li><li> <p>改动RTT源码，添加缺少的头文件。<br> <img src="https://images2.imgbox.com/89/52/bsY44Q2c_o.png" alt="在这里插入图片描述"></p> </li><li> <p>再配置交叉编译器include目录，增加如下：</p> </li></ul> 
<pre><code class="prism language-c"><span class="token string">"${workspace_loc:/${ProjName}/rt-thread/components/drivers/include/drivers}"</span>
<span class="token string">"${workspace_loc:/${ProjName}/rt-thread/components/drivers/include/ipc}"</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f4/3c/13jrJp7w_o.png" alt="在这里插入图片描述"></p> 
<ul><li>添加目录时请使用<code>工作空间</code>，使用的是相对工程文件的路径。（文件系统指的是磁盘的绝对路径，复制工程又要重新配置）<br> <img src="https://images2.imgbox.com/3f/5c/4ZW8haTU_o.png" alt="在这里插入图片描述"></li></ul> 
<br> 
<hr> 
<hr> 
<h2><a id="RX_DMA_120"></a>运行测试RX DMA接收，解决断帧</h2> 
<ul><li> <p>接收正常，但当接收的一帧字节数较长时，非常容易出现断帧。<br> <img src="https://images2.imgbox.com/14/00/Mgx2uRe9_o.png" alt="在这里插入图片描述"></p> </li><li> <p>断帧的解决方法我参考这个，实测好用：<br> <a href="https://blog.csdn.net/coderdd/article/details/108264369">使用RT-Thread的串口空闲+DMA收发数据</a></p> </li><li> <p>找打 drv_usart.c，注释掉这两句。<br> <img src="https://images2.imgbox.com/c6/7d/Kltkcmao_o.png" alt="在这里插入图片描述"></p> </li><li> <p>编译验证，确认经如上修改后就没有了断帧。</p> </li><li> <p>但当接收的一帧字节数大于缓冲区容量时，以前的内容会被覆盖。所以在硬件允许时，uart rx缓冲区可设置的大一些。</p> </li><li> <p>测试发送一帧270字节，当缓冲区容量为256字节时，仅提示收到14字节，前面的内容被覆盖。<br> <img src="https://images2.imgbox.com/b0/a4/FRWifANo_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b5/78/VZKTa4xi_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<hr> 
<hr> 
<h2><a id="RTThread_138"></a>关于RT-Thread的学习</h2> 
<ul><li>官方应用实例、Demo：<a href="https://www.rt-thread.org/document/site/#/" rel="nofollow">文档中心</a></li><li>API文档：<a href="https://www.rt-thread.org/document/api/group__peripheral-sample.html" rel="nofollow">RT-Thread API参考手册</a></li><li>IDE使用RT-Thread Studio，入门教程可以去B站看千峰教育的。</li></ul> 
<p>  本来自己是没计划去学习 RT-Thread 的，但在MCU国产化替代进程中，发现大多数IC厂商提供的支持十分有限，可以说几乎都是在近几年内以STM32为蓝本进行的仿制，其中隐藏的雷坑单靠个人摸索去解决相当不推荐。再加之大多数原厂Demo是裸机的，很少有RTOS的。于是就想到了国产的 RT-Thread。</p> 
<p>  试用了 RT-Thread Studio 感觉相当好用，MCU的外设驱动不用用户操心，又有比较多的扩展组件可用，开发者可在熟悉RT-Thread的基础上，专注于应用的开发。其对国产MCU的支持正在逐步完善，暂时有 AT32、APM32、CH32、ES32、GD32、MM32 等，虽然只支持部分型号，但个人目前只中意AT32F403A，好巧不巧正好有它的芯片支持包。希望国产MCU能抓住替换潮机会，抓紧完善生态，不然等价格回落又会有一大批人转回STM32。望疫情早些过去，想念前三年芯片的价格。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/825094e6603c16046da2766c3857ca2e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">中国地图的shp文件获取，包含省级</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/af5c18eb2e2f4ea7e6849ac4d44f3f9b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">简单网页计算器代码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>