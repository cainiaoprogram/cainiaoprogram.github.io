<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>å†™ç»™goå¼€å‘è€…çš„gRPCæ•™ç¨‹-metadata - èœé¸Ÿç¨‹åºå‘˜åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="å†™ç»™goå¼€å‘è€…çš„gRPCæ•™ç¨‹-metadata" />
<meta property="og:description" content="å¯¼è¯­
å’Œåœ¨æ™®é€šHTTPè¯·æ±‚ä¸­ä¸€æ ·ï¼ŒgRPCæä¾›äº†åœ¨æ¯ä¸€æ¬¡RPCä¸­æºå¸¦ä¸Šä¸‹æ–‡çš„ç»“æ„ï¼šmetadataã€‚åœ¨Goè¯­è¨€ä¸­ï¼Œå®ƒä¸context.Contextç´§å¯†ç»“åˆï¼Œå¸®åŠ©æˆ‘ä»¬å®ç°æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä¹‹é—´äº’ç›¸ä¼ é€’ä¿¡æ¯
ä»€ä¹ˆæ˜¯Â metadataï¼Ÿ gRPC çš„ metadata ç®€å•ç†è§£ï¼Œå°±æ˜¯ HTTP Header ä¸­çš„ key-value å¯¹
metadata æ˜¯ä»¥ key-value çš„å½¢å¼å­˜å‚¨æ•°æ®çš„ï¼Œå…¶ä¸­ key æ˜¯ string ç±»å‹ï¼Œè€Œ value æ˜¯ []stringï¼Œå³ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ç±»å‹
metadata ä½¿å¾— client å’Œ server èƒ½å¤Ÿä¸ºå¯¹æ–¹æä¾›å…³äºæœ¬æ¬¡è°ƒç”¨çš„ä¸€äº›ä¿¡æ¯ï¼Œå°±åƒä¸€æ¬¡HTTPè¯·æ±‚çš„Request Headerå’ŒResponse Headerä¸€æ ·
HTTP Header çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€æ¬¡ HTTP è¯·æ±‚ï¼Œé‚£ä¹ˆ metadata çš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯ä¸€æ¬¡ RPC è°ƒç”¨
metadata åˆ›å»º ğŸŒ² ä½¿ç”¨New()ï¼š mdÂ :=Â metadata.New(map[string]string{&#34;key1&#34;:&#34;value1&#34;,&#34;key2&#34;:&#34;value2&#34;}) ğŸŒ² ä½¿ç”¨Pairs()ï¼š è¦æ³¨æ„å¦‚æœæœ‰ç›¸åŒçš„ key ä¼šè‡ªåŠ¨åˆå¹¶
mdÂ :=Â metadata.Pairs( &#34;key1&#34;,Â &#34;value1&#34;, &#34;key1&#34;,Â &#34;value1.2&#34;,Â //Â &#34;key1&#34;Â willÂ haveÂ mapÂ valueÂ []string{&#34;value1&#34;,Â &#34;value1.2&#34;} &#34;key2&#34;,Â &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/426bf9ce15eae2d49fe8389773d49bb9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-07T18:00:35+08:00" />
<meta property="article:modified_time" content="2023-03-07T18:00:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="èœé¸Ÿç¨‹åºå‘˜åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">èœé¸Ÿç¨‹åºå‘˜åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">å†™ç»™goå¼€å‘è€…çš„gRPCæ•™ç¨‹-metadata</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="js_content"> 
 <blockquote> 
  <p><strong>å¯¼è¯­</strong></p> 
  <p>å’Œåœ¨æ™®é€š<code>HTTP</code>è¯·æ±‚ä¸­ä¸€æ ·ï¼ŒgRPCæä¾›äº†åœ¨æ¯ä¸€æ¬¡RPCä¸­æºå¸¦ä¸Šä¸‹æ–‡çš„ç»“æ„ï¼š<code>metadata</code>ã€‚åœ¨Goè¯­è¨€ä¸­ï¼Œå®ƒä¸<code>context.Context</code>ç´§å¯†ç»“åˆï¼Œå¸®åŠ©æˆ‘ä»¬å®ç°æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä¹‹é—´äº’ç›¸ä¼ é€’ä¿¡æ¯</p> 
 </blockquote> 
 <h3>ä»€ä¹ˆæ˜¯Â <code>metadata</code>ï¼Ÿ</h3> 
 <p><strong>gRPC çš„ <code>metadata</code> ç®€å•ç†è§£ï¼Œå°±æ˜¯ <code>HTTP Header</code> Â ä¸­çš„ key-value å¯¹</strong></p> 
 <ul><li><p><code>metadata</code> æ˜¯ä»¥ <code>key-value</code> çš„å½¢å¼å­˜å‚¨æ•°æ®çš„ï¼Œå…¶ä¸­ key æ˜¯ string ç±»å‹ï¼Œè€Œ value æ˜¯ []stringï¼Œå³ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ç±»å‹</p></li><li><p><code>metadata</code> ä½¿å¾— client å’Œ server èƒ½å¤Ÿä¸ºå¯¹æ–¹æä¾›å…³äºæœ¬æ¬¡è°ƒç”¨çš„ä¸€äº›ä¿¡æ¯ï¼Œå°±åƒä¸€æ¬¡HTTPè¯·æ±‚çš„<code>Request Header</code>å’Œ<code>Response Header</code>ä¸€æ ·</p></li><li><p><code>HTTP Header</code> çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€æ¬¡ HTTP è¯·æ±‚ï¼Œé‚£ä¹ˆ <code>metadata</code> çš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯ä¸€æ¬¡ RPC è°ƒç”¨</p></li></ul> 
 <h3>metadata åˆ›å»º</h3> 
 <h4>ğŸŒ² ä½¿ç”¨New()ï¼š</h4> 
 <pre class="has"><code class="language-go">mdÂ :=Â metadata.New(map[string]string{"key1":"value1","key2":"value2"})</code></pre> 
 <h4>ğŸŒ² ä½¿ç”¨Pairs()ï¼š</h4> 
 <p>è¦æ³¨æ„å¦‚æœæœ‰ç›¸åŒçš„ key ä¼šè‡ªåŠ¨åˆå¹¶</p> 
 <pre class="has"><code class="language-go">mdÂ :=Â metadata.Pairs(
Â Â Â Â "key1",Â "value1",
Â Â Â Â "key1",Â "value1.2",Â //Â "key1"Â willÂ haveÂ mapÂ valueÂ []string{"value1",Â "value1.2"}
Â Â Â Â "key2",Â "value2",
)</code></pre> 
 <h4>ğŸŒ² åˆå¹¶å¤šä¸ªmetadata</h4> 
 <pre class="has"><code class="language-go">md1Â :=Â Â metadata.Pairs("k1",Â "v1",Â "k2",Â "v2")
md2Â :=Â metadata.New(map[string]string{"key1":"value1","key2":"value2"})

mdÂ :=Â metadata.Join(md1,Â md2)</code></pre> 
 <h4>ğŸŒ² å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®</h4> 
 <p>åœ¨ metadata ä¸­ï¼Œkey æ°¸è¿œæ˜¯ string ç±»å‹ï¼Œä½†æ˜¯ value å¯ä»¥æ˜¯ string ä¹Ÿå¯ä»¥æ˜¯äºŒè¿›åˆ¶æ•°æ®ã€‚ä¸ºäº†åœ¨ metadata ä¸­å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®ï¼Œæˆ‘ä»¬ä»…ä»…éœ€è¦åœ¨ key çš„åé¢åŠ ä¸Šä¸€ä¸ª - bin åç¼€ã€‚å…·æœ‰ - bin åç¼€çš„ key æ‰€å¯¹åº”çš„ value åœ¨åˆ›å»º metadata æ—¶ä¼šè¢«ç¼–ç ï¼ˆbase64ï¼‰ï¼Œæ”¶åˆ°çš„æ—¶å€™ä¼šè¢«è§£ç ï¼š</p> 
 <pre class="has"><code class="language-go">mdÂ :=Â metadata.Pairs(
Â Â Â Â "key",Â "stringÂ value",
Â Â Â Â "key-bin",Â string([]byte{96,Â 102}),
)</code></pre> 
 <p>metadata ç»“æ„æœ¬èº«ä¹Ÿæœ‰ä¸€äº›æ“ä½œæ–¹æ³•ï¼Œå‚è€ƒæ–‡æ¡£éå¸¸å®¹æ˜“ç†è§£ã€‚è¿™é‡Œä¸å†èµ˜è¿°ï¼šhttps://pkg.go.dev/google.golang.org/grpc@v1.44.0/metadata</p> 
 <h3>metadata å‘é€ä¸æ¥æ”¶</h3> 
 <p>è®©æˆ‘ä»¬å†æ¬¡å›é¡¾ä¸‹pbæ–‡ä»¶å’Œç”Ÿæˆå‡ºæ¥çš„clientä¸serverç«¯çš„æ¥å£</p> 
 <pre class="has"><code class="language-go">service OrderManagement {
    rpc getOrder(google.protobuf.StringValue) returns (Order);
}</code></pre> 
 <pre class="has"><code class="language-go">typeÂ OrderManagementClientÂ interfaceÂ {
Â GetOrder(ctxÂ context.Context,Â 
Â Â Â Â Â Â Â Â Â Â Â inÂ *wrapperspb.StringValue,Â optsÂ ...grpc.CallOption)Â (*Order,Â error)
}</code></pre> 
 <pre class="has"><code class="language-go">typeÂ OrderManagementServerÂ interfaceÂ {
Â GetOrder(context.Context,Â *wrapperspb.StringValue)Â (*Order,Â error)
Â mustEmbedUnimplementedOrderManagementServer()
}</code></pre> 
 <p>å¯ä»¥çœ‹åˆ°ç›¸æ¯”pbä¸­çš„æ¥å£å®šä¹‰ï¼Œç”Ÿæˆå‡ºæ¥çš„Goä»£ç é™¤äº†å¢åŠ äº†<code>error</code>è¿”å›å€¼ï¼Œè¿˜å¤šäº†<code>context.Context</code></p> 
 <p>å’Œé”™è¯¯å¤„ç†ç±»ä¼¼ï¼ŒgRPCä¸­çš„<code>context.Context</code> ä¹Ÿç¬¦åˆGoè¯­è¨€çš„ä½¿ç”¨ä¹ æƒ¯ï¼šé€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬åœ¨å‡½æ•°é¦–ä¸ªå‚æ•°æ”¾ç½®<code>context.Context</code>ç”¨æ¥ä¼ é€’ä¸€æ¬¡RPCä¸­æœ‰å…³çš„ä¸Šä¸‹æ–‡ï¼Œå€ŸåŠ©<code>context.WithValue()</code>æˆ–<code>ctx.Value()</code>å¾€<code>context</code>æ·»åŠ å˜é‡æˆ–è¯»å–å˜é‡</p> 
 <p><code>metadata</code>å°±æ˜¯gRPCä¸­å¯ä»¥ä¼ é€’çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ä¹‹ä¸€ï¼Œæ‰€ä»¥<code>metadata</code>çš„ä½¿ç”¨æ–¹å¼å°±æ˜¯ï¼š<code>metadata</code>è®°å½•åˆ°<code>context</code>ï¼Œä»<code>context</code>è¯»å–<code>metadata</code></p> 
 <img src="https://images2.imgbox.com/5d/85/HkgKc2g9_o.png" alt="57b29bcfc2050275f812366c8db6e345.png"> 
 <h3>Clinetå‘é€Serveræ¥æ”¶</h3> 
 <p><code>client</code>å‘é€<code>metadata</code>ï¼Œé‚£å°±æ˜¯æŠŠ<code>metadata</code>å­˜å‚¨åˆ°<code>contex.Context</code></p> 
 <p><code>server</code>æ¥æ”¶<code>metadata</code>ï¼Œå°±æ˜¯ä»<code>contex.Context</code>ä¸­è¯»å–<code>Metadata</code></p> 
 <h4>Clinet å‘é€ Metadata</h4> 
 <p>æŠŠ<code>Metadata</code>æ”¾åˆ°<code>contex.Context</code>ï¼Œæœ‰å‡ ç§æ–¹å¼</p> 
 <h5>ğŸŒ² ä½¿ç”¨<code>NewOutgoingContext</code></h5> 
 <p>å°†æ–°åˆ›å»ºçš„<code>metadata</code>æ·»åŠ åˆ°<code>context</code>ä¸­ï¼Œè¿™æ ·ä¼š <strong>è¦†ç›–</strong> æ‰åŸæ¥å·²æœ‰çš„<code>metadata</code></p> 
 <pre class="has"><code class="language-go">//Â å°†metadataæ·»åŠ åˆ°contextä¸­ï¼Œè·å–æ–°çš„context
mdÂ :=Â metadata.Pairs("k1",Â "v1",Â "k1",Â "v2",Â "k2",Â "v3")
ctxÂ :=Â metadata.NewOutgoingContext(context.Background(),Â md)

//Â unaryÂ RPC
response,Â errÂ :=Â client.SomeRPC(ctx,Â someRequest)

//Â streamingÂ RPC
stream,Â errÂ :=Â client.SomeStreamingRPC(ctx)</code></pre> 
 <h5>ğŸŒ² ä½¿ç”¨<code>AppendToOutgoingContext</code></h5> 
 <p>å¯ä»¥ç›´æ¥å°† key-value å¯¹æ·»åŠ åˆ°å·²æœ‰çš„<code>context</code>ä¸­</p> 
 <ul><li><p>å¦‚æœ<code>context</code>ä¸­æ²¡æœ‰<code>metadata</code>ï¼Œé‚£ä¹ˆå°±ä¼š <strong>åˆ›å»º</strong> ä¸€ä¸ª</p></li><li><p>å¦‚æœå·²æœ‰<code>metadata</code>ï¼Œé‚£ä¹ˆå°±å°†æ•°æ® <strong>æ·»åŠ </strong> åˆ°åŸæ¥çš„<code>metadata</code></p></li></ul> 
 <pre class="has"><code class="language-go">//Â å¦‚æœå¯¹åº”çš„Â contextÂ æ²¡æœ‰Â metadataï¼Œé‚£ä¹ˆå°±ä¼šåˆ›å»ºä¸€ä¸ª
ctxÂ :=Â metadata.AppendToOutgoingContext(ctx,Â "k1",Â "v1",Â "k1",Â "v2",Â "k2",Â "v3")

//Â å¦‚æœå·²æœ‰Â metadataÂ äº†ï¼Œé‚£ä¹ˆå°±å°†æ•°æ®æ·»åŠ åˆ°åŸæ¥çš„Â metadataÂ Â (ä¾‹å¦‚åœ¨æ‹¦æˆªå™¨ä¸­)
ctxÂ :=Â metadata.AppendToOutgoingContext(ctx,Â "k3",Â "v4")

//Â æ™®é€šRPCï¼ˆunaryÂ RPCï¼‰
response,Â errÂ :=Â client.SomeRPC(ctx,Â someRequest)

//Â æµå¼RPCï¼ˆstreamingÂ RPCï¼‰
stream,Â errÂ :=Â client.SomeStreamingRPC(ctx)</code></pre> 
 <h4>Server æ¥æ”¶ Metedata</h4> 
 <p>æ™®é€šRPCä¸æµå¼RPCçš„åŒºåˆ«ä¸å¤§ï¼Œéƒ½æ˜¯ä»<code>contex.Context</code>ä¸­è¯»å–<code>metadata</code></p> 
 <h5>ğŸŒ² ä½¿ç”¨<code>FromIncomingContext</code></h5> 
 <p><strong>æ™®é€šRPCï¼ˆunary RPCï¼‰</strong></p> 
 <pre class="has"><code class="language-go">//UnaryÂ Call
funcÂ (sÂ *server)Â SomeRPC(ctxÂ context.Context,Â inÂ *pb.someRequest)Â (*pb.someResponse,Â error)Â {
Â Â Â Â md,Â okÂ :=Â metadata.FromIncomingContext(ctx)
Â Â Â Â //Â doÂ somethingÂ withÂ metadata
}</code></pre> 
 <p><strong>æµå¼RPCï¼ˆstreaming RPCï¼‰</strong></p> 
 <pre class="has"><code class="language-go">//StreamingÂ Call
funcÂ (sÂ *server)Â SomeStreamingRPC(streamÂ pb.Service_SomeStreamingRPCServer)Â errorÂ {
Â Â Â Â md,Â okÂ :=Â metadata.FromIncomingContext(stream.Context())Â //Â getÂ contextÂ fromÂ stream
Â Â Â Â //Â doÂ somethingÂ withÂ metadata
}</code></pre> 
 <h3>Serverå‘é€Clinetæ¥æ”¶</h3> 
 <p>æœåŠ¡ç«¯å‘é€çš„<code>metadata</code>è¢«åˆ†æˆäº†<code>header</code>å’Œ <code>trailer</code>ä¸¤è€…ï¼Œå› è€Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥è¯»å–ä¸¤è€…</p> 
 <h4>Server å‘é€ Metadata</h4> 
 <p>å¯¹äº<strong>æ™®é€šRPCï¼ˆunary RPCï¼‰</strong>serverå¯ä»¥ä½¿ç”¨grpcåŒ…ä¸­æä¾›çš„å‡½æ•°å‘clientå‘é€ <code>header</code> å’Œ<code>trailer</code></p> 
 <ul><li><p><code>grpc.SendHeader()</code></p></li><li><p><code>grpc.SetHeader()</code></p></li><li><p><code>grpc.SetTrailer()</code></p></li></ul> 
 <p>å¯¹äº**æµå¼RPCï¼ˆstreaming RPCï¼‰serverå¯ä»¥ä½¿ç”¨ServerStream<sup>[1]</sup>æ¥å£ä¸­å®šä¹‰çš„å‡½æ•°å‘clientå‘é€<code>header</code>å’Œ <code>trailer</code></p> 
 <ul><li><p><code>ServerStream.SendHeader()</code></p></li><li><p><code>ServerStream.SetHeader()</code></p></li><li><p><code>ServerStream.SetTrailer()</code></p></li></ul> 
 <h5>ğŸŒ² æ™®é€šRPCï¼ˆunary RPCï¼‰</h5> 
 <p>ä½¿ç”¨ <code>grpc.SendHeader()</code> Â å’Œ <code>grpc.SetTrailer()</code> æ–¹æ³• ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å°†<code>context.Context</code>ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°</p> 
 <pre class="has"><code class="language-go">funcÂ (sÂ *server)Â SomeRPC(ctxÂ context.Context,Â inÂ *pb.someRequest)Â (*pb.someResponse,Â error)Â {
Â Â //Â åˆ›å»ºå¹¶å‘é€header
Â Â headerÂ :=Â metadata.Pairs("header-key",Â "val")
Â Â grpc.SendHeader(ctx,Â header)
Â Â 
Â Â //Â åˆ›å»ºå¹¶å‘é€trailer
Â Â trailerÂ :=Â metadata.Pairs("trailer-key",Â "val")
Â Â grpc.SetTrailer(ctx,Â trailer)
}</code></pre> 
 <p>å¦‚æœä¸æƒ³ç«‹å³å‘é€<code>header</code>ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>grpc.SetHeader()</code>ã€‚<code>grpc.SetHeader()</code>å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼Œåœ¨å¦‚ä¸‹æ—¶æœºä¼šæŠŠå¤šä¸ª<code>metadata</code>åˆå¹¶å‘é€å‡ºå»</p> 
 <ul><li><p>è°ƒç”¨<code>grpc.SendHeader()</code></p></li><li><p>ç¬¬ä¸€ä¸ªå“åº”è¢«å‘é€æ—¶</p></li><li><p>RPCç»“æŸæ—¶ï¼ˆåŒ…å«æˆåŠŸæˆ–å¤±è´¥ï¼‰</p></li></ul> 
 <pre class="has"><code class="language-go">funcÂ (sÂ *server)Â SomeRPC(ctxÂ context.Context,Â inÂ *pb.someRequest)Â (*pb.someResponse,Â error)Â {
Â Â //Â åˆ›å»ºheaderï¼Œåœ¨é€‚å½“æ—¶æœºä¼šè¢«å‘é€
Â Â headerÂ :=Â metadata.Pairs("header-key1",Â "val1")
Â Â grpc.SetHeader(ctx,Â header)
Â Â Â Â 
Â Â //Â åˆ›å»ºheaderï¼Œåœ¨é€‚å½“æ—¶æœºä¼šè¢«å‘é€
Â Â headerÂ :=Â metadata.Pairs("header-key2",Â "val2")
Â Â grpc.SetHeader(ctx,Â header)
Â Â 
Â Â //Â åˆ›å»ºå¹¶å‘é€trailer
Â Â trailerÂ :=Â metadata.Pairs("trailer-key",Â "val")
Â Â grpc.SetTrailer(ctx,Â trailer)
}</code></pre> 
 <h5>ğŸŒ² <strong>æµå¼RPCï¼ˆstreaming RPCï¼‰</strong></h5> 
 <p>ä½¿ç”¨ <code>ServerStream.SendHeader()</code> å’Œ <code>ServerStream.SetTrailer()</code> æ–¹æ³•</p> 
 <pre class="has"><code class="language-go">funcÂ (sÂ *server)Â SomeStreamingRPC(streamÂ pb.Service_SomeStreamingRPCServer)Â errorÂ {
Â Â //Â createÂ andÂ sendÂ header
Â Â headerÂ :=Â metadata.Pairs("header-key",Â "val")
Â Â stream.SendHeader(header)
Â Â 
Â Â //Â createÂ andÂ setÂ trailer
Â Â trailerÂ :=Â metadata.Pairs("trailer-key",Â "val")
Â Â stream.SetTrailer(trailer)
}</code></pre> 
 <p>å¦‚æœä¸æƒ³ç«‹å³å‘é€<code>header</code>ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>ServerStream.SetHeader()</code>ã€‚<code>ServerStream.SetHeader()</code>å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼Œåœ¨å¦‚ä¸‹æ—¶æœºä¼šæŠŠå¤šä¸ª<code>metadata</code>åˆå¹¶å‘é€å‡ºå»</p> 
 <ul><li><p>è°ƒç”¨<code>ServerStream.SendHeader()</code></p></li><li><p>ç¬¬ä¸€ä¸ªå“åº”è¢«å‘é€æ—¶</p></li><li><p>RPCç»“æŸæ—¶ï¼ˆåŒ…å«æˆåŠŸæˆ–å¤±è´¥ï¼‰</p></li></ul> 
 <pre class="has"><code class="language-go">funcÂ (sÂ *server)Â SomeStreamingRPC(streamÂ pb.Service_SomeStreamingRPCServer)Â errorÂ {
Â Â //Â createÂ andÂ sendÂ header
Â Â headerÂ :=Â metadata.Pairs("header-key",Â "val")
Â Â stream.SetHeader(header)
Â Â 
Â Â //Â createÂ andÂ setÂ trailer
Â Â trailerÂ :=Â metadata.Pairs("trailer-key",Â "val")
Â Â stream.SetTrailer(trailer)
}</code></pre> 
 <h4>Client æ¥æ”¶ Metadata</h4> 
 <h5>ğŸŒ² <strong>æ™®é€šRPCï¼ˆunary RPCï¼‰</strong></h5> 
 <p><strong>æ™®é€šRPCï¼ˆunary RPCï¼‰</strong>ä½¿ç”¨<code>grpc.Header()</code>å’Œ<code>grpc.Trailer()</code>æ–¹æ³•æ¥æ¥æ”¶ Metadata</p> 
 <pre class="has"><code class="language-go">//Â RPCÂ usingÂ theÂ contextÂ withÂ newÂ metadata.
varÂ header,Â trailerÂ metadata.MD

//Â AddÂ Order
orderÂ :=Â pb.Order{Id:Â "101",Â Items:Â []string{"iPhoneÂ XS",Â "MacÂ BookÂ Pro"},Â Destination:Â "SanÂ Jose,Â CA",Â Price:Â 2300.00}
res,Â errÂ :=Â client.AddOrder(ctx,Â &amp;order,Â grpc.Header(&amp;header),Â grpc.Trailer(&amp;trailer))
ifÂ errÂ !=Â nilÂ {
Â Â panic(err)
}</code></pre> 
 <h5>ğŸŒ² <strong>æµå¼RPCï¼ˆstreaming RPCï¼‰</strong></h5> 
 <p><strong>æµå¼RPCï¼ˆstreaming RPCï¼‰</strong>é€šè¿‡è°ƒç”¨è¿”å›çš„ <code>ClientStream</code>æ¥å£çš„<code>Header()</code>å’Œ<code> Trailer()</code>æ–¹æ³•æ¥æ”¶ <code>metadata</code></p> 
 <pre class="has"><code class="language-go">stream,Â errÂ :=Â client.SomeStreamingRPC(ctx)

//Â retrieveÂ header
header,Â errÂ :=Â stream.Header()

stream.CloseAndRecv()

//Â retrieveÂ trailer
trailerÂ :=Â stream.Trailer()</code></pre> 
 <h4><code>Header</code>å’Œ<code>Trailer</code>åŒºåˆ«</h4> 
 <p>æ ¹æœ¬åŒºåˆ«ï¼šå‘é€çš„æ—¶æœºä¸åŒï¼</p> 
 <p>âœ¨ <code>headers</code>ä¼šåœ¨ä¸‹é¢ä¸‰ç§åœºæ™¯ä¸‹è¢«å‘é€</p> 
 <ul><li><p><code>SendHeader()</code> è¢«è°ƒç”¨æ—¶ï¼ˆåŒ…å«<code>grpc.SendHeader</code>å’Œ<code>stream.SendHeader</code>)</p></li><li><p>ç¬¬ä¸€ä¸ªå“åº”è¢«å‘é€æ—¶</p></li><li><p>RPCç»“æŸæ—¶ï¼ˆåŒ…å«æˆåŠŸæˆ–å¤±è´¥ï¼‰</p></li></ul> 
 <p>âœ¨ <code>trailer</code>ä¼šåœ¨rpcè¿”å›çš„æ—¶å€™ï¼Œå³è¿™ä¸ªè¯·æ±‚ç»“æŸçš„æ—¶å€™è¢«å‘é€</p> 
 <p>å·®å¼‚åœ¨æµå¼RPCï¼ˆstreaming RPCï¼‰ä¸­æ¯”è¾ƒæ˜æ˜¾ï¼š</p> 
 <p>å› ä¸º<code>trailer</code>æ˜¯åœ¨æœåŠ¡ç«¯å‘é€å®Œè¯·æ±‚ä¹‹åæ‰å‘é€çš„ï¼Œæ‰€ä»¥clientè·å–<code>trailer</code>çš„æ—¶å€™éœ€è¦åœ¨<code>stream.CloseAndRecv</code>æˆ–è€…<code>stream.Recv</code> è¿”å›énilé”™è¯¯ (åŒ…å« io.EOF)ä¹‹å</p> 
 <p>å¦‚æœ<code>stream.CloseAndRecv</code>ä¹‹å‰è°ƒç”¨<code>stream.Trailer()</code>è·å–çš„æ˜¯ç©º</p> 
 <pre class="has"><code class="language-go">stream,Â errÂ :=Â client.SomeStreamingRPC(ctx)

//Â retrieveÂ header
header,Â errÂ :=Â stream.Header()

//Â retrieveÂ trailerÂ 
//Â `trailer`ä¼šåœ¨rpcè¿”å›çš„æ—¶å€™ï¼Œå³è¿™ä¸ªè¯·æ±‚ç»“æŸçš„æ—¶å€™è¢«å‘é€
//Â å› æ­¤æ­¤æ—¶è°ƒç”¨`stream.Trailer()`è·å–çš„æ˜¯ç©º
trailerÂ :=Â stream.Trailer()

stream.CloseAndRecv()

//Â retrieveÂ trailerÂ 
//Â `trailer`ä¼šåœ¨rpcè¿”å›çš„æ—¶å€™ï¼Œå³è¿™ä¸ªè¯·æ±‚ç»“æŸçš„æ—¶å€™è¢«å‘é€
//Â å› æ­¤æ­¤æ—¶è°ƒç”¨`stream.Trailer()`æ‰å¯ä»¥è·å–åˆ°å€¼
trailerÂ :=Â stream.Trailer()</code></pre> 
 <h3>ä½¿ç”¨åœºæ™¯</h3> 
 <p>æ—¢ç„¶æˆ‘ä»¬æŠŠ<code>metadata</code>ç±»æ¯”æˆ<code>HTTP Header</code>ï¼Œé‚£ä¹ˆ<code>metadata</code>çš„ä½¿ç”¨åœºæ™¯ä¹Ÿå¯ä»¥å€Ÿé‰´<code>HTTP</code>çš„<code>Header</code>ã€‚å¦‚ä¼ é€’ç”¨æˆ·<code>token</code>è¿›è¡Œç”¨æˆ·è®¤è¯ï¼Œä¼ é€’<code>trace</code>è¿›è¡Œé“¾è·¯è¿½è¸ªç­‰</p> 
 <h4>æ‹¦æˆªå™¨ä¸­çš„metadata</h4> 
 <p>åœ¨æ‹¦æˆªå™¨ä¸­ï¼Œæˆ‘ä»¬ä¸ä½†å¯ä»¥è·å–æˆ–ä¿®æ”¹<strong>æ¥æ”¶</strong>åˆ°çš„<code>metadata</code>ï¼Œç”šè‡³è¿˜å¯ä»¥æˆªå–å¹¶ä¿®æ”¹è¦<strong>å‘é€</strong>å‡ºå»çš„<code>metadata</code></p> 
 <p>è¿˜è®°å¾—æ‹¦æˆªå™¨å¦‚ä½•å®ç°ä¹ˆï¼Ÿå¦‚æœå·²ç»å¿˜äº†å¿«å¿«å›é¡¾ä¸€ä¸‹å§ï¼š</p> 
 <p>ğŸŒ° ä¸¾ä¸ªä¾‹å­ï¼š</p> 
 <p>æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯æ‹¦æˆªå™¨ä¸­ä»è¦å‘é€ç»™æœåŠ¡ç«¯çš„<code>metadata</code>ä¸­è¯»å–ä¸€ä¸ªæ—¶é—´æˆ³å­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™è¡¥å……è¿™ä¸ªæ—¶é—´æˆ³å­—æ®µ</p> 
 <p>æ³¨æ„è¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªä¸Šæ–‡æ²¡æœ‰æåˆ°çš„<code>FromOutgoingContext(ctx)</code>å‡½æ•°</p> 
 <pre class="has"><code class="language-go">funcÂ orderUnaryClientInterceptor(ctxÂ context.Context,Â methodÂ string,Â req,Â replyÂ interface{},
Â ccÂ *grpc.ClientConn,Â invokerÂ grpc.UnaryInvoker,Â optsÂ ...grpc.CallOption)Â errorÂ {

Â varÂ sÂ string

Â //Â è·å–è¦å‘é€ç»™æœåŠ¡ç«¯çš„`metadata`
Â md,Â okÂ :=Â metadata.FromOutgoingContext(ctx)
Â ifÂ okÂ &amp;&amp;Â len(md.Get("time"))Â &gt;Â 0Â {
Â Â sÂ =Â md.Get("time")[0]
Â }Â elseÂ {
Â Â Â Â Â Â Â Â //Â å¦‚æœæ²¡æœ‰åˆ™è¡¥å……è¿™ä¸ªæ—¶é—´æˆ³å­—æ®µ
Â Â sÂ =Â "inter"Â +Â strconv.FormatInt(time.Now().UnixNano(),Â 10)
Â Â ctxÂ =Â metadata.AppendToOutgoingContext(ctx,Â "time",Â s)
Â }

Â log.Printf("callÂ timestamp:Â %s",Â s)

Â //Â InvokingÂ theÂ remoteÂ method
Â errÂ :=Â invoker(ctx,Â method,Â req,Â reply,Â cc,Â opts...)

Â returnÂ err
}

funcÂ main()Â {
Â conn,Â errÂ :=Â grpc.Dial("127.0.0.1:8009",
Â Â grpc.WithInsecure(),
Â Â grpc.WithChainUnaryInterceptor(
Â Â Â orderUnaryClientInterceptor,
Â Â ),
Â )
Â ifÂ errÂ !=Â nilÂ {
Â Â panic(err)
Â }
Â Â Â Â 
Â Â Â Â cÂ :=Â pb.NewOrderManagementClient(conn)

Â ctxÂ =Â metadata.AppendToOutgoingContext(context.Background(),Â "time",
Â Â "raw"+strconv.FormatInt(time.Now().UnixNano(),Â 10))

Â //Â RPCÂ usingÂ theÂ contextÂ withÂ newÂ metadata.
Â varÂ header,Â trailerÂ metadata.MD

Â //Â AddÂ Order
Â orderÂ :=Â pb.Order{
Â Â Id:Â Â Â Â Â Â Â Â Â Â "101",
Â Â Items:Â Â Â Â Â Â Â []string{"iPhoneÂ XS",Â "MacÂ BookÂ Pro"},
Â Â Destination:Â "SanÂ Jose,Â CA",
Â Â Price:Â Â Â Â Â Â Â 2300.00,
Â }
Â res,Â errÂ :=Â c.AddOrder(ctx,Â &amp;order)
Â ifÂ errÂ !=Â nilÂ {
Â Â panic(err)
Â }
}</code></pre> 
 <p>ä»¥ä¸Šçš„æ€è·¯åœ¨serveråŒæ ·é€‚ç”¨ã€‚åŸºäºä»¥ä¸ŠåŸç†æˆ‘ä»¬å¯ä»¥å®ç°é“¾è·¯è¿½è¸ªã€ç”¨æˆ·è®¤è¯ç­‰åŠŸèƒ½</p> 
 <h4>é”™è¯¯ä¿¡æ¯</h4> 
 <p>è¿˜è®°å¾—<a href="" rel="nofollow">é”™è¯¯å¤„ç†</a>ä¸€æ–‡ä¸­ç•™ä¸‹çš„é—®é¢˜ä¹ˆï¼šgRPC ä¸­å¦‚ä½•ä¼ é€’é”™è¯¯æ¶ˆæ¯<code>Status</code>çš„å‘¢ï¼Ÿæ²¡é”™ï¼ä¹Ÿæ˜¯ä½¿ç”¨çš„<code>metadata</code>æˆ–è€…è¯´<code>http2.0</code> çš„<code>header</code>ã€‚<code>Status</code>çš„ä¸‰ç§ä¿¡æ¯åˆ†åˆ«ä½¿ç”¨äº†ä¸‰ä¸ª<code>header</code>å¤´</p> 
 <ul><li><p><code>Grpc-Status</code>: ä¼ é€’<code>Status</code>çš„<code>code</code></p></li><li><p><code>Grpc-Message</code>: ä¼ é€’<code>Status</code>çš„<code>message</code></p></li><li><p><code>Grpc-Status-Details-Bin</code>: ä¼ é€’<code>Status</code>çš„<code>details</code></p></li></ul> 
 <pre class="has"><code class="language-go">funcÂ (htÂ *serverHandlerTransport)Â WriteStatus(sÂ *Stream,Â stÂ *status.Status)Â errorÂ {
Â //Â ...
Â Â hÂ :=Â ht.rw.Header()
Â Â h.Set("Grpc-Status",Â fmt.Sprintf("%d",Â st.Code()))
Â Â ifÂ mÂ :=Â st.Message();Â mÂ !=Â ""Â {
Â Â Â h.Set("Grpc-Message",Â encodeGrpcMessage(m))
Â Â }

Â Â ifÂ pÂ :=Â st.Proto();Â pÂ !=Â nilÂ &amp;&amp;Â len(p.Details)Â &gt;Â 0Â {
Â Â Â stBytes,Â errÂ :=Â proto.Marshal(p)
Â Â Â ifÂ errÂ !=Â nilÂ {
Â Â Â Â //Â TODO:Â returnÂ errorÂ instead,Â whenÂ callersÂ areÂ ableÂ toÂ handleÂ it.
Â Â Â Â panic(err)
Â Â Â }

Â Â Â h.Set("Grpc-Status-Details-Bin",Â encodeBinHeader(stBytes))
Â Â }
Â Â Â Â //Â ...
}</code></pre> 
 <h3>æ€»ç»“</h3> 
 <p>ä¸€å¼ å›¾æ€»ç»“ä¸‹æ•´ä¸ª<code>metadata</code>çš„ä½¿ç”¨æ–¹æ³•</p> 
 <img src="https://images2.imgbox.com/fa/f5/N6dTCW6Q_o.png" alt="25f3373c47a2b7a6e05e4f73578ee5d7.png"> 
 <p style="text-align:left;">- END -</p> 
 <p style="text-align:center;">æ‰«ç å…³æ³¨å…¬ä¼—å·ã€Œç½‘ç®¡å¨biå¨ã€</p> 
 <p style="text-align:center;">ç»™ç½‘ç®¡ä¸ªæ˜Ÿæ ‡ï¼Œç¬¬ä¸€æ—¶é—´å¸æˆ‘çš„çŸ¥è¯†Â ğŸ‘†</p> 
 <p style="text-align:left;">ç½‘ç®¡æ•´ç†äº†ä¸€æœ¬ã€ŠGo å¼€å‘å‚è€ƒä¹¦ã€‹æ”¶é›†äº†70å¤šæ¡å¼€å‘å®è·µã€‚å»å…¬ä¼—å·å›å¤ã€gocookbookã€‘é¢†å–ï¼è¿˜æœ‰ä¸€æœ¬ã€Šk8s å…¥é—¨å®è·µã€‹è®²è§£äº†å¸¸ç”¨è½¯ä»¶åœ¨K8sä¸Šçš„éƒ¨ç½²è¿‡ç¨‹ï¼Œå…¬ä¼—å·å›å¤ã€k8sã€‘å³å¯é¢†å–ï¼</p> 
 <p style="text-align:right;">è§‰å¾—æœ‰ç”¨å°±ç‚¹ä¸ªåœ¨çœ‹Â  ğŸ‘‡ğŸ‘‡ğŸ‘‡</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9321ccf91a8b75a3185ecab8e8d5622d/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">æœºå™¨å­¦ä¹ ä¸ç›®æ ‡æ£€æµ‹ä½œä¸šï¼šè¿é€šå—ç®—æ³•</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/82ba30fb727bf54cabf7ef3c2fa09491/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">redisTemplate æ ¹æ®keyå‰ç¼€æ‰¹é‡åˆ é™¤</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 èœé¸Ÿç¨‹åºå‘˜åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>